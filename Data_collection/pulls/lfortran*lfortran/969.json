{"url":"https://api.github.com/repos/lfortran/lfortran/pulls/969","id":1106044649,"node_id":"PR_kwDOCpMuHc5B7Obp","html_url":"https://github.com/lfortran/lfortran/pull/969","diff_url":"https://github.com/lfortran/lfortran/pull/969.diff","patch_url":"https://github.com/lfortran/lfortran/pull/969.patch","issue_url":"https://api.github.com/repos/lfortran/lfortran/issues/969","number":969,"state":"open","locked":false,"title":"Cross compilation2","user":{"login":"meow464","id":70211708,"node_id":"MDQ6VXNlcjcwMjExNzA4","avatar_url":"https://avatars.githubusercontent.com/u/70211708?v=4","gravatar_id":"","url":"https://api.github.com/users/meow464","html_url":"https://github.com/meow464","followers_url":"https://api.github.com/users/meow464/followers","following_url":"https://api.github.com/users/meow464/following{/other_user}","gists_url":"https://api.github.com/users/meow464/gists{/gist_id}","starred_url":"https://api.github.com/users/meow464/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meow464/subscriptions","organizations_url":"https://api.github.com/users/meow464/orgs","repos_url":"https://api.github.com/users/meow464/repos","events_url":"https://api.github.com/users/meow464/events{/privacy}","received_events_url":"https://api.github.com/users/meow464/received_events","type":"User","site_admin":false},"body":"Tests currently not passing because I made changes to the build system. CI will need changes too.\r\n\r\nMy [cross-compilation](https://github.com/meow464/lfortran/tree/cross-compilation2) branch.\r\n\r\nFor now you need to do some manual copying and pasting, the next pull request will enable automatic routing based on the triple. I tested this on x86_64 -> aarch64, macOS and Linux. If you don't have an aarch64 machine you can use qemu+linux to test the binaries. The instructions are relatively simple:\r\n\r\n### Linux x86 -> arm64\r\n\r\nFirst compile lfortran:\r\n\r\n```\r\n./build0.sh\r\nmkdir build && cd build\r\n\r\ncmake -DCMAKE_C_COMPILER=clang \\\r\n           -DCMAKE_CXX_COMPILER=clang++ \\\r\n           -DCMAKE_BUILD_TYPE=Debug \\\r\n           -DWITH_LLVM=yes \\\r\n           -DWITH_TARGET_AARCH64=Yes \\\r\n           -DCMAKE_INSTALL_PREFIX=`pwd`/../install ..\r\n\r\nmake -j12\r\nmake install\r\n\r\ncmake -DCMAKE_Fortran_COMPILER=../install/bin/lfortran \\\r\n           -DWITH_RUNTIME_LIBRARY=Yes\r\n\r\nmake -j12\r\nmake install\r\n```\r\n\r\nThen cross compile the runtime. You will need a cmake toolchain file for the target architecture, I used [aarch64-linux](https://gist.github.com/meow464/00bd0b89567e9c621846b3b3a74b589e).\r\n\r\nOn Linux will also need to install gcc and g++ for aarch64, I use debian and installed them with apt: `sudo apt install gcc make gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu g++-aarch64-linux-gnu`\r\n\r\n```\r\nmkdir build_aarch64 && cd build_aarch6\r\n\r\ncmake ..\\\r\n      -DCMAKE_TOOLCHAIN_FILE=./aarch64-linux-gnu.toolchain.cmake\\\r\n      -DCMAKE_BUILD_TYPE=Debug\\\r\n      -DWITH_LLVM=yes\\\r\n      -DCMAKE_INSTALL_PREFIX=\"$(pwd)/../install_aarch64\"\\\r\n      -DCMAKE_Fortran_COMPILER=\"$(pwd)/../install/bin/lfortran\"\\\r\n      -DWITH_ZLIB=NO\\\r\n      -DWITH_RUNTIME_LIBRARY_ONLY=YES\r\n\t  \r\nmake -j12\r\nmake install\r\n```\r\n\r\nNow move the compiler to the cross compilation runtime.\r\n\r\n```\r\ncp  install/bin/lfortran install_aarch64/bin/lfortran\r\n```\r\n\r\nYou can test it with a hello world or [this simple program](https://gist.github.com/meow464/44e86a02fe77ed0625e2f2a6f281a904).\r\n\r\nUse `LFORTRAN_CC=/usr/bin/aarch64-linux-gnu-gcc lfortran --static --link-with-gcc --target arm64-linux`. You don't need to use `--static` but then you will have to copy `liblfortran_runtime.so` to the appropriate location on the target system.\r\n\r\nAlternatively you can use [qemu userspace](https://www.qemu.org/docs/master/user/main.html) emulation and call `qemu-aarch64-static hello_world`. You can configure your system to simply run aarch64 binaries as if they were native, [debian instructions](https://wiki.debian.org/QemuUserEmulation).\r\n\r\n### macOS x86 -> iPhone arm64\r\n\r\n```\r\n./build0.sh\r\nmkdir build && cd build\r\n\r\ncmake -DCMAKE_C_COMPILER=clang \\\r\n           -DCMAKE_CXX_COMPILER=clang++ \\\r\n           -DCMAKE_BUILD_TYPE=Debug \\\r\n           -DWITH_LLVM=yes \\\r\n           -DWITH_TARGET_AARCH64=Yes \\\r\n           -DCMAKE_INSTALL_PREFIX=`pwd`/../install .. \r\n\r\nmake -j12\r\nmake install\r\n\r\ncmake -DCMAKE_Fortran_COMPILER=../install/bin/lfortran \\\r\n           -DWITH_RUNTIME_LIBRARY=Yes\r\n\r\nmake -j12\r\nmake install\r\n\r\n```\r\n[iOS toolchain](https://github.com/leetal/ios-cmake).\r\n\r\n```\r\nmkdir build_aarch64 && cd build_aarch64\r\n\r\ncmake ../ -DCMAKE_BUILD_TYPE=Debug \\\r\n      -DWITH_LLVM=yes \\\r\n      -DCMAKE_INSTALL_PREFIX=`pwd`/../iphone_install \\\r\n      -DWITH_ZLIB=No \\\r\n      -DWITH_TARGET_AARCH64=Yes \\\r\n      -DWITH_RUNTIME_LIBRARY_ONLY=Yes \\\r\n      -DCMAKE_Fortran_COMPILER=../install/bin/lfortran \\\r\n      -DCMAKE_TOOLCHAIN_FILE=../ios.toolchain.cmake \\\r\n      -DPLATFORM=OS64 \\\r\n      -DENABLE_BITCODE=No\r\n\r\nmake -j12\r\nmake install\r\n```\r\nNow move the compiler to the cross compilation runtime.\r\n```\r\ncp install/bin/lfortran iphone_install/bin/lfortran\r\n```\r\nNow we can compile this [example](https://gist.github.com/meow464/d01c6005ef69fb729b44f801c1c2dbdc) that uses iso_c_binding:\r\n```\r\nSDKROOT=$(xcrun --sdk iphoneos --show-sdk-path) ./iphone_install/bin/lfortran --target arm64-apple-ios --generate-object-code -c addnums.f90 -o addnums.o\r\n```\r\nTo actually use the binary you need to copy it and `liblfortran_runtime_static.a` to your XCode project. Don't forget to call the fortran subroutine from main.m as in the example. You should see the result \"5\" on the console log on XCode.\r\n\r\nOne great news is that apple no longer requires embedded bitcode and will drop support for it in future releases. This massively simplifies the iOS port.\r\n\r\nNote:\r\n\r\n1. This changes the build steps to a two stage build so I still need to change the CI;\r\n2. This is for the runtime only. Cross compiling the compiler itself shouldn't be take much (or any) work besides having the cross compiler dependencies on the target sysroot;\r\n3. Is ZLIB necessary for the runtime? For now I'm keeping it off but it's just a matter of installing it on the sysroot or passing linker parameters `-L`.\r\n4. The next pull requests will add `share/lfortran-aarch64-linux` and the likes and automatically select the runtime based on `--target`, better organize the CMakeLists.txt and move the libraries to `lib/lfortran` instead of `share/lfortran`.\r\n","created_at":"2022-10-31T23:36:38Z","updated_at":"2023-01-06T17:20:35Z","closed_at":null,"merged_at":null,"merge_commit_sha":"4971844c2729b8d98e09a5c1721bc44741f9ca2e","assignee":null,"assignees":[],"requested_reviewers":[],"requested_teams":[],"labels":[],"milestone":null,"draft":true,"commits_url":"https://api.github.com/repos/lfortran/lfortran/pulls/969/commits","review_comments_url":"https://api.github.com/repos/lfortran/lfortran/pulls/969/comments","review_comment_url":"https://api.github.com/repos/lfortran/lfortran/pulls/comments{/number}","comments_url":"https://api.github.com/repos/lfortran/lfortran/issues/969/comments","statuses_url":"https://api.github.com/repos/lfortran/lfortran/statuses/b8f79056629a671043a606e0d58c90c2b6b0b934","head":{"label":"meow464:cross-compilation2","ref":"cross-compilation2","sha":"b8f79056629a671043a606e0d58c90c2b6b0b934","user":{"login":"meow464","id":70211708,"node_id":"MDQ6VXNlcjcwMjExNzA4","avatar_url":"https://avatars.githubusercontent.com/u/70211708?v=4","gravatar_id":"","url":"https://api.github.com/users/meow464","html_url":"https://github.com/meow464","followers_url":"https://api.github.com/users/meow464/followers","following_url":"https://api.github.com/users/meow464/following{/other_user}","gists_url":"https://api.github.com/users/meow464/gists{/gist_id}","starred_url":"https://api.github.com/users/meow464/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meow464/subscriptions","organizations_url":"https://api.github.com/users/meow464/orgs","repos_url":"https://api.github.com/users/meow464/repos","events_url":"https://api.github.com/users/meow464/events{/privacy}","received_events_url":"https://api.github.com/users/meow464/received_events","type":"User","site_admin":false},"repo":{"id":516490858,"node_id":"R_kgDOHskGag","name":"lfortran","full_name":"meow464/lfortran","private":false,"owner":{"login":"meow464","id":70211708,"node_id":"MDQ6VXNlcjcwMjExNzA4","avatar_url":"https://avatars.githubusercontent.com/u/70211708?v=4","gravatar_id":"","url":"https://api.github.com/users/meow464","html_url":"https://github.com/meow464","followers_url":"https://api.github.com/users/meow464/followers","following_url":"https://api.github.com/users/meow464/following{/other_user}","gists_url":"https://api.github.com/users/meow464/gists{/gist_id}","starred_url":"https://api.github.com/users/meow464/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meow464/subscriptions","organizations_url":"https://api.github.com/users/meow464/orgs","repos_url":"https://api.github.com/users/meow464/repos","events_url":"https://api.github.com/users/meow464/events{/privacy}","received_events_url":"https://api.github.com/users/meow464/received_events","type":"User","site_admin":false},"html_url":"https://github.com/meow464/lfortran","description":"My LFortarn fork - user at your own risk","fork":true,"url":"https://api.github.com/repos/meow464/lfortran","forks_url":"https://api.github.com/repos/meow464/lfortran/forks","keys_url":"https://api.github.com/repos/meow464/lfortran/keys{/key_id}","collaborators_url":"https://api.github.com/repos/meow464/lfortran/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/meow464/lfortran/teams","hooks_url":"https://api.github.com/repos/meow464/lfortran/hooks","issue_events_url":"https://api.github.com/repos/meow464/lfortran/issues/events{/number}","events_url":"https://api.github.com/repos/meow464/lfortran/events","assignees_url":"https://api.github.com/repos/meow464/lfortran/assignees{/user}","branches_url":"https://api.github.com/repos/meow464/lfortran/branches{/branch}","tags_url":"https://api.github.com/repos/meow464/lfortran/tags","blobs_url":"https://api.github.com/repos/meow464/lfortran/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/meow464/lfortran/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/meow464/lfortran/git/refs{/sha}","trees_url":"https://api.github.com/repos/meow464/lfortran/git/trees{/sha}","statuses_url":"https://api.github.com/repos/meow464/lfortran/statuses/{sha}","languages_url":"https://api.github.com/repos/meow464/lfortran/languages","stargazers_url":"https://api.github.com/repos/meow464/lfortran/stargazers","contributors_url":"https://api.github.com/repos/meow464/lfortran/contributors","subscribers_url":"https://api.github.com/repos/meow464/lfortran/subscribers","subscription_url":"https://api.github.com/repos/meow464/lfortran/subscription","commits_url":"https://api.github.com/repos/meow464/lfortran/commits{/sha}","git_commits_url":"https://api.github.com/repos/meow464/lfortran/git/commits{/sha}","comments_url":"https://api.github.com/repos/meow464/lfortran/comments{/number}","issue_comment_url":"https://api.github.com/repos/meow464/lfortran/issues/comments{/number}","contents_url":"https://api.github.com/repos/meow464/lfortran/contents/{+path}","compare_url":"https://api.github.com/repos/meow464/lfortran/compare/{base}...{head}","merges_url":"https://api.github.com/repos/meow464/lfortran/merges","archive_url":"https://api.github.com/repos/meow464/lfortran/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/meow464/lfortran/downloads","issues_url":"https://api.github.com/repos/meow464/lfortran/issues{/number}","pulls_url":"https://api.github.com/repos/meow464/lfortran/pulls{/number}","milestones_url":"https://api.github.com/repos/meow464/lfortran/milestones{/number}","notifications_url":"https://api.github.com/repos/meow464/lfortran/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/meow464/lfortran/labels{/name}","releases_url":"https://api.github.com/repos/meow464/lfortran/releases{/id}","deployments_url":"https://api.github.com/repos/meow464/lfortran/deployments","created_at":"2022-07-21T19:01:48Z","updated_at":"2022-08-01T19:33:07Z","pushed_at":"2023-01-26T16:18:31Z","git_url":"git://github.com/meow464/lfortran.git","ssh_url":"git@github.com:meow464/lfortran.git","clone_url":"https://github.com/meow464/lfortran.git","svn_url":"https://github.com/meow464/lfortran","homepage":"https://lfortran.org/","size":19276,"stargazers_count":0,"watchers_count":0,"language":"C++","has_issues":false,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":0,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":0,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":0,"open_issues":0,"watchers":0,"default_branch":"main"}},"base":{"label":"lfortran:main","ref":"main","sha":"524b9579bb9846d2c01ad40a65cba2acb14c2568","user":{"login":"lfortran","id":40613057,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQwNjEzMDU3","avatar_url":"https://avatars.githubusercontent.com/u/40613057?v=4","gravatar_id":"","url":"https://api.github.com/users/lfortran","html_url":"https://github.com/lfortran","followers_url":"https://api.github.com/users/lfortran/followers","following_url":"https://api.github.com/users/lfortran/following{/other_user}","gists_url":"https://api.github.com/users/lfortran/gists{/gist_id}","starred_url":"https://api.github.com/users/lfortran/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lfortran/subscriptions","organizations_url":"https://api.github.com/users/lfortran/orgs","repos_url":"https://api.github.com/users/lfortran/repos","events_url":"https://api.github.com/users/lfortran/events{/privacy}","received_events_url":"https://api.github.com/users/lfortran/received_events","type":"Organization","site_admin":false},"repo":{"id":177417757,"node_id":"MDEwOlJlcG9zaXRvcnkxNzc0MTc3NTc=","name":"lfortran","full_name":"lfortran/lfortran","private":false,"owner":{"login":"lfortran","id":40613057,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQwNjEzMDU3","avatar_url":"https://avatars.githubusercontent.com/u/40613057?v=4","gravatar_id":"","url":"https://api.github.com/users/lfortran","html_url":"https://github.com/lfortran","followers_url":"https://api.github.com/users/lfortran/followers","following_url":"https://api.github.com/users/lfortran/following{/other_user}","gists_url":"https://api.github.com/users/lfortran/gists{/gist_id}","starred_url":"https://api.github.com/users/lfortran/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lfortran/subscriptions","organizations_url":"https://api.github.com/users/lfortran/orgs","repos_url":"https://api.github.com/users/lfortran/repos","events_url":"https://api.github.com/users/lfortran/events{/privacy}","received_events_url":"https://api.github.com/users/lfortran/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/lfortran/lfortran","description":"Official main repository for LFortran","fork":false,"url":"https://api.github.com/repos/lfortran/lfortran","forks_url":"https://api.github.com/repos/lfortran/lfortran/forks","keys_url":"https://api.github.com/repos/lfortran/lfortran/keys{/key_id}","collaborators_url":"https://api.github.com/repos/lfortran/lfortran/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/lfortran/lfortran/teams","hooks_url":"https://api.github.com/repos/lfortran/lfortran/hooks","issue_events_url":"https://api.github.com/repos/lfortran/lfortran/issues/events{/number}","events_url":"https://api.github.com/repos/lfortran/lfortran/events","assignees_url":"https://api.github.com/repos/lfortran/lfortran/assignees{/user}","branches_url":"https://api.github.com/repos/lfortran/lfortran/branches{/branch}","tags_url":"https://api.github.com/repos/lfortran/lfortran/tags","blobs_url":"https://api.github.com/repos/lfortran/lfortran/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/lfortran/lfortran/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/lfortran/lfortran/git/refs{/sha}","trees_url":"https://api.github.com/repos/lfortran/lfortran/git/trees{/sha}","statuses_url":"https://api.github.com/repos/lfortran/lfortran/statuses/{sha}","languages_url":"https://api.github.com/repos/lfortran/lfortran/languages","stargazers_url":"https://api.github.com/repos/lfortran/lfortran/stargazers","contributors_url":"https://api.github.com/repos/lfortran/lfortran/contributors","subscribers_url":"https://api.github.com/repos/lfortran/lfortran/subscribers","subscription_url":"https://api.github.com/repos/lfortran/lfortran/subscription","commits_url":"https://api.github.com/repos/lfortran/lfortran/commits{/sha}","git_commits_url":"https://api.github.com/repos/lfortran/lfortran/git/commits{/sha}","comments_url":"https://api.github.com/repos/lfortran/lfortran/comments{/number}","issue_comment_url":"https://api.github.com/repos/lfortran/lfortran/issues/comments{/number}","contents_url":"https://api.github.com/repos/lfortran/lfortran/contents/{+path}","compare_url":"https://api.github.com/repos/lfortran/lfortran/compare/{base}...{head}","merges_url":"https://api.github.com/repos/lfortran/lfortran/merges","archive_url":"https://api.github.com/repos/lfortran/lfortran/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/lfortran/lfortran/downloads","issues_url":"https://api.github.com/repos/lfortran/lfortran/issues{/number}","pulls_url":"https://api.github.com/repos/lfortran/lfortran/pulls{/number}","milestones_url":"https://api.github.com/repos/lfortran/lfortran/milestones{/number}","notifications_url":"https://api.github.com/repos/lfortran/lfortran/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/lfortran/lfortran/labels{/name}","releases_url":"https://api.github.com/repos/lfortran/lfortran/releases{/id}","deployments_url":"https://api.github.com/repos/lfortran/lfortran/deployments","created_at":"2019-03-24T13:22:20Z","updated_at":"2023-01-24T13:27:54Z","pushed_at":"2023-01-27T03:07:19Z","git_url":"git://github.com/lfortran/lfortran.git","ssh_url":"git@github.com:lfortran/lfortran.git","clone_url":"https://github.com/lfortran/lfortran.git","svn_url":"https://github.com/lfortran/lfortran","homepage":"https://lfortran.org/","size":19144,"stargazers_count":510,"watchers_count":510,"language":"C++","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":53,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":582,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["compiler","fortran","interactive","jupyter","jupyter-kernels","jupyter-notebook","library","repl"],"visibility":"public","forks":53,"open_issues":582,"watchers":510,"default_branch":"main"}},"_links":{"self":{"href":"https://api.github.com/repos/lfortran/lfortran/pulls/969"},"html":{"href":"https://github.com/lfortran/lfortran/pull/969"},"issue":{"href":"https://api.github.com/repos/lfortran/lfortran/issues/969"},"comments":{"href":"https://api.github.com/repos/lfortran/lfortran/issues/969/comments"},"review_comments":{"href":"https://api.github.com/repos/lfortran/lfortran/pulls/969/comments"},"review_comment":{"href":"https://api.github.com/repos/lfortran/lfortran/pulls/comments{/number}"},"commits":{"href":"https://api.github.com/repos/lfortran/lfortran/pulls/969/commits"},"statuses":{"href":"https://api.github.com/repos/lfortran/lfortran/statuses/b8f79056629a671043a606e0d58c90c2b6b0b934"}},"author_association":"CONTRIBUTOR","auto_merge":null,"active_lock_reason":null,"merged":false,"mergeable":null,"rebaseable":null,"mergeable_state":"unknown","merged_by":null,"comments":26,"review_comments":0,"maintainer_can_modify":true,"commits":81,"additions":564,"deletions":127,"changed_files":21}