{"url":"https://api.github.com/repos/zvtvz/zvt/issues/26","repository_url":"https://api.github.com/repos/zvtvz/zvt","labels_url":"https://api.github.com/repos/zvtvz/zvt/issues/26/labels{/name}","comments_url":"https://api.github.com/repos/zvtvz/zvt/issues/26/comments","events_url":"https://api.github.com/repos/zvtvz/zvt/issues/26/events","html_url":"https://github.com/zvtvz/zvt/issues/26","id":490691408,"node_id":"MDU6SXNzdWU0OTA2OTE0MDg=","number":26,"title":"[dev][bug]运行一定时间后，recoder抛异常","user":{"login":"yinianfangxia","id":35867859,"node_id":"MDQ6VXNlcjM1ODY3ODU5","avatar_url":"https://avatars.githubusercontent.com/u/35867859?v=4","gravatar_id":"","url":"https://api.github.com/users/yinianfangxia","html_url":"https://github.com/yinianfangxia","followers_url":"https://api.github.com/users/yinianfangxia/followers","following_url":"https://api.github.com/users/yinianfangxia/following{/other_user}","gists_url":"https://api.github.com/users/yinianfangxia/gists{/gist_id}","starred_url":"https://api.github.com/users/yinianfangxia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yinianfangxia/subscriptions","organizations_url":"https://api.github.com/users/yinianfangxia/orgs","repos_url":"https://api.github.com/users/yinianfangxia/repos","events_url":"https://api.github.com/users/yinianfangxia/events{/privacy}","received_events_url":"https://api.github.com/users/yinianfangxia/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-09-07T23:40:30Z","updated_at":"2019-09-19T10:27:14Z","closed_at":"2019-09-19T10:27:14Z","author_association":"MEMBER","active_lock_reason":null,"body":"异常如下：\r\n```\r\nsqlalchemy.exc.ProgrammingError: (sqlite3.ProgrammingError) SQLite objects created in a thread can only be used in that same thread. The object was created in thread id 139991270131456 \r\nand this is thread id 139991166502656. [SQL: 'SELECT \"index\".id AS index_id, \"index\".entity_id AS index_entity_id, \"index\".timestamp AS index_timestamp, \"index\".entity_type AS index_ent\r\nity_type, \"index\".exchange AS index_exchange, \"index\".code AS index_code, \"index\".name AS index_name, \"index\".is_delisted AS index_is_delisted, \"index\".category AS index_category, \"inde\r\nx\".base_point AS index_base_point, \"index\".list_date AS index_list_date \\nFROM \"index\" \\nWHERE \"index\".exchange IN (?) ORDER BY \"index\".code ASC'] [parameters: [{}]] (Background on this\r\n error at: http://sqlalche.me/e/f405)\r\nERROR  ThreadPoolExecutor-0_0  2019-09-08 07:37:41,624  __main__:25  run  sina runner error:(sqlite3.ProgrammingError) SQLite objects created in a thread can only be used in that same t\r\nhread. The object was created in thread id 139991270131456 and this is thread id 139991166502656. [SQL: 'SELECT \"index\".id AS index_id, \"index\".entity_id AS index_entity_id, \"index\".tim\r\nestamp AS index_timestamp, \"index\".entity_type AS index_entity_type, \"index\".exchange AS index_exchange, \"index\".code AS index_code, \"index\".name AS index_name, \"index\".is_delisted AS i\r\nndex_is_delisted, \"index\".category AS index_category, \"index\".base_point AS index_base_point, \"index\".list_date AS index_list_date \\nFROM \"index\" \\nWHERE \"index\".exchange IN (?) ORDER B\r\nY \"index\".code ASC'] [parameters: [{}]] (Background on this error at: http://sqlalche.me/e/f405)\r\nTraceback (most recent call last):\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1127, in _execute_context\r\n    context = constructor(dialect, self, conn, *args)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 639, in _init_compiled\r\n    self.cursor = self.create_cursor()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 954, in create_cursor\r\n    return self._dbapi_connection.cursor()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/pool.py\", line 977, in cursor\r\n    return self.connection.cursor(*args, **kwargs)\r\nsqlite3.ProgrammingError: SQLite objects created in a thread can only be used in that same thread. The object was created in thread id 139991270131456 and this is thread id 139991166502656.\r\n\r\nThe above exception was the direct cause of the following exception:\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"zvt/recorders/sina/sina_runner.py\", line 20, in run\r\n    SinaChinaStockCategoryRecorder().run()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/zvt/recorders/sina/meta/sina_china_stock_category_recorder.py\", line 34, in __init__\r\n    return_type='domain', provider=self.provider)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/zvdata/api.py\", line 215, in get_entities\r\n    index=index, index_is_time=index_is_time)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/zvdata/api.py\", line 115, in get_data\r\n    return query.all()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/orm/query.py\", line 2843, in all\r\n    return list(self)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/orm/query.py\", line 2995, in __iter__\r\n    return self._execute_and_instances(context)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/orm/query.py\", line 3018, in _execute_and_instances\r\n    result = conn.execute(querycontext.statement, self._params)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 948, in execute\r\n    return meth(self, multiparams, params)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/sql/elements.py\", line 269, in _execute_on_connection\r\n    return connection._execute_clauseelement(self, multiparams, params)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1060, in _execute_clauseelement\r\n    compiled_sql, distilled_params\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1132, in _execute_context\r\n    None, None)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1413, in _handle_dbapi_exception\r\n    exc_info\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/util/compat.py\", line 265, in raise_from_cause\r\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/util/compat.py\", line 248, in reraise\r\n    raise value.with_traceback(tb)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1127, in _execute_context\r\n    context = constructor(dialect, self, conn, *args)\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 639, in _init_compiled\r\n    self.cursor = self.create_cursor()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 954, in create_cursor\r\n    return self._dbapi_connection.cursor()\r\n  File \"/home/xuanqi/workspace/github/zvtvz/zvt/ve/lib/python3.6/site-packages/sqlalchemy/pool.py\", line 977, in cursor\r\n    return self.connection.cursor(*args, **kwargs)\r\nsqlalchemy.exc.ProgrammingError: (sqlite3.ProgrammingError) SQLite objects created in a thread can only be used in that same thread. The object was created in thread id 139991270131456 and this is thread id 139991166502656. [SQL: 'SELECT \"index\".id AS index_id, \"index\".entity_id AS index_entity_id, \"index\".timestamp AS index_timestamp, \"index\".entity_type AS index_entity_type, \"index\".exchange AS index_exchange, \"index\".code AS index_code, \"index\".name AS index_name, \"index\".is_delisted AS index_is_delisted, \"index\".category AS index_category, \"index\".base_point AS index_base_point, \"index\".list_date AS index_list_date \\nFROM \"index\" \\nWHERE \"index\".exchange IN (?) ORDER BY \"index\".code ASC'] [parameters: [{}]] (Background on this error at: http://sqlalche.me/e/f405)\r\n```\r\n\r\n初步怀疑是跟全局session的修改有关","closed_by":{"login":"foolcage","id":1160499,"node_id":"MDQ6VXNlcjExNjA0OTk=","avatar_url":"https://avatars.githubusercontent.com/u/1160499?v=4","gravatar_id":"","url":"https://api.github.com/users/foolcage","html_url":"https://github.com/foolcage","followers_url":"https://api.github.com/users/foolcage/followers","following_url":"https://api.github.com/users/foolcage/following{/other_user}","gists_url":"https://api.github.com/users/foolcage/gists{/gist_id}","starred_url":"https://api.github.com/users/foolcage/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/foolcage/subscriptions","organizations_url":"https://api.github.com/users/foolcage/orgs","repos_url":"https://api.github.com/users/foolcage/repos","events_url":"https://api.github.com/users/foolcage/events{/privacy}","received_events_url":"https://api.github.com/users/foolcage/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/zvtvz/zvt/issues/26/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/zvtvz/zvt/issues/26/timeline","performed_via_github_app":null,"state_reason":"completed"}