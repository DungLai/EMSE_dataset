{"url":"https://api.github.com/repos/alvations/sacremoses/issues/28","repository_url":"https://api.github.com/repos/alvations/sacremoses","labels_url":"https://api.github.com/repos/alvations/sacremoses/issues/28/labels{/name}","comments_url":"https://api.github.com/repos/alvations/sacremoses/issues/28/comments","events_url":"https://api.github.com/repos/alvations/sacremoses/issues/28/events","html_url":"https://github.com/alvations/sacremoses/issues/28","id":416932911,"node_id":"MDU6SXNzdWU0MTY5MzI5MTE=","number":28,"title":"Encoding problem when calling from python script in Windows","user":{"login":"mlforcada","id":227679,"node_id":"MDQ6VXNlcjIyNzY3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/227679?v=4","gravatar_id":"","url":"https://api.github.com/users/mlforcada","html_url":"https://github.com/mlforcada","followers_url":"https://api.github.com/users/mlforcada/followers","following_url":"https://api.github.com/users/mlforcada/following{/other_user}","gists_url":"https://api.github.com/users/mlforcada/gists{/gist_id}","starred_url":"https://api.github.com/users/mlforcada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mlforcada/subscriptions","organizations_url":"https://api.github.com/users/mlforcada/orgs","repos_url":"https://api.github.com/users/mlforcada/repos","events_url":"https://api.github.com/users/mlforcada/events{/privacy}","received_events_url":"https://api.github.com/users/mlforcada/received_events","type":"User","site_admin":false},"labels":[{"id":907981943,"node_id":"MDU6TGFiZWw5MDc5ODE5NDM=","url":"https://api.github.com/repos/alvations/sacremoses/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":928790437,"node_id":"MDU6TGFiZWw5Mjg3OTA0Mzc=","url":"https://api.github.com/repos/alvations/sacremoses/labels/windows","name":"windows","color":"7ff991","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-03-04T18:26:50Z","updated_at":"2019-03-07T06:12:11Z","closed_at":"2019-03-07T06:12:01Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, @alvations.\r\nA student of mine and I are using the truecaser from a Python 3 script in windows. The script makes sure that all files are opened in utf-8 by redefining open as follows:\r\n```\r\nopen = functools.partial(open, encoding='utf8') \r\n```\r\nHowever, when the script executes this excerpt of code:\r\n```\r\n\tfor suffix in [args.l1, args.l2] :\r\n\t\tmtc = MosesTruecaser()\r\n\t\tmtc.train([line.split() for line in open(\"train.\"+changes_applied+suffix)], save_to=\"truecasemodel.\"+suffix)\r\n\t\tfor prefix in [\"train.\", \"dev.\", \"test.\"] :\r\n\t\t\twith open(prefix+changes_applied+\"true.\"+suffix,\"w\") as outfile :\r\n\t\t\t\t[outfile.write(mtc.truecase(line, return_str=True)+\"\\n\") for line in open(prefix+changes_applied+suffix)]\r\n```\r\nThe error occurs in the line\r\n```\r\n[outfile.write(mtc.truecase(line, return_str=True)+\"\\n\") for line in open(prefix+changes_applied+suffix)]\r\n```\r\nAnd the traceback is\r\n```\r\n(prueba) C:\\Users\\Guest\\nmt-for-translators\\globalvoices\\data>python ../../code/prepare.py GlobalVoices.es-fr fr es 130000 1500 1500 10000 --tokenize --truecase --bpe\r\nFicheros 'tokenizados'\r\nTraceback (most recent call last):\r\n  File \"../../code/prepare.py\", line 132, in <module>\r\n    mtc.train([line.split() for line in open(\"train.\"+changes_applied+suffix)], save_to=\"truecasemodel.\"+suffix)\r\n  File \"C:\\Users\\Guest\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\sacremoses\\truecase.py\", line 142, in train\r\n    self.model = self._train(documents, save_to, possibly_use_first_token, processes, progress_bar=progress_bar)\r\n  File \"C:\\Users\\Guest\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\sacremoses\\truecase.py\", line 132, in _train\r\n    self._save_model_from_casing(casing, save_to)\r\n  File \"C:\\Users\\Guest\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\sacremoses\\truecase.py\", line 324, in _save_model_from_casing\r\n    c\r\n  File \"C:\\Users\\Guest\\prueba\\lib\\encodings\\cp1252.py\", line 19, in encode\r\n    return codecs.charmap_encode(input,self.errors,encoding_table)[0]\r\nUnicodeEncodeError: 'charmap' codec can't encode character '\\u011f' in position 4: character maps to <undefined>\r\n```\r\n\r\nWe found that '\\u011f' is the character 'ğ' in 'Erdoğan', position 4 in the word. Clearly, the error occurs when printing to a file\r\n```\r\nprint(' '.join(tokens_counts), end='\\n', file=fout)\r\n```\r\nThe file fout is opened as follows in `truecase.py`\r\n```\r\nwith open(filename, 'w') as fout:\r\n```\r\nWe have tried setting PYTHONIOENCODING before calling the script, to no avail. \r\n\r\nOur python is:\r\n```\r\nPython 3.6.5 (v3.6.5:f59c0932b4, Mar 28 2018, 17:00:18) [MSC v.1900 64 bit (AMD64)] on win32\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n```\r\nand it was installed from [This page](https://www.python.org/downloads/windows/). It also fails with 3.6.3 on a different machine.\r\nWe are using it inside a virtualenv.\r\nWe don't seem to find a way to solve this without modifying your code. \r\nThanks a million for your help.\r\n","closed_by":{"login":"alvations","id":1050316,"node_id":"MDQ6VXNlcjEwNTAzMTY=","avatar_url":"https://avatars.githubusercontent.com/u/1050316?v=4","gravatar_id":"","url":"https://api.github.com/users/alvations","html_url":"https://github.com/alvations","followers_url":"https://api.github.com/users/alvations/followers","following_url":"https://api.github.com/users/alvations/following{/other_user}","gists_url":"https://api.github.com/users/alvations/gists{/gist_id}","starred_url":"https://api.github.com/users/alvations/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alvations/subscriptions","organizations_url":"https://api.github.com/users/alvations/orgs","repos_url":"https://api.github.com/users/alvations/repos","events_url":"https://api.github.com/users/alvations/events{/privacy}","received_events_url":"https://api.github.com/users/alvations/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/alvations/sacremoses/issues/28/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/alvations/sacremoses/issues/28/timeline","performed_via_github_app":null,"state_reason":"completed"}