{"url":"https://api.github.com/repos/theislab/scgen/issues/11","repository_url":"https://api.github.com/repos/theislab/scgen","labels_url":"https://api.github.com/repos/theislab/scgen/issues/11/labels{/name}","comments_url":"https://api.github.com/repos/theislab/scgen/issues/11/comments","events_url":"https://api.github.com/repos/theislab/scgen/issues/11/events","html_url":"https://github.com/theislab/scgen/issues/11","id":500795021,"node_id":"MDU6SXNzdWU1MDA3OTUwMjE=","number":11,"title":"ValueError: Variable encoder/dense/kernel/Adam/ already exists if model is trained in a loop","user":{"login":"rene-rex","id":7721866,"node_id":"MDQ6VXNlcjc3MjE4NjY=","avatar_url":"https://avatars.githubusercontent.com/u/7721866?v=4","gravatar_id":"","url":"https://api.github.com/users/rene-rex","html_url":"https://github.com/rene-rex","followers_url":"https://api.github.com/users/rene-rex/followers","following_url":"https://api.github.com/users/rene-rex/following{/other_user}","gists_url":"https://api.github.com/users/rene-rex/gists{/gist_id}","starred_url":"https://api.github.com/users/rene-rex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rene-rex/subscriptions","organizations_url":"https://api.github.com/users/rene-rex/orgs","repos_url":"https://api.github.com/users/rene-rex/repos","events_url":"https://api.github.com/users/rene-rex/events{/privacy}","received_events_url":"https://api.github.com/users/rene-rex/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-10-01T10:06:44Z","updated_at":"2019-10-02T18:10:08Z","closed_at":"2019-10-02T18:09:42Z","author_association":"NONE","active_lock_reason":null,"body":"Hello\r\n\r\nFirst of all congratulations for this impressive work! I am very curious to find out how far we can go with VAEs and single cell data.\r\n\r\nUnfortunately, I encountered an error when I tried to train a model for different data sets in a loop. It seems the variable for the optimizer is not reset if a new instance of `VAEArith` is created. Here is short snippet to demonstrate the problem (tested against scgen 1.1.3 from pypi).\r\n\r\n```python\r\nimport scgen\r\nimport numpy as np\r\nimport pandas\r\nfrom anndata import AnnData\r\n\r\nfor i in range(1, 3):\r\n\r\n    data = pandas.DataFrame(np.random.random((i * 100, 50)))\r\n    obs = pandas.DataFrame(index=data.index)\r\n    obs['batch'] = (['BatchA'] * i * 50) + (['BatchB'] * i * 50)\r\n    obs['cell_type'] = ['TypeA'] * i * 100\r\n    adata = AnnData(data, obs)\r\n\r\n    network = scgen.VAEArith(x_dimension=adata.shape[1],\r\n                             model_path=\"./models/batch-\" + str(i))\r\n    network.train(train_data=adata, n_epochs=100)\r\n    corrected_adata = scgen.batch_removal(network, adata)\r\n```\r\n\r\nAnd here is the traceback:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"loop-bug.py\", line 17, in <module>\r\n    network = scgen.VAEArith(x_dimension=adata.shape[1], model_path=\"./models/batch-\" + str(i))\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/scgen/models/_vae.py\", line 46, in __init__\r\n    self._loss_function()\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/scgen/models/_vae.py\", line 158, in _loss_function\r\n    self.solver = tf.train.AdamOptimizer(learning_rate=self.learning_rate).minimize(self.vae_loss)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/optimizer.py\", line 413, in minimize\r\n    name=name)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/optimizer.py\", line 597, in apply_gradients\r\n    self._create_slots(var_list)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/adam.py\", line 131, in _create_slots\r\n    self._zeros_slot(v, \"m\", self._name)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/optimizer.py\", line 1155, in _zeros_slot\r\n    new_slot_variable = slot_creator.create_zeros_slot(var, op_name)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/slot_creator.py\", line 190, in create_zeros_slot\r\n    colocate_with_primary=colocate_with_primary)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/slot_creator.py\", line 164, in create_slot_with_initializer\r\n    dtype)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/training/slot_creator.py\", line 74, in _create_slot_var\r\n    validate_shape=validate_shape)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 1496, in get_variable\r\n    aggregation=aggregation)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 1239, in get_variable\r\n    aggregation=aggregation)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 562, in get_variable\r\n    aggregation=aggregation)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 514, in _true_getter\r\n    aggregation=aggregation)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 864, in _get_single_variable\r\n    (err_msg, \"\".join(traceback.format_list(tb))))\r\nValueError: Variable encoder/dense/kernel/Adam/ already exists, disallowed. Did you mean to set reuse=True or reuse=tf.AUTO_REUSE in VarScope? Originally defined at:\r\n\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/scgen/models/_vae.py\", line 158, in _loss_function\r\n    self.solver = tf.train.AdamOptimizer(learning_rate=self.learning_rate).minimize(self.vae_loss)\r\n  File \"/home/user/software/vens/scgen/lib64/python3.6/site-packages/scgen/models/_vae.py\", line 46, in __init__\r\n    self._loss_function()\r\n  File \"loop-bug.py\", line 17, in <module>\r\n    network = scgen.VAEArith(x_dimension=adata.shape[1], model_path=\"./models/batch-\" + str(i))\r\n```\r\n\r\nThis seems to be related to issue #10. However, I tried to test this code against the current master branch but the installation of scgen fails. I created a another issue (#12) for this.\r\n","closed_by":{"login":"Naghipourfar","id":16001761,"node_id":"MDQ6VXNlcjE2MDAxNzYx","avatar_url":"https://avatars.githubusercontent.com/u/16001761?v=4","gravatar_id":"","url":"https://api.github.com/users/Naghipourfar","html_url":"https://github.com/Naghipourfar","followers_url":"https://api.github.com/users/Naghipourfar/followers","following_url":"https://api.github.com/users/Naghipourfar/following{/other_user}","gists_url":"https://api.github.com/users/Naghipourfar/gists{/gist_id}","starred_url":"https://api.github.com/users/Naghipourfar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Naghipourfar/subscriptions","organizations_url":"https://api.github.com/users/Naghipourfar/orgs","repos_url":"https://api.github.com/users/Naghipourfar/repos","events_url":"https://api.github.com/users/Naghipourfar/events{/privacy}","received_events_url":"https://api.github.com/users/Naghipourfar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/theislab/scgen/issues/11/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/theislab/scgen/issues/11/timeline","performed_via_github_app":null,"state_reason":"completed"}