{"url":"https://api.github.com/repos/lfortran/lfortran/issues/550","repository_url":"https://api.github.com/repos/lfortran/lfortran","labels_url":"https://api.github.com/repos/lfortran/lfortran/issues/550/labels{/name}","comments_url":"https://api.github.com/repos/lfortran/lfortran/issues/550/comments","events_url":"https://api.github.com/repos/lfortran/lfortran/issues/550/events","html_url":"https://github.com/lfortran/lfortran/issues/550","id":1338784803,"node_id":"I_kwDOCpMuHc5PzDwj","number":550,"title":"Making a wasm32_emscripten Dynamic Library?","user":{"login":"certik","id":20568,"node_id":"MDQ6VXNlcjIwNTY4","avatar_url":"https://avatars.githubusercontent.com/u/20568?v=4","gravatar_id":"","url":"https://api.github.com/users/certik","html_url":"https://github.com/certik","followers_url":"https://api.github.com/users/certik/followers","following_url":"https://api.github.com/users/certik/following{/other_user}","gists_url":"https://api.github.com/users/certik/gists{/gist_id}","starred_url":"https://api.github.com/users/certik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/certik/subscriptions","organizations_url":"https://api.github.com/users/certik/orgs","repos_url":"https://api.github.com/users/certik/repos","events_url":"https://api.github.com/users/certik/events{/privacy}","received_events_url":"https://api.github.com/users/certik/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-15T10:02:12Z","updated_at":"2022-08-15T10:02:12Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"*Original issue*: https://gitlab.com/lfortran/lfortran/-/issues/714\n\nI am investigating using LFortran for Pyodide. We need the generated code to be position independent because we want to build an Emscripten side-module. However, the wasm object file generated by lfortran seems to include relocations that are not position independent. I am running the following code:\n\n```sh\nemcc -c src/runtime/impure/lfortran_intrinsics.c -o lfortran_intrinsics.o -fPIC\nlfortran -c test.f90 -o test.o --target wasm32\nemcc test.o lfortran_intrinsics.o -o test.so -sSIDE_MODULE=1 -sWASM_BIGINT\n```\nwhere `test.f90` is:\n```fortran\nprogram main\n    use iso_c_binding\n \n    print *, add(1, 1)\n contains\n \n    integer(kind=c_int) function add(x, y) result(r) bind(c, name=\"add\")\n       integer(kind=c_int), intent(in) :: x, y\n       r = x + y + 2021\n    end function\n \n end program\n```\n\nIf I compile it as the main module, it links successfully, runs, and prints 2023 as expected. But with `-sSIDE_MODULE=1` (or 2), it complains that there are relocations that are not position-independent, in particular the data relocations are type `R_WASM_MEMORY_ADDR_SLEB` but to be position independent they should be type `R_WASM_MEMORY_ADDR_REL_SLEB`. It looks to me like lfortran requests PIC here:\nhttps://gitlab.com/lfortran/lfortran/-/blob/master/src/libasr/codegen/evaluator.cpp#L183\n\nI think maybe the problem is that LLVM 11 is too old?\n\nIn tip of tree LLVM we see that setting PIC sets `OperandFlags = WebAssemblyII::MO_MEMORY_BASE_REL;`\n\nhttps://github.com/llvm/llvm-project/blob/ae72fee74ece594b8f30729b325a1f1cc1533d36/llvm/lib/Target/WebAssembly/WebAssemblyISelLowering.cpp#L1797\n\nWhich sets `Kind = MCSymbolRefExpr::VK_WASM_MBREL;`\n\nhttps://github.com/llvm/llvm-project/blob/4045b62d4cc9b366f349aa2786beaaddce179311/llvm/lib/Target/WebAssembly/WebAssemblyMCInstLower.cpp#L108\n\nWhich should cause the WasmObjectWriter to choose to emit `R_WASM_MEMORY_ADDR_REL_SLEB` locations:\n\nhttps://github.com/llvm/llvm-project/blob/ae72fee74ece594b8f30729b325a1f1cc1533d36/llvm/lib/Target/WebAssembly/MCTargetDesc/WebAssemblyWasmObjectWriter.cpp#L86","closed_by":null,"reactions":{"url":"https://api.github.com/repos/lfortran/lfortran/issues/550/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/lfortran/lfortran/issues/550/timeline","performed_via_github_app":null,"state_reason":null}