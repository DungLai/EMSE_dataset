{"url":"https://api.github.com/repos/lfortran/lfortran/issues/512","repository_url":"https://api.github.com/repos/lfortran/lfortran","labels_url":"https://api.github.com/repos/lfortran/lfortran/issues/512/labels{/name}","comments_url":"https://api.github.com/repos/lfortran/lfortran/issues/512/comments","events_url":"https://api.github.com/repos/lfortran/lfortran/issues/512/events","html_url":"https://github.com/lfortran/lfortran/issues/512","id":1338781431,"node_id":"I_kwDOCpMuHc5PzC73","number":512,"title":"Compile minpack","user":{"login":"certik","id":20568,"node_id":"MDQ6VXNlcjIwNTY4","avatar_url":"https://avatars.githubusercontent.com/u/20568?v=4","gravatar_id":"","url":"https://api.github.com/users/certik","html_url":"https://github.com/certik","followers_url":"https://api.github.com/users/certik/followers","following_url":"https://api.github.com/users/certik/following{/other_user}","gists_url":"https://api.github.com/users/certik/gists{/gist_id}","starred_url":"https://api.github.com/users/certik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/certik/subscriptions","organizations_url":"https://api.github.com/users/certik/orgs","repos_url":"https://api.github.com/users/certik/repos","events_url":"https://api.github.com/users/certik/events{/privacy}","received_events_url":"https://api.github.com/users/certik/received_events","type":"User","site_admin":false},"labels":[{"id":4432142216,"node_id":"LA_kwDOCpMuHc8AAAABCC0fiA","url":"https://api.github.com/repos/lfortran/lfortran/labels/SciPy","name":"SciPy","color":"d4c5f9","default":false,"description":"issues related to enable LFortran to compile the entire FORTRAN codebase in SciPy"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":29,"created_at":"2022-08-15T09:58:36Z","updated_at":"2023-01-15T04:06:48Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### TODO to public a blog post\r\n\r\n* [x] add CI: https://github.com/lfortran/lfortran/pull/1182\r\n* [ ] get rid of all the three \"XX\" commits in the minpack repo (by fixing it in LFortran)\r\n* [ ] get all examples working\r\n* [ ] should run at our CI correctly for a few weeks to reach \"beta\" (ideally 2 months, but we can \"overwrite\" this requirement)\r\n* [ ] write up a blog post and announce\r\n\r\n### Tracking examples\r\n- [x] examples_hybrd\r\n- [x] examples_hybrd1\r\n- [ ] examples_lmder1\r\n   - #1150 \r\n   - #1133\r\n- [x] examples_lmdif1\r\n  - #1122\r\n- [ ] examples_primes\r\n\r\n\r\n---------\r\n\r\n\r\n\r\n\r\n### Highest Priority\r\n\r\nThe code now compiles to binary (with just minimal source modifications, see below), but doesn't produce correct answers due to:\r\n\r\n* [x] https://github.com/lfortran/lfortran/issues/971 (fixed by #972)\r\n* [x] https://github.com/lfortran/lfortran/issues/976\r\n\r\nAnd perhaps other issues that we have not identified yet.\r\n\r\n---------\r\n\r\n### AST->ASR\r\n\r\nThese must be fixed, but the workaround is relatively simple by modifying Minpack sources, so are lower priority than the above.\r\n\r\nKnown TODO items for ASR (we commented out code for now):\r\n\r\n* [ ] equivalence statement\r\n* [x] statement functions (https://github.com/lfortran/lfortran/pull/911)\r\n* [x] implicit external (#950)\r\n* [ ] implied do loop (#981)\r\n* [x] do loop non-constant integer increment (#909, #946, #979)\r\n* [x] argument callback (undeclared)\r\n* [x] external function declared as \"double precision f\", when it should probably be \"external f\"\r\n* [x] implicit interface failure\r\n* [ ] LFortran also prints several warnings for missing features that are ignored, so we have to fix those\r\n* [x] The -I and -J options (https://github.com/lfortran/lfortran/pull/930)\r\n* [ ] `format()`: this is not strictly needed to get the correct answer and might not even be needed for SciPy, but it would be good to have it, so that things format on the screen correctly\r\n\r\n\r\n---------------\r\n\r\nSteps:\r\n\r\nhttps://github.com/certik/minpack/tree/scipy\r\n\r\n```console\r\ngit clone https://github.com/certik/minpack.git\r\ncd minpack\r\ngit checkout -t origin/scipy\r\nFC=lfortran cmake .\r\nmake\r\nctest\r\n```\r\n\r\nAll files compile to ASR as of 04d5732088ba195865ee9ccf322a4eea55070424, and when compiled sequentially, there is a failure in the LLVM backend:\r\n```console\r\n$ make\r\n[  2%] Building Fortran object src/CMakeFiles/minpack.dir/minpack.f90.o\r\n[  4%] Building Fortran object src/CMakeFiles/minpack.dir/covar.f.o\r\n[  6%] Building Fortran object src/CMakeFiles/minpack.dir/errjac.f.o\r\n[  8%] Building Fortran object src/CMakeFiles/minpack.dir/hybipt.f.o\r\n[ 10%] Building Fortran object src/CMakeFiles/minpack.dir/lhesfcn.f.o\r\nInternal Compiler Error: Unhandled exception\r\nTraceback (most recent call last):\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 1726\r\n    return compile_to_object_file(arg_file, outfile, false,\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 733\r\n    result = fe.get_asr2(input, lm, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 227\r\n    Result<ASR::TranslationUnit_t*> res2 = get_asr3(*ast, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 249\r\n    compiler_options.symtab_only, compiler_options);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_to_asr.cpp\", line 53\r\n    auto res = body_visitor(al, ast, diagnostics, unit, compiler_options, template_type_parameters);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 1685\r\n    b.template_type_parameters = template_type_parameters;\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 106\r\n    visit_ast(*x.m_items[i]);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4694\r\n    void visit_ast(const ast_t &b) { visit_ast_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4652\r\n    case astType::mod: { v.visit_mod((const mod_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4702\r\n    void visit_program_unit(const program_unit_t &b) { visit_program_unit_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4306\r\n    case program_unitType::Subroutine: { v.visit_Subroutine((const Subroutine_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 975\r\n    transform_stmts(body, x.n_body, x.m_body);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 83\r\n    this->visit_stmt(*m_body[i]);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4737\r\n    void visit_stmt(const stmt_t &b) { visit_stmt_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4412\r\n    case stmtType::Format: { v.visit_Format((const Format_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_common_visitor.h\", line 872\r\n    throw SemanticError(\"The value in data must be a constant\",\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/asr.h\", line 40\r\n    LFORTRAN_ASSERT(is_a<T>(*f));\r\nAssertFailed: is_a<T>(*f)\r\nmake[2]: *** [src/CMakeFiles/minpack.dir/lhesfcn.f.o] Error 1\r\nmake[1]: *** [src/CMakeFiles/minpack.dir/all] Error 2\r\nmake: *** [all] Error 2\r\n```\r\n\r\nCurrently as of 88b1ef7c5ea99fe40aa05190a68634fbc4e1497e it fails with:\r\n\r\n```console\r\n$ make\r\nScanning dependencies of target minpack\r\n[  2%] Building Fortran object src/CMakeFiles/minpack.dir/minpack.f90.o\r\n[  4%] Building Fortran object src/CMakeFiles/minpack.dir/covar.f.o\r\n[  6%] Building Fortran object src/CMakeFiles/minpack.dir/errjac.f.o\r\n[  8%] Building Fortran object src/CMakeFiles/minpack.dir/hybipt.f.o\r\n[ 10%] Building Fortran object src/CMakeFiles/minpack.dir/lhesfcn.f.o\r\nTraceback (most recent call last):\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 1726\r\n    return compile_to_object_file(arg_file, outfile, false,\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 733\r\n    result = fe.get_asr2(input, lm, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 227\r\n    Result<ASR::TranslationUnit_t*> res2 = get_asr3(*ast, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 249\r\n    compiler_options.symtab_only, compiler_options);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_to_asr.cpp\", line 53\r\n    auto res = body_visitor(al, ast, diagnostics, unit, compiler_options, template_type_parameters);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 1812\r\n    b.template_type_parameters = template_type_parameters;\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 114\r\n    visit_ast(*x.m_items[i]);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4694\r\n    void visit_ast(const ast_t &b) { visit_ast_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4652\r\n    case astType::mod: { v.visit_mod((const mod_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4702\r\n    void visit_program_unit(const program_unit_t &b) { visit_program_unit_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4306\r\n    case program_unitType::Subroutine: { v.visit_Subroutine((const Subroutine_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 990\r\n    transform_stmts(body, x.n_body, x.m_body);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_body_visitor.cpp\", line 90\r\n    this->visit_stmt(*m_body[i]);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4737\r\n    void visit_stmt(const stmt_t &b) { visit_stmt_t(b, self()); }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/ast.h\", line 4412\r\n    case stmtType::Format: { v.visit_Format((const Format_t &)x); return; }\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_common_visitor.h\", line 917\r\n    current_body->push_back(al, assign_stmt);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/semantics/ast_common_visitor.h\", line 917\r\n    current_body->push_back(al, assign_stmt);\r\n  Binary file \"/usr/lib/system/libsystem_platform.dylib\", local address: 0x1803244e3\r\nSegfault: Signal SIGSEGV (segmentation fault) received\r\nmake[2]: *** [src/CMakeFiles/minpack.dir/lhesfcn.f.o] Error 1\r\nmake[1]: *** [src/CMakeFiles/minpack.dir/all] Error 2\r\nmake: *** [all] Error 2\r\n```\r\n\r\nwhich is a slight regression caused by #864. As of 8e41e7f7e (a slightly prior commit) the error is:\r\n```console\r\n$ make\r\n[  2%] Building Fortran object src/CMakeFiles/minpack.dir/minpack.f90.o\r\n[  4%] Building Fortran object src/CMakeFiles/minpack.dir/covar.f.o\r\n[  6%] Building Fortran object src/CMakeFiles/minpack.dir/errjac.f.o\r\n[  8%] Building Fortran object src/CMakeFiles/minpack.dir/hybipt.f.o\r\n[ 10%] Building Fortran object src/CMakeFiles/minpack.dir/lhesfcn.f.o\r\nsemantic error: Object type ArrayItem is not implemented yet.\r\n  --> /Users/ondrej/repos/lfortran/minpack/src/lhesfcn.f:64:12\r\n   |\r\n64 |       data y(1),y(2),y(3),y(4),y(5),y(6),y(7),y(8),y(9),y(10),y(11),\r\n   |            ^^^^ \r\n\r\n\r\nNote: if any of the above error or warning messages are not clear or are lacking\r\ncontext please report it to us (we consider that a bug that needs to be fixed).\r\nmake[2]: *** [src/CMakeFiles/minpack.dir/lhesfcn.f.o] Error 1\r\nmake[1]: *** [src/CMakeFiles/minpack.dir/all] Error 2\r\nmake: *** [all] Error 2\r\n```\r\nWhich shows where the issue is.\r\n\r\n\r\n\r\n----------------\r\n\r\n*Original issue*: https://gitlab.com/lfortran/lfortran/-/issues/664\r\n\r\nIt would be very useful to have LFortran able to compile Minpack, currently it fails with commit 74d6438a8\r\n\r\n```\r\n❯ lfortran --version\r\nLFortran version: 0.14.0-1345-g74d6438a8\r\nPlatform: Linux\r\nDefault target: x86_64-unknown-linux-gnu\r\n❯ fpm build --compiler lfortran\r\nminpack.f90                            failed.\r\n[   7%]Compiling...\r\nsemantic error: Value of a parameter variable must evaluate to a compile time constant\r\n  --> ././src/minpack.f90:20:5\r\n   |\r\n20 |     real(wp), parameter, private :: epsmch = dpmpar(1) !! the machine precision\r\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ \r\n\r\n\r\nNote: if any of the above error or warning messages are not clear or are lacking\r\ncontext please report it to us (we consider that a bug that needs to be fixed).\r\n```\r\n\r\nWith a minor patch:\r\n\r\n```diff\r\ndiff --git a/src/minpack.f90 b/src/minpack.f90\r\nindex 65fe5b1..ad60201 100644\r\n--- a/src/minpack.f90\r\n+++ b/src/minpack.f90\r\n@@ -17,7 +17,7 @@ module minpack_module\r\n                                                    tiny(1.0_wp), &\r\n                                                    huge(1.0_wp)] !! machine constants\r\n \r\n-    real(wp), parameter, private :: epsmch = dpmpar(1) !! the machine precision\r\n+    real(wp), parameter, private :: epsmch = epsilon(1.0_wp) !! the machine precision\r\n     real(wp), parameter, private :: one = 1.0_wp\r\n     real(wp), parameter, private :: zero = 0.0_wp\r\n \r\n```\r\n\r\nI'm getting an error for the procedure pointer\r\n\r\n```\r\n❯ fpm build --compiler lfortran\r\nminpack.f90                            failed.\r\n[   7%]Compiling...\r\nsemantic error: Type not implemented yet.\r\n   --> ./src/minpack.f90:438:9\r\n    |\r\n438 |         procedure(func) :: fcn !! the user-supplied subroutine which\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^ \r\n\r\n\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/lfortran/lfortran/issues/512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/lfortran/lfortran/issues/512/timeline","performed_via_github_app":null,"state_reason":null}