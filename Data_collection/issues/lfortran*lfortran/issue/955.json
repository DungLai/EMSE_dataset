{"url":"https://api.github.com/repos/lfortran/lfortran/issues/955","repository_url":"https://api.github.com/repos/lfortran/lfortran","labels_url":"https://api.github.com/repos/lfortran/lfortran/issues/955/labels{/name}","comments_url":"https://api.github.com/repos/lfortran/lfortran/issues/955/comments","events_url":"https://api.github.com/repos/lfortran/lfortran/issues/955/events","html_url":"https://github.com/lfortran/lfortran/issues/955","id":1426306801,"node_id":"I_kwDOCpMuHc5VA7bx","number":955,"title":"CreateGEP fails","user":{"login":"certik","id":20568,"node_id":"MDQ6VXNlcjIwNTY4","avatar_url":"https://avatars.githubusercontent.com/u/20568?v=4","gravatar_id":"","url":"https://api.github.com/users/certik","html_url":"https://github.com/certik","followers_url":"https://api.github.com/users/certik/followers","following_url":"https://api.github.com/users/certik/following{/other_user}","gists_url":"https://api.github.com/users/certik/gists{/gist_id}","starred_url":"https://api.github.com/users/certik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/certik/subscriptions","organizations_url":"https://api.github.com/users/certik/orgs","repos_url":"https://api.github.com/users/certik/repos","events_url":"https://api.github.com/users/certik/events{/privacy}","received_events_url":"https://api.github.com/users/certik/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"czgdp1807","id":36567889,"node_id":"MDQ6VXNlcjM2NTY3ODg5","avatar_url":"https://avatars.githubusercontent.com/u/36567889?v=4","gravatar_id":"","url":"https://api.github.com/users/czgdp1807","html_url":"https://github.com/czgdp1807","followers_url":"https://api.github.com/users/czgdp1807/followers","following_url":"https://api.github.com/users/czgdp1807/following{/other_user}","gists_url":"https://api.github.com/users/czgdp1807/gists{/gist_id}","starred_url":"https://api.github.com/users/czgdp1807/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/czgdp1807/subscriptions","organizations_url":"https://api.github.com/users/czgdp1807/orgs","repos_url":"https://api.github.com/users/czgdp1807/repos","events_url":"https://api.github.com/users/czgdp1807/events{/privacy}","received_events_url":"https://api.github.com/users/czgdp1807/received_events","type":"User","site_admin":false},"assignees":[{"login":"czgdp1807","id":36567889,"node_id":"MDQ6VXNlcjM2NTY3ODg5","avatar_url":"https://avatars.githubusercontent.com/u/36567889?v=4","gravatar_id":"","url":"https://api.github.com/users/czgdp1807","html_url":"https://github.com/czgdp1807","followers_url":"https://api.github.com/users/czgdp1807/followers","following_url":"https://api.github.com/users/czgdp1807/following{/other_user}","gists_url":"https://api.github.com/users/czgdp1807/gists{/gist_id}","starred_url":"https://api.github.com/users/czgdp1807/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/czgdp1807/subscriptions","organizations_url":"https://api.github.com/users/czgdp1807/orgs","repos_url":"https://api.github.com/users/czgdp1807/repos","events_url":"https://api.github.com/users/czgdp1807/events{/privacy}","received_events_url":"https://api.github.com/users/czgdp1807/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-10-27T21:52:29Z","updated_at":"2022-10-28T05:33:34Z","closed_at":"2022-10-28T05:33:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The following code is a minimal reproducible example:\r\n```fortran\r\nprogram print_array\r\n\r\ncontains\r\n\r\nsubroutine f(n, x)\r\ninteger :: n, x(n)\r\nprint *, x\r\nend subroutine\r\n\r\nend program\r\n```\r\nAnd it gives the following error:\r\n```console\r\n$ lfortran a.f90\r\nInternal Compiler Error: Unhandled exception\r\nTraceback (most recent call last):\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 1793\r\n    err = compile_to_object_file(arg_file, tmp_o, false,\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 773\r\n    res = fe.get_llvm3(*asr, lpm, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 321\r\n    compiler_options, run_fn);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 6195\r\n    v.nested_func_types = pass_find_nested_vars(asr, context,\r\n  File \"../libasr/asr.h\", line 4080\r\n  File \"../libasr/asr.h\", line 4057\r\n  File \"../libasr/asr.h\", line 4081\r\n  File \"../libasr/asr.h\", line 3836\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 1157\r\n    visit_symbol(*item.second);\r\n  File \"../libasr/asr.h\", line 4083\r\n  File \"../libasr/asr.h\", line 3845\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 2150\r\n    visit_procedures(x);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3398\r\n    ASR::Function_t *s = ASR::down_cast<ASR::Function_t>(item.second);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3037\r\n    visit_procedures(x);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3351\r\n    this->visit_stmt(*x.m_body[i]);\r\n  File \"../libasr/asr.h\", line 4098\r\n  File \"../libasr/asr.h\", line 3867\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3767\r\n    this->visit_expr_wrapper(x.m_value, true);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3825\r\n    this->visit_expr(*x);\r\n  File \"../libasr/asr.h\", line 4141\r\n  File \"../libasr/asr.h\", line 3927\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 4266\r\n    this->visit_expr_wrapper(x.m_left, true);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3825\r\n    this->visit_expr(*x);\r\n  File \"../libasr/asr.h\", line 4141\r\n  File \"../libasr/asr.h\", line 3964\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 6152\r\n    llvm::Value* dim_des_val = arr_descr->get_pointer_to_dimension_descriptor_array(llvm_arg1);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_array_utils.cpp\", line 249\r\n    llvm::Value* dim_des_arr_ptr = llvm_utils->create_gep(arr, 2);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 120\r\n    return LLVM::CreateGEP(*builder, ds, idx_vec);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 24\r\n    LFORTRAN_ASSERT(t->isPointerTy());\r\nAssertFailed: t->isPointerTy()\r\n```\r\n\r\n\r\nThe actual error was discovered by:\r\n```console\r\n$ lfortran -Isrc --rtlib -c ../examples/example_hybrd.f90 -o a.o\r\nAssertion failed: (Ty && \"Invalid GetElementPtrInst indices for type!\"), function checkGEPType, file Instructions.h, line 897.\r\nTraceback (most recent call last):\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 1762\r\n    return compile_to_object_file(arg_file, outfile, false,\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 773\r\n    res = fe.get_llvm3(*asr, lpm, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 321\r\n    compiler_options, run_fn);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 6195\r\n    v.nested_func_types = pass_find_nested_vars(asr, context,\r\n  File \"../libasr/asr.h\", line 4080\r\n  File \"../libasr/asr.h\", line 4057\r\n  File \"../libasr/asr.h\", line 4081\r\n  File \"../libasr/asr.h\", line 3836\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 1157\r\n    visit_symbol(*item.second);\r\n  File \"../libasr/asr.h\", line 4083\r\n  File \"../libasr/asr.h\", line 3845\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 2150\r\n    visit_procedures(x);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3398\r\n    ASR::Function_t *s = ASR::down_cast<ASR::Function_t>(item.second);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3037\r\n    visit_procedures(x);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3351\r\n    this->visit_stmt(*x.m_body[i]);\r\n  File \"../libasr/asr.h\", line 4098\r\n  File \"../libasr/asr.h\", line 3867\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3767\r\n    this->visit_expr_wrapper(x.m_value, true);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3825\r\n    this->visit_expr(*x);\r\n  File \"../libasr/asr.h\", line 4141\r\n  File \"../libasr/asr.h\", line 3927\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 4266\r\n    this->visit_expr_wrapper(x.m_left, true);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3825\r\n    this->visit_expr(*x);\r\n  File \"../libasr/asr.h\", line 4141\r\n  File \"../libasr/asr.h\", line 3964\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 6152\r\n    llvm::Value* dim_des_val = arr_descr->get_pointer_to_dimension_descriptor_array(llvm_arg1);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_array_utils.cpp\", line 249\r\n    llvm::Value* dim_des_arr_ptr = llvm_utils->create_gep(arr, 2);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 120\r\n    return LLVM::CreateGEP(*builder, ds, idx_vec);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 26\r\n    return builder.CreateGEP(t2, x, idx);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/IRBuilder.h\", line 1773\r\n    return Insert(GetElementPtrInst::Create(Ty, Ptr, IdxList), Name);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 943\r\n    NameStr, InsertBefore);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1151\r\n    }\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1143\r\n    : Instruction(getGEPReturnType(PointeeType, Ptr, IdxList), GetElementPtr,\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1074\r\n    Type *PtrTy = PointerType::get(checkGEPType(getIndexedType(ElTy, IdxList)),\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 897\r\n    assert(Ty && \"Invalid GetElementPtrInst indices for type!\");\r\n  Binary file \"/usr/lib/system/libsystem_c.dylib\", local address: 0x18024972b\r\n  Binary file \"/usr/lib/system/libsystem_c.dylib\", local address: 0x18024a313\r\n  Binary file \"/usr/lib/system/libsystem_pthread.dylib\", local address: 0x18030ceaf\r\n  Binary file \"/usr/lib/system/libsystem_platform.dylib\", local address: 0x1803244e3\r\nAbort: Signal SIGABRT (abort) received\r\n\r\nzsh: abort      lfortran -Isrc --rtlib -c ../examples/example_hybrd.f90 -o a.o\r\n```\r\nWhich is a slightly different error stacktrace, but it is most likely the same\r\nissue.\r\n\r\nOnce we fix the minimum example above, we have to test for the actual error to\r\nsee if there is more than one issue.","closed_by":{"login":"czgdp1807","id":36567889,"node_id":"MDQ6VXNlcjM2NTY3ODg5","avatar_url":"https://avatars.githubusercontent.com/u/36567889?v=4","gravatar_id":"","url":"https://api.github.com/users/czgdp1807","html_url":"https://github.com/czgdp1807","followers_url":"https://api.github.com/users/czgdp1807/followers","following_url":"https://api.github.com/users/czgdp1807/following{/other_user}","gists_url":"https://api.github.com/users/czgdp1807/gists{/gist_id}","starred_url":"https://api.github.com/users/czgdp1807/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/czgdp1807/subscriptions","organizations_url":"https://api.github.com/users/czgdp1807/orgs","repos_url":"https://api.github.com/users/czgdp1807/repos","events_url":"https://api.github.com/users/czgdp1807/events{/privacy}","received_events_url":"https://api.github.com/users/czgdp1807/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/lfortran/lfortran/issues/955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/lfortran/lfortran/issues/955/timeline","performed_via_github_app":null,"state_reason":"completed"}