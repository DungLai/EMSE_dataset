{"url":"https://api.github.com/repos/lfortran/lfortran/issues/610","repository_url":"https://api.github.com/repos/lfortran/lfortran","labels_url":"https://api.github.com/repos/lfortran/lfortran/issues/610/labels{/name}","comments_url":"https://api.github.com/repos/lfortran/lfortran/issues/610/comments","events_url":"https://api.github.com/repos/lfortran/lfortran/issues/610/events","html_url":"https://github.com/lfortran/lfortran/issues/610","id":1341586997,"node_id":"I_kwDOCpMuHc5P9v41","number":610,"title":"LLVM backend: Bug in visit_ArraySize","user":{"login":"certik","id":20568,"node_id":"MDQ6VXNlcjIwNTY4","avatar_url":"https://avatars.githubusercontent.com/u/20568?v=4","gravatar_id":"","url":"https://api.github.com/users/certik","html_url":"https://github.com/certik","followers_url":"https://api.github.com/users/certik/followers","following_url":"https://api.github.com/users/certik/following{/other_user}","gists_url":"https://api.github.com/users/certik/gists{/gist_id}","starred_url":"https://api.github.com/users/certik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/certik/subscriptions","organizations_url":"https://api.github.com/users/certik/orgs","repos_url":"https://api.github.com/users/certik/repos","events_url":"https://api.github.com/users/certik/events{/privacy}","received_events_url":"https://api.github.com/users/certik/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"czgdp1807","id":36567889,"node_id":"MDQ6VXNlcjM2NTY3ODg5","avatar_url":"https://avatars.githubusercontent.com/u/36567889?v=4","gravatar_id":"","url":"https://api.github.com/users/czgdp1807","html_url":"https://github.com/czgdp1807","followers_url":"https://api.github.com/users/czgdp1807/followers","following_url":"https://api.github.com/users/czgdp1807/following{/other_user}","gists_url":"https://api.github.com/users/czgdp1807/gists{/gist_id}","starred_url":"https://api.github.com/users/czgdp1807/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/czgdp1807/subscriptions","organizations_url":"https://api.github.com/users/czgdp1807/orgs","repos_url":"https://api.github.com/users/czgdp1807/repos","events_url":"https://api.github.com/users/czgdp1807/events{/privacy}","received_events_url":"https://api.github.com/users/czgdp1807/received_events","type":"User","site_admin":false},"assignees":[{"login":"czgdp1807","id":36567889,"node_id":"MDQ6VXNlcjM2NTY3ODg5","avatar_url":"https://avatars.githubusercontent.com/u/36567889?v=4","gravatar_id":"","url":"https://api.github.com/users/czgdp1807","html_url":"https://github.com/czgdp1807","followers_url":"https://api.github.com/users/czgdp1807/followers","following_url":"https://api.github.com/users/czgdp1807/following{/other_user}","gists_url":"https://api.github.com/users/czgdp1807/gists{/gist_id}","starred_url":"https://api.github.com/users/czgdp1807/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/czgdp1807/subscriptions","organizations_url":"https://api.github.com/users/czgdp1807/orgs","repos_url":"https://api.github.com/users/czgdp1807/repos","events_url":"https://api.github.com/users/czgdp1807/events{/privacy}","received_events_url":"https://api.github.com/users/czgdp1807/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-08-17T11:00:49Z","updated_at":"2022-08-17T18:01:30Z","closed_at":"2022-08-17T18:01:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"There is some bug in ArraySize handling for this simple example:\r\n```fortran\r\nprogram arrays_17\r\n    integer, parameter :: real_kinds(2) = [4, 8]\r\n    print *, size(real_kinds)\r\nend program\r\n```\r\n\r\nIt fails with:\r\n\r\n```console\r\n$ lfortran arrays_17.f90 --show-llvm\r\nAssertion failed: (Ty && \"Invalid GetElementPtrInst indices for type!\"), function checkGEPType, file Instructions.h, line 897.\r\nTraceback (most recent call last):\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 1651\r\n    return emit_llvm(arg_file, lfortran_pass_manager,\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/bin/lfortran.cpp\", line 663\r\n    = fe.get_llvm(input, lm, pass_manager, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 264\r\n    Result<std::unique_ptr<LLVMModule>> res = get_llvm2(code, lm, pass_manager, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 285\r\n    Result<std::unique_ptr<LLVMModule>> res = get_llvm3(*asr.result, pass_manager, diagnostics);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/lfortran/fortran_evaluator.cpp\", line 318\r\n    compiler_options.platform, run_fn);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 5352\r\n    v.nested_func_types = pass_find_nested_vars(asr, context,\r\n  File \"../libasr/asr.h\", line 3728\r\n  File \"../libasr/asr.h\", line 3706\r\n  File \"../libasr/asr.h\", line 3729\r\n  File \"../libasr/asr.h\", line 3505\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 1065\r\n    visit_symbol(*item.second);\r\n  File \"../libasr/asr.h\", line 3731\r\n  File \"../libasr/asr.h\", line 3514\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 1673\r\n    this->visit_stmt(*x.m_body[i]);\r\n  File \"../libasr/asr.h\", line 3744\r\n  File \"../libasr/asr.h\", line 3548\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 4486\r\n    handle_print(x);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 4536\r\n    this->visit_expr_wrapper(x.m_values[i], true);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 3070\r\n    this->visit_expr(*x);\r\n  File \"../libasr/asr.h\", line 3786\r\n  File \"../libasr/asr.h\", line 3627\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/asr_to_llvm.cpp\", line 5292\r\n    tmp = arr_descr->get_array_size(llvm_arg, llvm_dim, output_kind, dim_kind);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_array_utils.cpp\", line 492\r\n    llvm::Value* dim_des_val = this->get_pointer_to_dimension_descriptor_array(array);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_array_utils.cpp\", line 265\r\n    llvm::Value* dim_des_arr_ptr = llvm_utils->create_gep(arr, 2);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 82\r\n    return LLVM::CreateGEP(*builder, ds, idx_vec);\r\n  File \"/Users/ondrej/repos/lfortran/lfortran/src/libasr/codegen/llvm_utils.cpp\", line 25\r\n    return builder.CreateGEP(t2, x, idx);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/IRBuilder.h\", line 1773\r\n    return Insert(GetElementPtrInst::Create(Ty, Ptr, IdxList), Name);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 943\r\n    NameStr, InsertBefore);\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1151\r\n    }\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1143\r\n    : Instruction(getGEPReturnType(PointeeType, Ptr, IdxList), GetElementPtr,\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 1074\r\n    Type *PtrTy = PointerType::get(checkGEPType(getIndexedType(ElTy, IdxList)),\r\n  File \"/Users/ondrej/mambaforge/envs/lf/include/llvm/IR/Instructions.h\", line 897\r\n    assert(Ty && \"Invalid GetElementPtrInst indices for type!\");\r\n  Binary file \"/usr/lib/system/libsystem_c.dylib\", local address: 0x18024972b\r\n  Binary file \"/usr/lib/system/libsystem_c.dylib\", local address: 0x18024a313\r\n  Binary file \"/usr/lib/system/libsystem_pthread.dylib\", local address: 0x18030ceaf\r\n  Binary file \"/usr/lib/system/libsystem_platform.dylib\", local address: 0x1803244e3\r\nAbort: Signal SIGABRT (abort) received\r\n\r\nzsh: abort      lfortran arrays_17.f90 --show-llvm\r\n```\r\n\r\nBut both of these work:\r\n```fortran\r\nprogram arrays_17\r\n    integer :: real_kinds(2)\r\n    print *, size(real_kinds)\r\nend program\r\n```\r\nand:\r\n```fortran\r\nprogram arrays_17\r\n    integer, parameter :: real_kinds(2) = [4, 8]\r\n    print *, real_kinds(1), real_kinds(2)\r\nend program\r\n```\r\n\r\nI tried debugging it, but can't figure it out. The LLVM code (if I can print it) seems correct, but it seems `GetElementPtrInst` has invalid indices somehow. @czgdp1807 by any chance do you know what could be causing this?","closed_by":{"login":"certik","id":20568,"node_id":"MDQ6VXNlcjIwNTY4","avatar_url":"https://avatars.githubusercontent.com/u/20568?v=4","gravatar_id":"","url":"https://api.github.com/users/certik","html_url":"https://github.com/certik","followers_url":"https://api.github.com/users/certik/followers","following_url":"https://api.github.com/users/certik/following{/other_user}","gists_url":"https://api.github.com/users/certik/gists{/gist_id}","starred_url":"https://api.github.com/users/certik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/certik/subscriptions","organizations_url":"https://api.github.com/users/certik/orgs","repos_url":"https://api.github.com/users/certik/repos","events_url":"https://api.github.com/users/certik/events{/privacy}","received_events_url":"https://api.github.com/users/certik/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/lfortran/lfortran/issues/610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/lfortran/lfortran/issues/610/timeline","performed_via_github_app":null,"state_reason":"completed"}