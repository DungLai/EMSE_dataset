[{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469468127","html_url":"https://github.com/msracver/Deep-Exemplar-based-Colorization/issues/9#issuecomment-469468127","issue_url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/9","id":469468127,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTQ2ODEyNw==","user":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false},"created_at":"2019-03-04T23:26:08Z","updated_at":"2019-03-04T23:26:08Z","author_association":"COLLABORATOR","body":"@dorpxam Hello, do you mean the gradient did not update in the deconv function with your CPU-based L-BFGS? \r\nIn the previous GPU-based implementation (decov.cpp), `diff` (`float* diff = m_classifier->net_->blob_by_name(m_layer1)->mutable_gpu_diff();`) is gpu_ptr to the gradient object, whose data will be updated by the following substraction (`caffe_gpu_sub(m_num1, src, m_dy, **diff**);`). \r\nIn your code, before calling `m_classifier->net_->BackwardFromTo(m_id1, m_id2 + 1)`, have you updated the gradient values `diff` on gpu?","reactions":{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469468127/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false}},{"id":2179430212,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjE3OTQzMDIxMg==","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2179430212","actor":null,"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-03-04T23:26:08Z","performed_via_github_app":null},{"id":2179430215,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDIxNzk0MzAyMTU=","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2179430215","actor":null,"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-03-04T23:26:08Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469601806","html_url":"https://github.com/msracver/Deep-Exemplar-based-Colorization/issues/9#issuecomment-469601806","issue_url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/9","id":469601806,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTYwMTgwNg==","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false},"created_at":"2019-03-05T09:15:05Z","updated_at":"2019-03-05T09:15:05Z","author_association":"NONE","body":"With my change, the cost function become : \r\n\r\n```\r\nvoid my_cost_function::cpu_f_gradf(const floatdouble *h_x, floatdouble *h_f, floatdouble *h_gradf)\r\n{\r\n\tm_classifier->net_->ForwardFromTo(m_id2 + 1, m_id1);\r\n\r\n\tconst float* src = m_classifier->net_->blob_by_name(m_layer1)->cpu_data();\r\n\tfloat* diff = m_classifier->net_->blob_by_name(m_layer1)->mutable_cpu_diff();\r\n\tcaffe_sub(m_num1, src, m_dy, diff);\r\n\r\n\tfloat* diff2;\r\n\tdiff2 = (float*)malloc(m_num1 * sizeof(float));\r\n\tcaffe_mul(m_num1, diff, diff, diff2);\r\n\r\n\tfloat total;\r\n\ttotal = caffe_cpu_asum(m_num1, diff2);\r\n\r\n\tm_classifier->net_->BackwardFromTo(m_id1, m_id2 + 1);\r\n\r\n\tconst float* diff3 = m_classifier->net_->blob_by_name(m_layer2)->cpu_diff();\r\n\tmemcpy(h_gradf, diff3, m_num2*sizeof(float));\r\n\tmemcpy(h_f, &total, sizeof(float));\r\n\r\n\tfree(diff2);\r\n}\r\n```\r\n\r\nAnd launched in the deconv method by : \r\n\r\n```\r\nmy_cost_function func (classifier, m_layer1, d_y, num1, m_layer2, num2, id1, id2);\r\n\r\nlbfgs solver (func);\r\n\r\nlbfgs::status s = solver.cpu_lbfgs(d_x);\r\n\r\nstd::cout << solver.statusToString(s) << std::endl;\r\n```\r\n\r\ndiff is correctly modified, but (as you can see in the log) the Forward/Backward seem broken somewhere and does not propagate the change. I don't think it's a model loading problem because except the hack on the math function files (for cublas v1), caffe is the version cloned on your hub with all the (nutget) dependencies.\r\n\r\nThank you for your help.","reactions":{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469601806/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469836568","html_url":"https://github.com/msracver/Deep-Exemplar-based-Colorization/issues/9#issuecomment-469836568","issue_url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/9","id":469836568,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTgzNjU2OA==","user":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false},"created_at":"2019-03-05T20:01:56Z","updated_at":"2019-03-05T20:01:56Z","author_association":"COLLABORATOR","body":"@dorpxam Thanks for sharing your code. \r\nI think the major problem in your code should be caused by unsynchronized CPU and GPU memory. There are 4 states in Caffe for CPU and GPU memory management, UNINITIALIZED, HEAD_AT_CPU, HEAD_AT_GPU, SYNCED. In your situation, the state should be SYNCED to ensure data consistency between CPU and GPU. But this state will be violated by `mutable_cpu_diff()`. As a result, only CPU data is updated, asynchronous to GPU memory. You may check the state before and after. Maybe \r\n `async_gpu_push` can be used to copy data from CPU to GPU before calling `BackwardFromTo(m_id1, m_id2 + 1)`. More details can be found in caffe source code (https://github.com/BVLC/caffe/blob/master/src/caffe/syncedmem.cpp).\r\nBTW, the input data type should be `float` instead of `floatdouble`.\r\nHope this could be helpful.","reactions":{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/469836568/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false}},{"id":2182152252,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjE4MjE1MjI1Mg==","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2182152252","actor":null,"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-03-05T20:01:56Z","performed_via_github_app":null},{"id":2182152253,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDIxODIxNTIyNTM=","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2182152253","actor":null,"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-03-05T20:01:56Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/470051354","html_url":"https://github.com/msracver/Deep-Exemplar-based-Colorization/issues/9#issuecomment-470051354","issue_url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/9","id":470051354,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MDA1MTM1NA==","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false},"created_at":"2019-03-06T10:18:01Z","updated_at":"2019-03-06T10:18:01Z","author_association":"NONE","body":"@hmmlillian Thanks for your answer.\r\nI understand. As I have said before, I init caffe in CPU mode. So the trained data was loaded in cpu_ptr memory blobs. The classifiers was modified to load the differents vectors of memory in cpu mem (data_A / data_AP / data_B / data_BP) mutable or copy. For my limited GPU memory hardware, I only move the cpu memory to allow use the differents block/thread cuda methods in the deep_image_analogy methods. The DeepAnalogy.cu file (in pseudo code) : \r\n\r\n```\r\nclassifier_A -> load all layers on cpu from trained datas to vector of / A / AP / \r\nclassifier B -> load all layers on cpu from trained datas to vector of / B / BP / \r\n\r\nNo change on ANN/ANND -> host on cpu / device on gpu\r\n\r\nfor each layers // from 32 to 512\r\n{\r\n    memcpy current_layer (A/AP/B/BP) to GPU\r\n\r\n    No change in the GPU process for :  \r\n    init/upsample -> norm -> blend -> norm -> patchmatch \r\n\r\n    Process avg_vote on GPU too and move target result to CPU\r\n\r\n    copy back A/AP/B/BP to CPU\r\n\r\n    launch deconv on CPU two times for data_AP[next_layer] and data_B[next_layer]\r\n\r\n    free cuda mem for current_layer of A/AP/B/BP\r\n}\r\n```\r\n\r\nSo the only time where the memory go to GPU, this is temporary. Only to process the differents layers and use the code in \"GeneralizedPatchMatch.cu\" without any change.\r\n\r\nNote that the `floatdouble` is not typedefined as `double` but as `float` ofcourse ;)\r\n\r\nI will investigate the question of async memory and the states as you've said.\r\n\r\nIn any case, thank's a lot for your help.","reactions":{"url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/comments/470051354/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false}},{"id":2183662689,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjE4MzY2MjY4OQ==","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2183662689","actor":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-03-06T10:18:01Z","performed_via_github_app":null},{"id":2183662690,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDIxODM2NjI2OTA=","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/2183662690","actor":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-03-06T10:18:01Z","performed_via_github_app":null},{"id":3206630512,"node_id":"MDExOkNsb3NlZEV2ZW50MzIwNjYzMDUxMg==","url":"https://api.github.com/repos/msracver/Deep-Exemplar-based-Colorization/issues/events/3206630512","actor":{"login":"hmmlillian","id":42595731,"node_id":"MDQ6VXNlcjQyNTk1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/42595731?v=4","gravatar_id":"","url":"https://api.github.com/users/hmmlillian","html_url":"https://github.com/hmmlillian","followers_url":"https://api.github.com/users/hmmlillian/followers","following_url":"https://api.github.com/users/hmmlillian/following{/other_user}","gists_url":"https://api.github.com/users/hmmlillian/gists{/gist_id}","starred_url":"https://api.github.com/users/hmmlillian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hmmlillian/subscriptions","organizations_url":"https://api.github.com/users/hmmlillian/orgs","repos_url":"https://api.github.com/users/hmmlillian/repos","events_url":"https://api.github.com/users/hmmlillian/events{/privacy}","received_events_url":"https://api.github.com/users/hmmlillian/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-04-06T18:16:45Z","state_reason":null,"performed_via_github_app":null}]