{"url":"https://api.github.com/repos/mikgroup/sigpy/issues/73","repository_url":"https://api.github.com/repos/mikgroup/sigpy","labels_url":"https://api.github.com/repos/mikgroup/sigpy/issues/73/labels{/name}","comments_url":"https://api.github.com/repos/mikgroup/sigpy/issues/73/comments","events_url":"https://api.github.com/repos/mikgroup/sigpy/issues/73/events","html_url":"https://github.com/mikgroup/sigpy/issues/73","id":857871240,"node_id":"MDU6SXNzdWU4NTc4NzEyNDA=","number":73,"title":"ESPIRiT with GPU producing different results compared to CPU","user":{"login":"adithyaOvGu","id":59664991,"node_id":"MDQ6VXNlcjU5NjY0OTkx","avatar_url":"https://avatars.githubusercontent.com/u/59664991?v=4","gravatar_id":"","url":"https://api.github.com/users/adithyaOvGu","html_url":"https://github.com/adithyaOvGu","followers_url":"https://api.github.com/users/adithyaOvGu/followers","following_url":"https://api.github.com/users/adithyaOvGu/following{/other_user}","gists_url":"https://api.github.com/users/adithyaOvGu/gists{/gist_id}","starred_url":"https://api.github.com/users/adithyaOvGu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adithyaOvGu/subscriptions","organizations_url":"https://api.github.com/users/adithyaOvGu/orgs","repos_url":"https://api.github.com/users/adithyaOvGu/repos","events_url":"https://api.github.com/users/adithyaOvGu/events{/privacy}","received_events_url":"https://api.github.com/users/adithyaOvGu/received_events","type":"User","site_admin":false},"labels":[{"id":983094941,"node_id":"MDU6TGFiZWw5ODMwOTQ5NDE=","url":"https://api.github.com/repos/mikgroup/sigpy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2021-04-14T12:55:54Z","updated_at":"2021-04-22T21:32:34Z","closed_at":"2021-04-22T21:25:13Z","author_association":"NONE","active_lock_reason":null,"body":"Hello, \r\n\r\nI have been using SigPy to perform L1-wavelet CS and TV reconstruction of undersampled data stored in h5 files. One of the steps in my workflow involves estimating Sensitivy maps of undersampled data with a certain ACS region using the ESPIRiT app. \r\n\r\n**My script produces the desired maps and reconstruction results while computing on a local system **with no GPU**. Because of the longer computation time, I deployed the same script in a remote machine with GPU**\r\n\r\nThe only changes made to the script was the addition of **device=sp.Device(0)** to the **ESPIRiT** app and convertion of cupy.ndarray to numpy.ndarray as seen in the lines below:\r\n\r\n``` \r\nmps_msk = mr.app.EspiritCalib(Masked_ksp, calib_width=num_low_frequency, device=sp.Device(0)).run()\r\nmps_msk = cupy.asnumpy(mps_msk) \r\n```\r\n\r\n**Expected behavior**\r\nComputation of Sensitivity maps (**in the local system**) for Undersampled data with ACS region = 13 produces the sensitivity maps and its coil combined image (slice number 6) as seen below. \r\n```\r\n mps_msk = mr.app.EspiritCalib(Masked_ksp, calib_width=num_low_frequency).run()\r\n```\r\n![Sense_13](https://user-images.githubusercontent.com/59664991/114709116-7b702100-9d2c-11eb-96c7-7b6a5fe6cd12.png)  ![Under_13_local](https://user-images.githubusercontent.com/59664991/114709125-7e6b1180-9d2c-11eb-9371-aee273698be3.png)\r\n\r\n**Issue**\r\nThe ESPIRiT computation on the same data (with same ACS region) performed in the **remote machine with GPU**(device=sp.Device(0) enabled) lead to faster computation but produced **unexpected cropping** of the maps as seen in the below images.\r\n\r\n![Sense_13_GPU](https://user-images.githubusercontent.com/59664991/114709795-4c0de400-9d2d-11eb-85b6-e94e9c70eb0b.png) ![Under_13_GPU](https://user-images.githubusercontent.com/59664991/114709809-4e703e00-9d2d-11eb-9b20-510eec38fc0e.png)\r\n\r\n**Problem** \r\nThis unexpected behavior of cropping in estimated maps leads to cropping or poor reconstruction of the Image as seen below. \r\n\r\n![L1W_13](https://user-images.githubusercontent.com/59664991/114711258-0a7e3880-9d2f-11eb-9a36-e73a4aad014e.png) ![L1W_13_GPU](https://user-images.githubusercontent.com/59664991/114711277-0eaa5600-9d2f-11eb-8ed3-d94f659561a4.png)\r\n\r\n![TV_13](https://user-images.githubusercontent.com/59664991/114711350-1ff36280-9d2f-11eb-814c-6bb2e1dabb7d.png)\r\n![TV_13_GPU](https://user-images.githubusercontent.com/59664991/114711359-2255bc80-9d2f-11eb-827f-cd5134d28155.png)\r\n\r\n\r\n**Desktop (Local machine):**\r\n- Machine: Macbook Pro mid 2012\r\n - OS: macOS Catalina\r\n - Version: 10.15.7\r\n - Graphics: Intel HD Graphics 4000 1536 MB\r\n - Memory: 8 GB 1600 MHz DDR3\r\n - Processor: 2,5 GHz Dual-Core Intel Core i5\r\n\r\n**Desktop (Remote server):**\r\n - OS: Manjaro Linux 64bit / Linux 5.10.2-2-MANJARO\r\n - Graphics: GeForce RTX 2080 Ti 10GB\r\n\r\n**Additional context**\r\nAfter estimating the sensitivity maps, I convert cupy.ndarray to numpy.ndarray to store the data in the h5 file. As far as my understanding goes, this does not cause any changes in the data. \r\n\r\n**My input k-space shape to the Espirit app is [coils, RO, PE] and calib_width=num_low_frequency = 13 for 8-fold accelerated data.** \r\n\r\nI kindly request you to provide some insight and solution to this issue, so that I could make my work reproducible. \r\n\r\nPS: I would also like to thank all the developers and contributors of SigPy for providing us with this awesome toolkit. \r\n","closed_by":{"login":"adithyaOvGu","id":59664991,"node_id":"MDQ6VXNlcjU5NjY0OTkx","avatar_url":"https://avatars.githubusercontent.com/u/59664991?v=4","gravatar_id":"","url":"https://api.github.com/users/adithyaOvGu","html_url":"https://github.com/adithyaOvGu","followers_url":"https://api.github.com/users/adithyaOvGu/followers","following_url":"https://api.github.com/users/adithyaOvGu/following{/other_user}","gists_url":"https://api.github.com/users/adithyaOvGu/gists{/gist_id}","starred_url":"https://api.github.com/users/adithyaOvGu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adithyaOvGu/subscriptions","organizations_url":"https://api.github.com/users/adithyaOvGu/orgs","repos_url":"https://api.github.com/users/adithyaOvGu/repos","events_url":"https://api.github.com/users/adithyaOvGu/events{/privacy}","received_events_url":"https://api.github.com/users/adithyaOvGu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mikgroup/sigpy/issues/73/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mikgroup/sigpy/issues/73/timeline","performed_via_github_app":null,"state_reason":"completed"}