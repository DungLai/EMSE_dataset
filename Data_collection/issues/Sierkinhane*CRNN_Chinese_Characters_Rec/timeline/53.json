[{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/487374766","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-487374766","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":487374766,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzM3NDc2Ng==","user":{"login":"JingLiJJ","id":32951124,"node_id":"MDQ6VXNlcjMyOTUxMTI0","avatar_url":"https://avatars.githubusercontent.com/u/32951124?v=4","gravatar_id":"","url":"https://api.github.com/users/JingLiJJ","html_url":"https://github.com/JingLiJJ","followers_url":"https://api.github.com/users/JingLiJJ/followers","following_url":"https://api.github.com/users/JingLiJJ/following{/other_user}","gists_url":"https://api.github.com/users/JingLiJJ/gists{/gist_id}","starred_url":"https://api.github.com/users/JingLiJJ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JingLiJJ/subscriptions","organizations_url":"https://api.github.com/users/JingLiJJ/orgs","repos_url":"https://api.github.com/users/JingLiJJ/repos","events_url":"https://api.github.com/users/JingLiJJ/events{/privacy}","received_events_url":"https://api.github.com/users/JingLiJJ/received_events","type":"User","site_admin":false},"created_at":"2019-04-28T12:29:25Z","updated_at":"2019-04-28T12:29:25Z","author_association":"NONE","body":"> up主，想过修改成可以在多个显卡上运行么？\r\n> 或者可以提供点参考资料。\r\n> \r\n> 单单使用Dataparalle，在CTCloss那块会出现batchsize不匹配的问题；\r\n> 这个batchsize是在dataloader那里就成了para里设定值（B）的一半，还是取完所有B后，split成B/2的？\r\n> \r\n> pytorch的API太高层了，不知道底层怎么实现的，思维有点混乱。不如tensorflow的单机多卡流程清晰，数据分成n份，feed给各个模型，然后各自计算loss与需要变化的grad，最后将grad平均后，同步到多卡。\r\n\r\n你好。请问你解决这个问题了嘛？","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/487374766/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JingLiJJ","id":32951124,"node_id":"MDQ6VXNlcjMyOTUxMTI0","avatar_url":"https://avatars.githubusercontent.com/u/32951124?v=4","gravatar_id":"","url":"https://api.github.com/users/JingLiJJ","html_url":"https://github.com/JingLiJJ","followers_url":"https://api.github.com/users/JingLiJJ/followers","following_url":"https://api.github.com/users/JingLiJJ/following{/other_user}","gists_url":"https://api.github.com/users/JingLiJJ/gists{/gist_id}","starred_url":"https://api.github.com/users/JingLiJJ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JingLiJJ/subscriptions","organizations_url":"https://api.github.com/users/JingLiJJ/orgs","repos_url":"https://api.github.com/users/JingLiJJ/repos","events_url":"https://api.github.com/users/JingLiJJ/events{/privacy}","received_events_url":"https://api.github.com/users/JingLiJJ/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/489963206","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-489963206","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":489963206,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4OTk2MzIwNg==","user":{"login":"Fighting-JJ","id":17001854,"node_id":"MDQ6VXNlcjE3MDAxODU0","avatar_url":"https://avatars.githubusercontent.com/u/17001854?v=4","gravatar_id":"","url":"https://api.github.com/users/Fighting-JJ","html_url":"https://github.com/Fighting-JJ","followers_url":"https://api.github.com/users/Fighting-JJ/followers","following_url":"https://api.github.com/users/Fighting-JJ/following{/other_user}","gists_url":"https://api.github.com/users/Fighting-JJ/gists{/gist_id}","starred_url":"https://api.github.com/users/Fighting-JJ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Fighting-JJ/subscriptions","organizations_url":"https://api.github.com/users/Fighting-JJ/orgs","repos_url":"https://api.github.com/users/Fighting-JJ/repos","events_url":"https://api.github.com/users/Fighting-JJ/events{/privacy}","received_events_url":"https://api.github.com/users/Fighting-JJ/received_events","type":"User","site_admin":false},"created_at":"2019-05-07T07:15:53Z","updated_at":"2019-05-07T07:15:53Z","author_association":"NONE","body":"没有","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/489963206/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Fighting-JJ","id":17001854,"node_id":"MDQ6VXNlcjE3MDAxODU0","avatar_url":"https://avatars.githubusercontent.com/u/17001854?v=4","gravatar_id":"","url":"https://api.github.com/users/Fighting-JJ","html_url":"https://github.com/Fighting-JJ","followers_url":"https://api.github.com/users/Fighting-JJ/followers","following_url":"https://api.github.com/users/Fighting-JJ/following{/other_user}","gists_url":"https://api.github.com/users/Fighting-JJ/gists{/gist_id}","starred_url":"https://api.github.com/users/Fighting-JJ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Fighting-JJ/subscriptions","organizations_url":"https://api.github.com/users/Fighting-JJ/orgs","repos_url":"https://api.github.com/users/Fighting-JJ/repos","events_url":"https://api.github.com/users/Fighting-JJ/events{/privacy}","received_events_url":"https://api.github.com/users/Fighting-JJ/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/502555955","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-502555955","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":502555955,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMjU1NTk1NQ==","user":{"login":"Lanme","id":28859589,"node_id":"MDQ6VXNlcjI4ODU5NTg5","avatar_url":"https://avatars.githubusercontent.com/u/28859589?v=4","gravatar_id":"","url":"https://api.github.com/users/Lanme","html_url":"https://github.com/Lanme","followers_url":"https://api.github.com/users/Lanme/followers","following_url":"https://api.github.com/users/Lanme/following{/other_user}","gists_url":"https://api.github.com/users/Lanme/gists{/gist_id}","starred_url":"https://api.github.com/users/Lanme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lanme/subscriptions","organizations_url":"https://api.github.com/users/Lanme/orgs","repos_url":"https://api.github.com/users/Lanme/repos","events_url":"https://api.github.com/users/Lanme/events{/privacy}","received_events_url":"https://api.github.com/users/Lanme/received_events","type":"User","site_admin":false},"created_at":"2019-06-17T06:47:53Z","updated_at":"2019-06-17T06:47:53Z","author_association":"NONE","body":"我也遇到了这个问题，输入(batch,imgH,imgW)是(1024,32,280)单卡的preds.size()是torch.Size([71, 1024, 6009])，但是多卡的是torch.Size([142, 512, 6009])，不过我看网上说是在前向传播的时候才等分的，怎么输出序列的大小也变了呢？","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/502555955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Lanme","id":28859589,"node_id":"MDQ6VXNlcjI4ODU5NTg5","avatar_url":"https://avatars.githubusercontent.com/u/28859589?v=4","gravatar_id":"","url":"https://api.github.com/users/Lanme","html_url":"https://github.com/Lanme","followers_url":"https://api.github.com/users/Lanme/followers","following_url":"https://api.github.com/users/Lanme/following{/other_user}","gists_url":"https://api.github.com/users/Lanme/gists{/gist_id}","starred_url":"https://api.github.com/users/Lanme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lanme/subscriptions","organizations_url":"https://api.github.com/users/Lanme/orgs","repos_url":"https://api.github.com/users/Lanme/repos","events_url":"https://api.github.com/users/Lanme/events{/privacy}","received_events_url":"https://api.github.com/users/Lanme/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/518179413","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-518179413","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":518179413,"node_id":"MDEyOklzc3VlQ29tbWVudDUxODE3OTQxMw==","user":{"login":"cqray1990","id":32585434,"node_id":"MDQ6VXNlcjMyNTg1NDM0","avatar_url":"https://avatars.githubusercontent.com/u/32585434?v=4","gravatar_id":"","url":"https://api.github.com/users/cqray1990","html_url":"https://github.com/cqray1990","followers_url":"https://api.github.com/users/cqray1990/followers","following_url":"https://api.github.com/users/cqray1990/following{/other_user}","gists_url":"https://api.github.com/users/cqray1990/gists{/gist_id}","starred_url":"https://api.github.com/users/cqray1990/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cqray1990/subscriptions","organizations_url":"https://api.github.com/users/cqray1990/orgs","repos_url":"https://api.github.com/users/cqray1990/repos","events_url":"https://api.github.com/users/cqray1990/events{/privacy}","received_events_url":"https://api.github.com/users/cqray1990/received_events","type":"User","site_admin":false},"created_at":"2019-08-05T10:27:19Z","updated_at":"2019-08-05T10:27:19Z","author_association":"NONE","body":"请问你这个问题解决了？\r\n@Lanme ","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/518179413/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cqray1990","id":32585434,"node_id":"MDQ6VXNlcjMyNTg1NDM0","avatar_url":"https://avatars.githubusercontent.com/u/32585434?v=4","gravatar_id":"","url":"https://api.github.com/users/cqray1990","html_url":"https://github.com/cqray1990","followers_url":"https://api.github.com/users/cqray1990/followers","following_url":"https://api.github.com/users/cqray1990/following{/other_user}","gists_url":"https://api.github.com/users/cqray1990/gists{/gist_id}","starred_url":"https://api.github.com/users/cqray1990/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cqray1990/subscriptions","organizations_url":"https://api.github.com/users/cqray1990/orgs","repos_url":"https://api.github.com/users/cqray1990/repos","events_url":"https://api.github.com/users/cqray1990/events{/privacy}","received_events_url":"https://api.github.com/users/cqray1990/received_events","type":"User","site_admin":false}},{"id":2533049381,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjUzMzA0OTM4MQ==","url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/events/2533049381","actor":{"login":"Lanme","id":28859589,"node_id":"MDQ6VXNlcjI4ODU5NTg5","avatar_url":"https://avatars.githubusercontent.com/u/28859589?v=4","gravatar_id":"","url":"https://api.github.com/users/Lanme","html_url":"https://github.com/Lanme","followers_url":"https://api.github.com/users/Lanme/followers","following_url":"https://api.github.com/users/Lanme/following{/other_user}","gists_url":"https://api.github.com/users/Lanme/gists{/gist_id}","starred_url":"https://api.github.com/users/Lanme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lanme/subscriptions","organizations_url":"https://api.github.com/users/Lanme/orgs","repos_url":"https://api.github.com/users/Lanme/repos","events_url":"https://api.github.com/users/Lanme/events{/privacy}","received_events_url":"https://api.github.com/users/Lanme/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-08-05T10:27:19Z","performed_via_github_app":null},{"id":2533049383,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI1MzMwNDkzODM=","url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/events/2533049383","actor":{"login":"Lanme","id":28859589,"node_id":"MDQ6VXNlcjI4ODU5NTg5","avatar_url":"https://avatars.githubusercontent.com/u/28859589?v=4","gravatar_id":"","url":"https://api.github.com/users/Lanme","html_url":"https://github.com/Lanme","followers_url":"https://api.github.com/users/Lanme/followers","following_url":"https://api.github.com/users/Lanme/following{/other_user}","gists_url":"https://api.github.com/users/Lanme/gists{/gist_id}","starred_url":"https://api.github.com/users/Lanme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lanme/subscriptions","organizations_url":"https://api.github.com/users/Lanme/orgs","repos_url":"https://api.github.com/users/Lanme/repos","events_url":"https://api.github.com/users/Lanme/events{/privacy}","received_events_url":"https://api.github.com/users/Lanme/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-08-05T10:27:19Z","performed_via_github_app":null},{"id":2823605925,"node_id":"MDExOkNsb3NlZEV2ZW50MjgyMzYwNTkyNQ==","url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/events/2823605925","actor":{"login":"Sierkinhane","id":41798797,"node_id":"MDQ6VXNlcjQxNzk4Nzk3","avatar_url":"https://avatars.githubusercontent.com/u/41798797?v=4","gravatar_id":"","url":"https://api.github.com/users/Sierkinhane","html_url":"https://github.com/Sierkinhane","followers_url":"https://api.github.com/users/Sierkinhane/followers","following_url":"https://api.github.com/users/Sierkinhane/following{/other_user}","gists_url":"https://api.github.com/users/Sierkinhane/gists{/gist_id}","starred_url":"https://api.github.com/users/Sierkinhane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sierkinhane/subscriptions","organizations_url":"https://api.github.com/users/Sierkinhane/orgs","repos_url":"https://api.github.com/users/Sierkinhane/repos","events_url":"https://api.github.com/users/Sierkinhane/events{/privacy}","received_events_url":"https://api.github.com/users/Sierkinhane/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-11-22T15:23:14Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/723578872","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-723578872","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":723578872,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMzU3ODg3Mg==","user":{"login":"Donaghys","id":49194956,"node_id":"MDQ6VXNlcjQ5MTk0OTU2","avatar_url":"https://avatars.githubusercontent.com/u/49194956?v=4","gravatar_id":"","url":"https://api.github.com/users/Donaghys","html_url":"https://github.com/Donaghys","followers_url":"https://api.github.com/users/Donaghys/followers","following_url":"https://api.github.com/users/Donaghys/following{/other_user}","gists_url":"https://api.github.com/users/Donaghys/gists{/gist_id}","starred_url":"https://api.github.com/users/Donaghys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Donaghys/subscriptions","organizations_url":"https://api.github.com/users/Donaghys/orgs","repos_url":"https://api.github.com/users/Donaghys/repos","events_url":"https://api.github.com/users/Donaghys/events{/privacy}","received_events_url":"https://api.github.com/users/Donaghys/received_events","type":"User","site_admin":false},"created_at":"2020-11-08T13:41:09Z","updated_at":"2020-11-08T13:41:09Z","author_association":"NONE","body":"> 我也遇到了这个问题，输入(batch,imgH,imgW)是(1024,32,280)单卡的preds.size()是torch.Size([71, 1024, 6009])，但是多卡的是torch.Size([142, 512, 6009])，不过我看网上说是在前向传播的时候才等分的，怎么输出序列的大小也变了呢？\r\n\r\n请问你解决这个问题了吗","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/723578872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Donaghys","id":49194956,"node_id":"MDQ6VXNlcjQ5MTk0OTU2","avatar_url":"https://avatars.githubusercontent.com/u/49194956?v=4","gravatar_id":"","url":"https://api.github.com/users/Donaghys","html_url":"https://github.com/Donaghys","followers_url":"https://api.github.com/users/Donaghys/followers","following_url":"https://api.github.com/users/Donaghys/following{/other_user}","gists_url":"https://api.github.com/users/Donaghys/gists{/gist_id}","starred_url":"https://api.github.com/users/Donaghys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Donaghys/subscriptions","organizations_url":"https://api.github.com/users/Donaghys/orgs","repos_url":"https://api.github.com/users/Donaghys/repos","events_url":"https://api.github.com/users/Donaghys/events{/privacy}","received_events_url":"https://api.github.com/users/Donaghys/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/1163834623","html_url":"https://github.com/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53#issuecomment-1163834623","issue_url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/53","id":1163834623,"node_id":"IC_kwDOCPcPJ85FXrT_","user":{"login":"wting861006","id":25969464,"node_id":"MDQ6VXNlcjI1OTY5NDY0","avatar_url":"https://avatars.githubusercontent.com/u/25969464?v=4","gravatar_id":"","url":"https://api.github.com/users/wting861006","html_url":"https://github.com/wting861006","followers_url":"https://api.github.com/users/wting861006/followers","following_url":"https://api.github.com/users/wting861006/following{/other_user}","gists_url":"https://api.github.com/users/wting861006/gists{/gist_id}","starred_url":"https://api.github.com/users/wting861006/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wting861006/subscriptions","organizations_url":"https://api.github.com/users/wting861006/orgs","repos_url":"https://api.github.com/users/wting861006/repos","events_url":"https://api.github.com/users/wting861006/events{/privacy}","received_events_url":"https://api.github.com/users/wting861006/received_events","type":"User","site_admin":false},"created_at":"2022-06-23T01:50:13Z","updated_at":"2022-06-23T02:01:51Z","author_association":"NONE","body":"用pytorch-lightning 不会有这个问题，我修改了一下训练代码，发出来给大家参考一下\r\n`\r\n\r\n    import argparse\r\n    import torch\r\n    import torch.backends.cudnn as cudnn\r\n    from torch.utils.data import DataLoader, random_split\r\n    import pytorch_lightning as pl\r\n    from easydict import EasyDict as edict\r\n    import yaml\r\n    import lib.models.crnn as crnn\r\n    import lib.utils.utils as utils\r\n    from lib.dataset import get_dataset\r\n    import lib.config.alphabets as alphabets\r\n    from lib.utils.utils import model_info\r\n    from tensorboardX import SummaryWriter\r\n    \r\n    \r\n    def parse_arg():\r\n        parser = argparse.ArgumentParser(description=\"train crnn\")\r\n    \r\n        parser.add_argument('--cfg', help='experiment configuration filename', required=True, type=str)\r\n    \r\n        args = parser.parse_args()\r\n        with open(args.cfg, 'r') as f:\r\n            # config = yaml.load(f, Loader=yaml.FullLoader)\r\n            config = yaml.safe_load(f)\r\n            config = edict(config)\r\n    \r\n        config.DATASET.ALPHABETS = alphabets.alphabet\r\n        config.MODEL.NUM_CLASSES = len(config.DATASET.ALPHABETS)\r\n    \r\n        return config\r\n    \r\n    \r\n    \r\n    class CRNN_TRAIN(pl.LightningModule):\r\n        def __init__(self,train_dataset,val_dataset,converter,config):\r\n            super(CRNN_TRAIN,self).__init__()\r\n            self.net=model\r\n            self.criterion=criterion\r\n            self.optimizer=optimizer\r\n            self.train_dataset=train_dataset\r\n            self.val_dataset=val_dataset\r\n            self.converter=converter\r\n            self.config=config\r\n            self.n_correct = 0\r\n    \r\n        def forward(self,x):\r\n            return self.net(x)\r\n    \r\n        def training_step(self,batch,batch_idx ):\r\n            inp, idx=batch\r\n            labels = utils.get_batch_label(self.train_dataset, idx)\r\n            preds = self(inp)\r\n            batch_size = inp.size(0)\r\n            text, length = self.converter.encode(labels)\r\n            preds_size = torch.IntTensor([preds.size(0)] * batch_size)\r\n            loss=self.criterion(preds,text,preds_size,length)\r\n            return loss\r\n    \r\n        def validation_step(self,batch,batch_idx):\r\n            inp, idx=batch\r\n            labels = utils.get_batch_label(self.val_dataset, idx)\r\n            preds = self(inp)\r\n            batch_size = inp.size(0)\r\n            text, length = self.converter.encode(labels)\r\n            preds_size = torch.IntTensor([preds.size(0)] * batch_size)\r\n            loss = self.criterion(preds, text, preds_size, length)\r\n            _, preds = preds.max(2)\r\n            preds = preds.transpose(1, 0).contiguous().view(-1)\r\n            sim_preds = self.converter.decode(preds.data, preds_size.data, raw=False)\r\n            for pred, target in zip(sim_preds, labels):\r\n                if pred == target:\r\n                    self.n_correct += 1\r\n            num_test_sample = self.config.TEST.NUM_TEST_BATCH * self.config.TEST.BATCH_SIZE_PER_GPU\r\n            if num_test_sample > len(self.val_dataset):\r\n                num_test_sample = len(self.val_dataset)\r\n            accuracy = self.n_correct / float(num_test_sample)\r\n            self.log(\"val_loss\", loss, prog_bar=True)\r\n            self.log(\"val_acc\", accuracy, prog_bar=True)\r\n    \r\n        def configure_optimizers(self):\r\n            return self.optimizer\r\n    \r\n    if __name__==\"__main__\":\r\n        config = parse_arg()\r\n        cudnn.benchmark = config.CUDNN.BENCHMARK\r\n        cudnn.deterministic = config.CUDNN.DETERMINISTIC\r\n        cudnn.enabled = config.CUDNN.ENABLED\r\n    \r\n        output_dict = utils.create_log_folder(config, phase='train')\r\n    \r\n        writer_dict = {\r\n            'writer': SummaryWriter(log_dir=output_dict['tb_dir']),\r\n            'train_global_steps': 0,\r\n            'valid_global_steps': 0,\r\n        }\r\n    \r\n        model = crnn.get_crnn(config)\r\n        criterion = torch.nn.CTCLoss()\r\n        last_epoch = config.TRAIN.BEGIN_EPOCH\r\n        optimizer = utils.get_optimizer(config, model)\r\n    \r\n        if isinstance(config.TRAIN.LR_STEP, list):\r\n            lr_scheduler = torch.optim.lr_scheduler.MultiStepLR(\r\n                optimizer, config.TRAIN.LR_STEP,\r\n                config.TRAIN.LR_FACTOR, last_epoch - 1\r\n            )\r\n        else:\r\n            lr_scheduler = torch.optim.lr_scheduler.StepLR(\r\n                optimizer, config.TRAIN.LR_STEP,\r\n                config.TRAIN.LR_FACTOR, last_epoch - 1\r\n            )\r\n    \r\n        if config.TRAIN.FINETUNE.IS_FINETUNE:\r\n            model_state_file = config.TRAIN.FINETUNE.FINETUNE_CHECKPOINIT\r\n            if model_state_file == '':\r\n                print(\" => no checkpoint found\")\r\n    \r\n            checkpoint = torch.load(model_state_file, map_location='cpu')\r\n            if 'state_dict' in checkpoint.keys():\r\n                checkpoint = checkpoint['state_dict']\r\n    \r\n            from collections import OrderedDict\r\n    \r\n            model_dict = OrderedDict()\r\n            for k, v in checkpoint.items():\r\n                if 'cnn' in k:\r\n                    model_dict[k[4:]] = v\r\n            model.cnn.load_state_dict(model_dict)\r\n            if config.TRAIN.FINETUNE.FREEZE:\r\n                for p in model.cnn.parameters():\r\n                    p.requires_grad = False\r\n    \r\n        elif config.TRAIN.RESUME.IS_RESUME:\r\n            model_state_file = config.TRAIN.RESUME.FILE\r\n            if model_state_file == '':\r\n                print(\" => no checkpoint found\")\r\n            print(\"load model:\", model_state_file)\r\n            checkpoint = torch.load(model_state_file, map_location='cpu')\r\n            if 'state_dict' in checkpoint.keys():\r\n                model.load_state_dict(checkpoint['state_dict'])\r\n                last_epoch = checkpoint['epoch']\r\n                # optimizer.load_state_dict(checkpoint['optimizer'])\r\n                # lr_scheduler.load_state_dict(checkpoint['lr_scheduler'])\r\n            else:\r\n                model.load_state_dict(checkpoint)\r\n    \r\n        train_dataset = get_dataset(config)(config, is_train=True)\r\n        train_loader = DataLoader(\r\n            dataset=train_dataset,\r\n            batch_size=config.TRAIN.BATCH_SIZE_PER_GPU,\r\n            shuffle=config.TRAIN.SHUFFLE,\r\n            num_workers=config.WORKERS,\r\n            pin_memory=config.PIN_MEMORY,\r\n        )\r\n        val_dataset = get_dataset(config)(config, is_train=False)\r\n        val_loader = DataLoader(\r\n            dataset=val_dataset,\r\n            batch_size=config.TEST.BATCH_SIZE_PER_GPU,\r\n            shuffle=config.TEST.SHUFFLE,\r\n            num_workers=config.WORKERS,\r\n            pin_memory=config.PIN_MEMORY,\r\n        )\r\n        converter = utils.strLabelConverter(config.DATASET.ALPHABETS)\r\n    \r\n        model=CRNN_TRAIN(train_dataset,val_dataset,converter,config)\r\n        # trainer = pl.Trainer(gpus=3, precision=32, max_epochs=config.TRAIN.END_EPOCH,auto_lr_find=True)\r\n        trainer = pl.Trainer(devices=3, precision=32, \r\n        max_epochs=config.TRAIN.END_EPOCH,auto_lr_find=True,accelerator=\"gpu\",strategy=\"ddp\")\r\n        trainer.fit(model, train_dataloaders=train_loader, val_dataloaders=val_loader)\r\n`","reactions":{"url":"https://api.github.com/repos/Sierkinhane/CRNN_Chinese_Characters_Rec/issues/comments/1163834623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wting861006","id":25969464,"node_id":"MDQ6VXNlcjI1OTY5NDY0","avatar_url":"https://avatars.githubusercontent.com/u/25969464?v=4","gravatar_id":"","url":"https://api.github.com/users/wting861006","html_url":"https://github.com/wting861006","followers_url":"https://api.github.com/users/wting861006/followers","following_url":"https://api.github.com/users/wting861006/following{/other_user}","gists_url":"https://api.github.com/users/wting861006/gists{/gist_id}","starred_url":"https://api.github.com/users/wting861006/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wting861006/subscriptions","organizations_url":"https://api.github.com/users/wting861006/orgs","repos_url":"https://api.github.com/users/wting861006/repos","events_url":"https://api.github.com/users/wting861006/events{/privacy}","received_events_url":"https://api.github.com/users/wting861006/received_events","type":"User","site_admin":false}}]