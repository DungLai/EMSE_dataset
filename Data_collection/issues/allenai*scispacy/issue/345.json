{"url":"https://api.github.com/repos/allenai/scispacy/issues/345","repository_url":"https://api.github.com/repos/allenai/scispacy","labels_url":"https://api.github.com/repos/allenai/scispacy/issues/345/labels{/name}","comments_url":"https://api.github.com/repos/allenai/scispacy/issues/345/comments","events_url":"https://api.github.com/repos/allenai/scispacy/issues/345/events","html_url":"https://github.com/allenai/scispacy/issues/345","id":850636204,"node_id":"MDU6SXNzdWU4NTA2MzYyMDQ=","number":345,"title":"rxnorm linker doesn't work with multiprocessing?","user":{"login":"kpich","id":52636,"node_id":"MDQ6VXNlcjUyNjM2","avatar_url":"https://avatars.githubusercontent.com/u/52636?v=4","gravatar_id":"","url":"https://api.github.com/users/kpich","html_url":"https://github.com/kpich","followers_url":"https://api.github.com/users/kpich/followers","following_url":"https://api.github.com/users/kpich/following{/other_user}","gists_url":"https://api.github.com/users/kpich/gists{/gist_id}","starred_url":"https://api.github.com/users/kpich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpich/subscriptions","organizations_url":"https://api.github.com/users/kpich/orgs","repos_url":"https://api.github.com/users/kpich/repos","events_url":"https://api.github.com/users/kpich/events{/privacy}","received_events_url":"https://api.github.com/users/kpich/received_events","type":"User","site_admin":false},"labels":[{"id":1068015159,"node_id":"MDU6TGFiZWwxMDY4MDE1MTU5","url":"https://api.github.com/repos/allenai/scispacy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-04-05T20:20:07Z","updated_at":"2022-09-07T02:58:18Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi, I'm getting an error trying to run `nlp.pipe` with `n_processes > 1`, I think because the pickling that `multiprocessing` does under the hood interacts poorly with `nmslib.dist.FloatIndex`, which the rxnorm entity linker requires and does not seem picklable. \r\n\r\nMinimal code:\r\n\r\n```\r\nimport spacy\r\nimport scispacy\r\nfrom scispacy.linking import EntityLinker\r\n\r\nTEXTS = [\"Hello! This is document 1.\", \"And here's doc 2.\"]\r\n\r\nif __name__ == '__main__':\r\n  nlp = spacy.load(\"en_core_sci_sm\")\r\n  nlp.add_pipe(\"scispacy_linker\", config={\"resolve_abbreviations\": True,\r\n                                          \"linker_name\": \"rxnorm\"})\r\n  for doc in nlp.pipe(TEXTS, n_process=2):\r\n    print(doc)\r\n```\r\nRunning with Python 3.8.5 gives me:\r\n```\r\nTraceback (most recent call last):\r\n  File \"./mwerror.py\", line 13, in <module>\r\n    for doc in nlp.pipe(TEXTS, n_process=2):\r\n  File \".../python3.8/site-packages/spacy/language.py\", line 1479, in pipe\r\n    for doc in docs:\r\n  File \".../python3.8/site-packages/spacy/language.py\", line 1515, in _multiprocessing_pipe\r\n    proc.start()\r\n  File \".../python3.8/multiprocessing/process.py\", line 121, in start\r\n    self._popen = self._Popen(self)\r\n  File \".../python3.8/multiprocessing/context.py\", line 224, in _Popen\r\n    return _default_context.get_context().Process._Popen(process_obj)\r\n  File \".../python3.8/multiprocessing/context.py\", line 284, in _Popen\r\n    return Popen(process_obj)\r\n  File \".../python3.8/multiprocessing/popen_spawn_posix.py\", line 32, in __init__\r\n    super().__init__(process_obj)\r\n  File \".../python3.8/multiprocessing/popen_fork.py\", line 19, in __init__\r\n    self._launch(process_obj)\r\n  File \".../python3.8/multiprocessing/popen_spawn_posix.py\", line 47, in _launch\r\n    reduction.dump(process_obj, fp)\r\n  File \".../python3.8/multiprocessing/reduction.py\", line 60, in dump\r\n    ForkingPickler(file, protocol).dump(obj)\r\nTypeError: cannot pickle 'nmslib.dist.FloatIndex' object\r\n```\r\nNote I don't get an error with `n_process=1`, presumably because `multiprocessing` is not invoked.\r\n\r\nI also do not get this error if I don't include the linker pipe (i.e. comment out the `add_pipe()` line above).\r\n\r\nThanks! This lib is great!","closed_by":null,"reactions":{"url":"https://api.github.com/repos/allenai/scispacy/issues/345/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/allenai/scispacy/issues/345/timeline","performed_via_github_app":null,"state_reason":null}