{"url":"https://api.github.com/repos/allenai/scispacy/issues/404","repository_url":"https://api.github.com/repos/allenai/scispacy","labels_url":"https://api.github.com/repos/allenai/scispacy/issues/404/labels{/name}","comments_url":"https://api.github.com/repos/allenai/scispacy/issues/404/comments","events_url":"https://api.github.com/repos/allenai/scispacy/issues/404/events","html_url":"https://github.com/allenai/scispacy/issues/404","id":1056808102,"node_id":"I_kwDOCPNzOc4-_Zym","number":404,"title":"Inconsistent NER results","user":{"login":"zhanyuanucb","id":32000378,"node_id":"MDQ6VXNlcjMyMDAwMzc4","avatar_url":"https://avatars.githubusercontent.com/u/32000378?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanyuanucb","html_url":"https://github.com/zhanyuanucb","followers_url":"https://api.github.com/users/zhanyuanucb/followers","following_url":"https://api.github.com/users/zhanyuanucb/following{/other_user}","gists_url":"https://api.github.com/users/zhanyuanucb/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanyuanucb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanyuanucb/subscriptions","organizations_url":"https://api.github.com/users/zhanyuanucb/orgs","repos_url":"https://api.github.com/users/zhanyuanucb/repos","events_url":"https://api.github.com/users/zhanyuanucb/events{/privacy}","received_events_url":"https://api.github.com/users/zhanyuanucb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-11-18T01:02:57Z","updated_at":"2021-11-18T02:43:56Z","closed_at":"2021-11-18T02:43:55Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nInconsistent NER results with large input\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\nRun the following script:\r\n```\r\nimport spacy\r\nfrom scispacy.linking import EntityLinker\r\n\r\nspacy.util.fix_random_seed(42)\r\nlang_model = \"en_core_sci_sm\"\r\n# Feel free to try the following model\r\n#lang_model = \"en_ner_bionlp13cg_md\"\r\nnlp = spacy.load(lang_model)\r\nlinker = EntityLinker(resolve_abbreviations=True, name=\"umls\")\r\nnlp.add_pipe(linker)\r\n\r\n# Large input\r\ntext = \"Title: Rethinking high-risk groups in COVID-19\\n\\n\\n\\nHow do we protect our 'high-risk' patient populations? This was the dominant focus of our coronavirus disease 2019 (COVID-19) neurology departmental meeting at the start of the epidemic weeks ago, where a neurologist in his late 50s assured us we were at minimal danger from coronavirus, and our efforts should focus on protecting our high-risk patients. But do we know exactly who these 'high-risk' people are? Although there was limited data to guide them, our hospital, the CDC, 1 and various medical associations repeated the intuitive refrain that 'high risk' patients are the 'immunocompromised and elderly.'A hospital-wide high-risk patient working group was established early on, consisting of neuroimmunologists and other physicians across disciplines that care for immunocompromised individuals. Specific guidance for immunocompromised patients regarding COVID-19 was pushed out quickly. Appointments for immunocompromised patients were converted to virtual visits or deferred if possible, before appointments for other patients.The inclusion of immunocompromised patients in the 'high-risk population' for COVID-19 is intuitive-immunosuppression should make a person more likely to contract an infection and may prolong the disease course. However, the data thus far has not borne this out. Early analyses of large Chinese cohorts have identified risk factors such as older age, hypertension, chronic respiratory diseases, and cardiovascular diseases, but not immunosuppression, as risk factors for disease severity in COVID-19. 2 In addition, data on prior related coronavirus outbreaks in MERS 3 and SARS 4 did not show any evidence of increased risk of infection or morbidity in immunocompromised populations.With the current outbreak, reports of 2 heart transplant recipients 5 and the first renal transplant recipient 6 with COVID-19 infection showed a clinical course, recovery, and laboratory profile similar to that of immunocompetent patients. A pediatric liver transplant center in Italy reported no significant pulmonary disease from COVID-19 amongst their patients with autoimmune liver disease, on chemotherapy, or those who were post-transplant. 7 An analysis from China did note increased rates of infection and morbidity in cancer patients, 8 however, it did not adjust for age, included patients many years out from their cancer treatments, and has been the subject of several responses that contest the conclusion of increased risk to cancer patients. 9,10 Indeed, one response raised the point that decreased access to quality medical care, rather than the virus itself, is the primary danger facing cancer patients in the current pandemic. 10 No data exists regarding other transplant, rheumatologic or neuroimmunological conditions, which itself prompts the question of whether these patients are indeed at higher risk than the general population.Not only has evidence that immunosuppression causes increased risk in COVID-19 been lacking, there is also a theoretical argument that immunosuppression may be therapeutic. A hyperinflammatory response to COVID-19 may cause a cytokine storm syndrome, driving severe and deadly cases of COVID-19. 11 Clinical investigations into the utility of various immunosuppressive agents in COVID-19, including tocilizumab (an IL-6 inhibitor), Janus kinus (JAK) inhibitors, and others are ongoing. 12 Instead of focusing on immunosuppression, we need to re-consider who qualifies as an 'elderly' person in regards to COVID-19 risk. Advanced older age as a risk factor for COVID-19 infection and death has been well substantiated. Over 1 out of 5 patients in Italy over the age of 80 succumbed to the disease, 13 and according to the CDC, 31-70% of confirmed COVID-19 patients over the age of 85 in the United States require hospitalization. 1 Lay press articles paint the at risk elderly as 'our grandparents,' 'nursing home residents,' or 'retirees.' And yet, while the very elderly in their 80s are most severely affected by the disease, the median age of hospitalized patients with severe COVID-19 in a large retrospective study in China was only 52 years. 14 The case fatality rate for individuals in the 60-69 age group was an unreassuring 3.5% in Italy and 3.6% in China, and hospitalizations in this age group are extremely common. 13 Morbidity may peak in society's oldest members, but anyone older than 50 is far from safe, and many in this group represent our health care workers, grocery store employees, government leaders, caregivers, and other members of society serving essential functions in the midst of this crisis. Unlike immunocompromised individuals, average adults in their 50s or 60s may never have thought of themselves as vulnerable; thus, messaging about their elevated risk should be targeted and unambiguous.The data regarding risk factors for poor outcomes in COVID-19 is far from definitive-as we learn more about this disease, we may find that certain cancers, neuroimmunologic conditions, or immunosuppressive agents do indeed increase morbidity. The medical complexity of some immunocompromised patients may itself lead to higher risk for nosocomial infections or complications related to hospitalization. Those in their 80s and 90s are at the highest risk from this infection, and we must do everything we can to protect them. However, as health professionals focus on 'immunocompromised and elderly' patients in our public health messaging, we send an implicit message, that others have made explicit, that those outside of these groups are safer. Paradoxically, the physician in his late 50s speaking about protecting high-risk immunocompromised patients at our hospital meeting, may himself be at higher risk than many of the immunocompromised patients he seeks to protect. These issues are consequential-some multiple sclerosis patients are considering delays in their immunosuppressive regimens due to the pandemic, older healthcare workers are coming out of retirement to work on the frontlines, and there is ongoing debate in government about the who will be at risk when we reopen society. It is time to urgently begin the discussion within the medical community on how to target accurate messaging to those at highest risk.\"\r\n\r\nresult = nlp(text)\r\nmedical_entities = result.ents\r\n\r\n# Dump the result for later inspection\r\noutput = collections.defaultdict(int)\r\noutput_root = \"./\" # change it to output dir\r\nsuffix = 1 # change it to prevent overwritting\r\n\r\nimport collections\r\nimport json\r\nfor item in medical_entities:\r\n    for umls_ent in item._.kb_ents:\r\n        cui, score = umls_ent\r\n        output[cui] += 1\r\nwith open(osp.join(output_root, f\"output_{suffix}.json\"), 'w') as f:\r\n    json.dump(results[f\"attm_{iter_num}\"], f, indent=2)\r\n```\r\n\r\n**Expected behavior**\r\nI expected running the following script multiple times would have the same result, but the output were inconsistent (different cui and different count for cui)\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Ubuntu 16.04.7 LTS\r\n - Package version\r\n```\r\n>>> scispacy.__version__\r\n'0.3.0'\r\n>>> spacy.__version__\r\n'2.3.5'\r\n```\r\n - Python verions: python:3.6\r\n\r\n","closed_by":{"login":"zhanyuanucb","id":32000378,"node_id":"MDQ6VXNlcjMyMDAwMzc4","avatar_url":"https://avatars.githubusercontent.com/u/32000378?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanyuanucb","html_url":"https://github.com/zhanyuanucb","followers_url":"https://api.github.com/users/zhanyuanucb/followers","following_url":"https://api.github.com/users/zhanyuanucb/following{/other_user}","gists_url":"https://api.github.com/users/zhanyuanucb/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanyuanucb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanyuanucb/subscriptions","organizations_url":"https://api.github.com/users/zhanyuanucb/orgs","repos_url":"https://api.github.com/users/zhanyuanucb/repos","events_url":"https://api.github.com/users/zhanyuanucb/events{/privacy}","received_events_url":"https://api.github.com/users/zhanyuanucb/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/allenai/scispacy/issues/404/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/allenai/scispacy/issues/404/timeline","performed_via_github_app":null,"state_reason":"completed"}