{"url":"https://api.github.com/repos/allenai/scispacy/issues/402","repository_url":"https://api.github.com/repos/allenai/scispacy","labels_url":"https://api.github.com/repos/allenai/scispacy/issues/402/labels{/name}","comments_url":"https://api.github.com/repos/allenai/scispacy/issues/402/comments","events_url":"https://api.github.com/repos/allenai/scispacy/issues/402/events","html_url":"https://github.com/allenai/scispacy/issues/402","id":1034771375,"node_id":"I_kwDOCPNzOc49rVuv","number":402,"title":"Slow loading of the pipe `scispacy_linker`","user":{"login":"vlievin","id":9859840,"node_id":"MDQ6VXNlcjk4NTk4NDA=","avatar_url":"https://avatars.githubusercontent.com/u/9859840?v=4","gravatar_id":"","url":"https://api.github.com/users/vlievin","html_url":"https://github.com/vlievin","followers_url":"https://api.github.com/users/vlievin/followers","following_url":"https://api.github.com/users/vlievin/following{/other_user}","gists_url":"https://api.github.com/users/vlievin/gists{/gist_id}","starred_url":"https://api.github.com/users/vlievin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vlievin/subscriptions","organizations_url":"https://api.github.com/users/vlievin/orgs","repos_url":"https://api.github.com/users/vlievin/repos","events_url":"https://api.github.com/users/vlievin/events{/privacy}","received_events_url":"https://api.github.com/users/vlievin/received_events","type":"User","site_admin":false},"labels":[{"id":1068015161,"node_id":"MDU6TGFiZWwxMDY4MDE1MTYx","url":"https://api.github.com/repos/allenai/scispacy/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2021-10-25T07:21:25Z","updated_at":"2022-02-02T23:58:18Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi, loading an UMLS linker is particularly slow (~20-30s). It is a real issue when testing the code. I reported the profiler output bellow. Is there anything we can do to speed-up the loading of the linker?\r\n\r\n## Profiler output\r\n```\r\n   Ordered by: internal time\r\n   List reduced from 951 to 20 due to restriction <20>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n        1   19.741   19.741   53.338   53.338 /Users/-/Library/Caches/pypoetry/virtualenvs/fz-openqa-rEqQaPFC-py3.8/lib/python3.8/site-packages/scispacy/linking_utils.py:55(__init__)\r\n        1   18.422   18.422   25.783   25.783 /Users/-/Library/Caches/pypoetry/virtualenvs/fz-openqa-rEqQaPFC-py3.8/lib/python3.8/site-packages/scispacy/candidate_generation.py:116(load_approximate_nearest_neighbours_index)\r\n  3359672   16.912    0.000   16.912    0.000 /Users/-/anaconda3/lib/python3.8/json/decoder.py:343(raw_decode)\r\n  3359672    3.847    0.000   24.272    0.000 /Users/-/anaconda3/lib/python3.8/json/decoder.py:332(decode)\r\n     4023    3.202    0.001    3.202    0.001 {method 'decompress' of 'zlib.Decompress' objects}\r\n  3359672    2.840    0.000   30.230    0.000 /Users/-/Library/Caches/pypoetry/virtualenvs/fz-openqa-rEqQaPFC-py3.8/lib/python3.8/site-packages/scispacy/linking_utils.py:65(<genexpr>)\r\n  3359672    2.818    0.000   28.086    0.000 /Users/-/anaconda3/lib/python3.8/json/__init__.py:299(loads)\r\n  6719602    2.603    0.000    2.603    0.000 {method 'match' of 're.Pattern' objects}\r\n        6    2.251    0.375    2.251    0.375 {method 'do_handshake' of '_ssl._SSLSocket' objects}\r\n        6    1.206    0.201    1.206    0.201 {method 'read' of '_ssl._SSLSocket' objects}\r\n        6    1.122    0.187    1.122    0.187 {method 'connect' of '_socket.socket' objects}\r\n  9300568    1.002    0.000    1.002    0.000 {method 'add' of 'set' objects}\r\n  3359671    0.867    0.000    1.565    0.000 <string>:1(__new__)\r\n     4033    0.763    0.000    0.763    0.000 {built-in method zlib.crc32}\r\n  3360030    0.704    0.000    0.704    0.000 {built-in method __new__ of type object at 0x10c379808}\r\n  3359928    0.679    0.000    0.679    0.000 {method 'startswith' of 'str' objects}\r\n  6719344    0.581    0.000    0.581    0.000 {method 'end' of 're.Match' objects}\r\n        2    0.525    0.262    0.525    0.262 {method 'astype' of 'numpy.ndarray' objects}\r\n        5    0.474    0.095    4.703    0.941 /Users/-/Library/Caches/pypoetry/virtualenvs/fz-openqa-rEqQaPFC-py3.8/lib/python3.8/site-packages/numpy/lib/format.py:699(read_array)\r\n        2    0.369    0.184    0.369    0.184 {method 'copy' of 'numpy.ndarray' objects}\r\n\r\n\r\n```\r\n\r\n## Code to reproduce the above results\r\n```python\r\nimport cProfile\r\nimport pstats\r\nfrom time import time\r\n\r\nimport spacy\r\nfrom scispacy.abbreviation import AbbreviationDetector  # type: ignore\r\nfrom scispacy.linking import EntityLinker  # type: ignore\r\n\r\n\r\ndef load_spacy_model(model_name: str):\r\n   \"\"\"Load a ScispaCy model\"\"\"\r\n    model = spacy.load(\r\n        model_name,\r\n        disable=[\r\n            \"tok2vec\",\r\n            \"tagger\",\r\n            \"parser\",\r\n            \"attribute_ruler\",\r\n            \"lemmatizer\",\r\n        ],\r\n    )\r\n\r\n    return model\r\n\r\n\r\ndef add_scispacy_linker(model):\r\n    \"\"\"add the entity linker (slow loading)\"\"\"\r\n    model.add_pipe(\r\n        \"scispacy_linker\",\r\n        config={\"linker_name\": \"umls\"},\r\n    )\r\n    return model\r\n\r\n# load the model (ok loading time)\r\nmodel = load_spacy_model(model_name=\"en_core_sci_sm\")\r\n\r\n# load the linker (slow loading time) + profiling\r\nprofiler = cProfile.Profile()\r\nprofiler.enable()\r\nt0 = time()\r\nmodel = add_scispacy_linker(model)\r\nduration = time() - t0\r\nprofiler.disable()\r\nstats = pstats.Stats(profiler).sort_stats(\"time\")\r\nstats.print_stats(20)\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/allenai/scispacy/issues/402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/allenai/scispacy/issues/402/timeline","performed_via_github_app":null,"state_reason":null}