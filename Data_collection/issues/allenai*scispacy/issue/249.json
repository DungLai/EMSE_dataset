{"url":"https://api.github.com/repos/allenai/scispacy/issues/249","repository_url":"https://api.github.com/repos/allenai/scispacy","labels_url":"https://api.github.com/repos/allenai/scispacy/issues/249/labels{/name}","comments_url":"https://api.github.com/repos/allenai/scispacy/issues/249/comments","events_url":"https://api.github.com/repos/allenai/scispacy/issues/249/events","html_url":"https://github.com/allenai/scispacy/issues/249","id":655226047,"node_id":"MDU6SXNzdWU2NTUyMjYwNDc=","number":249,"title":"RxNorm linker not working and I think its possibly due to an incorrect path to ai2 AWS instance","user":{"login":"diegoolano","id":554478,"node_id":"MDQ6VXNlcjU1NDQ3OA==","avatar_url":"https://avatars.githubusercontent.com/u/554478?v=4","gravatar_id":"","url":"https://api.github.com/users/diegoolano","html_url":"https://github.com/diegoolano","followers_url":"https://api.github.com/users/diegoolano/followers","following_url":"https://api.github.com/users/diegoolano/following{/other_user}","gists_url":"https://api.github.com/users/diegoolano/gists{/gist_id}","starred_url":"https://api.github.com/users/diegoolano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegoolano/subscriptions","organizations_url":"https://api.github.com/users/diegoolano/orgs","repos_url":"https://api.github.com/users/diegoolano/repos","events_url":"https://api.github.com/users/diegoolano/events{/privacy}","received_events_url":"https://api.github.com/users/diegoolano/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-07-11T15:14:40Z","updated_at":"2020-10-21T16:13:55Z","closed_at":"2020-10-21T16:13:54Z","author_association":"NONE","active_lock_reason":null,"body":"A colleague and I are both running into an issue while trying to use the new RxNorm linker, and\r\nI think its possibly due to an incorrect URL being set for RxNorm(KnowledgeBase)  file_path  in _scispacy/linking_utils.py_,\r\nits currently set to the same path as HumanPhenotypeOntology.\r\n\r\n I attempted to figure out what that correct file_path URL for RxNorm might be to see if that would fix the issue, but to no avail.   Any thoughts on the issue?  Could you provide the URL if that is in fact the issue?  Thank you.\r\n\r\n#246 \r\n\r\n**Reproduction notes:**\r\n \r\n**Install** \r\n \r\nvirtualenv --python=/usr/bin/python3 scispacy_newer\r\nsource scispacy_newer/bin/activate\r\n \r\npip install scispacy\r\npip install https://s3-us-west-2.amazonaws.com/ai2-s2-scispacy/releases/v0.2.5/en_core_sci_lg-0.2.5.tar.gz\r\n \r\n \r\n**In notebook**\r\n \r\nimport spacy\r\nimport scispacy\r\nfrom scispacy.abbreviation import AbbreviationDetector\r\nfrom scispacy.linking import EntityLinker\r\n \r\nnlp = spacy.load(\"en_core_sci_lg\")\r\nrxlinker = EntityLinker(resolve_abbreviations=True, name=\"rxnorm\")\r\nnlp.add_pipe(rxlinker)\r\n \r\ntext = \"The Aspirin was not helpful so I took Advil to help with my headache.\"\r\ndoc = nlp(text)\r\n \r\n \r\n**Error raised**:\r\n/Users/diegoolano/sandbox/newer_scispacy/scispacy_newer/lib/python3.7/site-packages/scispacy/candidate_generation.py:283: VisibleDeprecationWarning: Creating an ndarray from ragged nested sequences (which is a list-or-tuple of lists-or-tuples-or ndarrays with different lengths or shapes) is deprecated. If you meant to do this, you must specify 'dtype=object' when creating the ndarray\r\n  extended_neighbors[empty_vectors_boolean_flags] = numpy.array(neighbors)[:-1]\r\n\r\n/Users/diegoolano/sandbox/newer_scispacy/scispacy_newer/lib/python3.7/site-packages/scispacy/candidate_generation.py:284: VisibleDeprecationWarning: Creating an ndarray from ragged nested sequences (which is a list-or-tuple of lists-or-tuples-or ndarrays with different lengths or shapes) is deprecated. If you meant to do this, you must specify 'dtype=object' when creating the ndarray\r\n  extended_distances[empty_vectors_boolean_flags] = numpy.array(distances)[:-1]\r\n \r\n---------------------------------------------------------------------------\r\n**KeyError                                  Traceback (most recent call last)**\r\n<ipython-input-4-17c4c0ce77e8> in <module>      \r\n          1 text = \"The Aspirin was not helpful so I took Advil to help with my headache.\"\r\n----> 2 doc = nlp(text)\r\n\r\n~/sandbox/newer_scispacy/scispacy_newer/lib/python3.7/site-packages/spacy/language.py in __call__(self, text, disable, component_cfg)    \r\n           447             if not hasattr(proc, \"__call__\"):    \r\n           448                 raise ValueError(Errors.E003.format(component=type(proc), name=name))\r\n     --> 449             doc = proc(doc, **component_cfg.get(name, {}))    \r\n            450             if doc is None:    \r\n             451                 raise ValueError(Errors.E005.format(name=name))\r\n\r\n~/sandbox/newer_scispacy/scispacy_newer/lib/python3.7/site-packages/scispacy/linking.py in __call__(self, doc)    \r\n        102 \r\n        103         mention_strings = [x.text for x in mentions]\r\n --> 104         batch_candidates = self.candidate_generator(mention_strings, self.k)    \r\n        105 \r\n        106         for mention, candidates in zip(doc.ents, batch_candidates):\r\n\r\n~/sandbox/newer_scispacy/scispacy_newer/lib/python3.7/site-packages/scispacy/candidate_generation.py in __call__(self, mention_texts, k)    \r\n        342             for neighbor_index, distance in zip(neighbors, distances):    \r\n        343                 mention = self.ann_concept_aliases_list[neighbor_index]\r\n **--> 344                 concepts_for_mention = self.kb.alias_to_cuis[mention]**    \r\n        345                 for concept_id in concepts_for_mention:    \r\n        346                     concept_to_mentions[concept_id].append(mention)\r\nKeyError: 'Aspirin'\r\n \r\n \r\n**Thoughts:**\r\nI looked into the error some and  looking at the self.kb.alias_to_cuis  dict shows it has a length of 32111, but its entries don't seem to refer to drugs.\r\n \r\nBeginning of dict:\r\n\"\"\"\r\n{'Abdominal cramps': {'C0000729'}, 'Abdominal bloating': {'C0000731'}, 'Bloating': {'C0000731'}, 'Abdominal swelling': {'C0000731'}, 'Abdominal distension': {'C0000731'}, 'Abdominal distention': {'C0000731'}\r\n \"\"\"\r\n \r\nThis dict is set by processing the RxNorm class that extends the KnowledgeBase class in \"scispacy/linking_utils.py\"\r\nbut in looking at it there appears to be a typo in the filepath it uses.  \r\nAs of now it points to the same file as Human PhenotypeOntology?\r\n \r\n\"\"\"\r\nclass GeneOntology(KnowledgeBase):\r\n    def __init__(\r\n        self,\r\n        file_path: str = \"https://ai2-s2-scispacy.s3-us-west-2.amazonaws.com/data/umls_2020_gene_ontology.jsonl\",\r\n    ):\r\n        super().__init__(file_path)\r\n\r\nclass HumanPhenotypeOntology(KnowledgeBase):\r\n    def __init__(\r\n        self,\r\n        **file_path: str** = \"https://ai2-s2-scispacy.s3-us-west-2.amazonaws.com/data/umls_2020_human_phenotype_ontology.jsonl\",  # noqa\r\n    ):\r\n        super().__init__(file_path)\r\n \r\nclass RxNorm(KnowledgeBase):\r\n    def __init__(\r\n        self,\r\n        **file_path: str =** \"https://ai2-s2-scispacy.s3-us-west-2.amazonaws.com/data/umls_2020_human_phenotype_ontology.jsonl\",  # noqa\r\n    ):\r\n        super().__init__(file_path)\r\n\"\"\"\r\n \r\n\r\n<img width=\"1514\" alt=\"Screen Shot 2020-07-11 at 9 56 50 AM\" src=\"https://user-images.githubusercontent.com/554478/87227084-f64f7a00-c35d-11ea-847f-5378499bdef7.png\">\r\n ","closed_by":{"login":"DeNeutoy","id":16001974,"node_id":"MDQ6VXNlcjE2MDAxOTc0","avatar_url":"https://avatars.githubusercontent.com/u/16001974?v=4","gravatar_id":"","url":"https://api.github.com/users/DeNeutoy","html_url":"https://github.com/DeNeutoy","followers_url":"https://api.github.com/users/DeNeutoy/followers","following_url":"https://api.github.com/users/DeNeutoy/following{/other_user}","gists_url":"https://api.github.com/users/DeNeutoy/gists{/gist_id}","starred_url":"https://api.github.com/users/DeNeutoy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DeNeutoy/subscriptions","organizations_url":"https://api.github.com/users/DeNeutoy/orgs","repos_url":"https://api.github.com/users/DeNeutoy/repos","events_url":"https://api.github.com/users/DeNeutoy/events{/privacy}","received_events_url":"https://api.github.com/users/DeNeutoy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/allenai/scispacy/issues/249/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/allenai/scispacy/issues/249/timeline","performed_via_github_app":null,"state_reason":"completed"}