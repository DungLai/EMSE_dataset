{"url":"https://api.github.com/repos/allenai/scispacy/issues/338","repository_url":"https://api.github.com/repos/allenai/scispacy","labels_url":"https://api.github.com/repos/allenai/scispacy/issues/338/labels{/name}","comments_url":"https://api.github.com/repos/allenai/scispacy/issues/338/comments","events_url":"https://api.github.com/repos/allenai/scispacy/issues/338/events","html_url":"https://github.com/allenai/scispacy/issues/338","id":833316914,"node_id":"MDU6SXNzdWU4MzMzMTY5MTQ=","number":338,"title":"Span is not serializable in abbreviations - figure out a better workaround","user":{"login":"f0lie","id":9092074,"node_id":"MDQ6VXNlcjkwOTIwNzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9092074?v=4","gravatar_id":"","url":"https://api.github.com/users/f0lie","html_url":"https://github.com/f0lie","followers_url":"https://api.github.com/users/f0lie/followers","following_url":"https://api.github.com/users/f0lie/following{/other_user}","gists_url":"https://api.github.com/users/f0lie/gists{/gist_id}","starred_url":"https://api.github.com/users/f0lie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f0lie/subscriptions","organizations_url":"https://api.github.com/users/f0lie/orgs","repos_url":"https://api.github.com/users/f0lie/repos","events_url":"https://api.github.com/users/f0lie/events{/privacy}","received_events_url":"https://api.github.com/users/f0lie/received_events","type":"User","site_admin":false},"labels":[{"id":1068015159,"node_id":"MDU6TGFiZWwxMDY4MDE1MTU5","url":"https://api.github.com/repos/allenai/scispacy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1068015162,"node_id":"MDU6TGFiZWwxMDY4MDE1MTYy","url":"https://api.github.com/repos/allenai/scispacy/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2021-03-17T01:20:56Z","updated_at":"2021-07-15T18:44:21Z","closed_at":"2021-07-15T18:44:20Z","author_association":"NONE","active_lock_reason":null,"body":"```python\r\nimport spacy\r\n\r\nfrom scispacy.abbreviation import AbbreviationDetector\r\n\r\nnlp = spacy.load(\"en_core_sci_sm\")\r\n\r\n# Add the abbreviation pipe to the spacy pipeline.\r\nnlp.add_pipe(\"abbreviation_detector\")\r\n\r\ntest = [\"Spinal and bulbar muscular atrophy (SBMA) is an inherited motor neuron disease caused by the expansion of a polyglutamine tract within the androgen receptor (AR). SBMA can be caused by this easily.\"]\r\n\r\nprint(\"Abbreviation\", \"\\t\", \"Definition\")\r\nfor doc in nlp.pipe(test, n_process=4):\r\n    for abrv in doc._.abbreviations:\r\n        print(f\"{abrv} \\t ({abrv.start}, {abrv.end}) {abrv._.long_form}\")\r\n```\r\n\r\nRunning that code leads to this. The error message doesn't make a lot of sense, It could be because there are more processes than entries. If you remove `n_process` the solves the problem.\r\n\r\n```\r\nAbbreviation     Definition\r\nAbbreviation     Definition\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 116, in spawn_main\r\n    exitcode = _main(fd, parent_sentinel)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 125, in _main\r\n    prepare(preparation_data)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 236, in prepare\r\n    _fixup_main_from_path(data['init_main_from_path'])\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 287, in _fixup_main_from_path\r\n    main_content = runpy.run_path(main_path,\r\n  File \"C:\\Python38\\lib\\runpy.py\", line 265, in run_path\r\n    return _run_module_code(code, init_globals, run_name,\r\n  File \"C:\\Python38\\lib\\runpy.py\", line 97, in _run_module_code\r\n    _run_code(code, mod_globals, init_globals,\r\n  File \"C:\\Python38\\lib\\runpy.py\", line 87, in _run_code\r\n    exec(code, run_globals)\r\n  File \"C:\\Users\\alexd\\Dropbox (UFL)\\UFII_COVID19_RESEARCH_TOPICS\\cord19\\text_parsing_pipeline\\test.py\", line 13, in <module>\r\n    for doc in nlp.pipe(test, n_process=4):\r\n  File \"C:\\Python38\\lib\\site-packages\\spacy\\language.py\", line 1475, in pipe\r\n    for doc in docs:\r\n  File \"C:\\Python38\\lib\\site-packages\\spacy\\language.py\", line 1511, in _multiprocessing_pipe\r\n    proc.start()\r\n  File \"C:\\Python38\\lib\\multiprocessing\\process.py\", line 121, in start\r\n    self._popen = self._Popen(self)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\context.py\", line 224, in _Popen\r\n    return _default_context.get_context().Process._Popen(process_obj)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\context.py\", line 327, in _Popen\r\n    return Popen(process_obj)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\popen_spawn_win32.py\", line 45, in __init__\r\n    prep_data = spawn.get_preparation_data(process_obj._name)\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 154, in get_preparation_data\r\n    _check_not_importing_main()\r\n  File \"C:\\Python38\\lib\\multiprocessing\\spawn.py\", line 134, in _check_not_importing_main\r\n    raise RuntimeError('''\r\nRuntimeError:\r\n        An attempt has been made to start a new process before the\r\n        current process has finished its bootstrapping phase.\r\n\r\n        This probably means that you are not using fork to start your\r\n        child processes and you have forgotten to use the proper idiom\r\n        in the main module:\r\n\r\n            if __name__ == '__main__':\r\n                freeze_support()\r\n                ...\r\n\r\n        The \"freeze_support()\" line can be omitted if the program\r\n        is not going to be frozen to produce an executable.\r\n```\r\n\r\nThis is the error message from my main piece of code with more data. It sort of makes more sense. I think it has to something to do with how the multiprocess pipe collects the results of the workers. The error pops up after a while so it's definitely running.\r\n\r\n```\r\nProcess Process-1:\r\nTraceback (most recent call last):\r\n  File \"C:\\Python38\\lib\\multiprocessing\\process.py\", line 315, in _bootstrap\r\n    self.run()\r\n  File \"C:\\Python38\\lib\\multiprocessing\\process.py\", line 108, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"C:\\Python38\\lib\\site-packages\\spacy\\language.py\", line 1995, in _apply_pipes\r\n    sender.send([doc.to_bytes() for doc in docs])\r\n  File \"C:\\Python38\\lib\\site-packages\\spacy\\language.py\", line 1995, in <listcomp>\r\n    sender.send([doc.to_bytes() for doc in docs])\r\n  File \"spacy\\tokens\\doc.pyx\", line 1237, in spacy.tokens.doc.Doc.to_bytes\r\n  File \"spacy\\tokens\\doc.pyx\", line 1296, in spacy.tokens.doc.Doc.to_dict\r\n  File \"C:\\Python38\\lib\\site-packages\\spacy\\util.py\", line 1134, in to_dict\r\n    serialized[key] = getter()\r\n  File \"spacy\\tokens\\doc.pyx\", line 1293, in spacy.tokens.doc.Doc.to_dict.lambda18\r\n  File \"C:\\Python38\\lib\\site-packages\\srsly\\_msgpack_api.py\", line 14, in msgpack_dumps\r\n    return msgpack.dumps(data, use_bin_type=True)\r\n  File \"C:\\Python38\\lib\\site-packages\\srsly\\msgpack\\__init__.py\", line 55, in packb\r\n    return Packer(**kwargs).pack(o)\r\n  File \"srsly\\msgpack\\_packer.pyx\", line 285, in srsly.msgpack._packer.Packer.pack\r\n  File \"srsly\\msgpack\\_packer.pyx\", line 291, in srsly.msgpack._packer.Packer.pack\r\n  File \"srsly\\msgpack\\_packer.pyx\", line 288, in srsly.msgpack._packer.Packer.pack\r\n  File \"srsly\\msgpack\\_packer.pyx\", line 264, in srsly.msgpack._packer.Packer._pack\r\n  File \"srsly\\msgpack\\_packer.pyx\", line 282, in srsly.msgpack._packer.Packer._pack\r\nTypeError: can not serialize 'spacy.tokens.span.Span' object\r\n```\r\n\r\nRunning spacy 3.0, the latest version, and on Windows 10.","closed_by":{"login":"dakinggg","id":43149077,"node_id":"MDQ6VXNlcjQzMTQ5MDc3","avatar_url":"https://avatars.githubusercontent.com/u/43149077?v=4","gravatar_id":"","url":"https://api.github.com/users/dakinggg","html_url":"https://github.com/dakinggg","followers_url":"https://api.github.com/users/dakinggg/followers","following_url":"https://api.github.com/users/dakinggg/following{/other_user}","gists_url":"https://api.github.com/users/dakinggg/gists{/gist_id}","starred_url":"https://api.github.com/users/dakinggg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakinggg/subscriptions","organizations_url":"https://api.github.com/users/dakinggg/orgs","repos_url":"https://api.github.com/users/dakinggg/repos","events_url":"https://api.github.com/users/dakinggg/events{/privacy}","received_events_url":"https://api.github.com/users/dakinggg/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/allenai/scispacy/issues/338/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/allenai/scispacy/issues/338/timeline","performed_via_github_app":null,"state_reason":"completed"}