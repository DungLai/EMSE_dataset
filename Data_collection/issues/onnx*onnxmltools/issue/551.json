{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/551","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/551/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/551/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/551/events","html_url":"https://github.com/onnx/onnxmltools/issues/551","id":1243834236,"node_id":"I_kwDOB0J-H85KI2d8","number":551,"title":"SparkML OneHotEncoder conversion is wrong","user":{"login":"memoryz","id":6992432,"node_id":"MDQ6VXNlcjY5OTI0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/6992432?v=4","gravatar_id":"","url":"https://api.github.com/users/memoryz","html_url":"https://github.com/memoryz","followers_url":"https://api.github.com/users/memoryz/followers","following_url":"https://api.github.com/users/memoryz/following{/other_user}","gists_url":"https://api.github.com/users/memoryz/gists{/gist_id}","starred_url":"https://api.github.com/users/memoryz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/memoryz/subscriptions","organizations_url":"https://api.github.com/users/memoryz/orgs","repos_url":"https://api.github.com/users/memoryz/repos","events_url":"https://api.github.com/users/memoryz/events{/privacy}","received_events_url":"https://api.github.com/users/memoryz/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-21T01:46:31Z","updated_at":"2022-05-27T19:28:19Z","closed_at":"2022-05-27T19:28:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"SparkML OneHotEncoder conversion is implemented wrong. It just so happens to handle the conversion when there is one input column and one output column. Once you try multiple inputCols and outputCols, the generated ONNX graph is wrong.\r\n\r\nRepro:\r\n\r\n```python\r\n\r\nfrom pyspark.ml.feature import OneHotEncoder\r\nfrom onnxconverter_common.data_types import FloatTensorType, Int32TensorType\r\nfrom onnxmltools.convert import convert_sparkml\r\nfrom onnxruntime import InferenceSession\r\n\r\ndf = spark.createDataFrame(\r\n  [(0, 2), (1, 4),],\r\n  [\"col1\", \"col2\"]\r\n)\r\n\r\nencoder = OneHotEncoder(inputCols = [\"col1\", \"col2\"], outputCols = [\"col1_enc\", \"col2_enc\"], dropLast=False).fit(df)\r\n\r\ninitial_types = [\r\n  (\"col1\", Int32TensorType([None, 1])),\r\n  (\"col2\", Int32TensorType([None, 1])),\r\n]\r\n\r\nonnx_model = convert_sparkml(encoder, 'OneHotEncoder', initial_types)\r\n\r\n# Writing the model out for inspection\r\nwith open(\"ohe_quicktest.onnx\", \"wb\") as f:\r\n    f.write(onnx_model.SerializeToString())\r\n\r\n# Run with onnx runtime\r\ninput_data = {\"col1\": [(0, 1)], \"col2\": [(2, 4)]}\r\nsession = InferenceSession(onnx_model.SerializeToString(), providers=[\"CPUExecutionProvider\"])\r\noutput = session.run(None, input_data)\r\n```\r\n\r\nExpected result:\r\nThe model can correct encode the input features.\r\n\r\nActual result:\r\nInvalidArgument: [ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Failed to load model with error: /onnxruntime_src/onnxruntime/core/graph/graph.cc:1368 void onnxruntime::Graph::InitializeStateFromModelFileGraphProto() This is an invalid model. Graph output (col2_enc) does not exist in the graph.\r\n\r\nThe generated ONNX graph looks like this, which is obviously wrong:\r\n![image](https://user-images.githubusercontent.com/6992432/169629737-2fe2a869-d4e0-484c-ab1b-6c3fe875d513.png)\r\n","closed_by":{"login":"memoryz","id":6992432,"node_id":"MDQ6VXNlcjY5OTI0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/6992432?v=4","gravatar_id":"","url":"https://api.github.com/users/memoryz","html_url":"https://github.com/memoryz","followers_url":"https://api.github.com/users/memoryz/followers","following_url":"https://api.github.com/users/memoryz/following{/other_user}","gists_url":"https://api.github.com/users/memoryz/gists{/gist_id}","starred_url":"https://api.github.com/users/memoryz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/memoryz/subscriptions","organizations_url":"https://api.github.com/users/memoryz/orgs","repos_url":"https://api.github.com/users/memoryz/repos","events_url":"https://api.github.com/users/memoryz/events{/privacy}","received_events_url":"https://api.github.com/users/memoryz/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/551/timeline","performed_via_github_app":null,"state_reason":"completed"}