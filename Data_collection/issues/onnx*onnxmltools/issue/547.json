{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/547","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/547/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/547/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/547/events","html_url":"https://github.com/onnx/onnxmltools/issues/547","id":1229934572,"node_id":"I_kwDOB0J-H85JT0_s","number":547,"title":"onnxmltools convert_sparkml bug: AttributeError: 'SparkSession' object has no attribute 'util'` to convert spark tree-based models to onnx.","user":{"login":"RayTsui","id":13369167,"node_id":"MDQ6VXNlcjEzMzY5MTY3","avatar_url":"https://avatars.githubusercontent.com/u/13369167?v=4","gravatar_id":"","url":"https://api.github.com/users/RayTsui","html_url":"https://github.com/RayTsui","followers_url":"https://api.github.com/users/RayTsui/followers","following_url":"https://api.github.com/users/RayTsui/following{/other_user}","gists_url":"https://api.github.com/users/RayTsui/gists{/gist_id}","starred_url":"https://api.github.com/users/RayTsui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RayTsui/subscriptions","organizations_url":"https://api.github.com/users/RayTsui/orgs","repos_url":"https://api.github.com/users/RayTsui/repos","events_url":"https://api.github.com/users/RayTsui/events{/privacy}","received_events_url":"https://api.github.com/users/RayTsui/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-09T15:57:28Z","updated_at":"2022-06-09T21:33:37Z","closed_at":"2022-06-08T07:34:42Z","author_association":"NONE","active_lock_reason":null,"body":"I installed ONNX 1.10.0, ONNX Runtime 1.10.0 and ONNXMLTools 1.10.0\r\nI converted a spark tree-based model classifier (like GBTClassifier) model (trained in Python 3.7) to an ONNX model by onnxmltools.convert.convert_sparkml(). Which gives me the following bug\r\n\r\n`File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/main.py\", line 167, in convert_sparkml\r\n    custom_conversion_functions, custom_shape_calculators, spark_session)\r\n  File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/convert.py\", line 71, in convert\r\n    onnx_model = convert_topology(topology, name, doc_string, target_opset, targeted_onnx)\r\n  File \"/usr/local/lib/python3.7/site-packages/onnxconverter_common/topology.py\", line 776, in convert_topology\r\n    get_converter(operator.type)(scope, operator, container)\r\n  File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/gbt_classifier.py\", line 26, in convert_gbt_classifier\r\n    convert_decision_tree_regressor(scope, regressor_op, container)\r\n  File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/decision_tree_regressor.py\", line 20, in convert_decision_tree_regressor\r\n    tree_df = save_read_sparkml_model_data(operator.raw_params['SparkSession'], op)\r\n  File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/tree_ensemble_common.py\", line 37, in save_read_sparkml_model_data\r\n    tdir = spark.util.Utils.createTempDir().getAbsolutePath()\r\nAttributeError: 'SparkSession' object has no attribute 'util'`\r\n\r\nI trace the code execution flow not that: \r\n`\r\ndef _parse_sparkml_simple_model(spark, scope, model, global_inputs, output_dict):\r\n  \r\n    this_operator = scope.declare_local_operator(get_sparkml_operator_name(type(model)), model)\r\n    this_operator.raw_params = {'SparkSession': spark}\r\n`\r\n this_operator.raw_params = {'SparkSession': spark} the value is SparkSession instance, \r\nso when the code reaches to save_read_sparkml_model_data, where SparkSession instance does not have util attribute. \r\n\r\nMeanwhile, the line 44 at https://github.com/onnx/onnxmltools/blob/main/onnxmltools/convert/sparkml/operator_converters/tree_ensemble_common.py indicates it is SparkSession instance bc it can be used to create to spark.sql.DataFrame. but at line 44, SparkSession instance does not have util attr or method.\r\n\r\nCan anyone know what happened here or it is a bug, so very appreciated for any help.","closed_by":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/547/timeline","performed_via_github_app":null,"state_reason":"completed"}