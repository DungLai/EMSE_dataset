{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/338","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/338/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/338/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/338/events","html_url":"https://github.com/onnx/onnxmltools/issues/338","id":500457721,"node_id":"MDU6SXNzdWU1MDA0NTc3MjE=","number":338,"title":"[LGBMRanker] Bug in _parse.py and misleading documentation in convert.py","user":{"login":"sheon-han-zocdoc","id":29129916,"node_id":"MDQ6VXNlcjI5MTI5OTE2","avatar_url":"https://avatars.githubusercontent.com/u/29129916?v=4","gravatar_id":"","url":"https://api.github.com/users/sheon-han-zocdoc","html_url":"https://github.com/sheon-han-zocdoc","followers_url":"https://api.github.com/users/sheon-han-zocdoc/followers","following_url":"https://api.github.com/users/sheon-han-zocdoc/following{/other_user}","gists_url":"https://api.github.com/users/sheon-han-zocdoc/gists{/gist_id}","starred_url":"https://api.github.com/users/sheon-han-zocdoc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sheon-han-zocdoc/subscriptions","organizations_url":"https://api.github.com/users/sheon-han-zocdoc/orgs","repos_url":"https://api.github.com/users/sheon-han-zocdoc/repos","events_url":"https://api.github.com/users/sheon-han-zocdoc/events{/privacy}","received_events_url":"https://api.github.com/users/sheon-han-zocdoc/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-09-30T18:55:23Z","updated_at":"2022-07-12T15:32:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"# Issue\r\nIn [`onnxmltools/convert/lightgbm/convert.py`](https://github.com/onnx/onnxmltools/blob/060a71ef947f9d9e87e94dd8320ef78c83c946cb/onnxmltools/convert/lightgbm/convert.py), inline comments indicate that only `LGBMClassifiers`, `LGBMRegressor` and `Booster` are supported:\r\n\r\n```\r\nThis function produces an equivalent ONNX model of the given lightgbm model.\r\nThe supported lightgbm modules are listed below.\r\n    \r\n* `LGBMClassifiers <https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMClassifier.html>`_\r\n* `LGBMRegressor <https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMRegressor.html>`_\r\n* `Booster <https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.Booster.html>`_\r\n```\r\n\r\n# Steps \r\n1. We trained our model using the official `microsoft/LightGBM`, and inspecting its source code shows that [it assigns the value `\"lambdarank\"`](https://github.com/microsoft/LightGBM/blob/a0d7313b81a85754a0549bbd0354f9e74d832672/python-package/lightgbm/sklearn.py#L481-L482) as the model's objective function:\r\n\r\n```python\r\nif isinstance(self, LGBMRegressor):\r\n    self._objective = \"regression\"\r\nelif isinstance(self, LGBMClassifier):\r\n    self._objective = \"binary\"\r\nelif isinstance(self, LGBMRanker):\r\n    self._objective = \"lambdarank\"\t\r\n```\r\n\r\n2. But when we tried to convert the model, we got `\"unsupported LightGbm objective: lambarank\"` error. We believe the issue is in [`convert/lightgbm/_parse.py`](https://github.com/onnx/onnxmltools/blob/d2c8fb75454f19fced4ae733b50a940a6b82862f/onnxmltools/convert/lightgbm/_parse.py#L28-L31) where it checks for the string `\"binary\"` and `\"regression\"` but not `\"lambdarank\"`:\r\n\r\n```python\r\nif _model_dict['objective'].startswith('binary'):\r\n    self.operator_name = 'LgbmClassifier'\r\nelif _model_dict['objective'].startswith('regression'):\r\n    self.operator_name = 'LgbmRegressor'\r\n```\r\n\r\n3. To bypass this conditionals, we changed two occurrences of the string `\"lambdarank\"` from our `model.txt`. Then, we were able to convert the model to ONNX, and the converted model made correct predictions:\r\n```\r\n# our changes in model.txt\r\ntree\r\nversion=v3\r\nnum_class=1\r\n.\r\n.\r\n.\r\nobjective=lambdarank => objective=regression # change 1\r\n.\r\n.\r\n.\r\nparameters:\r\n[boosting: gbdt]\r\n[objective: lambdarank] => [objective: regression] # change 2\r\n```\r\n\r\nWe suggest creating a fix in `onnxmltools/convert/lightgbm/_parse.py` to accept models with `lambdarank` as `objective`.\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/338/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/338/timeline","performed_via_github_app":null,"state_reason":null}