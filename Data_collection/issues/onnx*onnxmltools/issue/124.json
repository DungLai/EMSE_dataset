{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/124","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/124/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/124/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/124/events","html_url":"https://github.com/onnx/onnxmltools/issues/124","id":346818026,"node_id":"MDU6SXNzdWUzNDY4MTgwMjY=","number":124,"title":"Unsupported shape calculation for operator Dropout","user":{"login":"eraoul","id":1067070,"node_id":"MDQ6VXNlcjEwNjcwNzA=","avatar_url":"https://avatars.githubusercontent.com/u/1067070?v=4","gravatar_id":"","url":"https://api.github.com/users/eraoul","html_url":"https://github.com/eraoul","followers_url":"https://api.github.com/users/eraoul/followers","following_url":"https://api.github.com/users/eraoul/following{/other_user}","gists_url":"https://api.github.com/users/eraoul/gists{/gist_id}","starred_url":"https://api.github.com/users/eraoul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eraoul/subscriptions","organizations_url":"https://api.github.com/users/eraoul/orgs","repos_url":"https://api.github.com/users/eraoul/repos","events_url":"https://api.github.com/users/eraoul/events{/privacy}","received_events_url":"https://api.github.com/users/eraoul/received_events","type":"User","site_admin":false},"labels":[{"id":839509663,"node_id":"MDU6TGFiZWw4Mzk1MDk2NjM=","url":"https://api.github.com/repos/onnx/onnxmltools/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":839509668,"node_id":"MDU6TGFiZWw4Mzk1MDk2Njg=","url":"https://api.github.com/repos/onnx/onnxmltools/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2018-08-02T00:38:44Z","updated_at":"2018-08-17T19:51:22Z","closed_at":"2018-08-17T19:51:21Z","author_association":"NONE","active_lock_reason":null,"body":"I made a new model using keras, and saved it to an .hdf file using a callback during training.\r\n\r\nI reloaded the model and tried to convert to an ONNX model:\r\n```\r\nmodel = keras.models.load_model(filename)\r\nwinml_onnx_model = onnxmltools.convert_keras(model)\r\n```\r\n\r\nconvert_keras throws an error here. Any idea what I might be doing wrong? I'm on Windows 10, python 3.6.2, Tensorflow 1.8, Keras 2.1.5, onnxmltools 1.2.0.0116, winmltools 1.2.0.0725\r\n\r\nThe model uses the following operators (but the error seems to be due to the Dropout layer):\r\n\r\nActivation, Dropout, BatchNormalization, Convolution2D, MaxPooling2D, GlobalAveragePooling2D\r\n\r\nIf I do model.summary() everything seems fine with my model. Batch size is always specified as \"None\" in the model summary, so I wonder if there's some issue with how to deal with batch size in the ONNx conversion (this is my first time making an ONNX model)\r\n\r\nThanks!\r\n\r\nUPDATE: This simple model gives the same error. I also tried specifying the batch_input_shape explicitly to just allow 1 item in the batch, and it didn't change anything:\r\n\r\n```\r\nmodel2 = Sequential()\r\nmodel2.add(Dense(50, batch_input_shape=[1, 5]))\r\nmodel2.add(Dropout(0.5))\r\nwinml_onnx_model2 = onnxmltools.convert_keras(model2)\r\n\r\n```\r\n\r\nError below:\r\n```\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-15-da007af6c51d> in <module>()\r\n----> 1 winml_onnx_model = onnxmltools.convert_keras(model)\r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\main.py in convert_keras(model, name, initial_types, doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\r\n     36     from .keras.convert import convert\r\n     37     return convert(model, name, initial_types,\r\n---> 38                    doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\keras\\convert.py in convert(model, name, initial_types, doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\r\n     40     topology = parse_keras(model, initial_types, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\r\n     41 \r\n---> 42     topology.compile()\r\n     43 \r\n     44     if name is None:\r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in compile(self)\r\n    607         self._resolve_duplicates()\r\n    608         self._fix_shapes()\r\n--> 609         self._infer_all_types()\r\n    610         self._check_structure()\r\n    611 \r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in _infer_all_types(self)\r\n    493                 pass  # in Keras converter, the shape calculator can be optional.\r\n    494             else:\r\n--> 495                 operator.infer_types()\r\n    496 \r\n    497     def _resolve_duplicates(self):\r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in infer_types(self)\r\n     95     def infer_types(self):\r\n     96         # Invoke a core inference function\r\n---> 97         _registration.get_shape_calculator(self.type)(self)\r\n     98 \r\n     99 \r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_registration.py in get_shape_calculator(operator_name)\r\n     66     '''\r\n     67     if operator_name not in _shape_calculator_pool:\r\n---> 68         raise ValueError('Unsupported shape calculation for operator %s' % operator_name)\r\n     69     return _shape_calculator_pool[operator_name]\r\n\r\nValueError: Unsupported shape calculation for operator <class 'keras.layers.core.Dropout'>\r\n```","closed_by":{"login":"wschin","id":3524474,"node_id":"MDQ6VXNlcjM1MjQ0NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/3524474?v=4","gravatar_id":"","url":"https://api.github.com/users/wschin","html_url":"https://github.com/wschin","followers_url":"https://api.github.com/users/wschin/followers","following_url":"https://api.github.com/users/wschin/following{/other_user}","gists_url":"https://api.github.com/users/wschin/gists{/gist_id}","starred_url":"https://api.github.com/users/wschin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wschin/subscriptions","organizations_url":"https://api.github.com/users/wschin/orgs","repos_url":"https://api.github.com/users/wschin/repos","events_url":"https://api.github.com/users/wschin/events{/privacy}","received_events_url":"https://api.github.com/users/wschin/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/124/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/124/timeline","performed_via_github_app":null,"state_reason":"completed"}