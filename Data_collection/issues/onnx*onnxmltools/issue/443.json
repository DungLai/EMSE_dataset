{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/443","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/443/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/443/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/443/events","html_url":"https://github.com/onnx/onnxmltools/issues/443","id":791046669,"node_id":"MDU6SXNzdWU3OTEwNDY2Njk=","number":443,"title":"How do I convert to ONNX a Spark model with multiple input columns and use it for scoring dynamic batch size?","user":{"login":"adieldar","id":6695027,"node_id":"MDQ6VXNlcjY2OTUwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/6695027?v=4","gravatar_id":"","url":"https://api.github.com/users/adieldar","html_url":"https://github.com/adieldar","followers_url":"https://api.github.com/users/adieldar/followers","following_url":"https://api.github.com/users/adieldar/following{/other_user}","gists_url":"https://api.github.com/users/adieldar/gists{/gist_id}","starred_url":"https://api.github.com/users/adieldar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adieldar/subscriptions","organizations_url":"https://api.github.com/users/adieldar/orgs","repos_url":"https://api.github.com/users/adieldar/repos","events_url":"https://api.github.com/users/adieldar/events{/privacy}","received_events_url":"https://api.github.com/users/adieldar/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-01-21T12:52:28Z","updated_at":"2022-12-27T06:40:42Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nI converted a logistic regression model with dynamic batch size from Spark ML to ONNX using this:\r\n\r\ninitial_types = [('Features', FloatTensorType([None, 5]))]\r\nonnx_model = convert_sparkml(s_clf, 'Occupancy detection Pyspark Logistic Regression model', initial_types, spark_session = sess)\r\n\r\nThen  I successfully scored df1, a dynamic batch of samples whose shape is (12417, 5) using the code below:\r\n\r\nimport onnxruntime as rt\r\nsess = rt.InferenceSession(bmodel)\r\ninput_name = sess.get_inputs()[0].name\r\nlabel_name = sess.get_outputs()[0].name\r\ndf1 = df[features_cols]\r\npredictions = sess.run([label_name], {input_name: df1.values.astype(np.float32)})[0]\r\n\r\nNow I try to build a pipeline and convert to ONNX. I tried to convert the first stage of it, which is just a VectorAssembler:\r\n\r\ninitial_types = [\r\n  ('Temperature', FloatTensorType([None, 1])),\r\n  ('Humidity', FloatTensorType([None, 1])),\r\n  ('Light', FloatTensorType([None, 1])),\r\n  ('CO2', FloatTensorType([None, 1])),\r\n  ('HumidityRatio', FloatTensorType([None, 1])),\r\n]\r\nonnx_model = convert_sparkml(assembler, 'Occupancy detection Pyspark Assembler of features', initial_types, spark_session = sess).\r\n\r\nTrying to consume it using this code:\r\n\r\npredictions = sess.run([label_name],\r\n    {\r\n        \"Temperature\": [df1.Temperature.values.astype(np.float32)],\r\n        \"Humidity\": [df1.Humidity.values.astype(np.float32)],\r\n        \"Light\": [df1.Light.values.astype(np.float32)],\r\n        \"CO2\": [df1.CO2.values.astype(np.float32)],\r\n        \"HumidityRatio\": [df1.HumidityRatio.values.astype(np.float32)],\r\n    })[0]\r\n\r\nfails, with [ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Got invalid dimensions for input: Light for the following indices\r\n index: 1 Got: 12417 Expected: 1.\r\n\r\nJust for testing, I selected a single samples by adding df1 = df1[:1], then the code above works..\r\n\r\nHow can I export a model with multiple input columns like above so I could run it on dynamic batch size? How come Logistic Regression works flawlessly, and this simple VectorAssembler fails?\r\n\r\nThanks for your help,\r\nAdi\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/443/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/443/timeline","performed_via_github_app":null,"state_reason":null}