{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/553","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/553/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/553/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/553/events","html_url":"https://github.com/onnx/onnxmltools/issues/553","id":1251205303,"node_id":"I_kwDOB0J-H85Kk-C3","number":553,"title":"Converter for SparkML  VectorAssembler does not support vector inputs correctly","user":{"login":"memoryz","id":6992432,"node_id":"MDQ6VXNlcjY5OTI0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/6992432?v=4","gravatar_id":"","url":"https://api.github.com/users/memoryz","html_url":"https://github.com/memoryz","followers_url":"https://api.github.com/users/memoryz/followers","following_url":"https://api.github.com/users/memoryz/following{/other_user}","gists_url":"https://api.github.com/users/memoryz/gists{/gist_id}","starred_url":"https://api.github.com/users/memoryz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/memoryz/subscriptions","organizations_url":"https://api.github.com/users/memoryz/orgs","repos_url":"https://api.github.com/users/memoryz/repos","events_url":"https://api.github.com/users/memoryz/events{/privacy}","received_events_url":"https://api.github.com/users/memoryz/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-05-27T19:51:04Z","updated_at":"2022-06-05T00:04:25Z","closed_at":"2022-06-05T00:04:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"SparkML's VectorAssembler allows the input cols to be vector columns as well as ordinary columns. When the ONNX converter calculates the vector assembler's output shape, it doesn't consider the size of the vector.\r\n\r\n[Code](https://github.com/onnx/onnxmltools/blob/19a0ddf0dc0a0f2215ee14dedcbaa40df6eafc15/onnxmltools/convert/sparkml/operator_converters/vector_assembler.py#L19-L29)\r\n\r\n```python\r\ndef calculate_vector_assembler_shapes(operator):\r\n    check_input_and_output_numbers(operator, output_count_range=1)\r\n    C = len(operator.raw_operator.getInputCols())\r\n    col_type = operator.inputs[0].type\r\n    if isinstance(col_type, FloatTensorType):\r\n        col_type = FloatTensorType([1, C])\r\n    elif isinstance(col_type, Int64TensorType):\r\n        col_type = Int64TensorType([1, C])\r\n    else:\r\n        raise TypeError(\"Unsupported input type\")\r\n    operator.outputs[0].type = col_type\r\n```\r\n\r\n`C` only adds up the number of inputCols, but when an input column itself is a vector, the size of the vector is not correctly counted.\r\n\r\nReproduce:\r\n\r\n```python\r\nfrom pyspark.ml.linalg import Vectors\r\nfrom pyspark.ml.feature import VectorAssembler\r\n\r\ncol_names = [\"a\", \"b\"]\r\n       \r\nmodel = VectorAssembler(inputCols=col_names, outputCol='features')\r\ndata = self.spark.createDataFrame([(1., Vectors.dense([1.0, 2.0, 3.0]))], col_names)\r\nmodel_onnx = convert_sparkml(model, 'Sparkml VectorAssembler',  [\r\n            ('a', FloatTensorType([None, 1])),\r\n            ('b', FloatTensorType([None, 3]))\r\n        ], target_opset=TARGET_OPSET)\r\n```\r\n\r\nExpected result:\r\nThe output shape should be 1x4.\r\n\r\nActual result:\r\nThe output shape is 1x2.\r\n![image](https://user-images.githubusercontent.com/6992432/170780457-3a1f7393-a07a-4e40-ae52-70cc491ca268.png)\r\n\r\n\r\nPR coming soon.","closed_by":{"login":"memoryz","id":6992432,"node_id":"MDQ6VXNlcjY5OTI0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/6992432?v=4","gravatar_id":"","url":"https://api.github.com/users/memoryz","html_url":"https://github.com/memoryz","followers_url":"https://api.github.com/users/memoryz/followers","following_url":"https://api.github.com/users/memoryz/following{/other_user}","gists_url":"https://api.github.com/users/memoryz/gists{/gist_id}","starred_url":"https://api.github.com/users/memoryz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/memoryz/subscriptions","organizations_url":"https://api.github.com/users/memoryz/orgs","repos_url":"https://api.github.com/users/memoryz/repos","events_url":"https://api.github.com/users/memoryz/events{/privacy}","received_events_url":"https://api.github.com/users/memoryz/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/553/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/553/timeline","performed_via_github_app":null,"state_reason":"completed"}