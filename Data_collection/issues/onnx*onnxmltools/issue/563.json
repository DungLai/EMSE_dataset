{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/563","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/563/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/563/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/563/events","html_url":"https://github.com/onnx/onnxmltools/issues/563","id":1266683324,"node_id":"I_kwDOB0J-H85LgA28","number":563,"title":"onnxmltools convert_sparkml bug: AttributeError: 'SparkSession' object has no attribute 'util'` to convert spark tree-based models to onnx. ","user":{"login":"RayTsui","id":13369167,"node_id":"MDQ6VXNlcjEzMzY5MTY3","avatar_url":"https://avatars.githubusercontent.com/u/13369167?v=4","gravatar_id":"","url":"https://api.github.com/users/RayTsui","html_url":"https://github.com/RayTsui","followers_url":"https://api.github.com/users/RayTsui/followers","following_url":"https://api.github.com/users/RayTsui/following{/other_user}","gists_url":"https://api.github.com/users/RayTsui/gists{/gist_id}","starred_url":"https://api.github.com/users/RayTsui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RayTsui/subscriptions","organizations_url":"https://api.github.com/users/RayTsui/orgs","repos_url":"https://api.github.com/users/RayTsui/repos","events_url":"https://api.github.com/users/RayTsui/events{/privacy}","received_events_url":"https://api.github.com/users/RayTsui/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-09T21:34:18Z","updated_at":"2022-06-16T15:27:37Z","closed_at":"2022-06-16T15:27:36Z","author_association":"NONE","active_lock_reason":null,"body":"I installed ONNX 1.10.0, ONNX Runtime 1.10.0 and ONNXMLTools 1.10.0\r\nI converted a spark tree-based model classifier (like GBTClassifier) model (trained in Python 3.7) to an ONNX model by onnxmltools.convert.convert_sparkml(). Which gives me the following bug\r\n\r\nFile \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/main.py\", line 167, in convert_sparkml custom_conversion_functions, custom_shape_calculators, spark_session) File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/convert.py\", line 71, in convert onnx_model = convert_topology(topology, name, doc_string, target_opset, targeted_onnx) File \"/usr/local/lib/python3.7/site-packages/onnxconverter_common/topology.py\", line 776, in convert_topology get_converter(operator.type)(scope, operator, container) File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/gbt_classifier.py\", line 26, in convert_gbt_classifier convert_decision_tree_regressor(scope, regressor_op, container) File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/decision_tree_regressor.py\", line 20, in convert_decision_tree_regressor tree_df = save_read_sparkml_model_data(operator.raw_params['SparkSession'], op) File \"/usr/local/lib/python3.7/site-packages/onnxmltools/convert/sparkml/operator_converters/tree_ensemble_common.py\", line 37, in save_read_sparkml_model_data tdir = spark.util.Utils.createTempDir().getAbsolutePath() AttributeError: 'SparkSession' object has no attribute 'util'\r\n\r\nI trace the code execution flow not that:\r\n`\r\ndef _parse_sparkml_simple_model(spark, scope, model, global_inputs, output_dict):\r\n\r\nthis_operator = scope.declare_local_operator(get_sparkml_operator_name(type(model)), model)\r\nthis_operator.raw_params = {'SparkSession': spark}\r\n`\r\nthis_operator.raw_params = {'SparkSession': spark} the value is SparkSession instance,\r\nso when the code reaches to save_read_sparkml_model_data, where SparkSession instance does not have util attribute.\r\n\r\nMeanwhile, the line 44 at https://github.com/onnx/onnxmltools/blob/main/onnxmltools/convert/sparkml/operator_converters/tree_ensemble_common.py indicates it is SparkSession instance bc it can be used to create to spark.sql.DataFrame. but at line 44, SparkSession instance does not have util attr or method.\r\n\r\nCan anyone know what happened here or it is a bug, so very appreciated for any help.","closed_by":{"login":"RayTsui","id":13369167,"node_id":"MDQ6VXNlcjEzMzY5MTY3","avatar_url":"https://avatars.githubusercontent.com/u/13369167?v=4","gravatar_id":"","url":"https://api.github.com/users/RayTsui","html_url":"https://github.com/RayTsui","followers_url":"https://api.github.com/users/RayTsui/followers","following_url":"https://api.github.com/users/RayTsui/following{/other_user}","gists_url":"https://api.github.com/users/RayTsui/gists{/gist_id}","starred_url":"https://api.github.com/users/RayTsui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RayTsui/subscriptions","organizations_url":"https://api.github.com/users/RayTsui/orgs","repos_url":"https://api.github.com/users/RayTsui/repos","events_url":"https://api.github.com/users/RayTsui/events{/privacy}","received_events_url":"https://api.github.com/users/RayTsui/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/563/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/563/timeline","performed_via_github_app":null,"state_reason":"completed"}