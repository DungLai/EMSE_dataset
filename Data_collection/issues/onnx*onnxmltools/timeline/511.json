[{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/950655189","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-950655189","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":950655189,"node_id":"IC_kwDOB0J-H844qdjV","user":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false},"created_at":"2021-10-25T08:22:44Z","updated_at":"2021-10-25T08:22:44Z","author_association":"COLLABORATOR","body":"I tried to replicate your issue with the following example and the conversion succeeds. Between step 2 and step 4, the model seems to be trained twice, the first instance is used compute the expected outputs, the second is converted into ONNX. But the two models are likely to be different.\r\n\r\n```\r\nimport numpy\r\nfrom numpy import asarray\r\nfrom numpy.testing import assert_almost_equal\r\nfrom xgboost import XGBRegressor\r\nfrom sklearn.model_selection import cross_val_score\r\nfrom sklearn.model_selection import RepeatedKFold\r\nfrom sklearn.datasets import make_regression\r\nfrom sklearn.model_selection import train_test_split\r\nfrom onnxmltools.convert.common.data_types import FloatTensorType\r\nfrom onnxmltools.convert import convert_xgboost\r\nfrom onnxconverter_common.onnx_ex import DEFAULT_OPSET_NUMBER\r\nfrom onnx.defs import onnx_opset_version\r\nimport onnxruntime as rt\r\nimport onnxmltools\r\n\r\n\r\nfeatures, labels = make_regression(1000)\r\nlabels /= 100\r\nprint(\"label range:\", min(labels), max(labels))  # ~ -5, 5\r\ntrain_features, test_features, train_labels, test_labels = train_test_split(features, labels)\r\n\r\nTARGET_OPSET = min(DEFAULT_OPSET_NUMBER, onnx_opset_version())\r\nxg_export_model = XGBRegressor(n_estimators=200, max_depth=7, eta=0.01, subsample=0.7, colsample_bytree=0.8)\r\n\r\n# fit model\r\nxg_export_model.fit(train_features, train_labels)\r\nxg_test_predicted = xg_export_model.predict(test_features.astype(numpy.float32))\r\n\r\ninitial_type = [('float_input', FloatTensorType([None, train_features.shape[1]]))]\r\nonx = convert_xgboost(xg_export_model, initial_types=initial_type, target_opset=TARGET_OPSET)\r\nonnxmltools.utils.save_model(onx, 'better_model.onnx')\r\n\r\nsess = rt.InferenceSession(onx.SerializeToString())\r\ninput_name = sess.get_inputs()[0].name\r\nlabel_name = sess.get_outputs()[0].name\r\npred_onx = sess.run(\r\n    [label_name], {input_name: test_features.astype(numpy.float32)})[0]\r\n\r\nassert_almost_equal(xg_test_predicted.ravel(), pred_onx.ravel(), decimal=5)\r\n```","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/950655189/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/951428213","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-951428213","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":951428213,"node_id":"IC_kwDOB0J-H844taR1","user":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false},"created_at":"2021-10-25T23:55:35Z","updated_at":"2021-10-25T23:55:35Z","author_association":"NONE","body":"I also try just use the model from Step1, but still getting a different result, looks like there is something related to the cv = `RepeatedKFold(n_splits=10, n_repeats=3, random_state=1)`, have you tried to use RepeatedKFold and see the same result yield?","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/951428213/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/951787177","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-951787177","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":951787177,"node_id":"IC_kwDOB0J-H844ux6p","user":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false},"created_at":"2021-10-26T10:10:56Z","updated_at":"2021-10-26T10:10:56Z","author_association":"COLLABORATOR","body":"I'm not sure I follow you what you are doing. RepeatedKFold produces several models, all different. All of them will be different from the model you convert in Step 3. Predictions will be different.","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/951787177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/952420324","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-952420324","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":952420324,"node_id":"IC_kwDOB0J-H844xMfk","user":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false},"created_at":"2021-10-26T23:57:47Z","updated_at":"2021-10-26T23:57:47Z","author_association":"NONE","body":"Here is what i did\r\n\r\n### Training\r\n```\r\nfrom numpy import asarray\r\nfrom xgboost import XGBRegressor\r\nfrom sklearn.model_selection import cross_val_score\r\nfrom sklearn.model_selection import RepeatedKFold\r\n\r\nxgb_model =  XGBRegressor(n_estimators=200, max_depth=7, eta=0.01, subsample=0.7, colsample_bytree=0.8, verbosity=1, gpu_id=0)\r\nxgb_model.fit(train_features, train_labels)\r\nscore = xgb_model.score(train_features, train_labels)   \r\nprint(score.mean())\r\n#define model evaluation method\r\ncv = RepeatedKFold(n_splits=10, n_repeats=3, random_state=4)\r\n# evaluate model\r\nscores = cross_val_score(xgb_model, train_features, train_labels, scoring='neg_mean_absolute_error', cv=cv, n_jobs=-1)\r\nprint('Mean MAE: %.3f (%.3f)' % (scores.mean(), scores.std()) )\r\ntest_results['auto_loss_model'] = scores.mean() * -1\r\n\r\n### Persist the model\r\nxgb_model.save_model('sapcost_model.model')\r\n```\r\n\r\n### Reload the persisted model\r\n```\r\nreloaded_xgb_model = xgb.XGBRegressor(n_estimators=200, max_depth=7, eta=0.01, subsample=0.7, colsample_bytree=0.8,\r\n                                      verbosity=1)\r\nreloaded_xgb_model.load_model('sapcost_model.model')\r\n```\r\n\r\nThe `reloaded_xgb_model` model predicts the same result, however if i convert the model to onnx as in `Step 3` and reload, different results yield\r\n","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/952420324/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/952653059","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-952653059","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":952653059,"node_id":"IC_kwDOB0J-H844yFUD","user":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false},"created_at":"2021-10-27T08:14:50Z","updated_at":"2021-10-27T08:14:50Z","author_association":"COLLABORATOR","body":"That's where I'm confused. The model is trained again in Step 3 and that would yield a different model and different prediction.","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/952653059/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/953386908","html_url":"https://github.com/onnx/onnxmltools/issues/511#issuecomment-953386908","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/511","id":953386908,"node_id":"IC_kwDOB0J-H84404ec","user":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false},"created_at":"2021-10-27T23:38:50Z","updated_at":"2021-10-27T23:38:50Z","author_association":"NONE","body":"I mean i did persist the model without training the model again, but still yield a different result","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/953386908/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mayuanyang","id":3387099,"node_id":"MDQ6VXNlcjMzODcwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/3387099?v=4","gravatar_id":"","url":"https://api.github.com/users/mayuanyang","html_url":"https://github.com/mayuanyang","followers_url":"https://api.github.com/users/mayuanyang/followers","following_url":"https://api.github.com/users/mayuanyang/following{/other_user}","gists_url":"https://api.github.com/users/mayuanyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mayuanyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayuanyang/subscriptions","organizations_url":"https://api.github.com/users/mayuanyang/orgs","repos_url":"https://api.github.com/users/mayuanyang/repos","events_url":"https://api.github.com/users/mayuanyang/events{/privacy}","received_events_url":"https://api.github.com/users/mayuanyang/received_events","type":"User","site_admin":false}}]