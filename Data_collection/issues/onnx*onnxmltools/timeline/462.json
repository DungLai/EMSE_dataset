[{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836695395","html_url":"https://github.com/onnx/onnxmltools/issues/462#issuecomment-836695395","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/462","id":836695395,"node_id":"MDEyOklzc3VlQ29tbWVudDgzNjY5NTM5NQ==","user":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"created_at":"2021-05-10T13:24:27Z","updated_at":"2021-05-10T13:24:27Z","author_association":"CONTRIBUTOR","body":"Ok, this seems more complicated than I first thought.\r\n\r\n- The [ONNX spec does not seem to support an exponential post transform function](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/core/providers/cpu/ml/ml_common.h). So we would need to add this to the `onnxruntime` first.\r\n- Next, we would need to update the [docstring in `onnx`](https://github.com/janjagusch/onnx/blob/master/onnx/defs/traditionalml/defs.cc#L1104-L1108) to indicate that 'EXPONENTIAL' is a valid post transform identifier.\r\n- Then we would need to bump the versions here and add the new objective.","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836695395/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836764965","html_url":"https://github.com/onnx/onnxmltools/issues/462#issuecomment-836764965","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/462","id":836764965,"node_id":"MDEyOklzc3VlQ29tbWVudDgzNjc2NDk2NQ==","user":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"created_at":"2021-05-10T14:24:44Z","updated_at":"2021-05-10T14:24:44Z","author_association":"CONTRIBUTOR","body":"I found a workaround for this issue:\r\n\r\n- Fitting the model with `objective='poisson'`\r\n- Changing the model objective post fit to `'regression'` (this requires a monkey patch)\r\n- Serialising the model\r\n- Wrapping the exponential transform function around the predictions, using Python\r\n\r\nThe results of the prediction using ONNX are equivalent to the LightGMB predictions up to 6 decimal places.\r\n\r\n```py\r\nimport numpy as np\r\nimport onnxruntime as rt\r\nfrom lightgbm.sklearn import LGBMRegressor\r\nfrom onnxmltools import convert_lightgbm\r\nfrom skl2onnx.common.data_types import FloatTensorType\r\n\r\nN_ROWS = 1000\r\nN_COLS = 4\r\n\r\nX = np.random.randn(N_ROWS, N_COLS)\r\n# For 'poisson' objective, all target values need to be non-negative\r\ny = abs(np.random.randn(N_ROWS))\r\n\r\nestimator = LGBMRegressor(objective=\"poisson\")\r\nestimator.fit(X, y)\r\n\r\npred_sklearn = estimator.predict(X)\r\n\r\n\r\n# Monkey patching lightgbm.basic.Booster.dump_model\r\n# to overwrite the objetive to 'regression', if the\r\n# actual objective is 'poisson'.\r\nimport lightgbm.basic\r\nfrom lightgbm.basic import Booster as Booster\r\n\r\nlightgbm.basic.Booster._dump_model = lightgbm.basic.Booster.dump_model\r\n\r\n\r\ndef dump_model(\r\n    self, num_iteration=None, start_iteration=0, importance_type=\"split\"\r\n):\r\n    result = Booster._dump_model(\r\n        self,\r\n        num_iteration=num_iteration,\r\n        start_iteration=start_iteration,\r\n        importance_type=importance_type,\r\n    )\r\n    if result[\"objective\"] == \"poisson\":\r\n        result[\"objective\"] = \"regression\"\r\n    return result\r\n\r\n\r\nlightgbm.basic.Booster.dump_model = dump_model\r\n\r\ninitial_types = [(\"float_input\", FloatTensorType([None, N_COLS]))]\r\nonnx_model = convert_lightgbm(\r\n    model=estimator, name=\"Poisson Estimator\", initial_types=initial_types\r\n)\r\n\r\nsess = rt.InferenceSession(onnx_model.SerializeToString())\r\ninput_name = sess.get_inputs()[0].name\r\nlabel_name = sess.get_outputs()[0].name\r\n\r\npred_onnx = sess.run([label_name], {input_name: X.astype(np.float32)})[0][:, 0]\r\n\r\nnp.testing.assert_almost_equal(np.exp(pred_onnx), pred_sklearn, decimal=6)\r\n```","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836764965/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836852722","html_url":"https://github.com/onnx/onnxmltools/issues/462#issuecomment-836852722","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/462","id":836852722,"node_id":"MDEyOklzc3VlQ29tbWVudDgzNjg1MjcyMg==","user":{"login":"xhochy","id":70274,"node_id":"MDQ6VXNlcjcwMjc0","avatar_url":"https://avatars.githubusercontent.com/u/70274?v=4","gravatar_id":"","url":"https://api.github.com/users/xhochy","html_url":"https://github.com/xhochy","followers_url":"https://api.github.com/users/xhochy/followers","following_url":"https://api.github.com/users/xhochy/following{/other_user}","gists_url":"https://api.github.com/users/xhochy/gists{/gist_id}","starred_url":"https://api.github.com/users/xhochy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xhochy/subscriptions","organizations_url":"https://api.github.com/users/xhochy/orgs","repos_url":"https://api.github.com/users/xhochy/repos","events_url":"https://api.github.com/users/xhochy/events{/privacy}","received_events_url":"https://api.github.com/users/xhochy/received_events","type":"User","site_admin":false},"created_at":"2021-05-10T15:38:32Z","updated_at":"2021-05-10T15:38:32Z","author_association":"CONTRIBUTOR","body":"@janjagusch I guess it is much more reliable in your workaround case if you add an `Exp` operation at the end of your generated `onnx_model` instead of doing a manual post-process. That way you would have a portable ONNX model export again.","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/836852722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"xhochy","id":70274,"node_id":"MDQ6VXNlcjcwMjc0","avatar_url":"https://avatars.githubusercontent.com/u/70274?v=4","gravatar_id":"","url":"https://api.github.com/users/xhochy","html_url":"https://github.com/xhochy","followers_url":"https://api.github.com/users/xhochy/followers","following_url":"https://api.github.com/users/xhochy/following{/other_user}","gists_url":"https://api.github.com/users/xhochy/gists{/gist_id}","starred_url":"https://api.github.com/users/xhochy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xhochy/subscriptions","organizations_url":"https://api.github.com/users/xhochy/orgs","repos_url":"https://api.github.com/users/xhochy/repos","events_url":"https://api.github.com/users/xhochy/events{/privacy}","received_events_url":"https://api.github.com/users/xhochy/received_events","type":"User","site_admin":false}},{"id":4718197167,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50NDcxODE5NzE2Nw==","url":"https://api.github.com/repos/onnx/onnxmltools/issues/events/4718197167","actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-05-10T15:38:32Z","performed_via_github_app":null},{"id":4718197176,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDQ3MTgxOTcxNzY=","url":"https://api.github.com/repos/onnx/onnxmltools/issues/events/4718197176","actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-05-10T15:38:32Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/838087441","html_url":"https://github.com/onnx/onnxmltools/issues/462#issuecomment-838087441","issue_url":"https://api.github.com/repos/onnx/onnxmltools/issues/462","id":838087441,"node_id":"MDEyOklzc3VlQ29tbWVudDgzODA4NzQ0MQ==","user":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"created_at":"2021-05-11T08:43:33Z","updated_at":"2021-05-11T08:43:33Z","author_association":"CONTRIBUTOR","body":"Nice idea, @xhochy! I have added an exponential post transform node to the model graph and have changed the model output to point to the output of the post transform node:\r\n\r\n```py\r\nimport lightgbm.basic\r\nimport numpy as np\r\nimport onnx\r\nimport onnxruntime as rt\r\nfrom lightgbm.basic import Booster as Booster\r\nfrom lightgbm.sklearn import LGBMRegressor\r\nfrom onnxmltools import convert_lightgbm\r\nfrom skl2onnx.common.data_types import FloatTensorType\r\n\r\nN_ROWS = 1000\r\nN_COLS = 4\r\n\r\nX = np.random.randn(N_ROWS, N_COLS)\r\n# For 'poisson' objective, all target values need to be non-negative\r\ny = abs(np.random.randn(N_ROWS))\r\n\r\nestimator = LGBMRegressor(objective=\"poisson\")\r\nestimator.fit(X, y)\r\n\r\npred_sklearn = estimator.predict(X)\r\n\r\n\r\n# Monkey patching lightgbm.basic.Booster.dump_model\r\n# to overwrite the objetive to 'regression', if the\r\n# actual objective is 'poisson'.\r\nlightgbm.basic.Booster._dump_model = lightgbm.basic.Booster.dump_model\r\n\r\n\r\ndef dump_model(\r\n    self, num_iteration=None, start_iteration=0, importance_type=\"split\"\r\n):  # noqa: D103\r\n    result = Booster._dump_model(\r\n        self,\r\n        num_iteration=num_iteration,\r\n        start_iteration=start_iteration,\r\n        importance_type=importance_type,\r\n    )\r\n    if result[\"objective\"] == \"poisson\":\r\n        result[\"objective\"] = \"regression\"\r\n    return result\r\n\r\n\r\nlightgbm.basic.Booster.dump_model = dump_model\r\n\r\ninitial_types = [(\"float_input\", FloatTensorType([None, N_COLS]))]\r\nonnx_model = convert_lightgbm(\r\n    model=estimator, name=\"Poisson Estimator\", initial_types=initial_types\r\n)\r\n\r\n# Adding a node to the graph that applies the\r\n# exponential post transform function.\r\n# Changing the graph output to the output of\r\n# the new post transform node.\r\noutput_name = onnx_model.graph.output[0].name\r\nnew_output_name = f\"exp_{output_name}\"\r\n\r\nexp_node = onnx.helper.make_node(\"Exp\", inputs=[output_name], outputs=[new_output_name])\r\nonnx_model.graph.node.append(exp_node)\r\nonnx_model.graph.output[0].name = new_output_name\r\n\r\nsess = rt.InferenceSession(onnx_model.SerializeToString())\r\ninput_name = sess.get_inputs()[0].name\r\nlabel_name = sess.get_outputs()[0].name\r\n\r\npred_onnx = sess.run([label_name], {input_name: X.astype(np.float32)})[0][:, 0]\r\n\r\nnp.testing.assert_almost_equal(pred_onnx, pred_sklearn, decimal=6)\r\n```","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments/838087441/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false}},{"id":4724975188,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50NDcyNDk3NTE4OA==","url":"https://api.github.com/repos/onnx/onnxmltools/issues/events/4724975188","actor":{"login":"xhochy","id":70274,"node_id":"MDQ6VXNlcjcwMjc0","avatar_url":"https://avatars.githubusercontent.com/u/70274?v=4","gravatar_id":"","url":"https://api.github.com/users/xhochy","html_url":"https://github.com/xhochy","followers_url":"https://api.github.com/users/xhochy/followers","following_url":"https://api.github.com/users/xhochy/following{/other_user}","gists_url":"https://api.github.com/users/xhochy/gists{/gist_id}","starred_url":"https://api.github.com/users/xhochy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xhochy/subscriptions","organizations_url":"https://api.github.com/users/xhochy/orgs","repos_url":"https://api.github.com/users/xhochy/repos","events_url":"https://api.github.com/users/xhochy/events{/privacy}","received_events_url":"https://api.github.com/users/xhochy/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-05-11T08:43:33Z","performed_via_github_app":null},{"id":4724975199,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDQ3MjQ5NzUxOTk=","url":"https://api.github.com/repos/onnx/onnxmltools/issues/events/4724975199","actor":{"login":"xhochy","id":70274,"node_id":"MDQ6VXNlcjcwMjc0","avatar_url":"https://avatars.githubusercontent.com/u/70274?v=4","gravatar_id":"","url":"https://api.github.com/users/xhochy","html_url":"https://github.com/xhochy","followers_url":"https://api.github.com/users/xhochy/followers","following_url":"https://api.github.com/users/xhochy/following{/other_user}","gists_url":"https://api.github.com/users/xhochy/gists{/gist_id}","starred_url":"https://api.github.com/users/xhochy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xhochy/subscriptions","organizations_url":"https://api.github.com/users/xhochy/orgs","repos_url":"https://api.github.com/users/xhochy/repos","events_url":"https://api.github.com/users/xhochy/events{/privacy}","received_events_url":"https://api.github.com/users/xhochy/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-05-11T08:43:33Z","performed_via_github_app":null},{"actor":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"created_at":"2021-05-11T09:37:33Z","updated_at":"2021-05-11T09:37:33Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/463","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/463/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/463/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/463/events","html_url":"https://github.com/onnx/onnxmltools/pull/463","id":886664803,"node_id":"MDExOlB1bGxSZXF1ZXN0NjM5OTM0MzU3","number":463,"title":"Allow to add custom post transform functions that are not supported by the ONNX spec yet","user":{"login":"janjagusch","id":25852654,"node_id":"MDQ6VXNlcjI1ODUyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/25852654?v=4","gravatar_id":"","url":"https://api.github.com/users/janjagusch","html_url":"https://github.com/janjagusch","followers_url":"https://api.github.com/users/janjagusch/followers","following_url":"https://api.github.com/users/janjagusch/following{/other_user}","gists_url":"https://api.github.com/users/janjagusch/gists{/gist_id}","starred_url":"https://api.github.com/users/janjagusch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janjagusch/subscriptions","organizations_url":"https://api.github.com/users/janjagusch/orgs","repos_url":"https://api.github.com/users/janjagusch/repos","events_url":"https://api.github.com/users/janjagusch/events{/privacy}","received_events_url":"https://api.github.com/users/janjagusch/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-05-11T09:37:33Z","updated_at":"2021-05-21T09:21:54Z","closed_at":"2021-05-20T16:37:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"draft":false,"repository":{"id":121798175,"node_id":"MDEwOlJlcG9zaXRvcnkxMjE3OTgxNzU=","name":"onnxmltools","full_name":"onnx/onnxmltools","private":false,"owner":{"login":"onnx","id":31675368,"node_id":"MDEyOk9yZ2FuaXphdGlvbjMxNjc1MzY4","avatar_url":"https://avatars.githubusercontent.com/u/31675368?v=4","gravatar_id":"","url":"https://api.github.com/users/onnx","html_url":"https://github.com/onnx","followers_url":"https://api.github.com/users/onnx/followers","following_url":"https://api.github.com/users/onnx/following{/other_user}","gists_url":"https://api.github.com/users/onnx/gists{/gist_id}","starred_url":"https://api.github.com/users/onnx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/onnx/subscriptions","organizations_url":"https://api.github.com/users/onnx/orgs","repos_url":"https://api.github.com/users/onnx/repos","events_url":"https://api.github.com/users/onnx/events{/privacy}","received_events_url":"https://api.github.com/users/onnx/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/onnx/onnxmltools","description":"ONNXMLTools enables conversion of models to ONNX","fork":false,"url":"https://api.github.com/repos/onnx/onnxmltools","forks_url":"https://api.github.com/repos/onnx/onnxmltools/forks","keys_url":"https://api.github.com/repos/onnx/onnxmltools/keys{/key_id}","collaborators_url":"https://api.github.com/repos/onnx/onnxmltools/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/onnx/onnxmltools/teams","hooks_url":"https://api.github.com/repos/onnx/onnxmltools/hooks","issue_events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/events{/number}","events_url":"https://api.github.com/repos/onnx/onnxmltools/events","assignees_url":"https://api.github.com/repos/onnx/onnxmltools/assignees{/user}","branches_url":"https://api.github.com/repos/onnx/onnxmltools/branches{/branch}","tags_url":"https://api.github.com/repos/onnx/onnxmltools/tags","blobs_url":"https://api.github.com/repos/onnx/onnxmltools/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/onnx/onnxmltools/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/onnx/onnxmltools/git/refs{/sha}","trees_url":"https://api.github.com/repos/onnx/onnxmltools/git/trees{/sha}","statuses_url":"https://api.github.com/repos/onnx/onnxmltools/statuses/{sha}","languages_url":"https://api.github.com/repos/onnx/onnxmltools/languages","stargazers_url":"https://api.github.com/repos/onnx/onnxmltools/stargazers","contributors_url":"https://api.github.com/repos/onnx/onnxmltools/contributors","subscribers_url":"https://api.github.com/repos/onnx/onnxmltools/subscribers","subscription_url":"https://api.github.com/repos/onnx/onnxmltools/subscription","commits_url":"https://api.github.com/repos/onnx/onnxmltools/commits{/sha}","git_commits_url":"https://api.github.com/repos/onnx/onnxmltools/git/commits{/sha}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/comments{/number}","issue_comment_url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments{/number}","contents_url":"https://api.github.com/repos/onnx/onnxmltools/contents/{+path}","compare_url":"https://api.github.com/repos/onnx/onnxmltools/compare/{base}...{head}","merges_url":"https://api.github.com/repos/onnx/onnxmltools/merges","archive_url":"https://api.github.com/repos/onnx/onnxmltools/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/onnx/onnxmltools/downloads","issues_url":"https://api.github.com/repos/onnx/onnxmltools/issues{/number}","pulls_url":"https://api.github.com/repos/onnx/onnxmltools/pulls{/number}","milestones_url":"https://api.github.com/repos/onnx/onnxmltools/milestones{/number}","notifications_url":"https://api.github.com/repos/onnx/onnxmltools/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/onnx/onnxmltools/labels{/name}","releases_url":"https://api.github.com/repos/onnx/onnxmltools/releases{/id}","deployments_url":"https://api.github.com/repos/onnx/onnxmltools/deployments","created_at":"2018-02-16T20:37:33Z","updated_at":"2023-01-18T07:05:25Z","pushed_at":"2023-01-18T18:13:14Z","git_url":"git://github.com/onnx/onnxmltools.git","ssh_url":"git@github.com:onnx/onnxmltools.git","clone_url":"https://github.com/onnx/onnxmltools.git","svn_url":"https://github.com/onnx/onnxmltools","homepage":"https://onnx.ai","size":3395,"stargazers_count":720,"watchers_count":720,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":false,"forks_count":161,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":104,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["keras","machine-learning","onnx","python-library","scikit-learn"],"visibility":"public","forks":161,"open_issues":104,"watchers":720,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/onnx/onnxmltools/pulls/463","html_url":"https://github.com/onnx/onnxmltools/pull/463","diff_url":"https://github.com/onnx/onnxmltools/pull/463.diff","patch_url":"https://github.com/onnx/onnxmltools/pull/463.patch","merged_at":"2021-05-20T16:37:13Z"},"body":"Closes #462 \r\n\r\nI have already added support for `objective='poisson'`, but I believe this PR also allows to easily add support for `objective='tweedie'` and `objective='gamma'`.\r\n\r\nUltimately, it would be useful to have \"EXPONENTIAL\" as a supported value in `attrs['post_transform']`, such that we don't have to handle this special case here. However, that seems to involve quite some changes in `onxx`/`onnxruntime`. If anybody knows how to move these changes upstream, that would be very appreciated.\r\n\r\nWhat this PR is still missing is tests. I have tested this locally, asserting that the predictions of the LightGMB model and the ONNX model are equivalent. I don't see an easy way to add this to your test suite, though. Some advice on this would be great.","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/463/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/463/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":4774607476,"node_id":"MDExOkNsb3NlZEV2ZW50NDc3NDYwNzQ3Ng==","url":"https://api.github.com/repos/onnx/onnxmltools/issues/events/4774607476","actor":{"login":"wenbingl","id":10278425,"node_id":"MDQ6VXNlcjEwMjc4NDI1","avatar_url":"https://avatars.githubusercontent.com/u/10278425?v=4","gravatar_id":"","url":"https://api.github.com/users/wenbingl","html_url":"https://github.com/wenbingl","followers_url":"https://api.github.com/users/wenbingl/followers","following_url":"https://api.github.com/users/wenbingl/following{/other_user}","gists_url":"https://api.github.com/users/wenbingl/gists{/gist_id}","starred_url":"https://api.github.com/users/wenbingl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenbingl/subscriptions","organizations_url":"https://api.github.com/users/wenbingl/orgs","repos_url":"https://api.github.com/users/wenbingl/repos","events_url":"https://api.github.com/users/wenbingl/events{/privacy}","received_events_url":"https://api.github.com/users/wenbingl/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-05-20T16:37:13Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"brunovilar","id":629703,"node_id":"MDQ6VXNlcjYyOTcwMw==","avatar_url":"https://avatars.githubusercontent.com/u/629703?v=4","gravatar_id":"","url":"https://api.github.com/users/brunovilar","html_url":"https://github.com/brunovilar","followers_url":"https://api.github.com/users/brunovilar/followers","following_url":"https://api.github.com/users/brunovilar/following{/other_user}","gists_url":"https://api.github.com/users/brunovilar/gists{/gist_id}","starred_url":"https://api.github.com/users/brunovilar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brunovilar/subscriptions","organizations_url":"https://api.github.com/users/brunovilar/orgs","repos_url":"https://api.github.com/users/brunovilar/repos","events_url":"https://api.github.com/users/brunovilar/events{/privacy}","received_events_url":"https://api.github.com/users/brunovilar/received_events","type":"User","site_admin":false},"created_at":"2021-10-03T13:05:20Z","updated_at":"2021-10-03T13:05:20Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/504","repository_url":"https://api.github.com/repos/onnx/onnxmltools","labels_url":"https://api.github.com/repos/onnx/onnxmltools/issues/504/labels{/name}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/issues/504/comments","events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/504/events","html_url":"https://github.com/onnx/onnxmltools/issues/504","id":1014387814,"node_id":"I_kwDOB0J-H848dlRm","number":504,"title":"Unsupported objective 'quantile' for LGBMRegressor ","user":{"login":"brunovilar","id":629703,"node_id":"MDQ6VXNlcjYyOTcwMw==","avatar_url":"https://avatars.githubusercontent.com/u/629703?v=4","gravatar_id":"","url":"https://api.github.com/users/brunovilar","html_url":"https://github.com/brunovilar","followers_url":"https://api.github.com/users/brunovilar/followers","following_url":"https://api.github.com/users/brunovilar/following{/other_user}","gists_url":"https://api.github.com/users/brunovilar/gists{/gist_id}","starred_url":"https://api.github.com/users/brunovilar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brunovilar/subscriptions","organizations_url":"https://api.github.com/users/brunovilar/orgs","repos_url":"https://api.github.com/users/brunovilar/repos","events_url":"https://api.github.com/users/brunovilar/events{/privacy}","received_events_url":"https://api.github.com/users/brunovilar/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-10-03T13:05:20Z","updated_at":"2021-10-04T11:41:29Z","closed_at":"2021-10-04T11:41:28Z","author_association":"NONE","active_lock_reason":null,"repository":{"id":121798175,"node_id":"MDEwOlJlcG9zaXRvcnkxMjE3OTgxNzU=","name":"onnxmltools","full_name":"onnx/onnxmltools","private":false,"owner":{"login":"onnx","id":31675368,"node_id":"MDEyOk9yZ2FuaXphdGlvbjMxNjc1MzY4","avatar_url":"https://avatars.githubusercontent.com/u/31675368?v=4","gravatar_id":"","url":"https://api.github.com/users/onnx","html_url":"https://github.com/onnx","followers_url":"https://api.github.com/users/onnx/followers","following_url":"https://api.github.com/users/onnx/following{/other_user}","gists_url":"https://api.github.com/users/onnx/gists{/gist_id}","starred_url":"https://api.github.com/users/onnx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/onnx/subscriptions","organizations_url":"https://api.github.com/users/onnx/orgs","repos_url":"https://api.github.com/users/onnx/repos","events_url":"https://api.github.com/users/onnx/events{/privacy}","received_events_url":"https://api.github.com/users/onnx/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/onnx/onnxmltools","description":"ONNXMLTools enables conversion of models to ONNX","fork":false,"url":"https://api.github.com/repos/onnx/onnxmltools","forks_url":"https://api.github.com/repos/onnx/onnxmltools/forks","keys_url":"https://api.github.com/repos/onnx/onnxmltools/keys{/key_id}","collaborators_url":"https://api.github.com/repos/onnx/onnxmltools/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/onnx/onnxmltools/teams","hooks_url":"https://api.github.com/repos/onnx/onnxmltools/hooks","issue_events_url":"https://api.github.com/repos/onnx/onnxmltools/issues/events{/number}","events_url":"https://api.github.com/repos/onnx/onnxmltools/events","assignees_url":"https://api.github.com/repos/onnx/onnxmltools/assignees{/user}","branches_url":"https://api.github.com/repos/onnx/onnxmltools/branches{/branch}","tags_url":"https://api.github.com/repos/onnx/onnxmltools/tags","blobs_url":"https://api.github.com/repos/onnx/onnxmltools/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/onnx/onnxmltools/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/onnx/onnxmltools/git/refs{/sha}","trees_url":"https://api.github.com/repos/onnx/onnxmltools/git/trees{/sha}","statuses_url":"https://api.github.com/repos/onnx/onnxmltools/statuses/{sha}","languages_url":"https://api.github.com/repos/onnx/onnxmltools/languages","stargazers_url":"https://api.github.com/repos/onnx/onnxmltools/stargazers","contributors_url":"https://api.github.com/repos/onnx/onnxmltools/contributors","subscribers_url":"https://api.github.com/repos/onnx/onnxmltools/subscribers","subscription_url":"https://api.github.com/repos/onnx/onnxmltools/subscription","commits_url":"https://api.github.com/repos/onnx/onnxmltools/commits{/sha}","git_commits_url":"https://api.github.com/repos/onnx/onnxmltools/git/commits{/sha}","comments_url":"https://api.github.com/repos/onnx/onnxmltools/comments{/number}","issue_comment_url":"https://api.github.com/repos/onnx/onnxmltools/issues/comments{/number}","contents_url":"https://api.github.com/repos/onnx/onnxmltools/contents/{+path}","compare_url":"https://api.github.com/repos/onnx/onnxmltools/compare/{base}...{head}","merges_url":"https://api.github.com/repos/onnx/onnxmltools/merges","archive_url":"https://api.github.com/repos/onnx/onnxmltools/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/onnx/onnxmltools/downloads","issues_url":"https://api.github.com/repos/onnx/onnxmltools/issues{/number}","pulls_url":"https://api.github.com/repos/onnx/onnxmltools/pulls{/number}","milestones_url":"https://api.github.com/repos/onnx/onnxmltools/milestones{/number}","notifications_url":"https://api.github.com/repos/onnx/onnxmltools/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/onnx/onnxmltools/labels{/name}","releases_url":"https://api.github.com/repos/onnx/onnxmltools/releases{/id}","deployments_url":"https://api.github.com/repos/onnx/onnxmltools/deployments","created_at":"2018-02-16T20:37:33Z","updated_at":"2023-01-18T07:05:25Z","pushed_at":"2023-01-18T18:13:14Z","git_url":"git://github.com/onnx/onnxmltools.git","ssh_url":"git@github.com:onnx/onnxmltools.git","clone_url":"https://github.com/onnx/onnxmltools.git","svn_url":"https://github.com/onnx/onnxmltools","homepage":"https://onnx.ai","size":3395,"stargazers_count":720,"watchers_count":720,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":false,"forks_count":161,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":104,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["keras","machine-learning","onnx","python-library","scikit-learn"],"visibility":"public","forks":161,"open_issues":104,"watchers":720,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Issue description\r\n\r\nWhen trying to run `onnxmltools.convert_lightgbm` on a `lightgbm.sklearn.LGBMRegressor` model with `objective='poisson'`, the conversion fails with a RuntimeError.\r\n\r\n### Open PR\r\nThis is an update. O just saw [this pull request](https://github.com/onnx/onnxmltools/pull/503). By directly applying the change it works properly. I would really recommend approving and merge the PR. :) \r\n\r\n### Similar closed issue\r\n\r\nThis problem seems to be similar to [this one](https://github.com/onnx/onnxmltools/issues/462), reported by @janjagusch. I could not reproduce the workaround for the original (poisson) problem.\r\n\r\n### Reproducible example\r\n\r\n```\r\nimport numpy as np\r\nfrom lightgbm.sklearn import LGBMRegressor\r\nfrom onnxmltools import convert_lightgbm\r\nfrom skl2onnx.common.data_types import FloatTensorType\r\n\r\nexamples = 1000\r\nfeatures = 10\r\n\r\nX = np.random.randn(examples, features)\r\ny = np.round(np.random.randn(examples), 0)\r\n\r\nmodel = LGBMRegressor(objective=\"quantile\", metric=\"quantile\", alpha=0.05)\r\nmodel.fit(X, y)\r\n\r\ninitial_types = [(\"float_input\", FloatTensorType([None, features]))]\r\nonnx_model = convert_lightgbm(model, initial_types=initial_types)\r\n```\r\n\r\nResults in the following error:\r\n```\r\n---------------------------------------------------------------------------\r\nRuntimeError                              Traceback (most recent call last)\r\n/tmp/ipykernel_33543/973951346.py in <module>\r\n     14 \r\n     15 initial_types = [(\"float_input\", FloatTensorType([None, features]))]\r\n---> 16 onnx_model = convert_lightgbm(model, initial_types=initial_types)\r\n\r\n/media/bruno/dados/dev/virtual_envs/generic_env/lib/python3.9/site-packages/onnxmltools/convert/main.py in convert_lightgbm(model, name, initial_types, doc_string, target_opset, targeted_onnx, custom_conversion_functions, custom_shape_calculators, without_onnx_ml, zipmap)\r\n    134 \r\n    135     from .lightgbm.convert import convert\r\n--> 136     return convert(model, name, initial_types, doc_string, target_opset, targeted_onnx,\r\n    137                    custom_conversion_functions, custom_shape_calculators, without_onnx_ml,\r\n    138                    zipmap=zipmap)\r\n\r\n/media/bruno/dados/dev/virtual_envs/generic_env/lib/python3.9/site-packages/onnxmltools/convert/lightgbm/convert.py in convert(model, name, initial_types, doc_string, target_opset, targeted_onnx, custom_conversion_functions, custom_shape_calculators, without_onnx_ml, zipmap)\r\n     54                               custom_shape_calculators, zipmap=zipmap)\r\n     55     topology.compile()\r\n---> 56     onnx_ml_model = convert_topology(topology, name, doc_string, target_opset, targeted_onnx)\r\n     57 \r\n     58     if without_onnx_ml:\r\n\r\n/media/bruno/dados/dev/virtual_envs/generic_env/lib/python3.9/site-packages/onnxconverter_common/topology.py in convert_topology(topology, model_name, doc_string, target_opset, targeted_onnx, channel_first_inputs)\r\n    774         else:\r\n    775             # Convert the selected operator into some ONNX objects and save them into the container\r\n--> 776             get_converter(operator.type)(scope, operator, container)\r\n    777 \r\n    778     # When calling ModelComponentContainer's add_initializer(...), nothing is added into the input list.\r\n\r\n/media/bruno/dados/dev/virtual_envs/generic_env/lib/python3.9/site-packages/onnxmltools/convert/lightgbm/operator_converters/LightGbm.py in convert_lightgbm(scope, operator, container)\r\n    398         post_transform = \"Exp\"\r\n    399     else:\r\n--> 400         raise RuntimeError(\r\n    401             \"LightGBM objective should be cleaned already not '{}'.\".format(\r\n    402                 gbm_text['objective']))\r\n\r\nRuntimeError: LightGBM objective should be cleaned already not 'quantile'.\r\n```\r\n\r\n### Versions\r\n```\r\nnumpy==1.21.1\r\nlightgbm==3.2.1\r\nonnxmltools==1.9.1\r\nskl2onnx==1.10.0\r\n```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/onnx/onnxmltools/issues/504/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/onnxmltools/issues/504/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]