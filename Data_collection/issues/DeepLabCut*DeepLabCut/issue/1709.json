{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/1709","id":1154455450,"node_id":"I_kwDOB5BM6c5Ez5ea","number":1709,"title":"3D analysis failing at triangulate, likely calibration errors (check_undistorted weird). But corners correctly detected.","user":{"login":"juliencarponcy","id":41296546,"node_id":"MDQ6VXNlcjQxMjk2NTQ2","avatar_url":"https://avatars.githubusercontent.com/u/41296546?v=4","gravatar_id":"","url":"https://api.github.com/users/juliencarponcy","html_url":"https://github.com/juliencarponcy","followers_url":"https://api.github.com/users/juliencarponcy/followers","following_url":"https://api.github.com/users/juliencarponcy/following{/other_user}","gists_url":"https://api.github.com/users/juliencarponcy/gists{/gist_id}","starred_url":"https://api.github.com/users/juliencarponcy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juliencarponcy/subscriptions","organizations_url":"https://api.github.com/users/juliencarponcy/orgs","repos_url":"https://api.github.com/users/juliencarponcy/repos","events_url":"https://api.github.com/users/juliencarponcy/events{/privacy}","received_events_url":"https://api.github.com/users/juliencarponcy/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-02-28T19:16:46Z","updated_at":"2022-11-03T07:29:41Z","closed_at":"2022-03-08T11:46:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Bug description\r\n\r\nThe code is failing at the triangulate level, after sucessfully analyzing both 2D vids.\r\n\r\nI nevertheless think that the problem is in the calibration. Corners are detected fine and I curated the folder to leave only the images where the corneres are detected from both angles. Detection looks fine, but check_undistortion gives very weird outputs.\r\nI have one camera on the side, and one in front-down to the mice. You can see the other objectives on the example corner image below.\r\n\r\n![image](https://user-images.githubusercontent.com/41296546/156042085-bb293d33-c9af-4697-8826-b2c1bae98774.png)\r\n\r\nI have this weird outputs of the check undistortion.\r\n\r\n![image](https://user-images.githubusercontent.com/41296546/156042201-94979386-120d-4f46-a581-2a04f767a434.png)\r\n\r\nI run on the notebook the following lines:\r\n\r\n```\r\nconfig_path3d = deeplabcut.create_new_project_3d('2cam_Rig2','julien',num_cameras = 2)\r\ndeeplabcut.calibrate_cameras(config_path3d, cbrow=4, cbcol=6, calibrate=False, alpha=0.9)\r\n```\r\nthen\r\n```\r\ndeeplabcut.calibrate_cameras(config_path3d, cbrow=4, cbcol=6, calibrate=True, alpha=0.9)\r\n```\r\nThis gave the dodgy outputs (No ref present in the docs, might be good to add what is expected after this stage)\r\n```\r\ndeeplabcut.check_undistortion(config_path3d, cbrow=4, cbcol=6)\r\n```\r\n```\r\nvideo_path = '/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored'\r\ndeeplabcut.triangulate(config_path3d, video_path, videotype='mp4', filterpredictions=False)\r\n```\r\n\r\nand I got the resulting error message (inserted below in dedicated section)\r\n\r\n\r\n### Operating System\r\n\r\nUbuntu 20.04 LTS\r\n\r\n### DeepLabCut version\r\n\r\ndlc version 2.2.0.6\r\n\r\n### DeepLabCut mode\r\n\r\n3d\r\n\r\n### Device type\r\n\r\nNvidia RTX 3090\r\n\r\n### Steps To Reproduce\r\n\r\nAll 3 configs in the .zip file:\r\n[ConfigsDLC.zip](https://github.com/DeepLabCut/DeepLabCut/files/8155988/ConfigsDLC.zip)\r\n\r\nFolder screenshot:\r\n![image](https://user-images.githubusercontent.com/41296546/156044962-04e7a1d2-f42e-41ad-8601-59e338635d58.png)\r\n\r\n\r\n1. With the supplied conda environment,\r\n2. on a notebook\r\n3. I have previously extracted frames with ffmpeg and only selected the ones with full checkckerboard on both cams\r\n4. did the calibrate cameras without calibration, \r\n5. checked and curated the resulting corners files\r\n6. run again with calibration True\r\n7. executed Triangulate, \r\n8. Failed with below error message after sucessfully analyzing both 2D vids.\r\n\r\n### Relevant log output\r\n\r\n```shell\r\nList of pairs: [['/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-1.mp4', '/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-2.mp4']]\r\nAnalyzing video /home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-1.mp4 using config_file_camera-1\r\nUsing snapshot-1200000 for model /home/MRC.OX.AC.UK/phar0732/ettin/Models/down-julien-2022-02-23/dlc-models/iteration-0/downFeb23-trainset95shuffle1\r\n\r\n2022-02-28 18:21:37.266604: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1733] Found device 0 with properties: \r\npciBusID: 0000:01:00.0 name: NVIDIA GeForce RTX 3090 computeCapability: 8.6\r\ncoreClock: 1.695GHz coreCount: 82 deviceMemorySize: 23.70GiB deviceMemoryBandwidth: 871.81GiB/s\r\n2022-02-28 18:21:37.267686: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1733] Found device 1 with properties: \r\npciBusID: 0000:81:00.0 name: NVIDIA GeForce RTX 3090 computeCapability: 8.6\r\ncoreClock: 1.695GHz coreCount: 82 deviceMemorySize: 23.70GiB deviceMemoryBandwidth: 871.81GiB/s\r\n2022-02-28 18:21:37.270469: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1871] Adding visible gpu devices: 0, 1\r\n2022-02-28 18:21:37.270553: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1258] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2022-02-28 18:21:37.270559: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1264]      0 1 \r\n2022-02-28 18:21:37.270563: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1277] 0:   N N \r\n2022-02-28 18:21:37.270566: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1277] 1:   N N \r\n2022-02-28 18:21:37.272459: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1418] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21481 MB memory) -> physical GPU (device: 0, name: NVIDIA GeForce RTX 3090, pci bus id: 0000:01:00.0, compute capability: 8.6)\r\n2022-02-28 18:21:37.273674: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1418] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 22312 MB memory) -> physical GPU (device: 1, name: NVIDIA GeForce RTX 3090, pci bus id: 0000:81:00.0, compute capability: 8.6)\r\n\r\nStarting to analyze %  /home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-1.mp4\r\nThe videos are analyzed. Now your research can truly start! \r\n You can create labeled videos with 'create_labeled_video'\r\nIf the tracking is not satisfactory for some videos, consider expanding the training set. You can use the function 'extract_outlier_frames' to extract a few representative outlier frames.\r\n/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-1 DLC_resnet50_downFeb23shuffle1_1200000\r\nAnalyzing video /home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-2.mp4 using config_file_camera-2\r\nUsing snapshot-1030000 for model /home/MRC.OX.AC.UK/phar0732/ettin/Models/side_2_hands-julien-2022-01-05/dlc-models/iteration-1/side_2_handsJan5-trainset95shuffle1\r\n\r\n2022-02-28 18:21:40.720525: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1733] Found device 0 with properties: \r\npciBusID: 0000:01:00.0 name: NVIDIA GeForce RTX 3090 computeCapability: 8.6\r\ncoreClock: 1.695GHz coreCount: 82 deviceMemorySize: 23.70GiB deviceMemoryBandwidth: 871.81GiB/s\r\n2022-02-28 18:21:40.721540: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1733] Found device 1 with properties: \r\npciBusID: 0000:81:00.0 name: NVIDIA GeForce RTX 3090 computeCapability: 8.6\r\ncoreClock: 1.695GHz coreCount: 82 deviceMemorySize: 23.70GiB deviceMemoryBandwidth: 871.81GiB/s\r\n2022-02-28 18:21:40.724212: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1871] Adding visible gpu devices: 0, 1\r\n2022-02-28 18:21:40.724265: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1258] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2022-02-28 18:21:40.724270: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1264]      0 1 \r\n2022-02-28 18:21:40.724274: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1277] 0:   N N \r\n2022-02-28 18:21:40.724277: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1277] 1:   N N \r\n2022-02-28 18:21:40.726074: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1418] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21481 MB memory) -> physical GPU (device: 0, name: NVIDIA GeForce RTX 3090, pci bus id: 0000:01:00.0, compute capability: 8.6)\r\n2022-02-28 18:21:40.727195: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1418] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 22312 MB memory) -> physical GPU (device: 1, name: NVIDIA GeForce RTX 3090, pci bus id: 0000:81:00.0, compute capability: 8.6)\r\n\r\nStarting to analyze %  /home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored/JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-2.mp4\r\nThe videos are analyzed. Now your research can truly start! \r\n You can create labeled videos with 'create_labeled_video'\r\nIf the tracking is not satisfactory for some videos, consider expanding the training set. You can use the function 'extract_outlier_frames' to extract a few representative outlier frames.\r\n/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored JC282LS_2021-11-18_11-41-13.000_Rig_1_camera-2 DLC_resnet50_side_2_handsJan5shuffle1_1030000\r\nUndistorting...\r\n\r\n---------------------------------------------------------------------------\r\nIndexError                                Traceback (most recent call last)\r\n/tmp/ipykernel_2980235/1195822122.py in <module>\r\n      1 video_path = '/home/MRC.OX.AC.UK/phar0732/ettin/Data/head-fixed/videos/3D_unscored'\r\n----> 2 deeplabcut.triangulate(config_path3d, video_path, videotype='mp4', filterpredictions=False)\r\n\r\n~/anaconda3/envs/DEEPLABCUT/lib/python3.8/site-packages/deeplabcut/pose_estimation_3d/triangulation.py in triangulate(config, video_path, videotype, filterpredictions, filtertype, gputouse, destfolder, save_as_csv)\r\n    300                 stereomatrix,\r\n    301                 path_stereo_file,\r\n--> 302             ) = undistort_points(\r\n    303                 config, dataname, str(cam_names[0] + \"-\" + cam_names[1])\r\n    304             )\r\n\r\n~/anaconda3/envs/DEEPLABCUT/lib/python3.8/site-packages/deeplabcut/pose_estimation_3d/triangulation.py in undistort_points(config, dataframe, camera_pair)\r\n    451     if True:\r\n    452         # Create an empty dataFrame to store the undistorted 2d coordinates and likelihood\r\n--> 453         dataframe_cam1 = pd.read_hdf(dataframe[0])\r\n    454         dataframe_cam2 = pd.read_hdf(dataframe[1])\r\n    455         scorer_cam1 = dataframe_cam1.columns.get_level_values(0)[0]\r\n\r\nIndexError: list index out of range\r\n```\r\n\r\n\r\n### Anything else?\r\n\r\n_No response_\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project's [Code of Conduct](https://github.com/DeepLabCut/DeepLabCut/blob/master/CODE_OF_CONDUCT.md)","closed_by":{"login":"MMathisLab","id":28102185,"node_id":"MDQ6VXNlcjI4MTAyMTg1","avatar_url":"https://avatars.githubusercontent.com/u/28102185?v=4","gravatar_id":"","url":"https://api.github.com/users/MMathisLab","html_url":"https://github.com/MMathisLab","followers_url":"https://api.github.com/users/MMathisLab/followers","following_url":"https://api.github.com/users/MMathisLab/following{/other_user}","gists_url":"https://api.github.com/users/MMathisLab/gists{/gist_id}","starred_url":"https://api.github.com/users/MMathisLab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MMathisLab/subscriptions","organizations_url":"https://api.github.com/users/MMathisLab/orgs","repos_url":"https://api.github.com/users/MMathisLab/repos","events_url":"https://api.github.com/users/MMathisLab/events{/privacy}","received_events_url":"https://api.github.com/users/MMathisLab/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1709/timeline","performed_via_github_app":null,"state_reason":"completed"}