{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/910","id":702962828,"node_id":"MDU6SXNzdWU3MDI5NjI4Mjg=","number":910,"title":"Failure to evaluate network with plotting on with large training sets","user":{"login":"backyardbiomech","id":9662673,"node_id":"MDQ6VXNlcjk2NjI2NzM=","avatar_url":"https://avatars.githubusercontent.com/u/9662673?v=4","gravatar_id":"","url":"https://api.github.com/users/backyardbiomech","html_url":"https://github.com/backyardbiomech","followers_url":"https://api.github.com/users/backyardbiomech/followers","following_url":"https://api.github.com/users/backyardbiomech/following{/other_user}","gists_url":"https://api.github.com/users/backyardbiomech/gists{/gist_id}","starred_url":"https://api.github.com/users/backyardbiomech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/backyardbiomech/subscriptions","organizations_url":"https://api.github.com/users/backyardbiomech/orgs","repos_url":"https://api.github.com/users/backyardbiomech/repos","events_url":"https://api.github.com/users/backyardbiomech/events{/privacy}","received_events_url":"https://api.github.com/users/backyardbiomech/received_events","type":"User","site_admin":false},"labels":[{"id":880550034,"node_id":"MDU6TGFiZWw4ODA1NTAwMzQ=","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2020-09-16T17:57:31Z","updated_at":"2021-05-02T18:39:49Z","closed_at":"2021-05-02T18:39:49Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"Related to one of the sub-issues in #878, and to #835 , but I think worthy of elevating to its own issue since both of those other issues covered multiple issues, and this one was never solved (just worked around). I've tried to monitor a few things (details below).\r\n\r\n**Describe the bug**\r\n\r\nDuring evaluating network with plotting, I get a wx._core.wxAssertionError (the same as mentioned [here](https://github.com/DeepLabCut/DeepLabCut/issues/878#issuecomment-683074629) and at the start of #835 . Some but not all plots are saved, and no other evaluation outputs are returned.\r\n\r\n**Desktop (please complete the following information about your system):**\r\n - OS: Windows 10, 64 GB, 24 GB GPU\r\n - DeepLabCut Version: 2.2b8 - clean install of conda env 15 Sept.\r\n - Browser, if applicable [e.g. chrome, safari]\r\n\r\n**To Reproduce**\r\nSame with GUI or from command line:\r\n1. Create training dataset with large number of input images, and crop and label True.\r\n2. Train Network\r\n3. Evaluate Network with plotting on\r\n\r\n<details><summary>TRACEBACK</summary>\r\n<p>\r\n\r\n```python\r\n\r\n1219it [05:34,  3.64it/s]\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\gui\\evaluate_network.py\", line 340, in evaluate_network\r\n    comparisonbodypart\r\ns=self.bodyparts,\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\pose_estimation_tensorflow\\evaluate.py\", line 583, in evaluate_network\r\n    c_engine=c_engine,\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\pose_estimation_tensorflow\\evaluate_multianimal.py\", line 343, in evaluate_multianimal_full\r\n    cfg[\"pcutoff\"],\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\utils\\visualization.py\", line 109, in make_multianimal_labeled_image\r\n    fig, ax = prepare_figure_axes(w, h)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\utils\\visualization.py\", line 185, in prepare_figure_axes\r\n    frameon=False, figsize=(width * scale / dpi, height * scale / dpi), dpi=dpi\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\pyplot.py\", line 545, in figure\r\n    **kwargs)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1969, in new_figure_manager\r\n    return super().new_figure_manager(num, *args, **kwargs)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backend_bases.py\", line 3261, in new_figure_manager\r\n    return cls.new_figure_manager_given_figure(num, fig)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1973, in new_figure_manager_given_figure\r\n    frame = cls._frame_class(num, figure)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1103, in __init__\r\n    self.toolbar = self._get_toolbar(self.statusbar)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1131, in _get_toolbar\r\n    toolbar = NavigationToolbar2Wx(self.canvas)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1377, in __init__\r\n    NavigationToolbar2.__init__(self, canvas)\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backend_bases.py\", line 2636, in __init__\r\n    self._init_toolbar()\r\n  File \"C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\matplotlib\\backends\\backend_wx.py\", line 1413, in _init_toolbar\r\n    self.Realize()\r\nwx._core.wxAssertionError: C++ assertion \"Assert failure\" failed at ..\\..\\src\\msw\\toolbar.cpp(938) in wxToolBar::Realize(): Could not add bitmap to toolbar  \r\n\r\n\r\n```\r\n\r\nAlso, possible relevant proceeding FutureWarnings and RuntimeWarnings. There are MANY of these, I'm assuming related to cropped training images when all points have been cropped out. But maybe not trying to save these would prevent memory issues?\r\n```python\r\n1216it [04:52,  3.84it/s]C:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\pose_estimation_tensorflow\\evaluate_multianimal.py:266: FutureWarning: Pass-through of possibly RGB images in gray2rgb is deprecated. In version 0.19, input arrays will always be considered grayscale, even if the last dimension has length 3 or 4. To prevent this warning and ensure compatibility with future versions, detect RGB images outside of this function.\r\n  frame = img_as_ubyte(skimage.color.gray2rgb(image))\r\nC:\\Users\\jacksonbe3\\Miniconda3\\envs\\dlc\\lib\\site-packages\\deeplabcut\\pose_estimation_tensorflow\\evaluate_multianimal.py:280: RuntimeWarning: All-NaN slice encountered\r\n  distnorm[imageindex] = np.nanmax(lengths)\r\n```\r\n</p></details>\r\n\r\n\r\n**Expected behavior**\r\nEvaluated images from all images in the training set, and other evaluation outputs\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem. (but please post the code output above!)\r\n\r\n**Additional context**\r\nMany labeled images are produced (ca. 1215), but with a large number of labelled images, and \"Crop and Label\" selected when creating the the dataset, this isn't all of them. Therefore, it acts like a memory leak issue, also suggested by and with a possible strategy for a fix [here](https://stackoverflow.com/a/61920189).\r\n\r\nTask Manager shows a gradual ongoing drop in available RAM, with this process eventually taking up about 2.5 GB as the evaluate process continues, so it doesn't seem to be releasing memory after creating each figure. However, when it fails, I still have about 45 GB free, so if it is a memory problem it's a problem with pre-allocation and not total available memory. In fact, that memory isn't released even with the error and the process stopping; it is only released if I start another evaluation process (or close the GUI).\r\n\r\nThere isn't an error with smaller training sets with crop and label. or the same project without crop and label, or this data set but without plotting, so it doesn't seem to be something fundamental to the version of wxpython, but indeed something about memory handling.\r\n\r\nImportantly, with plotting off, evaluation completes and returns everything (other than the images).\r\n\r\n","closed_by":{"login":"MMathisLab","id":28102185,"node_id":"MDQ6VXNlcjI4MTAyMTg1","avatar_url":"https://avatars.githubusercontent.com/u/28102185?v=4","gravatar_id":"","url":"https://api.github.com/users/MMathisLab","html_url":"https://github.com/MMathisLab","followers_url":"https://api.github.com/users/MMathisLab/followers","following_url":"https://api.github.com/users/MMathisLab/following{/other_user}","gists_url":"https://api.github.com/users/MMathisLab/gists{/gist_id}","starred_url":"https://api.github.com/users/MMathisLab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MMathisLab/subscriptions","organizations_url":"https://api.github.com/users/MMathisLab/orgs","repos_url":"https://api.github.com/users/MMathisLab/repos","events_url":"https://api.github.com/users/MMathisLab/events{/privacy}","received_events_url":"https://api.github.com/users/MMathisLab/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/910/timeline","performed_via_github_app":null,"state_reason":"completed"}