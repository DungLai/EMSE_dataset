{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/624","id":584637451,"node_id":"MDU6SXNzdWU1ODQ2Mzc0NTE=","number":624,"title":"CPU-training: Memory Error with Network Training","user":{"login":"nmtimme","id":38138179,"node_id":"MDQ6VXNlcjM4MTM4MTc5","avatar_url":"https://avatars.githubusercontent.com/u/38138179?v=4","gravatar_id":"","url":"https://api.github.com/users/nmtimme","html_url":"https://github.com/nmtimme","followers_url":"https://api.github.com/users/nmtimme/followers","following_url":"https://api.github.com/users/nmtimme/following{/other_user}","gists_url":"https://api.github.com/users/nmtimme/gists{/gist_id}","starred_url":"https://api.github.com/users/nmtimme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nmtimme/subscriptions","organizations_url":"https://api.github.com/users/nmtimme/orgs","repos_url":"https://api.github.com/users/nmtimme/repos","events_url":"https://api.github.com/users/nmtimme/events{/privacy}","received_events_url":"https://api.github.com/users/nmtimme/received_events","type":"User","site_admin":false},"labels":[{"id":1816193536,"node_id":"MDU6TGFiZWwxODE2MTkzNTM2","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/tensorflow/training","name":"tensorflow/training","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2020-03-19T19:11:42Z","updated_at":"2020-03-28T18:31:45Z","closed_at":"2020-03-28T18:31:45Z","author_association":"NONE","active_lock_reason":null,"body":"I'm encountering a memory error at the network training step. The network training fails after about 700 iterations for lack of virtual memory even with 32 gb available. \r\n\r\nSystem\r\nOS: Red Hat Enterprise Linux (RHEL 7)\r\nAnaconda Environment\r\nDeepLabCut Version 2.1.1\r\n\r\nBecause I'm working on a Red Hat system, I had to use the following steps to get DLC running:\r\n\r\n```\r\nwget https://github.com/AlexEMG/DeepLabCut/archive/v2.1.1.tar.gz\r\ntar -xzf v2.1.1.tar.gz\r\ncd DeepLabCut-2.1.1\r\nconda create -n DeepLabCutEnv python=3.6.8 tensorflow=1.13.1 imageio wxpython=4.0.3 matplotlib=3.0.3\r\n```\r\n\r\n```\r\nEdit the setup.py file in DeepLabCut-2.1.1 in the following way:\r\nReplace:\r\n'ipython','ipython-genutils','imageio~=2.3.0' ,\r\nwith:\r\n'ipython','ipython-genutils','imageio~=2.6.1'\r\n```\r\n\r\n```\r\nsource activate DeepLabCutLabelEnv\r\npython setup.py install\r\nexport DLClight=True\r\nipython\r\nimport deeplabcut\r\ndeeplabcut.train_network(config_path)\r\n```\r\nNote that I previously coded video frames. The video frames are 1080x720 pixels, but they have been cropped down to about 800x550. I don't believe this is due to corrupt images because I am able to adjust the amount of virtual memory available (I'm running on a large cluster) and increasing the memory delays the error. Unfortunately, the maximum memory is about 250gb, but that only gets to about 3000 iterations, so I can't simply add more memory. Perhaps there is some setting that is making DLC hold increasing amounts of data in RAM with each iteration and this can be easily fixed? Since I don't have much experience with python, I'd appreciate any ideas about how to diagnose the source of the memory leak and fix this problem. Thanks!\r\n\r\n~Nick\r\n\r\n--Output of Training--\r\n```\r\nDLC loaded in light mode; you cannot use the relabeling GUI!\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/statsmodels-0.10.1-py3.6-linux-x86_64.egg/statsmodels/tools/_testing.py:19: FutureWarning: pandas.util.testing is deprecated. Use the functions in the public API at pandas.testing instead.\r\n  import pandas.util.testing as tm\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:526: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  _np_qint8 = np.dtype([(\"qint8\", np.int8, 1)])\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:527: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  _np_quint8 = np.dtype([(\"quint8\", np.uint8, 1)])\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:528: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  _np_qint16 = np.dtype([(\"qint16\", np.int16, 1)])\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:529: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  _np_quint16 = np.dtype([(\"quint16\", np.uint16, 1)])\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:530: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  _np_qint32 = np.dtype([(\"qint32\", np.int32, 1)])\r\n/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:535: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.\r\n  np_resource = np.dtype([(\"resource\", np.ubyte, 1)])\r\nOMP: Info #154: KMP_AFFINITY: Initial OS proc set respected: 10\r\nOMP: Info #213: KMP_AFFINITY: decoding x2APIC ids.\r\nOMP: Info #276: KMP_AFFINITY: Affinity capable, using global cpuid leaf 11 info\r\nOMP: Info #156: KMP_AFFINITY: 1 available OS procs\r\nOMP: Info #157: KMP_AFFINITY: Uniform topology\r\nOMP: Info #159: KMP_AFFINITY: 1 packages x 1 cores/pkg x 1 threads/core (1 total cores)\r\nOMP: Info #215: KMP_AFFINITY: OS proc to physical thread map:\r\nOMP: Info #171: KMP_AFFINITY: OS proc 10 maps to package 0 \r\nOMP: Info #251: KMP_AFFINITY: pid 27438 tid 27438 thread 0 bound to OS proc set 10\r\nDLC loaded in light mode; you cannot use the labeling GUI!\r\nConfig:\r\n{'all_joints': [[0],\r\n                [1],\r\n                [2],\r\n                [3],\r\n                [4],\r\n                [5],\r\n                [6],\r\n                [7],\r\n                [8],\r\n                [9],\r\n                [10],\r\n                [11],\r\n                [12],\r\n                [13],\r\n                [14],\r\n                [15],\r\n                [16],\r\n                [17]],\r\n 'all_joints_names': ['SnoutTip',\r\n                      'HeadCap',\r\n                      'MidBack',\r\n                      'BackTailJunction',\r\n                      'LeftFrontPaw',\r\n                      'RightFrontPaw',\r\n                      'LeftRearPaw',\r\n                      'RightRearPaw',\r\n                      'LeftEar',\r\n                      'RightEar',\r\n                      'LeftLight',\r\n                      'RightLight',\r\n                      'LeftSipper',\r\n                      'RightSipper',\r\n                      'UpperLeftCorner',\r\n                      'LowerLeftCorner',\r\n                      'UpperRightCorner',\r\n                      'LowerRightCorner'],\r\n 'batch_size': 1,\r\n 'bottomheight': 400,\r\n 'crop': True,\r\n 'crop_pad': 0,\r\n 'cropratio': 0.4,\r\n 'dataset': 'training-datasets/iteration-0/UnaugmentedDataSet_2CapVer1Mar17/2CapVer1_Nick95shuffle1.mat',\r\n 'dataset_type': 'default',\r\n 'deterministic': False,\r\n 'display_iters': 100,\r\n 'fg_fraction': 0.25,\r\n 'global_scale': 0.8,\r\n 'init_weights': '/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutLabelEnv/lib/python3.6/site-packages/deeplabcut-2.1.1-py3.6.egg/deeplabcut/pose_estimation_tensorflow/models/pretrained/resnet_v1_50.ckpt',\r\n 'intermediate_supervision': False,\r\n 'intermediate_supervision_layer': 12,\r\n 'leftwidth': 400,\r\n 'location_refinement': True,\r\n 'locref_huber_loss': True,\r\n 'locref_loss_weight': 0.05,\r\n 'locref_stdev': 7.2801,\r\n 'log_dir': 'log',\r\n 'max_input_size': 1500,\r\n 'mean_pixel': [123.68, 116.779, 103.939],\r\n 'metadataset': 'training-datasets/iteration-0/UnaugmentedDataSet_2CapVer1Mar17/Documentation_data-2CapVer1_95shuffle1.pickle',\r\n 'min_input_size': 64,\r\n 'minsize': 100,\r\n 'mirror': False,\r\n 'multi_step': [[0.005, 10000],\r\n                [0.02, 430000],\r\n                [0.002, 730000],\r\n                [0.001, 1030000]],\r\n 'net_type': 'resnet_50',\r\n 'num_joints': 18,\r\n 'optimizer': 'sgd',\r\n 'pos_dist_thresh': 17,\r\n 'project_path': '/N/dc2/scratch/nmtimme/DeepLabCut2CapVer1/2CapVer1-Nick-2020-03-17',\r\n 'regularize': False,\r\n 'rightwidth': 400,\r\n 'save_iters': 50000,\r\n 'scale_jitter_lo': 0.5,\r\n 'scale_jitter_up': 1.25,\r\n 'scoremap_dir': 'test',\r\n 'shuffle': True,\r\n 'snapshot_prefix': '/N/dc2/scratch/nmtimme/DeepLabCut2CapVer1/2CapVer1-Nick-2020-03-17/dlc-models/iteration-0/2CapVer1Mar17-trainset95shuffle1/train/snapshot',\r\n 'stride': 8.0,\r\n 'topheight': 400,\r\n 'weigh_negatives': False,\r\n 'weigh_only_present_joints': False,\r\n 'weigh_part_predictions': False,\r\n 'weight_decay': 0.0001}\r\nSwitching batchsize to 1, as default/tensorpack/deterministic loaders do not support batches >1. Use imgaug loader.\r\nStarting with standard pose-dataset loader.\r\nInitializing ResNet\r\nWARNING:tensorflow:From /N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py:263: colocate_with (from tensorflow.python.framework.ops) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nColocations handled automatically by placer.\r\nWARNING:tensorflow:From /N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/ops/losses/losses_impl.py:209: to_float (from tensorflow.python.ops.math_ops) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nUse tf.cast instead.\r\nLoading ImageNet-pretrained resnet_50\r\nWARNING:tensorflow:From /N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutTrainEnv/lib/python3.6/site-packages/tensorflow/python/training/saver.py:1266: checkpoint_exists (from tensorflow.python.training.checkpoint_management) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nUse standard file APIs to check for files with this prefix.\r\nINFO:tensorflow:Restoring parameters from /N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutLabelEnv/lib/python3.6/site-packages/deeplabcut-2.1.1-py3.6.egg/deeplabcut/pose_estimation_tensorflow/models/pretrained/resnet_v1_50.ckpt\r\nTraining parameter:\r\n{'stride': 8.0, 'weigh_part_predictions': False, 'weigh_negatives': False, 'fg_fraction': 0.25, 'weigh_only_present_joints': False, 'mean_pixel': [123.68, 116.779, 103.939], 'shuffle': True, 'snapshot_prefix': '/N/dc2/scratch/nmtimme/DeepLabCut2CapVer1/2CapVer1-Nick-2020-03-17/dlc-models/iteration-0/2CapVer1Mar17-trainset95shuffle1/train/snapshot', 'log_dir': 'log', 'global_scale': 0.8, 'location_refinement': True, 'locref_stdev': 7.2801, 'locref_loss_weight': 0.05, 'locref_huber_loss': True, 'optimizer': 'sgd', 'intermediate_supervision': False, 'intermediate_supervision_layer': 12, 'regularize': False, 'weight_decay': 0.0001, 'mirror': False, 'crop_pad': 0, 'scoremap_dir': 'test', 'batch_size': 1, 'dataset_type': 'default', 'deterministic': False, 'crop': True, 'cropratio': 0.4, 'minsize': 100, 'leftwidth': 400, 'rightwidth': 400, 'topheight': 400, 'bottomheight': 400, 'all_joints': [[0], [1], [2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12], [13], [14], [15], [16], [17]], 'all_joints_names': ['SnoutTip', 'HeadCap', 'MidBack', 'BackTailJunction', 'LeftFrontPaw', 'RightFrontPaw', 'LeftRearPaw', 'RightRearPaw', 'LeftEar', 'RightEar', 'LeftLight', 'RightLight', 'LeftSipper', 'RightSipper', 'UpperLeftCorner', 'LowerLeftCorner', 'UpperRightCorner', 'LowerRightCorner'], 'dataset': 'training-datasets/iteration-0/UnaugmentedDataSet_2CapVer1Mar17/2CapVer1_Nick95shuffle1.mat', 'display_iters': 100, 'init_weights': '/N/u/nmtimme/Carbonate/.conda/envs/DeepLabCutLabelEnv/lib/python3.6/site-packages/deeplabcut-2.1.1-py3.6.egg/deeplabcut/pose_estimation_tensorflow/models/pretrained/resnet_v1_50.ckpt', 'max_input_size': 1500, 'metadataset': 'training-datasets/iteration-0/UnaugmentedDataSet_2CapVer1Mar17/Documentation_data-2CapVer1_95shuffle1.pickle', 'min_input_size': 64, 'multi_step': [[0.005, 10000], [0.02, 430000], [0.002, 730000], [0.001, 1030000]], 'net_type': 'resnet_50', 'num_joints': 18, 'pos_dist_thresh': 17, 'project_path': '/N/dc2/scratch/nmtimme/DeepLabCut2CapVer1/2CapVer1-Nick-2020-03-17', 'save_iters': 50000, 'scale_jitter_lo': 0.5, 'scale_jitter_up': 1.25, 'output_stride': 16, 'deconvolutionstride': 2}\r\nStarting training....\r\nOMP: Info #251: KMP_AFFINITY: pid 27438 tid 27524 thread 1 bound to OS proc set 10\r\nOMP: Info #251: KMP_AFFINITY: pid 27438 tid 27523 thread 2 bound to OS proc set 10\r\niteration: 100 loss: 0.0855 lr: 0.005\r\niteration: 200 loss: 0.0229 lr: 0.005\r\niteration: 300 loss: 0.0200 lr: 0.005\r\niteration: 400 loss: 0.0184 lr: 0.005\r\niteration: 500 loss: 0.0172 lr: 0.005\r\niteration: 600 loss: 0.0168 lr: 0.005\r\niteration: 700 loss: 0.0166 lr: 0.005\r\n=>> PBS: job killed: vmem 34553384960 exceeded limit 34359738368\r\n```\r\n\r\n\r\n\r\n","closed_by":{"login":"nmtimme","id":38138179,"node_id":"MDQ6VXNlcjM4MTM4MTc5","avatar_url":"https://avatars.githubusercontent.com/u/38138179?v=4","gravatar_id":"","url":"https://api.github.com/users/nmtimme","html_url":"https://github.com/nmtimme","followers_url":"https://api.github.com/users/nmtimme/followers","following_url":"https://api.github.com/users/nmtimme/following{/other_user}","gists_url":"https://api.github.com/users/nmtimme/gists{/gist_id}","starred_url":"https://api.github.com/users/nmtimme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nmtimme/subscriptions","organizations_url":"https://api.github.com/users/nmtimme/orgs","repos_url":"https://api.github.com/users/nmtimme/repos","events_url":"https://api.github.com/users/nmtimme/events{/privacy}","received_events_url":"https://api.github.com/users/nmtimme/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/624/timeline","performed_via_github_app":null,"state_reason":"completed"}