{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/362","id":468730882,"node_id":"MDU6SXNzdWU0Njg3MzA4ODI=","number":362,"title":"Slow Training Speed & Low GPU Utilization","user":{"login":"donglabimaging","id":50585879,"node_id":"MDQ6VXNlcjUwNTg1ODc5","avatar_url":"https://avatars.githubusercontent.com/u/50585879?v=4","gravatar_id":"","url":"https://api.github.com/users/donglabimaging","html_url":"https://github.com/donglabimaging","followers_url":"https://api.github.com/users/donglabimaging/followers","following_url":"https://api.github.com/users/donglabimaging/following{/other_user}","gists_url":"https://api.github.com/users/donglabimaging/gists{/gist_id}","starred_url":"https://api.github.com/users/donglabimaging/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/donglabimaging/subscriptions","organizations_url":"https://api.github.com/users/donglabimaging/orgs","repos_url":"https://api.github.com/users/donglabimaging/repos","events_url":"https://api.github.com/users/donglabimaging/events{/privacy}","received_events_url":"https://api.github.com/users/donglabimaging/received_events","type":"User","site_admin":false},"labels":[{"id":880550040,"node_id":"MDU6TGFiZWw4ODA1NTAwNDA=","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/question","name":"question","color":"d876e3","default":true,"description":"user question (not great for github ;)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-07-16T15:45:08Z","updated_at":"2019-07-19T15:51:45Z","closed_at":"2019-07-19T15:51:45Z","author_association":"NONE","active_lock_reason":null,"body":"**Your operating system and DeepLabCut version**\r\n\r\nPlease state your operating system, env, and which version of DeepLabCut you are using:\r\n\r\nWindows 10, with an Anaconda Env, & DeepLabCut 2.0.7\r\n\r\nPlease complete the following information about your system:\r\n\r\nOS: Windows 10\r\nDeepLabCut Version: 2.0.7\r\nBrowser: chrome\r\nGPU: NVIDIA GeForce RTX 2070\r\n\r\n\r\n**Describe the problem**\r\n\r\nWe have recently started using GPU for DeepLabCut, however, we noticed that the training takes extremely long. A 20 sec video of frame size 640x480 took more than 12 hours before DeepLabCut told us that the training was done and it was ready for evaluation. Although it seemed like the speed somewhat increased towards the end, in the beginning each iteration was taking about 5 minutes. We checked our computer's task manager during training, and it showed that the CPU was 15-20% engaged and the GPU only about 0-1%. But the dedicated GPU memory was about 7.2/8.0 GB, and this contrast seemed weird to us.\r\n\r\nOriginally, we thought the GPU was not being properly engaged. But we tried every tip we could find online:\r\n\r\n1)\r\nNVIDIA-SMI\r\n(Displays details about our GPU)\r\n\r\n2)\r\n`tf.test.is_gpu_available()`\r\n(Returns true)\r\n\r\n3)\r\n`tf.test.is_built_with_cuda()`\r\n(Returns true)\r\n\r\n4)\r\n`tf.test.gpu_device_name()`\r\n(Returns '/device:GPU:0')\r\n\r\n5)\r\n`with tf.device('/device:GPU:0'):`\r\n     `deeplabcut.train_network(path_config_file, gputouse=0)`\r\n\r\n6)\r\n`from tensorflow.python.client import device_lib`\r\n     `print(device_lib.list_local_devices())`\r\n(Prints information about both CPU and GPU)\r\n\r\n7)\r\n`a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')`\r\n`b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')`\r\n`c = tf.matmul(a, b)`\r\n\r\n`config = tf.ConfigProto(log_device_placement=True)`\r\n`config.gpu_options.allow_growth = True`\r\n`sess = tf.Session(config=config)`\r\n`print(sess.run(c))`\r\n(Printed output and Anaconda show that a, b, and c were all done using GPU)\r\n\r\n8)\r\n`import os`\r\n`os.environ[\"CUDA_DEVICE_ORDER\"]=\"PCI_BUS_ID\"`\r\n`os.environ[\"CUDA_VISIBLE_DEVICES\"]=\"0\"  # specify which GPU(s) to be used`\r\n(Run at the very beginning)\r\n\r\nThese all seemed to indicate to us that the GPU was ready and set to go, but DeepLabCut's training was still extremely slow and the task manager still displayed the same kind of performance details. Interestingly, though, we tried the training with both the dlc-windowsCPU and dlc-windowsGPU environments, and the performance was significantly slower in the CPU environment (with CPU being engaged up to about 90%), so we suspect the GPU must be making some kind of a difference. Still, the slow speed in the GPU environment is concerning to us, especially when we can't find any other complaints like this online.\r\n\r\nWe read online that a low GPU utilization could be due to a small batch size, and we saw this comment by @MMathisLab on another post [https://github.com/AlexEMG/DeepLabCut/issues/224#issuecomment-468439622](url) saying that DeepLabCut's training batch size is 1 and that \"in terms of GPU size, frame size is your limitation\". This (we think) is also echoed in the paper \"On the inference speed and video-compression robustness of DeepLabCut\", so we are wondering if the only solutions to increasing speed are changing the batchsize and/or downsampling our videos.\r\n\r\n\r\n**How to Reproduce the problem**\r\nSteps to reproduce the behavior:\r\n1. Activate dlc-windowsGPU on Anaconda\r\n2. Open \"Demo_yourowndata.ipynb\" in Jupyter Notebook\r\n3. In the training phase, run the following:\r\n`with tf.device('/device:GPU:0'):`\r\n`deeplabcut.train_network(path_config_file, gputouse=0)`\r\n4. Check the performance\r\n\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n\r\n**Additional context**\r\nWe ran a simple autoencoder that uses keras and its training was super fast with GPU.","closed_by":{"login":"MMathisLab","id":28102185,"node_id":"MDQ6VXNlcjI4MTAyMTg1","avatar_url":"https://avatars.githubusercontent.com/u/28102185?v=4","gravatar_id":"","url":"https://api.github.com/users/MMathisLab","html_url":"https://github.com/MMathisLab","followers_url":"https://api.github.com/users/MMathisLab/followers","following_url":"https://api.github.com/users/MMathisLab/following{/other_user}","gists_url":"https://api.github.com/users/MMathisLab/gists{/gist_id}","starred_url":"https://api.github.com/users/MMathisLab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MMathisLab/subscriptions","organizations_url":"https://api.github.com/users/MMathisLab/orgs","repos_url":"https://api.github.com/users/MMathisLab/repos","events_url":"https://api.github.com/users/MMathisLab/events{/privacy}","received_events_url":"https://api.github.com/users/MMathisLab/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/362/timeline","performed_via_github_app":null,"state_reason":"completed"}