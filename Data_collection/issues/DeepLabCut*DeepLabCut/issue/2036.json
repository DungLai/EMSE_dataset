{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/2036","id":1437635543,"node_id":"I_kwDOB5BM6c5VsJPX","number":2036,"title":"Cannot use individual video crops for refinement?","user":{"login":"jonahpearl","id":68478436,"node_id":"MDQ6VXNlcjY4NDc4NDM2","avatar_url":"https://avatars.githubusercontent.com/u/68478436?v=4","gravatar_id":"","url":"https://api.github.com/users/jonahpearl","html_url":"https://github.com/jonahpearl","followers_url":"https://api.github.com/users/jonahpearl/followers","following_url":"https://api.github.com/users/jonahpearl/following{/other_user}","gists_url":"https://api.github.com/users/jonahpearl/gists{/gist_id}","starred_url":"https://api.github.com/users/jonahpearl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonahpearl/subscriptions","organizations_url":"https://api.github.com/users/jonahpearl/orgs","repos_url":"https://api.github.com/users/jonahpearl/repos","events_url":"https://api.github.com/users/jonahpearl/events{/privacy}","received_events_url":"https://api.github.com/users/jonahpearl/received_events","type":"User","site_admin":false},"labels":[{"id":880550034,"node_id":"MDU6TGFiZWw4ODA1NTAwMzQ=","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2022-11-07T01:21:02Z","updated_at":"2022-11-28T15:14:30Z","closed_at":"2022-11-10T12:44:43Z","author_association":"NONE","active_lock_reason":null,"body":"### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Bug description\n\nHi all -- thank you for maintaining this code base so well! I have some videos where the mouse occupies about 1/4 of the frame, so I cropped them manually during initial frame extraction. I uploaded my videos to a computing cluster to run the training, and it worked quite well with the cropping. The relevant part of the config looks something like:\r\n```\r\nvideo_sets:\r\n? /laptop/path/to/basler_2022-10-10T19_24_54.mp4\r\n: crop: 268, 827, 269, 823\r\n? /laptop/path/to/basler_2022-10-10T20_46_35.mp4\r\n: crop: 207, 794, 280, 829\r\n\r\n[etc]\r\n\r\n[and then the same again but with paths on the cluster]\r\n\r\n? /cluster/path/to/basler_2022-10-10T19_24_54.mp4\r\n: crop: 268, 827, 269, 823\r\n? /cluster/path/to/basler_2022-10-10T20_46_35.mp4\r\n: crop: 207, 794, 280, 829\r\n\r\n [etc]\r\n\r\n```\r\n\r\nI used `displaycropped=True` to make labeled videos, and they look almost perfect! But I had some outliers in the videos, so I decided to do some refinement with `dlc.extract_outlier_frames`. It seems like the refinement step has a separate cropping parameter in the config file, which only allows for one set of crop params to be set at a time. Naively I expected that if the `video_sets` had video-specific crops, it would just use those instead, but no luck. The extracted outlier frames look like the frames from #1885 (ie the labels are all clearly offset by the amount of the crop). Oddly, the config file also gets overwritten, such that the cluster-side paths now show no cropping at all:\r\n```\r\n? /cluster/path/to/basler_2022-10-10T19_24_54.mp4\r\n: crop: 0, 1280, 0, 1024\r\n\r\n[etc]\r\n```\r\n\r\nIs there any way to send video-specific crop parameters into the refinement? If no, I may end up writing a script to make a config copy for each video and pass the correct crop to the refinement-specific crop parameters, which I can share here -- but seems like since cropping is part of the upstream pipeline, there should be a feature to use it in refinement as well? Apologies if I've just missed it or am doing something wrong. Thank you!\r\n\r\n(And ultimately, the lesson here may be to crop my videos during acquisition! But thought I'd open an issue anyways in case others have this issue.)\n\n### Operating System\n\nNAME=\"CentOS Linux\"\r\nVERSION=\"7 (Core)\"\r\nID=\"centos\"\r\nID_LIKE=\"rhel fedora\"\r\nVERSION_ID=\"7\"\r\nPRETTY_NAME=\"CentOS Linux 7 (Core)\"\r\n\r\n3.10.0-1160.76.1.el7.x86_64\r\n\n\n### DeepLabCut version\n\n2.2.3\n\n### DeepLabCut mode\n\nsingle animal\n\n### Device type\n\nThis was done with a CPU.\n\n### Steps To Reproduce\n\n`dlc.extract_outlier_frames(config, vid, outlieralgorithm='jump', epsilon=200, extractionalgorithm='uniform', automatic=True)`\r\n\n\n### Relevant log output\n\n```shell\nLoading DLC 2.2.3...\r\nDLC loaded in light mode; you cannot use any GUI (labeling, relabeling and standalone GUI)\r\n/home/jop9552/miniconda3/envs/DEEPLABCUT/lib/python3.8/site-packages/deeplabcut/__init__.py:81: UserWarning:\r\n        As PyTorch is not installed, unsupervised identity learning will not be available.\r\n        Please run `pip install torch`, or ignore this warning.\r\n\r\n  warnings.warn(\r\n/home/jop9552/miniconda3/envs/DEEPLABCUT/lib/python3.8/site-packages/deeplabcut/refine_training_dataset/outlier_frames.py:401: FutureWarning: Using the level keyword in DataFrame and Series aggregations is deprecated and will be removed in a future version. Use groupby instead. df.sum(level=1) should use df.groupby(level=1).sum().\r\n  sum_ = temp_dt.sum(axis=1, level=1)\r\nMethod  jump  found  252  putative outlier frames.\r\nDo you want to proceed with extracting  20  of those?\r\nIf this list is very large, perhaps consider changing the parameters (start, stop, p_bound, comparisonbodyparts) or use a different method.\r\nFrames from video basler_2022-10-13T20_25_58  already extracted (more will be added)!\r\nLoading video...\r\nDuration of video [s]:  4136.416666666667 , recorded @  120.0 fps!\r\nOverall # of frames:  496370 with (cropped) frame dimensions:\r\nUniformly extracting of frames from 0.0  seconds to 4136.42  seconds.\r\nLet's select frames indices: [246953, 148180, 377139, 148419, 246894, 377334, 148598, 377718, 104635, 246755, 246847, 377785, 148588, 377253, 246897, 104788, 377427, 377142, 246927, 148379]\r\nAttempting to create a symbolic link of the video ...\r\n/bin/sh: mklink: command not found\r\nSymlink creation impossible (exFat architecture?): cutting/pasting the video instead.\r\n/n/groups/datta/Jonah/Turbulator/dlc_projects/turbulator_conc_100_1000_gmou85_gmou86-Jonah-2022-10-21/videos/basler_2022-10-13T20_25_58.mp4 moved to /n/groups/datta/Jonah/Turbulator/dlc_projects/turbulator_conc_100_1000_gmou85_gmou86-Jonah-2022-10-21/videos/basler_2022-10-13T20_25_58.mp4\r\nNew videos were added to the project! Use the function 'extract_frames' to select frames for labeling.\r\nThe outlier frames are extracted. They are stored in the subdirectory labeled-data\\basler_2022-10-13T20_25_58.\r\nOnce you extracted frames for all videos, use 'refine_labels' to manually correct the labels.\n```\n\n\n### Anything else?\n\n_No response_\n\n### Code of Conduct\n\n- [X] I agree to follow this project's [Code of Conduct](https://github.com/DeepLabCut/DeepLabCut/blob/master/CODE_OF_CONDUCT.md)","closed_by":{"login":"MMathisLab","id":28102185,"node_id":"MDQ6VXNlcjI4MTAyMTg1","avatar_url":"https://avatars.githubusercontent.com/u/28102185?v=4","gravatar_id":"","url":"https://api.github.com/users/MMathisLab","html_url":"https://github.com/MMathisLab","followers_url":"https://api.github.com/users/MMathisLab/followers","following_url":"https://api.github.com/users/MMathisLab/following{/other_user}","gists_url":"https://api.github.com/users/MMathisLab/gists{/gist_id}","starred_url":"https://api.github.com/users/MMathisLab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MMathisLab/subscriptions","organizations_url":"https://api.github.com/users/MMathisLab/orgs","repos_url":"https://api.github.com/users/MMathisLab/repos","events_url":"https://api.github.com/users/MMathisLab/events{/privacy}","received_events_url":"https://api.github.com/users/MMathisLab/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/2036/timeline","performed_via_github_app":null,"state_reason":"completed"}