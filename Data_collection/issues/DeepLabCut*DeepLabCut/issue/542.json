{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/542","id":548304352,"node_id":"MDU6SXNzdWU1NDgzMDQzNTI=","number":542,"title":"extract_outlier_frames with extractionalgorithm='kmeans' fails if only one outlier is found","user":{"login":"johnmbarrett","id":19190699,"node_id":"MDQ6VXNlcjE5MTkwNjk5","avatar_url":"https://avatars.githubusercontent.com/u/19190699?v=4","gravatar_id":"","url":"https://api.github.com/users/johnmbarrett","html_url":"https://github.com/johnmbarrett","followers_url":"https://api.github.com/users/johnmbarrett/followers","following_url":"https://api.github.com/users/johnmbarrett/following{/other_user}","gists_url":"https://api.github.com/users/johnmbarrett/gists{/gist_id}","starred_url":"https://api.github.com/users/johnmbarrett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/johnmbarrett/subscriptions","organizations_url":"https://api.github.com/users/johnmbarrett/orgs","repos_url":"https://api.github.com/users/johnmbarrett/repos","events_url":"https://api.github.com/users/johnmbarrett/events{/privacy}","received_events_url":"https://api.github.com/users/johnmbarrett/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-01-10T21:41:58Z","updated_at":"2020-01-14T03:23:52Z","closed_at":"2020-01-14T03:23:52Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\n`extract_outlier_frames` fails with a `ValueError` if run on a video with only one outlier when `extractionalgorithm='kmeans'`\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1a. Download the [minimal DLC project folder](https://drive.google.com/open?id=1TVLxHXWCD0Q8P2piD3bcHp1wubIwv4L5) needed to reproduce the issue (the original video that caused the issue is 4GB, so I didn't want to attach it directly, but in the end I replaced it with a smaller one)\r\n1b. Alternatively, create your own DLC project and adjust the parameters to `extract_outlier_frames` (making sure `extractionalgorithm='kmeans'`) until you only get one outlier\r\n2. Change the included IPython notebook and config.yaml to match the paths on your system\r\n3. Run the included IPython notebook\r\n4. Get the following error:\r\n\r\n```\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-3-d4318e33ff51> in <module>\r\n----> 6     deeplabcut.extract_outlier_frames(path_config_file,videosToAnalyse,outlieralgorithm='jump',epsilon=100,extractionalgorithm='kmeans',automatic=True,comparisonbodyparts=['LD2','LD3','Nose','RD2','RD3'])\r\n\r\n~\\Anaconda3\\envs\\dlc-windowsGPU\\lib\\site-packages\\deeplabcut\\refine_training_dataset\\outlier_frames.py in extract_outlier_frames(config, videos, videotype, shuffle, trainingsetindex, outlieralgorithm, comparisonbodyparts, epsilon, p_bound, ARdegree, MAdegree, alpha, extractionalgorithm, automatic, cluster_resizewidth, cluster_color, opencv, savelabeled, destfolder)\r\n    194               if askuser=='y' or askuser=='yes' or askuser=='Ja' or askuser=='ha': # multilanguage support :)\r\n    195                   #Now extract from those Indices!\r\n--> 196                   ExtractFramesbasedonPreselection(Indices,extractionalgorithm,Dataframe,dataname,scorer,video,cfg,config,opencv,cluster_resizewidth,cluster_color,savelabeled)\r\n    197               else:\r\n    198                   print(\"Nothing extracted, please change the parameters and start again...\")\r\n\r\n~\\Anaconda3\\envs\\dlc-windowsGPU\\lib\\site-packages\\deeplabcut\\refine_training_dataset\\outlier_frames.py in ExtractFramesbasedonPreselection(Index, extractionalgorithm, Dataframe, dataname, scorer, video, cfg, config, opencv, cluster_resizewidth, cluster_color, savelabeled)\r\n    340     elif extractionalgorithm=='kmeans':\r\n    341         if opencv:\r\n--> 342             frames2pick=frameselectiontools.KmeansbasedFrameselectioncv2(cap,numframes2extract,start,stop,cfg['cropping'],coords,Index,resizewidth=cluster_resizewidth,color=cluster_color)\r\n    343         else:\r\n    344             if  cfg['cropping']:\r\n\r\n~\\Anaconda3\\envs\\dlc-windowsGPU\\lib\\site-packages\\deeplabcut\\utils\\frameselectiontools.py in KmeansbasedFrameselectioncv2(cap, numframes2pick, start, stop, crop, coords, Index, step, resizewidth, batchsize, max_iter, color)\r\n    233 \r\n    234         kmeans=MiniBatchKMeans(n_clusters=numframes2pick, tol=1e-3, batch_size=batchsize,max_iter=max_iter)\r\n--> 235         kmeans.fit(data)\r\n    236         frames2pick=[]\r\n    237         for clusterid in range(numframes2pick): #pick one frame per cluster\r\n\r\n~\\Anaconda3\\envs\\dlc-windowsGPU\\lib\\site-packages\\sklearn\\cluster\\_k_means.py in fit(self, X, y, sample_weight)\r\n   1507         if n_samples < self.n_clusters:\r\n   1508             raise ValueError(\"n_samples=%d should be >= n_clusters=%d\"\r\n-> 1509                              % (n_samples, self.n_clusters))\r\n   1510 \r\n   1511         sample_weight = _check_normalize_sample_weight(sample_weight, X)\r\n\r\nValueError: n_samples=1 should be >= n_clusters=2\r\n```\r\n\r\n**Expected behavior**\r\n`extract_outlier_frames` just gives you the one frame it found without running the kmeans step.\r\n\r\n**Desktop (please complete the following information about your system):**\r\n - OS: Windows 10 x64\r\n - DeepLabCut Version: 2.1.4\r\n - Browser: Firefox 71.0\r\n\r\n**Additional context**\r\nAdding\r\n\r\n```\r\n    if len(Index) == 1:\r\n        frames2pick=Index\r\n    el\r\n```\r\n\r\nto the beginning of line 330 of outlier_frames.py is one possible way to fix the issue.","closed_by":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/542/timeline","performed_via_github_app":null,"state_reason":"completed"}