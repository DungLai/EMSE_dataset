{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/1508","id":996881677,"node_id":"I_kwDOB5BM6c47azUN","number":1508,"title":"Impossible to run GPU (A100) for analysis via cluster. ","user":{"login":"DorianBattivelli","id":66886884,"node_id":"MDQ6VXNlcjY2ODg2ODg0","avatar_url":"https://avatars.githubusercontent.com/u/66886884?v=4","gravatar_id":"","url":"https://api.github.com/users/DorianBattivelli","html_url":"https://github.com/DorianBattivelli","followers_url":"https://api.github.com/users/DorianBattivelli/followers","following_url":"https://api.github.com/users/DorianBattivelli/following{/other_user}","gists_url":"https://api.github.com/users/DorianBattivelli/gists{/gist_id}","starred_url":"https://api.github.com/users/DorianBattivelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DorianBattivelli/subscriptions","organizations_url":"https://api.github.com/users/DorianBattivelli/orgs","repos_url":"https://api.github.com/users/DorianBattivelli/repos","events_url":"https://api.github.com/users/DorianBattivelli/events{/privacy}","received_events_url":"https://api.github.com/users/DorianBattivelli/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2021-09-15T09:51:32Z","updated_at":"2021-10-04T09:10:23Z","closed_at":"2021-10-04T09:10:23Z","author_association":"NONE","active_lock_reason":null,"body":"### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Bug description\n\nI fail to run GPU analysis via cluster (GPU A100).\r\nI'm able to launch the analysis but the execution stuck after the 7th frame, and keep stuck there endlessly. \r\n\r\nI also had to add module Xvfb to avoid the \"wxagg' which requires the 'wx' interactive framework, as 'headless' is currently running\" error. Indeed, it seems that the \"os.environ[\"DLClight\"]=\"True\"\" is not working. \r\n\r\nI added module CUDA/10.1.243-GCC-8.3.0 too to solve a \"cannot dlopen libraries\" error that made me fail the GPU using. \r\n\r\nI tried different combinations of python, tf, CUDA versions to match with https://www.tensorflow.org/install/source#gpu but I always fail to use my remote GPU. The only thing I managed to do is runing analysis without GPU. \r\n\r\nCould you please indicate how, in my case, create a reliable env to run GPU via cluster? \r\n\r\nThank you, \r\nBest,\r\n\n\n### Operating System\n\ngcc 4.8.5 - Red Hat 4.8.5-44 / Centos 7\r\nCuda 10.2\n\n### DeepLabCut version\n\nDLC version: 2.2.0.1\n\n### DeepLabCut mode\n\nmulti animal\n\n### Device type\n\nA100\n\n### Steps To Reproduce\n\nMy environment (miniconda) contains:\r\n\r\nPython 3.8\r\ncudnn 7.6.5.32\r\ntensorflow 2.2\r\ncudatoolkit 10.2.89\r\n\r\nCommand to submit to cluster:\r\nmodule add Xvfb\r\nmodule add CUDA/10.1.243-GCC-8.3.0\r\nsource activate DLC-GPU\r\nwhich python\r\npython --version\r\nxvfb-run /g/gross/Dorian2/miniconda/envs/DLC-GPU/bin/python Analysis.py\r\n\r\nScript that run:\r\n\r\nimport matplotlib\r\nmatplotlib.use('Agg')\r\nimport numpy\r\nimport scipy\r\nimport mpl_toolkits\r\n\r\nimport os\r\nos.environ[\"DLClight\"]=\"True\"\r\nimport deeplabcut\r\nprint(deeplabcut.__version__)\r\n\r\nProjectFolderName = 'C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06'\r\nVideoType = 'mp4' #, mp4, MOV, or avi, whatever you uploaded!\r\n\r\n\r\nvideofile_path = [f\"/g/gross/Dorian2/Test_DLC/{ProjectFolderName}/videos/\"] \r\nprint(videofile_path)\r\n\r\n\r\npath_config_file = f\"/g/gross/Dorian2/Test_DLC/{ProjectFolderName}/config.yaml\"\r\nprint(path_config_file)\r\n\r\nprint(\"Start Analyzing my video(s)!\")\r\nscorername = deeplabcut.analyze_videos(\r\n\tpath_config_file, \r\n\tvideofile_path, \r\n\tshuffle=1, \r\n\tvideotype=VideoType,\r\n) \n\n### Relevant log output\n\n```shell\nThe following have been reloaded with a version change:\r\n  1) GCCcore/10.3.0 => GCCcore/8.3.0\r\n  2) zlib/1.2.11-GCCcore-10.3.0 => zlib/1.2.11-GCCcore-8.3.0\r\n\r\n/var/spool/slurm/job24768206/slurm_script: line 17: activate: No such file or directory\r\n/g/gross/Dorian2/miniconda/envs/DLC-GPU/bin/python\r\nPython 3.8.6\r\n2021-09-15 11:11:49.907056: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcuda.so.1\r\n2021-09-15 11:11:49.973841: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1561] Found device 0 with properties: \r\npciBusID: 0000:01:00.0 name: A100-PCIE-40GB computeCapability: 8.0\r\ncoreClock: 1.41GHz coreCount: 108 deviceMemorySize: 39.59GiB deviceMemoryBandwidth: 1.41TiB/s\r\n2021-09-15 11:11:50.135242: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudart.so.10.1\r\n2021-09-15 11:11:50.472736: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcublas.so.10\r\n2021-09-15 11:11:50.625777: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcufft.so.10\r\n2021-09-15 11:11:50.835421: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcurand.so.10\r\n2021-09-15 11:11:50.972786: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcusolver.so.10\r\n2021-09-15 11:11:51.107075: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcusparse.so.10\r\n2021-09-15 11:11:51.465295: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudnn.so.7\r\n2021-09-15 11:11:51.470910: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1703] Adding visible gpu devices: 0\r\n2021-09-15 11:11:51.471406: I tensorflow/core/platform/cpu_feature_guard.cc:143] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n2021-09-15 11:11:51.485737: I tensorflow/core/platform/profile_utils/cpu_utils.cc:102] CPU Frequency: 2500035000 Hz\r\n2021-09-15 11:11:51.488424: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x55d1bc4ef200 initialized for platform Host (this does not guarantee that XLA will be used). Devices:\r\n2021-09-15 11:11:51.488482: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version\r\n2021-09-15 11:11:51.586989: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x55d1bbcbe9f0 initialized for platform CUDA (this does not guarantee that XLA will be used). Devices:\r\n2021-09-15 11:11:51.587054: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): A100-PCIE-40GB, Compute Capability 8.0\r\n2021-09-15 11:11:51.590439: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1561] Found device 0 with properties: \r\npciBusID: 0000:01:00.0 name: A100-PCIE-40GB computeCapability: 8.0\r\ncoreClock: 1.41GHz coreCount: 108 deviceMemorySize: 39.59GiB deviceMemoryBandwidth: 1.41TiB/s\r\n2021-09-15 11:11:51.590539: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudart.so.10.1\r\n2021-09-15 11:11:51.590574: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcublas.so.10\r\n2021-09-15 11:11:51.590605: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcufft.so.10\r\n2021-09-15 11:11:51.590644: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcurand.so.10\r\n2021-09-15 11:11:51.590675: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcusolver.so.10\r\n2021-09-15 11:11:51.590705: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcusparse.so.10\r\n2021-09-15 11:11:51.590746: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudnn.so.7\r\n2021-09-15 11:11:51.596051: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1703] Adding visible gpu devices: 0\r\n2021-09-15 11:11:51.596120: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudart.so.10.1\r\n2021-09-15 11:11:51.601083: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1102] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2021-09-15 11:11:51.601108: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1108]      0 \r\n2021-09-15 11:11:51.601122: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1121] 0:   N \r\n2021-09-15 11:11:51.606684: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1247] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 37712 MB memory) -> physical GPU (device: 0, name: A100-PCIE-40GB, pci bus id: 0000:01:00.0, compute capability: 8.0)\r\n2.2.0.1\r\n['/g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/videos/']\r\n/g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/config.yaml\r\nStart Analyzing my video(s)!\r\nUsing snapshot-12000 for model /g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/dlc-models/iteration-0/C57j-Ph1-UN_LSJul6-trainset95shuffle1\r\nActivating extracting of PAFs\r\nAnalyzing all the videos in the directory...\r\nStarting to analyze %  /g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/videos/C57j-B1-Ph1-T2-UN_LS-DLC(2).mp4\r\n/g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/videos  already exists!\r\nLoading  /g/gross/Dorian2/Test_DLC/C57j-Ph1-UN_LS-Dorian_Battivelli-2021-07-06/videos/C57j-B1-Ph1-T2-UN_LS-DLC(2).mp4\r\nDuration of video [s]:  599.87 , recorded with  45.0 fps!\r\nOverall # of frames:  26994  found with (before cropping) frame dimensions:  2048 2036\r\nStarting to extract posture\r\n\r\n  0%|          | 0/26994 [00:00<?, ?it/s]\r\n  0%|          | 1/26994 [00:00<2:59:35,  2.50it/s]\r\n  0%|          | 3/26994 [00:00<1:08:05,  6.61it/s]\r\n  0%|          | 5/26994 [00:00<47:46,  9.41it/s]  \r\n  0%|          | 7/26994 [00:00<40:13, 11.18it/s]2021-09-15 11:25:03.345079: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudnn.so.7\r\n\r\n  0%|          | 7/26994 [00:19<40:13, 11.18it/s]slurmstepd: error: *** JOB 24768206 ON sb03-07 CANCELLED AT 2021-09-15T11:31:38 ***\n```\n\n\n### Anything else?\n\nI tried the conda installation with different versions of python (3.7 to 3.9) and tensorflow (2.0 to 2.6) but in neither of the cases the conda environment was functional for GPU computing or, in some cases, it wasn't possible to create the environment due to package conflicts.\n\n### Code of Conduct\n\n- [X] I agree to follow this project's [Code of Conduct](https://github.com/DeepLabCut/DeepLabCut/blob/master/CODE_OF_CONDUCT.md)","closed_by":{"login":"MMathisLab","id":28102185,"node_id":"MDQ6VXNlcjI4MTAyMTg1","avatar_url":"https://avatars.githubusercontent.com/u/28102185?v=4","gravatar_id":"","url":"https://api.github.com/users/MMathisLab","html_url":"https://github.com/MMathisLab","followers_url":"https://api.github.com/users/MMathisLab/followers","following_url":"https://api.github.com/users/MMathisLab/following{/other_user}","gists_url":"https://api.github.com/users/MMathisLab/gists{/gist_id}","starred_url":"https://api.github.com/users/MMathisLab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MMathisLab/subscriptions","organizations_url":"https://api.github.com/users/MMathisLab/orgs","repos_url":"https://api.github.com/users/MMathisLab/repos","events_url":"https://api.github.com/users/MMathisLab/events{/privacy}","received_events_url":"https://api.github.com/users/MMathisLab/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1508/timeline","performed_via_github_app":null,"state_reason":"completed"}