{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468","repository_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut","labels_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468/labels{/name}","comments_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468/comments","events_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468/events","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/1468","id":976430532,"node_id":"MDU6SXNzdWU5NzY0MzA1MzI=","number":1468,"title":"Memory Error During Video Analysis","user":{"login":"mfkeles","id":22876046,"node_id":"MDQ6VXNlcjIyODc2MDQ2","avatar_url":"https://avatars.githubusercontent.com/u/22876046?v=4","gravatar_id":"","url":"https://api.github.com/users/mfkeles","html_url":"https://github.com/mfkeles","followers_url":"https://api.github.com/users/mfkeles/followers","following_url":"https://api.github.com/users/mfkeles/following{/other_user}","gists_url":"https://api.github.com/users/mfkeles/gists{/gist_id}","starred_url":"https://api.github.com/users/mfkeles/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfkeles/subscriptions","organizations_url":"https://api.github.com/users/mfkeles/orgs","repos_url":"https://api.github.com/users/mfkeles/repos","events_url":"https://api.github.com/users/mfkeles/events{/privacy}","received_events_url":"https://api.github.com/users/mfkeles/received_events","type":"User","site_admin":false},"labels":[{"id":1853326151,"node_id":"MDU6TGFiZWwxODUzMzI2MTUx","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/WORK%20IN%20PROGRESS!","name":"WORK IN PROGRESS!","color":"d38028","default":false,"description":"developers are currently working on this feature... stay tuned."},{"id":2821804657,"node_id":"MDU6TGFiZWwyODIxODA0NjU3","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/labels/Tensorflow%202","name":"Tensorflow 2","color":"A2326D","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"assignees":[{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false}],"milestone":null,"comments":26,"created_at":"2021-08-22T17:40:50Z","updated_at":"2022-04-25T12:15:11Z","closed_at":"2021-12-16T10:34:46Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Bug description\n\nMemory fills up during video analysis. This issue happens using multi-animal model and attempting to analyze single video file containing 1.7 million frames at 1100x800 pixels. Following setups are tested, all failed to complete analysis due to memory issues :\r\n\r\n- TF2.5 Docker Container from Nvidia with DeepLabCut 2.2, dlcrnet\r\n- Windows 10 with DLC 2.2, dlcrnet\r\n- Ubuntu 20.04 with DLC 2.2, dlcrnet\r\n\r\nVideo was successfully analyzed with a single animal model (resnet-50), albeit with significant memory usage (30gb) using DLC 2.2. \r\n\r\n\r\n\r\n\r\n\r\n\n\n### Operating System\n\nTested the analysis in Windows 10, Ubuntu 20.04, and TF2.5 Nvidia Docker Container.\r\n\n\n### DeepLabCut version\n\ndlc version: 2.2\r\n\n\n### DeepLabCut mode\n\nmulti animal\n\n### Device type\n\ngpu - RTX3090\n\n### Steps To Reproduce\n\n1. Open DEEPLABCUT environment, created with the provided conda file.\r\n2. Use dlcrnet and attempt to analyze video. \r\n3. Memory slowly fills up (system has 64gb of memory). \r\n4. Error thrown related to not being able to allocate space for an array.\n\n### Relevant log output\n\n```shell\nMemoryError                               Traceback (most recent call last)\r\n<ipython-input-7-972df93ca544> in <module>\r\n----> 1 deeplabcut.analyze_videos(config,[vid_path],gputouse=2)\r\n\r\n~\\Desktop\\MK\\Git\\DeepLabCut\\deeplabcut\\pose_estimation_tensorflow\\predict_videos.py in analyze_videos(config, videos, videotype, shuffle, trainingsetindex, gputouse, save_as_csv, destfolder, batchsize, cropping, TFGPUinference, dynamic, modelprefix, robust_nframes, allow_growth)\r\n    286             )\r\n    287             for video in Videos:\r\n--> 288                 AnalyzeMultiAnimalVideo(\r\n    289                     video,\r\n    290                     DLCscorer,\r\n\r\n~\\Desktop\\MK\\Git\\DeepLabCut\\deeplabcut\\pose_estimation_tensorflow\\predict_multianimal.py in AnalyzeMultiAnimalVideo(video, DLCscorer, trainFraction, cfg, dlc_cfg, sess, inputs, outputs, destfolder, robust_nframes)\r\n     77         print(\"Starting to extract posture\")\r\n     78         if int(dlc_cfg[\"batch_size\"]) > 1:\r\n---> 79             PredicteData, nframes = GetPoseandCostsF(\r\n     80                 cfg,\r\n     81                 dlc_cfg,\r\n\r\n~\\Desktop\\MK\\Git\\DeepLabCut\\deeplabcut\\pose_estimation_tensorflow\\predict_multianimal.py in GetPoseandCostsF(cfg, dlc_cfg, sess, inputs, outputs, cap, nframes, batchsize)\r\n    145             inds.append(counter)\r\n    146             if batch_ind == batchsize - 1:\r\n--> 147                 D = predict.predict_batched_peaks_and_costs(\r\n    148                     dlc_cfg, frames, sess, inputs, outputs,\r\n    149                 )\r\n\r\n~\\Desktop\\MK\\Git\\DeepLabCut\\deeplabcut\\pose_estimation_tensorflow\\core\\predict_multianimal.py in predict_batched_peaks_and_costs(pose_cfg, images_batch, sess, inputs, outputs, peaks_gt, n_points, n_decimals)\r\n    208     n_decimals=3,\r\n    209 ):\r\n--> 210     scmaps, locrefs, pafs, peaks = sess.run(\r\n    211         outputs, feed_dict={inputs: images_batch}\r\n    212     )\r\n\r\n~\\anaconda3\\envs\\DEEPLABCUT\\lib\\site-packages\\tensorflow\\python\\client\\session.py in run(self, fetches, feed_dict, options, run_metadata)\r\n    965\r\n    966     try:\r\n--> 967       result = self._run(None, fetches, feed_dict, options_ptr,\r\n    968                          run_metadata_ptr)\r\n    969       if run_metadata:\r\n\r\n~\\anaconda3\\envs\\DEEPLABCUT\\lib\\site-packages\\tensorflow\\python\\client\\session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\r\n   1158             feed_handles[subfeed_t.ref()] = subfeed_val\r\n   1159           else:\r\n-> 1160             np_val = np.asarray(subfeed_val, dtype=subfeed_dtype)\r\n   1161\r\n   1162           if (not is_tensor_handle_feed and\r\n\r\n~\\anaconda3\\envs\\DEEPLABCUT\\lib\\site-packages\\numpy\\core\\_asarray.py in asarray(a, dtype, order)\r\n     81\r\n     82     \"\"\"\r\n---> 83     return array(a, dtype, copy=False, order=order)\r\n     84\r\n     85\r\n\r\nMemoryError: Unable to allocate 40.3 MiB for an array with shape (4, 800, 1100, 3) and data type float32\n```\n\n\n### Anything else?\n\nI would be happy to share my video file (14.5gb) along with the model for reproducibility. It is obviously a very large dataset and i am not sure if it is feasible to analyze this as a single file. I am aware of the built in video functions to split large files and would be happy to workaround this issue by splitting the video. That said, I am curious if there is a straightforward solution in the code that could work. \n\n### Code of Conduct\n\n- [X] I agree to follow this project's [Code of Conduct](https://github.com/DeepLabCut/DeepLabCut/blob/master/CODE_OF_CONDUCT.md)","closed_by":{"login":"jeylau","id":30733203,"node_id":"MDQ6VXNlcjMwNzMzMjAz","avatar_url":"https://avatars.githubusercontent.com/u/30733203?v=4","gravatar_id":"","url":"https://api.github.com/users/jeylau","html_url":"https://github.com/jeylau","followers_url":"https://api.github.com/users/jeylau/followers","following_url":"https://api.github.com/users/jeylau/following{/other_user}","gists_url":"https://api.github.com/users/jeylau/gists{/gist_id}","starred_url":"https://api.github.com/users/jeylau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeylau/subscriptions","organizations_url":"https://api.github.com/users/jeylau/orgs","repos_url":"https://api.github.com/users/jeylau/repos","events_url":"https://api.github.com/users/jeylau/events{/privacy}","received_events_url":"https://api.github.com/users/jeylau/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/1468/timeline","performed_via_github_app":null,"state_reason":"completed"}