[{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436217321","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/95#issuecomment-436217321","issue_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/95","id":436217321,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjIxNzMyMQ==","user":{"login":"mschart","id":17218515,"node_id":"MDQ6VXNlcjE3MjE4NTE1","avatar_url":"https://avatars.githubusercontent.com/u/17218515?v=4","gravatar_id":"","url":"https://api.github.com/users/mschart","html_url":"https://github.com/mschart","followers_url":"https://api.github.com/users/mschart/followers","following_url":"https://api.github.com/users/mschart/following{/other_user}","gists_url":"https://api.github.com/users/mschart/gists{/gist_id}","starred_url":"https://api.github.com/users/mschart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschart/subscriptions","organizations_url":"https://api.github.com/users/mschart/orgs","repos_url":"https://api.github.com/users/mschart/repos","events_url":"https://api.github.com/users/mschart/events{/privacy}","received_events_url":"https://api.github.com/users/mschart/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T11:12:58Z","updated_at":"2018-11-06T11:12:58Z","author_association":"NONE","body":"That AnalyseVideos.py works well:\r\n\r\n```\r\n\"\"\"\r\nDeepLabCut Toolbox\r\nhttps://github.com/AlexEMG/DeepLabCut\r\n\r\nA Mathis, alexander.mathis@bethgelab.org\r\nM Mathis, mackenzie@post.harvard.edu\r\n\r\nThis script analyzes videos based on a trained network (as specified in myconfig_analysis.py)\r\n\r\nYou need tensorflow for evaluation. Run by:\r\n\r\nCUDA_VISIBLE_DEVICES=0 python3 AnalyzeVideos.py\r\n\r\n\"\"\"\r\n\r\n####################################################\r\n# Dependencies\r\n####################################################\r\n\r\nimport os.path\r\nimport sys\r\nsubfolder = os.getcwd().split('Analysis-tools')[0]\r\nsys.path.append(subfolder)\r\n# add parent directory: (where nnet & config are!)\r\nsys.path.append(subfolder + \"pose-tensorflow\")\r\nsys.path.append(subfolder + \"Generating_a_Training_Set\")\r\n\r\nfrom myconfig_analysis import videofolder, cropping, Task, date, \\\r\n    trainingsFraction, resnet, snapshotindex, shuffle,x1, x2, y1, y2, videotype, storedata_as_csv\r\n\r\n# Deep-cut dependencies\r\nfrom config import load_config\r\nfrom nnet import predict\r\nfrom dataset.pose_dataset import data_to_input\r\n\r\n# Dependencies for video:\r\nimport pickle\r\n# import matplotlib.pyplot as plt\r\nimport imageio\r\nimageio.plugins.ffmpeg.download()\r\nfrom skimage.util import img_as_ubyte\r\nfrom moviepy.editor import VideoFileClip\r\nimport skimage\r\nimport skimage.color\r\nimport time\r\nimport pandas as pd\r\nimport numpy as np\r\nimport os\r\nfrom tqdm import tqdm\r\n\r\n\r\ndef getpose(image, cfg, outputs, outall=False):\r\n    ''' Adapted from DeeperCut, see pose-tensorflow folder'''\r\n    image_batch = data_to_input(skimage.color.gray2rgb(image))\r\n    outputs_np = sess.run(outputs, feed_dict={inputs: image_batch})\r\n    scmap, locref = predict.extract_cnn_output(outputs_np, cfg)\r\n    pose = predict.argmax_pose_predict(scmap, locref, cfg.stride)\r\n    if outall:\r\n        return scmap, locref, pose\r\n    else:\r\n        return pose\r\n\r\n\r\n####################################################\r\n# Loading data, and defining model folder\r\n####################################################\r\n\r\nbasefolder = os.path.join('..','pose-tensorflow','models')\r\nmodelfolder = os.path.join(basefolder, Task + str(date) + '-trainset' +\r\n               str(int(trainingsFraction * 100)) + 'shuffle' + str(shuffle))\r\n\r\ncfg = load_config(os.path.join(modelfolder , 'test' ,\"pose_cfg.yaml\"))\r\n\r\n##################################################\r\n# Load and setup CNN part detector\r\n##################################################\r\n\r\n# Check which snapshots are available and sort them by # iterations\r\nSnapshots = np.array([\r\n    fn.split('.')[0]\r\n    for fn in os.listdir(os.path.join(modelfolder , 'train'))\r\n    if \"index\" in fn\r\n])\r\nincreasing_indices = np.argsort([int(m.split('-')[1]) for m in Snapshots])\r\nSnapshots = Snapshots[increasing_indices]\r\n\r\nprint(modelfolder)\r\nprint(Snapshots)\r\n\r\n##################################################\r\n# Compute predictions over images\r\n##################################################\r\n\r\n# Check if data already was generated:\r\ncfg['init_weights'] = os.path.join(modelfolder , 'train', Snapshots[snapshotindex])\r\n\r\n# Name for scorer:\r\ntrainingsiterations = (cfg['init_weights'].split('/')[-1]).split('-')[-1]\r\n\r\n# Name for scorer:\r\nscorer = 'DeepCut' + \"_resnet\" + str(resnet) + \"_\" + Task + str(\r\n    date) + 'shuffle' + str(shuffle) + '_' + str(trainingsiterations)\r\n\r\n\r\ncfg['init_weights'] = os.path.join(modelfolder , 'train', Snapshots[snapshotindex])\r\nsess, inputs, outputs = predict.setup_pose_prediction(cfg)\r\npdindex = pd.MultiIndex.from_product(\r\n    [[scorer], cfg['all_joints_names'], ['x', 'y', 'likelihood']],\r\n    names=['scorer', 'bodyparts', 'coords'])\r\n\r\n##################################################\r\n# Datafolder\r\n##################################################\r\n\r\n# videofolder='../videos/' #where your folder with videos is.\r\nframe_buffer = 10\r\n\r\nos.chdir(videofolder)\r\nvideos = np.sort([fn for fn in os.listdir(os.curdir) if (videotype in fn)])\r\nprint(\"Starting \", videofolder, videos)\r\nfor video in videos:\r\n    dataname = video.split('.')[0] + scorer + '.h5'\r\n    try:\r\n        # Attempt to load data...\r\n        pd.read_hdf(dataname)\r\n        print(\"Video already analyzed!\", dataname)\r\n    except FileNotFoundError:\r\n        print(\"Loading \", video)\r\n        clip = VideoFileClip(video)\r\n        ny, nx = clip.size  # dimensions of frame (height, width)\r\n        fps = clip.fps\r\n        #nframes = np.sum(1 for j in clip.iter_frames()) #this is slow (but accurate)\r\n        nframes_approx = int(np.ceil(clip.duration * clip.fps) + frame_buffer)\r\n        # this will overestimage number of frames (see https://github.com/AlexEMG/DeepLabCut/issues/9) This is especially a problem\r\n        # for high frame rates and long durations due to rounding errors (as Rich Warren found). Later we crop the result (line 187)\r\n        \r\n        if cropping:\r\n            clip = clip.crop(\r\n                y1=y1, y2=y2, x1=x1, x2=x2)  # one might want to adjust\r\n\r\n        print(\"Duration of video [s]: \", clip.duration, \", recorded with \", fps,\r\n              \"fps!\")\r\n        print(\"Overall # of frames: \", nframes_approx,\"with cropped frame dimensions: \", clip.size)\r\n\r\n        start = time.time()\r\n        PredicteData = np.zeros((nframes_approx, 3 * len(cfg['all_joints_names'])))\r\n        clip.reader.initialize()\r\n        print(\"Starting to extract posture\")\r\n        for index in tqdm(range(nframes_approx)):\r\n            #image = img_as_ubyte(clip.get_frame(index * 1. / fps))\r\n            image = img_as_ubyte(clip.reader.read_frame())\r\n            # Thanks to Rick Warren for the  following snipplet:\r\n            # if close to end of video, start checking whether two adjacent frames are identical\r\n            # this should only happen when moviepy has reached the final frame\r\n            # if two adjacent frames are identical, terminate the loop\r\n            if index==int(nframes_approx-frame_buffer*2):\r\n                last_image = image\r\n            elif index>int(nframes_approx-frame_buffer*2):\r\n                if (image==last_image).all():\r\n                    nframes = index\r\n                    print(\"Detected frames: \", nframes)\r\n                    break\r\n                else:\r\n                    last_image = image\r\n            pose = getpose(image, cfg, outputs)\r\n            PredicteData[index, :] = pose.flatten()  # NOTE: thereby cfg['all_joints_names'] should be same order as bodyparts!\r\n\r\n        stop = time.time()\r\n\r\n        dictionary = {\r\n            \"start\": start,\r\n            \"stop\": stop,\r\n            \"run_duration\": stop - start,\r\n            \"Scorer\": scorer,\r\n            \"config file\": cfg,\r\n            \"fps\": fps,\r\n            \"frame_dimensions\": (ny, nx),\r\n            \"nframes\": nframes\r\n        }\r\n        metadata = {'data': dictionary}\r\n\r\n        print(\"Saving results...\")\r\n        DataMachine = pd.DataFrame(PredicteData[:nframes,:], columns=pdindex, index=range(nframes)) #slice pose data to have same # as # of frames.\r\n        DataMachine.to_hdf(dataname, 'df_with_missing', format='table', mode='w')\r\n        \r\n        if storedata_as_csv:\r\n            DataMachine.to_csv(video.split('.')[0] + scorer+'.csv')\r\n        \r\n        with open(dataname.split('.')[0] + 'includingmetadata.pickle',\r\n                  'wb') as f:\r\n            pickle.dump(metadata, f, pickle.HIGHEST_PROTOCOL)\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436217321/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschart","id":17218515,"node_id":"MDQ6VXNlcjE3MjE4NTE1","avatar_url":"https://avatars.githubusercontent.com/u/17218515?v=4","gravatar_id":"","url":"https://api.github.com/users/mschart","html_url":"https://github.com/mschart","followers_url":"https://api.github.com/users/mschart/followers","following_url":"https://api.github.com/users/mschart/following{/other_user}","gists_url":"https://api.github.com/users/mschart/gists{/gist_id}","starred_url":"https://api.github.com/users/mschart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschart/subscriptions","organizations_url":"https://api.github.com/users/mschart/orgs","repos_url":"https://api.github.com/users/mschart/repos","events_url":"https://api.github.com/users/mschart/events{/privacy}","received_events_url":"https://api.github.com/users/mschart/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436295730","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/95#issuecomment-436295730","issue_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/95","id":436295730,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjI5NTczMA==","user":{"login":"triccelli","id":40061802,"node_id":"MDQ6VXNlcjQwMDYxODAy","avatar_url":"https://avatars.githubusercontent.com/u/40061802?v=4","gravatar_id":"","url":"https://api.github.com/users/triccelli","html_url":"https://github.com/triccelli","followers_url":"https://api.github.com/users/triccelli/followers","following_url":"https://api.github.com/users/triccelli/following{/other_user}","gists_url":"https://api.github.com/users/triccelli/gists{/gist_id}","starred_url":"https://api.github.com/users/triccelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/triccelli/subscriptions","organizations_url":"https://api.github.com/users/triccelli/orgs","repos_url":"https://api.github.com/users/triccelli/repos","events_url":"https://api.github.com/users/triccelli/events{/privacy}","received_events_url":"https://api.github.com/users/triccelli/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T15:35:20Z","updated_at":"2018-11-06T15:35:20Z","author_association":"NONE","body":"I had the same problem- it works fine when using an older version of analyzevideos","reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436295730/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"triccelli","id":40061802,"node_id":"MDQ6VXNlcjQwMDYxODAy","avatar_url":"https://avatars.githubusercontent.com/u/40061802?v=4","gravatar_id":"","url":"https://api.github.com/users/triccelli","html_url":"https://github.com/triccelli","followers_url":"https://api.github.com/users/triccelli/followers","following_url":"https://api.github.com/users/triccelli/following{/other_user}","gists_url":"https://api.github.com/users/triccelli/gists{/gist_id}","starred_url":"https://api.github.com/users/triccelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/triccelli/subscriptions","organizations_url":"https://api.github.com/users/triccelli/orgs","repos_url":"https://api.github.com/users/triccelli/repos","events_url":"https://api.github.com/users/triccelli/events{/privacy}","received_events_url":"https://api.github.com/users/triccelli/received_events","type":"User","site_admin":false}},{"id":1949313630,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQxOTQ5MzEzNjMw","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/events/1949313630","actor":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2018-11-06T15:48:18Z","assignee":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436304988","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/95#issuecomment-436304988","issue_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/95","id":436304988,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjMwNDk4OA==","user":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T15:58:48Z","updated_at":"2018-11-06T16:02:54Z","author_association":"MEMBER","body":"I cannot reproduce this error....\r\n\r\nOh, I see now what is happening. It works at my end because my video folder is in DLC/videos and the analsyis script in DLC/Analysis-tools/ etc. Thus \r\n\r\n```\r\nbasefolder = os.path.join('..','pose-tensorflow','models')\r\nmodelfolder = os.path.join(basefolder, Task + str(date) + '-trainset' +\r\n               str(int(trainingsFraction * 100)) + 'shuffle' + str(shuffle))\r\n\r\ncfg = load_config(os.path.join(modelfolder , 'test' ,\"pose_cfg.yaml\"))\r\n```\r\n\r\ngives me the same path, but that is not true if your video folder is somewhere else... Anyway, easy to fix (by moving line 179 and 180 before line 167). Will do so and push. Thanks for raising this!","reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436304988/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436315316","html_url":"https://github.com/DeepLabCut/DeepLabCut/issues/95#issuecomment-436315316","issue_url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/95","id":436315316,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjMxNTMxNg==","user":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T16:25:51Z","updated_at":"2018-11-06T17:56:19Z","author_association":"MEMBER","body":"Ok, I pushed an update, that works no matter, where your video folder is (as previously before the batch processing update). Thanks for raising this. ","reactions":{"url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/comments/436315316/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false}},{"id":1949431014,"node_id":"MDExOkNsb3NlZEV2ZW50MTk0OTQzMTAxNA==","url":"https://api.github.com/repos/DeepLabCut/DeepLabCut/issues/events/1949431014","actor":{"login":"AlexEMG","id":20850270,"node_id":"MDQ6VXNlcjIwODUwMjcw","avatar_url":"https://avatars.githubusercontent.com/u/20850270?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexEMG","html_url":"https://github.com/AlexEMG","followers_url":"https://api.github.com/users/AlexEMG/followers","following_url":"https://api.github.com/users/AlexEMG/following{/other_user}","gists_url":"https://api.github.com/users/AlexEMG/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexEMG/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexEMG/subscriptions","organizations_url":"https://api.github.com/users/AlexEMG/orgs","repos_url":"https://api.github.com/users/AlexEMG/repos","events_url":"https://api.github.com/users/AlexEMG/events{/privacy}","received_events_url":"https://api.github.com/users/AlexEMG/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2018-11-06T16:25:51Z","state_reason":null,"performed_via_github_app":null}]