{"url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85","repository_url":"https://api.github.com/repos/nikitakit/self-attentive-parser","labels_url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85/labels{/name}","comments_url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85/comments","events_url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85/events","html_url":"https://github.com/nikitakit/self-attentive-parser/issues/85","id":934299846,"node_id":"MDU6SXNzdWU5MzQyOTk4NDY=","number":85,"title":"Spacy and Berkeley parser Multi-processing","user":{"login":"hardianlawi","id":22806872,"node_id":"MDQ6VXNlcjIyODA2ODcy","avatar_url":"https://avatars.githubusercontent.com/u/22806872?v=4","gravatar_id":"","url":"https://api.github.com/users/hardianlawi","html_url":"https://github.com/hardianlawi","followers_url":"https://api.github.com/users/hardianlawi/followers","following_url":"https://api.github.com/users/hardianlawi/following{/other_user}","gists_url":"https://api.github.com/users/hardianlawi/gists{/gist_id}","starred_url":"https://api.github.com/users/hardianlawi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hardianlawi/subscriptions","organizations_url":"https://api.github.com/users/hardianlawi/orgs","repos_url":"https://api.github.com/users/hardianlawi/repos","events_url":"https://api.github.com/users/hardianlawi/events{/privacy}","received_events_url":"https://api.github.com/users/hardianlawi/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-01T02:26:23Z","updated_at":"2021-08-05T08:00:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I'm trying to make the multi-processing spacy pipeline works with the berkeley parser as I assume it will boost the performance. How can I get it to work? I tried the suggestion from [here](https://spacy.io/usage/processing-pipelines#multiprocessing), but it didn't work for me.\r\n\r\n![image](https://user-images.githubusercontent.com/22806872/124054709-1daec380-da55-11eb-8586-0f85aaf8d414.png)\r\n\r\n```python\r\nimport multiprocessing as mp\r\nimport torch\r\n\r\nmp.set_start_method('spawn')\r\ntorch.set_num_threads(1)\r\n\r\n\r\nimport spacy\r\nimport benepar\r\n\r\nbenepar.download(\"benepar_en3\")\r\n\r\nnlp = spacy.load(\"en_core_web_md\")\r\nif spacy.__version__.startswith(\"2\"):\r\n    nlp.add_pipe(benepar.BeneparComponent(\"benepar_en3\"))\r\nelse:\r\n    nlp.add_pipe(\"benepar\", config={\"model\": \"benepar_en3\"})\r\n\r\ndocs = nlp.pipe(['The time for action is now. It is never too late to do something.', 'The time for action is now. It is never too late to do something.'], n_process=2)\r\n```\r\n\r\nError message\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nAttributeError                            Traceback (most recent call last)\r\n<ipython-input-2-d850341268c5> in <module>\r\n----> 1 for doc in docs:\r\n      2     break\r\n      3\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/site-packages/spacy/language.py in pipe(self, texts, as_tuples, batch_size, disable, component_cfg, n_process)\r\n   1482             for pipe in pipes:\r\n   1483                 docs = pipe(docs)\r\n-> 1484         for doc in docs:\r\n   1485             yield doc\r\n   1486\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/site-packages/spacy/language.py in _multiprocessing_pipe(self, texts, pipes, n_process, batch_size)\r\n   1518         ]\r\n   1519         for proc in procs:\r\n-> 1520             proc.start()\r\n   1521\r\n   1522         # Cycle channels not to break the order of docs.\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/process.py in start(self)\r\n    119                'daemonic processes are not allowed to have children'\r\n    120         _cleanup()\r\n--> 121         self._popen = self._Popen(self)\r\n    122         self._sentinel = self._popen.sentinel\r\n    123         # Avoid a refcycle if the target function holds an indirect\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/context.py in _Popen(process_obj)\r\n    222     @staticmethod\r\n    223     def _Popen(process_obj):\r\n--> 224         return _default_context.get_context().Process._Popen(process_obj)\r\n    225\r\n    226 class DefaultContext(BaseContext):\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/context.py in _Popen(process_obj)\r\n    282         def _Popen(process_obj):\r\n    283             from .popen_spawn_posix import Popen\r\n--> 284             return Popen(process_obj)\r\n    285\r\n    286     class ForkServerProcess(process.BaseProcess):\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/popen_spawn_posix.py in __init__(self, process_obj)\r\n     30     def __init__(self, process_obj):\r\n     31         self._fds = []\r\n---> 32         super().__init__(process_obj)\r\n     33\r\n     34     def duplicate_for_child(self, fd):\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/popen_fork.py in __init__(self, process_obj)\r\n     17         self.returncode = None\r\n     18         self.finalizer = None\r\n---> 19         self._launch(process_obj)\r\n     20\r\n     21     def duplicate_for_child(self, fd):\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/popen_spawn_posix.py in _launch(self, process_obj)\r\n     45         try:\r\n     46             reduction.dump(prep_data, fp)\r\n---> 47             reduction.dump(process_obj, fp)\r\n     48         finally:\r\n     49             set_spawning_popen(None)\r\n\r\n~/miniforge3/envs/pod-classification/lib/python3.9/multiprocessing/reduction.py in dump(obj, file, protocol)\r\n     58 def dump(obj, file, protocol=None):\r\n     59     '''Replacement for pickle.dump() using ForkingPickler.'''\r\n---> 60     ForkingPickler(file, protocol).dump(obj)\r\n     61\r\n     62 #\r\n\r\nAttributeError: Can't pickle local object 'install_spacy_extensions.<locals>.<lambda>'\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/nikitakit/self-attentive-parser/issues/85/timeline","performed_via_github_app":null,"state_reason":null}