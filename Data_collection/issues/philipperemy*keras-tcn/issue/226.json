{"url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226","repository_url":"https://api.github.com/repos/philipperemy/keras-tcn","labels_url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226/labels{/name}","comments_url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226/comments","events_url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226/events","html_url":"https://github.com/philipperemy/keras-tcn/issues/226","id":1161034616,"node_id":"I_kwDOB4a3hs5FM_t4","number":226,"title":"Incorrect receptive field","user":{"login":"d-01","id":45796739,"node_id":"MDQ6VXNlcjQ1Nzk2NzM5","avatar_url":"https://avatars.githubusercontent.com/u/45796739?v=4","gravatar_id":"","url":"https://api.github.com/users/d-01","html_url":"https://github.com/d-01","followers_url":"https://api.github.com/users/d-01/followers","following_url":"https://api.github.com/users/d-01/following{/other_user}","gists_url":"https://api.github.com/users/d-01/gists{/gist_id}","starred_url":"https://api.github.com/users/d-01/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/d-01/subscriptions","organizations_url":"https://api.github.com/users/d-01/orgs","repos_url":"https://api.github.com/users/d-01/repos","events_url":"https://api.github.com/users/d-01/events{/privacy}","received_events_url":"https://api.github.com/users/d-01/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-07T08:02:36Z","updated_at":"2022-07-05T15:40:12Z","closed_at":"2022-03-10T17:51:36Z","author_association":"NONE","active_lock_reason":null,"body":"## A description of what the bug is\r\n\r\nThere are two problems with a receptive field:\r\n\r\n1. An effective receptive field size (see tests below) doesn't match a calculated size (`receptive_field` attribute).\r\n1. TCN layer with dilation=1 have holes (blind spots) in a receptive field.\r\n\r\n## A snippet\r\n\r\nThe test code demonstrates which positions in the input sequence affect the output.\r\n\r\nTest code ([Google Colab](https://colab.research.google.com/drive/1dvuM5D5MK2d_8TzVhImoPkzkQ7E7efHS?usp=sharing)):\r\n\r\n```python\r\nimport numpy as np\r\nfrom tcn import TCN\r\nimport tensorflow as tf  # 2.8.0\r\n\r\ndef test_inference(seq, tcn):\r\n    '''Perform inference with TCN layer, print input and output.'''\r\n    batch = np.asarray(seq, dtype=np.float32)[None, ..., None]\r\n    output = tcn(batch).numpy().squeeze()\r\n    print('input: {}; output: {:.4f}'.format(' '.join(map(str, seq)), output))\r\n    \r\ntf.random.set_seed(333)\r\ntcn = TCN(nb_filters=1, kernel_size=2, dilations=(1, 2), return_sequences=False)\r\nprint(f'k={tcn.kernel_size}, dilations={tcn.dilations}, receptive_field={tcn.receptive_field}')\r\n\r\nTEST_SEQ_LEN = 10\r\nfor i in range(TEST_SEQ_LEN):\r\n    print(i, end='. ')\r\n    test_seq = list(range(TEST_SEQ_LEN))\r\n    test_seq[i] = 0\r\n    test_inference(test_seq[1:][::-1], tcn)\r\n```\r\n\r\n## Actual result\r\n\r\nOutput (with comments):\r\n\r\n```\r\nk=2, dilations=(1, 2), receptive_field=7\r\n\r\n0. input: 9 8 7 6 5 4 3 2 1; output: 8.5691  base output (unmodified)\r\n1. input: 9 8 7 6 5 4 3 2 0; output: 9.537   changed\r\n2. input: 9 8 7 6 5 4 3 0 1; output: 8.5691  does not reflect changes in input\r\n3. input: 9 8 7 6 5 4 0 2 1; output: 7.0454  changed\r\n4. input: 9 8 7 6 5 0 3 2 1; output: 8.5691  does not reflect changes in input\r\n5. input: 9 8 7 6 0 4 3 2 1; output: 2.9412  changed\r\n6. input: 9 8 7 0 5 4 3 2 1; output: 8.5691  does not reflect changes in input\r\n7. input: 9 8 0 6 5 4 3 2 1; output: 8.5691  does not reflect changes in input\r\n8. input: 9 0 7 6 5 4 3 2 1; output: 8.5691  outside of receptive field\r\n9. input: 0 8 7 6 5 4 3 2 1; output: 8.5691  outside of receptive field\r\n                  _   _   _                  elements model \"sees\" in the input\r\n              * * * * * * *                  receptive field indicator\r\n```\r\n\r\n* Actual receptive field size is 5, not 7.\r\n* 2nd and 4th positions in the receptive field do not affect the output.\r\n\r\n## Expected result\r\n\r\nEvery element in the input sequence covered by receptive field affects the output.\r\n\r\n## Dependencies\r\n\r\n* environment – Google Colab\r\n* python – 3.7.12 (default, Jan 15 2022, 18:48:18)\r\n* tensorflow – 2.8.0\r\n* keras-tcn – 3.4.0","closed_by":{"login":"d-01","id":45796739,"node_id":"MDQ6VXNlcjQ1Nzk2NzM5","avatar_url":"https://avatars.githubusercontent.com/u/45796739?v=4","gravatar_id":"","url":"https://api.github.com/users/d-01","html_url":"https://github.com/d-01","followers_url":"https://api.github.com/users/d-01/followers","following_url":"https://api.github.com/users/d-01/following{/other_user}","gists_url":"https://api.github.com/users/d-01/gists{/gist_id}","starred_url":"https://api.github.com/users/d-01/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/d-01/subscriptions","organizations_url":"https://api.github.com/users/d-01/orgs","repos_url":"https://api.github.com/users/d-01/repos","events_url":"https://api.github.com/users/d-01/events{/privacy}","received_events_url":"https://api.github.com/users/d-01/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/philipperemy/keras-tcn/issues/226/timeline","performed_via_github_app":null,"state_reason":"completed"}