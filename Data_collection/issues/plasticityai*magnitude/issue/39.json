{"url":"https://api.github.com/repos/plasticityai/magnitude/issues/39","repository_url":"https://api.github.com/repos/plasticityai/magnitude","labels_url":"https://api.github.com/repos/plasticityai/magnitude/issues/39/labels{/name}","comments_url":"https://api.github.com/repos/plasticityai/magnitude/issues/39/comments","events_url":"https://api.github.com/repos/plasticityai/magnitude/issues/39/events","html_url":"https://github.com/plasticityai/magnitude/issues/39","id":384559247,"node_id":"MDU6SXNzdWUzODQ1NTkyNDc=","number":39,"title":"Database disk image malformed with multiprocessing","user":{"login":"jacobzweig","id":2703695,"node_id":"MDQ6VXNlcjI3MDM2OTU=","avatar_url":"https://avatars.githubusercontent.com/u/2703695?v=4","gravatar_id":"","url":"https://api.github.com/users/jacobzweig","html_url":"https://github.com/jacobzweig","followers_url":"https://api.github.com/users/jacobzweig/followers","following_url":"https://api.github.com/users/jacobzweig/following{/other_user}","gists_url":"https://api.github.com/users/jacobzweig/gists{/gist_id}","starred_url":"https://api.github.com/users/jacobzweig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jacobzweig/subscriptions","organizations_url":"https://api.github.com/users/jacobzweig/orgs","repos_url":"https://api.github.com/users/jacobzweig/repos","events_url":"https://api.github.com/users/jacobzweig/events{/privacy}","received_events_url":"https://api.github.com/users/jacobzweig/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-11-26T23:48:03Z","updated_at":"2021-04-03T19:25:36Z","closed_at":"2018-12-28T22:05:34Z","author_association":"NONE","active_lock_reason":null,"body":"Hi @AjayP13, I was curious if you had any examples of how you've used this with multiprocessing previously. I'm bumping into a pysqlite error when I try to run with multiprocessing:\r\n\r\n```python\r\ncoord = tf.train.Coordinator()\r\nprocesses = []\r\nfor i in range(num_processes):\r\n    args = (texts_sliced[i], labels_sliced[i], output_files[i], concatenated_embeddings)\r\n    p = Process(target=_convert_shard, args=args)\r\n    p.start()\r\n    processes.append(p)\r\ncoord.join(processes)\r\n```\r\n\r\n```python\r\n  File \"/home/jacob/test.py\", line 454, in _convert_shard \r\n    text_embedding = embedding.query(text) \r\n  File \"/home/jacob/anaconda3/pymagnitude/third_party/repoze/lru/__init__.py\", line 390, in cached_wrapper                                                                 \r\n    val = func(*args, **kwargs) \r\npysqlite2.dbapi2.DatabaseError: database disk image is malformed                                                         \r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 2088, in query\r\n    for i, m in enumerate(self.magnitudes)]\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 2088, in <listcomp>\r\n    for i, m in enumerate(self.magnitudes)] \r\n  File \"/home/jacob/anaconda3/pymagnitude/third_party/repoze/lru/__init__.py\", line 390, in cached_wrapper\r\n    val = func(*args, **kwargs)\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 1221, in query\r\n    vectors = self._vectors_for_keys_cached(q, normalized)\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 1109, in _vectors_for_keys_cached \r\n    unseen_keys[i], normalized, force=force)\r\n  File \"/home/jacob/anaconda3/pymagnitude/third_party/repoze/lru/__init__.py\", line 390, in cached_wrapper \r\n    val = func(*args, **kwargs)\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 483, in _out_of_vocab_vector_cached\r\n    return self._out_of_vocab_vector(*args, **kwargs)\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 992, in _out_of_vocab_vector, normalized=normalized)\r\n  File \"/home/jacob/anaconda3/pymagnitude/__init__.py\", line 829, in _db_query_similar_keys_vector, params).fetchall()   \r\npysqlite2.dbapi2.DatabaseError: database disk image is malformed\r\n```\r\nI've tried reloading the `.Magnitude` files as well as setting `blocking=True`, but can't seem to get around it. Any ideas?\r\n\r\nThanks!","closed_by":{"login":"jacobzweig","id":2703695,"node_id":"MDQ6VXNlcjI3MDM2OTU=","avatar_url":"https://avatars.githubusercontent.com/u/2703695?v=4","gravatar_id":"","url":"https://api.github.com/users/jacobzweig","html_url":"https://github.com/jacobzweig","followers_url":"https://api.github.com/users/jacobzweig/followers","following_url":"https://api.github.com/users/jacobzweig/following{/other_user}","gists_url":"https://api.github.com/users/jacobzweig/gists{/gist_id}","starred_url":"https://api.github.com/users/jacobzweig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jacobzweig/subscriptions","organizations_url":"https://api.github.com/users/jacobzweig/orgs","repos_url":"https://api.github.com/users/jacobzweig/repos","events_url":"https://api.github.com/users/jacobzweig/events{/privacy}","received_events_url":"https://api.github.com/users/jacobzweig/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/plasticityai/magnitude/issues/39/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/plasticityai/magnitude/issues/39/timeline","performed_via_github_app":null,"state_reason":"completed"}