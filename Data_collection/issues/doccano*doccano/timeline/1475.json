[{"url":"https://api.github.com/repos/doccano/doccano/issues/comments/904261149","html_url":"https://github.com/doccano/doccano/issues/1475#issuecomment-904261149","issue_url":"https://api.github.com/repos/doccano/doccano/issues/1475","id":904261149,"node_id":"IC_kwDOB-j9wM415e4d","user":{"login":"YosuaMichael","id":3679860,"node_id":"MDQ6VXNlcjM2Nzk4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/3679860?v=4","gravatar_id":"","url":"https://api.github.com/users/YosuaMichael","html_url":"https://github.com/YosuaMichael","followers_url":"https://api.github.com/users/YosuaMichael/followers","following_url":"https://api.github.com/users/YosuaMichael/following{/other_user}","gists_url":"https://api.github.com/users/YosuaMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/YosuaMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YosuaMichael/subscriptions","organizations_url":"https://api.github.com/users/YosuaMichael/orgs","repos_url":"https://api.github.com/users/YosuaMichael/repos","events_url":"https://api.github.com/users/YosuaMichael/events{/privacy}","received_events_url":"https://api.github.com/users/YosuaMichael/received_events","type":"User","site_admin":false},"created_at":"2021-08-24T02:03:50Z","updated_at":"2021-08-24T02:03:50Z","author_association":"NONE","body":"Hi, I have been debugging the problem and I think I found the reason why (although I am still not sure the best way to fix it).\r\n\r\nSo to illustrate the problem, consider the scenario where we deploy doccano into two server A and B. I have two scenarios that produce different errors:\r\nScenario 1:\r\n\r\n- When we are in upload page and choose file (or drop them) it will be successful and a temporary file (in `/doccano/backend/filepond-temp-uploads` folder) is created on A but note that B **dont** have the temporary file!\r\n- After that when we click the button Injest, the load balancer actually direct this request to B. And since B dont have the temporary file, it got error when it tried to move it into the folder `/doccano/backend/media`\r\n- This will result in error message: `Error moving temporary file to permanent storage location`\r\n\r\nScenario 2:\r\n\r\n- When we are in upload page and choose file (or drop them) it will be successful and a temporary file (in `/doccano/backend/filepond-temp-uploads` folder) is created on A but note that B **dont** have the temporary file!\r\n- After that when we click the button Injest, it seems loading and the load balancer direct the request to A (so A have both file in `filepond-temp-uploads` and `media` folder). However after a while the injest still failed and got error message from server B.\r\n- The error message in B is like: `FileNotFoundError: [Errno 2] No such file or directory: '/doccano/backend/media/5ohBU5hebFUcSo7Qi8Z4gq/YfTPmYLuJCzdFCR62KfVCM/sample_poi.ndjson'`\r\n\r\nSo basically for scenario 1, the error is clear because the temporary file is not shared and the load balancer assign different server when we drop the file and when we click injest.\r\n\r\nFor scenario 2, I am not too sure why, but my guess is after the file properly uploaded, a task is created (through rabbitmq) to read and process it into DB. And the one doing this task is the server that dont have the file.\r\n\r\nI hope this make the problem clearer and I hope this can be fixed... (feel free to ask for more detail!).\r\n\r\nThanks,\r\nYosua\r\n","reactions":{"url":"https://api.github.com/repos/doccano/doccano/issues/comments/904261149/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"YosuaMichael","id":3679860,"node_id":"MDQ6VXNlcjM2Nzk4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/3679860?v=4","gravatar_id":"","url":"https://api.github.com/users/YosuaMichael","html_url":"https://github.com/YosuaMichael","followers_url":"https://api.github.com/users/YosuaMichael/followers","following_url":"https://api.github.com/users/YosuaMichael/following{/other_user}","gists_url":"https://api.github.com/users/YosuaMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/YosuaMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YosuaMichael/subscriptions","organizations_url":"https://api.github.com/users/YosuaMichael/orgs","repos_url":"https://api.github.com/users/YosuaMichael/repos","events_url":"https://api.github.com/users/YosuaMichael/events{/privacy}","received_events_url":"https://api.github.com/users/YosuaMichael/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/doccano/doccano/issues/comments/907088513","html_url":"https://github.com/doccano/doccano/issues/1475#issuecomment-907088513","issue_url":"https://api.github.com/repos/doccano/doccano/issues/1475","id":907088513,"node_id":"IC_kwDOB-j9wM42ERKB","user":{"login":"YosuaMichael","id":3679860,"node_id":"MDQ6VXNlcjM2Nzk4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/3679860?v=4","gravatar_id":"","url":"https://api.github.com/users/YosuaMichael","html_url":"https://github.com/YosuaMichael","followers_url":"https://api.github.com/users/YosuaMichael/followers","following_url":"https://api.github.com/users/YosuaMichael/following{/other_user}","gists_url":"https://api.github.com/users/YosuaMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/YosuaMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YosuaMichael/subscriptions","organizations_url":"https://api.github.com/users/YosuaMichael/orgs","repos_url":"https://api.github.com/users/YosuaMichael/repos","events_url":"https://api.github.com/users/YosuaMichael/events{/privacy}","received_events_url":"https://api.github.com/users/YosuaMichael/received_events","type":"User","site_admin":false},"created_at":"2021-08-27T10:08:43Z","updated_at":"2021-08-27T10:08:43Z","author_association":"NONE","body":"Hi,\r\n\r\nI want to update that I have solved the problem for multi-server doccano deployment  in my environment. My solution is to use a shared storage among the server to store the temporary file during the upload (I use [AzureFile](https://docs.microsoft.com/en-us/azure/aks/azure-files-volume) ). \r\n\r\nAnd if we use the shared storage, I got the error because both django and django-drf-filepond try to change permission of the file but it is not allowed on the shared storage. To solve this I did two things:\r\n\r\n1. Add `FILE_UPLOAD_PERMISSIONS = None` on `backend/app/settings.py` so django dont try to change the file permission\r\n2. Patch the `store_upload` function of `django-drf-filepond` that get called in `backend/api/views/import_dataset.py` to make sure it use `shutil.copyfile` instead of `shutil.copy2`.\r\n\r\nHope this can help people who encounter similar issue.","reactions":{"url":"https://api.github.com/repos/doccano/doccano/issues/comments/907088513/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"YosuaMichael","id":3679860,"node_id":"MDQ6VXNlcjM2Nzk4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/3679860?v=4","gravatar_id":"","url":"https://api.github.com/users/YosuaMichael","html_url":"https://github.com/YosuaMichael","followers_url":"https://api.github.com/users/YosuaMichael/followers","following_url":"https://api.github.com/users/YosuaMichael/following{/other_user}","gists_url":"https://api.github.com/users/YosuaMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/YosuaMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YosuaMichael/subscriptions","organizations_url":"https://api.github.com/users/YosuaMichael/orgs","repos_url":"https://api.github.com/users/YosuaMichael/repos","events_url":"https://api.github.com/users/YosuaMichael/events{/privacy}","received_events_url":"https://api.github.com/users/YosuaMichael/received_events","type":"User","site_admin":false}},{"id":5217749838,"node_id":"MDExOkNsb3NlZEV2ZW50NTIxNzc0OTgzOA==","url":"https://api.github.com/repos/doccano/doccano/issues/events/5217749838","actor":{"login":"YosuaMichael","id":3679860,"node_id":"MDQ6VXNlcjM2Nzk4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/3679860?v=4","gravatar_id":"","url":"https://api.github.com/users/YosuaMichael","html_url":"https://github.com/YosuaMichael","followers_url":"https://api.github.com/users/YosuaMichael/followers","following_url":"https://api.github.com/users/YosuaMichael/following{/other_user}","gists_url":"https://api.github.com/users/YosuaMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/YosuaMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YosuaMichael/subscriptions","organizations_url":"https://api.github.com/users/YosuaMichael/orgs","repos_url":"https://api.github.com/users/YosuaMichael/repos","events_url":"https://api.github.com/users/YosuaMichael/events{/privacy}","received_events_url":"https://api.github.com/users/YosuaMichael/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-08-27T10:08:43Z","state_reason":null,"performed_via_github_app":null}]