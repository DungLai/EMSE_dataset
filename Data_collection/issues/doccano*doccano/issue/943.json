{"url":"https://api.github.com/repos/doccano/doccano/issues/943","repository_url":"https://api.github.com/repos/doccano/doccano","labels_url":"https://api.github.com/repos/doccano/doccano/issues/943/labels{/name}","comments_url":"https://api.github.com/repos/doccano/doccano/issues/943/comments","events_url":"https://api.github.com/repos/doccano/doccano/issues/943/events","html_url":"https://github.com/doccano/doccano/issues/943","id":671653897,"node_id":"MDU6SXNzdWU2NzE2NTM4OTc=","number":943,"title":"[Bug report] 500 error on annotation remove","user":{"login":"kuraga","id":1063219,"node_id":"MDQ6VXNlcjEwNjMyMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1063219?v=4","gravatar_id":"","url":"https://api.github.com/users/kuraga","html_url":"https://github.com/kuraga","followers_url":"https://api.github.com/users/kuraga/followers","following_url":"https://api.github.com/users/kuraga/following{/other_user}","gists_url":"https://api.github.com/users/kuraga/gists{/gist_id}","starred_url":"https://api.github.com/users/kuraga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuraga/subscriptions","organizations_url":"https://api.github.com/users/kuraga/orgs","repos_url":"https://api.github.com/users/kuraga/repos","events_url":"https://api.github.com/users/kuraga/events{/privacy}","received_events_url":"https://api.github.com/users/kuraga/received_events","type":"User","site_admin":false},"labels":[{"id":927327719,"node_id":"MDU6TGFiZWw5MjczMjc3MTk=","url":"https://api.github.com/repos/doccano/doccano/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-08-02T17:14:09Z","updated_at":"2020-11-17T05:54:42Z","closed_at":"2020-11-17T05:54:42Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"How to reproduce the behaviour\r\n---------\r\n\r\nPress Backspace key after you added an annotation.\r\n\r\nYou get 500 error:\r\n```\r\npostgres_1  | 2020-08-02 17:09:56.718 UTC [49] ERROR:  duplicate key value violates unique constraint \"api_documentannotation_document_id_user_id_labe_fc7680f9_uniq\"                                                                         \r\npostgres_1  | 2020-08-02 17:09:56.718 UTC [49] DETAIL:  Key (document_id, user_id, label_id)=(26329, 16, 147) already exists.                                                                                                                 \r\npostgres_1  | 2020-08-02 17:09:56.718 UTC [49] STATEMENT:  INSERT INTO \"api_documentannotation\" (\"prob\", \"manual\", \"user_id\", \"created_at\", \"updated_at\", \"document_id\", \"label_id\") VALUES (0.0, false, 16, '2020-08-02T17:09:56.718178+00:0$\r\n'::timestamptz, '2020-08-02T17:09:56.718205+00:00'::timestamptz, 26329, 147) RETURNING \"api_documentannotation\".\"id\"                                                                                                                          \r\nbackend_1   | Internal Server Error: /v1/projects/20/docs/26329/annotations                                                                                                                                                                   \r\nbackend_1   | Traceback (most recent call last):                                                                                                                                                                                              \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 84, in _execute                                                                                                                                     \r\nbackend_1   |     return self.cursor.execute(sql, params)                                                                                                                                                                                     \r\nbackend_1   | psycopg2.IntegrityError: duplicate key value violates unique constraint \"api_documentannotation_document_id_user_id_labe_fc7680f9_uniq\"                                                                                         \r\nbackend_1   | DETAIL:  Key (document_id, user_id, label_id)=(26329, 16, 147) already exists.                                                                                                                                                  \r\nbackend_1   |                                                                                                                                                                                                                                 \r\nbackend_1   |                                                                                                                                                                                                                                 \r\nbackend_1   | The above exception was the direct cause of the following exception:                                                                                                                                                            \r\nbackend_1   |                                                                                                                                                                                                                                 \r\nbackend_1   | Traceback (most recent call last):                                                                                                                                                                                              \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/core/handlers/exception.py\", line 34, in inner                                                                                                                                  \r\nbackend_1   |     response = get_response(request)                                                                                                                                                                                            \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/core/handlers/base.py\", line 115, in _get_response                                                                                                                              \r\nbackend_1   |     response = self.process_exception_by_middleware(e, request)                                                                                                                                                                 \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/core/handlers/base.py\", line 113, in _get_response                                                                                                                     [34/9336]\r\nbackend_1   |     response = wrapped_callback(request, *callback_args, **callback_kwargs)                                                                                                                                                     \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/views/decorators/csrf.py\", line 54, in wrapped_view                                                                                                                             \r\nbackend_1   |     return view_func(*args, **kwargs)                                                                                                                                                                                           \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/views/generic/base.py\", line 71, in view                                                                                                                                        \r\nbackend_1   |     return self.dispatch(request, *args, **kwargs)                                                                                                                                                                              \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/views.py\", line 497, in dispatch                                                                                                                                        \r\nbackend_1   |     response = self.handle_exception(exc)                                                                                                                                                                                       \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/views.py\", line 457, in handle_exception                                                                                                                                \r\nbackend_1   |     self.raise_uncaught_exception(exc)                                                                                                                                                                                          \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/views.py\", line 468, in raise_uncaught_exception                                                                                                                        \r\nbackend_1   |     raise exc                                                                                                                                                                                                                   \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/views.py\", line 494, in dispatch                                                                                                                                        \r\nbackend_1   |     response = handler(request, *args, **kwargs)                                                                                                                                                                                \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/generics.py\", line 242, in post                                                                                                                                         \r\nbackend_1   |     return self.create(request, *args, **kwargs)                                                                                                                                                                                \r\nbackend_1   |   File \"/app/api/views.py\", line 216, in create                                                                                                                                                                                 \r\nbackend_1   |     return super().create(request, args, kwargs)                                                                                                                                                                                \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/mixins.py\", line 19, in create                                                                                                                                          \r\nbackend_1   |     self.perform_create(serializer)                                                                                                                                                                                             \r\nbackend_1   |   File \"/app/api/views.py\", line 219, in perform_create                                                                                                                                                                         \r\nbackend_1   |     serializer.save(document_id=self.kwargs['doc_id'], user=self.request.user)                                                                                                                                                  \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/serializers.py\", line 213, in save                                                                                                                                      \r\nbackend_1   |     self.instance = self.create(validated_data)                                                                                                                                                                                 \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/rest_framework/serializers.py\", line 932, in create                                                                                                                                    \r\nbackend_1   |     instance = ModelClass._default_manager.create(**validated_data)                                                                                                                                                             \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/manager.py\", line 82, in manager_method                                                                                                                               \r\nbackend_1   |     return getattr(self.get_queryset(), name)(*args, **kwargs)                                                                                                                                                                  \r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/base.py\", line 870, in _save_table\r\nbackend_1   |     result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/base.py\", line 908, in _do_insert\r\nbackend_1   |     using=using, raw=raw)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/manager.py\", line 82, in manager_method\r\nbackend_1   |     return getattr(self.get_queryset(), name)(*args, **kwargs)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/query.py\", line 1186, in _insert\r\nbackend_1   |     return query.get_compiler(using=using).execute_sql(return_id)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/models/sql/compiler.py\", line 1375, in execute_sql\r\nbackend_1   |     cursor.execute(sql, params)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 99, in execute\r\nbackend_1   |     return super().execute(sql, params)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 67, in execute\r\nbackend_1   |     return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 76, in _execute_with_wrappers\r\nbackend_1   |     return executor(sql, params, many, context)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\nbackend_1   |     return self.cursor.execute(sql, params)\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/utils.py\", line 89, in __exit__\r\nbackend_1   |     raise dj_exc_value.with_traceback(traceback) from exc_value\r\nbackend_1   |   File \"/usr/lib/python3.6/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\nbackend_1   |     return self.cursor.execute(sql, params)\r\nbackend_1   | django.db.utils.IntegrityError: duplicate key value violates unique constraint \"api_documentannotation_document_id_user_id_labe_fc7680f9_uniq\"\r\nbackend_1   | DETAIL:  Key (document_id, user_id, label_id)=(26329, 16, 147) already exists.\r\nbackend_1   | \r\n```\r\n\r\nYour Environment\r\n---------\r\n<!-- Include details of your environment.-->\r\n*   Operating System: Ubuntu 18.04.4 LTS\r\n*   Python Version Used: system Python is 3.6.9\r\n*   When you install doccano: 2a94bf55e5a28bf294b9cddaeeb330a159cf4629\r\n*   How did you install doccano (Heroku button etc): Docker Compose (production)","closed_by":{"login":"Hironsan","id":6737785,"node_id":"MDQ6VXNlcjY3Mzc3ODU=","avatar_url":"https://avatars.githubusercontent.com/u/6737785?v=4","gravatar_id":"","url":"https://api.github.com/users/Hironsan","html_url":"https://github.com/Hironsan","followers_url":"https://api.github.com/users/Hironsan/followers","following_url":"https://api.github.com/users/Hironsan/following{/other_user}","gists_url":"https://api.github.com/users/Hironsan/gists{/gist_id}","starred_url":"https://api.github.com/users/Hironsan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hironsan/subscriptions","organizations_url":"https://api.github.com/users/Hironsan/orgs","repos_url":"https://api.github.com/users/Hironsan/repos","events_url":"https://api.github.com/users/Hironsan/events{/privacy}","received_events_url":"https://api.github.com/users/Hironsan/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doccano/doccano/issues/943/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doccano/doccano/issues/943/timeline","performed_via_github_app":null,"state_reason":"completed"}