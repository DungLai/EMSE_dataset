{"url":"https://api.github.com/repos/doccano/doccano/issues/1236","repository_url":"https://api.github.com/repos/doccano/doccano","labels_url":"https://api.github.com/repos/doccano/doccano/issues/1236/labels{/name}","comments_url":"https://api.github.com/repos/doccano/doccano/issues/1236/comments","events_url":"https://api.github.com/repos/doccano/doccano/issues/1236/events","html_url":"https://github.com/doccano/doccano/issues/1236","id":822379724,"node_id":"MDU6SXNzdWU4MjIzNzk3MjQ=","number":1236,"title":"Getting errors during annotations, missing labels","user":{"login":"johann-petrak","id":619106,"node_id":"MDQ6VXNlcjYxOTEwNg==","avatar_url":"https://avatars.githubusercontent.com/u/619106?v=4","gravatar_id":"","url":"https://api.github.com/users/johann-petrak","html_url":"https://github.com/johann-petrak","followers_url":"https://api.github.com/users/johann-petrak/followers","following_url":"https://api.github.com/users/johann-petrak/following{/other_user}","gists_url":"https://api.github.com/users/johann-petrak/gists{/gist_id}","starred_url":"https://api.github.com/users/johann-petrak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/johann-petrak/subscriptions","organizations_url":"https://api.github.com/users/johann-petrak/orgs","repos_url":"https://api.github.com/users/johann-petrak/repos","events_url":"https://api.github.com/users/johann-petrak/events{/privacy}","received_events_url":"https://api.github.com/users/johann-petrak/received_events","type":"User","site_admin":false},"labels":[{"id":927327719,"node_id":"MDU6TGFiZWw5MjczMjc3MTk=","url":"https://api.github.com/repos/doccano/doccano/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2021-03-04T18:14:57Z","updated_at":"2022-08-18T11:25:55Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I am getting exceptions on the log like this:\r\n\r\n```\r\nInternal Server Error: /v1/projects/1/docs/28/annotations\r\nTraceback (most recent call last):\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py\", line 413, in execute\r\n    return Database.Cursor.execute(self, query, params)\r\nsqlite3.OperationalError: database is locked\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/core/handlers/exception.py\", line 47, in inner\r\n    response = get_response(request)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/core/handlers/base.py\", line 181, in _get_response\r\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/views/decorators/csrf.py\", line 54, in wrapped_view\r\n    return view_func(*args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/views/generic/base.py\", line 70, in view\r\n    return self.dispatch(request, *args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 509, in dispatch\r\n    response = self.handle_exception(exc)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 469, in handle_exception\r\n    self.raise_uncaught_exception(exc)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 480, in raise_uncaught_exception\r\n    raise exc\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 497, in dispatch\r\n    self.initial(request, *args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 414, in initial\r\n    self.perform_authentication(request)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 324, in perform_authentication\r\n    request.user\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/request.py\", line 227, in user\r\n    self._authenticate()\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/request.py\", line 380, in _authenticate\r\n    user_auth_tuple = authenticator.authenticate(self)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/authentication.py\", line 196, in authenticate\r\n    return self.authenticate_credentials(token)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/authentication.py\", line 201, in authenticate_credentials\r\n    token = model.objects.select_related('user').get(key=key)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 425, in get\r\n    num = len(clone)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 269, in __len__\r\n    self._fetch_all()\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 1308, in _fetch_all\r\n    self._result_cache = list(self._iterable_class(self))\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 53, in __iter__\r\n    results = compiler.execute_sql(chunked_fetch=self.chunked_fetch, chunk_size=self.chunk_size)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/sql/compiler.py\", line 1156, in execute_sql\r\n    cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 98, in execute\r\n    return super().execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 66, in execute\r\n    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 75, in _execute_with_wrappers\r\n    return executor(sql, params, many, context)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/utils.py\", line 90, in __exit__\r\n    raise dj_exc_value.with_traceback(traceback) from exc_value\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py\", line 413, in execute\r\n    return Database.Cursor.execute(self, query, params)\r\ndjango.db.utils.OperationalError: database is locked\r\n```\r\n\r\nand \r\n\r\n```\r\nInternal Server Error: /v1/projects/1/docs/40/annotations\r\nTraceback (most recent call last):\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py\", line 413, in execute\r\n    return Database.Cursor.execute(self, query, params)\r\nsqlite3.IntegrityError: UNIQUE constraint failed: api_documentannotation.document_id, api_documentannotation.user_id, api_documentannotation.label_id\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/core/handlers/exception.py\", line 47, in inner\r\n    response = get_response(request)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/core/handlers/base.py\", line 181, in _get_response\r\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/views/decorators/csrf.py\", line 54, in wrapped_view\r\n    return view_func(*args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/views/generic/base.py\", line 70, in view\r\n    return self.dispatch(request, *args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 509, in dispatch\r\n    response = self.handle_exception(exc)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 469, in handle_exception\r\n    self.raise_uncaught_exception(exc)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 480, in raise_uncaught_exception\r\n    raise exc\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/views.py\", line 506, in dispatch\r\n    response = handler(request, *args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/generics.py\", line 242, in post\r\n    return self.create(request, *args, **kwargs)\r\n  File \"/home/johann/doccano/app/api/views.py\", line 225, in create\r\n    return super().create(request, args, kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/mixins.py\", line 19, in create\r\n    self.perform_create(serializer)\r\n  File \"/home/johann/doccano/app/api/views.py\", line 228, in perform_create\r\n    serializer.save(document_id=self.kwargs['doc_id'], user=self.request.user)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/serializers.py\", line 205, in save\r\n    self.instance = self.create(validated_data)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/rest_framework/serializers.py\", line 939, in create\r\n    instance = ModelClass._default_manager.create(**validated_data)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/manager.py\", line 85, in manager_method\r\n    return getattr(self.get_queryset(), name)(*args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 447, in create\r\n    obj.save(force_insert=True, using=self.db)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/base.py\", line 753, in save\r\n    self.save_base(using=using, force_insert=force_insert,\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/base.py\", line 790, in save_base\r\n    updated = self._save_table(\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/base.py\", line 895, in _save_table\r\n    results = self._do_insert(cls._base_manager, using, fields, returning_fields, raw)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/base.py\", line 933, in _do_insert\r\n    return manager._insert(\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/manager.py\", line 85, in manager_method\r\n    return getattr(self.get_queryset(), name)(*args, **kwargs)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/query.py\", line 1254, in _insert\r\n    return query.get_compiler(using=using).execute_sql(returning_fields)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/models/sql/compiler.py\", line 1397, in execute_sql\r\n    cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 98, in execute\r\n    return super().execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 66, in execute\r\n    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 75, in _execute_with_wrappers\r\n    return executor(sql, params, many, context)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/utils.py\", line 90, in __exit__\r\n    raise dj_exc_value.with_traceback(traceback) from exc_value\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/utils.py\", line 84, in _execute\r\n    return self.cursor.execute(sql, params)\r\n  File \"/home/johann/software/anaconda3/envs/doccano/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py\", line 413, in execute\r\n    return Database.Cursor.execute(self, query, params)\r\ndjango.db.utils.IntegrityError: UNIQUE constraint failed: api_documentannotation.document_id, api_documentannotation.user_id, api_documentannotation.label_id\r\n```\r\nAnd the GUI is sometimes showing popup dialogs mentioning a server 500 error. \r\n\r\nWhat is more worrying is that after assigning a label to an example and moving on to other examples, some of the examples then do not have any label, so the annotation was unsuccessful, but this was not directly visible in the GUI. \r\n\r\nThis happens *sometimes* so it is hard to find out what could cause this. \r\n\r\nI have installed doccano from git, commit 8d6d41f85adef4f80d21fdcbd4e07561ac74cd  and I am using the patch from https://github.com/doccano/doccano/issues/1191\r\n\r\nI am running doccano using Python 3.8.5 \r\n```\r\ngunicorn --bind=\"0.0.0.0:8000\" --workers=4 app.wsgi --timeout 300\r\n```\r\nin the app subdirectory after setting up pretty much like in https://github.com/doccano/doccano/issues/1192 \r\n\r\nDoes Doccano have a problem running with several workers using gunicorn? ","closed_by":null,"reactions":{"url":"https://api.github.com/repos/doccano/doccano/issues/1236/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doccano/doccano/issues/1236/timeline","performed_via_github_app":null,"state_reason":null}