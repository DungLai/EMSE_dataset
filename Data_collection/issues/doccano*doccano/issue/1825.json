{"url":"https://api.github.com/repos/doccano/doccano/issues/1825","repository_url":"https://api.github.com/repos/doccano/doccano","labels_url":"https://api.github.com/repos/doccano/doccano/issues/1825/labels{/name}","comments_url":"https://api.github.com/repos/doccano/doccano/issues/1825/comments","events_url":"https://api.github.com/repos/doccano/doccano/issues/1825/events","html_url":"https://github.com/doccano/doccano/issues/1825","id":1241192038,"node_id":"I_kwDOB-j9wM5J-xZm","number":1825,"title":"Sql alchemy cannot parse the connection string and file upload is failing when using in Azure","user":{"login":"Sooraj577","id":49942995,"node_id":"MDQ6VXNlcjQ5OTQyOTk1","avatar_url":"https://avatars.githubusercontent.com/u/49942995?v=4","gravatar_id":"","url":"https://api.github.com/users/Sooraj577","html_url":"https://github.com/Sooraj577","followers_url":"https://api.github.com/users/Sooraj577/followers","following_url":"https://api.github.com/users/Sooraj577/following{/other_user}","gists_url":"https://api.github.com/users/Sooraj577/gists{/gist_id}","starred_url":"https://api.github.com/users/Sooraj577/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sooraj577/subscriptions","organizations_url":"https://api.github.com/users/Sooraj577/orgs","repos_url":"https://api.github.com/users/Sooraj577/repos","events_url":"https://api.github.com/users/Sooraj577/events{/privacy}","received_events_url":"https://api.github.com/users/Sooraj577/received_events","type":"User","site_admin":false},"labels":[{"id":927327721,"node_id":"MDU6TGFiZWw5MjczMjc3MjE=","url":"https://api.github.com/repos/doccano/doccano/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"Improvement on existing feature"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-19T04:29:06Z","updated_at":"2022-08-19T04:45:36Z","closed_at":"2022-08-19T04:45:36Z","author_association":"NONE","active_lock_reason":null,"body":"Platform - Azure\r\nI am running this in Azure Kubernetes \r\n\r\nI was trying to connect my postgresql which is in azure, once the connection string is passed via dockerfile in ENV DATABASE_URL giving this error\r\n\r\n```\r\nsqlalchemy.exc.OperationalError: (psycopg2.OperationalError) could not translate host name \"testposgress2&password=password123!&sslmode=disable\" to address: Name or service not known\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\r\n```\r\n\r\nHere the host which i was given was - testpstgrses2.postgres.database.azure.com and port - 5432\r\n\r\nThen when i tried to upload text files, it shows the uploading and the green color is also shown. When i click the import button it shows the loading symbol and showing for a longer period, which does not upload files .\r\n\r\nI am giving the log for your reference.\r\n\r\n```\r\n[2022-05-19 04:59:41,004: INFO/MainProcess] Connected to sqla+postgresql://testpstgrses2.postgres.database.azure.com:5432/docano\r\n[2022-05-19 04:59:41,008: WARNING/MainProcess] consumer: Connection to broker lost. Trying to re-establish the connection...\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3250, in _wrap_pool_connect\r\n    return fn()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 310, in connect\r\n    return _ConnectionFairy._checkout(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 868, in _checkout\r\n    fairy = _ConnectionRecord.checkout(pool)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 476, in checkout\r\n    rec = pool._do_get()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/impl.py\", line 146, in _do_get\r\n    self._dec_overflow()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\n    compat.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/impl.py\", line 143, in _do_get\r\n    return self._create_connection()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 256, in _create_connection\r\n    return _ConnectionRecord(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 371, in __init__\r\n    self.__connect()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 666, in __connect\r\n    pool.logger.debug(\"Error on connect(): %s\", e)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\n    compat.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 661, in __connect\r\n    self.dbapi_connection = connection = pool._invoke_creator(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/create.py\", line 590, in connect\r\n    return dialect.connect(*cargs, **cparams)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/default.py\", line 597, in connect\r\n    return self.dbapi.connect(*cargs, **cparams)\r\n  File \"/usr/local/lib/python3.8/site-packages/psycopg2/__init__.py\", line 122, in connect\r\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\r\npsycopg2.OperationalError: could not translate host name \"testposgress2&password=password123!&sslmode=disable\" to address: Name or service not known\r\n\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/celery/worker/consumer/consumer.py\", line 326, in start\r\n    blueprint.start(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/celery/bootsteps.py\", line 116, in start\r\n    step.start(parent)\r\n  File \"/usr/local/lib/python3.8/site-packages/celery/worker/consumer/tasks.py\", line 38, in start\r\n    c.task_consumer = c.app.amqp.TaskConsumer(\r\n  File \"/usr/local/lib/python3.8/site-packages/celery/app/amqp.py\", line 274, in TaskConsumer\r\n    return self.Consumer(\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/messaging.py\", line 387, in __init__\r\n    self.revive(self.channel)\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/messaging.py\", line 409, in revive\r\n    self.declare()\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/messaging.py\", line 422, in declare\r\n    queue.declare()\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/entity.py\", line 606, in declare\r\n    self._create_queue(nowait=nowait, channel=channel)\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/entity.py\", line 615, in _create_queue\r\n    self.queue_declare(nowait=nowait, passive=False, channel=channel)\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/entity.py\", line 643, in queue_declare\r\n    ret = channel.queue_declare(\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/transport/virtual/base.py\", line 520, in queue_declare\r\n    self._new_queue(queue, **kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/transport/sqlalchemy/__init__.py\", line 153, in _new_queue\r\n    self._get_or_create(queue)\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/transport/sqlalchemy/__init__.py\", line 132, in _get_or_create\r\n    obj = self.session.query(self.queue_cls) \\\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/transport/sqlalchemy/__init__.py\", line 127, in session\r\n    _, Session = self._open()\r\n  File \"/usr/local/lib/python3.8/site-packages/kombu/transport/sqlalchemy/__init__.py\", line 119, in _open\r\n    metadata.create_all(engine)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/sql/schema.py\", line 4785, in create_all\r\n    bind._run_ddl_visitor(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3116, in _run_ddl_visitor\r\n    with self.begin() as conn:\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3032, in begin\r\n    conn = self.connect(close_with_result=close_with_result)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3204, in connect\r\n    return self._connection_cls(self, close_with_result=close_with_result)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 96, in __init__\r\n    else engine.raw_connection()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3283, in raw_connection\r\n    return self._wrap_pool_connect(self.pool.connect, _connection)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3253, in _wrap_pool_connect\r\n    Connection._handle_dbapi_exception_noconnection(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 2100, in _handle_dbapi_exception_noconnection\r\n    util.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 3250, in _wrap_pool_connect\r\n    return fn()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 310, in connect\r\n    return _ConnectionFairy._checkout(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 868, in _checkout\r\n    fairy = _ConnectionRecord.checkout(pool)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 476, in checkout\r\n    rec = pool._do_get()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/impl.py\", line 146, in _do_get\r\n    self._dec_overflow()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\n    compat.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/impl.py\", line 143, in _do_get\r\n    return self._create_connection()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 256, in _create_connection\r\n    return _ConnectionRecord(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 371, in __init__\r\n    self.__connect()\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 666, in __connect\r\n    pool.logger.debug(\"Error on connect(): %s\", e)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\n    compat.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/pool/base.py\", line 661, in __connect\r\n    self.dbapi_connection = connection = pool._invoke_creator(self)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/create.py\", line 590, in connect\r\n    return dialect.connect(*cargs, **cparams)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/default.py\", line 597, in connect\r\n    return self.dbapi.connect(*cargs, **cparams)\r\n  File \"/usr/local/lib/python3.8/site-packages/psycopg2/__init__.py\", line 122, in connect\r\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\r\nsqlalchemy.exc.OperationalError: (psycopg2.OperationalError) could not translate host name \"testposgress2&password=password123!&sslmode=disable\" to address: Name or service not known\r\n\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\r\n[2022-05-19 04:59:41,011: WARNING/MainProcess] /usr/local/lib/python3.8/site-packages/celery/worker/consumer/consumer.py:361: CPendingDeprecationWarning: \r\nIn Celery 5.1 we introduced an optional breaking change which\r\non connection loss cancels all currently executed tasks with late acknowledgement enabled.\r\nThese tasks cannot be acknowledged as the connection is gone, and the tasks are automatically redelivered back to the queue.\r\nYou can enable this behavior using the worker_cancel_long_running_tasks_on_connection_loss setting.\r\nIn Celery 5.1 it is set to False by default. The setting will be set to True by default in Celery 6.0.\r\n\r\n  warnings.warn(CANCEL_TASKS_BY_DEFAULT, CPendingDeprecationWarning)\r\n\r\nThe connection string which i used is like this:\r\n\"sqla+postgresql://testpstgrses2.postgres.database.azure.com:5432/docano?user=admin123@testposgress2&password=postgress@123$&sslmode=disable\"\r\n```\r\n\r\nWith reference to this issue https://github.com/doccano/doccano/issues/648","closed_by":{"login":"Hironsan","id":6737785,"node_id":"MDQ6VXNlcjY3Mzc3ODU=","avatar_url":"https://avatars.githubusercontent.com/u/6737785?v=4","gravatar_id":"","url":"https://api.github.com/users/Hironsan","html_url":"https://github.com/Hironsan","followers_url":"https://api.github.com/users/Hironsan/followers","following_url":"https://api.github.com/users/Hironsan/following{/other_user}","gists_url":"https://api.github.com/users/Hironsan/gists{/gist_id}","starred_url":"https://api.github.com/users/Hironsan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hironsan/subscriptions","organizations_url":"https://api.github.com/users/Hironsan/orgs","repos_url":"https://api.github.com/users/Hironsan/repos","events_url":"https://api.github.com/users/Hironsan/events{/privacy}","received_events_url":"https://api.github.com/users/Hironsan/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doccano/doccano/issues/1825/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doccano/doccano/issues/1825/timeline","performed_via_github_app":null,"state_reason":"completed"}