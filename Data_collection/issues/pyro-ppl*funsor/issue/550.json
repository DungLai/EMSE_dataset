{"url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550","repository_url":"https://api.github.com/repos/pyro-ppl/funsor","labels_url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550/labels{/name}","comments_url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550/comments","events_url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550/events","html_url":"https://github.com/pyro-ppl/funsor/issues/550","id":1004594765,"node_id":"I_kwDOCgoJts474OZN","number":550,"title":"Dispatch to `Integrate(Delta, ...)` in `normalize_integrate_contraction`","user":{"login":"ordabayevy","id":50752571,"node_id":"MDQ6VXNlcjUwNzUyNTcx","avatar_url":"https://avatars.githubusercontent.com/u/50752571?v=4","gravatar_id":"","url":"https://api.github.com/users/ordabayevy","html_url":"https://github.com/ordabayevy","followers_url":"https://api.github.com/users/ordabayevy/followers","following_url":"https://api.github.com/users/ordabayevy/following{/other_user}","gists_url":"https://api.github.com/users/ordabayevy/gists{/gist_id}","starred_url":"https://api.github.com/users/ordabayevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ordabayevy/subscriptions","organizations_url":"https://api.github.com/users/ordabayevy/orgs","repos_url":"https://api.github.com/users/ordabayevy/repos","events_url":"https://api.github.com/users/ordabayevy/events{/privacy}","received_events_url":"https://api.github.com/users/ordabayevy/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-09-22T18:20:13Z","updated_at":"2021-09-24T17:42:41Z","closed_at":"2021-09-24T17:42:41Z","author_association":"MEMBER","active_lock_reason":null,"body":"There is a difference between how individual `Delta` terms are integrated in `normalize_integrate_contraction` and `Integrate` pattern for `Delta`. The former only performs `integrand` substitution (line 105) and the latter performs substitutions for both `integrand` (line 164) and `log_measure` (line 165). This can lead to differences when the `log_density` in `Delta` term is not zero. If the latter is more appropriate way then this probably can be easily fixed by dispatching:\r\n\r\n```diff\r\n    for delta in delta_terms:\r\n+        args = delta, integrand, reduced_vars & delta.input_vars\r\n+        integrand = eager.dispatch(Integrate, *args)(*args)\r\n-        integrand = integrand(\r\n-            **{\r\n-                name: point\r\n-                for name, (point, log_density) in delta.terms\r\n-                if name in reduced_names.intersection(integrand.inputs)\r\n-            }\r\n        )\r\n```\r\n\r\nhttps://github.com/pyro-ppl/funsor/blob/e66bc6f6b5bc19d51e163666090bf22f6c0255d7/funsor/integrate.py#L90-L112\r\n\r\nhttps://github.com/pyro-ppl/funsor/blob/e66bc6f6b5bc19d51e163666090bf22f6c0255d7/funsor/integrate.py#L153-L167","closed_by":{"login":"ordabayevy","id":50752571,"node_id":"MDQ6VXNlcjUwNzUyNTcx","avatar_url":"https://avatars.githubusercontent.com/u/50752571?v=4","gravatar_id":"","url":"https://api.github.com/users/ordabayevy","html_url":"https://github.com/ordabayevy","followers_url":"https://api.github.com/users/ordabayevy/followers","following_url":"https://api.github.com/users/ordabayevy/following{/other_user}","gists_url":"https://api.github.com/users/ordabayevy/gists{/gist_id}","starred_url":"https://api.github.com/users/ordabayevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ordabayevy/subscriptions","organizations_url":"https://api.github.com/users/ordabayevy/orgs","repos_url":"https://api.github.com/users/ordabayevy/repos","events_url":"https://api.github.com/users/ordabayevy/events{/privacy}","received_events_url":"https://api.github.com/users/ordabayevy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyro-ppl/funsor/issues/550/timeline","performed_via_github_app":null,"state_reason":"completed"}