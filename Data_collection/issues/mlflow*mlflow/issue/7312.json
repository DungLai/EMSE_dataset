{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7312","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7312/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7312/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7312/events","html_url":"https://github.com/mlflow/mlflow/issues/7312","id":1444917773,"node_id":"I_kwDOCB5Jx85WH7IN","number":7312,"title":"[BUG] default artifact destination flag ignored for the default experiment","user":{"login":"JasonJooste","id":9052431,"node_id":"MDQ6VXNlcjkwNTI0MzE=","avatar_url":"https://avatars.githubusercontent.com/u/9052431?v=4","gravatar_id":"","url":"https://api.github.com/users/JasonJooste","html_url":"https://github.com/JasonJooste","followers_url":"https://api.github.com/users/JasonJooste/followers","following_url":"https://api.github.com/users/JasonJooste/following{/other_user}","gists_url":"https://api.github.com/users/JasonJooste/gists{/gist_id}","starred_url":"https://api.github.com/users/JasonJooste/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JasonJooste/subscriptions","organizations_url":"https://api.github.com/users/JasonJooste/orgs","repos_url":"https://api.github.com/users/JasonJooste/repos","events_url":"https://api.github.com/users/JasonJooste/events{/privacy}","received_events_url":"https://api.github.com/users/JasonJooste/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-11-11T04:34:26Z","updated_at":"2022-11-14T01:40:41Z","closed_at":"2022-11-14T01:40:41Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\r\n\r\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\n\r\n### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n- Client: 1.30.0\r\n- Tracking server: 1.30.0\r\n\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 18.04\r\n- **Python version**: 3.9.15\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\nWhen the mlflow server is started with a different --default-artifact-store the default experiment still references the original artifact store. \r\nThis may be related to pull request  #1332 and issue #1357 but doesn't appear to be working in version 1.30. \r\n\r\n### Tracking information\r\n\r\nMLflow version: 1.30.0\r\nTracking URI: file:///.../mlruns\r\nArtifact URI: old-scheme://old-bucket/0/dd0670c8e817403684b8d1bced67231d/artifacts (when running new server with new flag)\r\n\r\n### Code to reproduce issue\r\n\r\nFirst start the tracking server\r\n``` bash\r\nmlflow server --host 0.0.0.0 --default-artifact-root old-scheme://old-bucket\r\n```\r\nNow get the artifact uri of a new run from the python api\r\n``` python\r\nimport mlflow\r\nmlflow.set_tracking_uri(\"http://127.0.0.1:5000\")\r\n# First the default experiment\r\nr = mlflow.start_run(run_name='test-run')\r\nprint(f\"Experiment: {r.info.experiment_id} | Artifact URL: {r.info.artifact_uri}\")\r\nmlflow.end_run()\r\n# Now a named experiment\r\nexp = mlflow.create_experiment('test-experiment')\r\nr = mlflow.start_run(run_name='test-run', experiment_id=exp)\r\nprint(f\"Experiment: {r.info.experiment_id} | Artifact URL: {r.info.artifact_uri}\")\r\nmlflow.end_run()\r\n```\r\noutput\r\n```\r\nExperiment: 0 | Artifact URL: old-scheme://old-bucket/0/.../artifacts\r\nExperiment: 1 | Artifact URL: old-scheme://old-bucket/1/.../artifacts\r\n```\r\nNow we run the server again with a new `--default-artifact-root` flag\r\n``` bash\r\nmlflow server --host 0.0.0.0 --default-artifact-root new-scheme://new-bucket\r\n```\r\nand get the following output (with a new experiment name)\r\n```\r\nExperiment: 0 | Artifact URL: old-scheme://old-bucket/0/.../artifacts\r\nExperiment: 2 | Artifact URL: new-scheme://new-bucket/2/.../artifacts\r\n```\r\nDeleting the file storage under mlruns fixes the problem. \r\nThis is also the case with MySQL backend storage (where clearing the database fixes the problem)\r\nIt is also the case when switching from an initial default artifact store to mlflow proxy using --serve-artifacts and --artifacts-destination\r\n\r\n\r\n\r\n\r\n### Stack trace\r\n\r\nNA\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7312/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7312/timeline","performed_via_github_app":null,"state_reason":"completed"}