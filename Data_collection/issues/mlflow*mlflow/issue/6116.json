{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6116","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6116/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6116/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6116/events","html_url":"https://github.com/mlflow/mlflow/issues/6116","id":1280868495,"node_id":"I_kwDOCB5Jx85MWICP","number":6116,"title":"[BUG] Error message is hard to understand when artifacts CLI fails (especially when out of memory)","user":{"login":"BKDaugherty","id":18391567,"node_id":"MDQ6VXNlcjE4MzkxNTY3","avatar_url":"https://avatars.githubusercontent.com/u/18391567?v=4","gravatar_id":"","url":"https://api.github.com/users/BKDaugherty","html_url":"https://github.com/BKDaugherty","followers_url":"https://api.github.com/users/BKDaugherty/followers","following_url":"https://api.github.com/users/BKDaugherty/following{/other_user}","gists_url":"https://api.github.com/users/BKDaugherty/gists{/gist_id}","starred_url":"https://api.github.com/users/BKDaugherty/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BKDaugherty/subscriptions","organizations_url":"https://api.github.com/users/BKDaugherty/orgs","repos_url":"https://api.github.com/users/BKDaugherty/repos","events_url":"https://api.github.com/users/BKDaugherty/events{/privacy}","received_events_url":"https://api.github.com/users/BKDaugherty/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1041183632,"node_id":"MDU6TGFiZWwxMDQxMTgzNjMy","url":"https://api.github.com/repos/mlflow/mlflow/labels/language/r","name":"language/r","color":"349cd8","default":false,"description":"R APIs and clients"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-22T20:44:39Z","updated_at":"2022-06-29T23:40:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\nmlflow --version mlflow, version 1.23.1\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: \r\n```\r\n$ cat /etc/os-release\r\nNAME=\"Amazon Linux\"\r\nVERSION=\"2\"\r\nID=\"amzn\"\r\nID_LIKE=\"centos rhel fedora\"\r\nVERSION_ID=\"2\"\r\nPRETTY_NAME=\"Amazon Linux 2\"\r\nANSI_COLOR=\"0;33\"\r\nCPE_NAME=\"cpe:2.3:o:amazon:amazon_linux:2\"\r\nHOME_URL=\"https://amazonlinux.com/\"\r\n```\r\n \r\n- **R version**:\r\n```\r\n> getNamespaceVersion('mlflow')\r\n version \r\n\"1.23.0\" \r\n```\n\n### Describe the problem\n\nI ran out of memory on an AWS instance I was running an interactive R script on. When I did so, the following code failed.\r\n\r\n```\r\n> model <- mlflow::mlflow_load_model(model_file)()\r\nError in if (!nzchar(text)) return(paste0(\", \", std, \" empty\")) :\r\n  argument is of length zero\r\n>\r\n```\r\n\r\nRunning a traceback(), I found this.\r\n\r\n```\r\n> traceback()\r\n15: last_stderr_lines(x$stderr, std)\r\n14: system_error_parts(x)\r\n13: format.system_command_error(c)\r\n12: format(c)\r\n11: paste(format(c), collapse = \"\\n\")\r\n10: conditionMessage.system_command_error(cond)\r\n9: conditionMessage(cond)\r\n8: signalCondition(cond)\r\n7: throw(new_process_error(res, call = sys.call(), echo = echo,\r\n       stderr_to_stdout, res$status, command = command, args = args))\r\n6: run(mlflow_bin, args = unlist(args), echo = echo, echo_cmd = verbose,\r\n       stderr_callback = stderr_callback)\r\n5: force(code)\r\n4: with_envvar(env, {\r\n       if (background) {\r\n           result <- process$new(mlflow_bin, args = unlist(args),\r\n               echo_cmd = verbose, supervise = TRUE)\r\n       }\r\n       else {\r\n           result <- run(mlflow_bin, args = unlist(args), echo = echo,\r\n               echo_cmd = verbose, stderr_callback = stderr_callback)\r\n       }\r\n   })\r\n3: mlflow_cli(\"artifacts\", \"download\", \"-u\", artifact_uri, echo = FALSE,\r\n       client = client)\r\n2: mlflow_download_artifacts_from_uri(model_uri, client = client)\r\n1: mlflow::mlflow_load_model(model_file)\r\n```\r\n\r\nDigging into the internals, I eventually found the issue that I was out of memory, and the CLI must have been failing. \r\n\r\n```\r\n(sequoia) root@a538a1ec3145:/# df -h /tmp\r\nFilesystem      Size  Used Avail Use% Mounted on\r\n/dev/nvme0n1p1   30G   30G   20K 100% /tmp\r\n\r\n(sequoia) root@a538a1ec3145:/# mlflow artifacts download -u dbfs:/databricks/mlflow-tracking/SOME_TRACKING_STUFF/THAT_I_REPLACED/artifacts/only_model.crate\r\nTraceback (most recent call last):\r\n  File \"/root/Envs/sequoia/bin/mlflow\", line 8, in <module>\r\n    sys.exit(cli())\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 1128, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 1053, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 1395, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/click/core.py\", line 754, in invoke\r\n    return __callback(*args, **kwargs)\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/mlflow/store/artifact/cli.py\", line 122, in download_artifacts\r\n    print(_download_artifact_from_uri(artifact_uri))\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/mlflow/tracking/artifact_utils.py\", line 95, in _download_artifact_from_uri\r\n    return get_artifact_repository(artifact_uri=root_uri).download_artifacts(\r\n  File \"/root/Envs/sequoia/lib/python3.8/site-packages/mlflow/store/artifact/databricks_artifact_repo.py\", line 574, in download_artifacts\r\n    dst_path = tempfile.mkdtemp()\r\n  File \"/usr/lib/python3.8/tempfile.py\", line 486, in mkdtemp\r\n    prefix, suffix, dir, output_type = _sanitize_params(prefix, suffix, dir)\r\n  File \"/usr/lib/python3.8/tempfile.py\", line 256, in _sanitize_params\r\n    dir = gettempdir()\r\n  File \"/usr/lib/python3.8/tempfile.py\", line 425, in gettempdir\r\n    tempdir = _get_default_tempdir()\r\n  File \"/usr/lib/python3.8/tempfile.py\", line 357, in _get_default_tempdir\r\n    raise FileNotFoundError(_errno.ENOENT,\r\nFileNotFoundError: [Errno 2] No usable temporary directory found in ['/tmp', '/var/tmp', '/usr/tmp', '/']\r\n```\r\n\r\nWhile this still doesn't say, \"hey you're out of memory\", it gets me closer to understanding there's a problem with my filesystem, while the error from R is a lot harder to understand. I'd love it if this error could be better shown in the R traceback or message!\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\nI put code in the description ^^\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [X] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [X] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [X] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6116/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6116/timeline","performed_via_github_app":null,"state_reason":null}