{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3402","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3402/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3402/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3402/events","html_url":"https://github.com/mlflow/mlflow/issues/3402","id":696705691,"node_id":"MDU6SXNzdWU2OTY3MDU2OTE=","number":3402,"title":"keras.autolog() fails when running model within a sklearn pipeline [BUG]","user":{"login":"sephib","id":8223335,"node_id":"MDQ6VXNlcjgyMjMzMzU=","avatar_url":"https://avatars.githubusercontent.com/u/8223335?v=4","gravatar_id":"","url":"https://api.github.com/users/sephib","html_url":"https://github.com/sephib","followers_url":"https://api.github.com/users/sephib/followers","following_url":"https://api.github.com/users/sephib/following{/other_user}","gists_url":"https://api.github.com/users/sephib/gists{/gist_id}","starred_url":"https://api.github.com/users/sephib/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sephib/subscriptions","organizations_url":"https://api.github.com/users/sephib/orgs","repos_url":"https://api.github.com/users/sephib/repos","events_url":"https://api.github.com/users/sephib/events{/privacy}","received_events_url":"https://api.github.com/users/sephib/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022848510,"node_id":"MDU6TGFiZWwyMDIyODQ4NTEw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/projects","name":"area/projects","color":"48eabc","default":false,"description":"MLproject format, project running backends"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-09-09T10:46:53Z","updated_at":"2020-10-15T11:54:24Z","closed_at":"2020-10-05T17:34:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux SLES 12)**:\r\n- **MLflow installed from **: anaconda\r\n- **MLflow version ()**: 1.11\r\n- **Python version**: 3.7\r\n- **Exact command to reproduce**:  \r\n\r\nwrapping the code from this [keras-nlp-pipeline](https://github.com/diegoglozano/keras-nlp-pipeline) example with `mlflow`  \r\n\r\n<details>  \r\n\r\n```\r\nimport pandas as pd\r\nimport numpy as np\r\nimport joblib\r\nimport mlflow\r\nimport mlflow.keras\r\nfrom sklearn.pipeline import Pipeline\r\nfrom gensim.models import KeyedVectors\r\nfrom keras.wrappers.scikit_learn import KerasClassifier\r\n\r\nfrom library_pipeline_nlp.my_transformers import TokenizerTransformer, PadSequencesTransformer\r\nfrom library_pipeline_nlp.my_model import create_model\r\n\r\nmlflow.keras.autolog()\r\n\r\n# PATHS\r\nDATA_PATH = '../data/texts.csv'\r\nEMBEDDING_PATH = '../data/embedding.bin'\r\nPIPE_PATH = '../objects/pipeline.joblib'\r\n\r\n# DATA\r\ndf = pd.read_csv(DATA_PATH, index_col='id', nrows=100)\r\n\r\n# X / y\r\nX = df['tweet'].copy()\r\ny = df['label'].copy()\r\n\r\n# DIMENSIONS\r\nlongest_text = X.str.split().str.len().max()  # Para padsequences()\r\nEMBEDDING_DIM = 300  # Dimensi√≥n Word2Vec\r\n\r\n# PRETRAINED WORD2VEC\r\nword_vectors = KeyedVectors.load_word2vec_format(EMBEDDING_PATH, limit=1000, binary=True)\r\n\r\n# VOCABULARY SIZE (+1)\r\nvocab_size = len(word_vectors.vocab.keys()) + 1\r\nembedding_weights = np.vstack([np.zeros(word_vectors.vectors.shape[1]), word_vectors.vectors])\r\n\r\n\r\n# DECLARE ESTIMATORS\r\nmy_tokenizer = TokenizerTransformer()\r\nmy_padder = PadSequencesTransformer(maxlen=longest_text)\r\nmy_model = KerasClassifier(build_fn=create_model,\r\n                           epochs=2,\r\n                           embedding_input_dim=vocab_size,\r\n                           embedding_output_dim=300,\r\n                           embedding_weights=embedding_weights)\r\n\r\n# DECLARE PIPELINE\r\npipeline = Pipeline([\r\n    ('tokenizer', my_tokenizer),\r\n    ('padder', my_padder),\r\n    ('model', my_model)\r\n])\r\n\r\n# TRAIN\r\nwith mlflow.start_raun() as mlrun:\r\n  pipeline.fit(X, y)\r\n```   \r\n\r\n</details>   \r\n\r\n### Describe the problem\r\nWhen running with `autolog` the function that is passed is:    \r\n`<function mlflow.keras.autolog.<locals>.fit(self, *args, **kwargs)>  `\r\nwhile when running without `autolog` th function is:   \r\n`tensorflow.python.keras.engine.training.Model.fit`  \r\n\r\nSo when the`autolog` fn parameters are checked in [the keras wrapper](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/wrappers/scikit_learn.py#L77)  \r\n` self.check_params(sk_params)`  \r\nit fails.   \r\n\r\nTo by pass this you can comment the above check.    \r\nHowever even with this by pass the code does not consider the `epochs` parameter since it is not gather the argument  in this function:  \r\n[fit_args = copy.deepcopy(self.filter_sk_params(Sequential.fit))](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/wrappers/scikit_learn.py#L163)   \r\nsince the`Sequential` object is of `<function mlflow.keras.autolog.<locals>.fit(self, *args, **kwargs)>  ` which does not have the `epochs` param.  \r\nand then the fn  fails with \r\n[if has_arg(fn, params_name):]( https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/wrappers/scikit_learn.py#L102)   \r\n\r\n### Workaround  to get `keras.autolog` in current versions:\r\nAdd to the `MLflowKerasCallback` class to the `callbacks` in the  KerasClassifier:     \r\n```\r\nmy_model = KerasClassifier(build_fn=create_model,\r\n                           epochs=2,\r\n                           embedding_input_dim=vocab_size,\r\n                           embedding_output_dim=300,\r\n                           embedding_weights=embedding_weights,\r\n                           callbacks = [mlflow_keras_callback.__MLflowKerasCallback()],\r\n)\r\n```\r\n\r\n### Code to reproduce issue\r\nsee [github repo - keras-nlp-pipeline](https://github.com/diegoglozano/keras-nlp-pipeline) with the additional example in this post.  \r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [x] `area/projects`: MLproject format, project running backends\r\n\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3402/timeline","performed_via_github_app":null,"state_reason":"completed"}