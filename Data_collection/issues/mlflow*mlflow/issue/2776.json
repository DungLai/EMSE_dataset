{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2776","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2776/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2776/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2776/events","html_url":"https://github.com/mlflow/mlflow/issues/2776","id":610850943,"node_id":"MDU6SXNzdWU2MTA4NTA5NDM=","number":2776,"title":"[BUG] MLflow mlflow.log_metric TimeoutError: [Errno 110]","user":{"login":"HugangR","id":25859225,"node_id":"MDQ6VXNlcjI1ODU5MjI1","avatar_url":"https://avatars.githubusercontent.com/u/25859225?v=4","gravatar_id":"","url":"https://api.github.com/users/HugangR","html_url":"https://github.com/HugangR","followers_url":"https://api.github.com/users/HugangR/followers","following_url":"https://api.github.com/users/HugangR/following{/other_user}","gists_url":"https://api.github.com/users/HugangR/gists{/gist_id}","starred_url":"https://api.github.com/users/HugangR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HugangR/subscriptions","organizations_url":"https://api.github.com/users/HugangR/orgs","repos_url":"https://api.github.com/users/HugangR/repos","events_url":"https://api.github.com/users/HugangR/events{/privacy}","received_events_url":"https://api.github.com/users/HugangR/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1893057631,"node_id":"MDU6TGFiZWwxODkzMDU3NjMx","url":"https://api.github.com/repos/mlflow/mlflow/labels/Acknowledged","name":"Acknowledged","color":"f9d0c4","default":false,"description":"This issue has been read and acknowledged by the MLflow admins."},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-05-01T16:50:46Z","updated_at":"2020-06-05T06:12:48Z","closed_at":"2020-06-05T06:12:48Z","author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\nfor additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix\r\nfor this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [x ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\nYes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nRed Hat Enterprise Linux Server release 7.5 (Maipo)\r\n\r\n- **MLflow installed from (source or binary)**:\r\npip install\r\n- **MLflow version (run ``mlflow --version``)**:\r\n1.6.0\r\n- **Python version**:\r\n3.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\nepochs = 1000\r\nwith mlflow.start_run():\r\n    history = model.fit_generator(\r\n            train_data_gen,\r\n            steps_per_epoch=total_train//batch_size,\r\n            epochs=epochs,\r\n            validation_data=val_data_gen,\r\n            validation_steps=total_val//batch_size\r\n            )\r\n    acc = history.history['accuracy']\r\n    val_acc = history.history['val_accuracy']\r\n\r\n    loss = history.history['loss']\r\n    val_loss = history.history['val_loss']\r\n\r\n    for epoch in range(0, epochs):\r\n        mlflow.log_metric(key=\"Accuracy\", value=acc[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Validation Accuracy\", value=val_acc[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Loss\", value=loss[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Validation Loss\", value=val_loss[epoch], step=epoch)\r\n    \r\nmlflow.end_run()\r\n\r\n\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Include descriptions of the expected behavior and the actual behavior.\r\n\r\nIdeally, it should log all the metric for 1000 epochs. However, after about 300 epochs, it stops and throw an error message as below:\r\n\r\nTraceback (most recent call last):\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 384, in _make_request\r\n    six.raise_from(e, None)\r\n  File \"<string>\", line 2, in raise_from\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 380, in _make_request\r\n    httplib_response = conn.getresponse()\r\n  File \"/cm/local/apps/python3/lib/python3.6/http/client.py\", line 1331, in getresponse\r\n    response.begin()\r\n  File \"/cm/local/apps/python3/lib/python3.6/http/client.py\", line 297, in begin\r\n    version, status, reason = self._read_status()\r\n  File \"/cm/local/apps/python3/lib/python3.6/http/client.py\", line 258, in _read_status\r\n    line = str(self.fp.readline(_MAXLINE + 1), \"iso-8859-1\")\r\n  File \"/cm/local/apps/python3/lib/python3.6/socket.py\", line 586, in readinto\r\n    return self._sock.recv_into(b)\r\nTimeoutError: [Errno 110] Connection timed out\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/requests/adapters.py\", line 449, in send\r\n    timeout=timeout\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 638, in urlopen\r\n    _stacktrace=sys.exc_info()[2])\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/util/retry.py\", line 367, in increment\r\n    raise six.reraise(type(error), error, _stacktrace)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/packages/six.py\", line 686, in reraise\r\n    raise value\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 600, in urlopen\r\n    chunked=chunked)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 386, in _make_request\r\n    self._raise_timeout(err=e, url=url, timeout_value=read_timeout)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/urllib3/connectionpool.py\", line 317, in _raise_timeout\r\n    raise ReadTimeoutError(self, url, \"Read timed out. (read timeout=%s)\" % timeout_value)\r\nurllib3.exceptions.ReadTimeoutError: HTTPConnectionPool(host='mlflowserver.xxx.com', port=5000): Read timed out. (read timeout=None)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 147, in <module>\r\n    mlflow.log_metric(key=\"Loss\", value=loss[epoch], step=epoch)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/tracking/fluent.py\", line 252, in log_metric\r\n    MlflowClient().log_metric(run_id, key, value, int(time.time() * 1000), step or 0)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/tracking/client.py\", line 195, in log_metric\r\n    self._tracking_client.log_metric(run_id, key, value, timestamp, step)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/tracking/_tracking_service/client.py\", line 170, in log_metric\r\n    self.store.log_metric(run_id, metric)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/store/tracking/rest_store.py\", line 132, in log_metric\r\n    self._call_endpoint(LogMetric, req_body)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/store/tracking/rest_store.py\", line 32, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/utils/rest_utils.py\", line 136, in call_endpoint\r\n    host_creds=host_creds, endpoint=endpoint, method=method, json=json_body)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/utils/rest_utils.py\", line 70, in http_request\r\n    url=url, headers=headers, verify=verify, **kwargs)\r\n  File \"/cm/local/apps/python3/lib/python3.6/site-packages/mlflow/utils/rest_utils.py\", line 51, in request_with_ratelimit_retries\r\n    response = requests.request(**kwargs)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/requests/api.py\", line 60, in request\r\n    return session.request(method=method, url=url, **kwargs)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/requests/sessions.py\", line 533, in request\r\n    resp = self.send(prep, **send_kwargs)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/requests/sessions.py\", line 646, in send\r\n    r = adapter.send(request, **kwargs)\r\n  File \"/cm/shared/apps/ml-pythondeps-py36-cuda10.1-gcc/lib/python3.6/site-packages/requests/adapters.py\", line 529, in send\r\n    raise ReadTimeout(e, request=request)\r\nrequests.exceptions.ReadTimeout: HTTPConnectionPool(host='mlflowserver.xxx.com', port=5000): Read timed out. (read timeout=None)\r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\nepochs = 1000\r\nwith mlflow.start_run():\r\n    history = model.fit_generator(\r\n            train_data_gen,\r\n            steps_per_epoch=total_train//batch_size,\r\n            epochs=epochs,\r\n            validation_data=val_data_gen,\r\n            validation_steps=total_val//batch_size\r\n            )\r\n    acc = history.history['accuracy']\r\n    val_acc = history.history['val_accuracy']\r\n\r\n    loss = history.history['loss']\r\n    val_loss = history.history['val_loss']\r\n\r\n    for epoch in range(0, epochs):\r\n        mlflow.log_metric(key=\"Accuracy\", value=acc[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Validation Accuracy\", value=val_acc[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Loss\", value=loss[epoch], step=epoch)\r\n        mlflow.log_metric(key=\"Validation Loss\", value=val_loss[epoch], step=epoch)\r\n    \r\nmlflow.end_run()\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks,\r\nplease include the full traceback. Large logs and files should be attached.\r\n","closed_by":{"login":"HugangR","id":25859225,"node_id":"MDQ6VXNlcjI1ODU5MjI1","avatar_url":"https://avatars.githubusercontent.com/u/25859225?v=4","gravatar_id":"","url":"https://api.github.com/users/HugangR","html_url":"https://github.com/HugangR","followers_url":"https://api.github.com/users/HugangR/followers","following_url":"https://api.github.com/users/HugangR/following{/other_user}","gists_url":"https://api.github.com/users/HugangR/gists{/gist_id}","starred_url":"https://api.github.com/users/HugangR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HugangR/subscriptions","organizations_url":"https://api.github.com/users/HugangR/orgs","repos_url":"https://api.github.com/users/HugangR/repos","events_url":"https://api.github.com/users/HugangR/events{/privacy}","received_events_url":"https://api.github.com/users/HugangR/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2776/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2776/timeline","performed_via_github_app":null,"state_reason":"completed"}