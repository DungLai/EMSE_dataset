{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7362","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7362/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7362/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7362/events","html_url":"https://github.com/mlflow/mlflow/issues/7362","id":1454924175,"node_id":"I_kwDOCB5Jx85WuGGP","number":7362,"title":"[BUG] pymysql.err.IntegrityError on java client `startRun` (duplicate runName argument)","user":{"login":"serkef","id":3225779,"node_id":"MDQ6VXNlcjMyMjU3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/3225779?v=4","gravatar_id":"","url":"https://api.github.com/users/serkef","html_url":"https://github.com/serkef","followers_url":"https://api.github.com/users/serkef/followers","following_url":"https://api.github.com/users/serkef/following{/other_user}","gists_url":"https://api.github.com/users/serkef/gists{/gist_id}","starred_url":"https://api.github.com/users/serkef/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/serkef/subscriptions","organizations_url":"https://api.github.com/users/serkef/orgs","repos_url":"https://api.github.com/users/serkef/repos","events_url":"https://api.github.com/users/serkef/events{/privacy}","received_events_url":"https://api.github.com/users/serkef/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1673521876,"node_id":"MDU6TGFiZWwxNjczNTIxODc2","url":"https://api.github.com/repos/mlflow/mlflow/labels/language/java","name":"language/java","color":"349cd8","default":false,"description":"Java APIs and clients"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-11-18T11:14:13Z","updated_at":"2022-11-22T01:47:18Z","closed_at":"2022-11-22T01:47:16Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\n- Client: 1.30\r\n- Tracking server: 1.30\r\n\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: GCP Dataproc (Spark) - not sure of the internals\r\n- **Python version**: 3.7\r\n- **yarn version, if running the dev UI**: -\r\n\n\n### Describe the problem\n\nwhen I run:\r\n```java\r\nmlFlowContext.startRun(\"2022-11-05\")\r\n```\r\nthrows the following error:\r\n```\r\nException in thread \"main\" org.mlflow.tracking.MlflowHttpException: statusCode=400 reasonPhrase=[Bad Request] bodyMessage=[{\"error_code\": \"BAD_REQUEST\", \"message\": \"(pymysql.err.IntegrityError) (1062, \\\"Duplicate entry 'mlflow.runName-2796f91b90734e4ca05773f6e1ec5710' for key 'tags.PRIMARY'\\\")\\n[SQL: INSERT INTO tags (`key`, value, run_uuid) VALUES (%(key)s, %(value)s, %(run_uuid)s)]\\n[parameters: ({'key': 'mlflow.runName', 'value': '2022-11-05', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.source.type', 'value': 'LOCAL', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.user', 'value': 'spark', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.runName', 'value': 'marvelous-gnat-900', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'})]\\n(Background on this error at: https://sqlalche.me/e/14/gkpj)\"}]\r\n```\r\nBy reading it, there is an attempt to add both:\r\n```json\r\n{\"key\": \"mlflow.runName\", \"value\": \"2022-11-05\", \"run_uuid\": \"2796f91b90734e4ca05773f6e1ec5710\"}\r\n```\r\nand \r\n```json\r\n{\"key\": \"mlflow.runName\", \"value\": \"marvelous-gnat-900\", \"run_uuid\": \"2796f91b90734e4ca05773f6e1ec5710\"}\r\n```\r\n\r\nThis problem started occurring when we upgraded our server from v1.27 to v1.30\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\nCan't offer a reproduction step. Our code is in scala, using the java library, in a spark context.\r\nIt seems quite basic problem - someone must be injecting the randomly generated runName although runName is provided.\r\n\r\nMaybe the `runName` should be set here? \r\nhttps://github.com/mlflow/mlflow/blob/dbee92072cb1a002fd19255042aad8367d5353b5/mlflow/java/client/src/main/java/org/mlflow/tracking/MlflowContext.java#L160-L163\n\n### Stack trace\n\nException in thread \"main\" org.mlflow.tracking.MlflowHttpException: statusCode=400 reasonPhrase=[Bad Request] bodyMessage=[{\"error_code\": \"BAD_REQUEST\", \"message\": \"(pymysql.err.IntegrityError) (1062, \\\"Duplicate entry 'mlflow.runName-2796f91b90734e4ca05773f6e1ec5710' for key 'tags.PRIMARY'\\\")\\n[SQL: INSERT INTO tags (`key`, value, run_uuid) VALUES (%(key)s, %(value)s, %(run_uuid)s)]\\n[parameters: ({'key': 'mlflow.runName', 'value': '2022-11-05', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.source.type', 'value': 'LOCAL', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.user', 'value': 'spark', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'}, {'key': 'mlflow.runName', 'value': 'marvelous-gnat-900', 'run_uuid': '2796f91b90734e4ca05773f6e1ec5710'})]\\n(Background on this error at: https://sqlalche.me/e/14/gkpj)\"}]\r\n\tat org.mlflow.tracking.MlflowHttpCaller.checkError(MlflowHttpCaller.java:193)\r\n\tat org.mlflow.tracking.MlflowHttpCaller.executeRequestWithRateLimitRetries(MlflowHttpCaller.java:104)\r\n\tat org.mlflow.tracking.MlflowHttpCaller.executeRequest(MlflowHttpCaller.java:114)\r\n\tat org.mlflow.tracking.MlflowHttpCaller.send(MlflowHttpCaller.java:178)\r\n\tat org.mlflow.tracking.MlflowHttpCaller.post(MlflowHttpCaller.java:164)\r\n\tat org.mlflow.tracking.MlflowClient.sendPost(MlflowClient.java:549)\r\n\tat org.mlflow.tracking.MlflowClient.createRun(MlflowClient.java:117)\r\n\tat org.mlflow.tracking.MlflowContext.startRun(MlflowContext.java:167)\r\n\tat org.mlflow.tracking.MlflowContext.startRun(MlflowContext.java:131)\r\n\tat \\[...\\](MLFlowLogger.scala:27)\r\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)\r\n\tat scala.concurrent.Future$.$anonfun$apply$1(Future.scala:659)\r\n\tat scala.util.Success.$anonfun$map$1(Try.scala:255)\r\n\tat scala.util.Success.map(Try.scala:213)\r\n\tat scala.concurrent.Future.$anonfun$map$1(Future.scala:292)\r\n\tat scala.concurrent.impl.Promise.liftedTree1$1(Promise.scala:33)\r\n\tat scala.concurrent.impl.Promise.$anonfun$transform$1(Promise.scala:33)\r\n\tat scala.concurrent.impl.CallbackRunnable.run(Promise.scala:64)\r\n\tat java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1426)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [X] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [X] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7362/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7362/timeline","performed_via_github_app":null,"state_reason":"completed"}