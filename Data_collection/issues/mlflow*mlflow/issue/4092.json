{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4092","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4092/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4092/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4092/events","html_url":"https://github.com/mlflow/mlflow/issues/4092","id":806443004,"node_id":"MDU6SXNzdWU4MDY0NDMwMDQ=","number":4092,"title":"mlflow serve not working, getting \"AttributeError: module 'types' has no attribute 'ClassType'\"","user":{"login":"itachiRedhair","id":20207966,"node_id":"MDQ6VXNlcjIwMjA3OTY2","avatar_url":"https://avatars.githubusercontent.com/u/20207966?v=4","gravatar_id":"","url":"https://api.github.com/users/itachiRedhair","html_url":"https://github.com/itachiRedhair","followers_url":"https://api.github.com/users/itachiRedhair/followers","following_url":"https://api.github.com/users/itachiRedhair/following{/other_user}","gists_url":"https://api.github.com/users/itachiRedhair/gists{/gist_id}","starred_url":"https://api.github.com/users/itachiRedhair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/itachiRedhair/subscriptions","organizations_url":"https://api.github.com/users/itachiRedhair/orgs","repos_url":"https://api.github.com/users/itachiRedhair/repos","events_url":"https://api.github.com/users/itachiRedhair/events{/privacy}","received_events_url":"https://api.github.com/users/itachiRedhair/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-02-11T14:31:35Z","updated_at":"2021-02-22T09:57:04Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: tried building a docker image with the base `continuumio/miniconda3` and also tried running on MacOS locally\r\n- **MLflow installed from (source or binary)**:source\r\n- **MLflow version (run ``mlflow --version``)**:1.11.0\r\n- **Python version**:3.7.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:mlflow models serve -m ./custom-pyfunc-model --port 5000\r\n\r\n### Describe the problem\r\nEnv:\r\nPython 3.7.6\r\nMLFLow 1.11.0\r\nSKLearn 0.22.1\r\nCloudpickle 1.3.0\r\n\r\nI am using databricks to run MLflow.I have created a Pyfunc model that calls sk-learn model to predict. When I download model artifacts and run mlflow serve from local I get the following error:\r\n<details>\r\n  <summary>Error</summary>\r\n  \r\n[2021-02-11 12:30:21 +0000] [24] [INFO] Starting gunicorn 20.0.4\r\n[2021-02-11 12:30:21 +0000] [24] [INFO] Listening at: http://127.0.0.1:8000 (24)\r\n[2021-02-11 12:30:21 +0000] [24] [INFO] Using worker: gevent\r\n[2021-02-11 12:30:21 +0000] [37] [INFO] Booting worker with pid: 37\r\n[2021-02-11 12:30:21 +0000] [38] [INFO] Booting worker with pid: 38\r\n[2021-02-11 12:30:24 +0000] [38] [ERROR] Exception in worker process\r\nTraceback (most recent call last):\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/arbiter.py\", line 583, in spawn_worker\r\n    worker.init_process()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/ggevent.py\", line 162, in init_process\r\n    super().init_process()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/base.py\", line 119, in init_process\r\n    self.load_wsgi()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/base.py\", line 144, in load_wsgi\r\n    self.wsgi = self.app.wsgi()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/base.py\", line 67, in wsgi\r\n    self.callable = self.load()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/wsgiapp.py\", line 49, in load\r\n    return self.load_wsgiapp()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/wsgiapp.py\", line 39, in load_wsgiapp\r\n    return util.import_app(self.app_uri)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/util.py\", line 358, in import_app\r\n    mod = importlib.import_module(module)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/importlib/__init__.py\", line 127, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 983, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 967, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 677, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 728, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/models/container/scoring_server/wsgi.py\", line 4, in <module>\r\n    app = scoring_server.init(pyfunc.load_pyfunc(\"/opt/ml/model/\"))\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/utils/annotations.py\", line 42, in deprecated_func\r\n    return func(*args, **kwargs)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 548, in load_pyfunc\r\n    return load_model(model_uri, suppress_warnings)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 522, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/model.py\", line 223, in _load_pyfunc\r\n    python_model = cloudpickle.load(f)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/cloudpickle/cloudpickle.py\", line 415, in _builtin_type\r\n    return getattr(types, name)\r\nAttributeError: module 'types' has no attribute 'ClassType'\r\n[2021-02-11 12:30:24 +0000] [38] [INFO] Worker exiting (pid: 38)\r\n[2021-02-11 12:30:24 +0000] [37] [ERROR] Exception in worker process\r\nTraceback (most recent call last):\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/arbiter.py\", line 583, in spawn_worker\r\n    worker.init_process()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/ggevent.py\", line 162, in init_process\r\n    super().init_process()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/base.py\", line 119, in init_process\r\n    self.load_wsgi()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/workers/base.py\", line 144, in load_wsgi\r\n    self.wsgi = self.app.wsgi()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/base.py\", line 67, in wsgi\r\n    self.callable = self.load()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/wsgiapp.py\", line 49, in load\r\n    return self.load_wsgiapp()\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/app/wsgiapp.py\", line 39, in load_wsgiapp\r\n    return util.import_app(self.app_uri)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/gunicorn/util.py\", line 358, in import_app\r\n    mod = importlib.import_module(module)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/importlib/__init__.py\", line 127, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 983, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 967, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 677, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 728, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/models/container/scoring_server/wsgi.py\", line 4, in <module>\r\n    app = scoring_server.init(pyfunc.load_pyfunc(\"/opt/ml/model/\"))\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/utils/annotations.py\", line 42, in deprecated_func\r\n    return func(*args, **kwargs)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 548, in load_pyfunc\r\n    return load_model(model_uri, suppress_warnings)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 522, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/mlflow/pyfunc/model.py\", line 223, in _load_pyfunc\r\n    python_model = cloudpickle.load(f)\r\n  File \"/miniconda/envs/custom_env/lib/python3.7/site-packages/cloudpickle/cloudpickle.py\", line 415, in _builtin_type\r\n    return getattr(types, name)\r\nAttributeError: module 'types' has no attribute 'ClassType'\r\n</details>\r\n\r\n### Code to reproduce issue\r\n```\r\nimport os\r\nimport warnings\r\nimport sys\r\n\r\nimport pandas as pd\r\nimport numpy as np\r\nimport cloudpickle\r\nimport sklearn\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.linear_model import ElasticNet\r\nfrom sklearn import datasets\r\n\r\nimport mlflow\r\n\r\n# Load Diabetes datasets\r\ndiabetes = datasets.load_diabetes()\r\nX = diabetes.data\r\ny = diabetes.target\r\n\r\n# Create pandas DataFrame for sklearn ElasticNet linear_model\r\nY = np.array([y]).transpose()\r\nd = np.concatenate((X, Y), axis=1)\r\ncols = ['age', 'sex', 'bmi', 'bp', 's1', 's2', 's3', 's4', 's5', 's6', 'progression']\r\ndata = pd.DataFrame(d, columns=cols)\r\n```\r\n```\r\nclass CustomPyFuncModel(mlflow.pyfunc.PythonModel):\r\n    def __init__(self, model, age_mul_factor, pre_process, post_process):\r\n        self.model = model\r\n        self.age_mul_factor=age_mul_factor\r\n        self.pre_process = pre_process\r\n        self.post_process = post_process\r\n\r\n    def predict(self, context, model_input):\r\n        model_input_processed = self.pre_process(model_input,self.age_mul_factor)       \r\n        \r\n        obj = self.model.predict(model_input_processed)\r\n        x = self.post_process(obj)\r\n        return x\r\n```\r\n```\r\ncustom_pyfunc_model_conda_env = {\r\n 'name': 'mlflow-env',\r\n 'channels': ['defaults', 'conda-forge'],\r\n 'dependencies': [\r\n   f'python={python_version}', \r\n   'pip',\r\n   f'scikit-learn={sklearn.__version__}',\r\n   {\r\n     'pip': [\r\n       f'mlflow',\r\n       f'cloudpickle=={cloudpickle.__version__}'\r\n     ]\r\n   }\r\n  ]\r\n}\r\n```\r\n```\r\ndef pre_process(data,age_mul_factor):\r\n  data['age']= data['age'].apply(lambda x: x*age_mul_factor)\r\n  return data\r\n\r\ndef post_process(data):\r\n  return [i/100 for i in data]\r\n```\r\n```\r\nalpha = 0.05\r\nl1_ratio = 0.05\r\nnp.random.seed(40)\r\n\r\n# Split the data into training and test sets. (0.75, 0.25) split.\r\ntrain, test = train_test_split(data)\r\n\r\n# The predicted column is \"progression\" which is a quantitative measure of disease progression one year after baseline\r\ntrain_x = train.drop([\"progression\"], axis=1)\r\ntest_x = test.drop([\"progression\"], axis=1)\r\ntrain_y = train[[\"progression\"]]\r\ntest_y = test[[\"progression\"]]\r\n  \r\nwith mlflow.start_run() as run:\r\n  lr = ElasticNet(alpha=alpha, l1_ratio=l1_ratio, random_state=42)\r\n  lr.fit(train_x, train_y)\r\n\r\n  mlflow.sklearn.log_model(lr, \"model\")\r\n\r\nwith mlflow.start_run() as run:\r\n  custom_pyfunc_model = CustomPyFuncModel(\r\n    model=lr, \r\n    pre_process=pre_process, \r\n    post_process=post_process,\r\n    age_mul_factor=2\r\n  )\r\n\r\n  mlflow.pyfunc.log_model(\r\n                          artifact_path = \"model\",\r\n                          python_model = custom_pyfunc_model,\r\n                          conda_env = custom_pyfunc_model_conda_env\r\n  )\r\n```\r\nAfter this, I download the model artifacts from the run page and run following command:\r\n```\r\nmlflow models serve -m ./model --port 5000\r\n```\r\nAnd this gives the above error.\r\nNote that when I serve the model within databricks, it works.\r\n\r\n### Other info / logs\r\nTo me this seems like a library version issue, most likely with cloudpickle. I used the exact same libraries that I used to train the model and then served the model locally.\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4092/timeline","performed_via_github_app":null,"state_reason":null}