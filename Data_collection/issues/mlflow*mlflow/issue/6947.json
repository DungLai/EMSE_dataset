{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6947","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6947/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6947/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6947/events","html_url":"https://github.com/mlflow/mlflow/issues/6947","id":1392255046,"node_id":"I_kwDOCB5Jx85S_CBG","number":6947,"title":"[BUG] Exception running mlflow.pyfunc.load_model with custom Python model","user":{"login":"PJPRoche","id":97131018,"node_id":"U_kgDOBcoaCg","avatar_url":"https://avatars.githubusercontent.com/u/97131018?v=4","gravatar_id":"","url":"https://api.github.com/users/PJPRoche","html_url":"https://github.com/PJPRoche","followers_url":"https://api.github.com/users/PJPRoche/followers","following_url":"https://api.github.com/users/PJPRoche/following{/other_user}","gists_url":"https://api.github.com/users/PJPRoche/gists{/gist_id}","starred_url":"https://api.github.com/users/PJPRoche/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJPRoche/subscriptions","organizations_url":"https://api.github.com/users/PJPRoche/orgs","repos_url":"https://api.github.com/users/PJPRoche/repos","events_url":"https://api.github.com/users/PJPRoche/events{/privacy}","received_events_url":"https://api.github.com/users/PJPRoche/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"},{"id":2114036915,"node_id":"MDU6TGFiZWwyMTE0MDM2OTE1","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/databricks","name":"integrations/databricks","color":"ffbce5","default":false,"description":"Databricks integrations"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-09-30T10:52:19Z","updated_at":"2022-10-06T23:37:47Z","closed_at":"2022-10-06T23:37:47Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n1.24.0\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux 5.4.0-1090-azure / Windows 10\r\n- **Python version**: 3.8.10\r\n\r\nThe pip requirements inferred by mlflow are:\r\nmlflow\r\nastunparse==1.6.3\r\ncloudpickle==2.2.0\r\ndill==0.3.2\r\nipython==7.22.0\r\npyspark==3.2.1\r\nsdv==0.17.0\r\n\r\n### Describe the problem\r\n\r\nI am using MLFlow to train a GAN neural network model and logging the experiment with all its artifacts, which includes the pickled custom GAN model class. I am using MLFlow in Azure Databricks for all the training.\r\n\r\nAfter training, I am downloading all the artifacts so I can run some local inference. I am creating a conda environment using the inferred pip requirements (see the list in the above \"System information\" section) that gets bundled into the trained logged model artifacts. I then run the mlflow.pyfunc.load_model function and try get some predictions from the model.\r\n\r\nI appreciate there are a number of factors here: platforms / environments / custom model classes which makes this hard to isolate and maybe for other to reproduce issue. However, I thought I would share in case others are having the same issue, or if someone has an idea how I can get to the bottom of the issue!! I have tried and debugged a lot of things but am not having any success in solving the problem.\r\n\r\nThanks for any help/suggestions\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\nThis is the Databricks notebook I am using to train the model\r\n```\r\n# Databricks notebook source\r\npip install sdv==0.17.0\r\n\r\n# COMMAND ----------\r\n\r\n# DBTITLE 1,Install and Load Libraries\r\nimport logging\r\nimport mlflow\r\nimport mlflow.pyfunc\r\n\r\nfrom mlflow.tracking.client import MlflowClient\r\n\r\nfrom sdv.tabular import CTGAN\r\nfrom sdv.demo import load_tabular_demo\r\n\r\nfrom sys import version_info\r\n\r\n# COMMAND ----------\r\n\r\n# DBTITLE 1,Configure logging\r\n# setting logging to DEBUG level whilst in development\r\nlogging.basicConfig(level=logging.DEBUG)\r\nlogger = logging.getLogger(__name__)\r\n\r\n# turn off/set to error other modules\r\nlogger = logging.getLogger(\"py4j\").setLevel(logging.ERROR)\r\nlogger = logging.getLogger(\"rdt\").setLevel(logging.ERROR)\r\nlogger = logging.getLogger(\"urllib3v\").setLevel(logging.ERROR)\r\n\r\n# COMMAND ----------\r\n\r\nmlflow_experiment_name = \"/Shared/SyntheticGAN\"\r\n\r\nSDV_MODEL_NAME = \"sdv_model.pkl\"\r\n\r\n# name of sub-folder to save the MLFlow model under the experiment id\r\nMLFLOW_PYFUNC_MODEL_PATH = \"sdv_mlflow_pyfunc\"\r\n\r\n# Parameter grid for Neural Network\r\nPARAM_GRID = dict(\r\n  epochs = 1\r\n)\r\n\r\n# COMMAND ----------\r\n\r\nPYTHON_VERSION = \"{major}.{minor}.{micro}\".format(major=version_info.major,\r\n                                                  minor=version_info.minor,\r\n                                                  micro=version_info.micro)\r\n\r\nmlflow.set_experiment(mlflow_experiment_name)\r\n\r\n# COMMAND ----------\r\n\r\n# Create an `artifacts` dictionary that assigns a unique name to the saved SDV model file.\r\n# This dictionary will be passed to `mlflow.pyfunc.log_model`, which will copy the model file\r\n# into the new MLflow experiment model's directory.\r\nartifacts = {\r\n    \"sdv_model\": SDV_MODEL_NAME\r\n}\r\n\r\n# COMMAND ----------\r\n\r\n# Define the model class\r\n# https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#\r\n# https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#pyfunc-create-custom\r\nclass SDVWrapper(mlflow.pyfunc.PythonModel):\r\n    \"\"\"Defines the custom wrapper class.\"\"\"\r\n    def load_context(self, context):\r\n        from sdv.tabular import CTGAN\r\n        self.sdv_model = CTGAN.load(context.artifacts[\"sdv_model\"])\r\n\r\n    def predict(self, context, model_input):\r\n        return self.sdv_model.sample(num_rows=model_input)\r\n\r\n# COMMAND ----------\r\n\r\ndata = load_tabular_demo('student_placements')\r\n\r\n# COMMAND ----------\r\n\r\n# Start a new MLflow training run \r\nwith mlflow.start_run() as run:\r\n  \r\n    run_id = \"runs:/\" + run.info.run_id + \"/sdv_mlflow_pyfunc\"\r\n    \r\n    model = CTGAN()\r\n    model.fit(data)\r\n    model.save(SDV_MODEL_NAME)\r\n    \r\n    # Log the MLflow Model\r\n    # https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.log_model\r\n    mlflow.pyfunc.log_model(\r\n        artifact_path=MLFLOW_PYFUNC_MODEL_PATH, \r\n        python_model=SDVWrapper(), \r\n        artifacts=artifacts,\r\n    )\r\n  \r\n\r\n# COMMAND ----------\r\n\r\nrun_id\r\n\r\n# COMMAND ----------\r\n\r\nmodel = mlflow.pyfunc.load_model(run_id)\r\n\r\n# COMMAND ----------\r\n\r\nmodel.predict(10)\r\n\r\n```\r\n\r\nThis is the local python script I am using to make inferences with\r\n\r\n```\r\nimport mlflow\r\n\r\nlogged_model = 'PATH_TO_LOCALLY_SAVED_TRAINED_MODEL_ARTIFACTS_FOLDER'\r\n\r\nloaded_model = mlflow.pyfunc.load_model(logged_model)\r\nprint(loaded_model.predict(10))\r\n```\r\n\r\n### Stack trace\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\runpy.py\", line 194, in _run_module_as_main\r\n    return _run_code(code, main_globals, None,\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\runpy.py\", line 87, in _run_code\r\n    exec(code, run_globals)\r\n  File \"c:\\Users\\######\\.vscode\\extensions\\ms-python.python-2022.2.1924087327\\pythonFiles\\lib\\python\\debugpy\\__main__.py\", line 45, in <module>\r\n    cli.main()\r\n  File \"c:\\Users\\######\\.vscode\\extensions\\ms-python.python-2022.2.1924087327\\pythonFiles\\lib\\python\\debugpy/..\\debugpy\\server\\cli.py\", line 444, in main\r\n    run()\r\n  File \"c:\\Users\\######\\.vscode\\extensions\\ms-python.python-2022.2.1924087327\\pythonFiles\\lib\\python\\debugpy/..\\debugpy\\server\\cli.py\", line 285, in run_file\r\n    runpy.run_path(target_as_str, run_name=compat.force_str(\"__main__\"))\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\runpy.py\", line 265, in run_path\r\n    return _run_module_code(code, init_globals, run_name,\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\runpy.py\", line 97, in _run_module_code\r\n    _run_code(code, mod_globals, init_globals,\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\runpy.py\", line 87, in _run_code\r\n    exec(code, run_globals)\r\n  File \"C:\\Users\\######\\repos\\###########/run_models/sample_data_generator/run_mlflow_test.py\", line 5, in <module>\r\n    loaded_model = mlflow.pyfunc.load_model(logged_model)\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\site-packages\\mlflow\\pyfunc\\__init__.py\", line 710, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\site-packages\\mlflow\\pyfunc\\model.py\", line 280, in _load_pyfunc\r\n    python_model.load_context(context=context)\r\n  File \"<command-1315971304203110>\", line 8, in load_context\r\n  File \"C:\\Users\\######\\Miniconda3\\envs\\sdv-demo\\lib\\site-packages\\sdv\\tabular\\base.py\", line 891, in load\r\n    model = cloudpickle.load(f)\r\nTypeError: _restore() takes 3 positional arguments but 4 were given\r\n```\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [X] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [X] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6947/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6947/timeline","performed_via_github_app":null,"state_reason":"completed"}