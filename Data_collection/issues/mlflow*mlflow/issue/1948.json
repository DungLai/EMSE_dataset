{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1948","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1948/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1948/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1948/events","html_url":"https://github.com/mlflow/mlflow/issues/1948","id":508703824,"node_id":"MDU6SXNzdWU1MDg3MDM4MjQ=","number":1948,"title":"[BUG] Postgresql Alembic Migration Automatically Runs when running 'mlflow server' with no way to disable","user":{"login":"JoeJasinski","id":417872,"node_id":"MDQ6VXNlcjQxNzg3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/417872?v=4","gravatar_id":"","url":"https://api.github.com/users/JoeJasinski","html_url":"https://github.com/JoeJasinski","followers_url":"https://api.github.com/users/JoeJasinski/followers","following_url":"https://api.github.com/users/JoeJasinski/following{/other_user}","gists_url":"https://api.github.com/users/JoeJasinski/gists{/gist_id}","starred_url":"https://api.github.com/users/JoeJasinski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoeJasinski/subscriptions","organizations_url":"https://api.github.com/users/JoeJasinski/orgs","repos_url":"https://api.github.com/users/JoeJasinski/repos","events_url":"https://api.github.com/users/JoeJasinski/events{/privacy}","received_events_url":"https://api.github.com/users/JoeJasinski/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-10-17T20:28:15Z","updated_at":"2019-11-07T20:01:08Z","closed_at":"2019-11-07T20:01:08Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Debian Stretch (Python 3.7.3 docker base image)\r\n- **MLflow installed from (source or binary)**: from pypi via pip\r\n- **MLflow version (run ``mlflow --version``)**: 1.3.0\r\n- **Python version**: 3.7.3\r\n- **npm version, if running the dev UI**: na\r\n- **Exact command to reproduce**:\r\n\r\n```\r\nmlflow server \\\r\n    --default-artifact-root file://shared/mlruns/  \\\r\n    --backend-store-uri postgresql://***** \\\r\n    --host 0.0.0.0 \\\r\n    --port 5000 \\\r\n    --workers 4\r\n```\r\n\r\n### Describe the problem\r\n\r\nWhen I run `mlflow server` using Postgresql for the storage backend, the migrations are automatically executed and I don't see a way in the docs or code to disable that behavior. \r\n\r\nThis automatic migration is undesirable in situations where one would like to control exactly when their database is migrated (and not have it automatically migrated). Since MLFLow does have the `mlflow db upgrade` command, it does seem to indicate MLFlow may have been designed to separate the serving of the app from the migration of the database. However, it seems that adding the `--default-artifact-root` and the `--backend-store-uri` causes the database to automatically migrate. (I'm not sure what the purpose of `db upgrade` would be if its automatically run on first run of the server.)\r\n\r\nI'm able to reproduce this inside of the python:3.7.3 docker image running inside of docker-compose and in kubernetes. \r\n\r\n### Code to reproduce issue\r\n\r\nSee the above command. This looks like where the tables are migrated as soon as `__init__` is called on the sqlalchemy backend.\r\n\r\nhttps://github.com/mlflow/mlflow/blob/v1.3.0/mlflow/store/sqlalchemy_store.py#L97\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks,\r\nplease include the full traceback. Large logs and files should be attached.\r\n\r\n```\r\nroot@6e554811:/srv/# mlflow server --backend-store-uri ${BACKEND_STORE_URI} --default-artifact-root ${DEFAULT_ARTIFACT_ROOT}  --host 0.0.0.0 --port 5000\r\n2019/10/17 19:54:31 INFO mlflow.store.sqlalchemy_store: Creating initial MLflow database tables...\r\n2019/10/17 19:54:31 INFO mlflow.store.db.utils: Updating database tables at postgresql://*****\r\nINFO  [alembic.runtime.migration] Context impl PostgresqlImpl.\r\nINFO  [alembic.runtime.migration] Will assume transactional DDL.\r\nINFO  [alembic.runtime.migration] Running upgrade  -> 451aebb31d03, add metric step\r\nINFO  [alembic.runtime.migration] Running upgrade 451aebb31d03 -> 90e64c465722, migrate user column to tags\r\nINFO  [alembic.runtime.migration] Running upgrade 90e64c465722 -> 181f10493468, allow nulls for metric values\r\nINFO  [alembic.runtime.migration] Running upgrade 181f10493468 -> df50e92ffc5e, Add Experiment Tags Table\r\nINFO  [alembic.runtime.migration] Running upgrade df50e92ffc5e -> 7ac759974ad8, Update run tags with larger limit\r\nINFO  [alembic.runtime.migration] Running upgrade 7ac759974ad8 -> 89d4b8295536, create latest metrics table\r\n....\r\n...\r\n```\r\n","closed_by":{"login":"sueann","id":4411489,"node_id":"MDQ6VXNlcjQ0MTE0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/4411489?v=4","gravatar_id":"","url":"https://api.github.com/users/sueann","html_url":"https://github.com/sueann","followers_url":"https://api.github.com/users/sueann/followers","following_url":"https://api.github.com/users/sueann/following{/other_user}","gists_url":"https://api.github.com/users/sueann/gists{/gist_id}","starred_url":"https://api.github.com/users/sueann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sueann/subscriptions","organizations_url":"https://api.github.com/users/sueann/orgs","repos_url":"https://api.github.com/users/sueann/repos","events_url":"https://api.github.com/users/sueann/events{/privacy}","received_events_url":"https://api.github.com/users/sueann/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1948/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1948/timeline","performed_via_github_app":null,"state_reason":"completed"}