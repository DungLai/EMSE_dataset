{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4357","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4357/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4357/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4357/events","html_url":"https://github.com/mlflow/mlflow/issues/4357","id":890924988,"node_id":"MDU6SXNzdWU4OTA5MjQ5ODg=","number":4357,"title":"[FR] Masking sensitive environment variables in log","user":{"login":"jhettler","id":6342027,"node_id":"MDQ6VXNlcjYzNDIwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/6342027?v=4","gravatar_id":"","url":"https://api.github.com/users/jhettler","html_url":"https://github.com/jhettler","followers_url":"https://api.github.com/users/jhettler/followers","following_url":"https://api.github.com/users/jhettler/following{/other_user}","gists_url":"https://api.github.com/users/jhettler/gists{/gist_id}","starred_url":"https://api.github.com/users/jhettler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhettler/subscriptions","organizations_url":"https://api.github.com/users/jhettler/orgs","repos_url":"https://api.github.com/users/jhettler/repos","events_url":"https://api.github.com/users/jhettler/events{/privacy}","received_events_url":"https://api.github.com/users/jhettler/received_events","type":"User","site_admin":false},"labels":[{"id":955449434,"node_id":"MDU6TGFiZWw5NTU0NDk0MzQ=","url":"https://api.github.com/repos/mlflow/mlflow/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"},{"id":978584226,"node_id":"MDU6TGFiZWw5Nzg1ODQyMjY=","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docs","name":"area/docs","color":"48eabc","default":false,"description":"Documentation issues"},{"id":2022847277,"node_id":"MDU6TGFiZWwyMDIyODQ3Mjc3","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/examples","name":"area/examples","color":"48eabc","default":false,"description":"Example code"},{"id":2022848510,"node_id":"MDU6TGFiZWwyMDIyODQ4NTEw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/projects","name":"area/projects","color":"48eabc","default":false,"description":"MLproject format, project running backends"},{"id":2022851725,"node_id":"MDU6TGFiZWwyMDIyODUxNzI1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docker","name":"area/docker","color":"ede978","default":false,"description":"Docker use anywhere, such as MLprojects and MLmodels"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-05-13T10:28:53Z","updated_at":"2021-05-27T15:52:45Z","closed_at":"2021-05-27T15:52:45Z","author_association":"NONE","active_lock_reason":null,"body":"## Willingness to contribute\r\nThe MLflow Community encourages new feature contributions. Would you or another member of your organization be willing to contribute an implementation of this feature (either as an MLflow Plugin or an enhancement to the MLflow code base)?\r\n\r\n- [x] Yes. (I hope) I can contribute this feature independently.\r\n\r\n## Proposal Summary\r\n\r\nMasking of sensitive information provided via environemnt variables in MLFlow log.\r\n\r\nWe provide sensitivie information to MLFlow projects via environment variables e.g.\r\n```\r\ndocker_env:\r\n  image: \"dcreg.service.consul/prod/lmc-bi-models-pythia:latest\"\r\n  environment: [[\"PYTHONPATH\", \"/mlflow/projects/code:/mlflow/projects/code/pythia\"],\r\n                MLFLOW_SNOW_PWD,\r\n                MLFLOW_SNOW_USER\r\n               ]\r\n```\r\nthe issue is if you run MLFlow in external system, we execute it via Airflow, there are those senstitive information in MLFlow log, as you can see below - there are AWS S3 credentials and another credetials provided via environment variables from above config (I masked them with *, but it is not masked in log). The masking of those fields is the target of this FR.\r\n\r\n```\r\n\r\n2021/05/04 08:58:26 INFO mlflow.projects.utils: === Fetching project from https://hostname/scm/bi/models.git#applicant_segmentation into /tmp/tmppbsx4wuh ===\r\n2021/05/04 08:58:27 INFO mlflow.projects.docker: === Building docker image applicant:9ca4ed7 ===\r\n2021/05/04 08:58:28 INFO mlflow.projects.utils: === Created directory /tmp/tmpurzr_gt5 for downloading remote URIs passed to arguments of type 'path' ===\r\n2021/05/04 08:58:28 INFO mlflow.projects.backend.local: === Running command 'docker run --rm --name applicant_airflow -e MLFLOW_RUN_ID=f8e19ea984c2499293f33640a5eb755d -e MLFLOW_TRACKING_URI=http://hostname -e MLFLOW_EXPERIMENT_ID=1 -e AWS_SECRET_ACCESS_KEY=**** -e AWS_ACCESS_KEY_ID=**** -e PYTHONPATH=/mlflow/projects/code:/mlflow/projects/code/applicant -e MLFLOW_SNOW_PWD=*** -e MLFLOW_SNOW_USER=**** applicant':9ca4ed7 python applicant'/predict.py --start-date 2021-04-01 --end-date 2021-04-30 --run-id 15c85e076c654d609bfdc7bcb30cfbe9 --env PROD --dw-date-valid 2021-05-02' in run with ID 'f8e19ea984c2499293f33640a5eb755d' ===\r\n2021/05/04 09:00:26 INFO mlflow.projects: === Run (ID 'f8e19ea984c2499293f33640a5eb755d') succeeded ===\r\n```\r\n\r\n## Motivation\r\n- What is the use case for this feature?\r\nIf you provide sensitive information via environment variables into MLFlow project, you can mask them in the log.\r\n- Why is this use case valuable to support for MLflow users in general?\r\nBetter security.\r\n- Why is this use case valuable to support for your project(s) or organization?\r\nBetter security.\r\n- Why is it currently difficult to achieve this use case? (please be as specific as possible about why related MLflow features and components are insufficient)\r\nAs I understand it. At the moment, the problematic log line i hardcoded in \r\nhttps://github.com/mlflow/mlflow/blob/c635d1aa12e1749ab1321128ac61c0f3e6309c1d/mlflow/projects/backend/local.py#L191 and it gets all environment values from MLFlow Project file from here\r\nhttps://github.com/mlflow/mlflow/blob/c635d1aa12e1749ab1321128ac61c0f3e6309c1d/mlflow/projects/backend/local.py#L83\r\nand those env vars are prepared in here for the final command \r\nhttps://github.com/mlflow/mlflow/blob/c635d1aa12e1749ab1321128ac61c0f3e6309c1d/mlflow/projects/backend/local.py#L235\r\n\r\n### What component(s), interfaces, languages, and integrations does this feature affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [x] `area/docs`: MLflow documentation pages\r\n- [x] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [x] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterfaces\r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [x] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguages \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n\r\n## Details\r\n\r\nI would add the list to the MLProject `docker_env` section as above:\r\n```\r\ndocker_env:\r\n  image: \"dcreg.service.consul/prod/lmc-bi-models-pythia:latest\"\r\n  environment: [[\"PYTHONPATH\", \"/mlflow/projects/code:/mlflow/projects/code/pythia\"],\r\n                MLFLOW_SNOW_PWD,\r\n                MLFLOW_SNOW_USER\r\n               ]\r\n  mask_environment_log: [\"MLFLOW_SNOW_PWD\",\r\n               \"MLFLOW_SNOW_PWD\",\r\n               ....,\r\n               ...\r\n               ]\r\n```\r\n\r\nand just separate the command for execution and command which goes into the log in here\r\nhttps://github.com/mlflow/mlflow/blob/c635d1aa12e1749ab1321128ac61c0f3e6309c1d/mlflow/projects/backend/local.py#L191\r\n\r\nInstead of \r\n```\r\n=== Running command 'docker run --rm --name applicant_airflow -e MLFLOW_RUN_ID=f8e19ea984c2499293f33640a5eb755d -e MLFLOW_TRACKING_URI=http://hostname -e MLFLOW_EXPERIMENT_ID=1 -e AWS_SECRET_ACCESS_KEY=realKey -e AWS_ACCESS_KEY_ID=realId -e PYTHONPATH=/mlflow/projects/code:/mlflow/projects/code/applicant -e MLFLOW_SNOW_PWD=realPwd -e MLFLOW_SNOW_USER=realIUser applicant':9ca4ed7 python applicant'/predict.py --start-date 2021-04-01 --end-date 2021-04-30 --run-id 15c85e076c654d609bfdc7bcb30cfbe9 --env PROD --dw-date-valid 2021-05-02' in run with ID 'f8e19ea984c2499293f33640a5eb755d' ===\r\n```\r\nit would be\r\n```\r\n=== Running command 'docker run --rm --name applicant_airflow -e MLFLOW_RUN_ID=f8e19ea984c2499293f33640a5eb755d -e MLFLOW_TRACKING_URI=http://hostname -e MLFLOW_EXPERIMENT_ID=1 -e AWS_SECRET_ACCESS_KEY=**** -e AWS_ACCESS_KEY_ID=**** -e PYTHONPATH=/mlflow/projects/code:/mlflow/projects/code/applicant -e MLFLOW_SNOW_PWD=*** -e MLFLOW_SNOW_USER=**** applicant':9ca4ed7 python applicant'/predict.py --start-date 2021-04-01 --end-date 2021-04-30 --run-id 15c85e076c654d609bfdc7bcb30cfbe9 --env PROD --dw-date-valid 2021-05-02' in run with ID 'f8e19ea984c2499293f33640a5eb755d' ===\r\n```\r\n\r\nDoes it make sense?\r\nThanks for discussion!\r\n","closed_by":{"login":"jhettler","id":6342027,"node_id":"MDQ6VXNlcjYzNDIwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/6342027?v=4","gravatar_id":"","url":"https://api.github.com/users/jhettler","html_url":"https://github.com/jhettler","followers_url":"https://api.github.com/users/jhettler/followers","following_url":"https://api.github.com/users/jhettler/following{/other_user}","gists_url":"https://api.github.com/users/jhettler/gists{/gist_id}","starred_url":"https://api.github.com/users/jhettler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhettler/subscriptions","organizations_url":"https://api.github.com/users/jhettler/orgs","repos_url":"https://api.github.com/users/jhettler/repos","events_url":"https://api.github.com/users/jhettler/events{/privacy}","received_events_url":"https://api.github.com/users/jhettler/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4357/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4357/timeline","performed_via_github_app":null,"state_reason":"completed"}