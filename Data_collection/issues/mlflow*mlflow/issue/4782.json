{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4782","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4782/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4782/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4782/events","html_url":"https://github.com/mlflow/mlflow/issues/4782","id":989748340,"node_id":"MDU6SXNzdWU5ODk3NDgzNDA=","number":4782,"title":"[BUG] Tensorflow `load_model()` drops reference to variables in graph","user":{"login":"Chromatius","id":16374386,"node_id":"MDQ6VXNlcjE2Mzc0Mzg2","avatar_url":"https://avatars.githubusercontent.com/u/16374386?v=4","gravatar_id":"","url":"https://api.github.com/users/Chromatius","html_url":"https://github.com/Chromatius","followers_url":"https://api.github.com/users/Chromatius/followers","following_url":"https://api.github.com/users/Chromatius/following{/other_user}","gists_url":"https://api.github.com/users/Chromatius/gists{/gist_id}","starred_url":"https://api.github.com/users/Chromatius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Chromatius/subscriptions","organizations_url":"https://api.github.com/users/Chromatius/orgs","repos_url":"https://api.github.com/users/Chromatius/repos","events_url":"https://api.github.com/users/Chromatius/events{/privacy}","received_events_url":"https://api.github.com/users/Chromatius/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-09-07T08:51:10Z","updated_at":"2022-07-03T09:29:00Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MacOS Big Sur\r\n- **MLflow installed from (source or binary)**: Source\r\n- **MLflow version (run ``mlflow --version``)**: 1.20.2.dev0\r\n- **Python version**: 3.9.4\r\n- **npm version, if running the dev UI**: Not applicable\r\n- **Exact command to reproduce**: \r\n\r\n```python\r\nmodel_loaded = mlflow.tensorflow.load_model(output_path)   \r\n\r\n# Code block here to produce an example_tensor tf.train.Example which is fed to the model.\r\n\r\nmodel_loaded(example_tensor)\r\n``` \r\n\r\n### Describe the problem\r\nWhen attempting to run the loaded model for inference it raises the following stack trace pasted below. The model is unable to find variables in the model, and the same issue has been tracked in a couple of Tensorflow issues, see [#33060](https://github.com/tensorflow/tensorflow/issues/33060) and [#37615](https://github.com/tensorflow/tensorflow/issues/37615). \r\n\r\nIn short, the problem seems to be that when a model is loaded inside of a function's scope, the variables are garbage collected when exiting that scope. It is possible to force the interpreter to track the variables by modifying the `_load_tensorflow_saved_model` function to add them as an attribute to the model signature, like this:\r\n\r\n```python\r\ndef _load_tensorflow_saved_model(\r\n    tf_saved_model_dir, tf_meta_graph_tags, tf_signature_def_key, tf_sess=None\r\n):\r\n    if Version(tensorflow.__version__) < Version(\"2.0.0\"):\r\n        loaded = tensorflow.saved_model.loader.load(\r\n            sess=tf_sess, tags=tf_meta_graph_tags, export_dir=tf_saved_model_dir\r\n        )\r\n        loaded_sig = loaded.signature_def\r\n    else:\r\n        print(\"Loading Tensorflow2 version...\")\r\n        loaded = tensorflow.saved_model.load(  # pylint: disable=no-value-for-parameter\r\n            tags=tf_meta_graph_tags, export_dir=tf_saved_model_dir\r\n        )\r\n        loaded_sig = loaded.signatures\r\n    if tf_signature_def_key not in loaded_sig:\r\n        raise MlflowException(\r\n            \"Could not find signature def key %s. Available keys are: %s\"\r\n            % (tf_signature_def_key, list(loaded_sig.keys()))\r\n        )\r\n\r\n    model_sig = loaded_sig[tf_signature_def_key]\r\n    model_sig._backref_to_saved_model = loaded\r\n    return model_sig\r\n```\r\n\r\n\r\n### Code to reproduce issue\r\n```python\r\n\r\noutput_path = \"output/path/for/model\"\r\n\r\n# Schema for MNIST classification with tf.train.Example serialized input\r\ninput_schema = Schema(\r\n    [\r\n        TensorSpec(np.dtype(\"bytes\"), (-1, 1)),\r\n    ]\r\n)\r\noutput_schema = Schema(\r\n    [\r\n        TensorSpec(np.dtype(np.float32), (-1, 10))\r\n    ]\r\n)\r\n\r\nsignature = ModelSignature(inputs=input_schema, outputs=output_schema)\r\n\r\nmlflow.tensorflow.save_model(\r\n    tf_saved_model_dir=\"path/to/savedModel\",\r\n    tf_meta_graph_tags=[\"serve\"],\r\n    tf_signature_def_key=\"serve_example\",\r\n    path=output_path,\r\n    signature=signature\r\n)\r\n\r\n\r\nmodel_loaded = mlflow.tensorflow.load_model(output_path)   \r\n\r\n# Code block here to produce an example_tensor tf.train.Example which is fed to the model.\r\n\r\nmodel_loaded(example_tensor)\r\n``` \r\n\r\n### Other info / logs\r\nStack trace\r\n\r\n```\r\n2021-09-07 10:37:51.076618: W tensorflow/core/framework/op_kernel.cc:1767] OP_REQUIRES failed at resource_variable_ops.cc:657 : Not found: Resource localhost/_AnonymousVar24/N10tensorflow3VarE does not exist.\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _call_impl(self, args, kwargs, cancellation_manager)\r\n   1719         try:\r\n-> 1720           return self._call_with_structured_signature(args, kwargs,\r\n   1721                                                       cancellation_manager)\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _call_with_structured_signature(self, args, kwargs, cancellation_manager)\r\n   1797         self._function_spec.canonicalize_function_inputs(*args, **kwargs)\r\n-> 1798     self._structured_signature_check_missing_args(args, kwargs)\r\n   1799     self._structured_signature_check_unexpected_args(args, kwargs)\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _structured_signature_check_missing_args(self, args, kwargs)\r\n   1816     if missing_arguments:\r\n-> 1817       raise TypeError(\"{} missing required arguments: {}\".format(\r\n   1818           self._structured_signature_summary(),\r\n\r\nTypeError: signature_wrapper(*, examples) missing required arguments: examples\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nFailedPreconditionError                   Traceback (most recent call last)\r\n/var/folders/81/j6spqkp903s_7nvwgc24v69m0000gn/T/ipykernel_7022/4032791860.py in <module>\r\n----> 1 model_loaded(example_tensor)[\"output_0\"]\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in __call__(self, *args, **kwargs)\r\n   1709       TypeError: If the arguments do not match the function's signature.\r\n   1710     \"\"\"\r\n-> 1711     return self._call_impl(args, kwargs)\r\n   1712 \r\n   1713   def _call_impl(self, args, kwargs, cancellation_manager=None):\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _call_impl(self, args, kwargs, cancellation_manager)\r\n   1722         except TypeError as structured_err:\r\n   1723           try:\r\n-> 1724             return self._call_with_flat_signature(args, kwargs,\r\n   1725                                                   cancellation_manager)\r\n   1726           except TypeError:\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _call_with_flat_signature(self, args, kwargs, cancellation_manager)\r\n   1776                         \"got {} ({})\".format(self._flat_signature_summary(), i,\r\n   1777                                              type(arg).__name__, str(arg)))\r\n-> 1778     return self._call_flat(args, self.captured_inputs, cancellation_manager)\r\n   1779 \r\n   1780   def _call_with_structured_signature(self, args, kwargs, cancellation_manager):\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/saved_model/load.py in _call_flat(self, args, captured_inputs, cancellation_manager)\r\n    115     else:  # cross-replica context\r\n    116       captured_inputs = list(map(get_unused_handle, captured_inputs))\r\n--> 117     return super(_WrapperFunction, self)._call_flat(args, captured_inputs,\r\n    118                                                     cancellation_manager)\r\n    119 \r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in _call_flat(self, args, captured_inputs, cancellation_manager)\r\n   1958         and executing_eagerly):\r\n   1959       # No tape is watching; skip to running the function.\r\n-> 1960       return self._build_call_outputs(self._inference_function.call(\r\n   1961           ctx, args, cancellation_manager=cancellation_manager))\r\n   1962     forward_backward = self._select_forward_and_backward_functions(\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/function.py in call(self, ctx, args, cancellation_manager)\r\n    589       with _InterpolateFunctionError(self):\r\n    590         if cancellation_manager is None:\r\n--> 591           outputs = execute.execute(\r\n    592               str(self.signature.name),\r\n    593               num_outputs=self._num_outputs,\r\n\r\n~/.virtualenvs/tf-testing/lib/python3.9/site-packages/tensorflow/python/eager/execute.py in quick_execute(op_name, num_outputs, inputs, attrs, ctx, name)\r\n     57   try:\r\n     58     ctx.ensure_initialized()\r\n---> 59     tensors = pywrap_tfe.TFE_Py_Execute(ctx._handle, device_name, op_name,\r\n     60                                         inputs, attrs, num_outputs)\r\n     61   except core._NotOkStatusException as e:\r\n\r\nFailedPreconditionError:  Could not find variable _AnonymousVar28. This could mean that the variable has been deleted. In TF1, it can also mean the variable is uninitialized. Debug info: container=localhost, status=Not found: Resource localhost/_AnonymousVar28/N10tensorflow3VarE does not exist.\r\n\t [[{{node StatefulPartitionedCall/mnist_model/dense_2/MatMul/ReadVariableOp}}]] [Op:__inference_signature_wrapper_1775]\r\n\r\nFunction call stack:\r\nsignature_wrapper\r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4782/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4782/timeline","performed_via_github_app":null,"state_reason":null}