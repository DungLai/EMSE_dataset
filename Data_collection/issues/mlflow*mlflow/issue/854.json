{"url":"https://api.github.com/repos/mlflow/mlflow/issues/854","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/854/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/854/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/854/events","html_url":"https://github.com/mlflow/mlflow/issues/854","id":404163113,"node_id":"MDU6SXNzdWU0MDQxNjMxMTM=","number":854,"title":"bug: mlflow in R fail to call mlflow_param","user":{"login":"harryprince","id":5362577,"node_id":"MDQ6VXNlcjUzNjI1Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/5362577?v=4","gravatar_id":"","url":"https://api.github.com/users/harryprince","html_url":"https://github.com/harryprince","followers_url":"https://api.github.com/users/harryprince/followers","following_url":"https://api.github.com/users/harryprince/following{/other_user}","gists_url":"https://api.github.com/users/harryprince/gists{/gist_id}","starred_url":"https://api.github.com/users/harryprince/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harryprince/subscriptions","organizations_url":"https://api.github.com/users/harryprince/orgs","repos_url":"https://api.github.com/users/harryprince/repos","events_url":"https://api.github.com/users/harryprince/events{/privacy}","received_events_url":"https://api.github.com/users/harryprince/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-01-29T07:52:08Z","updated_at":"2019-08-01T19:10:46Z","closed_at":"2019-02-07T00:18:21Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n\r\n```\r\nR version 3.4.2 (2017-09-28)\r\nPlatform: x86_64-pc-linux-gnu (64-bit)\r\nRunning under: CentOS Linux 7 (Core)\r\n\r\nMatrix products: default\r\nBLAS: /data/opt/R/3.4.2/lib64/R/lib/libRblas.so\r\nLAPACK: /data/opt/R/3.4.2/lib64/R/lib/libRlapack.so\r\n\r\nlocale:\r\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \r\n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \r\n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \r\n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \r\n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \r\n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \r\n\r\nattached base packages:\r\n[1] stats     graphics  grDevices utils     datasets  methods   base     \r\n\r\nother attached packages:\r\n [1] mapdeck_0.2.1       sparklyr_0.9.3.9000 mapview_2.3.0      \r\n [4] bindrcpp_0.2.2      flexdashboard_0.5.1 forcats_0.2.0      \r\n [7] stringr_1.3.1       dplyr_0.7.8         readr_1.1.1        \r\n[10] tidyr_0.8.2         tibble_2.0.1        ggplot2_3.1.0      \r\n[13] tidyverse_1.2.1    \r\n\r\nloaded via a namespace (and not attached):\r\n  [1] colorspace_1.3-2       class_7.3-14           gdalUtils_2.0.1.7     \r\n  [4] leaflet_2.0.2          rgdal_1.3-6            rprojroot_1.3-2       \r\n  [7] satellite_1.0.1        fs_1.2.6               base64enc_0.1-3       \r\n [10] rstudioapi_0.9.0       fansi_0.4.0            lubridate_1.7.4       \r\n [13] xml2_1.2.0             codetools_0.2-15       R.methodsS3_1.7.1     \r\n [16] knitr_1.21             config_0.3             jsonlite_1.6          \r\n [19] broom_0.5.0            dbplyr_1.2.2           leafletCN_0.2.1       \r\n [22] png_0.1-7              R.oo_1.21.0            jsonify_0.2.0         \r\n [25] shiny_1.2.0            compiler_3.4.2         httr_1.4.0            \r\n [28] backports_1.1.2        Matrix_1.2-14          assertthat_0.2.0      \r\n [31] lazyeval_0.2.1         cli_1.0.1              later_0.7.5           \r\n [34] htmltools_0.3.6        tools_3.4.2            gtable_0.2.0          \r\n [37] glue_1.3.0             rappdirs_0.3.1         Rcpp_1.0.0.1          \r\n [40] cellranger_1.1.0       raster_2.8-4           debugme_1.1.0         \r\n [43] nlme_3.1-131           iterators_1.0.9        crosstalk_1.0.0       \r\n [46] xfun_0.4               rvest_0.3.2            mime_0.6              \r\n [49] devtools_1.13.4        scales_1.0.0           hms_0.4.0             \r\n [52] promises_1.0.1         parallel_3.4.2         swagger_3.9.2         \r\n [55] yaml_2.2.0             curl_3.2               memoise_1.1.0         \r\n [58] reticulate_1.10.0.9003 forge_0.1.0            stringi_1.2.4         \r\n [61] foreach_1.4.4          e1071_1.7-0            leaflet.extras_1.0.0  \r\n [64] rlang_0.3.1            pkgconfig_2.0.2        evaluate_0.12         \r\n [67] lattice_0.20-35        bindr_0.1.1            sf_0.7-2              \r\n [70] htmlwidgets_1.3        tidyselect_0.2.5       processx_3.2.1        \r\n [73] plyr_1.8.4             magrittr_1.5           R6_2.3.0              \r\n [76] DBI_1.0.0              carrier_0.1.0          pillar_1.3.1          \r\n [79] haven_1.1.2            withr_2.1.2.9000       units_0.6-2           \r\n [82] sp_1.3-1               modelr_0.1.1           crayon_1.3.4          \r\n [85] utf8_1.1.4             rmarkdown_1.11         grid_3.4.2            \r\n [88] readxl_1.0.0           git2r_0.24.0           colourvalues_0.2.2    \r\n [91] digest_0.6.18          classInt_0.3-1         webshot_0.5.0         \r\n [94] xtable_1.8-3           httpuv_1.4.5.1         r2d3_0.2.2            \r\n [97] R.utils_2.7.0          openssl_1.2.1          stats4_3.4.2          \r\n[100] munsell_0.5.0          viridisLite_0.3.0  \r\n```\r\n\r\n### Describe the problem\r\n\r\nmlflow::mlflow_param does not work due to `forge::cast_choice` bug.\r\n\r\nI check the `mlflow::mlflow_param` source code:\r\n\r\n```\r\nfunction (name, default = NULL, type = NULL, description = NULL) \r\n{\r\n    target_type <- forge::cast_choice(type, c(\"numeric\", \"integer\", \r\n        \"string\"), allow_null = TRUE) %||% typeof(default)\r\n    if (identical(target_type, \"NULL\")) \r\n        stop(\"At least one of `default` or `type` must be specified\", \r\n            call. = FALSE)\r\n    caster <- switch(target_type, integer = forge::cast_nullable_scalar_integer, \r\n        double = forge::cast_nullable_scalar_double, numeric = forge::cast_nullable_scalar_double, \r\n        forge::cast_nullable_string)\r\n    default <- tryCatch(if (!is.null(default)) \r\n        caster(default), error = function(e) stop(\"`default` value for `\", \r\n        name, \"` cannot be casted to type \", type, \": \", conditionMessage(e), \r\n        call. = FALSE))\r\n    tryCatch(caster(.globals$run_params[[name]]) %||% default, \r\n        error = function(e) stop(\"Provided value for `\", name, \r\n            \"` cannot be casted to type \", type, \": \", conditionMessage(e), \r\n            call. = FALSE))\r\n}\r\n<bytecode: 0x5582282f2c38>\r\n<environment: namespace:mlflow>\r\n```\r\n\r\nAnd I found `forge::cast_choice` source code:\r\n```\r\nfunction (.x, .choices, .allow_na = FALSE, .allow_null = FALSE, \r\n    .id = NULL) \r\n{\r\n    .id <- resolve_id(rlang::enquo(.x), .id)\r\n    cast <- switch(rlang::type_of(.choices), integer = cast_scalar_integer, \r\n        double = cast_scalar_double, string = cast_scalar_character, \r\n        character = cast_scalar_character)\r\n    if (is.null(cast)) \r\n        stop(\"`.choices` must be a vector of numbers or strings.\", \r\n            call. = FALSE)\r\n    if (rlang::is_na(.x)) {\r\n        if (.allow_na) \r\n            return(new_forge_stamped(.x, .id = .id))\r\n        else stop(backticks(.id), \" must not be NA.\", call. = FALSE)\r\n    }\r\n    if (rlang::is_null(.x)) {\r\n        if (.allow_null) \r\n            return(NULL)\r\n        else stop(backticks(.id), \" must not be NULL.\", call. = FALSE)\r\n    }\r\n    casted <- cast(.x)\r\n    if (casted %in% .choices) \r\n        new_forge_stamped(casted, .id = .id)\r\n    else stop(backticks(.id), \" must be one of \", paste0(.choices, \r\n        collapse = \", \"), \".\", call. = FALSE)\r\n}\r\n<bytecode: 0x558224bcec78>\r\n<environment: namespace:forge>\r\n```\r\n\r\nthe argument `allow_null` and `.allow_null` are inconsistent.\r\n\r\n### Source code / logs\r\n\r\nR/mlflow seems bugy:\r\n\r\n```\r\nlibrary(mlflow)\r\nmlflow_set_tracking_uri(\"http://0.0.0.0:5000\")\r\nmlflow_set_experiment(\"pp_v2\")\r\nmy_int <- mlflow_param(\"my_int\", 1, \"integer\")\r\n```\r\n\r\n```\r\nError in forge::cast_choice(type, c(\"numeric\", \"integer\", \"string\"), allow_null = TRUE): unused argument (allow_null = TRUE)\r\n```\r\nI think @kevinykuo should notice this issue.","closed_by":{"login":"kevinykuo","id":5582151,"node_id":"MDQ6VXNlcjU1ODIxNTE=","avatar_url":"https://avatars.githubusercontent.com/u/5582151?v=4","gravatar_id":"","url":"https://api.github.com/users/kevinykuo","html_url":"https://github.com/kevinykuo","followers_url":"https://api.github.com/users/kevinykuo/followers","following_url":"https://api.github.com/users/kevinykuo/following{/other_user}","gists_url":"https://api.github.com/users/kevinykuo/gists{/gist_id}","starred_url":"https://api.github.com/users/kevinykuo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kevinykuo/subscriptions","organizations_url":"https://api.github.com/users/kevinykuo/orgs","repos_url":"https://api.github.com/users/kevinykuo/repos","events_url":"https://api.github.com/users/kevinykuo/events{/privacy}","received_events_url":"https://api.github.com/users/kevinykuo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/854/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/854/timeline","performed_via_github_app":null,"state_reason":"completed"}