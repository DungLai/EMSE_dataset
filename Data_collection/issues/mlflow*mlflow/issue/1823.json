{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1823","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1823/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1823/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1823/events","html_url":"https://github.com/mlflow/mlflow/issues/1823","id":490701300,"node_id":"MDU6SXNzdWU0OTA3MDEzMDA=","number":1823,"title":"MLFlow Pyfunc failing on Databricks (missing python lib pip dependencies)  ","user":{"login":"arnaudsj","id":9855,"node_id":"MDQ6VXNlcjk4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/9855?v=4","gravatar_id":"","url":"https://api.github.com/users/arnaudsj","html_url":"https://github.com/arnaudsj","followers_url":"https://api.github.com/users/arnaudsj/followers","following_url":"https://api.github.com/users/arnaudsj/following{/other_user}","gists_url":"https://api.github.com/users/arnaudsj/gists{/gist_id}","starred_url":"https://api.github.com/users/arnaudsj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnaudsj/subscriptions","organizations_url":"https://api.github.com/users/arnaudsj/orgs","repos_url":"https://api.github.com/users/arnaudsj/repos","events_url":"https://api.github.com/users/arnaudsj/events{/privacy}","received_events_url":"https://api.github.com/users/arnaudsj/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2019-09-08T02:20:41Z","updated_at":"2020-01-04T19:25:20Z","closed_at":"2020-01-04T19:25:20Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes, I have made the code available in this repo: https://github.com/arnaudsj/sample-mlflow-spacy\r\n- **OS Platform and Distribution**: OS 10.14.6 locally / Databricks 5.5 Conda Beta (includes Apache Spark 2.4.3, Scala 2.11)\r\n- **MLflow installed from**:  binary\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.2.0\r\n- **Python version**: Python 3.7.3\r\n- **npm version, if running the dev UI**: n/a\r\n- **Exact command to reproduce**: `mlfow run .` then \r\n\r\n### Describe the problem\r\nI am attempting to wrap up a simple Spacy model for language detection using the mlflow.pyfunc class, and running it locally on OS X in a conda env works fine, but when attempting to run it in Databricks, even though I confirmed that the right conda env gets created, when executed it in Spark it appears to be either outside of the conda env, or the env did not get provisioned with the pip dependencies and therefore fails to find the needed python libs (e.g. spacy, spacy_langdetect). It sound very similar to #1208, but the work around described in that issue did not work.\r\n\r\n### Code to reproduce issue\r\n- Clone the repo I prepared here: https://github.com/arnaudsj/sample-mlflow-spacy\r\n- run mlflow locally to test it works in a conda env `mlflow run .`\r\n- the expected output should be:\r\n```\r\n0    {'language': 'en', 'score': 0.9999975821644531}\r\n1    {'language': 'fr', 'score': 0.9999969564108246}\r\n```\r\n- set MLFLOW_EXPERIMENT_NAME to a valid path in .env\r\n- run `make` it will execute locally again, but this time log the model to Databricks\r\n- Launch a Databricks cluster with the proper runtime (Databricks 5.5 Conda Beta) and create a new Python notebook\r\n- Adapt and execute the following Python code based on the path to the MLFlow model:\r\n```\r\nfrom mlflow import pyfunc\r\nfrom pyspark.sql.types import *\r\n\r\npyfunc_udf = pyfunc.spark_udf(spark, model_uri=\"dbfs:/databricks/mlflow/3664730769366758/4328856e8c2f44d0af13566bda773536/artifacts/model\", result_type=StringType())\r\nsqlContext.udf.register(\"sample_spacy_lang_detect\", pyfunc_udf)\r\n```\r\n- Test the new UDF function in SparkSQL\r\n```\r\nSELECT sample_spacy_lang_detect('Hello, world!')\r\n```\r\n- Get traceback (as shared below) about missing python lib\r\n\r\n### Other info / logs\r\nHere is the traceback I get back from Databricks:\r\n```\r\n(TID 636, 10.27.239.82, executor 0): org.apache.spark.api.python.PythonException: Traceback (most recent call last):\r\n  File \"/databricks/spark/python/pyspark/worker.py\", line 480, in main\r\n    process()\r\n  File \"/databricks/spark/python/pyspark/worker.py\", line 472, in process\r\n    serializer.dump_stream(out_iter, outfile)\r\n  File \"/databricks/spark/python/pyspark/serializers.py\", line 404, in dump_stream\r\n    timely_flush_timeout_ms=self.timely_flush_timeout_ms)\r\n  File \"/databricks/spark/python/pyspark/serializers.py\", line 214, in dump_stream\r\n    for batch in iterator:\r\n  File \"/databricks/spark/python/pyspark/serializers.py\", line 394, in init_stream_yield_batches\r\n    for series in iterator:\r\n  File \"<string>\", line 1, in <lambda>\r\n  File \"/databricks/spark/python/pyspark/worker.py\", line 108, in <lambda>\r\n    verify_result_type(f(*a)), len(a[0])), arrow_return_type)\r\n  File \"/databricks/spark/python/pyspark/util.py\", line 99, in wrapper\r\n    return f(*args, **kwargs)\r\n  File \"/local_disk0/pythonVirtualEnvDirs/virtualEnv-6cdf22b7-0350-45ea-a13c-4fa6f6ae7d68/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 423, in predict\r\n  File \"/databricks/python/lib/python3.7/site-packages/mlflow/pyfunc/spark_model_cache.py\", line 63, in get_or_load\r\n    SparkModelCache._models[archive_path] = load_pyfunc(temp_dir)\r\n  File \"/databricks/python/lib/python3.7/site-packages/mlflow/utils/annotations.py\", line 40, in deprecated_func\r\n    return func(*args, **kwargs)\r\n  File \"/databricks/python/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 313, in load_pyfunc\r\n    return importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/databricks/python/lib/python3.7/site-packages/mlflow/pyfunc/model.py\", line 214, in _load_pyfunc\r\n    python_model = cloudpickle.load(f)\r\nModuleNotFoundError: No module named 'spacy'\r\n```\r\n\r\nThank you in advance for your help. And let me know if there is something that I am not doing correctly in the first place.","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1823/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1823/timeline","performed_via_github_app":null,"state_reason":"completed"}