{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3785","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3785/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3785/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3785/events","html_url":"https://github.com/mlflow/mlflow/issues/3785","id":757938301,"node_id":"MDU6SXNzdWU3NTc5MzgzMDE=","number":3785,"title":"[BUG] No index on foreign keys, in postgres store","user":{"login":"ludaavics","id":1891756,"node_id":"MDQ6VXNlcjE4OTE3NTY=","avatar_url":"https://avatars.githubusercontent.com/u/1891756?v=4","gravatar_id":"","url":"https://api.github.com/users/ludaavics","html_url":"https://github.com/ludaavics","followers_url":"https://api.github.com/users/ludaavics/followers","following_url":"https://api.github.com/users/ludaavics/following{/other_user}","gists_url":"https://api.github.com/users/ludaavics/gists{/gist_id}","starred_url":"https://api.github.com/users/ludaavics/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ludaavics/subscriptions","organizations_url":"https://api.github.com/users/ludaavics/orgs","repos_url":"https://api.github.com/users/ludaavics/repos","events_url":"https://api.github.com/users/ludaavics/events{/privacy}","received_events_url":"https://api.github.com/users/ludaavics/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1893072438,"node_id":"MDU6TGFiZWwxODkzMDcyNDM4","url":"https://api.github.com/repos/mlflow/mlflow/labels/help%20wanted","name":"help wanted","color":"c5def5","default":true,"description":"We would like help from the community to add this support"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"}],"state":"closed","locked":false,"assignee":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"assignees":[{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":24,"created_at":"2020-12-06T14:28:16Z","updated_at":"2022-06-16T17:44:54Z","closed_at":"2022-03-04T07:42:38Z","author_association":"NONE","active_lock_reason":null,"body":"## MLflow Roadmap Item\r\n\r\nThis is an MLflow Roadmap item that has been prioritized by the MLflow maintainers. We're seeking help with the implementation of roadmap items tagged with the `help wanted` label.\r\n\r\nFor requirements clarifications and implementation questions, or to request a PR review, please tag @WeichenXu123 in your communications related to this issue.\r\n\r\n### System information\r\n- Linux Ubuntu 18.04\r\n- MLflow installed from pip\r\n- MLFlow version 1.11:\r\n- Python version 3.8.3\r\n\r\n### Describe the problem\r\nThis might not be true for other dialects, but Postgres doesn't automatically index on FKs. It makes something as simple as querying all run details extremely slow, as the number of experiments / runs (the UI only allows to fetch results 100 at  time).\r\n\r\n\r\n### Code to reproduce issue\r\nThe following has about 10k rows but essentially times out.\r\n```\r\nSELECT * \r\nFROM runs\r\nJOIN params on params.run_uuid = runs.run_uuid\r\nJOIN metrics on metrics.run_uuid = params.run_uuid\r\nWHERE runs.experiment_id = 30\r\n```\r\n\r\n\r\n### Other info / logs\r\nQuery to get all the missing FKs ([credit](https://www.cybertec-postgresql.com/en/index-your-foreign-key/))\r\n```\r\nSELECT c.conrelid::regclass AS \"table\",\r\n       /* list of key column names in order */\r\n       string_agg(a.attname, ',' ORDER BY x.n) AS columns,\r\n       pg_catalog.pg_size_pretty(\r\n          pg_catalog.pg_relation_size(c.conrelid)\r\n       ) AS size,\r\n       c.conname AS constraint,\r\n       c.confrelid::regclass AS referenced_table\r\nFROM pg_catalog.pg_constraint c\r\n   /* enumerated key column numbers per foreign key */\r\n   CROSS JOIN LATERAL\r\n      unnest(c.conkey) WITH ORDINALITY AS x(attnum, n)\r\n   /* name for each key column */\r\n   JOIN pg_catalog.pg_attribute a\r\n      ON a.attnum = x.attnum\r\n         AND a.attrelid = c.conrelid\r\nWHERE NOT EXISTS\r\n        /* is there a matching index for the constraint? */\r\n        (SELECT 1 FROM pg_catalog.pg_index i\r\n         WHERE i.indrelid = c.conrelid\r\n           /* the first index columns must be the same as the\r\n              key columns, but order doesn't matter */\r\n           AND (i.indkey::smallint[])[0:cardinality(c.conkey)-1]\r\n               OPERATOR(pg_catalog.@>) c.conkey)\r\n  AND c.contype = 'f'\r\nGROUP BY c.conrelid, c.conname, c.confrelid\r\nORDER BY pg_catalog.pg_relation_size(c.conrelid) DESC;\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3785/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3785/timeline","performed_via_github_app":null,"state_reason":"completed"}