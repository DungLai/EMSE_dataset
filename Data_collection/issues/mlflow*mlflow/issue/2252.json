{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2252","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2252/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2252/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2252/events","html_url":"https://github.com/mlflow/mlflow/issues/2252","id":543911441,"node_id":"MDU6SXNzdWU1NDM5MTE0NDE=","number":2252,"title":"[BUG]Issue with subprocess.Popen in backend.py","user":{"login":"michael-vh","id":59362379,"node_id":"MDQ6VXNlcjU5MzYyMzc5","avatar_url":"https://avatars.githubusercontent.com/u/59362379?v=4","gravatar_id":"","url":"https://api.github.com/users/michael-vh","html_url":"https://github.com/michael-vh","followers_url":"https://api.github.com/users/michael-vh/followers","following_url":"https://api.github.com/users/michael-vh/following{/other_user}","gists_url":"https://api.github.com/users/michael-vh/gists{/gist_id}","starred_url":"https://api.github.com/users/michael-vh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michael-vh/subscriptions","organizations_url":"https://api.github.com/users/michael-vh/orgs","repos_url":"https://api.github.com/users/michael-vh/repos","events_url":"https://api.github.com/users/michael-vh/events{/privacy}","received_events_url":"https://api.github.com/users/michael-vh/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2022863969,"node_id":"MDU6TGFiZWwyMDIyODYzOTY5","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-soon","name":"priority/important-soon","color":"534cb5","default":false,"description":"The issue is worked on by the community currently or will be very soon, ideally in time for the"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-12-30T15:10:45Z","updated_at":"2022-06-02T01:23:51Z","closed_at":"2022-06-02T01:23:51Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MS Windows 10 Enterprise N\r\n- **MLflow installed from (source or binary)**: pip install mlflow\r\n- **MLflow version (run ``mlflow --version``)**: 1.5.0\r\n- **Python version**: Python 3.7.4 (anaconda)\r\n- **Exact command to reproduce**: mlflow models predict -m models/scikitlearn -i testdata/test_new.csv -t csv\r\n\r\n### Describe the problem\r\nI'm trying to run a prediction on an MLflow model that I have created with a python script and logged with mlflow.sklearn.log_model(). When running \"mlflow models predict\" I'm expecting to get predictions for the records that are included in a csv file, but instead I get an EOL error:\r\n\r\n> mlflow models predict -m models/scikitlearn -i testdata/test_new.csv -t csv\r\n2019/12/30 13:53:01 INFO mlflow.models.cli: Selected backend for flavor 'python_function'\r\n2019/12/30 13:53:03 INFO mlflow.pyfunc.backend: === Running command 'conda activate mlflow-0a64134cb46544fe47c7e20ac258fdf249f3f174 & python -c \"from mlflow.pyfunc.scoring_server import _predict; _predict(model_uri='file:///C:/Users/xxx/Documents/mlflowtest/models/scikitlearn', input_path='testdata/test_new.csv', output_path=None, content_type='csv', json_format='split')\"'\r\nFile \"\", line 1\r\n\"from\r\n^\r\nSyntaxError: EOL while scanning string literal\r\n\r\nWhen I copy and execute the command that mlflow is trying to execute\r\n`conda activate mlflow-0a64134cb46544fe47c7e20ac258fdf249f3f174 & python -c \"from mlflow.pyfunc.scoring_server import _predict; _predict(model_uri='file:///C:/Users/xxx/Documents/mlflowtest/models/scikitlearn', input_path='testdata/test_new.csv', output_path=None, content_type='csv', json_format='split')\"`\r\nit works perfectly fine and returns the predictions for the records in the csv file. So the model seems to be working.\r\n\r\nGoing into the source code, the issue seems to be located inside the backend.py file (https://github.com/mlflow/mlflow/blob/master/mlflow/pyfunc/backend.py). Where the command above is executed with\r\n`subprocess.Popen([\"cmd\", \"/c\", command], close_fds=True, env=command_env)`\r\nSo it seems the Popen command is creating this issue.\r\n\r\nI confirmed this by running a simple python script with the following lines, which returned the same EOL error:\r\n```\r\nimport subprocess\r\ncommand = '''conda activate mlflow-0a64134cb46544fe47c7e20ac258fdf249f3f174 & python -c \"from mlflow.pyfunc.scoring_server import _predict; _predict(model_uri='file:///C:/Users/xxx/Documents/mlflowtest/models/scikitlearn', input_path='testdata/test_new.csv', output_path=None, content_type='csv', json_format='split')\"'''\r\nchild = subprocess.Popen([\"cmd\", \"/c\", command], close_fds=True, env=None)\r\n```\r\n\r\n### Code to reproduce issue\r\nmlflow models predict -m models/scikitlearn -i testdata/test_new.csv -t csv\r\n\r\n### Other info / logs\r\n\r\nFull error:\r\n> mlflow models predict -m models/scikitlearn -i testdata/test_new.csv -t csv\r\n2019/12/30 13:53:01 INFO mlflow.models.cli: Selected backend for flavor 'python_function'\r\n2019/12/30 13:53:03 INFO mlflow.pyfunc.backend: === Running command 'conda activate mlflow-0a64134cb46544fe47c7e20ac258fdf249f3f174 & python -c \"from mlflow.pyfunc.scoring_server import _predict; _predict(model_uri='file:///C:/Users/xxx/Documents/mlflowtest/models/scikitlearn', input_path='testdata/test_new.csv', output_path=None, content_type='csv', json_format='split')\"'\r\nFile \"\", line 1\r\n\"from\r\n^\r\nSyntaxError: EOL while scanning string literal\r\nTraceback (most recent call last):\r\nFile \"c:\\programdata\\anaconda3\\lib\\runpy.py\", line 193, in _run_module_as_main\r\n\"\\__main\\__\", mod_spec)\r\nFile \"c:\\programdata\\anaconda3\\lib\\runpy.py\", line 85, in _run_code\r\nexec(code, run_globals)\r\nFile \"C:\\ProgramData\\Anaconda3\\Scripts\\mlflow.exe__main__.py\", line 9, in\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 764, in \\__call\\__\r\nreturn self.main(*args, **kwargs)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 717, in main\r\nrv = self.invoke(ctx)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 1137, in invoke\r\nreturn _process_result(sub_ctx.command.invoke(sub_ctx))\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 1137, in invoke\r\nreturn _process_result(sub_ctx.command.invoke(sub_ctx))\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 956, in invoke\r\nreturn ctx.invoke(self.callback, **ctx.params)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\click\\core.py\", line 555, in invoke\r\nreturn callback(*args, **kwargs)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\mlflow\\models\\cli.py\", line 92, in predict\r\njson_format=json_format)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\mlflow\\pyfunc\\backend.py\", line 62, in predict\r\nreturn _execute_in_conda_env(conda_env_path, command, self._install_mlflow)\r\nFile \"c:\\programdata\\anaconda3\\lib\\site-packages\\mlflow\\pyfunc\\backend.py\", line 172, in _execute_in_conda_env\r\ncommand, rc\r\nException: Command 'conda activate mlflow-0a64134cb46544fe47c7e20ac258fdf249f3f174 & python -c \"from mlflow.pyfunc.scoring_server import _predict; _predict(model_uri='file:///C:/Users/xxx/Documents/mlflowtest/models/scikitlearn', input_path='testdata/test_new.csv', output_path=None, content_type='csv', json_format='split')\"' returned non zero return code. Return code = 1\r\n\r\nMLflow model conda.yaml file:\r\n- channels:\r\n  - defaults\r\n- dependencies:\r\n  - python=3.6.9\r\n  - scikit-learn=0.22\r\n  - pip:\r\n    - mlflow\r\n    - cloudpickle==1.2.2\r\n- name: mlflow-env","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2252/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2252/timeline","performed_via_github_app":null,"state_reason":"completed"}