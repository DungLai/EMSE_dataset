{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2630","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2630/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2630/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2630/events","html_url":"https://github.com/mlflow/mlflow/issues/2630","id":587263269,"node_id":"MDU6SXNzdWU1ODcyNjMyNjk=","number":2630,"title":"[BUG] s3 artifact as parameter is broken - doesn't support MLFLOW_S3_ENDPOINT_URL  ","user":{"login":"zamiramos","id":24910490,"node_id":"MDQ6VXNlcjI0OTEwNDkw","avatar_url":"https://avatars.githubusercontent.com/u/24910490?v=4","gravatar_id":"","url":"https://api.github.com/users/zamiramos","html_url":"https://github.com/zamiramos","followers_url":"https://api.github.com/users/zamiramos/followers","following_url":"https://api.github.com/users/zamiramos/following{/other_user}","gists_url":"https://api.github.com/users/zamiramos/gists{/gist_id}","starred_url":"https://api.github.com/users/zamiramos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zamiramos/subscriptions","organizations_url":"https://api.github.com/users/zamiramos/orgs","repos_url":"https://api.github.com/users/zamiramos/repos","events_url":"https://api.github.com/users/zamiramos/events{/privacy}","received_events_url":"https://api.github.com/users/zamiramos/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1893057631,"node_id":"MDU6TGFiZWwxODkzMDU3NjMx","url":"https://api.github.com/repos/mlflow/mlflow/labels/Acknowledged","name":"Acknowledged","color":"f9d0c4","default":false,"description":"This issue has been read and acknowledged by the MLflow admins."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-03-24T20:36:29Z","updated_at":"2021-12-15T13:09:18Z","closed_at":"2020-04-17T23:22:07Z","author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\nfor information on what types of issues we address. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\nPlease fill in this template and do not delete it unless you are sure your issue is outside its scope.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Debian\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.7.2\r\n- **Python version**: 3.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: mlflow run .\r\nenv variables:\r\n            - name:  MLFLOW_TRACKING_URI\r\n              value: http://mlflow-server:5000\r\n            - name: AWS_ACCESS_KEY_ID\r\n              value: minioadmin\r\n            - name: AWS_SECRET_ACCESS_KEY\r\n              value: minioadmin\r\n            - name: ARTIFACT_ROOT\r\n              value: s3://mlflow/\r\n            - name: MLFLOW_S3_ENDPOINT_URL\r\n              value: http://minio-demo:9000\r\n\r\n### Describe the problem\r\nI download the example code from \"https://github.com/mlflow/mlflow/tree/master/examples/multistep_workflow\", and run it against mlflow server which configured to work with minio s3 server. \r\n\r\nThe first phase \"load_raw_data\" of the workflow works perfectly and succeeded to save the ratings.csv file to s3 bucket but failed in the next phase \"etl_data\" when it tries to load the ratings.csv from the s3 server,\r\n\r\nAfter looking at the code, I have noticed that loading the artifact was working since it uses the \"https://github.com/mlflow/mlflow/blob/bde9c044f7b883723b3255e3c39eeb49a3c81fc2/mlflow/store/artifact/s3_artifact_repo.py\"\r\nwhich takes into account the environment variable MLFLOW_S3_ENDPOINT_URL and when it tries to load the artifact as part of the parameters parsing for the next phase it uses the \"https://github.com/mlflow/mlflow/blob/master/mlflow/data.py\" which ignore the environment variable MLFLOW_S3_ENDPOINT_URL.\r\n\r\nThe logs are:\r\nERROR conda.cli.main_run:execute(32): Subprocess for 'conda run ['mlflow', 'run', '.']' command failed.  (See above for error)\r\n/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/pyspark/cloudpickle.py:47: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses\r\n  import imp\r\n2020/03/24 15:19:53 INFO mlflow.projects: === Created directory /tmp/tmpza0zd19z for downloading remote URIs passed to arguments of type 'path' ===\r\n2020/03/24 15:19:53 INFO mlflow.projects: === Running command 'source /opt/conda/bin/../etc/profile.d/conda.sh && conda activate mlflow-9f5167292d547c49da28744ec745f90b2b35e40e 1>&2 && python main.py --als-max-iter 10 --keras-hidden-units 20 --max-row-limit 100000' in run with ID '119dd241293c430baaa989753c6741c2' === \r\nNo matching run has been found.\r\n2020/03/24 15:19:54 INFO mlflow.projects: === Created directory /tmp/tmpsfa2xukx for downloading remote URIs passed to arguments of type 'path' ===\r\nTraceback (most recent call last):\r\n  File \"main.py\", line 105, in <module>\r\n    workflow()\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/click/core.py\", line 829, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/click/core.py\", line 782, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/click/core.py\", line 1066, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/click/core.py\", line 610, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"main.py\", line 86, in workflow\r\n    git_commit)\r\n  File \"main.py\", line 67, in _get_or_run\r\n    submitted_run = mlflow.run(\".\", entrypoint, parameters=parameters)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/__init__.py\", line 288, in run\r\n    use_conda=use_conda, storage_dir=storage_dir, synchronous=synchronous, run_id=run_id)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/__init__.py\", line 168, in _run\r\n    command_args += _get_entry_point_command(project, entry_point, parameters, storage_dir)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/__init__.py\", line 490, in _get_entry_point_command\r\n    project.get_entry_point(entry_point).compute_command(parameters, storage_dir_for_run))\r\nFound existing run for entrypoint=load_raw_data and parameters={}\r\nLaunching new run for entrypoint=etl_data and parameters={'ratings_csv': 's3://mlflow/0/a4732be7b4db43949ecae708225ba340/artifacts/ratings-csv-dir/ratings.csv', 'max_row_limit': 100000}\r\n=== Downloading S3 object s3://mlflow/0/a4732be7b4db43949ecae708225ba340/artifacts/ratings-csv-dir/ratings.csv to local path /tmp/tmpsfa2xukx/ratings.csv ===\r\n\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/_project_spec.py\", line 164, in compute_command\r\n    params, extra_params = self.compute_parameters(user_parameters, storage_dir)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/_project_spec.py\", line 157, in compute_parameters\r\n    final_params[key] = param_obj.compute_value(value, storage_dir)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/_project_spec.py\", line 207, in compute_value\r\n    return self._compute_path_value(param_value, storage_dir)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/projects/_project_spec.py\", line 202, in _compute_path_value\r\n    data.download_uri(uri=user_param_value, output_path=dest_path)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/data.py\", line 72, in download_uri\r\n    _fetch_s3(uri, output_path)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/mlflow/data.py\", line 31, in _fetch_s3\r\n    boto3.client('s3').download_file(bucket, s3_path, local_path)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/boto3/s3/inject.py\", line 172, in download_file\r\n    extra_args=ExtraArgs, callback=Callback)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/boto3/s3/transfer.py\", line 307, in download_file\r\n    future.result()\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/s3transfer/futures.py\", line 106, in result\r\n    return self._coordinator.result()\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/s3transfer/futures.py\", line 265, in result\r\n    raise self._exception\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/s3transfer/tasks.py\", line 255, in _main\r\n    self._submit(transfer_future=transfer_future, **kwargs)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/s3transfer/download.py\", line 343, in _submit\r\n    **transfer_future.meta.call_args.extra_args\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/botocore/client.py\", line 316, in _api_call\r\n    return self._make_api_call(operation_name, kwargs)\r\n  File \"/opt/conda/envs/mlflow-9f5167292d547c49da28744ec745f90b2b35e40e/lib/python3.6/site-packages/botocore/client.py\", line 626, in _make_api_call\r\n    raise error_class(parsed_response, operation_name)\r\nbotocore.exceptions.ClientError: An error occurred (403) when calling the HeadObject operation: Forbidden\r\n2020/03/24 15:19:56 ERROR mlflow.cli: === Run (ID '119dd241293c430baaa989753c6741c2') failed ===","closed_by":{"login":"juntai-zheng","id":39497939,"node_id":"MDQ6VXNlcjM5NDk3OTM5","avatar_url":"https://avatars.githubusercontent.com/u/39497939?v=4","gravatar_id":"","url":"https://api.github.com/users/juntai-zheng","html_url":"https://github.com/juntai-zheng","followers_url":"https://api.github.com/users/juntai-zheng/followers","following_url":"https://api.github.com/users/juntai-zheng/following{/other_user}","gists_url":"https://api.github.com/users/juntai-zheng/gists{/gist_id}","starred_url":"https://api.github.com/users/juntai-zheng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juntai-zheng/subscriptions","organizations_url":"https://api.github.com/users/juntai-zheng/orgs","repos_url":"https://api.github.com/users/juntai-zheng/repos","events_url":"https://api.github.com/users/juntai-zheng/events{/privacy}","received_events_url":"https://api.github.com/users/juntai-zheng/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2630/timeline","performed_via_github_app":null,"state_reason":"completed"}