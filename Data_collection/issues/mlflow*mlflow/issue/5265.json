{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5265","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5265/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5265/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5265/events","html_url":"https://github.com/mlflow/mlflow/issues/5265","id":1101756357,"node_id":"I_kwDOCB5Jx85Bq3fF","number":5265,"title":"[BUG]Mlflow fails to create conda environments which is caused by pip dependency failure","user":{"login":"Tob-iee","id":49782212,"node_id":"MDQ6VXNlcjQ5NzgyMjEy","avatar_url":"https://avatars.githubusercontent.com/u/49782212?v=4","gravatar_id":"","url":"https://api.github.com/users/Tob-iee","html_url":"https://github.com/Tob-iee","followers_url":"https://api.github.com/users/Tob-iee/followers","following_url":"https://api.github.com/users/Tob-iee/following{/other_user}","gists_url":"https://api.github.com/users/Tob-iee/gists{/gist_id}","starred_url":"https://api.github.com/users/Tob-iee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tob-iee/subscriptions","organizations_url":"https://api.github.com/users/Tob-iee/orgs","repos_url":"https://api.github.com/users/Tob-iee/repos","events_url":"https://api.github.com/users/Tob-iee/events{/privacy}","received_events_url":"https://api.github.com/users/Tob-iee/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-01-13T13:44:48Z","updated_at":"2022-01-17T19:58:24Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 18.04)**: Linux(Ubuntu)\r\n- **MLflow installed from (source or binary)**:pip\r\n- **MLflow version (run ``mlflow --version``)**:1.22.0\r\n- **Python version**:3.8 and 3.9\r\n- **Exact command to reproduce**: ~/Documents/git_cloned/Github/Machine-Learning-Engineering-with-MLflow/Chapter01/stockpred > mlflow models serve -m runs:/c3fe1649dc284a9d82fbdb037666fc03/model_random_forest\r\n\r\n### Describe the problem\r\nAnytime I try to serve the model locally with the command above which creates a new conda environment and serves the model within that particular environment the environment build fails because the pip a/some dependencies fails to install. and I can't tell exactly why this dependencies fail \r\n\r\n### Code to reproduce issue\r\n`conda.yaml`\r\n\r\n```\r\nchannels:\r\n- conda-forge\r\ndependencies:\r\n- python=3.9.7\r\n- pip\r\n- pip:\r\n  - mlflow==1.22.0\r\n  - cloudpickle==2.0.0\r\n  - scikit-learn==1.0.2\r\nname: mlflow-env\r\n```\r\n`requirements.txt`\r\n```\r\nmlflow==1.22.0\r\ncloudpickle==2.0.0\r\nscikit-learn==1.0.2\r\n```\r\n### Other info / logs\r\n ```\r\n2022/01/13 11:52:01 INFO mlflow.models.cli: Selected backend for flavor 'python_function'\r\n2022/01/13 11:52:03 INFO mlflow.utils.conda: === Creating conda environment mlflow-04d87ea036b44c4189dc1f3a9f0d282b85dfcf87 ===\r\nCollecting package metadata (repodata.json): done\r\nSolving environment: done\r\nPreparing transaction: done\r\nVerifying transaction: done\r\nExecuting transaction: done\r\nInstalling pip dependencies: failed\r\n\r\n# >>>>>>>>>>>>>>>>>>>>>> ERROR REPORT <<<<<<<<<<<<<<<<<<<<<<\r\n\r\n    Traceback (most recent call last):\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda/exceptions.py\", line 1080, in __call__\r\n        return func(*args, **kwargs)\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda_env/cli/main.py\", line 80, in do_call\r\n        exit_code = getattr(module, func_name)(args, parser)\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda_env/cli/main_create.py\", line 141, in execute\r\n        result[installer_type] = installer.install(prefix, pkg_specs, args, env)\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda_env/installers/pip.py\", line 70, in install\r\n        return _pip_install_via_requirements(*args, **kwargs)\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda_env/installers/pip.py\", line 44, in _pip_install_via_requirements\r\n        requirements = Utf8NamedTemporaryFile(mode='w',\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/site-packages/conda/auxlib/compat.py\", line 88, in Utf8NamedTemporaryFile\r\n        return NamedTemporaryFile(\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/tempfile.py\", line 541, in NamedTemporaryFile\r\n        (fd, name) = _mkstemp_inner(dir, prefix, suffix, flags, output_type)\r\n      File \"/home/nwoke/anaconda3/lib/python3.9/tempfile.py\", line 251, in _mkstemp_inner\r\n        fd = _os.open(file, flags, 0o600)\r\n    PermissionError: [Errno 13] Permission denied: '/home/nwoke/Documents/git_cloned/Github/Machine-Learning-Engineering-with-MLflow/Chapter01/stockpred/mlruns/0/c3fe1649dc284a9d82fbdb037666fc03/artifacts/model_random_forest/condaenv.89qb6n18.requirements.txt'\r\n\r\n`$ /home/nwoke/anaconda3/bin/conda-env create -n mlflow-04d87ea036b44c4189dc1f3a9f0d282b85dfcf87 --file /home/nwoke/Documents/git_cloned/Github/Machine-Learning-Engineering-with-MLflow/Chapter01/stockpred/mlruns/0/c3fe1649dc284a9d82fbdb037666fc03/artifacts/model_random_forest/conda.yaml`\r\n\r\n  environment variables:\r\n                 CIO_TEST=<not set>\r\n  CONDA_AUTO_UPDATE_CONDA=false\r\n                CONDA_EXE=/home/nwoke/anaconda3/bin/conda\r\n         CONDA_PYTHON_EXE=/home/nwoke/anaconda3/bin/python\r\n               CONDA_ROOT=/home/nwoke/anaconda3\r\n              CONDA_SHLVL=0\r\n           CURL_CA_BUNDLE=<not set>\r\n            DEFAULTS_PATH=/usr/share/gconf/ubuntu.default.path\r\n       LIBVA_DRIVERS_PATH=/opt/intel/mediasdk/lib64\r\n           MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\r\n                     PATH=/home/nwoke/anaconda3/condabin:/home/nwoke/.local/bin:/usr/local/sbin:\r\n                          /usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/gam\r\n                          es:/snap/bin:/home/nwoke/.dotnet/tools\r\n       REQUESTS_CA_BUNDLE=<not set>\r\n            SSL_CERT_FILE=<not set>\r\n               WINDOWPATH=2\r\n\r\n     active environment : None\r\n            shell level : 0\r\n       user config file : /home/nwoke/.condarc\r\n populated config files : /home/nwoke/.condarc\r\n          conda version : 4.11.0\r\n    conda-build version : 3.21.5\r\n         python version : 3.9.7.final.0\r\n       virtual packages : __linux=5.4.0=0\r\n                          __glibc=2.27=0\r\n                          __unix=0=0\r\n                          __archspec=1=x86_64\r\n       base environment : /home/nwoke/anaconda3  (writable)\r\n      conda av data dir : /home/nwoke/anaconda3/etc/conda\r\n  conda av metadata url : None\r\n           channel URLs : https://conda.anaconda.org/conda-forge/linux-64\r\n                          https://conda.anaconda.org/conda-forge/noarch\r\n                          https://repo.anaconda.com/pkgs/main/linux-64\r\n                          https://repo.anaconda.com/pkgs/main/noarch\r\n                          https://repo.anaconda.com/pkgs/r/linux-64\r\n                          https://repo.anaconda.com/pkgs/r/noarch\r\n          package cache : /home/nwoke/anaconda3/pkgs\r\n                          /home/nwoke/.conda/pkgs\r\n       envs directories : /home/nwoke/anaconda3/envs\r\n                          /home/nwoke/opt/anaconda3/envs\r\n                          /home/nwoke/.conda/envs\r\n               platform : linux-64\r\n             user-agent : conda/4.11.0 requests/2.26.0 CPython/3.9.7 Linux/5.4.0-94-generic ubuntu/18.04.6 glibc/2.27\r\n                UID:GID : 1000:1000\r\n             netrc file : None\r\n           offline mode : False\r\n\r\n\r\nAn unexpected error has occurred. Conda has prepared the above report.\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/nwoke/.local/bin/mlflow\", line 8, in <module>\r\n    sys.exit(cli())\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 1128, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 1053, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 1395, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/click/core.py\", line 754, in invoke\r\n    return __callback(*args, **kwargs)\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/mlflow/models/cli.py\", line 57, in serve\r\n    return _get_flavor_backend(\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/mlflow/pyfunc/backend.py\", line 78, in serve\r\n    return _execute_in_conda_env(\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/mlflow/pyfunc/backend.py\", line 144, in _execute_in_conda_env\r\n    conda_env_name = get_or_create_conda_env(conda_env_path, env_id=env_id)\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/mlflow/utils/conda.py\", line 135, in get_or_create_conda_env\r\n    process.exec_cmd(\r\n  File \"/home/nwoke/.local/lib/python3.8/site-packages/mlflow/utils/process.py\", line 40, in exec_cmd\r\n    raise ShellCommandException(\"Non-zero exitcode: %s\" % (exit_code))\r\nmlflow.utils.process.ShellCommandException: Non-zero exitcode: 1\r\n```\r\n\r\n\r\n","closed_by":{"login":"Tob-iee","id":49782212,"node_id":"MDQ6VXNlcjQ5NzgyMjEy","avatar_url":"https://avatars.githubusercontent.com/u/49782212?v=4","gravatar_id":"","url":"https://api.github.com/users/Tob-iee","html_url":"https://github.com/Tob-iee","followers_url":"https://api.github.com/users/Tob-iee/followers","following_url":"https://api.github.com/users/Tob-iee/following{/other_user}","gists_url":"https://api.github.com/users/Tob-iee/gists{/gist_id}","starred_url":"https://api.github.com/users/Tob-iee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tob-iee/subscriptions","organizations_url":"https://api.github.com/users/Tob-iee/orgs","repos_url":"https://api.github.com/users/Tob-iee/repos","events_url":"https://api.github.com/users/Tob-iee/events{/privacy}","received_events_url":"https://api.github.com/users/Tob-iee/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5265/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5265/timeline","performed_via_github_app":null,"state_reason":null}