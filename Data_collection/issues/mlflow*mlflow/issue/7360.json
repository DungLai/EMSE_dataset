{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7360","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7360/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7360/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7360/events","html_url":"https://github.com/mlflow/mlflow/issues/7360","id":1454030523,"node_id":"I_kwDOCB5Jx85Wqr67","number":7360,"title":"[BUG] Downloading an artifact from a remote MLflow results in \"Connection broken: IncompleteRead\"","user":{"login":"dfdx","id":428171,"node_id":"MDQ6VXNlcjQyODE3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/428171?v=4","gravatar_id":"","url":"https://api.github.com/users/dfdx","html_url":"https://github.com/dfdx","followers_url":"https://api.github.com/users/dfdx/followers","following_url":"https://api.github.com/users/dfdx/following{/other_user}","gists_url":"https://api.github.com/users/dfdx/gists{/gist_id}","starred_url":"https://api.github.com/users/dfdx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfdx/subscriptions","organizations_url":"https://api.github.com/users/dfdx/orgs","repos_url":"https://api.github.com/users/dfdx/repos","events_url":"https://api.github.com/users/dfdx/events{/privacy}","received_events_url":"https://api.github.com/users/dfdx/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-11-17T21:39:52Z","updated_at":"2022-11-17T22:49:03Z","closed_at":"2022-11-17T22:49:03Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\n- Client: 2.0.1\r\n- Tracking server: 1.28.0\r\n\n\n### System information\n\nServer: \r\n* Docker image based on Ubuntu 18.04, running in Kubernetes\r\n* Python 3.9.13\r\n\r\nClient: \r\n* Ubuntu 22.04\r\n* Python 3.10.6\r\n\n\n### Describe the problem\n\nI have an MLflow Tracking Server running in a remote Kubernetes cluster, and a client running from my laptop at home. Whenever I try to download a model either using `mlflow.pytorch.load_models` or directly `mlflow.artifacts.download_artifacts()`, the request fails with the \"Connection broken: IncompleteRead\" error (see the full stacktrace below). \r\n\r\nSome important facts:\r\n* The server is configured with artifacts HTTP proxy\r\n* The error doesn't appear when testing the code from inside the cluster, so I suppose it's related to the network speed or stability\r\n* The time from the request start to the failure varies between 30 and 70 seconds so I suppose it's not a timeout configuration issue\r\n* Number of bytes read and left changes every time, so it's also not deterministic\r\n\r\nFrom the code of `download_artifacts()` I understand that mlflow downloads artifacts in separate threads, some of which fail, but their logs are not printed. Instead, the main thread checks the size of downloaded files and detects inconsistency. Alternatively, the main thread may try to check the artifacts before child threads are finished.\r\n\r\n\r\n\n\n### Tracking information\n\n```\r\nSystem information: Linux #58-Ubuntu SMP Thu Oct 13 08:03:55 UTC 2022\r\nPython version: 3.10.6\r\nMLflow version: 2.0.1\r\nMLflow module location: /home/username/venv/common/lib/python3.10/site-packages/mlflow/__init__.py\r\nTracking URI: http://<ip>:5000\r\nRegistry URI: http://<ip>:5000\r\nMLflow environment variables: {}\r\nMLflow dependencies: {\r\n    \"pyyaml\": \"6.0\",\r\n    \"scipy\": \"1.9.3\",\r\n    \"databricks-cli\": \"0.17.3\",\r\n    \"sqlparse\": \"0.4.3\",\r\n    \"pandas\": \"1.5.1\",\r\n    \"gitpython\": \"3.1.29\",\r\n    \"scikit-learn\": \"1.1.3\",\r\n    \"protobuf\": \"3.20.1\",\r\n    \"matplotlib\": \"3.6.2\",\r\n    \"gunicorn\": \"20.1.0\",\r\n    \"pyarrow\": \"10.0.0\",\r\n    \"numpy\": \"1.23.3\",\r\n    \"click\": \"8.1.3\",\r\n    \"cloudpickle\": \"2.2.0\",\r\n    \"requests\": \"2.28.1\",\r\n    \"shap\": \"0.41.0\",\r\n    \"docker\": \"6.0.1\",\r\n    \"importlib-metadata\": \"5.0.0\",\r\n    \"Flask\": \"2.2.2\",\r\n    \"pytz\": \"2022.6\",\r\n    \"sqlalchemy\": \"1.4.44\",\r\n    \"alembic\": \"1.8.1\",\r\n    \"querystring-parser\": \"1.2.4\",\r\n    \"markdown\": \"3.4.1\",\r\n    \"packaging\": \"21.3\",\r\n    \"Jinja2\": \"3.1.2\",\r\n    \"entrypoints\": \"0.4\"\r\n}\r\n```\n\n### Code to reproduce issue\n\nAssuming we have a large model saved as an artifact using `mlflow.pytorch.log_model()`:\r\n\r\n```python\r\nimport mlflow\r\n\r\nip = ...\r\nrun_id = ...\r\nmlflow.set_tracking_uri(f'http://{ip}:5000')\r\n\r\nmlflow.artifacts.download_artifacts(run_id=run_id, artifact_path=\"model\")\r\n```\n\n### Stack trace\n\n```python\r\n---------------------------------------------------------------------------\r\nMlflowException                           Traceback (most recent call last)\r\nCell In [4], line 1\r\n----> 1 mlflow.artifacts.download_artifacts(run_id='24b15bcbea6c410cac462e8bc18d6bfb', artifact_path=\"model\")\r\n\r\nFile ~/venv/common/lib/python3.10/site-packages/mlflow/artifacts/__init__.py:63, in download_artifacts(artifact_uri, run_id, artifact_path, dst_path, tracking_uri)\r\n     61 artifact_uri = store.get_run(run_id).info.artifact_uri\r\n     62 artifact_repo = get_artifact_repository(artifact_uri)\r\n---> 63 artifact_location = artifact_repo.download_artifacts(artifact_path, dst_path=dst_path)\r\n     64 return artifact_location\r\n\r\nFile ~/venv/common/lib/python3.10/site-packages/mlflow/store/artifact/artifact_repo.py:263, in ArtifactRepository.download_artifacts(self, artifact_path, dst_path)\r\n    260         failed_downloads[inflight_download.src_artifact_path] = repr(e)\r\n    262 if len(failed_downloads) > 0:\r\n--> 263     raise MlflowException(\r\n    264         message=(\r\n    265             \"The following failures occurred while downloading one or more\"\r\n    266             \" artifacts from {artifact_root}: {failures}\".format(\r\n    267                 artifact_root=self.artifact_uri,\r\n    268                 failures=failed_downloads,\r\n    269             )\r\n    270         )\r\n    271     )\r\n    272 return dst_local_path\r\n\r\nMlflowException: The following failures occurred while downloading one or more artifacts from http://<ip>:5000/api/2.0/mlflow-artifacts/artifacts/6/24b15bcbea6c410cac462e8bc18d6bfb/artifacts: {'model/data/model.pth': \"ChunkedEncodingError(ProtocolError('Connection broken: IncompleteRead(6 bytes read, 309 more expected)', IncompleteRead(6 bytes read, 309 more expected)))\"}\r\n```\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [X] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7360/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7360/timeline","performed_via_github_app":null,"state_reason":"completed"}