{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4886","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4886/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4886/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4886/events","html_url":"https://github.com/mlflow/mlflow/issues/4886","id":1023432828,"node_id":"I_kwDOCB5Jx849AFh8","number":4886,"title":"[BUG] mlflow fails to create conda environments with hash-pinned pip packages","user":{"login":"mmaitre314","id":8584604,"node_id":"MDQ6VXNlcjg1ODQ2MDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8584604?v=4","gravatar_id":"","url":"https://api.github.com/users/mmaitre314","html_url":"https://github.com/mmaitre314","followers_url":"https://api.github.com/users/mmaitre314/followers","following_url":"https://api.github.com/users/mmaitre314/following{/other_user}","gists_url":"https://api.github.com/users/mmaitre314/gists{/gist_id}","starred_url":"https://api.github.com/users/mmaitre314/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mmaitre314/subscriptions","organizations_url":"https://api.github.com/users/mmaitre314/orgs","repos_url":"https://api.github.com/users/mmaitre314/repos","events_url":"https://api.github.com/users/mmaitre314/events{/privacy}","received_events_url":"https://api.github.com/users/mmaitre314/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-10-12T06:50:19Z","updated_at":"2021-11-23T01:01:45Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Windows 10\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**:1.20.2\r\n- **Python version**:3.8\r\n- **npm version, if running the dev UI**:N/A\r\n- **Exact command to reproduce**:mlflow models serve -m runs:/5f8aee52fcb442388368af4da658b398/model\r\n\r\n### Describe the problem\r\n\r\nWe run `pip install` in [hash-checking mode](https://pip.pypa.io/en/stable/cli/pip_install/#hash-checking-mode) to prevent package tampering. MLFlow does not support this by default so I provided the `requirements.txt` file explicitly:\r\n```\r\n    mlflow.sklearn.log_model(\r\n        model,\r\n        artifact_path = \"model\",\r\n        signature = mlflow.models.infer_signature(X_train[:10], y_train[:10]),\r\n        input_example = X_train[:10],\r\n        pip_requirements = \"requirements.txt\")\r\n```\r\nInstead of using the `requirements.txt` file as-is, MLFlow added an extra `mlflow` entry in the list of PIP requirements. This `mlflow` entry has no version or hash, which breaks `pip install` when trying to serve the model. The fix is likely not to add that extra entry when the `mlflow` package is already present in the requirement list.\r\n\r\nconda.yaml logged in model artifacts:\r\n```\r\nchannels:\r\n- conda-forge\r\ndependencies:\r\n- python=3.8.8\r\n- pip\r\n- pip:\r\n  - mlflow\r\n  - adal==1.2.7 --hash=sha256:2a7451ed7441ddbc57703042204a3e30ef747478eea022c70f789fc7f084bc3d\r\n    --hash=sha256:d74f45b81317454d96e982fd1c50e6fb5c99ac2223728aea8764433a39f566f1\r\n  - alembic==1.4.1 --hash=sha256:791a5686953c4b366d3228c5377196db2f534475bb38d26f70eb69668efd9028\r\n  - azure-common==1.1.27 --hash=sha256:426673962740dbe9aab052a4b52df39c07767decd3f25fdc87c9d4c566a04934\r\n    --hash=sha256:9f3f5d991023acbd93050cf53c4e863c6973ded7e236c69e99c8ff5c7bad41ef\r\n<snip>\r\n  - werkzeug==2.0.2 --hash=sha256:63d3dc1cf60e7b7e35e97fa9861f7397283b75d765afcaefd993d6046899de8f\r\n    --hash=sha256:aa2bb6fc8dee8d6c504c0ac1e7f5f7dc5810a9903e793b6f715a9f015bdadb9a\r\n  - zipp==3.6.0 --hash=sha256:71c644c5369f4a6e07636f0aa966270449561fcea2e3d6747b8d23efaa9d7832\r\n    --hash=sha256:9fe5ea21568a0a70e50f273397638d39b03353731e6cbbb3fd8502a33fec40bc\r\nname: mlflow-env\r\n```\r\n\r\nCommand error:\r\n```\r\n(.venv) (base) C:\\Source\\local_training_mlflow_project>mlflow models serve -m runs:/5f8aee52fcb442388368af4da658b398/model\r\n2021/10/11 23:28:11 INFO mlflow.models.cli: Selected backend for flavor 'python_function'\r\n2021/10/11 23:28:15 INFO mlflow.utils.conda: === Creating conda environment mlflow-895112428d2cf8da9ab88b552b55b1ea2f22dc1c ===\r\nCollecting package metadata (repodata.json): done\r\nSolving environment: done\r\n\r\n\r\n==> WARNING: A newer version of conda exists. <==\r\n  current version: 4.10.1\r\n  latest version: 4.10.3\r\n\r\nPlease update conda by running\r\n\r\n    $ conda update -n base -c defaults conda\r\n\r\n\r\n\r\nDownloading and Extracting Packages\r\nopenssl-1.1.1l       | 5.7 MB    | ############################################################################################################################### | 100%\r\npython-3.8.8         | 19.2 MB   | ############################################################################################################################### | 100%\r\nPreparing transaction: done\r\nVerifying transaction: done\r\nExecuting transaction: done\r\nInstalling pip dependencies: | Ran pip subprocess with arguments:\r\n['C:\\\\Users\\\\mmaitre\\\\Anaconda3\\\\envs\\\\mlflow-895112428d2cf8da9ab88b552b55b1ea2f22dc1c\\\\python.exe', '-m', 'pip', 'install', '-U', '-r', 'C:\\\\Source\\\\local_training_mlflow_project\\\\mlruns\\\\0\\\\5f8aee52fcb442388368af4da658b398\\\\artifacts\\\\model\\\\condaenv.4kpb_18z.requirements.txt']\r\nPip subprocess output:\r\nCollecting mlflow\r\n\r\nPip subprocess error:\r\nERROR: In --require-hashes mode, all requirements must have their versions pinned with ==. These do not:\r\n    mlflow from https://files.pythonhosted.org/packages/ac/60/cc5ad7b761f31854d3158dc420e62d5adaa283e5d65efebf029ae2c400c2/mlflow-1.20.2-py3-none-any.whl#sha256=963c22532e82a93450674ab97d62f9e528ed0906b580fadb7c003e696197557c (from -r C:\\Source\\local_training_mlflow_project\\mlruns\\0\\5f8aee52fcb442388368af4da658b398\\artifacts\\model\\condaenv.4kpb_18z.requirements.txt (line 1))\r\n\r\nfailed\r\n\r\nCondaEnvException: Pip failed\r\n\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\mmaitre\\Anaconda3\\lib\\runpy.py\", line 194, in _run_module_as_main\r\n    return _run_code(code, main_globals, None,\r\n  File \"C:\\Users\\mmaitre\\Anaconda3\\lib\\runpy.py\", line 87, in _run_code\r\n    exec(code, run_globals)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\Scripts\\mlflow.exe\\__main__.py\", line 7, in <module>\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 1128, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 1053, in main\r\n    rv = self.invoke(ctx)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 1659, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 1395, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\click\\core.py\", line 754, in invoke\r\n    return __callback(*args, **kwargs)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\mlflow\\models\\cli.py\", line 54, in serve\r\n    return _get_flavor_backend(\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\mlflow\\pyfunc\\backend.py\", line 91, in serve\r\n    return _execute_in_conda_env(\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\mlflow\\pyfunc\\backend.py\", line 149, in _execute_in_conda_env\r\n    conda_env_name = get_or_create_conda_env(conda_env_path, env_id=env_id)\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\mlflow\\utils\\conda.py\", line 93, in get_or_create_conda_env\r\n    process.exec_cmd(\r\n  File \"C:\\Source\\local_training_mlflow_project\\.venv\\lib\\site-packages\\mlflow\\utils\\process.py\", line 40, in exec_cmd\r\n    raise ShellCommandException(\"Non-zero exitcode: %s\" % (exit_code))\r\nmlflow.utils.process.ShellCommandException: Non-zero exitcode: 1\r\n```\r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\n- train.py:\r\n```\r\nimport mlflow\r\nimport sklearn\r\n\r\nmlflow.sklearn.autolog(log_models=False) # Use explicit model logging to control pip requirements\r\n\r\n# Load data\r\nX, y = sklearn.datasets.load_diabetes(return_X_y = True)\r\nX_train, X_test, y_train, y_test = sklearn.model_selection.train_test_split(X, y, test_size=0.2, random_state=0)\r\n\r\n# Train model\r\nwith mlflow.start_run() as run:\r\n    print(f\"MLFlow run ID: {run.info.run_id}\")\r\n\r\n    model = sklearn.linear_model.Ridge(alpha=0.03)\r\n    model.fit(X_train, y_train)\r\n\r\n    mlflow.sklearn.log_model(\r\n        model,\r\n        artifact_path = \"model\",\r\n        signature = mlflow.models.infer_signature(X_train[:10], y_train[:10]),\r\n        input_example = X_train[:10],\r\n        pip_requirements = \"requirements.txt\")\r\n```\r\n\r\n- requirements.in:\r\n```\r\npandas==1.3.2\r\nscikit-learn==0.24.2\r\nmlflow==1.20.2\r\nazureml-mlflow==1.34.0\r\n```\r\n\r\nRequirement pinning:\r\n```\r\npip install pip-tools\r\npip-compile --generate-hashes --output-file=requirements.txt requirements.in\r\n```\r\n\r\n### Other info / logs\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4886/timeline","performed_via_github_app":null,"state_reason":null}