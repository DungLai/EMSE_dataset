{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3530","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3530/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3530/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3530/events","html_url":"https://github.com/mlflow/mlflow/issues/3530","id":721652455,"node_id":"MDU6SXNzdWU3MjE2NTI0NTU=","number":3530,"title":"[BUG] mlflow server does not work behind ingress proxy (kubernetes, traefik)","user":{"login":"dingobar","id":41419288,"node_id":"MDQ6VXNlcjQxNDE5Mjg4","avatar_url":"https://avatars.githubusercontent.com/u/41419288?v=4","gravatar_id":"","url":"https://api.github.com/users/dingobar","html_url":"https://github.com/dingobar","followers_url":"https://api.github.com/users/dingobar/followers","following_url":"https://api.github.com/users/dingobar/following{/other_user}","gists_url":"https://api.github.com/users/dingobar/gists{/gist_id}","starred_url":"https://api.github.com/users/dingobar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dingobar/subscriptions","organizations_url":"https://api.github.com/users/dingobar/orgs","repos_url":"https://api.github.com/users/dingobar/repos","events_url":"https://api.github.com/users/dingobar/events{/privacy}","received_events_url":"https://api.github.com/users/dingobar/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-10-14T17:36:22Z","updated_at":"2021-07-14T11:10:20Z","closed_at":"2021-07-14T11:10:20Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Debian/Ubuntu/CentOS\r\n- **MLflow installed from (source or binary)**: Binary\r\n- **MLflow version (run ``mlflow --version``)**: latest\r\n- **Python version**: 3.8\r\n- **npm version, if running the dev UI**: na\r\n- **Exact command to reproduce**: mlflow server [args]\r\n\r\n### Describe the problem\r\nWhen running in a container behind a proxy, for example in a kubernetes cluster with a traefik or nginx ingress in front, flask (actually its dependency werkzeug) does not handle forwarded request headers correctly.\r\n\r\nThe issue is explained in detail in the [werkzeug docs](https://werkzeug.palletsprojects.com/en/0.15.x/middleware/proxy_fix/#module-werkzeug.middleware.proxy_fix).\r\n\r\n### Code to reproduce issue\r\nAn ingress resource in kubernetes can contain a host and a URL prefix like this:\r\n```yaml\r\n...\r\n    - host: mlflow.my.domain.here.com\r\n      http:\r\n        paths:\r\n        - backend:\r\n            serviceName: mlflow\r\n            servicePort: 80\r\n          path: /mlops/mlflow\r\n...\r\n```\r\nWhen deployed with an mlflow deployment and a service in front, I would expect to hit the server in the browser with `https://mlflow.my.domain.here.com/mlops/mlflow`. However, the werkzeug WSGI does not translate the forwarded headers in the request correctly and thus the request never reaches the app itself.\r\n\r\nIf anyone is interested, the dockerfile for the container looks like this:\r\n```Dockerfile\r\nFROM python:3.8.2-slim\r\n\r\nRUN pip install PyMySQL==0.9.3 && \\   \r\n    pip install psycopg2-binary==2.8.5 && \\\r\n    pip install mlflow[extras]==1.9.1\r\n\r\nENTRYPOINT [\"mlflow\", \"server\"]\r\n```\r\n\r\nAnd the server is run like this in the kubernetes deployment:\r\n```yaml\r\n...\r\n        containers:\r\n        - args:\r\n          - --port=80\r\n          - --host=0.0.0.0\r\n          - --backend-store-uri=postgresql://mlflow:my-password@my-postgres-database:5432/mlflow\r\n          - --default-artifact-root=s3://my-bucket-here\r\n          - --gunicorn-opts=--log-level debug\r\n          - --static-prefix=/mlops/mlflow\r\n...\r\n```\r\n\r\n### Other info / logs\r\nI've made a PR on this to illustrate how to solve it, but I will need some help writing proper tests for it and also running the test suite that already exists.\r\n\r\nWeb-servers is admittedly not my strongest craft so please excuse my simple minded explanation of the issue.\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [x] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"dingobar","id":41419288,"node_id":"MDQ6VXNlcjQxNDE5Mjg4","avatar_url":"https://avatars.githubusercontent.com/u/41419288?v=4","gravatar_id":"","url":"https://api.github.com/users/dingobar","html_url":"https://github.com/dingobar","followers_url":"https://api.github.com/users/dingobar/followers","following_url":"https://api.github.com/users/dingobar/following{/other_user}","gists_url":"https://api.github.com/users/dingobar/gists{/gist_id}","starred_url":"https://api.github.com/users/dingobar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dingobar/subscriptions","organizations_url":"https://api.github.com/users/dingobar/orgs","repos_url":"https://api.github.com/users/dingobar/repos","events_url":"https://api.github.com/users/dingobar/events{/privacy}","received_events_url":"https://api.github.com/users/dingobar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3530/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3530/timeline","performed_via_github_app":null,"state_reason":"completed"}