{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5400","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5400/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5400/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5400/events","html_url":"https://github.com/mlflow/mlflow/issues/5400","id":1145680257,"node_id":"I_kwDOCB5Jx85ESbGB","number":5400,"title":"[BUG] RuntimeError: Java gateway process exited before sending its port number when Deploying Pyspark model to Azure Container Instance","user":{"login":"tobys-playground","id":81354022,"node_id":"MDQ6VXNlcjgxMzU0MDIy","avatar_url":"https://avatars.githubusercontent.com/u/81354022?v=4","gravatar_id":"","url":"https://api.github.com/users/tobys-playground","html_url":"https://github.com/tobys-playground","followers_url":"https://api.github.com/users/tobys-playground/followers","following_url":"https://api.github.com/users/tobys-playground/following{/other_user}","gists_url":"https://api.github.com/users/tobys-playground/gists{/gist_id}","starred_url":"https://api.github.com/users/tobys-playground/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tobys-playground/subscriptions","organizations_url":"https://api.github.com/users/tobys-playground/orgs","repos_url":"https://api.github.com/users/tobys-playground/repos","events_url":"https://api.github.com/users/tobys-playground/events{/privacy}","received_events_url":"https://api.github.com/users/tobys-playground/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-21T11:33:25Z","updated_at":"2022-02-22T06:09:38Z","closed_at":"2022-02-22T06:09:37Z","author_association":"NONE","active_lock_reason":null,"body":"I am trying to deploy a PySpark model trained in Azure Databricks with MLflow to an ACI in Azure Machine Learning.\r\n\r\nI am following the steps in this link:\r\n\r\nhttps://docs.microsoft.com/en-us/azure/machine-learning/how-to-deploy-mlflow-models#example-notebooks\r\n\r\nbut I get this error:\r\n\r\n```\r\nSPARK_HOME not set. Skipping PySpark Initialization.\r\nInitializing logger\r\n2022-02-21 09:29:30,269 | root | INFO | Starting up app insights client\r\nlogging socket was found. logging is available.\r\nlogging socket was found. logging is available.\r\n2022-02-21 09:29:30,270 | root | INFO | Starting up request id generator\r\n2022-02-21 09:29:30,270 | root | INFO | Starting up app insight hooks\r\n2022-02-21 09:29:30,270 | root | INFO | Invoking user's init function\r\nJAVA_HOME is not set\r\n2022-02-21 09:29:31,267 | root | ERROR | User's init function failed\r\n2022-02-21 09:29:31,268 | root | ERROR | Encountered Exception Traceback (most recent call last):\r\n  File \"/var/azureml-server/aml_blueprint.py\", line 191, in register\r\n    main.init()\r\n  File \"/var/azureml-app/execution_script.py\", line 15, in init\r\n    model = load_model(model_path)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 667, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/mlflow/spark.py\", line 703, in _load_pyfunc\r\n    pyspark.sql.SparkSession.builder.config(\"spark.python.worker.reuse\", True)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/pyspark/sql/session.py\", line 228, in getOrCreate\r\n    sc = SparkContext.getOrCreate(sparkConf)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/pyspark/context.py\", line 392, in getOrCreate\r\n    SparkContext(conf=conf or SparkConf())\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/pyspark/context.py\", line 144, in __init__\r\n    SparkContext._ensure_initialized(self, gateway=gateway, conf=conf)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/pyspark/context.py\", line 339, in _ensure_initialized\r\n    SparkContext._gateway = gateway or launch_gateway(conf)\r\n  File \"/azureml-envs/azureml_5d25bdfadca034daea176336163db1e0/lib/python3.8/site-packages/pyspark/java_gateway.py\", line 108, in launch_gateway\r\n    raise RuntimeError(\"Java gateway process exited before sending its port number\")\r\nRuntimeError: Java gateway process exited before sending its port number\r\n```\r\nMy code looks like this:\r\n\r\n```\r\nfrom mlflow.deployments import get_deploy_client\r\n\r\n# set the tracking uri as the deployment client\r\nclient = get_deploy_client(mlflow.get_tracking_uri())\r\n\r\n# set the model path \r\nmodel_path = \"k_means_model\"\r\n\r\n# define the model path and the name is the service name\r\n# the model gets registered automatically and a name is autogenerated using the \"name\" parameter below \r\nclient.create_deployment(model_uri='runs:/{}/{}'.format(run_id, model_path), name = 'k-means-model-ml-flow')\r\n```\r\nWhile my model settings are:\r\n\r\n```\r\nartifact_path: k_means_model\r\ndatabricks_runtime: 10.3.x-cpu-ml-scala2.12\r\nflavors:\r\n  python_function:\r\n    data: sparkml\r\n    env: conda.yaml\r\n    loader_module: mlflow.spark\r\n    python_version: 3.8.10\r\n  spark:\r\n    model_data: sparkml\r\n    pyspark_version: 3.2.1\r\n```\r\nCan someone help please?","closed_by":{"login":"tobys-playground","id":81354022,"node_id":"MDQ6VXNlcjgxMzU0MDIy","avatar_url":"https://avatars.githubusercontent.com/u/81354022?v=4","gravatar_id":"","url":"https://api.github.com/users/tobys-playground","html_url":"https://github.com/tobys-playground","followers_url":"https://api.github.com/users/tobys-playground/followers","following_url":"https://api.github.com/users/tobys-playground/following{/other_user}","gists_url":"https://api.github.com/users/tobys-playground/gists{/gist_id}","starred_url":"https://api.github.com/users/tobys-playground/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tobys-playground/subscriptions","organizations_url":"https://api.github.com/users/tobys-playground/orgs","repos_url":"https://api.github.com/users/tobys-playground/repos","events_url":"https://api.github.com/users/tobys-playground/events{/privacy}","received_events_url":"https://api.github.com/users/tobys-playground/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5400/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5400/timeline","performed_via_github_app":null,"state_reason":"completed"}