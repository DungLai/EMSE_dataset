{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5133","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5133/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5133/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5133/events","html_url":"https://github.com/mlflow/mlflow/issues/5133","id":1068793065,"node_id":"I_kwDOCB5Jx84_tHzp","number":5133,"title":"[BUG] ModuleNotFoundError: No module named 'autosklearn' -- but it's in the artifact's dependencies","user":{"login":"totalhack","id":43683140,"node_id":"MDQ6VXNlcjQzNjgzMTQw","avatar_url":"https://avatars.githubusercontent.com/u/43683140?v=4","gravatar_id":"","url":"https://api.github.com/users/totalhack","html_url":"https://github.com/totalhack","followers_url":"https://api.github.com/users/totalhack/followers","following_url":"https://api.github.com/users/totalhack/following{/other_user}","gists_url":"https://api.github.com/users/totalhack/gists{/gist_id}","starred_url":"https://api.github.com/users/totalhack/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/totalhack/subscriptions","organizations_url":"https://api.github.com/users/totalhack/orgs","repos_url":"https://api.github.com/users/totalhack/repos","events_url":"https://api.github.com/users/totalhack/events{/privacy}","received_events_url":"https://api.github.com/users/totalhack/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-12-01T19:30:28Z","updated_at":"2022-05-03T00:45:12Z","closed_at":"2022-05-03T00:45:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\n\r\nN/A -- looking for a clarification on how this is supposed to work, or perhaps a doc update. Apologies if this is misclassified, the other options didn't seem appropriate either.\r\n\r\n### System information\r\n\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:  Linux / Debian-based\r\n- **MLflow installed from (source or binary)**: Binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.21.0\r\n- **Python version**: 3.8.7\r\n\r\n### Describe the problem\r\n\r\nI trained a model with auto-sklearn and used log_model. It successfully saves the artifact to S3, and the S3 conda and pip requirements files both show the proper dependencies. Conda env for example:\r\n\r\n```\r\nchannels:\r\n- conda-forge\r\ndependencies:\r\n- python=3.8.7\r\n- pip\r\n- pip:\r\n  - mlflow\r\n  - auto-sklearn==0.14.1\r\n  - cloudpickle==2.0.0\r\n  - scikit-learn==0.24.2\r\nname: mlflow-env\r\n```\r\n\r\nWhen I later try to call `load_model` I expected it would \"just work\", but I instead get an error since autosklearn doesn't exist in the python environment:\r\n\r\n```\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/sklearn/__init__.py\", line 549, in load_model\r\n    return _load_model_from_local_file(\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/sklearn/__init__.py\", line 417, in _load_model_from_local_file\r\n    return cloudpickle.load(f)\r\nModuleNotFoundError: No module named 'autosklearn'\r\n```\r\n\r\nSo it appears my assumption that the requirements would automatically be bundled with the model are wrong. But I also don't see any options on `log_model` or `load_model` that would either package the requirements with the model artifact or attempt an install before the load. Perhaps my issue here is that my workflow is off target, but after a lot of searching the docs / github / stackoverflow I'm not finding a clear answer on the proper workflow to handle a case like this. \r\n\r\nIs there an existing example that shows programmatically using the conda env or requirements.txt info from the artifact to create an environment prior to a `load_model` call? Or am I just expected to be handling inference environment creation separately? Of course the latter is doable, but I was hoping there would be some way to have the artifact be the source of truth for the environment...otherwise one needs to coordinate the training environment with the inference environment by other means. Again, doable, but I think I misunderstood that this was supposed to be a thing MLFlow somehow took care of for you.\r\n\r\nNote, I'm going to be using BentoML for model containerization and deployment. Roughly following [this](https://github.com/bentoml/gallery/blob/pre-v1.0/bentomlflow/mlflow-to-bentoml-example.ipynb) example. Not expecting anyone here to comment on the Bento side of things, just adding this as a data point as I was hoping to keep the model serving code independent of the training code as much as possible. The training environments are all containerized but have more requirements than I'd really need for inference, so just using that same image isn't ideal. \r\n\r\nThanks for your help.\r\n\r\n\r\nEDIT: I've come across `mlflow models prepare-env` which I may be able to utilize in a build step to create the env from the artifact definition. Will give that a shot.\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5133/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5133/timeline","performed_via_github_app":null,"state_reason":"completed"}