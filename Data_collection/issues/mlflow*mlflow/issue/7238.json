{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7238","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7238/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7238/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7238/events","html_url":"https://github.com/mlflow/mlflow/issues/7238","id":1433802085,"node_id":"I_kwDOCB5Jx85VdhVl","number":7238,"title":"[BUG] MLflow REST API incorrectly reports \"database down\" as BAD_REQUEST (HTTP 400) error","user":{"login":"barrywhart","id":1678585,"node_id":"MDQ6VXNlcjE2Nzg1ODU=","avatar_url":"https://avatars.githubusercontent.com/u/1678585?v=4","gravatar_id":"","url":"https://api.github.com/users/barrywhart","html_url":"https://github.com/barrywhart","followers_url":"https://api.github.com/users/barrywhart/followers","following_url":"https://api.github.com/users/barrywhart/following{/other_user}","gists_url":"https://api.github.com/users/barrywhart/gists{/gist_id}","starred_url":"https://api.github.com/users/barrywhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/barrywhart/subscriptions","organizations_url":"https://api.github.com/users/barrywhart/orgs","repos_url":"https://api.github.com/users/barrywhart/repos","events_url":"https://api.github.com/users/barrywhart/events{/privacy}","received_events_url":"https://api.github.com/users/barrywhart/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"},{"id":4300304016,"node_id":"LA_kwDOCB5Jx88AAAABAFFukA","url":"https://api.github.com/repos/mlflow/mlflow/labels/has-closing-pr","name":"has-closing-pr","color":"fef2c0","default":false,"description":"This issue has a closing PR"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-11-02T21:20:51Z","updated_at":"2022-12-02T22:57:20Z","closed_at":"2022-12-02T22:57:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nYes. I can contribute a fix for this bug independently.\n\n### MLflow version\n\n- Client: 1.30.0\r\n- Tracking server: 1.30.0\r\n\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Debian Slim\r\n- **Python version**: 3.7\r\n- **yarn version, if running the dev UI**:\r\n\n\n### Describe the problem\n\nI'm testing the behavior MLflow REST server when the database server (e.g. Postgres) goes down. I discovered that the server returns an HTTP 400 **client** error, which is not retried by the MLflow client. Hence, a job using MLflow fails immediately rather than retrying.\r\n\r\nThe incorrect code is [here](https://github.com/mlflow/mlflow/blob/v1.30.0/mlflow/store/db/utils.py#L105).\r\n\r\nI propose adding another `except` block above this one, resulting in:\r\n```\r\n        except sqlalchemy.exc.OperationalError as e:\r\n            session.rollback()\r\n            raise MlflowException(message=e, error_code= INTERNAL_ERROR)\r\n        except sqlalchemy.exc.SQLAlchemyError as e:\r\n            session.rollback()\r\n            raise MlflowException(message=e, error_code=BAD_REQUEST)\r\n```\r\n\r\n[PEP 249 – Python Database API Specification v2.0 | peps.python.org](https://peps.python.org/pep-0249/#operationalerror) [Core Exceptions — SQLAlchemy 1.4 Documentation] describes `OperationalError` as:\r\n> Exception raised for errors that are related to the database’s operation and not necessarily under the control of the programmer, e.g. an unexpected disconnect occurs, the data source name is not found, a transaction could not be processed, a memory allocation error occurred during processing, etc.\r\n\r\nThis exception type is primarily for errors that occur at runtime, relating to the operational environment of the application, rather than a bug in the application (or something the MLflow user / client did wrong).\r\n\r\n\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\n```\r\nimport mlflow\r\n\r\nexperiment_name = f\"foobar\"\r\nmlflow.set_experiment(experiment_name)\r\nwith mlflow.start_run():\r\n    pass\r\n```\n\n### Stack trace\n\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 455, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 528, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 711, in _update_run\r\n    run_id, request_message.status, request_message.end_time, request_message.run_name\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 650, in update_run_info\r\n    return run.info\r\n  File \"/usr/local/lib/python3.7/contextlib.py\", line 130, in __exit__\r\n    self.gen.throw(type, value, traceback)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/db/utils.py\", line 105, in make_managed_session\r\n    raise MlflowException(message=e, error_code=BAD_REQUEST)\r\nmlflow.exceptions.MlflowException: (psycopg2.OperationalError) could not connect to server: Connection refused\r\n        Is the server running on host \"127.0.0.1\" and accepting\r\n        TCP/IP connections on port 5432?\r\n```\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [X] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [X] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7238/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7238/timeline","performed_via_github_app":null,"state_reason":"completed"}