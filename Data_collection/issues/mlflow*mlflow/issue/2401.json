{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2401","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2401/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2401/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2401/events","html_url":"https://github.com/mlflow/mlflow/issues/2401","id":561614491,"node_id":"MDU6SXNzdWU1NjE2MTQ0OTE=","number":2401,"title":"[BUG] pyfunc.log_model fails for large .pkl files (PythonModel)","user":{"login":"rrma","id":18377705,"node_id":"MDQ6VXNlcjE4Mzc3NzA1","avatar_url":"https://avatars.githubusercontent.com/u/18377705?v=4","gravatar_id":"","url":"https://api.github.com/users/rrma","html_url":"https://github.com/rrma","followers_url":"https://api.github.com/users/rrma/followers","following_url":"https://api.github.com/users/rrma/following{/other_user}","gists_url":"https://api.github.com/users/rrma/gists{/gist_id}","starred_url":"https://api.github.com/users/rrma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rrma/subscriptions","organizations_url":"https://api.github.com/users/rrma/orgs","repos_url":"https://api.github.com/users/rrma/repos","events_url":"https://api.github.com/users/rrma/events{/privacy}","received_events_url":"https://api.github.com/users/rrma/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022866842,"node_id":"MDU6TGFiZWwyMDIyODY2ODQy","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/awaiting-more-evidence","name":"priority/awaiting-more-evidence","color":"534cb5","default":false,"description":"Lowest priority. Possibly useful, but not yet enough support to actually get it done."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-02-07T12:40:50Z","updated_at":"2020-08-26T20:01:42Z","closed_at":"2020-08-26T20:01:42Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- OS: tested on Linux & MaxOS \r\n- mlflow v1.6.0\r\n- python 3.7.6\r\n\r\n### Describe the problem\r\nI want to log a SARIMAX model to a S3 bucket (artifact store) with mlflow. This works as long as the model (.pkl) file is small, but as soon as it reaches a larger size (because endog contains more values), the model upload fails.\r\nIt looks like the splitting the model file into multiple parts, due to file size, is the problem.\r\n\r\nFYI - \r\nI found a similar problem in the issues of the moto package. There, it is stated that the issue could be solved in the TransferConfig of the boto3 client by setting use_treads=False (default value is True). => https://github.com/spulec/moto/issues/786\r\nMaybe this could also be solved by that...\r\n\r\n### Code to reproduce issue\r\nSet environment variables\r\n\r\n- MLFLOW_S3_ENDPOINT_URL\r\n- MLFLOW_TRACKING_URI\r\n\r\n```\r\nimport mlflow\r\nimport numpy as np\r\n\r\nfrom mlflow.pyfunc import PythonModel\r\nfrom statsmodels.tsa.statespace.sarimax import SARIMAX\r\n\r\nclass PythonModelWrapper(PythonModel):\r\n\r\n    def __init__(self, model):\r\n        self.model = model\r\n\r\n    def predict(self, context, model_input):\r\n        return self.model.predict(model_input)\r\n\r\n\r\ny_train = np.random.randint(0, 1000, 8000)\r\n\r\nmodel = SARIMAX(endog=y_train, order=(1, 1, 1), frequ='T').fit()\r\n\r\nwrapper = PythonModelWrapper(model)\r\nmlflow.pyfunc.log_model('model', python_model=wrapper)\r\n\r\n```\r\n### Other info / logs\r\n```\r\nTraceback (most recent call last):\r\n  File \".../lib/python3.7/site-packages/boto3/s3/transfer.py\", line 279, in upload_file\r\n    future.result()\r\n  File \".../lib/python3.7/site-packages/s3transfer/futures.py\", line 106, in result\r\n    return self._coordinator.result()\r\n  File \".../lib/python3.7/site-packages/s3transfer/futures.py\", line 265, in result\r\n    raise self._exception\r\n  File \".../lib/python3.7/site-packages/s3transfer/tasks.py\", line 126, in __call__\r\n    return self._execute_main(kwargs)\r\n  File \".../lib/python3.7/site-packages/s3transfer/tasks.py\", line 150, in _execute_main\r\n    return_value = self._main(**kwargs)\r\n  File \".../lib/python3.7/site-packages/s3transfer/tasks.py\", line 364, in _main\r\n    **extra_args)\r\n  File \".../lib/python3.7/site-packages/botocore/client.py\", line 276, in _api_call\r\n    return self._make_api_call(operation_name, kwargs)\r\n  File \".../lib/python3.7/site-packages/botocore/client.py\", line 586, in _make_api_call\r\n    raise error_class(parsed_response, operation_name)\r\nbotocore.exceptions.ClientError: An error occurred (InvalidPart) when calling the CompleteMultipartUpload operation: Unknown\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \".../code/log_sarimax.py\", line 22, in <module>\r\n    mlflow.pyfunc.log_model('model', python_model=wrapper)\r\n  File \".../lib/python3.7/site-packages/mlflow/pyfunc/__init__.py\", line 686, in log_model\r\n    registered_model_name=registered_model_name)\r\n  File \".../lib/python3.7/site-packages/mlflow/models/__init__.py\", line 83, in log\r\n    mlflow.tracking.fluent.log_artifacts(local_path, artifact_path)\r\n  File \".../lib/python3.7/site-packages/mlflow/tracking/fluent.py\", line 323, in log_artifacts\r\n    MlflowClient().log_artifacts(run_id, local_dir, artifact_path)\r\n  File \".../lib/python3.7/site-packages/mlflow/tracking/client.py\", line 260, in log_artifacts\r\n    self._tracking_client.log_artifacts(run_id, local_dir, artifact_path)\r\n  File \".../lib/python3.7/site-packages/mlflow/tracking/_tracking_service/client.py\", line 259, in log_artifacts\r\n    artifact_repo.log_artifacts(local_dir, artifact_path)\r\n  File \".../lib/python3.7/site-packages/mlflow/store/artifact/s3_artifact_repo.py\", line 56, in log_artifacts\r\n    posixpath.join(upload_path, f), Config=TransferConfig(use_threads=False))\r\n  File \".../lib/python3.7/site-packages/boto3/s3/inject.py\", line 131, in upload_file\r\n    extra_args=ExtraArgs, callback=Callback)\r\n  File \".../lib/python3.7/site-packages/boto3/s3/transfer.py\", line 287, in upload_file\r\n    filename, '/'.join([bucket, key]), e))\r\nboto3.exceptions.S3UploadFailedError: Failed to upload /var/folders/m2/fx5640rj3xz5d0src7pqdqmwh9vmmr/T/tmpsa38v5w_/model/python_model.pkl to .../artifacts/model/python_model.pkl: An error occurred (InvalidPart) when calling the CompleteMultipartUpload operation: Unknown\r\n```\r\n\r\n","closed_by":{"login":"rrma","id":18377705,"node_id":"MDQ6VXNlcjE4Mzc3NzA1","avatar_url":"https://avatars.githubusercontent.com/u/18377705?v=4","gravatar_id":"","url":"https://api.github.com/users/rrma","html_url":"https://github.com/rrma","followers_url":"https://api.github.com/users/rrma/followers","following_url":"https://api.github.com/users/rrma/following{/other_user}","gists_url":"https://api.github.com/users/rrma/gists{/gist_id}","starred_url":"https://api.github.com/users/rrma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rrma/subscriptions","organizations_url":"https://api.github.com/users/rrma/orgs","repos_url":"https://api.github.com/users/rrma/repos","events_url":"https://api.github.com/users/rrma/events{/privacy}","received_events_url":"https://api.github.com/users/rrma/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2401/timeline","performed_via_github_app":null,"state_reason":"completed"}