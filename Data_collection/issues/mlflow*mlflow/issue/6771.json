{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6771","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6771/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6771/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6771/events","html_url":"https://github.com/mlflow/mlflow/issues/6771","id":1370761225,"node_id":"I_kwDOCB5Jx85RtCgJ","number":6771,"title":"[BUG] Default model evaluator cannot log TreeEnsemble shap explainer","user":{"login":"jerrylian-db","id":66143562,"node_id":"MDQ6VXNlcjY2MTQzNTYy","avatar_url":"https://avatars.githubusercontent.com/u/66143562?v=4","gravatar_id":"","url":"https://api.github.com/users/jerrylian-db","html_url":"https://github.com/jerrylian-db","followers_url":"https://api.github.com/users/jerrylian-db/followers","following_url":"https://api.github.com/users/jerrylian-db/following{/other_user}","gists_url":"https://api.github.com/users/jerrylian-db/gists{/gist_id}","starred_url":"https://api.github.com/users/jerrylian-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jerrylian-db/subscriptions","organizations_url":"https://api.github.com/users/jerrylian-db/orgs","repos_url":"https://api.github.com/users/jerrylian-db/repos","events_url":"https://api.github.com/users/jerrylian-db/events{/privacy}","received_events_url":"https://api.github.com/users/jerrylian-db/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2114036915,"node_id":"MDU6TGFiZWwyMTE0MDM2OTE1","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/databricks","name":"integrations/databricks","color":"ffbce5","default":false,"description":"Databricks integrations"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-09-13T02:27:47Z","updated_at":"2022-09-21T00:34:47Z","closed_at":null,"author_association":"COLLABORATOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\nlatest master - commit: f65429478255b88a211d7dd262c159b4939b44b2\r\n\r\n### System information\r\n\r\nDatabricks MLR 11.X\r\n\r\n\r\n### Describe the problem\r\n\r\nI ran the [model validation example](https://github.com/mlflow/mlflow/blob/master/examples/evaluation/evaluate_with_model_validation.py) off of the latest master. The Tree shap explainer failed to be logged. See screenshot below:\r\n\r\n<img width=\"1688\" alt=\"Screen Shot 2022-09-12 at 7 25 44 PM\" src=\"https://user-images.githubusercontent.com/66143562/189793641-66c6dde0-9f9d-4f0f-bbe1-e20acaa16093.png\">\r\n\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\n```\r\n\r\nimport xgboost\r\nimport shap\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.dummy import DummyClassifier\r\nimport mlflow\r\nfrom mlflow.models import MetricThreshold\r\nfrom mlflow.models.evaluation.validation import ModelValidationFailedException\r\n\r\n# load UCI Adult Data Set; segment it into training and test sets\r\nX, y = shap.datasets.adult()\r\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=42)\r\n\r\n# train a candidate XGBoost model\r\ncandidate_model = xgboost.XGBClassifier().fit(X_train, y_train)\r\n\r\n# train a baseline dummy model\r\nbaseline_model = DummyClassifier(strategy=\"uniform\").fit(X_train, y_train)\r\n\r\n# construct an evaluation dataset from the test set\r\neval_data = X_test\r\neval_data[\"label\"] = y_test\r\n\r\n# Define a custom metric to evaluate against\r\ndef double_positive(_, builtin_metrics):\r\n    return {\r\n        \"double_positive\": builtin_metrics[\"true_positives\"] * 2,\r\n    }\r\n\r\n\r\n# Define criteria for model to be validated against\r\nthresholds = {\r\n    # Specify metric value threshold\r\n    \"precision_score\": MetricThreshold(\r\n        threshold=0.7, higher_is_better=True\r\n    ),  # precision should be >=0.7\r\n    # Specify model comparison thresholds\r\n    \"recall_score\": MetricThreshold(\r\n        min_absolute_change=0.1,  # recall should be at least 0.1 greater than baseline model recall\r\n        min_relative_change=0.1,  # recall should be at least 10 percent greater than baseline model recall\r\n        higher_is_better=True,\r\n    ),\r\n    # Specify both metric value and model comparison thresholds\r\n    \"accuracy_score\": MetricThreshold(\r\n        threshold=0.8,  # accuracy should be >=0.8\r\n        min_absolute_change=0.05,  # accuracy should be at least 0.05 greater than baseline model accuracy\r\n        min_relative_change=0.05,  # accuracy should be at least 5 percent greater than baseline model accuracy\r\n        higher_is_better=True,\r\n    ),\r\n    # Specify threshold for custom metric\r\n    \"double_positive\": MetricThreshold(\r\n        threshold=1e5, higher_is_better=False  # double_positive should be <=1e5\r\n    ),\r\n}\r\n\r\nwith mlflow.start_run() as run:\r\n    candidate_model_uri = mlflow.sklearn.log_model(candidate_model, \"candidate_model\").model_uri\r\n    # Note: in most model validation use-cases the baseline model should instead be a previously\r\n    # trained model (such as the current production model), specified directly in the\r\n    # mlflow.evaluate() call via model URI.\r\n    baseline_model_uri = mlflow.sklearn.log_model(baseline_model, \"baseline_model\").model_uri\r\n\r\n    mlflow.evaluate(\r\n        candidate_model_uri,\r\n        eval_data,\r\n        targets=\"label\",\r\n        model_type=\"classifier\",\r\n        dataset_name=\"adult\",\r\n        evaluators=[\"default\"],\r\n        validation_thresholds=thresholds,\r\n        custom_metrics=[double_positive],\r\n        baseline_model=baseline_model_uri,\r\n    )\r\n    # If you would like to catch model validation failures, you can add try except clauses around\r\n    # the mlflow.evaluate() call and catch the ModelValidationFailedException, imported at the top\r\n    # of this file.\r\n```\r\n\r\n### Stack trace\r\n\r\nFull trace back:\r\n```\r\n2022/09/13 02:27:06 WARNING mlflow.models.evaluation.default_evaluator: Logging explainer failed. Reason: AttributeError(\"'TreeEnsemble' object has no attribute 'save'\").Set logging level to DEBUG to see the full traceback.\r\n2022/09/13 02:27:06 DEBUG mlflow.models.evaluation.default_evaluator: \r\nTraceback (most recent call last):\r\n  File \"/local_disk0/.ephemeral_nfs/envs/pythonEnv-4113bd0b-94f3-4aa5-9ee2-47edf7480f42/lib/python3.9/site-packages/mlflow/models/evaluation/default_evaluator.py\", line 665, in _log_model_explainability\r\n    mlflow.shap.log_explainer(explainer, artifact_path=self._gen_log_key(\"explainer\"))\r\n  File \"/local_disk0/.ephemeral_nfs/envs/pythonEnv-4113bd0b-94f3-4aa5-9ee2-47edf7480f42/lib/python3.9/site-packages/mlflow/shap.py\", line 351, in log_explainer\r\n    Model.log(\r\n  File \"/local_disk0/.ephemeral_nfs/envs/pythonEnv-4113bd0b-94f3-4aa5-9ee2-47edf7480f42/lib/python3.9/site-packages/mlflow/models/model.py\", line 372, in log\r\n    flavor.save_model(path=local_path, mlflow_model=mlflow_model, **kwargs)\r\n  File \"/local_disk0/.ephemeral_nfs/envs/pythonEnv-4113bd0b-94f3-4aa5-9ee2-47edf7480f42/lib/python3.9/site-packages/mlflow/shap.py\", line 464, in save_explainer\r\n    explainer.save(explainer_output_file_handle)\r\n  File \"/databricks/python/lib/python3.9/site-packages/shap/explainers/_explainer.py\", line 419, in save\r\n    s.save(\"model\", self.model, model_saver)\r\n  File \"/databricks/python/lib/python3.9/site-packages/shap/_serializable.py\", line 87, in save\r\n    if len(inspect.getfullargspec(value.save)[0]) == 3: # backward compat for MLflow, can remove 4/1/2021\r\nAttributeError: 'TreeEnsemble' object has no attribute 'save'\r\n```\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [X] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6771/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6771/timeline","performed_via_github_app":null,"state_reason":null}