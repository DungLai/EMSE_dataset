{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2335","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2335/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2335/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2335/events","html_url":"https://github.com/mlflow/mlflow/issues/2335","id":553446389,"node_id":"MDU6SXNzdWU1NTM0NDYzODk=","number":2335,"title":"[BUG] Tensorflow inference doesn't work with Spark UDFs","user":{"login":"fhoering","id":13346472,"node_id":"MDQ6VXNlcjEzMzQ2NDcy","avatar_url":"https://avatars.githubusercontent.com/u/13346472?v=4","gravatar_id":"","url":"https://api.github.com/users/fhoering","html_url":"https://github.com/fhoering","followers_url":"https://api.github.com/users/fhoering/followers","following_url":"https://api.github.com/users/fhoering/following{/other_user}","gists_url":"https://api.github.com/users/fhoering/gists{/gist_id}","starred_url":"https://api.github.com/users/fhoering/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fhoering/subscriptions","organizations_url":"https://api.github.com/users/fhoering/orgs","repos_url":"https://api.github.com/users/fhoering/repos","events_url":"https://api.github.com/users/fhoering/events{/privacy}","received_events_url":"https://api.github.com/users/fhoering/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022865338,"node_id":"MDU6TGFiZWwyMDIyODY1MzM4","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-longterm","name":"priority/important-longterm","color":"534cb5","default":false,"description":"Important over the long term, but may not be staffed or may need multiple releases to complete."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-01-22T10:27:34Z","updated_at":"2022-06-02T17:34:11Z","closed_at":"2022-06-02T01:37:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Centos 7\r\n- **MLflow installed from (source or binary)**: Yes\r\n- **MLflow version (run ``mlflow --version``)**: 1.5.1\r\n- **Python version**: 3.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\n\r\nCurrently there are several issues with the [TensorFlow flavor](https://mlflow.org/docs/latest/models.html#tensorflow-tensorflow) in MLFlow models.\r\n\r\n- Tensorflow model needs to be exported with columns names 0,1,2,3 to have it working. See https://github.com/mlflow/mlflow/blob/master/mlflow/pyfunc/__init__.py#L443. This brings a lot of constraints for the model owner to name the Pandas/Spark df columns with generic names and also seems currently undocumented\r\n- The predict function of TF 1.x wrapper only works with regression models https://github.com/mlflow/mlflow/blob/master/mlflow/tensorflow.py#L414 not with classification models for example where the output will be a dictionary of several tensors\r\n- PyArrow currently has several limitations on datastructures https://spark.apache.org/docs/latest/sql-pyspark-pandas-with-arrow.html#supported-sql-types i.e. doesn't support ArrayTypes which means the inference with those tensors  doesn't work\r\n\r\n### Proposal for fixes:\r\n\r\n- One needs to document better on how the TensorFlow model needs to be exported and which use cases are supported\r\n- For Spark vectorized UDFs one workaround woud be to convert the whole dataframe to tf records and the export the model to accept udfs. This is all supported by default by TensorFlow. So it would be a very generic solution that doesn't have a lot of edge cases\r\nFor online inference it is still better to directly accept tensors (to prevent serialization and de-serialization). So this probably means that the model owner needs to export his model with two functions (one that accepts tensors and one that accepts tf records).\r\n\r\nFor DataFrame to tfr record conversion we could use this udf (in fact our own upstreamed solution from Criteo) that we use and that works well in a lot of cases:\r\nhttps://github.com/tensorflow/ecosystem/tree/master/spark/spark-tensorflow-connector#python-inference-with-pandas_udf-and-estimators-requires-spark--24\r\n\r\n- To fix the column naming problem in pyspark udfs we could get the input tensor keys directly from the TensorFlow model, but it means add an additional property to the pyfunc model wrapper (that currently only has the predict method), if we agree on the intermediate tf record step this would take away this constraint as we only need one single bytestream column for the tf record.\r\n\r\n###  Other remarks\r\n\r\n- we currently still mostly use estimators  but for keras one can also provide different serving functions https://www.tensorflow.org/api_docs/python/tf/saved_model/save\r\n- default export functions for estimators \r\nhttps://www.tensorflow.org/api_docs/python/tf/estimator/export/build_raw_serving_input_receiver_fn, \r\nhttps://www.tensorflow.org/api_docs/python/tf/estimator/export/build_parsing_serving_input_receiver_fn\r\n- to be checked how also this works with tf 2 (most probably the same)\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2335/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2335/timeline","performed_via_github_app":null,"state_reason":"completed"}