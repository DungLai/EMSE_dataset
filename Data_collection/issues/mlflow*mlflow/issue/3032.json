{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3032","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3032/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3032/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3032/events","html_url":"https://github.com/mlflow/mlflow/issues/3032","id":649066044,"node_id":"MDU6SXNzdWU2NDkwNjYwNDQ=","number":3032,"title":"[BUG] Error when using mlflow.keras.log_model(model, 'best_model')","user":{"login":"julien-h","id":11776282,"node_id":"MDQ6VXNlcjExNzc2Mjgy","avatar_url":"https://avatars.githubusercontent.com/u/11776282?v=4","gravatar_id":"","url":"https://api.github.com/users/julien-h","html_url":"https://github.com/julien-h","followers_url":"https://api.github.com/users/julien-h/followers","following_url":"https://api.github.com/users/julien-h/following{/other_user}","gists_url":"https://api.github.com/users/julien-h/gists{/gist_id}","starred_url":"https://api.github.com/users/julien-h/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/julien-h/subscriptions","organizations_url":"https://api.github.com/users/julien-h/orgs","repos_url":"https://api.github.com/users/julien-h/repos","events_url":"https://api.github.com/users/julien-h/events{/privacy}","received_events_url":"https://api.github.com/users/julien-h/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022863969,"node_id":"MDU6TGFiZWwyMDIyODYzOTY5","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-soon","name":"priority/important-soon","color":"534cb5","default":false,"description":"The issue is worked on by the community currently or will be very soon, ideally in time for the"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2020-07-01T15:18:26Z","updated_at":"2022-05-29T15:54:44Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ x] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 18.04.3 LTS\r\n- **MLflow installed from (source or binary)**: from pip\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.9.1\r\n- **Python version**: Python 3.7.7\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Include descriptions of the expected behavior and the actual behavior.\r\n\r\nWhen using `mlflow.keras.log_model` with a keras model, I get the following error:\r\n\r\n```\r\n2020/07/01 14:49:45 ERROR mlflow.utils.rest_utils: API request to http://0.0.0.0:8765/api/2.0/mlflow/runs/log-model failed with code 500 != 200, retrying up to 2 more times. API response body: {\"error_code\": \"INTERNAL_ERROR\", \"message\": \"Tag value '[{\\\"run_id\\\": \\\"862b8c024cf44623bca2c266f71519a1\\\", \\\"artifact_path\\\": \\\"best_model\\\", \\\"utc_time_created\\\": \\\"2020-07-01 14:47:40.934320\\\", \\\"flavors\\\": {\\\"keras\\\": {\\\"keras_module\\\": \\\"tensorflow.keras\\\", \\\"keras_version\\\": \\\"2.3.0-tf\\\", \\\"data\\\": \\\"data\\\"}, \\\"python_function\\\"' had length 5280, which exceeded length limit of 5000\"}\r\n2020/07/01 14:49:48 ERROR mlflow.utils.rest_utils: API request to http://0.0.0.0:8765/api/2.0/mlflow/runs/log-model failed with code 500 != 200, retrying up to 1 more times. API response body: {\"error_code\": \"INTERNAL_ERROR\", \"message\": \"Tag value '[{\\\"run_id\\\": \\\"862b8c024cf44623bca2c266f71519a1\\\", \\\"artifact_path\\\": \\\"best_model\\\", \\\"utc_time_created\\\": \\\"2020-07-01 14:47:40.934320\\\", \\\"flavors\\\": {\\\"keras\\\": {\\\"keras_module\\\": \\\"tensorflow.keras\\\", \\\"keras_version\\\": \\\"2.3.0-tf\\\", \\\"data\\\": \\\"data\\\"}, \\\"python_function\\\"' had length 5280, which exceeded length limit of 5000\"}\r\n2020/07/01 14:49:51 ERROR mlflow.utils.rest_utils: API request to http://0.0.0.0:8765/api/2.0/mlflow/runs/log-model failed with code 500 != 200, retrying up to 0 more times. API response body: {\"error_code\": \"INTERNAL_ERROR\", \"message\": \"Tag value '[{\\\"run_id\\\": \\\"862b8c024cf44623bca2c266f71519a1\\\", \\\"artifact_path\\\": \\\"best_model\\\", \\\"utc_time_created\\\": \\\"2020-07-01 14:47:40.934320\\\", \\\"flavors\\\": {\\\"keras\\\": {\\\"keras_module\\\": \\\"tensorflow.keras\\\", \\\"keras_version\\\": \\\"2.3.0-tf\\\", \\\"data\\\": \\\"data\\\"}, \\\"python_function\\\"' had length 5280, which exceeded length limit of 5000\"}\r\n2020/07/01 14:49:54 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under /data/mlflow-artifacts/0/862b8c024cf44623bca2c266f71519a1/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the  tracking store. If logging to a mlflow server via REST, consider  upgrading the server version to MLflow 1.7.0 or above.\r\n```\r\n\r\nI run this function at every epoch in a keras callback. What is surprising it that I only get the error after several epochs. The first few times the model is saved without errors.\r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\nRun mlflow server:\r\n```\r\nmlflow server -h 0.0.0.0 -p 8765 --backend-store-uri sqlite:////data/mlflow.db --default-artifact-root /data/mlflow-artifacts/\r\n```\r\n\r\nCode (simple keras model on mnist):\r\n\r\n```python\r\nimport mlflow\r\nimport mlflow.keras\r\nimport mlflow.tensorflow\r\n\r\nimport numpy as np\r\nimport tensorflow\r\nimport tensorflow as tf\r\n\r\nfrom tensorflow.keras.models import Sequential\r\nfrom tensorflow.keras.layers import Dense, Dropout\r\nfrom tensorflow.keras.optimizers import RMSprop\r\n\r\nmlflow.set_tracking_uri('http://0.0.0.0:8765')\r\n\r\n# -------------------------------------\r\n# Used to save the model after each epoch\r\n\r\nclass MlFlowModelCheckpoint(tensorflow.keras.callbacks.ModelCheckpoint):\r\n    def __init__(self, artifact_name, *args, **kwargs):\r\n        super().__init__(*args, **kwargs)\r\n        self.artifact_name = artifact_name\r\n\r\n    def _save_model(self, epoch, logs):\r\n        super()._save_model(epoch, logs)\r\n        mlflow.keras.log_model(self.model, self.artifact_name)\r\n\r\nmodel_checkpoint_callback = MlFlowModelCheckpoint(\r\n    artifact_name='best_model',\r\n    filepath='/data/checkpoints/best_model.h5',\r\n    save_weights_only=False,\r\n    monitor='val_loss',\r\n    mode='min',\r\n    save_best_only=True)\r\n\r\n# -----------------------------------\r\n\r\nparams = dict(\r\n    batch_size = 128,\r\n    num_classes = 10,\r\n    epochs = 200,\r\n)\r\n\r\n(x_train, y_train), (x_test, y_test) = tf.keras.datasets.mnist.load_data()\r\nx_train = x_train.reshape(60000, 784)\r\nx_test = x_test.reshape(10000, 784)\r\nx_train = x_train.astype('float32')\r\nx_test = x_test.astype('float32')\r\nx_train /= 255\r\nx_test /= 255\r\ny_train = tf.keras.utils.to_categorical(y_train, params['num_classes'])\r\ny_test = tf.keras.utils.to_categorical(y_test, params['num_classes'])\r\n\r\ndef make_model():\r\n    model = Sequential()\r\n    model.add(Dense(512, activation='relu', input_shape=(784,)))\r\n    model.add(Dropout(0.2))\r\n    model.add(Dense(512, activation='relu'))\r\n    model.add(Dropout(0.2))\r\n    model.add(Dense(params['num_classes'], activation='softmax'))\r\n    return model\r\n\r\n\r\nwith mlflow.start_run(run_name='mnist_keras_tutorial') as run:\r\n    mlflow.tensorflow.autolog(\r\n        every_n_iter=1\r\n    )\r\n    \r\n    model = make_model()\r\n    model.compile(loss='categorical_crossentropy',\r\n              optimizer=tf.keras.optimizers.SGD(\r\n                learning_rate=0.00001,\r\n              ),\r\n              metrics=['accuracy'])\r\n    \r\n    history = model.fit(\r\n        x_train,\r\n        y_train,\r\n        batch_size=params['batch_size'],\r\n        epochs=params['epochs'],\r\n        verbose=1,\r\n        validation_data=(x_test, y_test),\r\n        callbacks=[model_checkpoint_callback],\r\n    )\r\n```\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [?] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for\r\nModel Registry\r\n- [?] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3032/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3032/timeline","performed_via_github_app":null,"state_reason":null}