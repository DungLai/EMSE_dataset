{"url":"https://api.github.com/repos/mlflow/mlflow/issues/940","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/940/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/940/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/940/events","html_url":"https://github.com/mlflow/mlflow/issues/940","id":416421708,"node_id":"MDU6SXNzdWU0MTY0MjE3MDg=","number":940,"title":"Failure in examples/r_wine R Markdown with 'server encountered an internal error'","user":{"login":"jimthompson5802","id":1425269,"node_id":"MDQ6VXNlcjE0MjUyNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1425269?v=4","gravatar_id":"","url":"https://api.github.com/users/jimthompson5802","html_url":"https://github.com/jimthompson5802","followers_url":"https://api.github.com/users/jimthompson5802/followers","following_url":"https://api.github.com/users/jimthompson5802/following{/other_user}","gists_url":"https://api.github.com/users/jimthompson5802/gists{/gist_id}","starred_url":"https://api.github.com/users/jimthompson5802/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimthompson5802/subscriptions","organizations_url":"https://api.github.com/users/jimthompson5802/orgs","repos_url":"https://api.github.com/users/jimthompson5802/repos","events_url":"https://api.github.com/users/jimthompson5802/events{/privacy}","received_events_url":"https://api.github.com/users/jimthompson5802/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-03-02T17:46:10Z","updated_at":"2019-03-25T02:37:03Z","closed_at":"2019-03-25T02:37:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: examples/r_wine/train.Rmd\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MacOS 10.14.3\r\n- **MLflow installed from (source or binary)**:  binary install in Docker image rocker/rstudio.  **Dockerfile** to build image\r\n```\r\nFROM rocker/rstudio-stable:latest\r\n\r\n# install miniconda and prereq libraries\r\nRUN apt-get update && \\\r\n    apt-get install -y zlib1g-dev libxml2-dev bzip2 && \\\r\n    wget -nv https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \\\r\n       -O /tmp/miniconda.sh  && \\\r\n    bash /tmp/miniconda.sh -b -p /opt/conda \r\n\r\n# set up path to conda binary\r\nENV PATH /opt/conda/bin:$PATH\r\n\r\n# install R prereq packages and R mlflow support\r\nRUN mkdir ~/.R &&\\\r\n    echo 'MAKEFLAGS = -j6' >~/.R/Makevars && \\\r\n    Rscript -e \"install.packages(c('devtools','glmnet','rmarkdown'), Ncpus=3)\"  \\\r\n      -e \"library(devtools)\" \\\r\n      -e \"devtools::install_github('mlflow/mlflow', subdir = 'mlflow/R/mlflow', threads=4)\" \\\r\n      -e \"Sys.setenv(PATH = paste('/opt/conda/bin',Sys.getenv('PATH'), sep=':'))\"  \\\r\n      -e \"mlflow::mlflow_install()\"\r\n\r\n# create link to user source code\r\nRUN cd /home/rstudio && \\\r\n    ln -s /opt/project project && \\\r\n    echo  '\\nexport PATH=/opt/conda/bin:$PATH' >>./.bashrc && \\\r\n    echo 'Sys.setenv(PATH=paste(\"/opt/conda/bin\",Sys.getenv(\"PATH\"),sep=\":\"))' >>./.Rprofile\r\n```\r\n- **MLflow version (run ``mlflow --version``)**:  mlflow, version 0.8.2\r\n- **Python version**: Anaconda Python 3.7.2\r\n- **npm version (if running the dev UI):\r\n- **Exact command to reproduce**:  Executed train.Rmd in RStudio IDE\r\n\r\n### Describe the problem\r\nError messages that appeared:\r\n```\r\nElasticnet model (alpha=0.5, lambda=0.5):\r\n  RMSE: 0.831979670110336\r\n  MAE: 0.621679680171868\r\n  R2: 0.14762098099876\r\nNo encoding supplied: defaulting to UTF-8.\r\nThe server encountered an internal error and was unable to complete your request.  Either the server is overloaded or there is an error in the application.\r\n```\r\n\r\nWithin the ./mlruns directory, only the following were recorded: `alpha`, `lambda` and `rmse`.  Failure occurred on `mlflow_log_metric(\"r2\", r2)` because this metric was not recorded.\r\n\r\n### Source code / logs\r\nMWE is the `examples/r_wine/train.Rmd`.  log from failure:\r\n```\r\nwith(mlflow_start_run(), {\r\n    model <- glmnet(train_x, train_y, alpha = alpha, lambda = lambda, family = \"gaussian\")\r\n    predictor <- crate(~ glmnet::predict.glmnet(model, as.matrix(.x)), model)\r\n    predicted <- predictor(test_x)\r\n\r\n    rmse <- sqrt(mean((predicted - test_y) ^ 2))\r\n    mae <- mean(abs(predicted - test_y))\r\n    r2 <- cor(predicted, test_y) ^ 2\r\n\r\n    message(\"Elasticnet model (alpha=\", alpha, \", lambda=\", lambda, \"):\")\r\n    message(\"  RMSE: \", rmse)\r\n    message(\"  MAE: \", mae)\r\n    message(\"  R2: \", r2)\r\n\r\n    mlflow_log_param(\"alpha\", alpha)\r\n    mlflow_log_param(\"lambda\", lambda)\r\n    mlflow_log_metric(\"rmse\", rmse)\r\n    mlflow_log_metric(\"r2\", r2)\r\n    mlflow_log_metric(\"mae\", mae)\r\n\r\n    mlflow_log_model(predictor, \"model\")\r\n```\r\n\r\n### Root Cause Analysis:  \r\nIn looking at the data class used for the params and metrics we find:\r\n```\r\n[1] \"param alpha: class numeric\"\r\n[1] \"param lambda: class numeric\"\r\n[1] \"metric rmse: class numeric\"\r\n[1] \"metric r2: class matrix\"\r\n[1] \"metric mae: class numeric\"\r\n```\r\n\r\n Changing this call `mlflow_log_metric(\"r2\", r2)` to reference the specific element in the matrix resolves the problem `mlflow_log_metric(\"r2\", r2[1,1])`  Will submit PR with this fix.","closed_by":{"login":"mateiz","id":228859,"node_id":"MDQ6VXNlcjIyODg1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228859?v=4","gravatar_id":"","url":"https://api.github.com/users/mateiz","html_url":"https://github.com/mateiz","followers_url":"https://api.github.com/users/mateiz/followers","following_url":"https://api.github.com/users/mateiz/following{/other_user}","gists_url":"https://api.github.com/users/mateiz/gists{/gist_id}","starred_url":"https://api.github.com/users/mateiz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mateiz/subscriptions","organizations_url":"https://api.github.com/users/mateiz/orgs","repos_url":"https://api.github.com/users/mateiz/repos","events_url":"https://api.github.com/users/mateiz/events{/privacy}","received_events_url":"https://api.github.com/users/mateiz/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/940/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/940/timeline","performed_via_github_app":null,"state_reason":"completed"}