{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1487","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1487/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1487/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1487/events","html_url":"https://github.com/mlflow/mlflow/issues/1487","id":459133539,"node_id":"MDU6SXNzdWU0NTkxMzM1Mzk=","number":1487,"title":"\"ValueError: invalid interpolation syntax\" with username containing \"%\"","user":{"login":"hershaw","id":424192,"node_id":"MDQ6VXNlcjQyNDE5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/424192?v=4","gravatar_id":"","url":"https://api.github.com/users/hershaw","html_url":"https://github.com/hershaw","followers_url":"https://api.github.com/users/hershaw/followers","following_url":"https://api.github.com/users/hershaw/following{/other_user}","gists_url":"https://api.github.com/users/hershaw/gists{/gist_id}","starred_url":"https://api.github.com/users/hershaw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hershaw/subscriptions","organizations_url":"https://api.github.com/users/hershaw/orgs","repos_url":"https://api.github.com/users/hershaw/repos","events_url":"https://api.github.com/users/hershaw/events{/privacy}","received_events_url":"https://api.github.com/users/hershaw/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":25,"created_at":"2019-06-21T10:39:38Z","updated_at":"2020-01-14T16:50:39Z","closed_at":"2020-01-14T09:13:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 18.04\r\n- **MLflow installed from (source or binary)**: `pip install mlflow==1.0.0`\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.0.0\r\n- **Python version**: Python 3.6.8\r\n- **npm version (if running the dev UI): N/A\r\n- **Exact command to reproduce**:\r\n```bash\r\nmlflow server \\\r\n    --backend-store-uri \"postgresql://mlflow%40mlflow:__password__@mydb.postgres.database.azure.com/mlflow\" \\\r\n    --default-artifact-root \"N/A\" \\\r\n    --host 0.0.0.0 \\\r\n    --port 3000\r\n```\r\n\r\n### Describe the problem\r\nThe hosted version of microsoft azure (stupidly) requires an `@` symbol in the username. Regaredless of whether or not in the `backend-store-uri` you uri_encode it to become a `%40`, it will be escaped before being saved in an [alembic config](https://github.com/mlflow/mlflow/blob/43700cb838992fddef848cff7f1a37197b035ee0/mlflow/store/db/utils.py#L36).\r\n\r\n### Source code / logs\r\n```\r\n2019/06/21 10:15:59 INFO mlflow.store.sqlalchemy_store: Creating initial MLflow database tables...\r\n2019/06/21 10:16:04 INFO mlflow.store.db.utils: Updating database tables at postgresql://mlflow%40mlflow:__password__@mydb.postgres.database.azure.com/mlflow\r\n2019/06/21 10:16:04 ERROR mlflow.cli: Error initializing backend store\r\n2019/06/21 10:16:04 ERROR mlflow.cli: invalid interpolation syntax in 'postgresql://mlflow%40mlflow:__password__@mydb.postgres.database.azure.com/mlflow' at position 19\r\nTraceback (most recent call last):\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/cli.py\", line 247, in server\r\n    _get_store(backend_store_uri, default_artifact_root)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 35, in _get_store\r\n    _store = SqlAlchemyStore(store_dir, artifact_root)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/store/sqlalchemy_store.py\", line 85, in __init__\r\n    SqlAlchemyStore._initialize_tables(self.engine)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/store/sqlalchemy_store.py\", line 103, in _initialize_tables\r\n    _upgrade_db(engine_url)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/store/db/utils.py\", line 53, in _upgrade_db\r\n    config = _get_alembic_config(url)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/mlflow/store/db/utils.py\", line 36, in _get_alembic_config\r\n    config.set_main_option('sqlalchemy.url', db_url)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/alembic/config.py\", line 237, in set_main_option\r\n    self.set_section_option(self.config_ini_section, name, value)\r\n  File \"/home/sam/.virtualenvs/mlflow-tracking-server/lib/python3.6/site-packages/alembic/config.py\", line 264, in set_section_option\r\n    self.file_config.set(section, name, value)\r\n  File \"/usr/lib/python3.6/configparser.py\", line 1193, in set\r\n    super().set(section, option, value)\r\n  File \"/usr/lib/python3.6/configparser.py\", line 894, in set\r\n    value)\r\n  File \"/usr/lib/python3.6/configparser.py\", line 402, in before_set\r\n    \"position %d\" % (value, tmp_value.find('%')))\r\n```\r\n\r\n### Quick hack to fix\r\n\r\nI modified the `_get_alembic_config` function from this:\r\n\r\n```py\r\ndef _get_alembic_config(db_url, alembic_dir=None):\r\n    from alembic.config import Config\r\n    final_alembic_dir = os.path.join(_get_package_dir(), 'alembic')\\\r\n        if alembic_dir is None else alembic_dir\r\n    config = Config(os.path.join(final_alembic_dir, 'alembic.ini'))\r\n    config.set_main_option('script_location', final_alembic_dir)\r\n    config.set_main_option('sqlalchemy.url', db_url)\r\n    return config\r\n```\r\n\r\nTo this:\r\n\r\n```py\r\ndef _get_alembic_config(db_url, alembic_dir=None):\r\n    from alembic.config import Config\r\n    final_alembic_dir = os.path.join(_get_package_dir(), 'alembic')\\\r\n        if alembic_dir is None else alembic_dir\r\n    config = Config(os.path.join(final_alembic_dir, 'alembic.ini'))\r\n    config.set_main_option('script_location', final_alembic_dir)\r\n    # NEW CODE HERE TO ESCAPE THE '%'\r\n    db_url = db_url.replace('%', '%%')\r\n    config.set_main_option('sqlalchemy.url', db_url)\r\n    return config\r\n```\r\n\r\nAnd I am now up and running. I'm also a bit confused about why this has not come up yet in an issue (couldn't find one anyway) as special characters in a password are quite common. Normally to work around I would just change the name or the password but in this case I cannot because azure decided to require an `@` in all of its database usernames.","closed_by":{"login":"hershaw","id":424192,"node_id":"MDQ6VXNlcjQyNDE5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/424192?v=4","gravatar_id":"","url":"https://api.github.com/users/hershaw","html_url":"https://github.com/hershaw","followers_url":"https://api.github.com/users/hershaw/followers","following_url":"https://api.github.com/users/hershaw/following{/other_user}","gists_url":"https://api.github.com/users/hershaw/gists{/gist_id}","starred_url":"https://api.github.com/users/hershaw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hershaw/subscriptions","organizations_url":"https://api.github.com/users/hershaw/orgs","repos_url":"https://api.github.com/users/hershaw/repos","events_url":"https://api.github.com/users/hershaw/events{/privacy}","received_events_url":"https://api.github.com/users/hershaw/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1487/reactions","total_count":10,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1487/timeline","performed_via_github_app":null,"state_reason":"completed"}