{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7481","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7481/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7481/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7481/events","html_url":"https://github.com/mlflow/mlflow/issues/7481","id":1484445206,"node_id":"I_kwDOCB5Jx85YetYW","number":7481,"title":"[BUG] MLflow Tracking server with proxied artifact access fails with `ValueError: not enough values to unpack (expected 2, got 1)`","user":{"login":"TomSteenbergen","id":41334387,"node_id":"MDQ6VXNlcjQxMzM0Mzg3","avatar_url":"https://avatars.githubusercontent.com/u/41334387?v=4","gravatar_id":"","url":"https://api.github.com/users/TomSteenbergen","html_url":"https://github.com/TomSteenbergen","followers_url":"https://api.github.com/users/TomSteenbergen/followers","following_url":"https://api.github.com/users/TomSteenbergen/following{/other_user}","gists_url":"https://api.github.com/users/TomSteenbergen/gists{/gist_id}","starred_url":"https://api.github.com/users/TomSteenbergen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TomSteenbergen/subscriptions","organizations_url":"https://api.github.com/users/TomSteenbergen/orgs","repos_url":"https://api.github.com/users/TomSteenbergen/repos","events_url":"https://api.github.com/users/TomSteenbergen/events{/privacy}","received_events_url":"https://api.github.com/users/TomSteenbergen/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-12-08T11:38:51Z","updated_at":"2022-12-14T15:05:57Z","closed_at":"2022-12-09T23:06:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\r\n\r\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\n\r\n### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n- Client: 2.0.1\r\n- Tracking server: 2.0.1\r\n\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MacOS 12.6\r\n- **Python version**: 3.10\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\nBoth on Kubernetes and locally using `docker compose`, I cannot get the proxied artifact access to work with MLflow Tracking. I've followed the docs and consulted other issues and threads, but have not been able to solve it.\r\n\r\nBelow, I attached the `docker-compose.yml` to spin up a MLflow Tracking Server locally with a Postgres database and Minio S3 storage. I checked and I correctly set all the required environment variables when running the `mlflow server` command. \r\n\r\nWhat's missing in my solution?\r\n\r\n\r\n### Tracking information\r\n\r\n#### Client information:\r\n```\r\n# MLflow < 2.0\r\nprint(\"MLflow version:\", mlflow.__version__)\r\nprint(\"Tracking URI:\", mlflow.get_tracking_uri())\r\nprint(\"Artifact URI:\", mlflow.get_artifact_uri())\r\n\r\n# MLflow >= 2.0\r\nmlflow.doctor()\r\n```\r\n\r\n```\r\nMLflow version: 2.0.1\r\nTracking URI: http://127.0.0.1:5001\r\nArtifact URI: mlflow-artifacts:/9/3d05766953f247d8ac1cf2bad8126bd8/artifacts\r\nSystem information: Darwin Darwin Kernel Version 21.6.0: Mon Aug 22 20:17:10 PDT 2022; root:xnu-8020.140.49~2/RELEASE_X86_64\r\nPython version: 3.10.7\r\nMLflow version: 2.0.1\r\nMLflow module location: <redacted>/lib/python3.10/site-packages/mlflow/__init__.py\r\nTracking URI: http://127.0.0.1:5001\r\nRegistry URI: http://127.0.0.1:5001\r\nActive experiment ID: 9\r\nActive run ID: 3d05766953f247d8ac1cf2bad8126bd8\r\nActive run artifact URI: mlflow-artifacts:/9/3d05766953f247d8ac1cf2bad8126bd8/artifacts\r\nMLflow environment variables: {}\r\nMLflow dependencies: {\r\n    \"click\": \"8.1.3\",\r\n    \"cloudpickle\": \"2.2.0\",\r\n    \"databricks-cli\": \"0.17.3\",\r\n    \"entrypoints\": \"0.4\",\r\n    \"gitpython\": \"3.1.29\",\r\n    \"pyyaml\": \"6.0\",\r\n    \"protobuf\": \"4.21.10\",\r\n    \"pytz\": \"2022.6\",\r\n    \"requests\": \"2.28.1\",\r\n    \"packaging\": \"21.3\",\r\n    \"importlib-metadata\": \"5.1.0\",\r\n    \"sqlparse\": \"0.4.3\",\r\n    \"alembic\": \"1.8.1\",\r\n    \"docker\": \"6.0.1\",\r\n    \"Flask\": \"2.2.2\",\r\n    \"numpy\": \"1.23.5\",\r\n    \"scipy\": \"1.9.3\",\r\n    \"pandas\": \"1.5.2\",\r\n    \"querystring-parser\": \"1.2.4\",\r\n    \"sqlalchemy\": \"1.4.41\",\r\n    \"scikit-learn\": \"1.1.3\",\r\n    \"pyarrow\": \"10.0.1\",\r\n    \"shap\": \"0.41.0\",\r\n    \"markdown\": \"3.4.1\",\r\n    \"matplotlib\": \"3.6.2\",\r\n    \"gunicorn\": \"20.1.0\",\r\n    \"Jinja2\": \"3.1.2\"\r\n}\r\n```\r\n\r\n#### Server command\r\n```\r\nmlflow server \\\r\n--backend-store-uri \"$MLFLOW_BACKEND_STORE_URI\" \\\r\n--artifacts-destination \"$MLFLOW_ARTIFACTS_DESTINATION\" \\\r\n--serve-artifacts \\\r\n--host 0.0.0.0 \\\r\n--port 5001\r\n```\r\n\r\n#### Docker-compose file:\r\n```\r\n---\r\nversion: \"3\"\r\nservices:\r\n  minio:\r\n    restart: always\r\n    image: minio/minio\r\n    container_name: mlflow_s3\r\n    ports:\r\n      - \"9000:9000\"\r\n      - \"9001:9001\"\r\n    networks:\r\n      - backend\r\n    entrypoint: sh\r\n    command: -c 'mkdir -p /data/local-test-mlflow-tracking && minio server /data --console-address \":9001\" --address \":9000\"'\r\n    environment:\r\n      - MINIO_ROOT_USER=minio\r\n      - MINIO_ROOT_PASSWORD=minio123\r\n    volumes:\r\n      - ~/mlflow_minio_data:/data\r\n  db:\r\n    restart: always\r\n    image: postgres:alpine\r\n    container_name: mlflow_db\r\n    ports:\r\n      - \"5432:5432\"\r\n    networks:\r\n      - backend\r\n    volumes:\r\n      - ~/mlflow_postgres_data:/var/lib/postgresql/data\r\n    environment:\r\n      - POSTGRES_DB=mlflow_db\r\n      - POSTGRES_USER=postgres\r\n      - POSTGRES_PASSWORD=test\r\n  app:\r\n    restart: always\r\n    build:\r\n      context: .\r\n    image: mlflow_server\r\n    container_name: mlflow_server\r\n    depends_on:\r\n      - db\r\n      - minio\r\n    ports:\r\n      - \"5001:5001\"\r\n    networks:\r\n      - backend\r\n    environment:\r\n      - MLFLOW_ARTIFACTS_DESTINATION=s3://local-test-mlflow-tracking/mlartifacts/\r\n      - MLFLOW_S3_ENDPOINT_URL=http://127.0.0.1:9000\r\n      - MLFLOW_BACKEND_STORE_URI=postgresql://postgres:test@db:5432/mlflow_db\r\n      - AWS_ACCESS_KEY_ID=minio\r\n      - AWS_SECRET_ACCESS_KEY=minio123\r\n      - AWS_DEFAULT_REGION=us-east-1\r\n\r\n\r\nnetworks:\r\n  backend:\r\n    driver: bridge\r\n\r\nvolumes:\r\n  mlflow_postgres_data: null\r\n  mlflow_minio_data: null\r\n```\r\n\r\n### Code to reproduce issue\r\n\r\n```python\r\nfrom pathlib import Path\r\nimport mlflow\r\n\r\nmlflow.set_tracking_uri(\"http://127.0.0.1:5001\")\r\nmlflow.set_experiment(\"some-new-experiment\")\r\nwith mlflow.start_run():\r\n    mlflow.log_artifact(Path(__file__))\r\n```\r\n\r\n### Stack trace\r\n\r\n```python\r\nTraceback (most recent call last):\r\n  File \"<redacted>/mlflow_test.py\", line 7, in <module>\r\n    mlflow.log_artifact(Path(__file__))\r\n  File \"<redacted>/lib/python3.10/site-packages/mlflow/tracking/fluent.py\", line 778, in log_artifact\r\n    MlflowClient().log_artifact(run_id, local_path, artifact_path)\r\n  File \"<redacted>/lib/python3.10/site-packages/mlflow/tracking/client.py\", line 1002, in log_artifact\r\n    self._tracking_client.log_artifact(run_id, local_path, artifact_path)\r\n  File \"<redacted>/lib/python3.10/site-packages/mlflow/tracking/_tracking_service/client.py\", line 416, in log_artifact\r\n    artifact_repo.log_artifact(local_path, artifact_path)\r\n  File \"<redacted>/lib/python3.10/site-packages/mlflow/store/artifact/http_artifact_repo.py\", line 25, in log_artifact\r\n    resp = http_request(self._host_creds, endpoint, \"PUT\", data=f)\r\n  File \"<redacted>/lib/python3.10/site-packages/mlflow/utils/rest_utils.py\", line 184, in http_request\r\n    raise MlflowException(\"API request to %s failed with exception %s\" % (url, e))\r\nmlflow.exceptions.MlflowException: API request to http://127.0.0.1:5001/api/2.0/mlflow-artifacts/artifacts/10/139579893a674993ae2a2f2ac049d916/artifacts/mlflow_test.py failed with exception HTTPConnectionPool(host='127.0.0.1', port=5001): Max retries exceeded with url: /api/2.0/mlflow-artifacts/artifacts/10/139579893a674993ae2a2f2ac049d916/artifacts/mlflow_test.py (Caused by ProtocolError('Connection aborted.', RemoteDisconnected('Remote end closed connection without response')))\r\n```\r\n\r\n\r\n### Other info / logs\r\n\r\n#### Tracking server logs\r\n```\r\nmlflow_server  | 2022/12/08 11:31:49 ERROR mlflow.server: Exception on /ajax-api/2.0/mlflow/artifacts/list [GET]\r\nmlflow_server  | Traceback (most recent call last):\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/flask/app.py\", line 2525, in wsgi_app\r\nmlflow_server  |     response = self.full_dispatch_request()\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/flask/app.py\", line 1822, in full_dispatch_request\r\nmlflow_server  |     rv = self.handle_user_exception(e)\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/flask/app.py\", line 1820, in full_dispatch_request\r\nmlflow_server  |     rv = self.dispatch_request()\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/flask/app.py\", line 1796, in dispatch_request\r\nmlflow_server  |     return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/server/handlers.py\", line 452, in wrapper\r\nmlflow_server  |     return func(*args, **kwargs)\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/server/handlers.py\", line 522, in wrapper\r\nmlflow_server  |     return func(*args, **kwargs)\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/server/handlers.py\", line 928, in _list_artifacts\r\nmlflow_server  |     artifact_entities = _list_artifacts_for_proxied_run_artifact_root(\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/server/handlers.py\", line 452, in wrapper\r\nmlflow_server  |     return func(*args, **kwargs)\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/server/handlers.py\", line 965, in _list_artifacts_for_proxied_run_artifact_root\r\nmlflow_server  |     for file_info in artifact_destination_repo.list_artifacts(artifact_destination_path):\r\nmlflow_server  |   File \"/home/.venv/lib/python3.10/site-packages/mlflow/store/artifact/http_artifact_repo.py\", line 44, in list_artifacts\r\nmlflow_server  |     url, tail = self.artifact_uri.split(endpoint, maxsplit=1)\r\nmlflow_server  | ValueError: not enough values to unpack (expected 2, got 1)\r\n```\r\n\r\n#### Screenshot UI\r\nWhen browsing to the experiment in the UI, the `Artifacts` tab shows the below error:\r\n![image](https://user-images.githubusercontent.com/41334387/206436947-0d12ead3-dc2e-47c5-9f33-726f7eb579de.png)\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7481/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7481/timeline","performed_via_github_app":null,"state_reason":"completed"}