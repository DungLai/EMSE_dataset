{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3587","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3587/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3587/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3587/events","html_url":"https://github.com/mlflow/mlflow/issues/3587","id":728176818,"node_id":"MDU6SXNzdWU3MjgxNzY4MTg=","number":3587,"title":"[BUG] MLflow deployment on AzureML fails because of a previous version of Numpy.","user":{"login":"deepankerkoul","id":32043450,"node_id":"MDQ6VXNlcjMyMDQzNDUw","avatar_url":"https://avatars.githubusercontent.com/u/32043450?v=4","gravatar_id":"","url":"https://api.github.com/users/deepankerkoul","html_url":"https://github.com/deepankerkoul","followers_url":"https://api.github.com/users/deepankerkoul/followers","following_url":"https://api.github.com/users/deepankerkoul/following{/other_user}","gists_url":"https://api.github.com/users/deepankerkoul/gists{/gist_id}","starred_url":"https://api.github.com/users/deepankerkoul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/deepankerkoul/subscriptions","organizations_url":"https://api.github.com/users/deepankerkoul/orgs","repos_url":"https://api.github.com/users/deepankerkoul/repos","events_url":"https://api.github.com/users/deepankerkoul/events{/privacy}","received_events_url":"https://api.github.com/users/deepankerkoul/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022851725,"node_id":"MDU6TGFiZWwyMDIyODUxNzI1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docker","name":"area/docker","color":"ede978","default":false,"description":"Docker use anywhere, such as MLprojects and MLmodels"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"},{"id":2042304474,"node_id":"MDU6TGFiZWwyMDQyMzA0NDc0","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/build","name":"area/build","color":"48eabc","default":false,"description":"Build and test infrastructure for MLflow"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-10-23T12:25:54Z","updated_at":"2022-06-02T00:46:36Z","closed_at":"2022-06-02T00:46:36Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Custom code for model training and stock code from documentation for deployment to Azure\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 16.04.6\r\n- **MLflow installed from (source or binary)**: Source (pip)\r\n- **MLflow version (run ``mlflow --version``)**: 1.11.0\r\n- **Python version**: Tried with 3.6 as well as 3.7.9\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: mlflow.azureml.build_image(model_uri=<my_mlrun_uri>, workspace=ws, synchronous=True)\r\n\r\n### Describe the problem\r\nMLflow deployment on AzureML fails because of a previous version of Numpy.\r\n\r\nI have developed a custom code that I am trying to deploy to Azure using MLFlow. I have used the deployment script multiple times over last couple of months so I know that nothing is wrong there.\r\n\r\nAnyway, I let the image build using the command ```mlflow.azureml.build_image(model_uri=<my_mlrun_uri>, workspace=ws, synchronous=True)``` and build succeeds, but when I deploy the Image as a webservice using Azure Container Instances, the \r\ncode fails with a Timeout Error and the following error:\r\n\r\n```\r\nWebserviceException: WebserviceException:\r\n\tMessage: Service deployment polling reached non-successful terminal state, current service state: Unhealthy\r\nOperation ID: 5bcee0af-35b7-45ae-8be3-ff3a610afa2a\r\nMore information can be found using '.get_logs()'\r\nError:\r\n{\r\n  \"code\": \"DeploymentTimedOut\",\r\n  \"statusCode\": 504,\r\n  \"message\": \"The deployment operation polling has TimedOut. The service creation is taking longer than our normal time. We are still trying to achieve the desired state for the web service. Please check the webservice state for the current webservice health. You can run print(service.state) from the python SDK to retrieve the current state of the webservice.\r\nPlease refer to https://aka.ms/debugimage#dockerlog for more information.\",\r\n  \"details\": [\r\n    {\r\n      \"code\": \"AciDeploymentFailed\",\r\n      \"message\": \"Your container application crashed. Please follow the steps to debug:\r\n1. From the AML SDK, you can run print(service.get_logs()) if you have service object to fetch the logs. Please refer to https://aka.ms/debugimage#dockerlog for more information.\r\n2. If your container application crashed. This may be caused by errors in your scoring file's init() function. You can try debugging locally first. Please refer to https://aka.ms/debugimage#debug-locally for more information.\r\n3. View the diagnostic events to check status of container, it may help you to debug the issue. \r\n{\"restartCount\":7,\r\n\"currentState\": {\"state\":\"Waiting\",\"startTime\":null,\"exitCode\":null,\"finishTime\":null,\"detailStatus\":\"CrashLoopBackOff: Back-off 5m0s restarting failed\"},\r\n\"previousState\":{\"state\":\"Terminated\",\"startTime\":\"2020-10-22T18:53:39Z\",\"exitCode\":111,\"finishTime\":\"2020-10-22T18:54:02Z\",\"detailStatus\":\"Error\"},\r\n\"events\":[\r\n{\"count\":3,\"firstTimestamp\":\"2020-10-22T18:28:19Z\",\"lastTimestamp\":\"2020-10-22T18:40:40Z\",\"name\":\"Pulling\",\"message\":\"pulling image \\\\\\\"<IMAGE_NAME>\\\\\\\" \", \"type\":\"Normal\"},\r\n{\"count\":3,\"firstTimestamp\":\"2020-10-22T18:39:31Z\",\"lastTimestamp\":\"2020-10-22T18:40:41Z\",\"name\":\"Pulled\",\"message\":\"Successfully pulled image \\\\\\\"<IMAGE_NAME>\\\\\\\" \",\"type\":\"Normal\"},\r\n{\"count\":3,\"firstTimestamp\":\"2020-10-22T18:39:35Z\",\"lastTimestamp\":\"2020-10-22T18:40:41Z\",\"name\":\"Created\",\"message\":\"Created container\",\"type\":\"Normal\"},\r\n{\"count\":3,\"firstTimestamp\":\"2020-10-22T18:39:35Z\",\"lastTimestamp\":\"2020-10-22T18:40:41Z\",\"name\":\"Started\",\"message\":\"Started container\",\"type\":\"Normal\"},\r\n{\"count\":50,\"firstTimestamp\":\"2020-10-22T18:40:28Z\",\"lastTimestamp\":\"2020-10-22T18:53:23Z\",\"name\":\"BackOff\",\"message\":\"Back-off restarting failed container\",\"type\":\"Warning\"}]}\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\nI pulled up the logs from the Azure Container Instances Services and it is as follows:\r\n```\r\n2020-10-22T06:58:49,020260384+00:00 - iot-server/run \r\n2020-10-22T06:58:49,019574380+00:00 - rsyslog/run \r\n2020-10-22T06:58:49,117097008+00:00 - gunicorn/run \r\n2020-10-22T06:58:49,118285816+00:00 - nginx/run \r\nEdgeHubConnectionString and IOTEDGE_IOTHUBHOSTNAME are not set. Exiting...\r\n2020-10-22T06:58:51,222442674+00:00 - iot-server/finish 1 0\r\n2020-10-22T06:58:51,322087216+00:00 - Exit code 1 is normal. Not restarting iot-server.\r\nStarting gunicorn 19.6.0\r\nListening at: http://127.0.0.1:31311 (12)\r\nUsing worker: sync\r\nworker timeout is set to 300\r\nBooting worker with pid: 41\r\nException in worker process\r\nTraceback (most recent call last):\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/arbiter.py\", line 557, in spawn_worker\r\n    worker.init_process()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/workers/base.py\", line 126, in init_process\r\n    self.load_wsgi()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/workers/base.py\", line 136, in load_wsgi\r\n    self.wsgi = self.app.wsgi()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/app/base.py\", line 67, in wsgi\r\n    self.callable = self.load()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/app/wsgiapp.py\", line 65, in load\r\n    return self.load_wsgiapp()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/app/wsgiapp.py\", line 52, in load_wsgiapp\r\n    return util.import_app(self.app_uri)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/gunicorn/util.py\", line 357, in import_app\r\n    __import__(module)\r\n  File \"/var/azureml-server/wsgi.py\", line 1, in <module>\r\n    import create_app\r\n  File \"/var/azureml-server/create_app.py\", line 3, in <module>\r\n    from app import main\r\n  File \"/var/azureml-server/app.py\", line 31, in <module>\r\n    import main as user_main\r\n  File \"/var/azureml-app/main.py\", line 12, in <module>\r\n    driver_module_spec.loader.exec_module(driver_module)\r\n  File \"/var/azureml-app/execution_script.py\", line 2, in <module>\r\n    import pandas as pd\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pandas/__init__.py\", line 22, in <module>\r\n    from pandas.compat.numpy import (\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pandas/compat/numpy/__init__.py\", line 21, in <module>\r\n    \"this version of pandas is incompatible with numpy < 1.15.4\\n\"\r\nImportError: this version of pandas is incompatible with numpy < 1.15.4\r\nyour numpy version is 1.14.2.\r\nPlease upgrade numpy to >= 1.15.4 to use this pandas version\r\nWorker exiting (pid: 41)\r\nShutting down: Master\r\nReason: Worker failed to boot.\r\n2020-10-22T06:59:16,624645953+00:00 - gunicorn/finish 3 0\r\n2020-10-22T06:59:16,717989455+00:00 - Exit code 3 is not normal. Killing image.\r\n```\r\n\r\nI checked and my development venv (Py3.7.9) has the numpy version - 1.19.2 and even the base python (3.6.6) has 1.18.2\r\n\r\nInitially the error was that the numpy version is 1.14.2. To mitigate that I explicitly passed ```numpy==1.16.1``` as a dependency and as a result the error now asks me to uninstall the previous versions of numpy. \r\n\r\n**DOUBT 01 of 02 : How do I uninstall this previous version? Is that even possible.**\r\n\r\nWhile investigating it, I went back to the logs generated by MLflow while building the image and I noticed that it is installing a number of additional packages while building the base image (including Numpy version 1.14.2) that is subsequently overwritten using packages from my mlflow_env.yml file.\r\n\r\nA snippet of logs while building the image is as follows:\r\n\r\n```\r\nStep 36/38 : RUN CONDA_ROOT_DIR=$(conda info --root) && if [ -n \"$AZUREML_CONDA_ENVIRONMENT_PATH\" ]; then conda env update -p \"$AZUREML_CONDA_ENVIRONMENT_PATH\" -f '/var/azureml-app/mlflow_env.yml'; else conda env update -n base -f '/var/azureml-app/mlflow_env.yml'; fi && conda clean -aqy && rm -rf /root/.cache/pip && rm -rf \"$CONDA_ROOT_DIR/pkgs\" && find \"$CONDA_ROOT_DIR\" -type d -name __pycache__ -exec rm -rf {} +\r\n ---> Running in fe3b3c665339\r\nWarning: you have pip-installed dependencies in your environment file, but you do not list pip itself as one of your conda dependencies.  Conda may not use the correct pip to install your packages, and they may end up in the wrong place.  Please add an explicit pip dependency.  I'm adding one for you, but still nagging you.\r\nCollecting package metadata: ...working... \r\ndone\r\nSolving environment: ...working... \r\ndone\r\n\r\nDownloading and Extracting Packages\r\n\r\n<Random packages being installed>\r\n<Random packages being installed>\r\n<Random packages being installed>\r\nnumpy-1.14.2         | 4.0 MB    |            |   0% \r\nnumpy-1.14.2         | 4.0 MB    | #######6   |  76% \r\nnumpy-1.14.2         | 4.0 MB    | #########  |  91% \r\nnumpy-1.14.2         | 4.0 MB    | ########## | 100% \r\n\r\nPreparing transaction: ...working... done\r\nVerifying transaction: ...working... done\r\nExecuting transaction: ...working... \r\ndone\r\nRan pip subprocess with arguments:\r\n['/opt/miniconda/bin/python', '-m', 'pip', 'install', '-U', '-r', '/var/azureml-app/condaenv.kscafao_.requirements.txt']\r\nPip subprocess output:\r\nCollecting torch==1.3.0\r\n  Downloading torch-1.3.0-cp36-cp36m-manylinux1_x86_64.whl (773.1 MB)\r\nCollecting numpy==1.16.1\r\n  Downloading numpy-1.16.1-cp36-cp36m-manylinux1_x86_64.whl (17.3 MB)\r\nInstalling collected packages: numpy, torch,\r\n  Attempting uninstall: numpy\r\n    Found existing installation: numpy 1.19.2\r\n    Uninstalling numpy-1.19.2:\r\n      Successfully uninstalled numpy-1.19.2\r\n  Attempting uninstall: torch\r\n    Found existing installation: torch 0.4.1\r\n    Uninstalling torch-0.4.1:\r\n      Successfully uninstalled torch-0.4.1\r\nSuccessfully installed numpy-1.16.1  torch-1.3.0 \r\n```\r\n\r\n**Doubt 02 of 02: As you can see, my system has a different numpy (1.19) and in my yml file I'm asking for numpy (1.16) to be installed, then where is this numpy (1.14.2) coming from?**\r\n\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [X] `area/build`: Build and test infrastructure for MLflow\r\n\r\nInterface \r\n- [X] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n\r\n\r\nIntegrations\r\n- [X] `integrations/azure`: Azure and Azure ML integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3587/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3587/timeline","performed_via_github_app":null,"state_reason":"completed"}