{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5525","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5525/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5525/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5525/events","html_url":"https://github.com/mlflow/mlflow/issues/5525","id":1178672172,"node_id":"I_kwDOCB5Jx85GQRws","number":5525,"title":"[BUG] Inconsistency in serving between json and csv data","user":{"login":"vvijay-bolt","id":96092891,"node_id":"U_kgDOBbpC2w","avatar_url":"https://avatars.githubusercontent.com/u/96092891?v=4","gravatar_id":"","url":"https://api.github.com/users/vvijay-bolt","html_url":"https://github.com/vvijay-bolt","followers_url":"https://api.github.com/users/vvijay-bolt/followers","following_url":"https://api.github.com/users/vvijay-bolt/following{/other_user}","gists_url":"https://api.github.com/users/vvijay-bolt/gists{/gist_id}","starred_url":"https://api.github.com/users/vvijay-bolt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vvijay-bolt/subscriptions","organizations_url":"https://api.github.com/users/vvijay-bolt/orgs","repos_url":"https://api.github.com/users/vvijay-bolt/repos","events_url":"https://api.github.com/users/vvijay-bolt/events{/privacy}","received_events_url":"https://api.github.com/users/vvijay-bolt/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"tomasatdatabricks","id":33237569,"node_id":"MDQ6VXNlcjMzMjM3NTY5","avatar_url":"https://avatars.githubusercontent.com/u/33237569?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasatdatabricks","html_url":"https://github.com/tomasatdatabricks","followers_url":"https://api.github.com/users/tomasatdatabricks/followers","following_url":"https://api.github.com/users/tomasatdatabricks/following{/other_user}","gists_url":"https://api.github.com/users/tomasatdatabricks/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasatdatabricks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasatdatabricks/subscriptions","organizations_url":"https://api.github.com/users/tomasatdatabricks/orgs","repos_url":"https://api.github.com/users/tomasatdatabricks/repos","events_url":"https://api.github.com/users/tomasatdatabricks/events{/privacy}","received_events_url":"https://api.github.com/users/tomasatdatabricks/received_events","type":"User","site_admin":false},"assignees":[{"login":"tomasatdatabricks","id":33237569,"node_id":"MDQ6VXNlcjMzMjM3NTY5","avatar_url":"https://avatars.githubusercontent.com/u/33237569?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasatdatabricks","html_url":"https://github.com/tomasatdatabricks","followers_url":"https://api.github.com/users/tomasatdatabricks/followers","following_url":"https://api.github.com/users/tomasatdatabricks/following{/other_user}","gists_url":"https://api.github.com/users/tomasatdatabricks/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasatdatabricks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasatdatabricks/subscriptions","organizations_url":"https://api.github.com/users/tomasatdatabricks/orgs","repos_url":"https://api.github.com/users/tomasatdatabricks/repos","events_url":"https://api.github.com/users/tomasatdatabricks/events{/privacy}","received_events_url":"https://api.github.com/users/tomasatdatabricks/received_events","type":"User","site_admin":false},{"login":"arjundc-db","id":61438563,"node_id":"MDQ6VXNlcjYxNDM4NTYz","avatar_url":"https://avatars.githubusercontent.com/u/61438563?v=4","gravatar_id":"","url":"https://api.github.com/users/arjundc-db","html_url":"https://github.com/arjundc-db","followers_url":"https://api.github.com/users/arjundc-db/followers","following_url":"https://api.github.com/users/arjundc-db/following{/other_user}","gists_url":"https://api.github.com/users/arjundc-db/gists{/gist_id}","starred_url":"https://api.github.com/users/arjundc-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arjundc-db/subscriptions","organizations_url":"https://api.github.com/users/arjundc-db/orgs","repos_url":"https://api.github.com/users/arjundc-db/repos","events_url":"https://api.github.com/users/arjundc-db/events{/privacy}","received_events_url":"https://api.github.com/users/arjundc-db/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-03-23T21:12:41Z","updated_at":"2022-04-15T21:23:59Z","closed_at":"2022-04-15T21:23:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The parse csv input function [here](https://github.com/mlflow/mlflow/blob/master/mlflow/pyfunc/scoring_server/__init__.py) is used to decode requests during model serving. Unlike the json function in the same file, it does not use the model schema to inform the choice of datatypes. This causes errors when the dataframe is later compared against the schema [here](https://github.com/mlflow/mlflow/blob/41deb9ee5705d2727dc3df7fe60ce2c09231c8cc/mlflow/pyfunc/__init__.py)\r\n\r\nIn particular, when the input schema contains an int32 column, serving will work with json but not with csv.\r\n\r\n### Willingness to contribute\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community. (Need guidance on testing)\r\n\r\n### Describe the problem\r\nProblem: serving with csv fails when an input column has type int32. In contrast, serving with json works.\r\n\r\n### Code to reproduce issue\r\n\r\nTrain and serve the modified logistic regression example below.\r\nSave the following in test_csv.csv:\r\nx\r\n1\r\n-1\r\n\r\nThen try:\r\ncurl -d '{\"columns\":[\"x\"],\"index\":[0,1],\"data\":[[1],[-1]]}' -H 'Content-Type: application/json'  localhost:5000/invocations\r\ncurl --data-binary '@test_csv.csv' -H 'Content-Type: text/csv'  localhost:5000/invocations\r\n\r\nThe json request returns [1, 0].\r\nThe csv request will produce: {\"error_code\": \"BAD_REQUEST\", \"message\": \"Incompatible input types for column x. Can not safely convert int64 to int32.\"}\r\n\r\nThe json command\r\n\r\nModified logistic regression example:\r\n\r\n```\r\nimport numpy as np\r\nimport pandas as pd\r\nfrom sklearn.linear_model import LogisticRegression\r\nfrom mlflow.models.signature import infer_signature\r\n\r\nimport mlflow\r\nimport mlflow.sklearn\r\n\r\nif __name__ == \"__main__\":\r\n    X = pd.DataFrame({'x': [-2, -1, 0, 1, 2, 1]}, dtype='int32')\r\n    y = np.array([0, 0, 1, 1, 1, 0])\r\n    lr = LogisticRegression()\r\n    lr.fit(X, y)\r\n    score = lr.score(X, y)\r\n    print(\"Score: %s\" % score)\r\n\r\n    class Model(mlflow.pyfunc.PythonModel):\r\n        def __init__(self, m):\r\n            self.m = m\r\n\r\n        def predict(self, context, x):\r\n            return self.m.predict(x)\r\n\r\n    model = Model(lr)\r\n    signature = infer_signature(X, model.predict(None, X))\r\n    print('Signature')\r\n    print(signature)\r\n    mlflow.pyfunc.log_model('model', python_model=model, signature=signature)\r\n    print(\"Model saved in run %s\" % mlflow.active_run().info.run_uuid)\r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging","closed_by":{"login":"arjundc-db","id":61438563,"node_id":"MDQ6VXNlcjYxNDM4NTYz","avatar_url":"https://avatars.githubusercontent.com/u/61438563?v=4","gravatar_id":"","url":"https://api.github.com/users/arjundc-db","html_url":"https://github.com/arjundc-db","followers_url":"https://api.github.com/users/arjundc-db/followers","following_url":"https://api.github.com/users/arjundc-db/following{/other_user}","gists_url":"https://api.github.com/users/arjundc-db/gists{/gist_id}","starred_url":"https://api.github.com/users/arjundc-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arjundc-db/subscriptions","organizations_url":"https://api.github.com/users/arjundc-db/orgs","repos_url":"https://api.github.com/users/arjundc-db/repos","events_url":"https://api.github.com/users/arjundc-db/events{/privacy}","received_events_url":"https://api.github.com/users/arjundc-db/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5525/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5525/timeline","performed_via_github_app":null,"state_reason":"completed"}