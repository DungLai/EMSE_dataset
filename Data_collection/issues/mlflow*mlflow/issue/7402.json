{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7402","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7402/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7402/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7402/events","html_url":"https://github.com/mlflow/mlflow/issues/7402","id":1464141400,"node_id":"I_kwDOCB5Jx85XRQZY","number":7402,"title":"[BUG][Warning][MlflowException] Changing param values is not allowed.","user":{"login":"tsungjung411","id":14820019,"node_id":"MDQ6VXNlcjE0ODIwMDE5","avatar_url":"https://avatars.githubusercontent.com/u/14820019?v=4","gravatar_id":"","url":"https://api.github.com/users/tsungjung411","html_url":"https://github.com/tsungjung411","followers_url":"https://api.github.com/users/tsungjung411/followers","following_url":"https://api.github.com/users/tsungjung411/following{/other_user}","gists_url":"https://api.github.com/users/tsungjung411/gists{/gist_id}","starred_url":"https://api.github.com/users/tsungjung411/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsungjung411/subscriptions","organizations_url":"https://api.github.com/users/tsungjung411/orgs","repos_url":"https://api.github.com/users/tsungjung411/repos","events_url":"https://api.github.com/users/tsungjung411/events{/privacy}","received_events_url":"https://api.github.com/users/tsungjung411/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":4300304016,"node_id":"LA_kwDOCB5Jx88AAAABAFFukA","url":"https://api.github.com/repos/mlflow/mlflow/labels/has-closing-pr","name":"has-closing-pr","color":"fef2c0","default":false,"description":"This issue has a closing PR"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2022-11-25T07:29:04Z","updated_at":"2022-12-06T09:32:23Z","closed_at":"2022-12-06T05:23:43Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\r\n\r\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\n\r\n### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n- mlflow: 1.29.0\r\n- Client: (how to query it?)\r\n- Tracking server: (how to query it?)\r\n\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.04\r\n- **Python version**: 3.8.10\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\n#### Scenario \r\nLightGBM + Scikit-learn's pipeline (for data preprocessing)\r\n```python\r\nclf = LGBMClassifier()\r\nclf = make_pipeline(clf)\r\nclf.fit(train_X, train_y)\r\n```\r\nbut there is an unexpected exception that a parameter with key='verbose' is already logged. (100% reproducible) (see the exception below)\r\n\r\n<br>\r\n\r\n#### MlflowException\r\n- #### if the sklearn's pipeline precedes LGBMClassifier (reproducible: 29/30 )\r\n  > 2022/11/25 11:45:17 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during lightgbm autologging: The following failures occurred while performing one or more logging operations:  [MlflowException('Failed to perform one or more operations on the run with ID 68e5d682e86d4afaa34cb71f728a759d. Failed operations: [MlflowException(\"Changing param values is not allowed. **Param with key=\\'verbose\\' was already logged with value=\\'False\\' for run ID=\\'68e5d682e86d4afaa34cb71f728a759d\\'. Attempted logging new value \\'-1\\'.**\")]')]\r\nPipeline(steps=[('lgbmclassifier', LGBMClassifier())])\r\n\r\n- #### if LGBMClassifier precedes the sklearn's pipeline (reproducible: 1/30 )\r\n  > 2022/11/25 15:58:31 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during sklearn autologging: The following failures occurred while performing one or more logging operations: [MlflowException('Failed to perform one or more operations on the run with ID f642171dc7fe4c9ab470f4e2fd323fc9. Failed operations: [MlflowException(\"Changing param values is not allowed. **Param with key=\\'verbose\\' was already logged with value=\\'-1\\' for run ID=\\'f642171dc7fe4c9ab470f4e2fd323fc9\\'. Attempted logging new value \\'False\\'.**\")]')]\r\nPipeline(steps=[('lgbmclassifier', LGBMClassifier())])\r\n  ![image](https://user-images.githubusercontent.com/14820019/203935542-0e788933-90bf-402f-9c94-050f970ace1b.png)\r\n\r\n\r\n\r\n<br>\r\n\r\n### Root Cause\r\n- The sklearn's pipeline precedes LGBMClassifier.\r\n   - The sklearn's pipeline gets parameters from the LGBMClassifier object, where `verbose` is `False`\r\n      - I guess: `-1` should be the value used internally, `False` should be the value used externally\r\n      - i.e. LGBMClassifier has a value of `-1` inside and `False` outside\r\n- Sometimes LGBMClassifier precedes the sklearn's pipeline.\r\n   -  that is, there are `log_params` competitions between mlflow.sklearn and mlflow.lightgbm\r\n- There is a `fit` API in the sklearn's pipeline, so `verbose: False` is logged first.\r\n- There is a `fit` API in the LGBMClassifier object, so `verbose: -1` is logged later.\r\n- This is why the the param with key=`verbose` are logged twice.\r\n\r\n### Tracking information\r\n\r\nMLflow version: 1.29.0\r\nTracking URI: file:///mlruns\r\nArtifact URI: file:///mlruns/0/ad371fb0485c4c4cb7bb7b281bf10053/artifacts\r\n\r\n\r\n### Code to reproduce issue\r\n\r\n#### Required Packages\r\n```bash\r\n# mlflow(mlflow.utils.git_utils) requires git SHA\r\napt-get update\r\napt-get install -y git\r\n\r\n# mlflow compatibility: \"mlflow==1.29.0\", \"lightgbm==3.3.2\", \"scikit-learn==1.1.2\"\r\n# matplotlib: for mlflow tasks, lightgbm requires to log feature importance plot\r\npip install \"lightgbm==3.3.2\" \"scikit-learn==1.1.2\" matplotlib\r\npip install \"mlflow==1.29.0\" \"requests>=2.26.0\" \"urllib3>=1.26.0\"\r\n```\r\n\r\n<br>\r\n\r\n#### Print more logs for mllfow\r\n```\r\nmlflow/utils/autologging_utils/client.py:176:\r\n    def log_params(self, run_id: Union[str, PendingRunId], params: Dict[str, Any]) -> None:\r\n```\r\nadd the code below to `mlflow/utils/autologging_utils/client.py#177`\r\n```\r\nprint('[DEBUG] run_id:', run_id, ', params:', params)\r\n```\r\n![image](https://user-images.githubusercontent.com/14820019/203896999-6cef3ac4-b71a-4a6d-a36f-98e9d0aef484.png)\r\n\r\n<br>\r\n\r\n#### Python Code\r\n```python\r\n# import packages\r\nfrom sklearn.datasets import load_iris\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.pipeline import make_pipeline\r\nfrom lightgbm import LGBMClassifier\r\n\r\nimport mlflow\r\nimport os\r\n\r\n# load dataset\r\niris = load_iris()\r\ntrain_X, test_X, train_y, test_y = train_test_split(iris.data, iris.target, stratify=iris.target)\r\n\r\n# start to train\r\nmlflow.autolog()\r\nclf = LGBMClassifier()\r\nclf = make_pipeline(clf)\r\nclf.fit(train_X, train_y)\r\nmlflow.end_run()\r\n```\r\n\r\n\r\n### Stack trace\r\n\r\n2022/11/25 11:45:17 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.\r\n\r\n2022/11/25 11:45:17 INFO mlflow.tracking.fluent: Autologging successfully enabled for lightgbm.\r\n\r\n2022/11/25 11:45:17 INFO mlflow.utils.autologging_utils: Created MLflow autologging run with ID '68e5d682e86d4afaa34cb71f728a759d', which will track hyperparameters, performance metrics, model artifacts, and lineage information for the current sklearn workflow\r\n\r\n[DEBUG] run_id: 68e5d682e86d4afaa34cb71f728a759d , params: {'memory': None, 'steps': [('lgbmclassifier', LGBMClassifier())], 'verbose': False, 'lgbmclassifier': LGBMClassifier(), 'lgbmclassifier__boosting_type': 'gbdt', 'lgbmclassifier__class_weight': None, 'lgbmclassifier__colsample_bytree': 1.0, 'lgbmclassifier__importance_type': 'split', 'lgbmclassifier__learning_rate': 0.1, 'lgbmclassifier__max_depth': -1, 'lgbmclassifier__min_child_samples': 20, 'lgbmclassifier__min_child_weight': 0.001, 'lgbmclassifier__min_split_gain': 0.0, 'lgbmclassifier__n_estimators': 100, 'lgbmclassifier__n_jobs': -1, 'lgbmclassifier__num_leaves': 31, 'lgbmclassifier__objective': None, 'lgbmclassifier__random_state': None, 'lgbmclassifier__reg_alpha': 0.0, 'lgbmclassifier__reg_lambda': 0.0, 'lgbmclassifier__silent': 'warn', 'lgbmclassifier__subsample': 1.0, 'lgbmclassifier__subsample_for_bin': 200000, 'lgbmclassifier__subsample_freq': 0}\r\n\r\n[DEBUG] run_id: 68e5d682e86d4afaa34cb71f728a759d , params: {'boosting_type': 'gbdt', 'colsample_bytree': 1.0, 'learning_rate': 0.1, 'max_depth': -1, 'min_child_samples': 20, 'min_child_weight': 0.001, 'min_split_gain': 0.0, 'n_jobs': -1, 'num_leaves': 31, 'random_state': None, 'reg_alpha': 0.0, 'reg_lambda': 0.0, 'subsample': 1.0, 'subsample_for_bin': 200000, 'subsample_freq': 0, 'verbose': -1, 'num_class': 3, 'objective': 'multiclass', 'metric': ['multiclass']}\r\n\r\n[DEBUG] run_id: 68e5d682e86d4afaa34cb71f728a759d , params: {'num_boost_round': 100, 'feature_name': 'auto', 'categorical_feature': 'auto', 'early_stopping_rounds': None, 'evals_result': None, 'verbose_eval': 'warn', 'keep_training_booster': False}\r\n\r\n2022/11/25 11:45:17 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during lightgbm autologging: The following failures occurred while performing one or more logging operations: [MlflowException('Failed to perform one or more operations on the run with ID 68e5d682e86d4afaa34cb71f728a759d. Failed operations: [MlflowException(\"Changing param values is not allowed. **Param with key=\\'verbose\\' was already logged with value=\\'False\\' for run ID=\\'68e5d682e86d4afaa34cb71f728a759d\\'. Attempted logging new value \\'-1\\'**.\")]')]\r\nPipeline(steps=[('lgbmclassifier', LGBMClassifier())])\r\n\r\n\r\n---\r\n\r\nif LGBMClassifier precedes the sklearn's pipeline, the last message will become:\r\n\r\n2022/11/25 15:58:31 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during sklearn autologging: The following failures occurred while performing one or more logging operations: [MlflowException('Failed to perform one or more operations on the run with ID f642171dc7fe4c9ab470f4e2fd323fc9. Failed operations: [MlflowException(\"Changing param values is not allowed. **Param with key=\\'verbose\\' was already logged with value=\\'-1\\' for run ID=\\'f642171dc7fe4c9ab470f4e2fd323fc9\\'. Attempted logging new value \\'False\\'**.\")]')]\r\nPipeline(steps=[('lgbmclassifier', LGBMClassifier())])\r\n\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"WeichenXu123","id":19235986,"node_id":"MDQ6VXNlcjE5MjM1OTg2","avatar_url":"https://avatars.githubusercontent.com/u/19235986?v=4","gravatar_id":"","url":"https://api.github.com/users/WeichenXu123","html_url":"https://github.com/WeichenXu123","followers_url":"https://api.github.com/users/WeichenXu123/followers","following_url":"https://api.github.com/users/WeichenXu123/following{/other_user}","gists_url":"https://api.github.com/users/WeichenXu123/gists{/gist_id}","starred_url":"https://api.github.com/users/WeichenXu123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WeichenXu123/subscriptions","organizations_url":"https://api.github.com/users/WeichenXu123/orgs","repos_url":"https://api.github.com/users/WeichenXu123/repos","events_url":"https://api.github.com/users/WeichenXu123/events{/privacy}","received_events_url":"https://api.github.com/users/WeichenXu123/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7402/timeline","performed_via_github_app":null,"state_reason":"completed"}