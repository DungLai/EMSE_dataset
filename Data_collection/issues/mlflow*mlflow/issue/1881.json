{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1881","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1881/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1881/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1881/events","html_url":"https://github.com/mlflow/mlflow/issues/1881","id":499494604,"node_id":"MDU6SXNzdWU0OTk0OTQ2MDQ=","number":1881,"title":"[BUG] Spark UDF cannot load models with empty directories","user":{"login":"dwyatte","id":2512762,"node_id":"MDQ6VXNlcjI1MTI3NjI=","avatar_url":"https://avatars.githubusercontent.com/u/2512762?v=4","gravatar_id":"","url":"https://api.github.com/users/dwyatte","html_url":"https://github.com/dwyatte","followers_url":"https://api.github.com/users/dwyatte/followers","following_url":"https://api.github.com/users/dwyatte/following{/other_user}","gists_url":"https://api.github.com/users/dwyatte/gists{/gist_id}","starred_url":"https://api.github.com/users/dwyatte/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwyatte/subscriptions","organizations_url":"https://api.github.com/users/dwyatte/orgs","repos_url":"https://api.github.com/users/dwyatte/repos","events_url":"https://api.github.com/users/dwyatte/events{/privacy}","received_events_url":"https://api.github.com/users/dwyatte/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-09-27T14:57:39Z","updated_at":"2019-12-18T22:48:03Z","closed_at":"2019-12-18T22:48:03Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux\r\n- **MLflow installed from (source or binary)**:  Binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.2.0\r\n- **Python version**: \r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nLoading a MLflow model with empty directories as a Spark UDF raises an IsADirectoryError. I encountered this for TensorFlow models without variables (which is the case for models with all variables converted to constants), but it looks like it will be triggered for any MLflow model with an empty directory (untested).\r\n\r\n```\r\nIsADirectoryError: [Errno 21] Is a directory: 'path/to/model/tfmodel/variables'\r\n\r\n/databricks/python/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py in spark_udf(spark, model_uri, result_type)\r\n    417     with TempDir() as local_tmpdir:\r\n    418         local_model_path = _download_artifact_from_uri(\r\n--> 419             artifact_uri=model_uri, output_path=local_tmpdir.path())\r\n    420         archive_path = SparkModelCache.add_local_model(spark, local_model_path)\r\n    421 \r\n\r\n/databricks/python/lib/python3.7/site-packages/mlflow/tracking/artifact_utils.py in _download_artifact_from_uri(artifact_uri, output_path)\r\n     64     root_uri = prefix + urllib.parse.urlunparse(parsed_uri)\r\n     65     return get_artifact_repository(artifact_uri=root_uri).download_artifacts(\r\n---> 66         artifact_path=artifact_path, dst_path=output_path)\r\n```\r\n\r\n### Code to reproduce issue\r\n```\r\nimport tensorflow as tf\r\nimport mlflow\r\nimport mlflow.tensorflow\r\nimport mlflow.pyfunc\r\n\r\ninputs = tf.placeholder(tf.float32, [None])\r\noutputs = inputs/2 + 2\r\nsignature = (\r\n    tf.saved_model.signature_def_utils.build_signature_def(\r\n        inputs={\"inputs\": tf.saved_model.utils.build_tensor_info(inputs)},\r\n        outputs={\"outputs\": tf.saved_model.utils.build_tensor_info(outputs)},\r\n        method_name=\"predict\"\r\n    )\r\n)\r\n\r\nwith tf.Session() as sess:\r\n    builder = tf.saved_model.builder.SavedModelBuilder(\"saved_model\")\r\n    builder.add_meta_graph_and_variables(\r\n        sess,\r\n        [tf.saved_model.tag_constants.SERVING],\r\n        signature_def_map={\"predict\": signature}\r\n    )\r\n    builder.save()\r\n\r\nmlflow.tensorflow.save_model(tf_saved_model_dir=\"saved_model\",\r\n                             tf_meta_graph_tags=[tf.saved_model.tag_constants.SERVING],\r\n                             tf_signature_def_key=\"predict\",\r\n                             path=\"model\")\r\n\r\nudf = mlflow.pyfunc.spark_udf(spark=spark, model_uri=\"model\")\r\n```\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks,\r\nplease include the full traceback. Large logs and files should be attached.\r\n","closed_by":{"login":"tomasatdatabricks","id":33237569,"node_id":"MDQ6VXNlcjMzMjM3NTY5","avatar_url":"https://avatars.githubusercontent.com/u/33237569?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasatdatabricks","html_url":"https://github.com/tomasatdatabricks","followers_url":"https://api.github.com/users/tomasatdatabricks/followers","following_url":"https://api.github.com/users/tomasatdatabricks/following{/other_user}","gists_url":"https://api.github.com/users/tomasatdatabricks/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasatdatabricks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasatdatabricks/subscriptions","organizations_url":"https://api.github.com/users/tomasatdatabricks/orgs","repos_url":"https://api.github.com/users/tomasatdatabricks/repos","events_url":"https://api.github.com/users/tomasatdatabricks/events{/privacy}","received_events_url":"https://api.github.com/users/tomasatdatabricks/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1881/timeline","performed_via_github_app":null,"state_reason":"completed"}