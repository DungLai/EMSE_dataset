{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3839","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3839/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3839/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3839/events","html_url":"https://github.com/mlflow/mlflow/issues/3839","id":766817589,"node_id":"MDU6SXNzdWU3NjY4MTc1ODk=","number":3839,"title":"[BUG] Unable to deploy to a SageMaker Endpoint","user":{"login":"vas610","id":64650227,"node_id":"MDQ6VXNlcjY0NjUwMjI3","avatar_url":"https://avatars.githubusercontent.com/u/64650227?v=4","gravatar_id":"","url":"https://api.github.com/users/vas610","html_url":"https://github.com/vas610","followers_url":"https://api.github.com/users/vas610/followers","following_url":"https://api.github.com/users/vas610/following{/other_user}","gists_url":"https://api.github.com/users/vas610/gists{/gist_id}","starred_url":"https://api.github.com/users/vas610/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vas610/subscriptions","organizations_url":"https://api.github.com/users/vas610/orgs","repos_url":"https://api.github.com/users/vas610/repos","events_url":"https://api.github.com/users/vas610/events{/privacy}","received_events_url":"https://api.github.com/users/vas610/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022860064,"node_id":"MDU6TGFiZWwyMDIyODYwMDY0","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/sagemaker","name":"integrations/sagemaker","color":"ffbce5","default":false,"description":"Sagemaker integrations"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-12-14T18:49:43Z","updated_at":"2021-02-11T19:13:51Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu\r\n- **MLflow installed from (source or binary)**: pip\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.12.1\r\n- **Python version**: Python 3.6.11\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n    ```python\r\n      # Below commands were run on a SageMaker Notebook instance\r\n      import sagemaker\r\n      import mlflow\r\n      from mlflow import sagemaker as mfs   \r\n   \r\n      role = sagemaker.get_execution_role()\r\n\r\n      mfs.deploy(app_name='test-model',\r\n                        model_uri=\"s3://sagemaker-mlflow-test/mlruns/aeab55a0f9c94acc8123d499a758a95E/artifacts/model\",\r\n                        execution_role_arn=role,\r\n                        # execution_role_arn='arn:aws:iam::830861123456:role/service-role/AmazonSageMaker-ExecutionRole-20201213T185603'\r\n                        image_url='830861123456.dkr.ecr.us-east-1.amazonaws.com/mlflow-pyfunc',\r\n                        region_name='us-east-1',\r\n                        mode=mlflow.sagemaker.DEPLOYMENT_MODE_CREATE,\r\n                        instance_type='ml.t2.medium',\r\n                        instance_count=1)\r\n     ```\r\n\r\n I also updated my SageMaker execution role's policy\r\n\r\n  ```json\r\n \r\n         {\r\n            \"Sid\": \"VisualEditor2\",\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"s3:DeleteObjectTagging\",\r\n                \"s3:DeleteStorageLensConfigurationTagging\",\r\n                \"s3:ReplicateTags\",\r\n                \"s3:PutStorageLensConfigurationTagging\",\r\n                \"s3:PutObjectVersionTagging\",\r\n                \"s3:PutJobTagging\",\r\n                \"s3:DeleteObjectVersionTagging\",\r\n                \"s3:PutObject\",\r\n                \"s3:GetObject\",\r\n                \"s3:DeleteJobTagging\",\r\n                \"s3:PutBucketTagging\",\r\n                \"s3:PutObjectTagging\",\r\n                \"s3:DeleteObject\"\r\n            ],\r\n            \"Resource\": \"arn:aws:s3:::arn:aws:s3:::mlflow-sagemaker-us-east-1-830861123456/*\"\r\n         }\r\n\r\n  ```\r\n \r\n### Describe the problem\r\nUnable to deploy to a SageMaker Endpoint. I keep getting the `PutObjectTagging operation: Access Denied` exception\r\n\r\n### Code to reproduce issue\r\nAdded above\r\n\r\n### Other info / logs\r\n```python\r\n2020/12/14 18:37:55 INFO mlflow.sagemaker: Using the python_function flavor for deployment!\r\n2020/12/14 18:37:55 INFO mlflow.sagemaker: No model data bucket specified, using the default bucket\r\n2020/12/14 18:37:57 INFO mlflow.sagemaker: Default bucket `mlflow-sagemaker-us-east-1-830861123456` already exists. Skipping creation.\r\n---------------------------------------------------------------------------\r\nClientError                               Traceback (most recent call last)\r\n<ipython-input-73-3619a973e6f4> in <module>\r\n     15                         mode=mlflow.sagemaker.DEPLOYMENT_MODE_CREATE,\r\n     16                         instance_type='ml.t2.medium',\r\n---> 17                         instance_count=1)\r\n     18 \r\n\r\n~/anaconda3/envs/python3/lib/python3.6/site-packages/mlflow/sagemaker/__init__.py in deploy(app_name, model_uri, execution_role_arn, bucket, image_url, region_name, mode, archive, instance_type, instance_count, vpc_config, flavor, synchronous, timeout_seconds)\r\n    353         prefix=model_name,\r\n    354         region_name=region_name,\r\n--> 355         s3_client=s3_client,\r\n    356     )\r\n    357 \r\n\r\n~/anaconda3/envs/python3/lib/python3.6/site-packages/mlflow/sagemaker/__init__.py in _upload_s3(local_model_path, bucket, prefix, region_name, s3_client)\r\n    660             obj.upload_fileobj(fobj)\r\n    661             response = s3_client.put_object_tagging(\r\n--> 662                 Bucket=bucket, Key=key, Tagging={\"TagSet\": [{\"Key\": \"SageMaker\", \"Value\": \"true\"}]}\r\n    663             )\r\n    664             _logger.info(\"tag response: %s\", response)\r\n\r\n~/anaconda3/envs/python3/lib/python3.6/site-packages/botocore/client.py in _api_call(self, *args, **kwargs)\r\n    355                     \"%s() only accepts keyword arguments.\" % py_operation_name)\r\n    356             # The \"self\" in this scope is referring to the BaseClient.\r\n--> 357             return self._make_api_call(operation_name, kwargs)\r\n    358 \r\n    359         _api_call.__name__ = str(py_operation_name)\r\n\r\n~/anaconda3/envs/python3/lib/python3.6/site-packages/botocore/client.py in _make_api_call(self, operation_name, api_params)\r\n    674             error_code = parsed_response.get(\"Error\", {}).get(\"Code\")\r\n    675             error_class = self.exceptions.from_code(error_code)\r\n--> 676             raise error_class(parsed_response, operation_name)\r\n    677         else:\r\n    678             return parsed_response\r\n\r\nClientError: An error occurred (AccessDenied) when calling the PutObjectTagging operation: Access Denied\r\n\r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [x] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3839/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3839/timeline","performed_via_github_app":null,"state_reason":null}