{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4345","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4345/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4345/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4345/events","html_url":"https://github.com/mlflow/mlflow/issues/4345","id":888201552,"node_id":"MDU6SXNzdWU4ODgyMDE1NTI=","number":4345,"title":"[BUG] log_artifact() not working on remote server: AttributeError: 'NoneType' object has no attribute 'time'","user":{"login":"TimoSommer","id":67800320,"node_id":"MDQ6VXNlcjY3ODAwMzIw","avatar_url":"https://avatars.githubusercontent.com/u/67800320?v=4","gravatar_id":"","url":"https://api.github.com/users/TimoSommer","html_url":"https://github.com/TimoSommer","followers_url":"https://api.github.com/users/TimoSommer/followers","following_url":"https://api.github.com/users/TimoSommer/following{/other_user}","gists_url":"https://api.github.com/users/TimoSommer/gists{/gist_id}","starred_url":"https://api.github.com/users/TimoSommer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimoSommer/subscriptions","organizations_url":"https://api.github.com/users/TimoSommer/orgs","repos_url":"https://api.github.com/users/TimoSommer/repos","events_url":"https://api.github.com/users/TimoSommer/events{/privacy}","received_events_url":"https://api.github.com/users/TimoSommer/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-05-11T18:48:42Z","updated_at":"2021-05-12T08:38:43Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [x] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Red Hat Enterprise Linux release 8.2 (Ootpa) (Remote Server)\r\n- **MLflow installed from (source or binary)**: Binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.16.0\r\n- **Python version**: 3.8.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n\r\n### Describe the problem\r\nMlflow gives a strange error if I log a numpy array as artifact while running autolog() on a remote server. On my local machine there  is no error. This behaviour seems to be connected to not having enough time for the logging because either waiting a few seconds or logging a smaller array doesn't reproduce the issue for the minimal working example. However, in my real script where I logged several arrays I noticed that even waiting 2 min was not enough and I could not make it work there. The exception arises the moment the script is closed.\r\nNote that this is a different issue than #4327. \r\nIt seems to be a paramiko issue (https://stackoverflow.com/questions/60037299/attributeerror-nonetype-object-has-no-attribute-time-paramiko) but I was wondering if there is anything one can do from the mlflow point of view and it is weird that it only happens on the remote server. Btw my paramiko version is 2.7.2.\r\n\r\n### Code to reproduce issue\r\n```python\r\nimport mlflow\r\nimport numpy as np\r\nimport tempfile\r\nimport time\r\nimport os\r\n\r\n# Define functions for connecting to mlflow server.\r\ndef load_env(env_path: str):\r\n    \"\"\"Loads an .env file in your home directory.\r\n    To access the mlflow api, you need log in credentials. These can be stored in a local environment file which you\r\n    should protect with `chmod 600 .env`.\r\n    In this .env file you should define:\r\n    MLFLOW_TRACKING_USERNAME=your_username\r\n    MLFLOW_TRACKING_PASSWORD=your_password\r\n    MLFLOW_TRACKING_URI=***\r\n\r\n  Returns:\r\n      env: (dict) A dictionary containing the defined key value pairs.\r\n  \"\"\"\r\n  home = os.path.expanduser(\"~\")\r\n  with open(env_path, 'r') as f:\r\n      env = dict()\r\n      for line in f.readlines():\r\n          key, value = line.split('=')\r\n          env[key] = value.split('\\n')[0]\r\n      return env\r\n\r\ndef export_env(env_path: str):\r\n    \"\"\"Loads your .env file and exports the three variables important for mlflow.\r\n    MLFLOW_TRACKING_USERNAME, MLFLOW_TRACKING_PASSWORD, MLFLOW_TRACKING_URI\r\n    \"\"\"\r\n    env = load_env(env_path)\r\n    for key in [\"MLFLOW_TRACKING_USERNAME\", \"MLFLOW_TRACKING_PASSWORD\", \"MLFLOW_TRACKING_URI\"]:\r\n        os.environ[key] = env[key]\r\n\r\ndef log_array(a, name: str):\r\n    \"\"\"Logs an array as artifact to the currently active run.\r\n    Args:\r\n        a: (anything convertible to np.array) Array to store as artifact.\r\n        name: (str) Name to give the folder and file under th current mlflow run.\r\n    \"\"\"\r\n    a = np.array(a)\r\n    tmpdir = tempfile.mkdtemp()\r\n    save_path = os.path.join(tmpdir, name+\".npy\")\r\n    np.save(save_path, a)\r\n    mlflow.log_artifact(save_path, 'meta_data')\r\n    return\r\n\r\n# Export environment variables for the ssh connection of MLflow.\r\nenv_path = os.path.join(os.path.expanduser('~'), '.env')\r\nexport_env(env_path)\r\n\r\n# This is the important part.\r\nmlflow.autolog()\r\na = np.ones(1000)    # 10 is not enough to break it here\r\nlog_array(a, 'a')\r\n# time.sleep(15)        # workaround fixes exception\r\n```\r\n\r\n### Other info / logs\r\nTraceback: \r\n```\r\nException ignored in: <function Connection.__del__ at 0x14cbda767f70>\r\nTraceback (most recent call last):\r\n  File \"/home/kit/stud/uoeci/conda/envs/Masterarbeit/lib/python3.8/site-packages/pysftp/__init__.py\", line 1013, in __del__\r\n  File \"/home/kit/stud/uoeci/conda/envs/Masterarbeit/lib/python3.8/site-packages/pysftp/__init__.py\", line 785, in close\r\n  File \"/home/kit/stud/uoeci/conda/envs/Masterarbeit/lib/python3.8/site-packages/paramiko/sftp_client.py\", line 195, in close\r\n  File \"/home/kit/stud/uoeci/conda/envs/Masterarbeit/lib/python3.8/site-packages/paramiko/channel.py\", line 671, in close\r\n  File \"/home/kit/stud/uoeci/conda/envs/Masterarbeit/lib/python3.8/site-packages/paramiko/transport.py\", line 1846, in _send_user_message\r\nAttributeError: 'NoneType' object has no attribute 'time'\r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4345/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4345/timeline","performed_via_github_app":null,"state_reason":null}