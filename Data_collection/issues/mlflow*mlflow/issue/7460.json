{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7460","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7460/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7460/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7460/events","html_url":"https://github.com/mlflow/mlflow/issues/7460","id":1478876540,"node_id":"I_kwDOCB5Jx85YJd18","number":7460,"title":"[BUG] Log_model required 'artifact_path' while 'default-artifact-root' of MLflow server was defined as an S3 storage","user":{"login":"ann-lab52","id":59548514,"node_id":"MDQ6VXNlcjU5NTQ4NTE0","avatar_url":"https://avatars.githubusercontent.com/u/59548514?v=4","gravatar_id":"","url":"https://api.github.com/users/ann-lab52","html_url":"https://github.com/ann-lab52","followers_url":"https://api.github.com/users/ann-lab52/followers","following_url":"https://api.github.com/users/ann-lab52/following{/other_user}","gists_url":"https://api.github.com/users/ann-lab52/gists{/gist_id}","starred_url":"https://api.github.com/users/ann-lab52/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ann-lab52/subscriptions","organizations_url":"https://api.github.com/users/ann-lab52/orgs","repos_url":"https://api.github.com/users/ann-lab52/repos","events_url":"https://api.github.com/users/ann-lab52/events{/privacy}","received_events_url":"https://api.github.com/users/ann-lab52/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-12-06T11:29:22Z","updated_at":"2022-12-16T00:28:07Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\r\n\r\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\n\r\n### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n- Client: 1.29.0\r\n- Tracking server: 1.29.0\r\n\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution**: Ubuntu 18.04.4 LTS\r\n- **Python version**: 3.0.7\r\n- **yarn version, if running the dev UI**: None\r\n\r\n\r\n### Describe the problem\r\n\r\nIn our case, MLFlow server and ML experiments was run on the  same machine. When the MLFlow server deploy, the `default-artifact-root`  was defined as an `MLFLOW_S3_ENDPOINT_URL`. This mean  MLflow client will use the value provided by `--default-artifact-root` as default `artifact_path` following the third warning at [officials docs](https://www.mlflow.org/docs/latest/tracking.html#id13). This lead to an unexpected problem that when the we try to use [mlflow.pytorch.log_model()](https://www.mlflow.org/docs/latest/python_api/mlflow.pytorch.html?highlight=log_model#mlflow.pytorch.log_model), it required `artifact_path` must be passed some value although `artifact_path` value was provided by MLFlow Server. So we if try to pass something into `artifact_path` then \r\n\r\n> boto3.exceptions.S3UploadFailedError: Failed to upload /tmp/tmpgwr6044u/model/python_env.yaml to /s3_url/value_of_artifact_path. An error occurred (SignatureDoesNotMatch) when calling the PutObject operation: The request signature we calculated does not match the signature you provided. Check your key and signing method.\r\n\r\n will be raised. \r\n\r\nThis problem made the our scientist who run ML experiments confused for a while and luckily it was solve by pass an **empty string** to `artifact_path`. However, I think there more efficient way to solve this problem, like remove required of `artifact_path`, accept the `None` value or add this special case as an warning to the document.\r\n\r\n### Tracking information\r\n\r\n**Example of CLI we used to run MLFlow server**\r\n` mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri   sqlite://backend_store --default-artifact-root s3:///bucket/path: --serve-artifacts`\r\n\r\n### Code to reproduce issue\r\n\r\n\r\n\r\n**Example of an ML experiments we did:**\r\n```\r\nmlflow.set_tracking_uri('http://0.0.0.0:9696')\r\nmlflow.set_experiment('S3_TEST')\r\nos.environ['MLFLOW_S3_ENDPOINT_URL'] = 'https://s3.endpoint/'\r\nos.environ['AWS_ACCESS_KEY_ID'] = 'key id'\r\nos.environ['AWS_SECRET_ACCESS_KEY'] = 'secret key'\r\nwith mlflow.start_run():\r\n            artifact_uri = mlflow.get_artifact_uri()\r\n            # https://s3.endpoint/\r\n\r\n            for epoch in run_experiment:\r\n                train_some_model()\r\n                mlflow.pytorch.log_model(self.model, artifact_path='required_some_value', registered_model_name=\"ModelName\")\r\n```\r\n                \r\n\r\n\r\n\r\n### Stack trace\r\n\r\n> File \"train_pipeline.py\", line 150, in <module>\r\n>     train_command()\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/click/core.py\", line 1128, in __call__\r\n>     return self.main(*args, **kwargs)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/click/core.py\", line 1053, in main\r\n>     rv = self.invoke(ctx)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/click/core.py\", line 1395, in invoke\r\n>     return ctx.invoke(self.callback, **ctx.params)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/click/core.py\", line 754, in invoke\r\n>     return __callback(*args, **kwargs)\r\n>   File \"train_pipeline.py\", line 146, in train_command\r\n>     train_obj.run(data_directory=data_dir, save_path=full_save_path)\r\n>   File \"train_pipeline.py\", line 86, in run\r\n>     mlflow.pytorch.log_model(self.model, artifact_path=artifact_uri, registered_model_name=\"OurModel\")\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/pytorch/__init__.py\", line 321, in log_model\r\n>     **kwargs,\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/models/model.py\", line 373, in log\r\n>     mlflow.tracking.fluent.log_artifacts(local_path, mlflow_model.artifact_path)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/tracking/fluent.py\", line 811, in log_artifacts\r\n>     MlflowClient().log_artifacts(run_id, local_dir, artifact_path)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/tracking/client.py\", line 1117, in log_artifacts\r\n>     self._tracking_client.log_artifacts(run_id, local_dir, artifact_path)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/tracking/_tracking_service/client.py\", line 431, in log_artifacts\r\n>     self._get_artifact_repo(run_id).log_artifacts(local_dir, artifact_path)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/store/artifact/s3_artifact_repo.py\", line 146, in log_artifacts\r\n>     key=posixpath.join(upload_path, f),\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/mlflow/store/artifact/s3_artifact_repo.py\", line 118, in _upload_file\r\n>     s3_client.upload_file(Filename=local_file, Bucket=bucket, Key=key, ExtraArgs=extra_args)\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/boto3/s3/inject.py\", line 148, in upload_file\r\n>     callback=Callback,\r\n>   File \"/apps/conda/envs/kube/lib/python3.7/site-packages/boto3/s3/transfer.py\", line 296, in upload_file\r\n>     filename, '/'.join([bucket, key]), e\r\n> boto3.exceptions.S3UploadFailedError: Failed to upload /tmp/tmpgwr6044u/model/python_env.yaml to bucket/1/825051e047fb4b779315e218f336ffcd/artifacts/s3://bucket/1/825051e047fb4b779315e218f336ffcd/artifacts/python_env.yaml: An error occurred (SignatureDoesNotMatch) when calling the PutObject operation: The request signature we calculated does not match the signature you provided. Check your key and signing method.\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7460/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7460/timeline","performed_via_github_app":null,"state_reason":null}