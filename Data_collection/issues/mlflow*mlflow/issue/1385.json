{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1385","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1385/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1385/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1385/events","html_url":"https://github.com/mlflow/mlflow/issues/1385","id":451623696,"node_id":"MDU6SXNzdWU0NTE2MjM2OTY=","number":1385,"title":"MLflow UI fails on 1.0 RC1 when backend store is MySQL 8.x","user":{"login":"ananthc","id":3952273,"node_id":"MDQ6VXNlcjM5NTIyNzM=","avatar_url":"https://avatars.githubusercontent.com/u/3952273?v=4","gravatar_id":"","url":"https://api.github.com/users/ananthc","html_url":"https://github.com/ananthc","followers_url":"https://api.github.com/users/ananthc/followers","following_url":"https://api.github.com/users/ananthc/following{/other_user}","gists_url":"https://api.github.com/users/ananthc/gists{/gist_id}","starred_url":"https://api.github.com/users/ananthc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ananthc/subscriptions","organizations_url":"https://api.github.com/users/ananthc/orgs","repos_url":"https://api.github.com/users/ananthc/repos","events_url":"https://api.github.com/users/ananthc/events{/privacy}","received_events_url":"https://api.github.com/users/ananthc/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-06-03T18:24:42Z","updated_at":"2019-06-03T20:56:05Z","closed_at":"2019-06-03T20:56:05Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac OS Mojave , MySQL 8.0.16\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.0 RC1 (https://mlflow-snapshots.s3-us-west-2.amazonaws.com/mlflow-1.0.0-1199.8386d25-py2.py3-none-any.whl)\r\n- **Python version**: 3.6\r\n- **npm version (if running the dev UI):N/A\r\n- **Exact command to reproduce**: Perform install per documentation and launch the UI as follows:\r\n- Install MySQL 8.0.16 (latest brew install fetches this version)\r\n- create database in mysql (ex: create database orion_tracker)\r\n- pip3 install mlflow per RC instructions given here https://docs.google.com/document/d/1Hu1y73aR21uDPbuUTBlTfSN7e5tR-9txqk_VHlCnupk/edit# \r\n- run using : mlflow server --backend-store-uri=$MLFLOW_TRACKING_URI --default-artifact-root=<some-artifact-location>\r\n- traverse to the MLflow UI\r\n- UI shows an \"OOPS\" page\r\n\r\n### Describe the problem\r\nMlflow does not run on MySQL 8.x versions when enabled with backend store for mysql. This seems to be because of a duplicate constraint name in the autogeneration of schemas when running the server. The error stack trace points to a duplicate constrain check name 'lifecycle_stage'  while creating the 'runs' table.\r\n\r\n\r\n\r\n### Source code / logs\r\n\r\n```\r\n[2019-05-31 04:16:13 +1000] [7836] [ERROR] Socket error processing request.\r\nTraceback (most recent call last):\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/workers/sync.py\", line 135, in handle\r\n    self.handle_request(listener, req, client, addr)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/workers/sync.py\", line 191, in handle_request\r\n    six.reraise(*sys.exc_info())\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/six.py\", line 625, in reraise\r\n    raise value\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/workers/sync.py\", line 182, in handle_request\r\n    resp.write(item)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/http/wsgi.py\", line 353, in write\r\n    util.write(self.sock, arg, self.chunked)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/gunicorn/util.py\", line 304, in write\r\n    sock.sendall(data)\r\nOSError: [Errno 41] Protocol wrong type for socket\r\n2019/05/31 04:16:13 INFO mlflow.store.sqlalchemy_store: Creating initial MLflow database tables...\r\n[2019-05-31 04:16:13,159] ERROR in app: Exception on /ajax-api/2.0/preview/mlflow/experiments/list [GET]\r\nTraceback (most recent call last):\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1244, in _execute_context\r\n    cursor, statement, parameters, context\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 550, in do_execute\r\n    cursor.execute(statement, parameters)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/cursors.py\", line 206, in execute\r\n    res = self._query(query)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/cursors.py\", line 312, in _query\r\n    db.query(q)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/connections.py\", line 224, in query\r\n    _mysql.connection.query(self, query)\r\nMySQLdb._exceptions.OperationalError: (3822, \"Duplicate check constraint name 'lifecycle_stage'.\")\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/app.py\", line 2311, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/app.py\", line 1834, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/app.py\", line 1737, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/_compat.py\", line 36, in reraise\r\n    raise value\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/app.py\", line 1832, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/flask/app.py\", line 1818, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 81, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 330, in _list_experiments\r\n    experiment_entities = _get_store().list_experiments(request_message.view_type)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 35, in _get_store\r\n    _store = SqlAlchemyStore(store_dir, artifact_root)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/mlflow/store/sqlalchemy_store.py\", line 81, in __init__\r\n    SqlAlchemyStore._initialize_tables(self.engine)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/mlflow/store/sqlalchemy_store.py\", line 97, in _initialize_tables\r\n    InitialBase.metadata.create_all(engine)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/schema.py\", line 4287, in create_all\r\n    ddl.SchemaGenerator, self, checkfirst=checkfirst, tables=tables\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 2033, in _run_visitor\r\n    conn._run_visitor(visitorcallable, element, **kwargs)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1607, in _run_visitor\r\n    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/visitors.py\", line 131, in traverse_single\r\n    return meth(obj, **kw)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/ddl.py\", line 781, in visit_metadata\r\n    _is_metadata_operation=True,\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/visitors.py\", line 131, in traverse_single\r\n    return meth(obj, **kw)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/ddl.py\", line 826, in visit_table\r\n    include_foreign_key_constraints,\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 988, in execute\r\n    return meth(self, multiparams, params)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/sql/ddl.py\", line 72, in _execute_on_connection\r\n    return connection._execute_ddl(self, multiparams, params)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1050, in _execute_ddl\r\n    compiled,\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1248, in _execute_context\r\n    e, statement, parameters, cursor, context\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1466, in _handle_dbapi_exception\r\n    util.raise_from_cause(sqlalchemy_exception, exc_info)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/util/compat.py\", line 383, in raise_from_cause\r\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/util/compat.py\", line 128, in reraise\r\n    raise value.with_traceback(tb)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/base.py\", line 1244, in _execute_context\r\n    cursor, statement, parameters, context\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/sqlalchemy/engine/default.py\", line 550, in do_execute\r\n    cursor.execute(statement, parameters)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/cursors.py\", line 206, in execute\r\n    res = self._query(query)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/cursors.py\", line 312, in _query\r\n    db.query(q)\r\n  File \"/anaconda3/envs/automl/lib/python3.6/site-packages/MySQLdb/connections.py\", line 224, in query\r\n    _mysql.connection.query(self, query)\r\nsqlalchemy.exc.OperationalError: (MySQLdb._exceptions.OperationalError) (3822, \"Duplicate check constraint name 'lifecycle_stage'.\")\r\n[SQL:\r\nCREATE TABLE runs (\r\n\trun_uuid VARCHAR(32) NOT NULL,\r\n\tname VARCHAR(250),\r\n\tsource_type VARCHAR(20),\r\n\tsource_name VARCHAR(500),\r\n\tentry_point_name VARCHAR(50),\r\n\tuser_id VARCHAR(256),\r\n\tstatus VARCHAR(20),\r\n\tstart_time BIGINT,\r\n\tend_time BIGINT,\r\n\tsource_version VARCHAR(50),\r\n\tlifecycle_stage VARCHAR(20),\r\n\tartifact_uri VARCHAR(200),\r\n\texperiment_id INTEGER,\r\n\tCONSTRAINT run_pk PRIMARY KEY (run_uuid),\r\n\tCONSTRAINT source_type CHECK (source_type IN ('NOTEBOOK', 'JOB', 'LOCAL', 'UNKNOWN', 'PROJECT')),\r\n\tCONSTRAINT status CHECK (status IN ('SCHEDULED', 'FAILED', 'FINISHED', 'RUNNING')),\r\n\tCONSTRAINT lifecycle_stage CHECK (lifecycle_stage IN ('active', 'deleted')),\r\n\tFOREIGN KEY(experiment_id) REFERENCES experiments (experiment_id)\r\n)\r\n\r\n]\r\n(Background on this error at: http://sqlalche.me/e/e3q8)\r\n[2019-05-31 04:16:43 +1000] [7832] [CRITICAL] WORKER TIMEOUT (pid:7835)\r\n[2019-05-31 04:16:43 +1000] [7835] [INFO] Worker exiting (pid: 7835)\r\n[2019-05-31 04:16:43 +1000] [7845] [INFO] Booting worker with pid: 7845\r\n2019/05/31 04:17:15 ERROR mlflow.store.sqlalchemy_store: Detected one or more differences between current database schema and desired schema, exiting. Diff:\r\n [ ( 'add_table',\r\n    Table('runs', MetaData(bind=Engine(mysql://root:***@localhost:3306/orion_tracker)), Column('run_uuid', String(length=32), table=<runs>, primary_key=True, nullable=False), Column('name', String(length=250), table=<runs>), Column('source_type', String(length=20), table=<runs>, default=ColumnDefault('LOCAL')), Column('source_name', String(length=500), table=<runs>), Column('entry_point_name', String(length=50), table=<runs>), Column('user_id', String(length=256), table=<runs>), Column('status', String(length=20), table=<runs>, default=ColumnDefault('SCHEDULED')), Column('start_time', BigInteger(), table=<runs>, default=ColumnDefault(1559240235)), Column('end_time', BigInteger(), table=<runs>), Column('source_version', String(length=50), table=<runs>), Column('lifecycle_stage', String(length=20), table=<runs>, default=ColumnDefault('active')), Column('artifact_uri', String(length=200), table=<runs>), Column('experiment_id', Integer(), ForeignKey('experiments.experiment_id'), table=<runs>), schema=None)),\r\n  ( 'add_table',\r\n    Table('metrics', MetaData(bind=Engine(mysql://root:***@localhost:3306/orion_tracker)), Column('key', String(length=250), table=<metrics>, primary_key=True, nullable=False), Column('value', Float(), table=<metrics>, primary_key=True, nullable=False), Column('timestamp', BigInteger(), table=<metrics>, primary_key=True, nullable=False, default=ColumnDefault(<function SqlMetric.<lambda> at 0x11e6bae18>)), Column('step', BigInteger(), table=<metrics>, primary_key=True, nullable=False, default=ColumnDefault(0)), Column('run_uuid', String(length=32), ForeignKey('runs.run_uuid'), table=<metrics>, primary_key=True, nullable=False), schema=None)),\r\n  ( 'add_table',\r\n    Table('params', MetaData(bind=Engine(mysql://root:***@localhost:3306/orion_tracker)), Column('key', String(length=250), table=<params>, primary_key=True, nullable=False), Column('value', String(length=250), table=<params>, nullable=False), Column('run_uuid', String(length=32), ForeignKey('runs.run_uuid'), table=<params>, primary_key=True, nullable=False), schema=None)),\r\n  ( 'add_table',\r\n    Table('tags', MetaData(bind=Engine(mysql://root:***@localhost:3306/orion_tracker)), Column('key', String(length=250), table=<tags>, primary_key=True, nullable=False), Column('value', String(length=250), table=<tags>), Column('run_uuid', String(length=32), ForeignKey('runs.run_uuid'), table=<tags>, primary_key=True, nullable=False), schema=None))]\r\n[2019-05-31 04:17:45 +1000] [7832] [CRITICAL] WORKER TIMEOUT (pid:7836)\r\n[2019-05-31 04:17:45 +1000] [7832] [CRITICAL] WORKER TIMEOUT (pid:7845)\r\n[2019-05-31 04:17:45 +1000] [7836] [INFO] Worker exiting (pid: 7836)\r\n[2019-05-31 04:17:45 +1000] [7845] [INFO] Worker exiting (pid: 7845)\r\n[2019-05-31 04:17:45 +1000] [7890] [INFO] Booting worker with pid: 7890\r\n[2019-05-31 04:17:45 +1000] [7891] [INFO] Booting worker with pid: 7891\r\n\r\n```","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1385/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1385/timeline","performed_via_github_app":null,"state_reason":"completed"}