{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2551","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2551/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2551/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2551/events","html_url":"https://github.com/mlflow/mlflow/issues/2551","id":576502644,"node_id":"MDU6SXNzdWU1NzY1MDI2NDQ=","number":2551,"title":"[BUG] INTERNAL_SERVER_ERROR when sorting the runs table by metric or by date","user":{"login":"lopezco","id":6637618,"node_id":"MDQ6VXNlcjY2Mzc2MTg=","avatar_url":"https://avatars.githubusercontent.com/u/6637618?v=4","gravatar_id":"","url":"https://api.github.com/users/lopezco","html_url":"https://github.com/lopezco","followers_url":"https://api.github.com/users/lopezco/followers","following_url":"https://api.github.com/users/lopezco/following{/other_user}","gists_url":"https://api.github.com/users/lopezco/gists{/gist_id}","starred_url":"https://api.github.com/users/lopezco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lopezco/subscriptions","organizations_url":"https://api.github.com/users/lopezco/orgs","repos_url":"https://api.github.com/users/lopezco/repos","events_url":"https://api.github.com/users/lopezco/events{/privacy}","received_events_url":"https://api.github.com/users/lopezco/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022863969,"node_id":"MDU6TGFiZWwyMDIyODYzOTY5","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-soon","name":"priority/important-soon","color":"534cb5","default":false,"description":"The issue is worked on by the community currently or will be very soon, ideally in time for the"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2020-03-05T20:11:11Z","updated_at":"2021-05-24T20:13:01Z","closed_at":"2021-05-24T20:13:01Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Debian\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.7.0\r\n- **Python version**: 3.7\r\n- **npm version, if running the dev UI**: -\r\n- **Exact command to reproduce**: run the mlflow server and log parameters and metrics\r\n\r\n### Describe the problem\r\nWhen I try to sort the runs by any metric or date (parameters, versions and users work) I get an `INTERNAL_SERVER_ERROR` and the whole table disappears. Then, if I sort by a parameter, for example, the table comes back.\r\n\r\n**UPDATE:**\r\n![V4-Model-MLflow-Experiment-Google-Chrome-2020-04-07-10-18-17-_online-video-cutter com_](https://user-images.githubusercontent.com/6637618/78646910-10d70a80-78ba-11ea-82ea-a4678a3337fe.gif)\r\n\r\n\r\n### Code to reproduce issue\r\nrun the mlflow server and log parameters and metrics\r\n\r\n### Other info / logs\r\nThis is the trace-back I got from the server:\r\n```\r\n2020/03/04 09:40:50 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/runs/search [POST]\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 1246, in _execute_context\r\n    cursor, statement, parameters, context\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/default.py\", line 588, in do_execute\r\n    cursor.execute(statement, parameters)\r\npyodbc.ProgrammingError: ('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Incorrect syntax near '1'. (102) (SQLExecDirectW)\")\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/db/utils.py\", line 73, in make_managed_session\r\n    yield session\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 651, in _search_runs\r\n    .offset(offset).limit(max_results).all()\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3233, in all\r\n    return list(self)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3389, in __iter__\r\n    return self._execute_and_instances(context)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3414, in _execute_and_instances\r\n    result = conn.execute(querycontext.statement, self._params)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 982, in execute\r\n    return meth(self, multiparams, params)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/sql/elements.py\", line 293, in _execute_on_connection\r\n    return connection._execute_clauseelement(self, multiparams, params)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 1101, in _execute_clauseelement\r\n    distilled_params,\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 1250, in _execute_context\r\n    e, statement, parameters, cursor, context\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 1476, in _handle_dbapi_exception\r\n    util.raise_from_cause(sqlalchemy_exception, exc_info)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/util/compat.py\", line 398, in raise_from_cause\r\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/util/compat.py\", line 152, in reraise\r\n    raise value.with_traceback(tb)\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 1246, in _execute_context\r\n    cursor, statement, parameters, context\r\n  File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/default.py\", line 588, in do_execute\r\n    cursor.execute(statement, parameters)\r\nsqlalchemy.exc.ProgrammingError: (pyodbc.ProgrammingError) ('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Incorrect syntax near '1'. (102) (SQLExecDirectW)\")\r\n[SQL: SELECT DISTINCT TOP 100 runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (anon_1.is_nan IS 1) THEN ? WHEN (anon_1.value IS NULL) THEN ? ELSE ? END AS clause_1, anon_1.value AS anon_1_value \r\nFROM runs LEFT OUTER JOIN (SELECT latest_metrics.[key] AS [key], latest_metrics.value AS value, latest_metrics.timestamp AS timestamp, latest_metrics.step AS step, latest_metrics.is_nan AS is_nan, latest_metrics.run_uuid AS run_uuid \r\nFROM latest_metrics \r\nWHERE latest_metrics.[key] = ?) AS anon_1 ON runs.run_uuid = anon_1.run_uuid \r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY clause_1, anon_1.value, runs.start_time DESC, runs.run_uuid]\r\n[parameters: (1, 1, 0, 'auc', '4', 'active')]\r\n(Background on this error at: http://sqlalche.me/e/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 155, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 394, in _search_runs\r\n    max_results, order_by, page_token)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/abstract_store.py\", line 230, in search_runs\r\n    order_by, page_token)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 654, in _search_runs\r\n    next_page_token = compute_next_token(len(runs))\r\n  File \"/usr/local/lib/python3.7/contextlib.py\", line 130, in __exit__\r\n    self.gen.throw(type, value, traceback)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/db/utils.py\", line 80, in make_managed_session\r\n    raise MlflowException(message=e, error_code=INTERNAL_ERROR)\r\nmlflow.exceptions.MlflowException: (pyodbc.ProgrammingError) ('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Incorrect syntax near '1'. (102) (SQLExecDirectW)\")\r\n[SQL: SELECT DISTINCT TOP 100 runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (anon_1.is_nan IS 1) THEN ? WHEN (anon_1.value IS NULL) THEN ? ELSE ? END AS clause_1, anon_1.value AS anon_1_value \r\nFROM runs LEFT OUTER JOIN (SELECT latest_metrics.[key] AS [key], latest_metrics.value AS value, latest_metrics.timestamp AS timestamp, latest_metrics.step AS step, latest_metrics.is_nan AS is_nan, latest_metrics.run_uuid AS run_uuid \r\nFROM latest_metrics \r\nWHERE latest_metrics.[key] = ?) AS anon_1 ON runs.run_uuid = anon_1.run_uuid \r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY clause_1, anon_1.value, runs.start_time DESC, runs.run_uuid]\r\n[parameters: (1, 1, 0, 'auc', '4', 'active')]\r\n(Background on this error at: http://sqlalche.me/e/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 2446, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1951, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1820, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/_compat.py\", line 39, in reraise\r\n    raise value\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1949, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1935, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 158, in wrapper\r\n    response.set_data(e.serialize_as_json())\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/exceptions.py\", line 50, in serialize_as_json\r\n    return json.dumps(exception_dict)\r\n  File \"/usr/local/lib/python3.7/json/__init__.py\", line 231, in dumps\r\n    return _default_encoder.encode(obj)\r\n  File \"/usr/local/lib/python3.7/json/encoder.py\", line 199, in encode\r\n    chunks = self.iterencode(o, _one_shot=True)\r\n  File \"/usr/local/lib/python3.7/json/encoder.py\", line 257, in iterencode\r\n    return _iterencode(o, 0)\r\n  File \"/usr/local/lib/python3.7/json/encoder.py\", line 179, in default\r\n    raise TypeError(f'Object of type {o.__class__.__name__} '\r\nTypeError: Object of type ProgrammingError is not JSON serializable\r\n```\r\n### **UPDATE**\r\nI've updated the version to v1.7.2 and the bug is still there.","closed_by":{"login":"jinzhang21","id":78067366,"node_id":"MDQ6VXNlcjc4MDY3MzY2","avatar_url":"https://avatars.githubusercontent.com/u/78067366?v=4","gravatar_id":"","url":"https://api.github.com/users/jinzhang21","html_url":"https://github.com/jinzhang21","followers_url":"https://api.github.com/users/jinzhang21/followers","following_url":"https://api.github.com/users/jinzhang21/following{/other_user}","gists_url":"https://api.github.com/users/jinzhang21/gists{/gist_id}","starred_url":"https://api.github.com/users/jinzhang21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jinzhang21/subscriptions","organizations_url":"https://api.github.com/users/jinzhang21/orgs","repos_url":"https://api.github.com/users/jinzhang21/repos","events_url":"https://api.github.com/users/jinzhang21/events{/privacy}","received_events_url":"https://api.github.com/users/jinzhang21/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2551/timeline","performed_via_github_app":null,"state_reason":"completed"}