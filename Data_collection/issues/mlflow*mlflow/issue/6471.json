{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6471","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6471/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6471/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6471/events","html_url":"https://github.com/mlflow/mlflow/issues/6471","id":1339337992,"node_id":"I_kwDOCB5Jx85P1K0I","number":6471,"title":"[SETUP-BUG] ValueError: Anonymous credentials cannot be refreshed","user":{"login":"shahasim","id":26812995,"node_id":"MDQ6VXNlcjI2ODEyOTk1","avatar_url":"https://avatars.githubusercontent.com/u/26812995?v=4","gravatar_id":"","url":"https://api.github.com/users/shahasim","html_url":"https://github.com/shahasim","followers_url":"https://api.github.com/users/shahasim/followers","following_url":"https://api.github.com/users/shahasim/following{/other_user}","gists_url":"https://api.github.com/users/shahasim/gists{/gist_id}","starred_url":"https://api.github.com/users/shahasim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shahasim/subscriptions","organizations_url":"https://api.github.com/users/shahasim/orgs","repos_url":"https://api.github.com/users/shahasim/repos","events_url":"https://api.github.com/users/shahasim/events{/privacy}","received_events_url":"https://api.github.com/users/shahasim/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"assignees":[{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2022-08-15T18:35:27Z","updated_at":"2022-08-23T07:45:51Z","closed_at":"2022-08-23T07:45:51Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux version 5.15.58-flatcar (build@pony-truck.infra.kinvolk.io) (x86_64-cros-linux-gnu-gcc (Gentoo Hardened 10.3.0-r2 p3) 10.3.0\r\n- **MLflow installed from (source or binary)**: source, installed using `pip install mlflow[extras]==1.27.0` in docker container\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.27.0\r\n- **Python version**: python3.8, using base docker image `from python:3.8.2-slim`\r\n\n\n### Code to reproduce issue\n\n**Docker File** \r\n```\r\nFROM python:3.8.2-slim\r\n\r\nENV MLFLOW_HOME /app/mlflow\r\nENV SERVER_PORT 5000\r\nENV SERVER_HOST 0.0.0.0\r\nENV ARTIFACT_STORE /mnt/mlflow\r\nENV BACKEND_STORE mysql+pymysql://mluser:<your_password>@<ip>:30036/mlflow\r\nENV GOOGLE_APPLICATION_CREDENTIALS /secrets/service-account.json\r\n\r\nRUN pip install --upgrade pip && \\ \r\n    pip install PyMySQL==1.0.2 && \\   \r\n    pip install psycopg2-binary==2.9.3 && \\\r\n    pip install google-cloud-storage==2.4.0 && \\\r\n    pip install mlflow[extras]==1.27.0\r\n\r\nRUN apt-get update; apt-get --assume-yes install curl\r\n\r\nRUN curl https://sdk.cloud.google.com > install.sh\r\nRUN bash install.sh --disable-prompts --install-dir=/workdir/\r\n\r\nENV PATH=/workdir/google-cloud-sdk/bin:$PATH\r\n\r\nEXPOSE ${SERVER_PORT}\r\n\r\nENTRYPOINT [\"mlflow\", \"server\"]\r\n```\r\n\r\n**kubernetes command:**\r\n`mlflow  server --host=0.0.0.0 --backend-store-uri=$(BACKEND_STORE) --artifacts-destination=$(ARTIFACT_STORE) --default-artifact-root=$(ARTIFACT_STORE) --serve-artifacts` \r\n\r\n**Envs**\r\n```\r\n          - name: ARTIFACT_STORE\r\n            value: \"gs://bucket-name/mlflow\"\r\n          - name: GOOGLE_APPLICATION_CREDENTIALS\r\n            value: \"/secrets/service-account.json\"\r\n```\r\n\r\n**code** \r\n\r\n```\r\nmlflow.set_tracking_uri(\"https://mlflowserver.system/\")\r\nmlflow.set_experiment(\"test\")\r\n\r\nwith mlflow.start_run() as run:\r\n    mlflow.log_params(params)\r\n    model_info = mlflow.catboost.log_model(model, artifact_path=\"model\")\r\n    mlflow.log_artifact(\"../data/features.txt\", artifact_path=\"features\")\r\n    model_uri = mlflow.get_artifact_uri(\"model\")\r\n    result = mlflow.evaluate(\r\n        model_info.model_uri,\r\n        eval_data,\r\n        targets=\"label\",\r\n        model_type=\"classifier\",\r\n        evaluators=\"default\",\r\n        evaluator_config={\"explainability_kernel_link\":\"logit\"},\r\n        feature_names=X_train[selected_features].columns\r\n    )\r\n```\r\n\r\n\n\n### Describe the problem\n\nI have deployed mlflow server on Kubernetes cluster and unless I explicitly set the following ENVs in python script / Jupyter notebook, it throws `\"ValueError: Anonymous credentials cannot be refreshed.\"` error.\r\n\r\n```\r\n# Workaround\r\n# import os \r\n# os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/myname/Documents/json_serv.json'\r\n```\r\n\r\nIn our container we have explicitly set `GOOGLE_APPLICATION_CREDENTIALS` environment variable and expect mlflow server to handle authentication with the google cloud storage bucket using the service account set by the env, but that's not the case.\r\n\r\nPlease do let me know if this is not possible and we do need to explicitly set the credentials in every script / notebook. \r\n\r\nIdeally we do not want to be in a situation that for every user we need to create a service account with appropriate permission and that requires manually setting ENVs in every script / notebook. \r\n\r\nFrom what I have seen so far, our setup requires us to explicitly set credentials in order to upload model artefacts. \r\n\r\nPlease do let me know if there is something wrong with my setup / code and if you need more details.\r\n\r\nThanks in advance in helping me solve this issue :) \r\n\r\n\r\n\n\n### Other info / logs\n\n<img width=\"671\" alt=\"Screenshot 2022-08-15 at 15 32 27\" src=\"https://user-images.githubusercontent.com/26812995/184694853-24e593a8-a164-4ba2-b43b-a2b552e85b6b.png\">\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6471/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6471/timeline","performed_via_github_app":null,"state_reason":"completed"}