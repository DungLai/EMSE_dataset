{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6770","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6770/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6770/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6770/events","html_url":"https://github.com/mlflow/mlflow/issues/6770","id":1370731776,"node_id":"I_kwDOCB5Jx85Rs7UA","number":6770,"title":"[BUG] Register step reruns model evaluation, predict step reruns ingest scoring","user":{"login":"jerrylian-db","id":66143562,"node_id":"MDQ6VXNlcjY2MTQzNTYy","avatar_url":"https://avatars.githubusercontent.com/u/66143562?v=4","gravatar_id":"","url":"https://api.github.com/users/jerrylian-db","html_url":"https://github.com/jerrylian-db","followers_url":"https://api.github.com/users/jerrylian-db/followers","following_url":"https://api.github.com/users/jerrylian-db/following{/other_user}","gists_url":"https://api.github.com/users/jerrylian-db/gists{/gist_id}","starred_url":"https://api.github.com/users/jerrylian-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jerrylian-db/subscriptions","organizations_url":"https://api.github.com/users/jerrylian-db/orgs","repos_url":"https://api.github.com/users/jerrylian-db/repos","events_url":"https://api.github.com/users/jerrylian-db/events{/privacy}","received_events_url":"https://api.github.com/users/jerrylian-db/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2114036915,"node_id":"MDU6TGFiZWwyMTE0MDM2OTE1","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/databricks","name":"integrations/databricks","color":"ffbce5","default":false,"description":"Databricks integrations"},{"id":4265961281,"node_id":"LA_kwDOCB5Jx87-RWdB","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/recipes","name":"area/recipes","color":"48eabc","default":false,"description":"MLflow Recipes, Recipes APIs, Recipes configs, Recipe Templates"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-13T01:51:25Z","updated_at":"2022-09-21T00:34:49Z","closed_at":null,"author_association":"COLLABORATOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n1.28.1.dev0 (installed from mlflow master commit 3016c02fb59928a129dac2dae21c762e7992578e)\r\n\r\n### System information\r\n\r\n- Databricks runtime 11.X snapshot Machine Learning\r\n\r\n\r\n### Describe the problem\r\n\r\nI cloned the [mlp-regression-template](https://github.com/mlflow/mlp-regression-template) and imported it in Databricks. I updated the requirements.txt file to point to the latest master for MLflow. Then, I ran through the entire Databricks notebook. I noticed a few issues:\r\n\r\nFirst, the register step seems to be doing model evaluation despite the evaluate step was already run. See screenshot:\r\n<img width=\"1052\" alt=\"Screen Shot 2022-09-12 at 6 45 40 PM\" src=\"https://user-images.githubusercontent.com/66143562/189789138-4bae1e42-ba9f-4021-b2dd-78c005d8ba6b.png\">\r\n\r\nSecond, the predict step re-ingests and profiles the scoring data despite the ingest-scoring step was already run. To add, `p.get_artifact(\"ingested_scoring_data\")` returned a Dataframe before the predict step was run, so it doesn't seem like the execution cache was not populated.\r\n<img width=\"1687\" alt=\"Screen Shot 2022-09-12 at 6 47 48 PM\" src=\"https://user-images.githubusercontent.com/66143562/189789352-a58482a2-7d2f-4e27-bd95-95153c1e2238.png\">\r\n before the predict step was run. See screenshot:\r\n\r\nThird, sklearn continues to warn during model training and evaluation that `UserWarning: X does not have valid feature names, but SGDRegressor was fitted with feature names`. This warning is annoying and concerning from a user perspective.\r\n<img width=\"1689\" alt=\"Screen Shot 2022-09-12 at 6 48 26 PM\" src=\"https://user-images.githubusercontent.com/66143562/189789419-e8f63096-4e2e-4c14-8d0a-c5a86615f2b0.png\">\r\n\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\nDownload the latest mlp regression template into Databricks. Update the requirements.txt file to point to the latest master. Run the Databricks notebook on an MLR 11.X cluster. Add the following two cells `p.run(\"ingest_scoring\")` and `p.run(\"predict\")` and run both of them.\r\n\r\n### Stack trace\r\n\r\nIn the evaluate step run\r\n```\r\n2022/09/13 01:15:15 INFO mlflow.models.evaluation.base: Evaluating the model with the default evaluator.\r\n/local_disk0/.ephemeral_nfs/envs/pythonEnv-32323741-9c89-42e1-a9f5-11190e7f1aaf/lib/python3.9/site-packages/sklearn/base.py:450: UserWarning: X does not have valid feature names, but SGDRegressor was fitted with feature names\r\n  warnings.warn(\r\n/local_disk0/.ephemeral_nfs/envs/pythonEnv-32323741-9c89-42e1-a9f5-11190e7f1aaf/lib/python3.9/site-packages/sklearn/base.py:450: UserWarning: X does not have valid feature names, but SGDRegressor was fitted with feature names\r\n  warnings.warn(\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n2022/09/13 01:15:16 INFO mlflow.models.evaluation.default_evaluator: Shap explainer _PatchedKernelExplainer is used.\r\n\r\n  0%|          | 0/10 [00:00<?, ?it/s]X does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n\r\n 30%|███       | 3/10 [00:00<00:00, 22.67it/s]X does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n\r\n 60%|██████    | 6/10 [00:00<00:00, 20.77it/s]X does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n\r\n 90%|█████████ | 9/10 [00:00<00:00, 20.66it/s]X does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n\r\n100%|██████████| 10/10 [00:00<00:00, 20.37it/s]\r\nUnable to serialize underlying model using MLflow, will use SHAP serialization\r\n2022/09/13 01:15:21 WARNING mlflow.utils.requirements_utils: Found torch version (1.12.1+cpu) contains a local version label (+cpu). MLflow logged a pip requirement for this package as 'torch==1.12.1' without the local version label to make it installable from PyPI. To specify pip requirements containing local version labels, please use `conda_env` or `pip_requirements`.\r\nelementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\nelementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n2022/09/13 01:15:25 INFO mlflow.models.evaluation.base: Evaluating the model with the default evaluator.\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\nX does not have valid feature names, but SGDRegressor was fitted with feature names\r\n```\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [X] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [X] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6770/timeline","performed_via_github_app":null,"state_reason":null}