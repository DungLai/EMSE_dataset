{"url":"https://api.github.com/repos/mlflow/mlflow/issues/414","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/414/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/414/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/414/events","html_url":"https://github.com/mlflow/mlflow/issues/414","id":355707219,"node_id":"MDU6SXNzdWUzNTU3MDcyMTk=","number":414,"title":"mlflow pyfunc server with keras model is broken","user":{"login":"tomasatdatabricks","id":33237569,"node_id":"MDQ6VXNlcjMzMjM3NTY5","avatar_url":"https://avatars.githubusercontent.com/u/33237569?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasatdatabricks","html_url":"https://github.com/tomasatdatabricks","followers_url":"https://api.github.com/users/tomasatdatabricks/followers","following_url":"https://api.github.com/users/tomasatdatabricks/following{/other_user}","gists_url":"https://api.github.com/users/tomasatdatabricks/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasatdatabricks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasatdatabricks/subscriptions","organizations_url":"https://api.github.com/users/tomasatdatabricks/orgs","repos_url":"https://api.github.com/users/tomasatdatabricks/repos","events_url":"https://api.github.com/users/tomasatdatabricks/events{/privacy}","received_events_url":"https://api.github.com/users/tomasatdatabricks/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-08-30T18:42:13Z","updated_at":"2019-08-02T17:45:32Z","closed_at":"2019-08-02T17:45:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Serving keras models (with tf-backedn) via pyfunc serve currently does not work. The global tf graph changes between model load and predict (assuming changing threads / processes) which lead to the following stacktrace:\r\n\r\nTraceback (most recent call last):\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/app.py\", line 2292, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/app.py\", line 1815, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/app.py\", line 1718, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/_compat.py\", line 35, in reraise\r\n    raise value\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/app.py\", line 1813, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/flask/app.py\", line 1799, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/Users/tomas/dev/mlflow-prototype/mlflow/pyfunc/scoring_server.py\", line 78, in transformation\r\n    predictions = get_jsonable_obj(model.predict(data))\r\n  File \"/Users/tomas/dev/mlflow-prototype/mlflow/keras.py\", line 53, in predict\r\n    predicted = pd.DataFrame(self.keras_model.predict(dataframe))\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/keras/engine/training.py\", line 1162, in predict\r\n    self._make_predict_function()\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/keras/engine/training.py\", line 543, in _make_predict_function\r\n    **kwargs)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py\", line 2695, in function\r\n    return Function(inputs, outputs, updates=updates, **kwargs)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py\", line 2516, in __init__\r\n    with tf.control_dependencies(self.outputs):\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 5027, in control_dependencies\r\n    return get_default_graph().control_dependencies(control_inputs)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 4631, in control_dependencies\r\n    c = self.as_graph_element(c)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3590, in as_graph_element\r\n    return self._as_graph_element_locked(obj, allow_tensor, allow_operation)\r\n  File \"/anaconda3/envs/mlflow-dev/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3669, in _as_graph_element_locked\r\n    raise ValueError(\"Tensor %s is not an element of this graph.\" % obj)\r\nValueError: Tensor Tensor(\"dense_5/Sigmoid:0\", shape=(?, 1), dtype=float32) is not an element of this graph.\r\n\r\nThe fix is to store the graph with the model and set it as default during predict call.","closed_by":{"login":"ankit-db","id":52183359,"node_id":"MDQ6VXNlcjUyMTgzMzU5","avatar_url":"https://avatars.githubusercontent.com/u/52183359?v=4","gravatar_id":"","url":"https://api.github.com/users/ankit-db","html_url":"https://github.com/ankit-db","followers_url":"https://api.github.com/users/ankit-db/followers","following_url":"https://api.github.com/users/ankit-db/following{/other_user}","gists_url":"https://api.github.com/users/ankit-db/gists{/gist_id}","starred_url":"https://api.github.com/users/ankit-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankit-db/subscriptions","organizations_url":"https://api.github.com/users/ankit-db/orgs","repos_url":"https://api.github.com/users/ankit-db/repos","events_url":"https://api.github.com/users/ankit-db/events{/privacy}","received_events_url":"https://api.github.com/users/ankit-db/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/414/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/414/timeline","performed_via_github_app":null,"state_reason":"completed"}