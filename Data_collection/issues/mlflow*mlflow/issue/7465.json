{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7465","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7465/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7465/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7465/events","html_url":"https://github.com/mlflow/mlflow/issues/7465","id":1480764792,"node_id":"I_kwDOCB5Jx85YQq14","number":7465,"title":"[BUG] Password with spacial characters parsing error when using FTP as artifact root","user":{"login":"HCTsai","id":6162740,"node_id":"MDQ6VXNlcjYxNjI3NDA=","avatar_url":"https://avatars.githubusercontent.com/u/6162740?v=4","gravatar_id":"","url":"https://api.github.com/users/HCTsai","html_url":"https://github.com/HCTsai","followers_url":"https://api.github.com/users/HCTsai/followers","following_url":"https://api.github.com/users/HCTsai/following{/other_user}","gists_url":"https://api.github.com/users/HCTsai/gists{/gist_id}","starred_url":"https://api.github.com/users/HCTsai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HCTsai/subscriptions","organizations_url":"https://api.github.com/users/HCTsai/orgs","repos_url":"https://api.github.com/users/HCTsai/repos","events_url":"https://api.github.com/users/HCTsai/events{/privacy}","received_events_url":"https://api.github.com/users/HCTsai/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":4300304016,"node_id":"LA_kwDOCB5Jx88AAAABAFFukA","url":"https://api.github.com/repos/mlflow/mlflow/labels/has-closing-pr","name":"has-closing-pr","color":"fef2c0","default":false,"description":"This issue has a closing PR"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-12-07T02:46:20Z","updated_at":"2022-12-12T04:58:52Z","closed_at":"2022-12-12T04:58:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\n- Client: 2.0.1\r\n- Tracking server: 2.0.1\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 20.04\r\n- **Python version**: 3.8\r\n- **yarn version, if running the dev UI**:\r\n\n\n### Describe the problem\n\nwhen using ftp as artifact root with a spacial character in password：\r\n\r\nExample: password is 'pass#01'\r\nartifact_root = 'ftp://username:pass#01@192.168.51.61/temp/mlflow/' \r\n\r\nthis situation will raise a urllib/parse.py error\r\n```\r\npython3.8/urllib/parse.py\", line 177, in port\r\n    raise ValueError(message) from None\r\nValueError: Port could not be cast to integer value as 'pass'\r\n```\r\nThis is because client code do not encode the password.\r\n\r\nBut if  client code encode the password as follow:\r\n\r\nartifact_root = 'ftp://username:pass%2301@192.168.51.61/temp/mlflow/' \r\n\r\nthis situation will raise a ftplib.py error: \r\nftplib.error_perm: 530 Login incorrect.\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/qailab/src/eclipse-workspace/kubeflow_tools/demo/ftp_bug_demo.py\", line 24, in <module>\r\n    mlflow.log_artifact(\"upload_test.txt\")\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/fluent.py\", line 778, in log_artifact\r\n    MlflowClient().log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 1002, in log_artifact\r\n    self._tracking_client.log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 416, in log_artifact\r\n    artifact_repo.log_artifact(local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 68, in log_artifact\r\n    with self.get_ftp_client() as ftp:\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/contextlib.py\", line 113, in __enter__\r\n    return next(self.gen)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 38, in get_ftp_client\r\n    ftp.login(self.config[\"username\"], self.config[\"password\"])\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 410, in login\r\n    resp = self.sendcmd('PASS ' + passwd)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 277, in sendcmd\r\n    return self.getresp()\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 250, in getresp\r\n    raise error_perm(resp)\r\nftplib.error_perm: 530 Login incorrect.\r\n```\r\n\r\nThis is because :\r\nLine 38 in https://github.com/mlflow/mlflow/blob/master/mlflow/store/artifact/ftp_artifact_repo.py\r\n\r\nUsing url-encoded password to connect a FTP server:\r\n```\r\nftp.login(self.config[\"username\"], self.config[\"password\"])\r\n```\r\n\r\n```\r\nresp = self.sendcmd('PASS ' + passwd)\r\n```\r\n\r\nSuggest bug solution:\r\n\r\nDecode the password in ftp_artifact_repo.py  makes the ftp connection using decoded password:\r\n\r\n\r\n```\r\nfrom urllib.parse import unquote\r\n\r\nparsed = urllib.parse.urlparse(artifact_uri)\r\n        self.config = {\r\n            \"host\": parsed.hostname,\r\n            \"port\": 21 if parsed.port is None else parsed.port,\r\n            \"username\": parsed.username,\r\n            \"password\": unquote(parsed.password),,\r\n        }\r\n```\r\n\n\n### Tracking information\n\nMLflow version: 2.0.1\r\nTracking URI: mysql+pymysql://mlflow_user:xxxx@192.168.51.xxx:3306/mlflow\r\nArtifact URI: ftp://hsiao-chien.tsai:pass%231@192.168.51.61/Temp/Stanley/mlflow/ftp_bug_demo_2/54aa5167bae14f8f98dd84515d1235ec/artifacts\r\nSystem information: Linux #62~20.04.1-Ubuntu SMP Tue Nov 22 21:24:20 UTC 2022\r\nPython version: 3.8.13\r\nMLflow version: 2.0.1\r\nMLflow module location: /home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/__init__.py\r\nTracking URI: mysql+pymysql://mlflow_user:mlflow_user@192.168.51.138:30306/mlflow\r\nRegistry URI: mysql+pymysql://mlflow_user:mlflow_user@192.168.51.138:30306/mlflow\r\nActive experiment ID: 13\r\nActive run ID: 54aa5167bae14f8f98dd84515d1235ec\r\nActive run artifact URI: ftp://hsiao-chien.tsai:pass%231@192.168.51.61/Temp/Stanley/mlflow/ftp_bug_demo_2/54aa5167bae14f8f98dd84515d1235ec/artifacts\r\nMLflow environment variables: {}\r\nMLflow dependencies: {\r\n    \"click\": \"8.1.3\",\r\n    \"cloudpickle\": \"2.2.0\",\r\n    \"databricks-cli\": \"0.17.3\",\r\n    \"entrypoints\": \"0.4\",\r\n    \"gitpython\": \"3.1.29\",\r\n    \"pyyaml\": \"5.4.1\",\r\n    \"protobuf\": \"3.20.1\",\r\n    \"pytz\": \"2022.6\",\r\n    \"requests\": \"2.28.1\",\r\n    \"packaging\": \"21.3\",\r\n    \"importlib-metadata\": \"5.0.0\",\r\n    \"sqlparse\": \"0.4.3\",\r\n    \"alembic\": \"1.8.1\",\r\n    \"docker\": \"6.0.1\",\r\n    \"Flask\": \"2.2.2\",\r\n    \"numpy\": \"1.23.5\",\r\n    \"scipy\": \"1.9.3\",\r\n    \"pandas\": \"1.5.1\",\r\n    \"querystring-parser\": \"1.2.4\",\r\n    \"sqlalchemy\": \"1.4.44\",\r\n    \"scikit-learn\": \"1.1.3\",\r\n    \"pyarrow\": \"10.0.1\",\r\n    \"shap\": \"0.41.0\",\r\n    \"markdown\": \"3.4.1\",\r\n    \"matplotlib\": \"3.6.2\",\r\n    \"gunicorn\": \"20.1.0\",\r\n    \"Jinja2\": \"3.1.2\"\r\n}\n\n### Code to reproduce issue\n\n\r\n```\r\nimport mlflow\r\nexp_name = 'ftp_bug_demo'\r\nartifact_root = 'ftp://username:pass%231@192.168.51.61/temp/mlflow/'\r\ntracking_uri = 'mysql+pymysql://mlflow_user:password@192.168.51.138:3306/mlflow'\r\nmlflow.set_tracking_uri(tracking_uri) # 設定\r\nartifact_location = artifact_root + exp_name\r\nif exp_name is not None :\r\n    exp = mlflow.get_experiment_by_name(exp_name) #檢查是否需要產生新的實驗\r\n    if not exp :\r\n        mlflow.create_experiment(exp_name, artifact_location)\r\n        print(\"create {} on {}\".format(exp_name, artifact_location))\r\n    mlflow.set_experiment(exp_name)\r\nmlflow.start_run()\r\nmlflow.log_artifact(\"upload_test.txt\")\r\nmlflow.end_run()\r\n```\n\n### Stack trace\n\n```\r\nTraceback (most recent call last):\r\n  File \"/home/qailab/src/eclipse-workspace/kubeflow_tools/demo/ftp_bug_demo.py\", line 24, in <module>\r\n    mlflow.log_artifact(\"upload_test.txt\")\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/fluent.py\", line 778, in log_artifact\r\n    MlflowClient().log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 1002, in log_artifact\r\n    self._tracking_client.log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 416, in log_artifact\r\n    artifact_repo.log_artifact(local_path, artifact_path)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 68, in log_artifact\r\n    with self.get_ftp_client() as ftp:\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/contextlib.py\", line 113, in __enter__\r\n    return next(self.gen)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 38, in get_ftp_client\r\n    ftp.login(self.config[\"username\"], self.config[\"password\"])\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 410, in login\r\n    resp = self.sendcmd('PASS ' + passwd)\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 277, in sendcmd\r\n    return self.getresp()\r\n  File \"/home/qailab/anaconda3/envs/kubeflow/lib/python3.8/ftplib.py\", line 250, in getresp\r\n    raise error_perm(resp)\r\nftplib.error_perm: 530 Login incorrect.\r\n```\r\n\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [X] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7465/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7465/timeline","performed_via_github_app":null,"state_reason":"completed"}