{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6905","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6905/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6905/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6905/events","html_url":"https://github.com/mlflow/mlflow/issues/6905","id":1387523638,"node_id":"I_kwDOCB5Jx85Ss-42","number":6905,"title":"[BUG]  autolog not working from pyspark because of _capture_modules.py stuck","user":{"login":"seraus","id":41294954,"node_id":"MDQ6VXNlcjQxMjk0OTU0","avatar_url":"https://avatars.githubusercontent.com/u/41294954?v=4","gravatar_id":"","url":"https://api.github.com/users/seraus","html_url":"https://github.com/seraus","followers_url":"https://api.github.com/users/seraus/followers","following_url":"https://api.github.com/users/seraus/following{/other_user}","gists_url":"https://api.github.com/users/seraus/gists{/gist_id}","starred_url":"https://api.github.com/users/seraus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seraus/subscriptions","organizations_url":"https://api.github.com/users/seraus/orgs","repos_url":"https://api.github.com/users/seraus/repos","events_url":"https://api.github.com/users/seraus/events{/privacy}","received_events_url":"https://api.github.com/users/seraus/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":28,"created_at":"2022-09-27T10:36:12Z","updated_at":"2022-10-04T07:54:01Z","closed_at":"2022-10-04T00:26:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n1.28/1.29\r\n\r\n### System information\r\n\r\nrunning on kubernetes v1.20.8\r\nubuntu 20.04, \r\njupyterlab 3.4.3, \r\npython 3.8.13\r\nspark 3.2.1 (pyspark)\r\nminio quay.io/minio/minio:RELEASE.2022-02-18T01-50-10Z\r\n\r\n\r\n\r\n### Describe the problem\r\n\r\nHi team,\r\nI'm using mlflow to log a pysparkml model. \r\nI've got a mlflow tracking which is configured to use a local minio as storage.\r\n\r\nModel logging is working from pure python (sklearn) while there seems to be a problem \r\n\r\n- when using mlflow.spark.log without specifying a conda_env, ie \r\n\r\n```\r\nmlflow.spark.log_model(pipeline_model,\"model\",conda_env=conda_env)\r\n```\r\n- or when using sparkml autolog\r\n\r\nIn both cases it seems, after correctly logging the sparkml pipeline files to minio,  to call a piece of code \"_capture_modules.py\" to prepare the main file MLmodel:\r\n\r\njovyan    7228  0.5  0.4 583672 109928 ?       Sl   09:41   0:04 /home/jovyan/condaenv/edge/bin/python3.8 /home/jovyan/condaenv/edge/lib/python3.8/site-packages/mlflow/utils/_capture_modules.py --model-path /tmp/tmprxa5r8da --flavor spark --output-file /tmp/tmporxuqx4o/imported_modules.txt --sys-path [\"/home/jovyan/notebook/working\", \"/home/jovyan/condaenv/edge/lib/python3.8/site-packages/git/ext/gitdb\", \"/tmp/spark-b0b87cac-185a-455a-a4f7-2541285e2836/userFiles-2989435d-54ac-48f2-92e7-86ae1cfb781a\", \"/usr/local/spark/python/lib/py4j-0.10.9.3-src.zip\", \"/usr/local/spark/python\", \"/home/jovyan/notebook/working\", \"/home/jovyan/condaenv/edge/lib/python38.zip\", \"/home/jovyan/condaenv/edge/lib/python3.8\", \"/home/jovyan/condaenv/edge/lib/python3.8/lib-dynload\", \"\", \"/home/jovyan/condaenv/edge/lib/python3.8/site-packages\", \"/home/jovyan/condaenv/edge/lib/python3.8/site-packages/gitdb/ext/smmap\"]\r\n\r\nand it starts a spark instance which seems  not properly configured:\r\n\r\njovyan    7237  2.6  1.5 6196088 368348 ?      Sl   09:41   0:19 /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java -cp /usr/local/spark/conf/:/usr/local/spark/jars/* -Xmx1g -Dio.netty.tryReflectionSetAccessible=true org.apache.spark.deploy.SparkSubmit --conf spark.master=local[1] --conf spark.databricks.io.cache.enabled=False --conf spark.driver.bindAddress=127.0.0.1 --conf spark.python.worker.reuse=True --conf spark.executor.allowSparkContext=true pyspark-shell\r\n\r\nand try to call s3 of amazon.com instead of local minio \r\n\r\nsee stacktrace below\r\n\r\nIt usually end run in a 1.5 h after a timeout logging the remaining files (MLmodel file and \"brothers\")\r\n\r\nIs there any chance to pass  spark and minio configuration to this process?\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\nfrom pyspark.ml.classification import LogisticRegression\r\nfrom pyspark.ml.feature import VectorAssembler, StandardScaler\r\nfrom pyspark.ml import Pipeline\r\nfrom pyspark.sql import SparkSession\r\nfrom sklearn.datasets import load_iris\r\n\r\nimport mlflow\r\n\r\n\r\n\r\nmlflow.set_experiment(\"spark_pipeline_example\")\r\n\r\nmlflow.pyspark.ml.autolog()\r\n\r\n\r\n\r\ndf = load_iris(as_frame=True).frame.rename(columns={\"target\": \"label\"})\r\ndf = sc.createDataFrame(df)\r\ntrain, test = df.randomSplit([0.8, 0.2])\r\n\r\nassembler = VectorAssembler(inputCols=df.columns[:-1], outputCol=\"features\")\r\nscaler = StandardScaler(inputCol=assembler.getOutputCol(), outputCol=\"scaledFeatures\")\r\nlor = LogisticRegression(maxIter=5, featuresCol=scaler.getOutputCol())\r\n\r\n# Non-neseted pipeline\r\npipeline = Pipeline(stages=[assembler, scaler, lor])\r\nwith mlflow.start_run():\r\n    pipeline_model = pipeline.fit(train)\r\n\r\n# predictions\r\n\r\ncolumns = [\"features\", \"prediction\"]\r\npipeline_model.transform(test).select(columns).show()\r\n\r\n### Stack trace\r\n\r\nfrom pyspark.ml.classification import LogisticRegression\r\nfrom pyspark.ml.feature import VectorAssembler, StandardScaler\r\nfrom pyspark.ml import Pipeline\r\nfrom pyspark.sql import SparkSession\r\nfrom sklearn.datasets import load_iris\r\n\r\nimport mlflow\r\n\r\n\r\n\r\nmlflow.set_experiment(\"spark_pipeline_example\")\r\n\r\nmlflow.pyspark.ml.autolog()\r\n\r\n\r\n\r\ndf = load_iris(as_frame=True).frame.rename(columns={\"target\": \"label\"})\r\ndf = sc.createDataFrame(df)\r\ntrain, test = df.randomSplit([0.8, 0.2])\r\n\r\nassembler = VectorAssembler(inputCols=df.columns[:-1], outputCol=\"features\")\r\nscaler = StandardScaler(inputCol=assembler.getOutputCol(), outputCol=\"scaledFeatures\")\r\nlor = LogisticRegression(maxIter=5, featuresCol=scaler.getOutputCol())\r\n\r\n# Non-neseted pipeline\r\npipeline = Pipeline(stages=[assembler, scaler, lor])\r\nwith mlflow.start_run():\r\n    pipeline_model = pipeline.fit(train)\r\n\r\n# predictions\r\n\r\ncolumns = [\"features\", \"prediction\"]\r\npipeline_model.transform(test).select(columns).show()\r\n\r\n### Other info / logs\r\n\r\n2022-09-27 09:53:14,412 +0000 [Thread-4] DEBUG (MainClientExec.java:234) - Opening connection {s}->https://miniosergio.s3.amazonaws.com:443\r\n2022-09-27 09:53:14,413 +0000 [Thread-4] DEBUG (DefaultHttpClientConnectionOperator.java:139) - Connecting to miniosergio.s3.amazonaws.com/52.217.88.84:443\r\n2022-09-27 09:53:14,413 +0000 [Thread-4] DEBUG (SSLConnectionSocketFactory.java:366) - Connecting socket to miniosergio.s3.amazonaws.com/52.217.88.84:443 with timeout 5000\r\n2022-09-27 09:53:19,419 +0000 [Thread-4] DEBUG (ClientConnectionManagerFactory.java:82) - \r\njava.lang.reflect.InvocationTargetException\r\n        at sun.reflect.GeneratedMethodAccessor16.invoke(Unknown Source)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:498)\r\n        at com.amazonaws.http.conn.ClientConnectionManagerFactory$Handler.invoke(ClientConnectionManagerFactory.java:76)\r\n        at com.amazonaws.http.conn.$Proxy15.connect(Unknown Source)\r\n        at com.amazonaws.thirdparty.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:393)\r\n        at com.amazonaws.thirdparty.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)\r\n        at com.amazonaws.thirdparty.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)\r\n        at com.amazonaws.thirdparty.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n        at com.amazonaws.thirdparty.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\r\n        at com.amazonaws.thirdparty.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)\r\n        at com.amazonaws.http.apache.client.impl.SdkHttpClient.execute(SdkHttpClient.java:72)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeOneRequest(AmazonHttpClient.java:1333)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeHelper(AmazonHttpClient.java:1145)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.doExecute(AmazonHttpClient.java:802)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeWithTimer(AmazonHttpClient.java:770)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.execute(AmazonHttpClient.java:744)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.access$500(AmazonHttpClient.java:704)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutionBuilderImpl.execute(AmazonHttpClient.java:686)\r\n        at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:550)\r\n        at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:530)\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5227)\r\n        at com.amazonaws.services.s3.AmazonS3Client.getBucketRegionViaHeadRequest(AmazonS3Client.java:6189)\r\n        at com.amazonaws.services.s3.AmazonS3Client.fetchRegionFromCache(AmazonS3Client.java:6162)\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5211)\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5173)\r\n        at com.amazonaws.services.s3.AmazonS3Client.getObjectMetadata(AmazonS3Client.java:1360)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.lambda$getObjectMetadata$6(S3AFileSystem.java:2066)\r\n        at org.apache.hadoop.fs.s3a.Invoker.retryUntranslated(Invoker.java:412)\r\n        at org.apache.hadoop.fs.s3a.Invoker.retryUntranslated(Invoker.java:375)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.getObjectMetadata(S3AFileSystem.java:2056)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.getObjectMetadata(S3AFileSystem.java:2032)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.s3GetFileStatus(S3AFileSystem.java:3273)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.innerGetFileStatus(S3AFileSystem.java:3185)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.getFileStatus(S3AFileSystem.java:3053)\r\n        at org.apache.hadoop.fs.FileSystem.exists(FileSystem.java:1760)\r\n        at org.apache.hadoop.fs.s3a.S3AFileSystem.exists(S3AFileSystem.java:4263)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:498)\r\n        at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)\r\n        at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357)\r\n        at py4j.Gateway.invoke(Gateway.java:282)\r\n        at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)\r\n        at py4j.commands.CallCommand.execute(CallCommand.java:79)\r\n        at py4j.ClientServerConnection.waitForCommands(ClientServerConnection.java:182)\r\n        at py4j.ClientServerConnection.run(ClientServerConnection.java:106)\r\n        at java.lang.Thread.run(Thread.java:750)\r\nCaused by: com.amazonaws.thirdparty.apache.http.conn.ConnectTimeoutException: Connect to miniosergio.s3.amazonaws.com:443 [miniosergio.s3.amazonaws.com/52.217.88.84] failed: connect timed out\r\n        at com.amazonaws.thirdparty.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:151)\r\n        at com.amazonaws.thirdparty.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:376)\r\n        ... 49 more\r\nCaused by: java.net.SocketTimeoutException: connect timed out\r\n        at java.net.PlainSocketImpl.socketConnect(Native Method)\r\n        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)\r\n        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)\r\n        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)\r\n        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\r\n        at java.net.Socket.connect(Socket.java:607)\r\n        at com.amazonaws.thirdparty.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:368)\r\n        at com.amazonaws.thirdparty.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\r\n        ... 50 more\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6905/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6905/timeline","performed_via_github_app":null,"state_reason":"completed"}