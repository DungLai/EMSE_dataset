{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4920","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4920/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4920/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4920/events","html_url":"https://github.com/mlflow/mlflow/issues/4920","id":1032421314,"node_id":"I_kwDOCB5Jx849iX_C","number":4920,"title":"[BUG] Bug when I try to download an artifact from the mlflow UI","user":{"login":"fernando080","id":82539263,"node_id":"MDQ6VXNlcjgyNTM5MjYz","avatar_url":"https://avatars.githubusercontent.com/u/82539263?v=4","gravatar_id":"","url":"https://api.github.com/users/fernando080","html_url":"https://github.com/fernando080","followers_url":"https://api.github.com/users/fernando080/followers","following_url":"https://api.github.com/users/fernando080/following{/other_user}","gists_url":"https://api.github.com/users/fernando080/gists{/gist_id}","starred_url":"https://api.github.com/users/fernando080/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fernando080/subscriptions","organizations_url":"https://api.github.com/users/fernando080/orgs","repos_url":"https://api.github.com/users/fernando080/repos","events_url":"https://api.github.com/users/fernando080/events{/privacy}","received_events_url":"https://api.github.com/users/fernando080/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-10-21T12:14:35Z","updated_at":"2021-10-21T12:14:49Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ x ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\nOS Platform and Distribution: Windows 10\r\nMLflow installed: using pip\r\nMLflow version: version 1.20.2\r\n**Python version: Python 3.9.7 **\r\n\r\n### Describe the problem\r\nI have saved an .h5 keras model, and when i tryed to execute mlflow.keras.load_model(\"run:/id_run/model\") i have been waiting almost an hour but it doesn't finish. So i stopped the execution and I got the next error:\r\n\r\n```\r\nERROR:root:Internal Python error in the inspect module.\r\nBelow is the traceback from this internal error.\r\n\r\nERROR:root:Internal Python error in the inspect module.\r\nBelow is the traceback from this internal error.\r\n\r\nTraceback (most recent call last):\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\IPython\\core\\interactiveshell.py\", line 3441, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-3-277d37cc6084>\", line 1, in <module>\r\n    keras_model = mlflow.keras.load_model(\"runs:/483745e28a864eceb738c852cf062774/model\")\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\keras.py\", line 585, in load_model\r\n    local_model_path = _download_artifact_from_uri(artifact_uri=model_uri)\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\tracking\\artifact_utils.py\", line 83, in _download_artifact_from_uri\r\n    return get_artifact_repository(artifact_uri=root_uri).download_artifacts(\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\runs_artifact_repo.py\", line 125, in download_artifacts\r\n    return self.repo.download_artifacts(artifact_path, dst_path)\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\artifact_repo.py\", line 180, in download_artifacts\r\n    return download_artifact_dir(\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\artifact_repo.py\", line 147, in download_artifact_dir\r\n    download_artifact_dir(\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\artifact_repo.py\", line 152, in download_artifact_dir\r\n    download_artifact(\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\artifact_repo.py\", line 129, in download_artifact\r\n    self._download_file(\r\n  File \"~\\AppData\\Roaming\\Python\\Python38\\site-packages\\mlflow\\store\\artifact\\azure_blob_artifact_repo.py\", line 136, in _download_file\r\n    container_client.download_blob(remote_full_path).readinto(file)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\azure\\storage\\blob\\_download.py\", line 617, in readinto\r\n    downloader.process_chunk(chunk)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\azure\\storage\\blob\\_download.py\", line 129, in process_chunk\r\n    chunk_data = self._download_chunk(chunk_start, chunk_end - 1)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\azure\\storage\\blob\\_download.py\", line 211, in _download_chunk\r\n    chunk_data = process_content(response, offset[0], offset[1], self.encryption_options)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\azure\\storage\\blob\\_download.py\", line 52, in process_content\r\n    content = b\"\".join(list(data))\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\azure\\core\\pipeline\\transport\\_requests_basic.py\", line 158, in __next__\r\n    chunk = next(self.iter_content_func)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\requests\\models.py\", line 758, in generate\r\n    for chunk in self.raw.stream(chunk_size, decode_content=True):\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\urllib3\\response.py\", line 576, in stream\r\n    data = self.read(amt=amt, decode_content=decode_content)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\urllib3\\response.py\", line 519, in read\r\n    data = self._fp.read(amt) if not fp_closed else b\"\"\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\http\\client.py\", line 459, in read\r\n    n = self.readinto(b)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\http\\client.py\", line 503, in readinto\r\n    n = self.fp.readinto(b)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\socket.py\", line 669, in readinto\r\n    return self._sock.recv_into(b)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\ssl.py\", line 1241, in recv_into\r\n    return self.read(nbytes, buffer)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\ssl.py\", line 1099, in read\r\n    return self._sslobj.read(len, buffer)\r\nKeyboardInterrupt\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\IPython\\core\\interactiveshell.py\", line 2061, in showtraceback\r\n    stb = value._render_traceback_()\r\nAttributeError: 'KeyboardInterrupt' object has no attribute '_render_traceback_'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\IPython\\core\\ultratb.py\", line 1101, in get_records\r\n    return _fixed_getinnerframes(etb, number_of_lines_of_context, tb_offset)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\IPython\\core\\ultratb.py\", line 248, in wrapped\r\n    return f(*args, **kwargs)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\site-packages\\IPython\\core\\ultratb.py\", line 281, in _fixed_getinnerframes\r\n    records = fix_frame_records_filenames(inspect.getinnerframes(etb, context))\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\inspect.py\", line 1515, in getinnerframes\r\n    frameinfo = (tb.tb_frame,) + getframeinfo(tb, context)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\inspect.py\", line 1473, in getframeinfo\r\n    filename = getsourcefile(frame) or getfile(frame)\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\inspect.py\", line 708, in getsourcefile\r\n    if getattr(getmodule(object, filename), '__loader__', None) is not None:\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\inspect.py\", line 754, in getmodule\r\n    os.path.realpath(f)] = module.__name__\r\n  File \"~\\anaconda3\\envs\\python_38\\lib\\ntpath.py\", line 647, in realpath\r\n    path = _getfinalpathname(path)\r\nKeyboardInterrupt\r\n```\r\n\r\nMy artifact sotrage is an Azure Blob Storage and my MLflow Server is running in axeternal server \r\n\r\nI checked the model in the UI and it was there o i tryed to dowload it from there. But the download stops as you can see in the images and then restart over and over again. I noticed that it weight 355MB, soy i logged the model dicrectory compressed as an artifact with more or less the same weight and it gives the same problem when you try to download it. \r\n\r\n\r\n![image](https://user-images.githubusercontent.com/82539263/138273641-654ebddc-fd65-4926-91c5-655d978b034a.png)\r\n\r\n![image](https://user-images.githubusercontent.com/82539263/138273521-f80575c7-c7d6-4a52-a5ba-3a771d82fd53.png)\r\n\r\n### Code to reproduce issue\r\nJust log a file with the same weight and try to recover it\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ x ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ x ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ x ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ x ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4920/timeline","performed_via_github_app":null,"state_reason":null}