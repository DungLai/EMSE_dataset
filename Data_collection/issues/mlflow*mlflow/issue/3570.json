{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3570","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3570/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3570/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3570/events","html_url":"https://github.com/mlflow/mlflow/issues/3570","id":726532431,"node_id":"MDU6SXNzdWU3MjY1MzI0MzE=","number":3570,"title":"[BUG] Unable to invoke models tracked by MLFlow that requires high-dimensional inputs/outputs","user":{"login":"mohammedi-haroune","id":23096288,"node_id":"MDQ6VXNlcjIzMDk2Mjg4","avatar_url":"https://avatars.githubusercontent.com/u/23096288?v=4","gravatar_id":"","url":"https://api.github.com/users/mohammedi-haroune","html_url":"https://github.com/mohammedi-haroune","followers_url":"https://api.github.com/users/mohammedi-haroune/followers","following_url":"https://api.github.com/users/mohammedi-haroune/following{/other_user}","gists_url":"https://api.github.com/users/mohammedi-haroune/gists{/gist_id}","starred_url":"https://api.github.com/users/mohammedi-haroune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mohammedi-haroune/subscriptions","organizations_url":"https://api.github.com/users/mohammedi-haroune/orgs","repos_url":"https://api.github.com/users/mohammedi-haroune/repos","events_url":"https://api.github.com/users/mohammedi-haroune/events{/privacy}","received_events_url":"https://api.github.com/users/mohammedi-haroune/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2020-10-21T14:12:32Z","updated_at":"2020-11-14T00:14:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.10\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.11.0\r\n- **Python version**: 3.7.9 and 3.8.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\nCopy the reproduction script below into `reproduction_script.py`\r\n```bash\r\nvirtualenv venv --python=python3\r\nsource venv/bin/activate\r\npip install gluoncv==0.8.0 mxnet==1.7.0.post1 mlflow==1.11.0 pandas==1.0.4 numpy==1.18.5 matplotlib==3.3.2\r\npython reproduction_script.py\r\n```\r\n### Describe the problem\r\n**TL;DR;** Models that require a high-dimensional input can't be invoked\r\n\r\nThe MLFlow `predict` method takes/returns only `pd.DataFrame`s which are [by definition](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html) two dimensional, this makes it impossible to use models that require high-dimensional (>2d) arrays as inputs/outputs, see the reproduction script and the similar open/closed issues \r\n\r\nIn fact, many issues were open to allow `predict` to accept/return high-dimensional arrays:\r\n##### Open issues:\r\n* [[BUG] ONNX predict fails for high-dimensional models #3229](https://github.com/mlflow/mlflow/issues/3229)\r\n* [[BUG] Predict N-dimensional data with pyfunc from MLmodel #2830](https://github.com/mlflow/mlflow/issues/2830)\r\n* [[FR] Support tensor inputs to MLflow inference APIs #3159](https://github.com/mlflow/mlflow/issues/3159)\r\n\r\n##### Pull requests:\r\n* [Added support for high dimensional onnx models #3307](https://github.com/mlflow/mlflow/pull/3307/)\r\n\r\n##### Closed issues:\r\n* [How to pass 2D array as an input to the MLFlow Model #1480](https://github.com/mlflow/mlflow/issues/1480)\r\n* [[FR]How to transfer the multi-dimensional pixel information of the image to the model after the model is deployed as dockerï¼Ÿ #1668](https://github.com/mlflow/mlflow/issues/1668)\r\n* [[BUG] Model predict with json input fails if the dataframe has multi-index #2412](https://github.com/mlflow/mlflow/issues/2412)\r\n* [[FR] Mlflow serve - sending an image #2452](https://github.com/mlflow/mlflow/issues/2452)\r\n* [Recommended handling of I/O for pyfunc? #702](https://github.com/mlflow/mlflow/issues/702)\r\n* [TensorFlow wrapper ravels outputs on predict #1066](https://github.com/mlflow/mlflow/issues/1066)\r\n\r\nThis is clearly something that blocks so many users from using the models that require high-dimensional inputs/outputs logged by MLFlow, I don't understand why MLFlow `predict` method is tightly coupled to `pd.DataFrame`s which clearly can't represent high-dimensional inputs/outputs, why don't we just allow passing `numpy` arrays and return them?  \r\n\r\n### Code to reproduce issue\r\n```python\r\n# Run the following pip command to install the dependencies\r\n# ! pip install gluoncv==0.8.0 mxnet==1.7.0.post1 mlflow==1.11.0 pandas==1.0.4 numpy==1.18.5 matplotlib==3.3.2 pyqt5==5.15.1\r\nfrom gluoncv import model_zoo, data, utils\r\nfrom matplotlib import pyplot as plt\r\nimport pandas as pd\r\nimport numpy as np\r\nimport mlflow\r\nimport mxnet\r\nimport mlflow.gluon\r\nimport traceback\r\n\r\n# Load a pretrained model\r\nnet = model_zoo.get_model('yolo3_darknet53_voc', pretrained=True)\r\n\r\n# Pre-process an image\r\nim_fname = utils.download('https://raw.githubusercontent.com/zhreshold/' +\r\n                          'mxnet-ssd/master/data/demo/dog.jpg',\r\n                          path='dog.jpg')\r\nx, img = data.transforms.presets.yolo.load_test(im_fname, short=512)\r\nprint('Shape of pre-processed image:', x.shape)\r\n\r\n# Inference and display\r\nnet.hybridize()\r\nclass_IDs, scores, bounding_boxs = net(x)\r\n\r\nax = utils.viz.plot_bbox(img, bounding_boxs[0], scores[0],\r\n                         class_IDs[0], class_names=net.classes)\r\n\r\n\r\n# Log the model with MLFlow\r\nr = mlflow.start_run()\r\nmodel_name = 'net'\r\nmodel_path = r.info.artifact_uri + '/' + model_name\r\nmlflow.gluon.log_model(net, model_name)\r\nmlflow.end_run()\r\n\r\n# Load the model\r\nm = mlflow.pyfunc.load_model(model_path)\r\n\r\n\r\nprint('-------------------------------------------------------------------------------------------')\r\nprint('Using the input as it is')\r\nprint('-------------------------------------------------------------------------------------------')\r\ntry:\r\n    print(m.predict(x))\r\nexcept Exception:\r\n    traceback.print_exc()\r\n\r\n# Using numpy.ndarray raises AttributeError: 'numpy.ndarray' object has no attribute 'values'\r\nprint('-------------------------------------------------------------------------------------------')\r\nprint(\"Using numpy.ndarray raises AttributeError: 'numpy.ndarray' object has no attribute 'values'\")\r\nprint('-------------------------------------------------------------------------------------------')\r\ntry:\r\n    print(m.predict(x.asnumpy()))\r\nexcept Exception:\r\n    traceback.print_exc()\r\n\r\n# Can't construct pd.DataFrame with a >2d shaped array\r\nprint('-------------------------------------------------------------------------------------------')\r\nprint(\"Can't construct pd.DataFrame with a >2d shaped array\")\r\nprint('-------------------------------------------------------------------------------------------')\r\ntry:\r\n    print(m.predict(pd.DataFrame(x.asnumpy())))\r\nexcept Exception:\r\n    traceback.print_exc()\r\n\r\n\r\n# Flattening the input with np.ravel is not acceptable\r\nprint('-------------------------------------------------------------------------------------------')\r\nprint(\"Flattening the input with np.ravel is not acceptable\")\r\nprint('-------------------------------------------------------------------------------------------')\r\ntry:\r\n    print(m.predict(pd.DataFrame(np.ravel(x.asnumpy()))))\r\nexcept Exception:\r\n    traceback.print_exc()\r\n\r\n\r\n# Using pd.DataFrame after reshaping also don't work\r\nprint('-------------------------------------------------------------------------------------------')\r\nprint(\"Using pd.DataFrame after reshaping also don't work\")\r\nprint('-------------------------------------------------------------------------------------------')\r\ntry:\r\n    x_df = pd.DataFrame(x.reshape(0, -1).asnumpy())\r\n    print(m.predict(x_df))\r\nexcept Exception:\r\n    traceback.print_exc()\r\n```\r\n\r\n### Other info / logs\r\nHere's the output of the reproduction script\r\n```\r\n-------------------------------------------------------------------------------------------\r\nUsing the input as it is\r\n-------------------------------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"invoking_mlflow_model_that_requires_multidimensional_input.py\", line 45, in <module>\r\n    print(m.predict(x))\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 425, in predict\r\n    return self._model_impl.predict(data)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/gluon.py\", line 78, in predict\r\n    ndarray = mx.nd.array(df.values)\r\nAttributeError: 'NDArray' object has no attribute 'values'\r\n-------------------------------------------------------------------------------------------\r\nUsing numpy.ndarray raises AttributeError: 'numpy.ndarray' object has no attribute 'values'\r\n-------------------------------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"invoking_mlflow_model_that_requires_multidimensional_input.py\", line 54, in <module>\r\n    print(m.predict(x.asnumpy()))\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 425, in predict\r\n    return self._model_impl.predict(data)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/gluon.py\", line 78, in predict\r\n    ndarray = mx.nd.array(df.values)\r\nAttributeError: 'numpy.ndarray' object has no attribute 'values'\r\n-------------------------------------------------------------------------------------------\r\nCan't construct pd.DataFrame with a >2d shaped array\r\n-------------------------------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"invoking_mlflow_model_that_requires_multidimensional_input.py\", line 63, in <module>\r\n    print(m.predict(pd.DataFrame(x.asnumpy())))\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/pandas/core/frame.py\", line 464, in __init__\r\n    mgr = init_ndarray(data, index, columns, dtype=dtype, copy=copy)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/pandas/core/internals/construction.py\", line 169, in init_ndarray\r\n    values = prep_ndarray(values, copy=copy)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/pandas/core/internals/construction.py\", line 295, in prep_ndarray\r\n    raise ValueError(\"Must pass 2-d input\")\r\nValueError: Must pass 2-d input\r\n-------------------------------------------------------------------------------------------\r\nFlattening the input with np.ravel is not acceptable\r\n-------------------------------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"invoking_mlflow_model_that_requires_multidimensional_input.py\", line 73, in <module>\r\n    print(m.predict(pd.DataFrame(np.ravel(x.asnumpy()))))\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 425, in predict\r\n    return self._model_impl.predict(data)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/gluon.py\", line 79, in predict\r\n    return pd.DataFrame(self.gluon_model(ndarray).asnumpy())\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 682, in __call__\r\n    out = self.forward(*args)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 1429, in forward\r\n    return self._call_cached_op(x, *args)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 1028, in _call_cached_op\r\n    out = self._cached_op(*cargs)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/_ctypes/ndarray.py\", line 148, in __call__\r\n    check_call(_LIB.MXInvokeCachedOpEx(\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/base.py\", line 246, in check_call\r\n    raise get_last_ffi_error()\r\nmxnet.base.MXNetError: MXNetError: Error in operator darknetv30_conv0_fwd: [14:32:19] src/operator/nn/convolution.cc:152: Check failed: dshp.ndim() == 4U (2 vs. 4) : Input data should be 4D in batch-num_filter-y-x\r\n-------------------------------------------------------------------------------------------\r\nUsing pd.DataFrame after reshaping also don't work\r\n-------------------------------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"invoking_mlflow_model_that_requires_multidimensional_input.py\", line 84, in <module>\r\n    print(m.predict(x_df))\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 425, in predict\r\n    return self._model_impl.predict(data)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mlflow/gluon.py\", line 79, in predict\r\n    return pd.DataFrame(self.gluon_model(ndarray).asnumpy())\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 682, in __call__\r\n    out = self.forward(*args)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 1429, in forward\r\n    return self._call_cached_op(x, *args)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/gluon/block.py\", line 1028, in _call_cached_op\r\n    out = self._cached_op(*cargs)\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/_ctypes/ndarray.py\", line 148, in __call__\r\n    check_call(_LIB.MXInvokeCachedOpEx(\r\n  File \"/home/mohammedi/Downloads/venv/lib/python3.8/site-packages/mxnet/base.py\", line 246, in check_call\r\n    raise get_last_ffi_error()\r\nmxnet.base.MXNetError: MXNetError: Error in operator darknetv30_conv0_fwd: [14:32:19] src/operator/nn/convolution.cc:152: Check failed: dshp.ndim() == 4U (2 vs. 4) : Input data should be 4D in batch-num_filter-y-x\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3570/reactions","total_count":9,"+1":9,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3570/timeline","performed_via_github_app":null,"state_reason":null}