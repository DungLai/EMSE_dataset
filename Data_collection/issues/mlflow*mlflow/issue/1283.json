{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1283","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1283/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1283/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1283/events","html_url":"https://github.com/mlflow/mlflow/issues/1283","id":444960469,"node_id":"MDU6SXNzdWU0NDQ5NjA0Njk=","number":1283,"title":"Avoid extensive copying of model files & artifacts in pyfunc","user":{"login":"dschoenleber","id":34317609,"node_id":"MDQ6VXNlcjM0MzE3NjA5","avatar_url":"https://avatars.githubusercontent.com/u/34317609?v=4","gravatar_id":"","url":"https://api.github.com/users/dschoenleber","html_url":"https://github.com/dschoenleber","followers_url":"https://api.github.com/users/dschoenleber/followers","following_url":"https://api.github.com/users/dschoenleber/following{/other_user}","gists_url":"https://api.github.com/users/dschoenleber/gists{/gist_id}","starred_url":"https://api.github.com/users/dschoenleber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dschoenleber/subscriptions","organizations_url":"https://api.github.com/users/dschoenleber/orgs","repos_url":"https://api.github.com/users/dschoenleber/repos","events_url":"https://api.github.com/users/dschoenleber/events{/privacy}","received_events_url":"https://api.github.com/users/dschoenleber/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-05-16T13:36:06Z","updated_at":"2019-05-28T20:08:00Z","closed_at":"2019-05-28T20:08:00Z","author_association":"NONE","active_lock_reason":null,"body":"### Issue\r\nI was trying out mlflow to serve a ML model with large model files (totalling about 2 GB) on sagemaker. I used `mlflow.pyfunc` to load the model data etc. specified via the artifacts-dictionary. \r\n\r\nHowever, when I built the Docker container and ran it locally, gunicorn always timed out (due to the hard-coded 60s timeout). \r\nObserving the `/tmp` folder in the Docker container during the run as well as digging into the mlflow code, I noticed that temporary folders containing the **full** model artifacts (in my case amounting to about 2 GB) were copied **twice** per worker, while the model files were already all lying safe and sound in the `/opt/ml/model` directory in the Docker container.\r\n\r\n### Reason\r\nThe reason for this behavior is that each worker calls upon initialization `pyfunc.load_pyfunc(\"/opt/ml/model/\")` (see `wsgi.py` in `mlflow/sagemaker/container/scoring_server`).\r\nIn `pyfunc.load_pyfunc`\r\ni) the model files are \"downloaded\" (copied to a temporary directory in `/tmp` via `local_model_path = _download_artifact_from_uri(artifact_uri=model_uri)`. Then, the `_load_pyfunc` in the pyfunc loader_module (`model.py`) is called. This again,\r\nii) copies all artifact files to a temporary directory with suffix \"artifacts\"\r\n\r\n### My workaround\r\nAs a quick fix for myself, I\r\ni) set `local_model_path = local_file_uri_to_path(model_uri)`in `mlflow/pyfunc/__init__.py`\r\nii) set `artifacts[saved_artifact_name] = os.path.join(model_path, saved_artifact_info[CONFIG_KEY_ARTIFACT_RELATIVE_PATH])` instead of `tmp_artifact_path` in `mlflow/pyfunc/model.py` and commented out the creation of `tmp_artifact_path` which involves `_copy_file_or_tree` to copy the artifact files.\r\n\r\n### Request\r\nSince I believe I'm not the only one working with larger model artifacts, I suggest improving the handling of the model artifacts. Besides, it might be reasonable to allow for a custom gunicorn timeout in case model initialization is more involved.","closed_by":{"login":"andrewmchen","id":4492809,"node_id":"MDQ6VXNlcjQ0OTI4MDk=","avatar_url":"https://avatars.githubusercontent.com/u/4492809?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewmchen","html_url":"https://github.com/andrewmchen","followers_url":"https://api.github.com/users/andrewmchen/followers","following_url":"https://api.github.com/users/andrewmchen/following{/other_user}","gists_url":"https://api.github.com/users/andrewmchen/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewmchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewmchen/subscriptions","organizations_url":"https://api.github.com/users/andrewmchen/orgs","repos_url":"https://api.github.com/users/andrewmchen/repos","events_url":"https://api.github.com/users/andrewmchen/events{/privacy}","received_events_url":"https://api.github.com/users/andrewmchen/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1283/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1283/timeline","performed_via_github_app":null,"state_reason":"completed"}