{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4693","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4693/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4693/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4693/events","html_url":"https://github.com/mlflow/mlflow/issues/4693","id":968289075,"node_id":"MDU6SXNzdWU5NjgyODkwNzU=","number":4693,"title":"[BUG] mlflow crashes randomly during training","user":{"login":"bugdary","id":57069624,"node_id":"MDQ6VXNlcjU3MDY5NjI0","avatar_url":"https://avatars.githubusercontent.com/u/57069624?v=4","gravatar_id":"","url":"https://api.github.com/users/bugdary","html_url":"https://github.com/bugdary","followers_url":"https://api.github.com/users/bugdary/followers","following_url":"https://api.github.com/users/bugdary/following{/other_user}","gists_url":"https://api.github.com/users/bugdary/gists{/gist_id}","starred_url":"https://api.github.com/users/bugdary/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bugdary/subscriptions","organizations_url":"https://api.github.com/users/bugdary/orgs","repos_url":"https://api.github.com/users/bugdary/repos","events_url":"https://api.github.com/users/bugdary/events{/privacy}","received_events_url":"https://api.github.com/users/bugdary/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-08-12T07:54:18Z","updated_at":"2021-08-17T11:16:21Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:  Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:Ubuntu 20.04.2 LTS\r\n- **MLflow installed from (source or binary)**: conda\r\n- **MLflow version (run ``mlflow --version``)**: 1.19.0\r\n- **Python version**: 3.7\r\n\r\n\r\n### Describe the problem\r\nI train a CNN (using pytorch) and try to log my metrics using Mlflow. For that, I ramped up a remote server in another linux machine, and in my current machine, I train the CNN.  In my remote server, I use sftp for the artifacts and postgresql for logging the metrics. \r\nThe CNN keeps training but in random epochs, the mlflow crashes the simulation with the attached error. \r\n\r\n### Code to reproduce issue\r\n\r\nremote_server_uri = <my other linux machine ip>  # set to your server URI\r\nmlflow.set_tracking_uri(remote_server_uri)\r\nex = \"tutorial2\"\r\n\r\nmlflow.create_experiment(ex, artifact_location=\"sftp://<my user>:<my pass>@<my other linux machine ip>/media/sftp/mlflow/artifacts\")\r\nmlflow.set_experiment(ex)\r\n\r\nand here comes my training code...\r\nThe command the crashes the simulation is \r\n\r\nmlflow.log_metric(\"train_loss\", loss.data.item())\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n\r\n```\r\n]\r\nEpoch 9: 100%|______________________________________________________________________________________________________________________________| 4315/4315 [14:30<00:00,  4.96batch/s, accuracy=84.6, loss=0.366]\r\n100%|________________________________________________________________________________________________________________________________________| 480/480 [00:03<00:00, 140.20batch/s, accuracy=71.4, loss=0.848]\r\nEpoch 10:  97%|_________________________________________________________________________________________________________________________    | 4166/4315 [14:10<00:30,  4.90batch/s, accuracy=68.8, loss=0.595]\r\nTraceback (most recent call last):\r\n  File \"/home/shlomi/projects/gesturedetection/MouthCoverDetection/scenarios/cnn_mouth_classifier/train.py\", line 95, in <module>\r\n    mlflow.log_metric(\"lr\", optimizer.param_groups[0][\"lr\"])\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/fluent.py\", line 441, in log_metric\r\n    MlflowClient().log_metric(run_id, key, value, int(time.time() * 1000), step or 0)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/client.py\", line 678, in log_metric\r\n    self._tracking_client.log_metric(run_id, key, value, timestamp, step)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/_tracking_service/client.py\", line 209, in log_metric\r\n    self.store.log_metric(run_id, metric)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/store/tracking/rest_store.py\", line 184, in log_metric\r\n    self._call_endpoint(LogMetric, req_body)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/store/tracking/rest_store.py\", line 56, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/utils/rest_utils.py\", line 170, in call_endpoint\r\n    response = verify_rest_response(response, endpoint)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/utils/rest_utils.py\", line 128, in verify_rest_response\r\n    raise MlflowException(\"%s. Response body: '%s'\" % (base_msg, response.text))\r\nmlflow.exceptions.MlflowException: API request to endpoint /api/2.0/mlflow/runs/log-metric failed with error code 403 != 200. Response body: '<!doctype html>\r\n<html>\r\n<head>\r\n<meta http-equiv=\"refresh\" content=\"0;url=http://7rx80271.ibosscloud.com/ibreports/ibp/bp.html?bu=http://10.189.***.***:8080/api/2.0/mlflow/runs/log-metric&bc=The%20requested%20URL%20cannot%20be%20accessed.&ip=10.189.***.***&er=ERR_ACCESS_DENIED\"/>\r\n</head>\r\n<body>\r\n</body>\r\n</html>\r\n'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/shlomi/projects/gesturedetection/MouthCoverDetection/scenarios/cnn_mouth_classifier/train.py\", line 114, in <module>\r\n    writer.close()\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/fluent.py\", line 110, in __exit__\r\n    end_run(RunStatus.to_string(status))\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/fluent.py\", line 291, in end_run\r\n    MlflowClient().set_terminated(run.info.run_id, status)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/client.py\", line 1438, in set_terminated\r\n    self._tracking_client.set_terminated(run_id, status, end_time)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/tracking/_tracking_service/client.py\", line 364, in set_terminated\r\n    run_id, run_status=RunStatus.from_string(status), end_time=end_time\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/store/tracking/rest_store.py\", line 140, in update_run_info\r\n    response_proto = self._call_endpoint(UpdateRun, req_body)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/store/tracking/rest_store.py\", line 56, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/utils/rest_utils.py\", line 170, in call_endpoint\r\n    response = verify_rest_response(response, endpoint)\r\n  File \"/home/shlomi/anaconda3/envs/pytorch17/lib/python3.7/site-packages/mlflow/utils/rest_utils.py\", line 128, in verify_rest_response\r\n    raise MlflowException(\"%s. Response body: '%s'\" % (base_msg, response.text))\r\nmlflow.exceptions.MlflowException: API request to endpoint /api/2.0/mlflow/runs/update failed with error code 403 != 200. Response body: '<!doctype html>\r\n<html>\r\n<head>\r\n<meta http-equiv=\"refresh\" content=\"0;url=http://7rx80271.ibosscloud.com/ibreports/ibp/bp.html?bu=http://10.189.***.***:8080/api/2.0/mlflow/runs/update&bc=The%20requested%20URL%20cannot%20be%20accessed.&ip=10.189.***.***&er=ERR_ACCESS_DENIED\"/>\r\n</head>\r\n<body>\r\n</body>\r\n</html>\r\n\r\n```\r\n\r\nand the logs from the server are :\r\n\r\n`\r\n\r\nAug 16 09:27:15 mlserv2 bash[52763]: /home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/pysftp/__init__.py:61: UserWarning: Failed to load HostKeys from /media/sftp/mlflow/artifacts/.ssh/known_hosts.  You will need to explicitly load HostKeys (cnopts.hostkeys.load(filename)) or disableHostKey checking (cnopts.hostkeys = None).\r\nAug 16 09:27:15 mlserv2 bash[52763]:   warnings.warn(wmsg, UserWarning)\r\nAug 16 09:27:15 mlserv2 bash[52763]: 2021/08/16 09:27:15 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/artifacts/list [GET]\r\nAug 16 09:27:15 mlserv2 bash[52763]: Traceback (most recent call last):\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/flask/app.py\", line 2070, in wsgi_app\r\nAug 16 09:27:15 mlserv2 bash[52763]:     response = self.full_dispatch_request()\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/flask/app.py\", line 1515, in full_dispatch_request\r\nAug 16 09:27:15 mlserv2 bash[52763]:     rv = self.handle_user_exception(e)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/flask/app.py\", line 1513, in full_dispatch_request\r\nAug 16 09:27:15 mlserv2 bash[52763]:     rv = self.dispatch_request()\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/flask/app.py\", line 1499, in dispatch_request\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 214, in wrapper\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return func(*args, **kwargs)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 487, in _list_artifacts\r\nAug 16 09:27:15 mlserv2 bash[52763]:     artifact_entities = _get_artifact_repo(run).list_artifacts(path)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 214, in wrapper\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return func(*args, **kwargs)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/server/handlers.py\", line 526, in _get_artifact_repo\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return get_artifact_repository(run.info.artifact_uri)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/store/artifact/artifact_repository_registry.py\", line 102, in get_artifact_repository\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return _artifact_repository_registry.get_artifact_repository(artifact_uri)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/store/artifact/artifact_repository_registry.py\", line 71, in get_artifact_repository\r\nAug 16 09:27:15 mlserv2 bash[52763]:     return repository(artifact_uri)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/mlflow/store/artifact/sftp_artifact_repo.py\", line 70, in __init__\r\nAug 16 09:27:15 mlserv2 bash[52763]:     self.sftp = pysftp.Connection(**self.config)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/pysftp/__init__.py\", line 132, in __init__\r\nAug 16 09:27:15 mlserv2 bash[52763]:     self._tconnect['hostkey'] = self._cnopts.get_hostkey(host)\r\nAug 16 09:27:15 mlserv2 bash[52763]:   File \"/home/mlserv2/anaconda3/envs/mlflow_env/lib/python3.6/site-packages/pysftp/__init__.py\", line 71, in get_hostkey\r\nAug 16 09:27:15 mlserv2 bash[52763]:     raise SSHException(\"No hostkey for host %s found.\" % host)\r\nAug 16 09:27:15 mlserv2 bash[52763]: paramiko.ssh_exception.SSHException: No hostkey for host 10.189.***.***found.\r\n\r\n\r\n`","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4693/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4693/timeline","performed_via_github_app":null,"state_reason":null}