{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1208","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1208/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1208/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1208/events","html_url":"https://github.com/mlflow/mlflow/issues/1208","id":441153611,"node_id":"MDU6SXNzdWU0NDExNTM2MTE=","number":1208,"title":"mlflow pyfunc serve doesn't correctly execute in the correct conda environment","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-05-07T10:14:39Z","updated_at":"2019-07-26T21:29:27Z","closed_at":"2019-07-26T21:29:27Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes, I provided the files below in \"Exact command to reproduce\".\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 18.04\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: `mlflow, version 0.9.0`\r\n- **Exact command to reproduce**:\r\n\r\nCreate a folder with the following files:\r\n\r\n_MLproject_\r\n\r\n```yaml\r\nname: Test project\r\nconda_env: conda.yml\r\nentry_points:\r\n    main:\r\n        command: python train.py\r\n```\r\n\r\n_conda.yml_\r\n\r\n```yaml\r\nname: test-env\r\ndependencies:\r\n  - pip:\r\n    - loguru\r\n    - mlflow\r\n```\r\n\r\n_train.py_\r\n\r\n```python\r\nfrom loguru import logger\r\nimport mlflow.pyfunc\r\n\r\nlogger.debug(\"Training\")\r\n\r\nmlflow.log_metric(\"test\", 4)\r\n\r\nmlflow.pyfunc.log_model(\r\n    \"model\",\r\n    \"predict\",\r\n    code_path=[\"predict.py\"],\r\n    conda_env=\"conda.yml\"\r\n)\r\n```\r\n\r\n_predict.py_\r\n\r\n```python\r\nfrom loguru import logger\r\n\r\nclass MockModel:\r\n    def predict(self):\r\n        logger.debug(\"Predict\")\r\n        return \"predictiono\"\r\n\r\ndef _load_pyfunc(datapath):\r\n    logger.debug(\"Load predict\")\r\n    return MockModel()\r\n```\r\n\r\nInside this newly created folder, run `mlflow run .`. It should complete successfuly.\r\n\r\nThen, run `mlflow pyfunc serve -m model -r <run_id>`. It should throw an error because it can't find the module `loguru`.\r\n\r\n### Describe the problem\r\n\r\nThe predict script can't find the module `loguru`. By looking at the logs, you can see that `mlflow` create the conda environment and re-execute the command inside this environment by doing: `source /home/fkaczynski/miniconda3/bin/activate mlflow-70df6080b570305b994f0bed58438eadd65de7bd && /usr/local/bin/mlflow pyfunc serve -m model -r <run-id> --no-conda`. You can see that the mlflow binary used is `/usr/local/bin/mlflow`, which is not the mlflow binary that is installed inside the conda environment.\r\n\r\nIf I execute manually in my terminal `source /home/fkaczynski/miniconda3/bin/activate mlflow-70df6080b570305b994f0bed58438eadd65de7bd && mlflow pyfunc serve -m model -r <run-id> --no-conda`, it works correctly.\r\n\r\n### Source code / logs\r\n\r\nWhen running `mlflow run .`:\r\n\r\n```\r\n2019/05/07 12:11:20 INFO mlflow.projects: === Created directory /tmp/tmp6pc54qdf for downloading remote URIs passed to arguments of type 'path' ===\r\n2019/05/07 12:11:20 INFO mlflow.projects: === Running command 'source /home/fkaczynski/miniconda3/bin/activate mlflow-70df6080b570305b994f0bed58438eadd65de7bd && python train.py' in run with ID 'f94b4eb806544e8ea03a72c754ca7877' === \r\n2019-05-07 12:11:21.521 | DEBUG    | __main__:<module>:4 - Training\r\n2019/05/07 12:11:21 INFO mlflow.projects: === Run (ID 'f94b4eb806544e8ea03a72c754ca7877') succeeded ===\r\n\r\n```\r\n\r\nWhen running `mlflow pyfunc run -m model -r f94b4eb806544e8ea03a72c754ca7877`:\r\n\r\n```\r\n2019/05/07 12:11:44 INFO mlflow.pyfunc.cli: === Running command 'source /home/fkaczynski/miniconda3/bin/activate mlflow-70df6080b570305b994f0bed58438eadd65de7bd && /usr/local/bin/mlflow pyfunc serve -m model -r f94b4eb806544e8ea03a72c754ca7877 --no-conda'\r\n2019/05/07 12:11:45 WARNING mlflow.pyfunc: The version of Python that the model was saved in, `Python 3.7.3`, differs from the version of Python that is currently running, `Python 3.6.7`, and may be incompatible\r\nTraceback (most recent call last):\r\n  File \"/usr/local/bin/mlflow\", line 10, in <module>\r\n    sys.exit(cli())\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 764, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 717, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 1137, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 1137, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 956, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/usr/local/lib/python3.6/dist-packages/click/core.py\", line 555, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.6/dist-packages/mlflow/pyfunc/cli.py\", line 71, in serve\r\n    app = scoring_server.init(load_pyfunc(model_path))\r\n  File \"/usr/local/lib/python3.6/dist-packages/mlflow/pyfunc/__init__.py\", line 288, in load_pyfunc\r\n    return importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/usr/lib/python3.6/importlib/__init__.py\", line 126, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 994, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 971, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 955, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 665, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 678, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/tmp/tmpijimfjo7/model/code/predict.py\", line 1, in <module>\r\n    from loguru import logger\r\nModuleNotFoundError: No module named 'loguru'\r\n```\r\n\r\nWhen running  `source /home/fkaczynski/miniconda3/bin/activate mlflow-70df6080b570305b994f0bed58438eadd65de7bd && /usr/local/bin/mlflow pyfunc serve -m model -r f94b4eb806544e8ea03a72c754ca7877 --no-conda`:\r\n\r\n```\r\n2019-05-07 12:12:23.561 | DEBUG    | predict:_load_pyfunc:9 - Load predict\r\n * Serving Flask app \"mlflow.pyfunc.scoring_server\" (lazy loading)\r\n * Environment: production\r\n   WARNING: Do not use the development server in a production environment.\r\n   Use a production WSGI server instead.\r\n * Debug mode: off\r\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\r\n```\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1208/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1208/timeline","performed_via_github_app":null,"state_reason":"completed"}