{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5480","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5480/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5480/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5480/events","html_url":"https://github.com/mlflow/mlflow/issues/5480","id":1166114525,"node_id":"I_kwDOCB5Jx85FgX7d","number":5480,"title":"[BUG] MLFLow proxy artifact does not work on blob azure","user":{"login":"antoinevokleber","id":44051139,"node_id":"MDQ6VXNlcjQ0MDUxMTM5","avatar_url":"https://avatars.githubusercontent.com/u/44051139?v=4","gravatar_id":"","url":"https://api.github.com/users/antoinevokleber","html_url":"https://github.com/antoinevokleber","followers_url":"https://api.github.com/users/antoinevokleber/followers","following_url":"https://api.github.com/users/antoinevokleber/following{/other_user}","gists_url":"https://api.github.com/users/antoinevokleber/gists{/gist_id}","starred_url":"https://api.github.com/users/antoinevokleber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antoinevokleber/subscriptions","organizations_url":"https://api.github.com/users/antoinevokleber/orgs","repos_url":"https://api.github.com/users/antoinevokleber/repos","events_url":"https://api.github.com/users/antoinevokleber/events{/privacy}","received_events_url":"https://api.github.com/users/antoinevokleber/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-03-11T07:59:25Z","updated_at":"2022-03-18T08:43:16Z","closed_at":"2022-03-18T08:43:16Z","author_association":"NONE","active_lock_reason":null,"body":"Hi All,\r\ni use MLflow 1.24.0 on kubernetes Server\r\n\r\non my docker image, i use python 3.8 \r\nmy script to launch server mflow : \r\n```\r\nmlflow server '--backend-store-uri=postgresql://********@10.0.1.15:5432/mlflow_db' --artifacts-destination wasbs://mlartifacts@********.blob.core.windows.net/ --serve-artifacts --host 0.0.0.0 --port 80\r\n```\r\n\r\nOn my client linux (python 3.6, debian 4.19), i use example mlflow ElasticnetWineModel to save model on my server with tracking uri of my server.\r\n\r\n\r\nI have some metrics, logs on the mlflow interface. However, I don't see any artifacts on the user interface MlFlow and the azure blob.\r\nWhen on my client, i have added environment variable (AZURE_STORAGE_ACCESS_KEY and AZURE_STORAGE_CONNECTION_STRING) for the connection on blob azure, the artifacts are visible from UI and blob Azure.\r\n\r\nThis seems to mean that the proxy process is not working. It is always the client that sends the artifacts, right?\r\n\r\ni have try with different option to launch the server (--default-artifact-root wasbs://mlartifacts@********.blob.core.windows.net/)\r\n\r\nrun without env variable:\r\n```\r\nElasticnet model (alpha=0.500000, l1_ratio=0.500000):\r\n  RMSE: 0.793164022927685\r\n  MAE: 0.6271946374319586\r\n  R2: 0.10862644997792636\r\nwasbs://mlartifacts@pocmlopsvelo.blob.core.windows.net/6/955dc732b1a2484d9aa0dcc2b6b838d0/artifacts\r\nWARNING:azure.identity._credentials.chained:DefaultAzureCredential failed to retrieve a token from the included credentials.\r\nAttempted credentials:\r\n        EnvironmentCredential: EnvironmentCredential authentication unavailable. Environment variables are not fully configured.\r\nVisit https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot to troubleshoot.this issue.\r\n        ManagedIdentityCredential: ManagedIdentityCredential authentication unavailable. The requested identity has not been assigned to this resource.\r\n        SharedTokenCacheCredential: SharedTokenCacheCredential authentication unavailable. No accounts were found in the cache.\r\n        VisualStudioCodeCredential: Failed to get Azure user details from Visual Studio Code.\r\n        AzureCliCredential: ERROR: CLIInternalError: The command failed with an unexpected error. Here is the traceback:\r\nERROR: Get Token request returned http error: 400 and server response: {\"error\":\"invalid_grant\",\"error_description\":\"AADSTS700082: The refresh token has expired due to inactivity. The token was issued on 2021-05-17T07:28:42.0742305Z and was inactive for 90.00:00:00.\\r\\nTrace ID: 93e04446-3703-4d99-8890-a5bc7c9cb300\\r\\nCorrelation ID: c372a377-3dcb-4fab-8c9b-d040c5fe4071\\r\\nTimestamp: 2022-03-11 07:53:48Z\",\"error_codes\":[700082],\"timestamp\":\"2022-03-11 07:53:48Z\",\"trace_id\":\"93e04446-3703-4d99-8890-a5bc7c9cb300\",\"correlation_id\":\"c372a377-3dcb-4fab-8c9b-d040c5fe4071\",\"error_uri\":\"https://login.microsoftonline.com/error?code=700082\"}\r\nTraceback (most recent call last):\r\n  File \"/opt/az/lib/python3.6/site-packages/knack/cli.py\", line 215, in invoke\r\n    cmd_result = self.invocation.execute(args)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/commands/__init__.py\", line 654, in execute\r\n    raise ex\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/commands/__init__.py\", line 718, in _run_jobs_serially\r\n    results.append(self._run_job(expanded_arg, cmd_copy))\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/commands/__init__.py\", line 711, in _run_job\r\n    six.reraise(*sys.exc_info())\r\n  File \"/opt/az/lib/python3.6/site-packages/six.py\", line 703, in reraise\r\n    raise value\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/commands/__init__.py\", line 688, in _run_job\r\n    result = cmd_copy(params)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/commands/__init__.py\", line 325, in __call__\r\n    return self.handler(*args, **kwargs)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/__init__.py\", line 784, in default_command_handler\r\n    return op(**command_args)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/command_modules/profile/custom.py\", line 75, in get_access_token\r\n    creds, subscription, tenant = profile.get_raw_token(subscription=subscription, resource=resource, tenant=tenant)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/_profile.py\", line 650, in get_raw_token\r\n    tenant_dest, resource)\r\n  File \"/opt/az/lib/python3.6/site-packages/azure/cli/core/_profile.py\", line 1019, in retrieve_token_for_user\r\n    token_entry = context.acquire_token(resource, username, _CLIENT_ID)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/authentication_context.py\", line 145, in acquire_token\r\n    return self._acquire_token(token_func)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/authentication_context.py\", line 128, in _acquire_token\r\n    return token_func(self)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/authentication_context.py\", line 143, in token_func\r\n    return token_request.get_token_from_cache_with_refresh(user_id)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/token_request.py\", line 347, in get_token_from_cache_with_refresh\r\n    return self._find_token_from_cache()\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/token_request.py\", line 127, in _find_token_from_cache\r\n    return self._cache_driver.find(cache_query)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/cache_driver.py\", line 199, in find\r\n    is_resource_tenant_specific)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/cache_driver.py\", line 184, in _refresh_entry_if_necessary\r\n    return self._acquire_new_token_from_mrrt(entry)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/cache_driver.py\", line 160, in _acquire_new_token_from_mrrt\r\n    token_response = self._refresh_function(entry, self._resource)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/token_request.py\", line 137, in _get_token_with_token_response\r\n    return self._get_token_with_refresh_token(refresh_token, resource, None)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/token_request.py\", line 339, in _get_token_with_refresh_token\r\n    return self._oauth_get_token(oauth_parameters)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/token_request.py\", line 112, in _oauth_get_token\r\n    return client.get_token(oauth_parameters)\r\n  File \"/opt/az/lib/python3.6/site-packages/adal/oauth2_client.py\", line 289, in get_token\r\n    raise AdalError(return_error_string, error_response)\r\nadal.adal_error.AdalError: Get Token request returned http error: 400 and server response: {\"error\":\"invalid_grant\",\"error_description\":\"AADSTS700082: The refresh token has expired due to inactivity. The token was issued on 2021-05-17T07:28:42.0742305Z and was inactive for 90.00:00:00.\\r\\nTrace ID: 93e04446-3703-4d99-8890-a5bc7c9cb300\\r\\nCorrelation ID: c372a377-3dcb-4fab-8c9b-d040c5fe4071\\r\\nTimestamp: 2022-03-11 07:53:48Z\",\"error_codes\":[700082],\"timestamp\":\"2022-03-11 07:53:48Z\",\"trace_id\":\"93e04446-3703-4d99-8890-a5bc7c9cb300\",\"correlation_id\":\"c372a377-3dcb-4fab-8c9b-d040c5fe4071\",\"error_uri\":\"https://login.microsoftonline.com/error?code=700082\"}\r\nTo open an issue, please run: 'az feedback'\r\n\r\nTo mitigate this issue, please refer to the troubleshooting guidelines here at https://aka.ms/azsdk/python/identity/defaultazurecredential/troubleshoot.\r\n\r\n```\r\n\r\nthe artifacts are nt present on the blob azure.\r\n\r\n\r\nRun with Env variable to access blob azure:\r\n\r\n**Hint : the variable AZURE_STORAGE_ACCESS_KEy is not necessary. but we need AZURE_STORAGE_CONNECTION_STRING. i think it's a problem. In a proxy process for me, the storage of artifacts is transparent and not directly accessible.**\r\n```\r\nexport AZURE_STORAGE_CONNECTION_STRING='*************************intSuffix=core.windows.net'\r\nexport AZURE_STORAGE_ACCESS_KEY='************'\r\npython train.py 0.5 0.5\r\nElasticnet model (alpha=0.500000, l1_ratio=0.500000):\r\n  RMSE: 0.793164022927685\r\n  MAE: 0.6271946374319586\r\n  R2: 0.10862644997792636\r\n\r\nwasbs://mlartifacts@pocmlopsvelo.blob.core.windows.net/6/6e0786f6c4c54d36b629543aaad25fe1/artifacts\r\nRegistered model 'ElasticnetWineModel' already exists. Creating a new version of this model...\r\n2022/03/11 07:56:17 INFO mlflow.tracking._model_registry.client: Waiting up to 300 seconds for model version to finish creation.                     Model name: ElasticnetWineModel, version 11\r\nCreated version '11' of model 'ElasticnetWineModel'.\r\n```\r\n\r\nthe artifacts are in this case present on the blob\r\n\r\nOn the mlflow Ui, I can see the artifact model. the server has access to the azure blob.\r\n![image](https://user-images.githubusercontent.com/44051139/157826874-18149755-c6a3-4ca0-be75-696f1a90d2ce.png)\r\n\r\n\r\nthanks for your help\r\n\r\n \r\n\r\n\r\n","closed_by":{"login":"antoinevokleber","id":44051139,"node_id":"MDQ6VXNlcjQ0MDUxMTM5","avatar_url":"https://avatars.githubusercontent.com/u/44051139?v=4","gravatar_id":"","url":"https://api.github.com/users/antoinevokleber","html_url":"https://github.com/antoinevokleber","followers_url":"https://api.github.com/users/antoinevokleber/followers","following_url":"https://api.github.com/users/antoinevokleber/following{/other_user}","gists_url":"https://api.github.com/users/antoinevokleber/gists{/gist_id}","starred_url":"https://api.github.com/users/antoinevokleber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antoinevokleber/subscriptions","organizations_url":"https://api.github.com/users/antoinevokleber/orgs","repos_url":"https://api.github.com/users/antoinevokleber/repos","events_url":"https://api.github.com/users/antoinevokleber/events{/privacy}","received_events_url":"https://api.github.com/users/antoinevokleber/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5480/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5480/timeline","performed_via_github_app":null,"state_reason":"completed"}