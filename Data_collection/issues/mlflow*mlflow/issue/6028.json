{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6028","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6028/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6028/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6028/events","html_url":"https://github.com/mlflow/mlflow/issues/6028","id":1260548307,"node_id":"I_kwDOCB5Jx85LInDT","number":6028,"title":"[BUG] `load_model()` adding code directories to system path that shouldn't be added to path","user":{"login":"jhallard","id":7551586,"node_id":"MDQ6VXNlcjc1NTE1ODY=","avatar_url":"https://avatars.githubusercontent.com/u/7551586?v=4","gravatar_id":"","url":"https://api.github.com/users/jhallard","html_url":"https://github.com/jhallard","followers_url":"https://api.github.com/users/jhallard/followers","following_url":"https://api.github.com/users/jhallard/following{/other_user}","gists_url":"https://api.github.com/users/jhallard/gists{/gist_id}","starred_url":"https://api.github.com/users/jhallard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhallard/subscriptions","organizations_url":"https://api.github.com/users/jhallard/orgs","repos_url":"https://api.github.com/users/jhallard/repos","events_url":"https://api.github.com/users/jhallard/events{/privacy}","received_events_url":"https://api.github.com/users/jhallard/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022851725,"node_id":"MDU6TGFiZWwyMDIyODUxNzI1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docker","name":"area/docker","color":"ede978","default":false,"description":"Docker use anywhere, such as MLprojects and MLmodels"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-06-04T00:44:47Z","updated_at":"2022-10-31T23:34:38Z","closed_at":"2022-08-12T20:15:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n1.26.1\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.02\r\n- **Python version**: 3.8\r\n- **yarn version, if running the dev UI**: N/A\r\n\r\n\r\n### Describe the problem\r\n\r\n## Overview\r\n\r\nThe main problem is that MLflow is adding _all directories_ under the `/code` directory to the system path, which is not what one would always expect to be the case. This is causing imports to break / collide in a way that doesn't otherwise happen when running the same code outside of MLflow. It seems to me that one normally expects the top-level modules to be on the system path i.e. that only `<model_directory>/code` should be on the path, and not everything underneath it.\r\n\r\n## Minimum Reproducible Example\r\n\r\nSee attached file for MLflow that this can be reproduced with:\r\n[mlflow-issue-test.zip](https://github.com/mlflow/mlflow/files/8836294/mlflow-issue-test.zip)\r\n\r\n#### Model Structure\r\n```\r\nmlflow-issue-test\r\n├── code\r\n│   ├── dir_one\r\n│   │   ├── entrypoint.py\r\n│   │   └── __init__.py\r\n│   └── dir_two\r\n│       ├── redis.py\r\n│       └── __init__.py\r\n├── conda.yml\r\n├── data\r\n└── MLmodel\r\n\r\n```\r\n\r\n#### Problem Setup\r\n\r\nI have two directories in this model, `dir_one` and `dir_two`. `dir_one/entrypoint.py` is the entrypoint to the model and is pointed to by the `MLmodel` entrypoint field. The problem is that this entrypoint is going to try to import a 3rd party dependency (in this case, `redis`) that has a name that collides with the name of a file inside of another directory, `code/dir_two`. \r\n\r\nUnder normal operation this doesn't matter since `dir_two/redis.py` isn't on the system path - it can only be imported by doing `from dir_two import redis`. However, since MLflow adds *all* directories under `/code` to the system path, this import is now conflicting with the system import and is breaking inference for us. Specifically, [this code](https://github.com/mlflow/mlflow/blob/master/mlflow/utils/model_utils.py#L120) is the offending logic.\r\n\r\n#### Example Code\r\n\r\n`code/dir_one/entrypoint.py`: the entrypoint\r\n```python\r\nimport mlflow\r\nimport pandas as pd\r\n\r\n# This should import the system redis-py \"redis\"\r\n# but it actually grabs `/code/dir_two/redis.py` because\r\n# MLflow messes with the import paths\r\nimport redis\r\n\r\nclass _ModelWrapper(mlflow.pyfunc.PythonModel):\r\n    def predict(self, input_df: pd.DataFrame) -> pd.DataFrame:\r\n        # Toy predict example\r\n        return input_df\r\n\r\ndef _load_pyfunc(data_path: str) -> _ModelWrapper:\r\n    return _ModelWrapper()\r\n```\r\n\r\n`code/dir_two/redis.py`: the colliding file\r\n```python\r\n# This file should not be imported!\r\n\r\nraise RuntimeError(f\"code/dir_two/redis.py has been imported!\")\r\n```\r\n\r\n`MLmodel`\r\n```yaml\r\nflavors:\r\n  python_function:\r\n    code: code\r\n    data: data\r\n    env: conda.yml\r\n    loader_module: dir_one.entrypoint\r\nmodel_uuid: 66a6a42db8444965b7dae6ce6163549d\r\nutc_time_created: '2022-06-03 20:49:12.836282'\r\n```\r\n\r\n#### Running the Example\r\n\r\n```\r\n>>> mlflow.pyfunc.load_model(\"mlflow-issue-test\")\r\n2022/06/04 00:38:36 WARNING mlflow.pyfunc: The specified model does not have a specified Python version. It may be incompatible with the version of Python that is currently running: Python 3.8.0\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/ubuntu/.env/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 735, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/usr/lib/python3.8/importlib/__init__.py\", line 127, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1014, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 991, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 975, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 671, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 783, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/tmp/mlflow-issue-test/code/dir_one/entrypoint.py\", line 7, in <module>\r\n    import redis\r\n  File \"/tmp/mlflow-issue-test/code/dir_two/redis.py\", line 4, in <module>\r\n    raise RuntimeError(f\"code/dir_two/redis.py has been imported!\")\r\nRuntimeError: code/dir_two/redis.py has been imported!\r\n```\r\n\r\n#### Example Breakdown\r\n\r\nNotice that when the entrypoint code calls `import redis`, it ends up importing `code/dir_two/redis.py` instead of the system `redis` module that would be expected. It's not expected that all files under parallel directories are magically on the system path.\r\n\r\n\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\nSee attached file for MLflow that this can be reproduced with:\r\n[mlflow-issue-test.zip](https://github.com/mlflow/mlflow/files/8836294/mlflow-issue-test.zip)\r\n\r\nSimple unzip the file as an MLflow model and then try to load the model\r\n\r\n```bash\r\nunzip mlflow-issue-test.zip -d mlflow-issue-test\r\npython3\r\n```\r\n\r\n```python3\r\n>>> import mlflow\r\n>>> mlflow.pyfunc.load_model(\"mlflow-issue-test\")\r\n````\r\n\r\nProduces the outputs showed in the next section\r\n\r\n### Other info / logs\r\n\r\n```python\r\n>>> mlflow.pyfunc.load_model(\"mlflow-issue-test\")\r\n2022/06/04 00:38:36 WARNING mlflow.pyfunc: The specified model does not have a specified Python version. It may be incompatible with the version of Python that is currently running: Python 3.8.0\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/ubuntu/.env/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 735, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/usr/lib/python3.8/importlib/__init__.py\", line 127, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1014, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 991, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 975, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 671, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 783, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/tmp/mlflow-issue-test/code/dir_one/entrypoint.py\", line 7, in <module>\r\n    import redis\r\n  File \"/tmp/mlflow-issue-test/code/dir_two/redis.py\", line 4, in <module>\r\n    raise RuntimeError(f\"code/dir_two/redis.py has been imported!\")\r\nRuntimeError: code/dir_two/redis.py has been imported!\r\n```\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [X] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6028/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6028/timeline","performed_via_github_app":null,"state_reason":"completed"}