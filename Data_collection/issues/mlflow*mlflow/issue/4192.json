{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4192","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4192/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4192/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4192/events","html_url":"https://github.com/mlflow/mlflow/issues/4192","id":837822715,"node_id":"MDU6SXNzdWU4Mzc4MjI3MTU=","number":4192,"title":"[BUG] Incorect path used in list_artifacts with a FTP artifact store on a windows host combined with a MLflow server on a linux host","user":{"login":"nicolas-renard","id":62021868,"node_id":"MDQ6VXNlcjYyMDIxODY4","avatar_url":"https://avatars.githubusercontent.com/u/62021868?v=4","gravatar_id":"","url":"https://api.github.com/users/nicolas-renard","html_url":"https://github.com/nicolas-renard","followers_url":"https://api.github.com/users/nicolas-renard/followers","following_url":"https://api.github.com/users/nicolas-renard/following{/other_user}","gists_url":"https://api.github.com/users/nicolas-renard/gists{/gist_id}","starred_url":"https://api.github.com/users/nicolas-renard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicolas-renard/subscriptions","organizations_url":"https://api.github.com/users/nicolas-renard/orgs","repos_url":"https://api.github.com/users/nicolas-renard/repos","events_url":"https://api.github.com/users/nicolas-renard/events{/privacy}","received_events_url":"https://api.github.com/users/nicolas-renard/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-03-22T15:17:57Z","updated_at":"2021-03-24T16:01:41Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Debian 9\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.14.1\r\n- **Python version**: 3.7\r\n- **npm version, if running the dev UI**: \r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nWhen running MLflow server on a linux environment with an FTP artifact store on a windows environment, the UI can't display artifacts on a run page. It fails with a display message `Unable to list artifacts stored under for the current run. Please contact your tracking server administrator to notify them of this error, which can happen when the tracking server lacks permission to list artifacts under the current run's root artifact directory.`\r\nThe MLflow server logs display an error (complete log here under) saying that `the specified access path can't be found` regarding the artifact path using the value `artifact_store_path/[EXPERIMENT_ID]/[RUN_ID]/artifacts/artifacts/Sklearn` (notice the repeated \"artifacts\" in the path)\r\n\r\nThe python API `list_artifacts` functions fail with the same error.\r\n\r\nA precision : the artifacts are normally stored on the FTP. It's just the UI display and the API calls that fails.\r\n\r\nAfter some diging, I think I found the issue : \r\n- IMO, it comes from the fact that the FTP artifact store is on a windows host and that the MLflow server is on a Linux host\r\n- In that case, the `list_artifacts` method of the `FTPArtifactRepository` class in the `mlflow/store/artifact/ftp_artifact_repo.py` file fails\r\n- Indeed, in this case, at runtime, the `list_dir` object contains linux type paths (ex : `/path/to/artifact_store/1/c716604157c04a7b99552cde1b20d8a4/artifacts`), but then at line 104, the `ftp.nlst(list_dir)` call returns paths with a mix of linux and windows slash convention (because the artifact store is on a windows host) : `/path/to/artifact_store/1/c716604157c04a7b99552cde1b20d8a4/artifacts\\\\Sklearn`\r\n- Then because of this mix with Windows paths the `artifact_files = [os.path.basename(f) for f in artifact_files]` line ends up returning \"file names\" like `artifacts\\Sklearn` instead of just `Sklearn` which then explains why the path where the UI try to find the artifacts is erronous (the \"file name\" `artifacts\\Sklearn` is appended to the artifact base path `/path/to/artifact_store/1/c716604157c04a7b99552cde1b20d8a4/artifacts`, hence the repeated \"artifacts\" in the path)\r\n\r\nA quick hack would be to replace `\\\\` with `/` in paths, like in the function proposed here under, but there may be some side effects : \r\n```python\r\ndef list_artifacts(self, path=None):\r\n    with self.get_ftp_client() as ftp:\r\n        artifact_dir = self.path\r\n        list_dir = posixpath.join(artifact_dir, path) if path else artifact_dir\r\n        if not self._is_dir(ftp, list_dir):\r\n            return []\r\n        artifact_files = ftp.nlst(list_dir)\r\n        artifact_files = list(filter(lambda x: x != \".\" and x != \"..\", artifact_files))\r\n        ################## BUG CORRECTION ###################\r\n        artifact_files = [x.replace('\\\\', '/') for x in artifact_files]\r\n        ################## BUG CORRECTION END ###################\r\n        # Make sure artifact_files is a list of file names because ftp.nlst\r\n        # may return absolute paths.\r\n        artifact_files = [os.path.basename(f) for f in artifact_files]\r\n        infos = []\r\n        for file_name in artifact_files:\r\n            file_path = file_name if path is None else posixpath.join(path, file_name)\r\n            full_file_path = posixpath.join(list_dir, file_name)\r\n            if self._is_dir(ftp, full_file_path):\r\n                infos.append(FileInfo(file_path, True, None))\r\n            else:\r\n                size = self._size(ftp, full_file_path)\r\n                infos.append(FileInfo(file_path, False, size))\r\n    return infos\r\n```\r\n\r\nTo be more clean, we could use `ntpath.basename` instead of `os.path.basename`, but there would still be the caveat of linux files with name containing a `\\` (see https://stackoverflow.com/a/8384788).\r\n\r\nTo account for all cases, we might have to separate the linux and windows cases using `sys.platform`.\r\n\r\nAny ideas / opinions regarding this ?\r\n\r\n### Code to reproduce issue\r\n- FTP on a windows host\r\n- MLflow server on a windows host\r\n- Save an artifact on a run and try to display a list using the `MlflowClient().list_artifacts()` function or try to go on the Run UI page and to see artifacts on the UI\r\n\r\n### Other info / logs\r\nTraceback of error displayed on the MLflow server logs : \r\n```\r\n2021/03/19 09:06:55 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/artifacts/list [GET]\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 2447, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1952, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1821, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/_compat.py\", line 39, in reraise\r\n    raise value\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1950, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1936, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 214, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 487, in _list_artifacts\r\n    artifact_entities = _get_artifact_repo(run).list_artifacts(path)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 116, in list_artifacts\r\n    size = self._size(ftp, full_file_path)\r\n  File \"/usr/local/lib/python3.7/site-packages/mlflow/store/artifact/ftp_artifact_repo.py\", line 63, in _size\r\n    size = ftp.size(full_file_path)\r\n  File \"/usr/local/lib/python3.7/ftplib.py\", line 636, in size\r\n    resp = self.sendcmd('SIZE ' + filename)\r\n  File \"/usr/local/lib/python3.7/ftplib.py\", line 273, in sendcmd\r\n    return self.getresp()\r\n  File \"/usr/local/lib/python3.7/ftplib.py\", line 246, in getresp\r\n    raise error_perm(resp)\r\nftplib.error_perm: 550 /path/to/artifact_store/1/ab5998807dc8479397eb4f22132afae0/artifacts/artifacts/Sklearn: Le chemin d'accès spécifié est introuvable. \r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [x] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4192/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4192/timeline","performed_via_github_app":null,"state_reason":null}