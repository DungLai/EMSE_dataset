{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5979","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5979/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5979/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5979/events","html_url":"https://github.com/mlflow/mlflow/issues/5979","id":1251852043,"node_id":"I_kwDOCB5Jx85Knb8L","number":5979,"title":"[BUG] tracking metrics in multiple threadings style.","user":{"login":"Jingnan-Jia","id":34941987,"node_id":"MDQ6VXNlcjM0OTQxOTg3","avatar_url":"https://avatars.githubusercontent.com/u/34941987?v=4","gravatar_id":"","url":"https://api.github.com/users/Jingnan-Jia","html_url":"https://github.com/Jingnan-Jia","followers_url":"https://api.github.com/users/Jingnan-Jia/followers","following_url":"https://api.github.com/users/Jingnan-Jia/following{/other_user}","gists_url":"https://api.github.com/users/Jingnan-Jia/gists{/gist_id}","starred_url":"https://api.github.com/users/Jingnan-Jia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jingnan-Jia/subscriptions","organizations_url":"https://api.github.com/users/Jingnan-Jia/orgs","repos_url":"https://api.github.com/users/Jingnan-Jia/repos","events_url":"https://api.github.com/users/Jingnan-Jia/events{/privacy}","received_events_url":"https://api.github.com/users/Jingnan-Jia/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-29T10:40:47Z","updated_at":"2022-06-01T14:43:04Z","closed_at":"2022-06-01T14:43:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\n\nNo. I cannot contribute a bug fix at this time.\n\n### MLflow version\n\n1.26.1\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: CentOS 7.7\r\n- **Python version**:  3.8\r\n- **yarn version, if running the dev UI**:\r\n\n\n### Describe the problem\n\nI want to monitor GPU and CPU usage using mlflow. I used a seperate thread to monitor GPU and CPU information. \r\nHowever, it seems that mlflow does not support multi-thread log_metrics? \n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\n\r\nMy code is as follows.\r\n\r\n```\r\ndef record_cgpu_info(outfile) -> Tuple:\r\n    \"\"\"Record CPU and GPU information to `outfile`.\r\n\r\n    Args:\r\n        outfile: The format of `outfile` is: slurm-[JOB_ID].out\r\n\r\n    Returns:\r\n        gpu_name, gpu_usage, gpu_util\r\n\r\n    Examples:\r\n\r\n        >>> record_gpu_info('slurm-98234.out')\r\n\r\n    \"\"\"\r\n    t = threading.currentThread()\r\n    t.do_run = True\r\n\r\n    if outfile:\r\n        cpu_count = psutil.cpu_count()\r\n        log_param('cpu_count', cpu_count)\r\n\r\n        pid = os.getpid()\r\n        python_process = psutil.Process(pid)\r\n\r\n        jobid_gpuid = outfile.split('-')[-1]\r\n        tmp_split = jobid_gpuid.split('_')[-1]\r\n        if len(tmp_split) == 2:\r\n            gpuid = tmp_split[-1]\r\n        else:\r\n            gpuid = 0\r\n        nvidia_smi.nvmlInit()\r\n        handle = nvidia_smi.nvmlDeviceGetHandleByIndex(gpuid)\r\n        gpuname = nvidia_smi.nvmlDeviceGetName(handle)\r\n        gpuname = gpuname.decode(\"utf-8\")\r\n        log_param('gpuname', gpuname)\r\n        # log_dict['gpuname'] = gpuname\r\n\r\n        # log_dict['gpu_mem_usage'] = gpu_mem_usage\r\n        # gpu_util = 0\r\n        i = 0\r\n        period = 2  # 2 seconds\r\n        while i<60*20:  # stop signal passed from t, monitor 20 minutes\r\n            if t.do_run:\r\n                memoryUse = python_process.memory_info().rss / 2. ** 30  # memory use in GB...I think\r\n                log_metric('cpu_mem_used_GB_in_process_rss', memoryUse, step=i)\r\n                memoryUse = python_process.memory_info().vms / 2. ** 30  # memory use in GB...I think\r\n                log_metric('cpu_mem_used_GB_in_process_vms', memoryUse, step=i)\r\n                cpu_percent = psutil.cpu_percent()\r\n                log_metric('cpu_util_used_percent', cpu_percent, step=i)\r\n                cpu_mem_used = psutil.virtual_memory().percent\r\n                log_metric('cpu_mem_used_percent', cpu_mem_used, step=i)\r\n\r\n                res = nvidia_smi.nvmlDeviceGetUtilizationRates(handle)\r\n                log_metric(\"gpu_util\", res.gpu, step=i)\r\n\r\n                info = nvidia_smi.nvmlDeviceGetMemoryInfo(handle)\r\n                gpu_mem_used = _bytes_to_megabytes(info.used)\r\n                log_metric('gpu_mem_used_MB', gpu_mem_used, step=i)\r\n\r\n                time.sleep(period)\r\n                i += period\r\n            else:\r\n                print('record_cgpu_info do_run is True, let stop the process')\r\n                break\r\n        print('It is time to stop this process: record_cgpu_info')\r\n        return None\r\n\r\n    else:\r\n        print('outfile is None, can not show GPU memory info')\r\n        return None, None, None\r\n\r\ndef run():\r\n    ......\r\n\r\nmlflow.set_experiment(\"ex1\")\r\noutfile = 'slurm-32123.out'\r\nwith mlflow.start_run(run_name='run1'):\r\n    p1 = threading.Thread(target=record_cgpu_info, args=(outfile,))\r\n    p1.start()\r\n    run()  \r\n```\r\n\n\n### Other info / logs\n\nThe code works well most times. But sometimes the error occured: \r\n```\r\nException in thread Thread-3:\r\nTraceback (most recent call last):\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/threading.py\", line 932, in _bootstrap_inner\r\n    self.run()\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/threading.py\", line 870, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/data1/jjia/ssc_scoring/ssc_scoring/../ssc_scoring/mymodules/tool.py\", line 603, in record_cgpu_info\r\n    log_metric('cpu_mem_used_GB_in_process_vms', memoryUse, step=i)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/fluent.py\", line 583, in log_metric\r\n    MlflowClient().log_metric(run_id, key, value, int(time.time() * 1000), step or 0)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 690, in log_metric\r\n    self._tracking_client.log_metric(run_id, key, value, timestamp, step)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 226, in log_metric\r\n    self.store.log_metric(run_id, metric)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 191, in log_metric\r\n    self._call_endpoint(LogMetric, req_body)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 56, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 256, in call_endpoint\r\n    response = verify_rest_response(response, endpoint)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 185, in verify_rest_response\r\n    raise RestException(json.loads(response.text))\r\nmlflow.exceptions.RestException: BAD_REQUEST: (sqlite3.OperationalError) database is locked\r\n[SQL: SELECT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id \r\nFROM runs \r\nWHERE runs.run_uuid = ?]\r\n[parameters: ('7a4be02f5f0b4eecb6b07d47f075646b',)]\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\r\n\r\n```\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"Jingnan-Jia","id":34941987,"node_id":"MDQ6VXNlcjM0OTQxOTg3","avatar_url":"https://avatars.githubusercontent.com/u/34941987?v=4","gravatar_id":"","url":"https://api.github.com/users/Jingnan-Jia","html_url":"https://github.com/Jingnan-Jia","followers_url":"https://api.github.com/users/Jingnan-Jia/followers","following_url":"https://api.github.com/users/Jingnan-Jia/following{/other_user}","gists_url":"https://api.github.com/users/Jingnan-Jia/gists{/gist_id}","starred_url":"https://api.github.com/users/Jingnan-Jia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jingnan-Jia/subscriptions","organizations_url":"https://api.github.com/users/Jingnan-Jia/orgs","repos_url":"https://api.github.com/users/Jingnan-Jia/repos","events_url":"https://api.github.com/users/Jingnan-Jia/events{/privacy}","received_events_url":"https://api.github.com/users/Jingnan-Jia/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5979/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5979/timeline","performed_via_github_app":null,"state_reason":"completed"}