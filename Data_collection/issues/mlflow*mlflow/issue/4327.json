{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4327","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4327/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4327/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4327/events","html_url":"https://github.com/mlflow/mlflow/issues/4327","id":878618818,"node_id":"MDU6SXNzdWU4Nzg2MTg4MTg=","number":4327,"title":"Can't log artifacts on remote server - probably '--default-artifact-root' issue [BUG]","user":{"login":"wodecki","id":14348685,"node_id":"MDQ6VXNlcjE0MzQ4Njg1","avatar_url":"https://avatars.githubusercontent.com/u/14348685?v=4","gravatar_id":"","url":"https://api.github.com/users/wodecki","html_url":"https://github.com/wodecki","followers_url":"https://api.github.com/users/wodecki/followers","following_url":"https://api.github.com/users/wodecki/following{/other_user}","gists_url":"https://api.github.com/users/wodecki/gists{/gist_id}","starred_url":"https://api.github.com/users/wodecki/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wodecki/subscriptions","organizations_url":"https://api.github.com/users/wodecki/orgs","repos_url":"https://api.github.com/users/wodecki/repos","events_url":"https://api.github.com/users/wodecki/events{/privacy}","received_events_url":"https://api.github.com/users/wodecki/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-05-07T08:44:52Z","updated_at":"2021-05-28T07:35:40Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 20.10\r\n- **MLflow installed from (source or binary)**: binary (pip install mlflow)\r\n- **MLflow version (run ``mlflow --version``)**: 1.16.0\r\n- **Python version**: 3.8.5.\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: \r\n\r\n### Describe the problem\r\nMy goal is to configure ML Flow to run on a remote Linux server, with logs stored in the PostgreSQL database and artifacts in /home/aw/mlfow/mllogs, where \"aw\" is my user name with root privileges.\r\n\r\nWhen I run my simple python code (see section below):\r\n- when it's last line (\"mlflow.log_artifact(\"features.txt\")) is commented out: I get no errors in Python, but when I enter log details via browser, in the artifact section I get the warning: \"Unable to list artifacts stored undersftp://mlflow_user@194.39.141.27:~/mlflow/mlruns/0/d1eb9ce83b6b4ede96a9ea5203c097da/artifacts\"\r\n- in case the last line is active, python compiler returns a long list of errors, ending with \"ValueError: Port could not be cast to integer value as '~'\"\r\n\r\nI tried running the server from the CLI in many different ways, each time changing the --default-artifact-root parameter (see section below). Interestingly, the printout of the mlflow.get_artifact_uri() variable from the Python code remains the same, despite changes in the CLI server parameters: it always shows up as \r\nsftp://mlflow_user@94.39.141.27:~/mlflow/mlruns/0/c613c110839946a3adc198377cc82c0c/artifacts\r\n\r\nSo, it looks like there is a problem of setting this parameter up during MLFlow server run from CLI. Maybe it's cached somewhere? Linux server reboot doesn't help.\r\n\r\nMy apologies if it's my mistake, not a BUG: I feel more a DataScientist than programmer...\r\n\r\n### Code to reproduce issue\r\nServer CLI run (credentials are just examples):\r\n\r\noption 1 (based on https://towardsdatascience.com/setup-mlflow-in-production-d72aecde7fef):\r\nmlflow server --backend-store-uri postgresql://mlflow_user:mlflow321@localhost/mlflow_db --default-artifact-root sftp://mlflow_user@194.39.141.27:~/mlflow/mlruns -h 0.0.0.0 -p 8000&\r\n\r\noptions 2.1 and 2.2 (aw is my user name on the machine, with root privileges):\r\nmlflow server --backend-store-uri postgresql://mlflow_user:mlflow321@localhost/mlflow_db --default-artifact-root sftp://aw:aw_pass@194.39.141.27:~/mlflow/mlruns -h 0.0.0.0 -p 8000&\r\n\r\nmlflow server --backend-store-uri postgresql://mlflow_user:mlflow321@localhost/mlflow_db --default-artifact-root sftp://aw:@194.39.141.27:~/home/aw/mlflow/mlruns -h 0.0.0.0 -p 8000&\r\n\r\noption 3:\r\nmlflow server --backend-store-uri postgresql://mlflow_user:mlflow321@localhost/mlflow_db --default-artifact-root sftp://mlflow_user:mlflow_pass#@194.39.141.27:~/mlflow/mlruns -h 0.0.0.0 -p 8000&\r\n\r\n\r\nPython code:\r\n```\r\nimport mlflow\r\n\r\nif __name__ == \"__main__\":\r\n    mlflow.set_tracking_uri(\"http://194.39.141.27:8000\") #hostname IP here is just an example\r\n\r\n    features = \"rooms, zipcode, median_price, school_rating, transport\"\r\n    with open(\"features.txt\", 'w') as f:\r\n        f.write(features)\r\n\r\n    with mlflow.start_run():\r\n\r\n        tracking_uri = mlflow.get_tracking_uri()\r\n        artifact_uri = mlflow.get_artifact_uri()\r\n        print(\"Tracking uri: {}\".format(tracking_uri))\r\n        print(\"Artifact uri: {}\".format(artifact_uri))\r\n\r\n        mlflow.log_artifact(\"features.txt\")\r\n```\r\n\r\n\r\n### Other info / logs\r\nPython compiler log:\r\n\r\nTraceback (most recent call last):\r\n  File \"1.py\", line 18, in <module>\r\n    mlflow.log_artifact(\"features.txt\")\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/tracking/fluent.py\", line 544, in log_artifact\r\n    MlflowClient().log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 903, in log_artifact\r\n    self._tracking_client.log_artifact(run_id, local_path, artifact_path)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 271, in log_artifact\r\n    artifact_repo = self._get_artifact_repo(run_id)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 262, in _get_artifact_repo\r\n    return get_artifact_repository(artifact_uri)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repository_registry.py\", line 102, in get_artifact_repository\r\n    return _artifact_repository_registry.get_artifact_repository(artifact_uri)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repository_registry.py\", line 71, in get_artifact_repository\r\n    return repository(artifact_uri)\r\n  File \"/home/aw/anaconda3/lib/python3.8/site-packages/mlflow/store/artifact/sftp_artifact_repo.py\", line 32, in __init__\r\n    \"port\": parsed.port,\r\n  File \"/home/aw/anaconda3/lib/python3.8/urllib/parse.py\", line 174, in port\r\n    raise ValueError(message) from None\r\nValueError: Port could not be cast to integer value as '~'\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n\r\nLanguage \r\n- Python","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4327/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4327/timeline","performed_via_github_app":null,"state_reason":null}