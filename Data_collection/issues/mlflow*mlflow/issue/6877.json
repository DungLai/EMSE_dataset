{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6877","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6877/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6877/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6877/events","html_url":"https://github.com/mlflow/mlflow/issues/6877","id":1384718693,"node_id":"I_kwDOCB5Jx85SiSFl","number":6877,"title":"[BUG] Unable to log complete sklearn model to mlflow","user":{"login":"erjieyong","id":109052378,"node_id":"U_kgDOBoAB2g","avatar_url":"https://avatars.githubusercontent.com/u/109052378?v=4","gravatar_id":"","url":"https://api.github.com/users/erjieyong","html_url":"https://github.com/erjieyong","followers_url":"https://api.github.com/users/erjieyong/followers","following_url":"https://api.github.com/users/erjieyong/following{/other_user}","gists_url":"https://api.github.com/users/erjieyong/gists{/gist_id}","starred_url":"https://api.github.com/users/erjieyong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erjieyong/subscriptions","organizations_url":"https://api.github.com/users/erjieyong/orgs","repos_url":"https://api.github.com/users/erjieyong/repos","events_url":"https://api.github.com/users/erjieyong/events{/privacy}","received_events_url":"https://api.github.com/users/erjieyong/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-09-24T15:40:51Z","updated_at":"2022-11-03T16:00:16Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\n1.29\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Windows 11\r\n- **Python version**:  3.8.5\r\n- **yarn version, if running the dev UI**:\r\n- Using jupyter lab with sklearn 0.23.2\r\n\n\n### Describe the problem\n\nMlflow was activated as per following:\r\n\r\n    import mlflow \r\n    mlflow.set_tracking_uri(\"sqlite:///mlflow.db\") \r\n    mlflow.set_experiment(\"project-2\") \r\n    mlflow.autolog()\r\n\r\nOutput message after activation was fine as per following:\r\n\r\n    2022/09/24 18:00:58 INFO mlflow.tracking.fluent: Autologging successfully enabled for statsmodels.\r\n    2022/09/24 18:00:58 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.\r\n    2022/09/24 18:00:58 INFO mlflow.tracking.fluent: Autologging successfully enabled for lightgbm.\r\n\r\nHowever, when i tried to run the following regression model. \r\n\r\n    lr_baseline = LinearRegression()\r\n    lr_baseline.fit(X_train, y_train)\r\n    y_pred = lr_baseline.predict(X_test)\r\n    \r\n    with mlflow.start_run():\r\n        baseline_train_r2 = lr_baseline.score(X_train, y_train)\r\n        baseline_test_r2 = lr_baseline.score(X_test, y_test)\r\n        baseline_cv_r2 = cross_val_score(lr_baseline, X_train, y_train).mean()\r\n    print(f\"\"\"Baseline R2 score for train data: {baseline_train_r2}\r\n    Baseline R2 score for test data: {baseline_test_r2}, \r\n    Baseline cross validated R2 score for train data: {baseline_cv_r2}\"\"\")\r\n\r\nMLflow shows the following warning.\r\n\r\n    2022/09/24 18:24:04 INFO mlflow.utils.autologging_utils: Created MLflow autologging run with ID 'a843adb4410d46ff855b725479b0bcf0', which will track hyperparameters, performance metrics, model artifacts, and lineage information for the current sklearn workflow\r\n    2022/09/24 18:24:09 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/a843adb4410d46ff855b725479b0bcf0/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n    2022/09/24 18:24:14 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n    2022/09/24 18:24:18 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n    2022/09/24 18:24:22 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n    2022/09/24 18:24:26 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n    2022/09/24 18:24:30 WARNING mlflow.models.model: Logging model metadata to the tracking server has failed, possibly due older server version. The model artifacts have been logged successfully under ./mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts. In addition to exporting model artifacts, MLflow clients 1.7.0 and above attempt to record model metadata to the tracking store. If logging to a mlflow server via REST, consider upgrading the server version to MLflow 1.7.0 or above.\r\n\r\nI expect mlflow to be able to log properly including all the metadata\n\n### Tracking information\n\nMLflow version: 1.29.0\r\nTracking URI: sqlite:///mlflow.db\r\nArtifact URI: ./mlruns/1/fd0b1d09c09f4b65a05baaec1870d7af/artifacts\r\n\r\n! mlflow ui --backend-store-uri sqlite:///mlflow.db\n\n### Code to reproduce issue\n\nAlthough i am still able to download from mlflow, i am unable to run the downloaded model.\r\n\r\n    from mlflow.artifacts import download_artifacts\r\n\r\n    import mlflow.pyfunc\r\n    \r\n    full_path = './mlruns/1/ed3439cbaed04b87bd4ab8764eaad894/artifacts/model'\r\n    download_artifacts(full_path, dst_path='.')\r\n    \r\n    model = mlflow.pyfunc.load_model(model_uri=\"./model\") # saved trained model is within the best_estimator folder\r\n    model.predict(df_submit_cleaned)\r\n\r\n\n\n### Stack trace\n\nOutput error message when i tried to run the downloaded model is as follows:\r\n\r\n    ---------------------------------------------------------------------------\r\n    MlflowException                           Traceback (most recent call last)\r\n    Cell In [58], line 1\r\n    ----> 1 model.predict(df_submit_cleaned)\r\n    \r\n    File ~\\anaconda3\\envs\\dsi-sg\\lib\\site-packages\\mlflow\\pyfunc\\__init__.py:372, in PyFuncModel.predict(self, data)\r\n        370 input_schema = self.metadata.get_input_schema()\r\n        371 if input_schema is not None:\r\n    --> 372     data = _enforce_schema(data, input_schema)\r\n        373 return self._predict_fn(data)\r\n    \r\n    File ~\\anaconda3\\envs\\dsi-sg\\lib\\site-packages\\mlflow\\models\\utils.py:545, in _enforce_schema(pfInput, input_schema)\r\n        543         if extra_cols:\r\n        544             message += \" Note that there were extra inputs: {0}\".format(extra_cols)\r\n    --> 545         raise MlflowException(message)\r\n        546 elif not input_schema.is_tensor_spec():\r\n        547     # The model signature does not specify column names => we can only verify column count.\r\n        548     num_actual_columns = len(pfInput.columns)\r\n    \r\n    MlflowException: Model is missing inputs ['MS SubClass_120', 'MS SubClass_150', 'MS SubClass_160', 'MS SubClass_180', 'MS SubClass_190', 'MS SubClass_20', 'MS SubClass_30', 'MS SubClass_40', 'MS SubClass_45', 'MS SubClass_50', 'MS SubClass_60', 'MS SubClass_70', 'MS SubClass_75', 'MS SubClass_80', 'MS SubClass_85', 'MS SubClass_90', 'MS Zoning_A (agr)', 'MS Zoning_C (all)', 'MS Zoning_FV', 'MS Zoning_I (all)', 'MS Zoning_RH', 'MS Zoning_RL', 'MS Zoning_RM', 'Street_Grvl', 'Street_Pave', 'Alley_0', 'Alley_Grvl', 'Alley_Pave', 'Lot Shape_IR1', 'Lot Shape_IR2', 'Lot Shape_IR3', 'Lot Shape_Reg', 'Land Contour_Bnk', 'Land Contour_HLS', 'Land Contour_Low', 'Land Contour_Lvl', 'Utilities_AllPub', 'Utilities_NoSeWa', 'Utilities_NoSewr', 'Lot Config_Corner', 'Lot Config_CulDSac', 'Lot Config_FR2', 'Lot Config_FR3', 'Lot Config_Inside', 'Land Slope_Gtl', 'Land Slope_Mod', 'Land Slope_Sev', 'Neighborhood_Blmngtn', 'Neighborhood_Blueste', 'Neighborhood_BrDale', 'Neighborhood_BrkSide', 'Neighborhood_ClearCr', 'Neighborhood_CollgCr', 'Neighborhood_Crawfor', 'Neighborhood_Edwards', 'Neighborhood_Gilbert', 'Neighborhood_Greens', 'Neighborhood_GrnHill', 'Neighborhood_IDOTRR', 'Neighborhood_Landmrk', 'Neighborhood_MeadowV', 'Neighborhood_Mitchel', 'Neighborhood_NAmes', 'Neighborhood_NPkVill', 'Neighborhood_NWAmes', 'Neighborhood_NoRidge', 'Neighborhood_NridgHt', 'Neighborhood_OldTown', 'Neighborhood_SWISU', 'Neighborhood_Sawyer', 'Neighborhood_SawyerW', 'Neighborhood_Somerst', 'Neighborhood_StoneBr', 'Neighborhood_Timber', 'Neighborhood_Veenker', 'Condition 1_Artery', 'Condition 1_Feedr', 'Condition 1_Norm', 'Condition 1_PosA', 'Condition 1_PosN', 'Condition 1_RRAe', 'Condition 1_RRAn', 'Condition 1_RRNe', 'Condition 1_RRNn', 'Condition 2_Artery', 'Condition 2_Feedr', 'Condition 2_Norm', 'Condition 2_PosA', 'Condition 2_PosN', 'Condition 2_RRAe', 'Condition 2_RRAn', 'Condition 2_RRNn', 'Bldg Type_1Fam', 'Bldg Type_2fmCon', 'Bldg Type_Duplex', 'Bldg Type_Twnhs', 'Bldg Type_TwnhsE', 'House Style_1.5Fin', 'House Style_1.5Unf', 'House Style_1Story', 'House Style_2.5Fin', 'House Style_2.5Unf', 'House Style_2Story', 'House Style_SFoyer', 'House Style_SLvl', 'Roof Style_Flat', 'Roof Style_Gable', 'Roof Style_Gambrel', 'Roof Style_Hip', 'Roof Style_Mansard', 'Roof Style_Shed', 'Roof Matl_ClyTile', 'Roof Matl_CompShg', 'Roof Matl_Membran', 'Roof Matl_Tar&Grv', 'Roof Matl_WdShake', 'Roof Matl_WdShngl', 'Exterior 1st_AsbShng', 'Exterior 1st_AsphShn', 'Exterior 1st_BrkComm', 'Exterior 1st_BrkFace', 'Exterior 1st_CBlock', 'Exterior 1st_CemntBd', 'Exterior 1st_HdBoard', 'Exterior 1st_ImStucc', 'Exterior 1st_MetalSd', 'Exterior 1st_Plywood', 'Exterior 1st_Stone', 'Exterior 1st_Stucco', 'Exterior 1st_VinylSd', 'Exterior 1st_Wd Sdng', 'Exterior 1st_WdShing', 'Mas Vnr Type_0', 'Mas Vnr Type_BrkCmn', 'Mas Vnr Type_BrkFace', 'Mas Vnr Type_None', 'Mas Vnr Type_Stone', 'Exter Qual_Ex', 'Exter Qual_Fa', 'Exter Qual_Gd', 'Exter Qual_TA', 'Exter Cond_Ex', 'Exter Cond_Fa', 'Exter Cond_Gd', 'Exter Cond_Po', 'Exter Cond_TA', 'Foundation_BrkTil', 'Foundation_CBlock', 'Foundation_PConc', 'Foundation_Slab', 'Foundation_Stone', 'Foundation_Wood', 'Bsmt Qual_0', 'Bsmt Qual_Ex', 'Bsmt Qual_Fa', 'Bsmt Qual_Gd', 'Bsmt Qual_Po', 'Bsmt Qual_TA', 'Bsmt Cond_0', 'Bsmt Cond_Ex', 'Bsmt Cond_Fa', 'Bsmt Cond_Gd', 'Bsmt Cond_Po', 'Bsmt Cond_TA', 'Bsmt Exposure_0', 'Bsmt Exposure_Av', 'Bsmt Exposure_Gd', 'Bsmt Exposure_Mn', 'Bsmt Exposure_No', 'BsmtFin Type 1_0', 'BsmtFin Type 1_ALQ', 'BsmtFin Type 1_BLQ', 'BsmtFin Type 1_GLQ', 'BsmtFin Type 1_LwQ', 'BsmtFin Type 1_Rec', 'BsmtFin Type 1_Unf', 'BsmtFin Type 2_0', 'BsmtFin Type 2_ALQ', 'BsmtFin Type 2_BLQ', 'BsmtFin Type 2_GLQ', 'BsmtFin Type 2_LwQ', 'BsmtFin Type 2_Rec', 'BsmtFin Type 2_Unf', 'Heating_GasA', 'Heating_GasW', 'Heating_Grav', 'Heating_OthW', 'Heating_Wall', 'Heating QC_Ex', 'Heating QC_Fa', 'Heating QC_Gd', 'Heating QC_Po', 'Heating QC_TA', 'Central Air_N', 'Central Air_Y', 'Electrical_FuseA', 'Electrical_FuseF', 'Electrical_FuseP', 'Electrical_Mix', 'Electrical_SBrkr', 'Kitchen Qual_Ex', 'Kitchen Qual_Fa', 'Kitchen Qual_Gd', 'Kitchen Qual_TA', 'Functional_Maj1', 'Functional_Maj2', 'Functional_Min1', 'Functional_Min2', 'Functional_Mod', 'Functional_Sal', 'Functional_Sev', 'Functional_Typ', 'Garage Type_0', 'Garage Type_2Types', 'Garage Type_Attchd', 'Garage Type_Basment', 'Garage Type_BuiltIn', 'Garage Type_CarPort', 'Garage Type_Detchd', 'Garage Finish_0', 'Garage Finish_Fin', 'Garage Finish_RFn', 'Garage Finish_Unf', 'Garage Cond_0', 'Garage Cond_Ex', 'Garage Cond_Fa', 'Garage Cond_Gd', 'Garage Cond_Po', 'Garage Cond_TA', 'Paved Drive_N', 'Paved Drive_P', 'Paved Drive_Y', 'Fence_0', 'Fence_GdPrv', 'Fence_GdWo', 'Fence_MnPrv', 'Fence_MnWw', 'Misc Feature_0', 'Misc Feature_Elev', 'Misc Feature_Gar2', 'Misc Feature_Othr', 'Misc Feature_Shed', 'Misc Feature_TenC', 'Sale Type_COD', 'Sale Type_CWD', 'Sale Type_Con', 'Sale Type_ConLD', 'Sale Type_ConLI', 'Sale Type_ConLw', 'Sale Type_New', 'Sale Type_Oth', 'Sale Type_WD ']. Note that there were extra inputs: ['Exter Qual', 'Lot Shape', 'Bsmt Qual', 'Foundation', 'Functional', 'Neighborhood', 'Fence', 'Sale Type', 'Condition 2', 'BsmtFin Type 2', 'Lot Config', 'Garage Finish', 'BsmtFin Type 1', 'Garage Cond', 'MS SubClass', 'Exterior 1st', 'Roof Style', 'Street', 'Heating', 'Central Air', 'Garage Type', 'Paved Drive', 'Land Contour', 'Roof Matl', 'Alley', 'Bsmt Cond', 'Mas Vnr Type', 'Kitchen Qual', 'House Style', 'Bldg Type', 'MS Zoning', 'Misc Feature', 'Condition 1', 'Utilities', 'Electrical', 'Exter Cond', 'Land Slope', 'Heating QC', 'Bsmt Exposure']\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6877/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6877/timeline","performed_via_github_app":null,"state_reason":null}