{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1786","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1786/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1786/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1786/events","html_url":"https://github.com/mlflow/mlflow/issues/1786","id":485846437,"node_id":"MDU6SXNzdWU0ODU4NDY0Mzc=","number":1786,"title":"[BUG] 'mlflow run' cannot find 'source' on Windows platform with defined env CONDA_EXE","user":{"login":"artefom","id":15194702,"node_id":"MDQ6VXNlcjE1MTk0NzAy","avatar_url":"https://avatars.githubusercontent.com/u/15194702?v=4","gravatar_id":"","url":"https://api.github.com/users/artefom","html_url":"https://github.com/artefom","followers_url":"https://api.github.com/users/artefom/followers","following_url":"https://api.github.com/users/artefom/following{/other_user}","gists_url":"https://api.github.com/users/artefom/gists{/gist_id}","starred_url":"https://api.github.com/users/artefom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/artefom/subscriptions","organizations_url":"https://api.github.com/users/artefom/orgs","repos_url":"https://api.github.com/users/artefom/repos","events_url":"https://api.github.com/users/artefom/events{/privacy}","received_events_url":"https://api.github.com/users/artefom/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-08-27T14:29:31Z","updated_at":"2019-11-17T00:32:07Z","closed_at":"2019-11-17T00:32:07Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no custom code\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Windows 10\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.2.0\r\n- **Python version**: 3.7\r\n- **Conda version**: 4.5.12\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: \r\n\r\n1. **MLproject i use**:\r\n```\r\nname: test\r\nconda_env: env/test.yaml\r\nentry_points:\r\n  main:\r\n    command: \"echo 'Hello, world!'\"\r\n```\r\n2. **Add CONDA_EXE to env**\r\n3. **run**:\r\n```bash\r\nmlflow run . \r\n```\r\n\r\n### Describe the problem\r\n\r\nMLflow run fails with `\"Running command 'source C:\\Anaconda3\\Scripts/../etc/profile.d/conda.sh && conda activate mlflow-a0ccc40d6f0f515d16fcdead908287c92754d8fb 1>&2 && echo 'Hello, world!'' in run with ID '283707091aa0462f8c64d49ec0db2f31' ===\"`\r\n\r\ntraceback:\r\n```\r\nTraceback (most recent call last):\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\runpy.py\", line 193, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"C:\\Anaconda3\\envs\\lenta\\Scripts\\mlflow.exe\\__main__.py\", line 9, in <module>\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\click\\core.py\", line 764, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\click\\core.py\", line 717, in main\r\n    rv = self.invoke(ctx)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\click\\core.py\", line 1137, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\click\\core.py\", line 956, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\click\\core.py\", line 555, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\mlflow\\cli.py\", line 137, in run\r\n    run_id=run_id\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\mlflow\\projects\\__init__.py\", line 266, in run\r\n    use_conda=use_conda, storage_dir=storage_dir, synchronous=synchronous, run_id=run_id)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\mlflow\\projects\\__init__.py\", line 154, in _run\r\n    run_id=active_run.info.run_id)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\site-packages\\mlflow\\projects\\__init__.py\", line 556, in _run_entry_point\r\n    process = subprocess.Popen(command, close_fds=True, cwd=work_dir, env=env)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\subprocess.py\", line 775, in __init__\r\n    restore_signals, start_new_session)\r\n  File \"c:\\anaconda3\\envs\\lenta\\lib\\subprocess.py\", line 1178, in _execute_child\r\n    startupinfo)\r\nFileNotFoundError: [WinError 2] The system cannot find the file specified\r\n```\r\n\r\n*Clearly, it cannot find 'source' since i'm using Windows 10*\r\n\r\nThe root of the problem is in `mlflow/projects/__init__.py` (func: _get_conda_command)\r\n\r\n```\r\ndef _get_conda_command(conda_env_name):\r\n    #  Checking for newer conda versions\r\n    if 'CONDA_EXE' in os.environ or 'MLFLOW_CONDA_HOME' in os.environ:\r\n        conda_path = _get_conda_bin_executable(\"conda\")\r\n\r\n        activate_conda_env = ['source ' + os.path.dirname(conda_path) +\r\n                              '/../etc/profile.d/conda.sh']\r\n...\r\n```\r\n\r\nI have 'CONDA_EXE' environment variable and it branches into adding 'source' to command\r\n\r\nto fix that, we need to check if os is 'nt' and proceed to adding 'sh' instead of 'source'","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1786/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1786/timeline","performed_via_github_app":null,"state_reason":"completed"}