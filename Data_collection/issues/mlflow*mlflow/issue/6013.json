{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6013","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6013/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6013/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6013/events","html_url":"https://github.com/mlflow/mlflow/issues/6013","id":1256272990,"node_id":"I_kwDOCB5Jx85K4TRe","number":6013,"title":"[BUG] multi-thread log_metrics met 'database is locked' when the script is run several times in a few seconds even I have used threading.Lock to make it thread-safe..","user":{"login":"Jingnan-Jia","id":34941987,"node_id":"MDQ6VXNlcjM0OTQxOTg3","avatar_url":"https://avatars.githubusercontent.com/u/34941987?v=4","gravatar_id":"","url":"https://api.github.com/users/Jingnan-Jia","html_url":"https://github.com/Jingnan-Jia","followers_url":"https://api.github.com/users/Jingnan-Jia/followers","following_url":"https://api.github.com/users/Jingnan-Jia/following{/other_user}","gists_url":"https://api.github.com/users/Jingnan-Jia/gists{/gist_id}","starred_url":"https://api.github.com/users/Jingnan-Jia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jingnan-Jia/subscriptions","organizations_url":"https://api.github.com/users/Jingnan-Jia/orgs","repos_url":"https://api.github.com/users/Jingnan-Jia/repos","events_url":"https://api.github.com/users/Jingnan-Jia/events{/privacy}","received_events_url":"https://api.github.com/users/Jingnan-Jia/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-01T15:21:24Z","updated_at":"2022-06-17T11:35:07Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n1.26.0\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: CentOS 7.7\r\n- **Python version**: 3.8\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\nI would like to run several threads to record different metrics. I use \"`with global_lock:`\" for each `log_metrics` to make sure the database `sqlite` is not locked for each thread's `log_metrics`. The code to reproduce the test is attached.\r\n\r\nHowever I found a weird issue. Even I added `global_lock` to each thread, the error still raised when the script was run several times at the same time: `mlflow.exceptions.RestException: BAD_REQUEST: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely) (sqlite3.OperationalError) database is locked`\r\n\r\nTo reproduce the issue, follow these steps, \r\n\r\n1. Copy the code at the following ' Code to reproduce issue' section to a file `test_threas_safe.py`. \r\n2. Open one linux's terminal, run `mlflow server --backend-store-uri=sqlite:///mlrunsdb15.db --default-artifact-root=file:mlruns --host 0.0.0.0 --port 5000`.\r\n3.  Open another linux's terminal, run `python test_threas_safe.py`. \r\n\r\nAt present, every thing is fine, the screen shows the accuracy output from each thread.\r\n\r\nHowever, \r\nif we repeat the third step several times in several seconds:\r\n1. The same as above step 1.\r\n2. The same as above step 2.\r\n3. Open another linux's terminal, run `python test_threas_safe.py`. \r\n5. Open another linux's terminal, run `python test_threas_safe.py`. \r\n6. Open another linux's terminal, run `python test_threas_safe.py`. \r\n7. Open another linux's terminal, run `python test_threas_safe.py`. \r\n8. Open another linux's terminal, run `python test_threas_safe.py`. \r\n9. Open another linux's terminal, run `python test_threas_safe.py`. \r\n\r\nThen, we successfully launched the same scripts 6 times. **But the 6 terminals would show some errors at some random time** !\r\n\r\n**To summarize, based on `sqlite` database backend, the multi-thread `log_metrics` can not work normally when the same script is run several times in a few seconds.**\r\n\r\n\r\n\r\n### Tracking information\r\n\r\nMLflow version: 1.26.1\r\nTracking URI: http://localhost:5000\r\nArtifact URI: file:mlruns/0/16bcb11d4ffb4253abb5faa0d69a2ba7/artifacts\r\n\r\n### Code to reproduce issue\r\n```\r\nfrom mlflow import log_metric\r\nimport mlflow\r\nimport threading\r\nimport time\r\nimport random\r\nglobal_lock = threading.Lock()\r\n\r\ndef sub_thread1():\r\n    for i in range(500):\r\n        with global_lock:\r\n            tmp1 = random.random()\r\n            log_metric('Accuracy1', tmp1, step=i)\r\n            print(f'accuracy1: {tmp1}')\r\n        time.sleep(tmp1)\r\n\r\ndef sub_thread2():\r\n    for i in range(500):\r\n        with global_lock:\r\n            tmp2 = random.random()\r\n            log_metric('Accuracy2', tmp2, step=i)\r\n            print(f'accuracy2: {tmp2}')\r\n        time.sleep(tmp2)\r\n\r\n\r\ndef sub_thread3():\r\n    for i in range(500):\r\n        with global_lock:\r\n            tmp3 = random.random()\r\n            log_metric('Accuracy3', tmp3, step=i)\r\n            print(f'accuracy3: {tmp3}')\r\n        time.sleep(tmp3)\r\n\r\ndef sub_thread4():\r\n    for i in range(500):\r\n        with global_lock:\r\n            tmp4 = random.random()\r\n            log_metric('Accuracy4', tmp4, step=i)\r\n            print(f'accuracy4: {tmp4}')\r\n        time.sleep(tmp4)\r\n\r\nif __name__ == \"__main__\":\r\n    mlflow.set_tracking_uri(\"http://localhost:5000\")\r\n    with mlflow.start_run():\r\n        p1 = threading.Thread(target=sub_thread1)\r\n        p2 = threading.Thread(target=sub_thread2)\r\n        p3 = threading.Thread(target=sub_thread3)\r\n        p4 = threading.Thread(target=sub_thread3)\r\n        p1.start()\r\n        p2.start()\r\n        p3.start()\r\n        p4.start()\r\n        for i in range(500):\r\n            with global_lock:\r\n                tmp0 = random.random()\r\n                log_metric('Accuracy0', tmp0, step=i)\r\n                print(f'accuracy0: {tmp0}')\r\n            time.sleep(tmp0)\r\n        p1.join()\r\n        p2.join()\r\n        p3.join()\r\n        p4.join()\r\n\r\n    print(\"Finished!\")\r\n```\r\n### Other info / logs\r\n```\r\nException in thread Thread-3:\r\nTraceback (most recent call last):\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/threading.py\", line 932, in _bootstrap_inner\r\n    self.run()\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/threading.py\", line 870, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"test_multi_threads.py\", line 31, in sub_thread3\r\n    log_metric('Accuracy3', tmp3, step=i)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/fluent.py\", line 583, in log_metric\r\n    MlflowClient().log_metric(run_id, key, value, int(time.time() * 1000), step or 0)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 690, in log_metric\r\n    self._tracking_client.log_metric(run_id, key, value, timestamp, step)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 226, in log_metric\r\n    self.store.log_metric(run_id, metric)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 191, in log_metric\r\n    self._call_endpoint(LogMetric, req_body)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 56, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 256, in call_endpoint\r\n    response = verify_rest_response(response, endpoint)\r\n  File \"/home/jjia/.conda/envs/py38/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 185, in verify_rest_response\r\n    raise RestException(json.loads(response.text))\r\nmlflow.exceptions.RestException: BAD_REQUEST: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)\r\n(sqlite3.OperationalError) database is locked\r\n[SQL: INSERT INTO metrics (\"key\", value, timestamp, step, is_nan, run_uuid) VALUES (?, ?, ?, ?, ?, ?)]\r\n[parameters: ('Accuracy3', 0.6279300229024112, 1654095519850, 29, 0, '1422fd42e34742899220ceeae11f55c2')]\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\r\n```\r\n\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [X] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [X] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6013/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6013/timeline","performed_via_github_app":null,"state_reason":null}