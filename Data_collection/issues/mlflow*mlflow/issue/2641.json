{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2641","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2641/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2641/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2641/events","html_url":"https://github.com/mlflow/mlflow/issues/2641","id":588451271,"node_id":"MDU6SXNzdWU1ODg0NTEyNzE=","number":2641,"title":"[BUG] Cannot load keras autlog model from registry due to model/model/ directory doubling","user":{"login":"Dr-DaDe","id":60467599,"node_id":"MDQ6VXNlcjYwNDY3NTk5","avatar_url":"https://avatars.githubusercontent.com/u/60467599?v=4","gravatar_id":"","url":"https://api.github.com/users/Dr-DaDe","html_url":"https://github.com/Dr-DaDe","followers_url":"https://api.github.com/users/Dr-DaDe/followers","following_url":"https://api.github.com/users/Dr-DaDe/following{/other_user}","gists_url":"https://api.github.com/users/Dr-DaDe/gists{/gist_id}","starred_url":"https://api.github.com/users/Dr-DaDe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Dr-DaDe/subscriptions","organizations_url":"https://api.github.com/users/Dr-DaDe/orgs","repos_url":"https://api.github.com/users/Dr-DaDe/repos","events_url":"https://api.github.com/users/Dr-DaDe/events{/privacy}","received_events_url":"https://api.github.com/users/Dr-DaDe/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1893057631,"node_id":"MDU6TGFiZWwxODkzMDU3NjMx","url":"https://api.github.com/repos/mlflow/mlflow/labels/Acknowledged","name":"Acknowledged","color":"f9d0c4","default":false,"description":"This issue has been read and acknowledged by the MLflow admins."},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022863969,"node_id":"MDU6TGFiZWwyMDIyODYzOTY5","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-soon","name":"priority/important-soon","color":"534cb5","default":false,"description":"The issue is worked on by the community currently or will be very soon, ideally in time for the"},{"id":2022886708,"node_id":"MDU6TGFiZWwyMDIyODg2NzA4","url":"https://api.github.com/repos/mlflow/mlflow/labels/needs%20design","name":"needs design","color":"006b75","default":false,"description":"This feature requires design and design review before starting coding"}],"state":"closed","locked":false,"assignee":{"login":"andychow-db","id":58712524,"node_id":"MDQ6VXNlcjU4NzEyNTI0","avatar_url":"https://avatars.githubusercontent.com/u/58712524?v=4","gravatar_id":"","url":"https://api.github.com/users/andychow-db","html_url":"https://github.com/andychow-db","followers_url":"https://api.github.com/users/andychow-db/followers","following_url":"https://api.github.com/users/andychow-db/following{/other_user}","gists_url":"https://api.github.com/users/andychow-db/gists{/gist_id}","starred_url":"https://api.github.com/users/andychow-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andychow-db/subscriptions","organizations_url":"https://api.github.com/users/andychow-db/orgs","repos_url":"https://api.github.com/users/andychow-db/repos","events_url":"https://api.github.com/users/andychow-db/events{/privacy}","received_events_url":"https://api.github.com/users/andychow-db/received_events","type":"User","site_admin":false},"assignees":[{"login":"andychow-db","id":58712524,"node_id":"MDQ6VXNlcjU4NzEyNTI0","avatar_url":"https://avatars.githubusercontent.com/u/58712524?v=4","gravatar_id":"","url":"https://api.github.com/users/andychow-db","html_url":"https://github.com/andychow-db","followers_url":"https://api.github.com/users/andychow-db/followers","following_url":"https://api.github.com/users/andychow-db/following{/other_user}","gists_url":"https://api.github.com/users/andychow-db/gists{/gist_id}","starred_url":"https://api.github.com/users/andychow-db/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andychow-db/subscriptions","organizations_url":"https://api.github.com/users/andychow-db/orgs","repos_url":"https://api.github.com/users/andychow-db/repos","events_url":"https://api.github.com/users/andychow-db/events{/privacy}","received_events_url":"https://api.github.com/users/andychow-db/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2020-03-26T14:11:34Z","updated_at":"2020-08-05T03:01:29Z","closed_at":"2020-08-05T03:01:29Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: macOS Catalina\r\n- **MLflow installed from (source or binary)**: both via pip 1.7.0 and pip+git 1.7.3dev0\r\n- **MLflow version (run ``mlflow --version``)**: 1.7.0 and 1.7.3.dev0\r\n- **Python version**: 3.7.6\r\n\r\nI installed a working model registry on a remote server using postgresql as a basis. As for now, I have not encountered any problems with logging models to the registry both via the UI interface and via the API:\r\n\r\n<img width=\"500\" alt=\"image\" src=\"https://user-images.githubusercontent.com/60467599/77654810-d2645600-6f71-11ea-8a71-9d8e8db59e95.png\">\r\n\r\nI have no problems in loading models via their run_id using e.g\r\n```\r\nfrom mlflow.keras import load_model\r\nmodel = load_model(\"runs:/e510981424cc4d7e9b91d7ceb15c8098/model/model\")\r\n```\r\nHowever, if I try to load a model from the registry, I encounter a bug\r\n\r\n```\r\nload_model(\"models:/MyKerasModel/3\")\r\n\r\nTraceback (most recent call last):\r\n  File \"mini.py\", line 6, in <module>\r\n    load_model(\"models:/MyKerasModel/3\")\r\n  File \"/Users/daniel.dercks/opt/anaconda3/envs/berner_macos_nogpu/lib/python3.7/site-packages/mlflow/keras.py\", line 391, in load_model\r\n    flavor_conf = _get_flavor_configuration(model_path=local_model_path, flavor_name=FLAVOR_NAME)\r\n  File \"/Users/daniel.dercks/opt/anaconda3/envs/berner_macos_nogpu/lib/python3.7/site-packages/mlflow/utils/model_utils.py\", line 26, in _get_flavor_configuration\r\n    RESOURCE_DOES_NOT_EXIST)\r\nmlflow.exceptions.MlflowException: Could not find an \"MLmodel\" configuration file at \"/var/folders/jx/02yypg8x5wjdhhr54xcmzhy87m0bvt/T/tmpmo0g0x22/\"\r\n```\r\n\r\nInterestingly, if I look inside the folder of interest, I do see that it countains a `model` subdirectory  which contains the model of interest.\r\n```\r\n~$ ls /var/folders/jx/02yypg8x5wjdhhr54xcmzhy87m0bvt/T/tmpmo0g0x22/\r\nmodel\r\n~$ ls /var/folders/jx/02yypg8x5wjdhhr54xcmzhy87m0bvt/T/tmpmo0g0x22/model/\r\nMLmodel    conda.yaml data\r\n```\r\n\r\nIt seems as if mlflow forgets to look inside the /model subfolder. Unfortunately, I cannot tell it to do so because if I run\r\n\r\n```\r\nload_model(\"models:/MyKerasModel/3/model\")\r\n```\r\nI get\r\n```\r\nmlflow.exceptions.MlflowException: Not a proper models:/ URI: models:/MyKerasModel/3/model. Models URIs must be of the form 'models:/<model_name>/<version or stage>'.\r\n```\r\n\r\nIf it is of any interest: models were stored 'automatically' via the `mlflow.keras.autolog()` functionality and I used the \"Register Model\" button on the UI to publish the model inside the model registry.  \r\nInterestingly, there seems to be  a potentially peculiar `model/model/...` directory structure. So maybe it's keras.autolog() who is the culprit and should not produce a model folder within a model folder\r\n<img width=\"1303\" alt=\"image\" src=\"https://user-images.githubusercontent.com/60467599/77656867-c8902200-6f74-11ea-9916-737d51eafe26.png\">\r\n\r\n\r\nNote also how my `load_model(\"runs:/...`command from above also explicitly has to look inside models/models\r\n\r\n**EDIT** In investigated the double folder structre more thoroughly.\r\nSo in the artifact listing I showed above, I can both click on the main folder \"model\" and click \"Register Model\" _and_ I can click on the subfolder \"model/model\" and click \"Register Model\". \r\n\r\nIf I do the first, I encounter the above error, I I do the second, I don't.\r\n\r\nSo the solution, to me, seems to be that either or both of the following should be fixed\r\n- Keras.autolog should not produce the model/model double structure\r\n- The \"Register Model\" should not be clickable unless the folder I selected really is a proper model folder with a proper MLModel definition file inside.\r\n\r\n**EDIT2** The bug also appears if I don't use the UI but use the actual `mlflow.keras.log_model` method:\r\n\r\n```\r\nIn[2]: import mlflow\r\nIn[3]: from mlflow.keras import load_model\r\nIn[4]: mlflow.set_tracking_uri(\"http://ki01hb.hmmh.ag:4999\")\r\nIn[5]: model = load_model(\"runs:/3289a926f0164ee5bf114405e7fc6723/model/model\")\r\nUsing TensorFlow backend.\r\n[... some tensorflow warnings ... ]\r\nIn[6]: mlflow.keras.log_model(model, \"\", registered_model_name=\"MyVeryFirstModel\")\r\nSuccessfully registered model 'MyVeryFirstModel'.\r\nCreated version '1' of model 'MyVeryFirstModel'.\r\nIn[7]: model2 = load_model(\"models:/MyVeryFirstModel/1\")\r\nTraceback (most recent call last):\r\n  File \"/Users/daniel.dercks/opt/anaconda3/envs/berner_macos_nogpu/lib/python3.7/site-packages/IPython/core/interactiveshell.py\", line 3331, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-7-f1fb653daf70>\", line 1, in <module>\r\n    model2 = load_model(\"models:/MyVeryFirstModel/1\")\r\n  File \"/Users/daniel.dercks/opt/anaconda3/envs/berner_macos_nogpu/lib/python3.7/site-packages/mlflow/keras.py\", line 391, in load_model\r\n    flavor_conf = _get_flavor_configuration(model_path=local_model_path, flavor_name=FLAVOR_NAME)\r\n  File \"/Users/daniel.dercks/opt/anaconda3/envs/berner_macos_nogpu/lib/python3.7/site-packages/mlflow/utils/model_utils.py\", line 26, in _get_flavor_configuration\r\n    RESOURCE_DOES_NOT_EXIST)\r\nmlflow.exceptions.MlflowException: Could not find an \"MLmodel\" configuration file at \"/var/folders/jx/02yypg8x5wjdhhr54xcmzhy87m0bvt/T/tmpha64w5wy/\"\r\nIn[8]: import os\r\n  ...: os.listdir(\"/var/folders/jx/02yypg8x5wjdhhr54xcmzhy87m0bvt/T/tmpha64w5wy/\")\r\nOut[8]: ['model']\r\n```\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2641/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2641/timeline","performed_via_github_app":null,"state_reason":"completed"}