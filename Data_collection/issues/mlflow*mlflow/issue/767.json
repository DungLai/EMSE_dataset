{"url":"https://api.github.com/repos/mlflow/mlflow/issues/767","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/767/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/767/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/767/events","html_url":"https://github.com/mlflow/mlflow/issues/767","id":392895006,"node_id":"MDU6SXNzdWUzOTI4OTUwMDY=","number":767,"title":"spark_udf cannot accept more than 255 columns ","user":{"login":"kieucuong","id":37095714,"node_id":"MDQ6VXNlcjM3MDk1NzE0","avatar_url":"https://avatars.githubusercontent.com/u/37095714?v=4","gravatar_id":"","url":"https://api.github.com/users/kieucuong","html_url":"https://github.com/kieucuong","followers_url":"https://api.github.com/users/kieucuong/followers","following_url":"https://api.github.com/users/kieucuong/following{/other_user}","gists_url":"https://api.github.com/users/kieucuong/gists{/gist_id}","starred_url":"https://api.github.com/users/kieucuong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kieucuong/subscriptions","organizations_url":"https://api.github.com/users/kieucuong/orgs","repos_url":"https://api.github.com/users/kieucuong/repos","events_url":"https://api.github.com/users/kieucuong/events{/privacy}","received_events_url":"https://api.github.com/users/kieucuong/received_events","type":"User","site_admin":false},"labels":[{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-20T05:24:02Z","updated_at":"2019-11-12T21:50:19Z","closed_at":"2019-11-12T21:50:19Z","author_association":"NONE","active_lock_reason":null,"body":"I think currently `spark_udf` cannot accept more than 255 columns. We tried to use `spark_udf` with our Keras model (TensorFlow backend) that needs more than 255 inputs and we faced the error. \r\n  \r\nI checked `mlflow.pyfunc.__init__.py`  and found that `spark_udf`'s `predict` function is like this:\r\n```\r\ndef predict(*args): \r\n```\r\nPrior to 3.7, Python does not allow a function to have more than 255 arguments. And of course we cannot upgrade to Python 3.7 since currently TensorFlow doesn't work with Python 3.7. \r\n\r\nSo how about making `spark_udf` accept one column which is an array of features? Similar to Spark MLlib where usually we use only one feature column. \r\n\r\nActually I tried to modify `mlflow.pyfunc.__init__.py` and something like this works:\r\n```\r\n    def predict(*args):\r\n        model = SparkModelCache.get_or_load(archive_path)\r\n        # My-fix start\r\n        schema = None\r\n        columns = None\r\n        if (len(args) == 1):\r\n            data = args[0].get_values()\r\n            num_rows = len(data)\r\n            num_features = len(data[0])\r\n            schema = {str(i): pandas.Series({str(j): data[j][i] for j in range(num_rows)}) for i in range(num_features)}\r\n            columns = [str(i) for i in range(num_features)]\r\n        # My-fix end\r\n        else:\r\n            schema = {str(i): arg for i, arg in enumerate(args)}\r\n            # Explicitly pass order of columns to avoid lexicographic ordering (i.e., 10 < 2)\r\n            columns = [str(i) for i, _ in enumerate(args)]\r\n        \r\n        pdf = pandas.DataFrame(schema, columns=columns)\r\n        result = model.predict(pdf)\r\n        ...\r\n```\r\nThe above code doesn't break the current behavior. \r\n\r\nIn our use case, we really need `spark_udf` to accept many features (columns) so we really appreciate if mlflow can provide that ability. \r\n\r\nThanks.  \r\n","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/767/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/767/timeline","performed_via_github_app":null,"state_reason":"completed"}