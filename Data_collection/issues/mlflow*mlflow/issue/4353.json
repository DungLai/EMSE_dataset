{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4353","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4353/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4353/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4353/events","html_url":"https://github.com/mlflow/mlflow/issues/4353","id":890814942,"node_id":"MDU6SXNzdWU4OTA4MTQ5NDI=","number":4353,"title":"[BUG] Deadlock issue raised from backend store DB","user":{"login":"anjsam1402","id":47534937,"node_id":"MDQ6VXNlcjQ3NTM0OTM3","avatar_url":"https://avatars.githubusercontent.com/u/47534937?v=4","gravatar_id":"","url":"https://api.github.com/users/anjsam1402","html_url":"https://github.com/anjsam1402","followers_url":"https://api.github.com/users/anjsam1402/followers","following_url":"https://api.github.com/users/anjsam1402/following{/other_user}","gists_url":"https://api.github.com/users/anjsam1402/gists{/gist_id}","starred_url":"https://api.github.com/users/anjsam1402/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anjsam1402/subscriptions","organizations_url":"https://api.github.com/users/anjsam1402/orgs","repos_url":"https://api.github.com/users/anjsam1402/repos","events_url":"https://api.github.com/users/anjsam1402/events{/privacy}","received_events_url":"https://api.github.com/users/anjsam1402/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2021-05-13T07:42:14Z","updated_at":"2022-06-16T17:44:56Z","closed_at":"2022-04-14T22:28:26Z","author_association":"NONE","active_lock_reason":null,"body":"## MLflow Roadmap Item\r\n\r\nThis is an MLflow Roadmap item that has been prioritized by the MLflow maintainers.\r\n\r\n### System information\r\n- **OS Platform and Distribution**: MLflow docker image based on 'python:3.9-slim-buster'. Deployed in k8s cluster.\r\n- **MLflow installed from**: official pip \\ pypi\r\n- **MLflow version**: 1.16.0\r\n- **MLflow backend store**: AWS RDS MySQL 8.0.23\r\n- **MLflow artifact root**: AWS S3 bucket\r\n- **Python version**: 3.9\r\n- ** command** : `mlflow server --host 0.0.0.0  --port 5000 --default-artifact-root ${BUCKET}  --backend-store-uri mysql+pymysql://${USERNAME}:${PASSWORD}@${HOST}:${PORT}/${DATABASE}`\r\n\r\n### Describe the problem\r\nI have been performing load test on the Mlflow Tracking server with a multiprocessing sample code. For few of the runs the following issue was raised :\r\n\r\n> mlflow.exceptions.MlflowException: (pymysql.err.OperationalError) (1213, 'Deadlock found when trying to get lock; try restarting transaction')\r\n[SQL: INSERT INTO latest_metrics (`key`, value, timestamp, step, is_nan, run_uuid) VALUES (%(key)s, %(value)s, %(timestamp)s, %(step)s, %(is_nan)s, %(run_uuid)s)]\r\n[parameters: {'key': 'rmse', 'value': 0.859125957974236, 'timestamp': 1620801352207, 'step': 0, 'is_nan': 0, 'run_uuid': 'eb6d1876d37d4706a97cec4db51937a6'}]\r\n\r\n### Code to reproduce issue\r\n```\r\nimport time\r\nimport multiprocessing\r\nfrom multiprocessing import Pool\r\nimport os\r\nimport warnings\r\nimport sys\r\nimport pandas as pd\r\nimport numpy as np\r\nfrom sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.linear_model import ElasticNet\r\nimport mlflow\r\nimport mlflow.sklearn\r\n\r\nmlflow.set_tracking_uri({REMOTE_TRACKING_SERVER_URI}) \r\nmlflow.set_experiment({EXPERIMENT_NAME})\r\n\r\ndef eval_metrics(actual, pred):\r\n    # compute relevant metrics\r\n    rmse = np.sqrt(mean_squared_error(actual, pred))\r\n    mae = mean_absolute_error(actual, pred)\r\n    r2 = r2_score(actual, pred)\r\n    return rmse, mae, r2\r\n    \r\ndef load_data(data_path):\r\n    data = pd.read_csv(data_path)\r\n    # Split the data into training and test sets. (0.75, 0.25) split.\r\n    train, test = train_test_split(data)\r\n    \r\n    # The predicted column is \"quality\" which is a scalar from [3, 9]\r\n    train_x = train.drop([\"quality\"], axis=1)\r\n    test_x = test.drop([\"quality\"], axis=1)\r\n    train_y = train[[\"quality\"]]\r\n    test_y = test[[\"quality\"]]\r\n    return train_x, train_y, test_x, test_y\r\n\r\ndef train(x, alpha=0.5, l1_ratio=0.5):\r\n    # train a model with given parameters\r\n    warnings.filterwarnings(\"ignore\")\r\n    np.random.seed(40)\r\n    mlflow.sklearn.autolog()\r\n\r\n    # Read the wine-quality csv file (make sure you're running this from the root of MLflow!)\r\n    data_path = \"./data/wine-quality.csv\"\r\n    train_x, train_y, test_x, test_y = load_data(data_path)\r\n    # Useful for multiple runs (only doing one run in this sample notebook)\r\n\r\n    with mlflow.start_run(run_name='run-infy 1000 - ' + str(x)):\r\n        # Execute ElasticNet\r\n        lr = ElasticNet(alpha=alpha, l1_ratio=l1_ratio, random_state=42)\r\n        lr.fit(train_x, train_y)\r\n        # Evaluate Metrics\r\n        predicted_qualities = lr.predict(test_x)\r\n        (rmse, mae, r2) = eval_metrics(test_y, predicted_qualities)\r\n\r\n        print(\"##############  logging params and metrics for \" + str(x) + \"/\" + str(500) + \" ###########\")\r\n        # Log parameter, metrics, and model to MLflow\r\n        mlflow.log_param(key=\"alpha\", value=alpha)\r\n        mlflow.log_param(key=\"l1_ratio\", value=l1_ratio)\r\n        mlflow.log_metric(key=\"rmse\", value=rmse)\r\n        mlflow.log_metrics({\"mae\": mae, \"r2\": r2})\r\n        mlflow.log_artifact(data_path)\r\n        mlflow.sklearn.log_model(lr, \"model\")\r\n\r\ndef multiprocessing_func(x):\r\n    time.sleep(2)\r\n    (x, train(x, 0.5, 0.8))\r\n\r\nif __name__ == '__main__':\r\n    starttime = time.time()\r\n    pool = Pool()\r\n    pool.map(multiprocessing_func, range(1, 1000))\r\n    pool.close()\r\n    print()\r\n    print('Time taken = {} seconds'.format(time.time() - starttime))\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\n- [X] `help wanted`: Need help from community\r\n\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [X] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4353/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4353/timeline","performed_via_github_app":null,"state_reason":"completed"}