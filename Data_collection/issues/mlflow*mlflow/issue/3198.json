{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3198","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3198/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3198/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3198/events","html_url":"https://github.com/mlflow/mlflow/issues/3198","id":668654384,"node_id":"MDU6SXNzdWU2Njg2NTQzODQ=","number":3198,"title":"[BUG] Failed to load registered model from the FTP store","user":{"login":"Nielsmitie","id":18120782,"node_id":"MDQ6VXNlcjE4MTIwNzgy","avatar_url":"https://avatars.githubusercontent.com/u/18120782?v=4","gravatar_id":"","url":"https://api.github.com/users/Nielsmitie","html_url":"https://github.com/Nielsmitie","followers_url":"https://api.github.com/users/Nielsmitie/followers","following_url":"https://api.github.com/users/Nielsmitie/following{/other_user}","gists_url":"https://api.github.com/users/Nielsmitie/gists{/gist_id}","starred_url":"https://api.github.com/users/Nielsmitie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nielsmitie/subscriptions","organizations_url":"https://api.github.com/users/Nielsmitie/orgs","repos_url":"https://api.github.com/users/Nielsmitie/repos","events_url":"https://api.github.com/users/Nielsmitie/events{/privacy}","received_events_url":"https://api.github.com/users/Nielsmitie/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022863969,"node_id":"MDU6TGFiZWwyMDIyODYzOTY5","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-soon","name":"priority/important-soon","color":"534cb5","default":false,"description":"The issue is worked on by the community currently or will be very soon, ideally in time for the"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-07-30T12:03:38Z","updated_at":"2020-08-05T03:12:50Z","closed_at":"2020-08-05T03:12:50Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- I have written a small example that should be able to replicate the problem. The structure was taken from [issue 3197](https://github.com/mlflow/mlflow/issues/3197#issuecomment-666116249)\r\n- Ubuntu 18.04\r\n- MLflow binary\r\n- Mlflow version 1.10.0\r\n- Pyhton version: 3.8\r\n\r\n### Describe the problem\r\nLoading a model with `model = mlflow.sklearn.load_model('models:/' + 'model-reg' + '/Staging')` should return the model.\r\nInstead it throws an error.\r\n\r\n```shell script\r\nmlflow version: 1.10.0\r\ntracking URI: http://XXX.XXX.XXX.XXX:5000/\r\nartifact URI: ftp://mlflow:mlflow@XXX.XXX.XXX.XXX:2222/mlruns/721c37f3c87e4acdaea15b28029e4df8/artifacts\r\n```\r\n\r\n```shell script\r\nRegistered model 'model-reg' already exists. Creating a new version of this model...\r\nCreated version '6' of model 'model-reg'.\r\nTraceback (most recent call last):\r\n  File \"/home/monitoring/Projekt/MethodClasses/test/method_test/basic_ml_flow_test.py\", line 52, in <module>\r\n    test()\r\n  File \"/home/monitoring/Projekt/MethodClasses/test/method_test/basic_ml_flow_test.py\", line 45, in test\r\n    model = mlflow.sklearn.load_model('models:/' + 'model-reg' + '/Staging')\r\n  File \"/home/monitoring/.local/share/virtualenvs/MethodClasses-YeH10dls/lib/python3.8/site-packages/mlflow/sklearn.py\", line 334, in load_model\r\n    flavor_conf = _get_flavor_configuration(model_path=local_model_path, flavor_name=FLAVOR_NAME)\r\n  File \"/home/monitoring/.local/share/virtualenvs/MethodClasses-YeH10dls/lib/python3.8/site-packages/mlflow/utils/model_utils.py\", line 23, in _get_flavor_configuration\r\n    raise MlflowException(\r\nmlflow.exceptions.MlflowException: Could not find an \"MLmodel\" configuration file at \"/tmp/tmp42yolmhz/\"\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\nThe model was previously registered. It shows up in the web UI. The model is downloaded properly to a path in `/tmp/`.\r\nThe method in `mlflow.store.artifact.artifact_repo` returns the correct path to the files. E.g. `/tmp/tmp42yolmhz/model`. I manually checked the files MLmodel, conda.yml, model.pkl are inside the copied local dir `/tmp/tmp42yolmhz/model`.\r\n\r\nIn `mlflow.utils.model_utils` the function `_get_flavor_configuration` throws an exception, because it expects that model_path contains the files MLmodel, conda.yml, model.pkl, but model_path is `/tmp/tmp42yolmhz/ with contains only `model/` which then contains MLmodel, conda.yml, model.pkl.\r\n\r\n### Code to reproduce issue\r\nHopefully this is a reproducible test case with the bare minimum necessary to replicate the problem.\r\n\r\nModified example from [issue 3197](https://github.com/mlflow/mlflow/issues/3197#issuecomment-666116249).\r\n\r\nFTP-Server:\r\n```shell script\r\nsudo docker run -d --name ftpd_server -p 2222:21 -p 30000-30009:30000-30009 -e \"PUBLICHOST=XXX.XXX.XXX.XXX\"     -e FTP_USER_NAME=mlflow -e FTP_USER_PASS=mlflow -e FTP_USER_HOME=/home/mlflow stilliard/pure-ftpd\r\n```\r\n\r\n```python\r\nimport pandas as pd\r\n\r\nimport string\r\nimport random\r\n\r\nimport mlflow\r\nimport mlflow.sklearn\r\nfrom mlflow.tracking import MlflowClient\r\n\r\nfrom sklearn.preprocessing import StandardScaler\r\n\r\n\r\ndef test():\r\n    mlflow.set_tracking_uri('http://XXX.XXX.XXX.XXX:5000/')\r\n\r\n    def get_random_string(length):\r\n        letters = string.ascii_lowercase\r\n        return ''.join(random.choice(letters) for i in range(length))\r\n\r\n    expr_name = get_random_string(32)\r\n    artifact_location = \"ftp://mlflow:mlflow@XXX.XXX.XXX.XXX:2222/mlruns\"\r\n\r\n    if mlflow.get_experiment_by_name(expr_name) is None:\r\n        mlflow.create_experiment(expr_name, artifact_location)\r\n\r\n    mlflow.set_experiment(expr_name)\r\n\r\n    training_input = pd.DataFrame({'1': [1, 2, 3], '2': [4, 5, 6]})\r\n    predict_input = pd.DataFrame({'1': [10, 20, 30], '2': [40, 50, 60]})\r\n\r\n    with mlflow.start_run():\r\n        print('mlflow version:', mlflow.__version__)\r\n        print('tracking URI:', mlflow.get_tracking_uri())\r\n        print('artifact URI:', mlflow.get_artifact_uri())\r\n\r\n        scaler = StandardScaler()\r\n        output = scaler.fit_transform(training_input)\r\n\r\n        mlflow.sklearn.log_model(scaler, artifact_path='model',\r\n                                 registered_model_name='model-reg')\r\n        client = MlflowClient()\r\n        version = client.get_registered_model('model-reg').latest_versions[0].version\r\n        client.transition_model_version_stage('model-reg', version, 'Staging')\r\n\r\n        model = mlflow.sklearn.load_model('models:/' + 'model-reg' + '/Staging')\r\n\r\n        print(model)\r\n        print(model.predict(predict_input))\r\n```\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\nIf there are informations missing, I can include them here.\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3198/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3198/timeline","performed_via_github_app":null,"state_reason":"completed"}