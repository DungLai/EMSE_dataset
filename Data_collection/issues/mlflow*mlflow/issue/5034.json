{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5034","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5034/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5034/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5034/events","html_url":"https://github.com/mlflow/mlflow/issues/5034","id":1048732550,"node_id":"I_kwDOCB5Jx84-gmOG","number":5034,"title":"[BUG] Internal Server Error while launching the MLFlow UI","user":{"login":"dhirajsuvarna","id":4989127,"node_id":"MDQ6VXNlcjQ5ODkxMjc=","avatar_url":"https://avatars.githubusercontent.com/u/4989127?v=4","gravatar_id":"","url":"https://api.github.com/users/dhirajsuvarna","html_url":"https://github.com/dhirajsuvarna","followers_url":"https://api.github.com/users/dhirajsuvarna/followers","following_url":"https://api.github.com/users/dhirajsuvarna/following{/other_user}","gists_url":"https://api.github.com/users/dhirajsuvarna/gists{/gist_id}","starred_url":"https://api.github.com/users/dhirajsuvarna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhirajsuvarna/subscriptions","organizations_url":"https://api.github.com/users/dhirajsuvarna/orgs","repos_url":"https://api.github.com/users/dhirajsuvarna/repos","events_url":"https://api.github.com/users/dhirajsuvarna/events{/privacy}","received_events_url":"https://api.github.com/users/dhirajsuvarna/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-11-09T15:20:56Z","updated_at":"2022-08-12T06:27:57Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:  - No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: - Windows 10 \r\n- **MLflow installed from (source or binary)**: - binary (pip install mlflow)\r\n- **MLflow version (run ``mlflow --version``)**: - mlflow, version 1.21.0\r\n- **Python version**: - 3.9.5\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:  - Launch mlflow ui\r\n\r\n### Describe the problem\r\nWhen I launch the `mlflow ui` I get an error `500 Internal Server Error Internal Server Error The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.` \r\n\r\n### Code to reproduce issue\r\n1. Start the Tracking Server and point it to MS-SQL Server. \r\n2. Run the Training using train.py (I used the one from examples\\sklearn_elasticnet_wine\r\n3. Start the MLFlow UI using `mlflow ui` command and pointing `--backend-store-uri` to the MS-SQL Server \r\n4. Open the web page and go to `localhost:5000` \r\n\r\nFollowing error appears - \r\n\r\n![image](https://user-images.githubusercontent.com/4989127/140950877-75d4ab43-6e32-4b28-a15d-12a3b91b9592.png)\r\n\r\n\r\n### My Analysis\r\n\r\nThis is the problematic query - \r\n\r\n```\r\ndeclare @p1 int\r\nset @p1=NULL\r\nexec sp_prepexec @p1 output,N'@P1 int,@P2 int,@P3 nvarchar(2),@P4 nvarchar(12),@P5 int,@P6 int,@P7 int,@P8 int',\r\nN'SELECT DISTINCT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, \r\nruns.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, \r\nruns.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version \r\nAS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, \r\nruns.experiment_id AS runs_experiment_id, CASE WHEN (runs.start_time IS NULL) THEN @P1 ELSE @P2 END AS anon_1 \r\nFROM runs \r\nWHERE runs.experiment_id IN (@P3) AND runs.lifecycle_stage IN (@P4) ORDER BY CASE WHEN (runs.start_time IS NULL) THEN @P5 ELSE @P6 END, runs.start_time DESC, runs.run_uuid\r\n OFFSET @P7 ROWS\r\n FETCH FIRST @P8 ROWS ONLY',1,0,N'0',N'active',1,0,0,100\r\nselect @p1\r\n```\r\n\r\n\r\n### Other info / logs\r\n```\r\n2021/11/09 20:34:45 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/runs/search [POST]\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1799, in _execute_context\r\n    self.dialect.do_execute(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 717, in do_execute\r\n    cursor.execute(statement, parameters)\r\npyodbc.ProgrammingError: ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\store\\db\\utils.py\", line 79, in make_managed_session\r\n    yield session\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\store\\tracking\\sqlalchemy_store.py\", line 785, in _search_runs\r\n    query.distinct()\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 2711, in all\r\n    return self._iter().all()\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 2846, in _iter\r\n    result = self.session.execute(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1689, in execute\r\n    result = conn._execute_20(statement, params or {}, execution_options)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1611, in _execute_20\r\n    return meth(self, args_10style, kwargs_10style, execution_options)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 325, in _execute_on_connection\r\n    return connection._execute_clauseelement(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1478, in _execute_clauseelement\r\n    ret = self._execute_context(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1842, in _execute_context\r\n    self._handle_dbapi_exception(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2023, in _handle_dbapi_exception\r\n    util.raise_(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\util\\compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1799, in _execute_context\r\n    self.dialect.do_execute(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 717, in do_execute\r\n    cursor.execute(statement, parameters)\r\nsqlalchemy.exc.ProgrammingError: (pyodbc.ProgrammingError) ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')\r\n[SQL: SELECT DISTINCT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END AS anon_1\r\nFROM runs\r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END, runs.start_time DESC, runs.run_uuid\r\n OFFSET ? ROWS\r\n FETCH FIRST ? ROWS ONLY]\r\n[parameters: (1, 0, '0', 'active', 1, 0, 0, 100)]\r\n(Background on this error at: https://sqlalche.me/e/14/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\server\\handlers.py\", line 214, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\server\\handlers.py\", line 467, in _search_runs\r\n    run_entities = _get_tracking_store().search_runs(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\store\\tracking\\abstract_store.py\", line 242, in search_runs\r\n    runs, token = self._search_runs(\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\store\\tracking\\sqlalchemy_store.py\", line 799, in _search_runs\r\n    next_page_token = compute_next_token(len(runs))\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\contextlib.py\", line 135, in __exit__\r\n    self.gen.throw(type, value, traceback)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\store\\db\\utils.py\", line 86, in make_managed_session\r\n    raise MlflowException(message=e, error_code=INTERNAL_ERROR)\r\nmlflow.exceptions.MlflowException: (pyodbc.ProgrammingError) ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')\r\n[SQL: SELECT DISTINCT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END AS anon_1\r\nFROM runs\r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END, runs.start_time DESC, runs.run_uuid\r\n OFFSET ? ROWS\r\n FETCH FIRST ? ROWS ONLY]\r\n[parameters: (1, 0, '0', 'active', 1, 0, 0, 100)]\r\n(Background on this error at: https://sqlalche.me/e/14/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\flask\\app.py\", line 2073, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\flask\\app.py\", line 1518, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\flask\\app.py\", line 1516, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\flask\\app.py\", line 1502, in dispatch_request\r\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\server\\handlers.py\", line 217, in wrapper\r\n    response.set_data(e.serialize_as_json())\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\site-packages\\mlflow\\exceptions.py\", line 60, in serialize_as_json\r\n    return json.dumps(exception_dict)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\json\\__init__.py\", line 231, in dumps\r\n    return _default_encoder.encode(obj)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\json\\encoder.py\", line 199, in encode\r\n    chunks = self.iterencode(o, _one_shot=True)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\json\\encoder.py\", line 257, in iterencode\r\n    return _iterencode(o, 0)\r\n  File \"c:\\users\\dhiraj.suvarna\\anaconda3\\envs\\learnenv\\lib\\json\\encoder.py\", line 179, in default\r\n    raise TypeError(f'Object of type {o.__class__.__name__} '\r\n```\r\n\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5034/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5034/timeline","performed_via_github_app":null,"state_reason":null}