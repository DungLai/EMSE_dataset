{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5787","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5787/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5787/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5787/events","html_url":"https://github.com/mlflow/mlflow/issues/5787","id":1216949011,"node_id":"I_kwDOCB5Jx85IiSsT","number":5787,"title":"[BUG] Error while upgrading the database schema (Duplicated key name 'index_params_run_uuid')","user":{"login":"pedrety","id":17024367,"node_id":"MDQ6VXNlcjE3MDI0MzY3","avatar_url":"https://avatars.githubusercontent.com/u/17024367?v=4","gravatar_id":"","url":"https://api.github.com/users/pedrety","html_url":"https://github.com/pedrety","followers_url":"https://api.github.com/users/pedrety/followers","following_url":"https://api.github.com/users/pedrety/following{/other_user}","gists_url":"https://api.github.com/users/pedrety/gists{/gist_id}","starred_url":"https://api.github.com/users/pedrety/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pedrety/subscriptions","organizations_url":"https://api.github.com/users/pedrety/orgs","repos_url":"https://api.github.com/users/pedrety/repos","events_url":"https://api.github.com/users/pedrety/events{/privacy}","received_events_url":"https://api.github.com/users/pedrety/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-27T07:52:22Z","updated_at":"2022-05-03T18:51:46Z","closed_at":"2022-05-03T18:51:45Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 20.04\r\n- **MLflow installed from (source or binary)**: From pip package manager\r\n- **MLflow version (run ``mlflow --version``)**: 1.25.1\r\n- **Python version**: 3.8.10\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: `mlflow db upgrade <database_uri>`\r\n\r\n### Describe the problem\r\n\r\nI'm trying to upgrade the database schema when upgrading my mlflow server from 1.24 to 1.25.1. When running the command to achieve this I get the following error: `sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1061, \"Duplicate key name 'index_params_run_uuid'\")`. I've checked the database and it is true that index exists, but I cannot delete it because it's a foreign key for something else (something I can't found apparently). \r\n\r\nWhen running the server in 1.24 version I don't get any error whatsoever, so I'm guessing the issue is in that upgrade made by [this function](https://github.com/mlflow/mlflow/blob/0489b01ebbf46bd78a1c8e6a3938891b118b7152/mlflow/store/db_migrations/versions/bd07f7e963c5_create_index_on_run_uuid.py#L18). For the record I'm running a MySQL database not a PostgreSQL, and that upgrade seems to affect PostgreSQL according to the commit message. \r\n\r\n[Here](https://github.com/mlflow/mlflow/tree/master/mlflow/store/db_migrations#readme) is a section which indicates what to do in case the migration fails, but it seems to be outdated, I guess if there is some procedure to revert the migration in my case (c48cb773bb87 -> bd07f7e963c5).\r\n\r\n### Code to reproduce issue\r\n\r\nI'm running this in 3 docker containers (one for the backend store, artifact store and the actual mlflow server).\r\n\r\nThe artifact store is a MinIO storage deployed as follows:\r\n\r\n```\r\nserver  --address \"0.0.0.0:9000\" --console-address \"0.0.0.0:9876\" /data\r\n```\r\n\r\nWhere `/data` is the directory with all the files related to runs.\r\n\r\nThe backend store is a MySQL database in its version 8.0.22.\r\n\r\nFinally the mlflow server is deployed as follows, in its version 1.25.1 (which fails when upgrading the database):\r\n\r\n```\r\nmlflow server --backend-store-uri mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@${HOST_IP}:5001/mlflow --default-artifact-root s3://mlflow/ --host 0.0.0.0 \r\n```\r\n\r\nAll those docker containers are deployed using docker-compose and the error comes when I run the mlflow server with the db upgrade option:\r\n\r\n```\r\ndocker-compose -f mlflow.yml run mlflow mlflow db upgrade mysql+pymysql://<user>:<password>@<database_uri>:<port>/mlflow\r\n```\r\n\r\n### Other info / logs\r\n\r\nAfter getting the artifact store and the backend store up and running, executing the mlflow server as described before I get this error:\r\n\r\n```bash\r\nCreating mlflow-server_mlflow_run ... done                                                                                                                                                                         \r\n2022/04/27 06:57:54 INFO mlflow.store.db.utils: Updating database tables                                                                                                                                           \r\nINFO  [alembic.runtime.migration] Context impl MySQLImpl.                                                                                                                                                          \r\nINFO  [alembic.runtime.migration] Will assume non-transactional DDL.                                                                                                                                               \r\nINFO  [alembic.runtime.migration] Running upgrade c48cb773bb87 -> bd07f7e963c5, create index on run_uuid                                                                                                           \r\nTraceback (most recent call last):                                                                                                                                                                                 \r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1819, in _execute_context                                                                                                          \r\n    self.dialect.do_execute(                                                                                                                                                                                       \r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/default.py\", line 732, in do_execute                                                                                                              \r\n    cursor.execute(statement, parameters)                                                                                                                                                                          \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/cursors.py\", line 148, in execute                                                                                                                           \r\n    result = self._query(query)                                                                                                                                                                                    \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/cursors.py\", line 310, in _query                                                                                                                            \r\n    conn.query(q)                                                                                                                                                                                                  \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 548, in query                                                                                                                         \r\n    self._affected_rows = self._read_query_result(unbuffered=unbuffered)                                                                                                                                           \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 775, in _read_query_result                                                                                                            \r\n    result.read()                                                                                                                                                                                                  \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 1156, in read                                                                                                                         \r\n    first_packet = self.connection._read_packet()                                                                                                                                                                  \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 725, in _read_packet                                                                                                                  \r\n    packet.raise_for_error()                                                                                                                                                                                       \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/protocol.py\", line 221, in raise_for_error                                                                                                                  \r\n    err.raise_mysql_exception(self._data)                                                                                                                                                                          \r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/err.py\", line 143, in raise_mysql_exception                                                                                                                 \r\n    raise errorclass(errno, errval)                                                                                                                                                                                \r\npymysql.err.OperationalError: (1061, \"Duplicate key name 'index_params_run_uuid'\")\r\n\r\nThe above exception was the direct cause of the following exception:                                                                                                                                               \r\n                                                                                                                                                                                                                   \r\nTraceback (most recent call last):                                                                                                                                                                                 \r\n  File \"/usr/local/bin/mlflow\", line 8, in <module>                                                                                                                                                                \r\n    sys.exit(cli())                                                                                                                                                                                                \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1130, in __call__                                                                                                                              \r\n    return self.main(*args, **kwargs)                                                                                                                                                                              \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1055, in main                                                                                                                                  \r\n    rv = self.invoke(ctx)                                                                                                                                                                                          \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1657, in invoke                                                                                                                                \r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))                                                                                                                                                        \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1657, in invoke                                                                                                                                \r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))                                                                                                                                                        \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1404, in invoke                                                                                                                                \r\n    return ctx.invoke(self.callback, **ctx.params)                                                                                                                                                                 \r\n  File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 760, in invoke                                                                                                                                 \r\n    return __callback(*args, **kwargs)                                                                                                                                                                             \r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/db.py\", line 28, in upgrade\r\n    mlflow.store.db.utils._upgrade_db(engine)\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/store/db/utils.py\", line 145, in _upgrade_db\r\n    command.upgrade(config, \"heads\")\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/command.py\", line 320, in upgrade\r\n    script.run_env()\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/script/base.py\", line 563, in run_env\r\n    util.load_python_file(self.dir, \"env.py\")\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/util/pyfiles.py\", line 92, in load_python_file\r\n    module = load_module_py(module_id, path)\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/util/pyfiles.py\", line 108, in load_module_py\r\n    spec.loader.exec_module(module)  # type: ignore\r\n  File \"<frozen importlib._bootstrap_external>\", line 783, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/store/db_migrations/env.py\", line 84, in <module>\r\n    run_migrations_online()\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/store/db_migrations/env.py\", line 78, in run_migrations_online\r\n    context.run_migrations()\r\n  File \"<string>\", line 8, in run_migrations\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/runtime/environment.py\", line 851, in run_migrations\r\n    self.get_context().run_migrations(**kw)\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/runtime/migration.py\", line 620, in run_migrations \r\n    step.migration_fn(**kw)\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/store/db_migrations/versions/bd07f7e963c5_create_index_on_run_uuid.py\", line 22, in upgrade\r\n    op.create_index(f\"index_{table}_run_uuid\", table, [\"run_uuid\"])\r\n  File \"<string>\", line 8, in create_index\r\n  File \"<string>\", line 3, in create_index\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/operations/ops.py\", line 966, in create_index\r\n    return operations.invoke(op)\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/operations/base.py\", line 392, in invoke\r\n    return fn(self, operation)\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/operations/toimpl.py\", line 99, in create_index\r\n    operations.impl.create_index(idx)\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/ddl/impl.py\", line 375, in create_index\r\n    self._exec(schema.CreateIndex(index))\r\n  File \"/usr/local/lib/python3.8/site-packages/alembic/ddl/impl.py\", line 193, in _exec\r\n    return conn.execute(construct, multiparams)\r\nFile \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1306, in execute\r\n    return meth(self, multiparams, params, _EMPTY_EXECUTION_OPTS)\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/sql/ddl.py\", line 80, in _execute_on_connection \r\n    return connection._execute_ddl(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1398, in _execute_ddl\r\n    ret = self._execute_context(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1862, in _execute_context \r\n    self._handle_dbapi_exception(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 2043, in _handle_dbapi_exception\r\n    util.raise_(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1819, in _execute_context \r\n    self.dialect.do_execute(\r\n  File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/default.py\", line 732, in do_execute\r\n    cursor.execute(statement, parameters)\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/cursors.py\", line 148, in execute\r\n    result = self._query(query)\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/cursors.py\", line 310, in _query\r\n    conn.query(q)\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 548, in query\r\n    self._affected_rows = self._read_query_result(unbuffered=unbuffered)\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 775, in _read_query_result\r\n    result.read()\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 1156, in read\r\n    first_packet = self.connection._read_packet()\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/connections.py\", line 725, in _read_packet\r\n    packet.raise_for_error()\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/protocol.py\", line 221, in raise_for_error\r\n    err.raise_mysql_exception(self._data)\r\n  File \"/usr/local/lib/python3.8/site-packages/pymysql/err.py\", line 143, in raise_mysql_exception\r\n    raise errorclass(errno, errval)\r\nsqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1061, \"Duplicate key name 'index_params_run_uuid'\")\r\n[SQL: CREATE INDEX index_params_run_uuid ON params (run_uuid)]\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\r\n```\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\n\r\nComponents\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [x] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5787/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5787/timeline","performed_via_github_app":null,"state_reason":"completed"}