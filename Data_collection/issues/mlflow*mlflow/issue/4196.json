{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4196","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4196/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4196/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4196/events","html_url":"https://github.com/mlflow/mlflow/issues/4196","id":838069841,"node_id":"MDU6SXNzdWU4MzgwNjk4NDE=","number":4196,"title":"[SETUP-BUG] MLFLOW database session expires for AWS RDS Serverless database","user":{"login":"vas610","id":64650227,"node_id":"MDQ6VXNlcjY0NjUwMjI3","avatar_url":"https://avatars.githubusercontent.com/u/64650227?v=4","gravatar_id":"","url":"https://api.github.com/users/vas610","html_url":"https://github.com/vas610","followers_url":"https://api.github.com/users/vas610/followers","following_url":"https://api.github.com/users/vas610/following{/other_user}","gists_url":"https://api.github.com/users/vas610/gists{/gist_id}","starred_url":"https://api.github.com/users/vas610/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vas610/subscriptions","organizations_url":"https://api.github.com/users/vas610/orgs","repos_url":"https://api.github.com/users/vas610/repos","events_url":"https://api.github.com/users/vas610/events{/privacy}","received_events_url":"https://api.github.com/users/vas610/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-03-22T20:09:51Z","updated_at":"2021-07-30T17:41:08Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\n- **MLflow installed from (source or binary)**: pip\r\n- **MLflow version (run ``mlflow --version``)**: 1.14.1\r\n- **Python version**:   3.7\r\n   - mlflow==1.14.1\r\n   - pg8000==1.16.5\r\n- **Exact command to reproduce**:\r\n   ```shell\r\n   mlflow server \\\r\n      --host 0.0.0.0 \\\r\n      --port 5000 \\\r\n      --backend-store-uri \"postgresql+pg8000://${USERNAME}:${URL_COMPATIBLE_PASSWORD}@${HOST}:${PORT}/${DATABASE_NAME}\" \\\r\n    --default-artifact-root ${DEFAULT_ARTIFACT_ROOT}\r\n   ```\r\n\r\n### Describe the problem\r\n\r\nWhen using AWS RDS Serverless (postgres) as the backend data store, the MLFLOW server doesn't create a new database session whenever the Serverless database comes online after pausing due to no activity. Currently running MLFLOW  on a AWS ECS cluster. So, whenever I encounter the issue, I kill the existing ECS task and create a new one and the error goes away.\r\n\r\n### Other info / logs\r\n\r\n```shell\r\n2021-03-22 13:24:412021/03/22 13:24:41 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/experiments/list [GET]\r\n2021-03-22 13:24:41Traceback (most recent call last):\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/store/db/utils.py\", line 80, in make_managed_session\r\n2021-03-22 13:24:41yield session\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 258, in list_experiments\r\n2021-03-22 13:24:41for exp in self._list_experiments(session=session, view_type=view_type, eager=True)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 252, in _list_experiments\r\n2021-03-22 13:24:41return session.query(SqlExperiment).options(*query_options).filter(*conditions).all()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3373, in all\r\n2021-03-22 13:24:41return list(self)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3535, in __iter__\r\n2021-03-22 13:24:41return self._execute_and_instances(context)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3557, in _execute_and_instances\r\n2021-03-22 13:24:41querycontext, self._connection_from_session, close_with_result=True\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3572, in _get_bind_args\r\n2021-03-22 13:24:41mapper=self._bind_mapper(), clause=querycontext.statement, **kw\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3550, in _connection_from_session\r\n2021-03-22 13:24:41conn = self.session.connection(**kw)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 1145, in connection\r\n2021-03-22 13:24:41execution_options=execution_options,\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 1151, in _connection_for_bind\r\n2021-03-22 13:24:41engine, execution_options\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 433, in _connection_for_bind\r\n2021-03-22 13:24:41conn = bind._contextual_connect()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 2302, in _contextual_connect\r\n2021-03-22 13:24:41self._wrap_pool_connect(self.pool.connect, None),\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/base.py\", line 2336, in _wrap_pool_connect\r\n2021-03-22 13:24:41return fn()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/pool/base.py\", line 364, in connect\r\n2021-03-22 13:24:41return _ConnectionFairy._checkout(self)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/pool/base.py\", line 809, in _checkout\r\n2021-03-22 13:24:41result = pool._dialect.do_ping(fairy.connection)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/sqlalchemy/engine/default.py\", line 575, in do_ping\r\n2021-03-22 13:24:41cursor.execute(self._dialect_specific_select_one)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/pg8000/core.py\", line 340, in execute\r\n2021-03-22 13:24:41self._c.execute_unnamed(self, \"begin transaction\")\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/pg8000/core.py\", line 1213, in execute_unnamed\r\n2021-03-22 13:24:41self._flush()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/socket.py\", line 607, in write\r\n2021-03-22 13:24:41return self._sock.send(b)\r\n2021-03-22 13:24:41TimeoutError: [Errno 110] Connection timed out\r\n2021-03-22 13:24:41During handling of the above exception, another exception occurred:\r\n2021-03-22 13:24:41Traceback (most recent call last):\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 214, in wrapper\r\n2021-03-22 13:24:41return func(*args, **kwargs)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 510, in _list_experiments\r\n2021-03-22 13:24:41experiment_entities = _get_tracking_store().list_experiments(request_message.view_type)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 258, in list_experiments\r\n2021-03-22 13:24:41for exp in self._list_experiments(session=session, view_type=view_type, eager=True)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/contextlib.py\", line 130, in __exit__\r\n2021-03-22 13:24:41self.gen.throw(type, value, traceback)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/store/db/utils.py\", line 87, in make_managed_session\r\n2021-03-22 13:24:41raise MlflowException(message=e, error_code=INTERNAL_ERROR)\r\n2021-03-22 13:24:41mlflow.exceptions.MlflowException: [Errno 110] Connection timed out\r\n2021-03-22 13:24:41During handling of the above exception, another exception occurred:\r\n2021-03-22 13:24:41Traceback (most recent call last):\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 2447, in wsgi_app\r\n2021-03-22 13:24:41response = self.full_dispatch_request()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1952, in full_dispatch_request\r\n2021-03-22 13:24:41rv = self.handle_user_exception(e)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1821, in handle_user_exception\r\n2021-03-22 13:24:41reraise(exc_type, exc_value, tb)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/_compat.py\", line 39, in reraise\r\n2021-03-22 13:24:41raise value\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1950, in full_dispatch_request\r\n2021-03-22 13:24:41rv = self.dispatch_request()\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/flask/app.py\", line 1936, in dispatch_request\r\n2021-03-22 13:24:41return self.view_functions[rule.endpoint](**req.view_args)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 217, in wrapper\r\n2021-03-22 13:24:41response.set_data(e.serialize_as_json())\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/site-packages/mlflow/exceptions.py\", line 60, in serialize_as_json\r\n2021-03-22 13:24:41return json.dumps(exception_dict)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/json/__init__.py\", line 231, in dumps\r\n2021-03-22 13:24:41return _default_encoder.encode(obj)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/json/encoder.py\", line 199, in encode\r\n2021-03-22 13:24:41chunks = self.iterencode(o, _one_shot=True)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/json/encoder.py\", line 257, in iterencode\r\n2021-03-22 13:24:41return _iterencode(o, 0)\r\n2021-03-22 13:24:41File \"/usr/local/lib/python3.7/json/encoder.py\", line 179, in default\r\n2021-03-22 13:24:41raise TypeError(f'Object of type {o.__class__.__name__} '\r\n2021-03-22 13:24:41TypeError: Object of type TimeoutError is not JSON serializable\r\n```\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4196/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4196/timeline","performed_via_github_app":null,"state_reason":null}