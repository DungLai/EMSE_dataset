{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4495","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4495/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4495/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4495/events","html_url":"https://github.com/mlflow/mlflow/issues/4495","id":927878197,"node_id":"MDU6SXNzdWU5Mjc4NzgxOTc=","number":4495,"title":"Unable to use cloud SQL(postgre) backend for mlflow version > 1.11.0 [BUG]","user":{"login":"dalavayi","id":72725647,"node_id":"MDQ6VXNlcjcyNzI1NjQ3","avatar_url":"https://avatars.githubusercontent.com/u/72725647?v=4","gravatar_id":"","url":"https://api.github.com/users/dalavayi","html_url":"https://github.com/dalavayi","followers_url":"https://api.github.com/users/dalavayi/followers","following_url":"https://api.github.com/users/dalavayi/following{/other_user}","gists_url":"https://api.github.com/users/dalavayi/gists{/gist_id}","starred_url":"https://api.github.com/users/dalavayi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dalavayi/subscriptions","organizations_url":"https://api.github.com/users/dalavayi/orgs","repos_url":"https://api.github.com/users/dalavayi/repos","events_url":"https://api.github.com/users/dalavayi/events{/privacy}","received_events_url":"https://api.github.com/users/dalavayi/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-06-23T05:38:31Z","updated_at":"2022-12-09T17:07:24Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [*] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Container with python3.8-slim base image\r\n- **MLflow installed from (source or binary)**: source\r\n- **MLflow version (run ``mlflow --version``)**: anything greater than >1.11.0, i am trying to make it work for 1.17.0\r\n- **Python version**: 3.8-slim\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: exec gunicorn -b \"0.0.0.0:8080\" -w 4 --log-level debug --access-logfile=- --error-logfile=- --log-level=debug mlflow_auth:app\r\n------------------------\r\n### Describe the problem\r\nThe mlflow server is working fine with the same setup(deployed on cloud run, artifact store: gcs bucket, backend : postgresql db on gcp cloud sql instance) with mlflow version 1.11.0, and pg8000 version 1.16.5, when i try to upgrade the mlflow version to 1.17.0 or any other version greater thatn 1.11.0, it requires a pg8000 version >1.16.6, when i provide the greater version, i get many errors in the cloud run logs. \r\n\r\n### Code to reproduce issue\r\n- files and commands used mentioned below\r\n-----------------\r\nrequirements.txt\r\n------------------\r\ngoogle-cloud-storage==1.31.2\r\nmlflow==1.17.0\r\nclick==7.1.2\r\npg8000==1.16.6\r\ngunicorn==20.0.4\r\npsycopg2-binary==2.8.6\r\n\r\n-----------------\r\nmlflow_auth.py\r\n-----------------\r\nfrom mlflow.server import app as mlflow_app\r\nfrom wsgi_basic_auth import BasicAuth\r\n\r\napp = BasicAuth(mlflow_app)\r\n\r\n----------------\r\nentry-point.sh\r\n----------------\r\nexport _MLFLOW_SERVER_ARTIFACT_ROOT=gs://mybucket\r\nexport _MLFLOW_SERVER_FILE_STORE=postgresql+pg8000://username:pwd@/mlflowdb?unix_sock=/cloudsql/my-project:us-central1:mlflow/.s.PGSQL.5432\r\n\r\nexec gunicorn -b \"0.0.0.0:8080\" -w 4 --log-level debug --access-logfile=- --error-logfile=- --log-level=debug mlflow_auth:app\r\n\r\n\r\n\r\n### Other info / logs\r\nlocal/lib/python3.8/site-packages/mlflow/store/db/utils.py\", line 80, in make_managed_session yield session File \"/usr/local/lib/python3.8/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 304, in get_experiment return self._get_experiment( File \"/usr/local/lib/python3.8/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 272, in _get_experiment session.query(SqlExperiment) File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/orm/query.py\", line 2776, in one_or_none return self._iter().one_or_none() File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/orm/query.py\", line 2834, in _iter result = self.session.execute( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/orm/session.py\", line 1689, in execute result = conn._execute_20(statement, params or {}, execution_options) File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1582, in _execute_20 return meth(self, args_10style, kwargs_10style, execution_options) File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/sql/elements.py\", line 324, in _execute_on_connection return connection._execute_clauseelement( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1451, in _execute_clauseelement ret = self._execute_context( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1813, in _execute_context self._handle_dbapi_exception( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1994, in _handle_dbapi_exception util.raise_( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_ raise exception File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/base.py\", line 1770, in _execute_context self.dialect.do_execute( File \"/usr/local/lib/python3.8/site-packages/sqlalchemy/engine/default.py\", line 717, in do_execute cursor.execute(statement, parameters) File \"/usr/local/lib/python3.8/site-packages/pg8000/core.py\", line 341, in execute self._c.execute_unnamed( File \"/usr/local/lib/python3.8/site-packages/pg8000/core.py\", line 1225, in execute_unnamed self.handle_messages(cursor) File \"/usr/local/lib/python3.8/site-packages/pg8000/core.py\", line 1381, in handle_messages raise self.error sqlalchemy.exc.ProgrammingError: (pg8000.exceptions.ProgrammingError) {'S': 'ERROR', 'V': 'ERROR', 'C': '42883', 'M': 'operator does not exist: integer = character varying', 'H': 'No operator matches the given name and argument types. You might need to add explicit type casts.', 'P': '276', 'F': 'parse_oper.c', 'L': '731', 'R': 'op_error'}\r\n\r\n[SQL: SELECT experiments.experiment_id AS experiments_experiment_id, experiments.name AS experiments_name, experiments.artifact_location AS experiments_artifact_location, experiments.lifecycle_stage AS experiments_lifecycle_stage\r\nDefault\r\n2021-06-22T15:57:48.560678ZFROM experiments\r\nWHERE experiments.experiment_id = %s AND experiments.lifecycle_stage IN (%s, %s)]\r\nDefault\r\n2021-06-22T15:57:48.560777Z[parameters: ('0', 'active', 'deleted')]\r\nDefault\r\n2021-06-22T15:57:48.560788Z(Background on this error at: http://sqlalche.me/e/14/f405)\r\nError\r\n2021-06-22T15:57:48.560828ZTraceback (most recent call last): File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 2070, in wsgi_app response = self.full_dispatch_request() File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1515, in full_dispatch_request rv = self.handle_user_exception(e) File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1513, in full_dispatch_request rv = self.dispatch_request() File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1499, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File \"/usr/local/lib/python3.8/site-packages/mlflow/server/handlers.py\", line 217, in wrapper response.set_data(e.serialize_as_json()) File \"/usr/local/lib/python3.8/site-packages/mlflow/exceptions.py\", line 60, in serialize_as_json return json.dumps(exception_dict) File \"/usr/local/lib/python3.8/json/__init__.py\", line 231, in dumps return _default_encoder.encode(obj) File \"/usr/local/lib/python3.8/json/encoder.py\", line 199, in encode chunks = self.iterencode(o, _one_shot=True) File \"/usr/local/lib/python3.8/json/encoder.py\", line 257, in iterencode return _iterencode(o, 0) File \"/usr/local/lib/python3.8/json/encoder.py\", line 179, in default raise TypeError(f'Object of type {o.__class__.__name__} ' TypeError: Object of type ProgrammingError is not JSON serializable\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [*] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [*] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [*] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [*] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\npython\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\nGCP ","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4495/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4495/timeline","performed_via_github_app":null,"state_reason":null}