{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4624","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4624/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4624/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4624/events","html_url":"https://github.com/mlflow/mlflow/issues/4624","id":955550299,"node_id":"MDU6SXNzdWU5NTU1NTAyOTk=","number":4624,"title":"[DOC-FIX] Adding custom flavors","user":{"login":"PowerToThePeople111","id":17195501,"node_id":"MDQ6VXNlcjE3MTk1NTAx","avatar_url":"https://avatars.githubusercontent.com/u/17195501?v=4","gravatar_id":"","url":"https://api.github.com/users/PowerToThePeople111","html_url":"https://github.com/PowerToThePeople111","followers_url":"https://api.github.com/users/PowerToThePeople111/followers","following_url":"https://api.github.com/users/PowerToThePeople111/following{/other_user}","gists_url":"https://api.github.com/users/PowerToThePeople111/gists{/gist_id}","starred_url":"https://api.github.com/users/PowerToThePeople111/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PowerToThePeople111/subscriptions","organizations_url":"https://api.github.com/users/PowerToThePeople111/orgs","repos_url":"https://api.github.com/users/PowerToThePeople111/repos","events_url":"https://api.github.com/users/PowerToThePeople111/events{/privacy}","received_events_url":"https://api.github.com/users/PowerToThePeople111/received_events","type":"User","site_admin":false},"labels":[{"id":978584226,"node_id":"MDU6TGFiZWw5Nzg1ODQyMjY=","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docs","name":"area/docs","color":"48eabc","default":false,"description":"Documentation issues"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-29T07:34:33Z","updated_at":"2021-07-30T13:08:03Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for information on what types of issues we address.\r\n\r\n**Please fill in this documentation issue template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages documentation fix contributions. Would you or another member of your organization be willing to contribute a fix for this documentation issue to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a documentation fix independently.\r\n- [ x] Yes. I would be willing to contribute a document fix with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a documentation fix at this time.\r\n\r\n### URL(s) with the issue:\r\n\r\nhttps://www.mlflow.org/docs/latest/models.html#custom-flavors\r\n\r\n### Description of proposal (what needs changing):\r\nIn order to be able to add support for our spark models that produce multidimensional output vectors I wanted to add a modified version of the mlflow.spark flavor without working on a fork of your project. I took the fact that this should be possible from the referenced url:\r\n\r\n`To create a new flavor to support a custom model, you define the set of flavor-specific attributes to include in the MLmodel configuration file, as well as the code that can interpret the contents of the model directory and the flavorâ€™s attributes.`\r\n\r\nSadly, I find it hard to understand how to do that given the documentation. \r\nDo I need to create a plugin for that?\r\nIf so, what endpoints do I need to implement?\r\n\r\nSimply adding a modified version of `mlflow/spark.py ` where I adapted ...\r\n\r\n- the `predict` method\r\n- FLAVOR_NAME, DFS_TMP, _SPARK_MODEL_PATH_SUB\r\n- the default values of `flavor` params in several methods to point to this python file\r\n- the `loader_module` param in the `_save_model_metadata` function:\r\n```\r\npyfunc.add_to_model(\r\n        mlflow_model,\r\n        loader_module=\"flavors.custom_spark_flavor\",\r\n        data=_SPARK_MODEL_PATH_SUB,\r\n        env=conda_env_subpath,\r\n    )\r\n```\r\nto my project and calling this new `flavor`'s `log`  methods did not help, since the model still uses the original code of the predict method from  `mlflow/spark.py `when being deployed with `mlflow serve`.\r\n\r\nAlso all attempts to create the respective scalar output using spark transformers did not succeed. I tried to use the SQLTransformer with udfs to extract classifier scores (in the `probability` output column of the model) values because I found no other transformer that takes a vector column as input and returns a scalar column. But those udfs like `vector_to_array` are not known when predictions are made with mlflow-logged and served models.\r\n\r\nIf someone could provide details or an example of how to add new flavors, I would love to contribute a document that explains the required steps to make it happen.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4624/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4624/timeline","performed_via_github_app":null,"state_reason":null}