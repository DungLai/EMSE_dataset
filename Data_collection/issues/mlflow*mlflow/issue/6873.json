{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6873","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6873/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6873/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6873/events","html_url":"https://github.com/mlflow/mlflow/issues/6873","id":1384034400,"node_id":"I_kwDOCB5Jx85SfrBg","number":6873,"title":"[BUG] keras.log_model tensorflow_probabilistic raises an error","user":{"login":"forons","id":4101332,"node_id":"MDQ6VXNlcjQxMDEzMzI=","avatar_url":"https://avatars.githubusercontent.com/u/4101332?v=4","gravatar_id":"","url":"https://api.github.com/users/forons","html_url":"https://github.com/forons","followers_url":"https://api.github.com/users/forons/followers","following_url":"https://api.github.com/users/forons/following{/other_user}","gists_url":"https://api.github.com/users/forons/gists{/gist_id}","starred_url":"https://api.github.com/users/forons/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/forons/subscriptions","organizations_url":"https://api.github.com/users/forons/orgs","repos_url":"https://api.github.com/users/forons/repos","events_url":"https://api.github.com/users/forons/events{/privacy}","received_events_url":"https://api.github.com/users/forons/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2022-09-23T16:23:11Z","updated_at":"2022-10-01T00:23:29Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n1.26.0\r\n\r\n### System information\r\n\r\n- MacOS Monterey with M1 Chip\r\n- 3.8.13\r\n\r\n\r\n### Describe the problem\r\n\r\nI have a keras model that has a tfp.layers.DistributionLambda(tfd.Poisson)(input) (https://www.tensorflow.org/probability/api_docs/python/tfp/layers/DistributionLambda, https://www.tensorflow.org/probability/api_docs/python/tfp/distributions/Poisson for reference).\r\n\r\nIn order to store the model locally, I save it just by doing: `model.save(destination_path)`.\r\nThen, to load it, I simply do: \r\n```\r\nimport keras\r\nimport tensorflow as tf\r\nkeras.models.load_model(file_path, compile=False, custom_objects={'exp': tf.exp})\r\n```\r\n\r\nInstead, when I try to log it to mlflow by doing: `mlflow.keras.log_model(keras_model, path)` I get the following error:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/Users/user/dev/project/src/utils/mlflow_utils.py\", line 54, in log\r\n    model_info = mlflow.keras.log_model(model, 'model', keras_module=keras, custom_objects={'exp': tf.exp})\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/keras.py\", line 416, in log_model\r\n    return Model.log(\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/models/model.py\", line 294, in log\r\n    flavor.save_model(path=local_path, mlflow_model=mlflow_model, **kwargs)\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/keras.py\", line 268, in save_model\r\n    keras_model.save(model_path, **kwargs)\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/site-packages/keras/utils/traceback_utils.py\", line 67, in error_handler\r\n    raise e.with_traceback(filtered_tb) from None\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/contextlib.py\", line 120, in __exit__\r\n    next(self.gen)\r\n  File \"/Users/user/miniforge3/envs/py38/lib/python3.8/site-packages/tensorflow_probability/python/layers/distribution_layer.py\", line 224, in __call__\r\n    distribution, _ = super(DistributionLambda, self).__call__(\r\ntensorflow.python.framework.errors_impl.OperatorNotAllowedInGraphError: Iterating over a symbolic `tf.Tensor` is not allowed: AutoGraph did convert this function. This might indicate you are trying to use an unsupported feature.\r\npython-BaseException\r\n```\r\n\r\nI also tried by adding the `custom_objects` parameter (so by doing `mlflow.keras.log_model(keras_model, path, custom_objects={'exp': tf.exp})`, but I still get the same error.\r\n\r\nCould you please help me?\r\n\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\n```python\r\n\r\nimport mlflow\r\nimport tensorflow as tf\r\nimport tensorflow_probability as tfp\r\nfrom sklearn.datasets import load_iris\r\n\r\ntfd = tfp.distributions\r\n\r\nX, y = load_iris(return_X_y=True)\r\n\r\ninputs = tf.keras.layers.Input(shape=(X.shape[1],))\r\nx = tf.keras.layers.Dense(30, \"relu\")(inputs)\r\noutput = tf.keras.layers.Dense(1, activation=tf.exp)(x)\r\np_y = tfp.layers.DistributionLambda(tfd.Poisson)(output)\r\nmodel = tf.keras.Model(inputs=inputs, outputs=p_y)\r\n\r\noptimizer = tf.keras.optimizers.Adam(learning_rate=0.1)\r\n\r\ndef nll(y_true, y_pred):\r\n    return -y_pred.log_prob(y_true)\r\n\r\nmodel.compile(optimizer, loss=nll)\r\nmodel.fit(x=X.astype(float), y=y.astype(float), epochs=5)\r\n\r\n\r\nactive_experiment = \"active-custom-experiment\"\r\nmlflow.set_experiment(active_experiment)\r\nwith mlflow.start_run():\r\n    mlflow.keras.log_model(model, \"model\")\r\n```\r\n### Stack trace\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nOperatorNotAllowedInGraphError            Traceback (most recent call last)\r\nInput In [25], in <cell line: 2>()\r\n      1 mlflow.set_experiment(active_experiment)\r\n      2 with mlflow.start_run():\r\n----> 3     mlflow.keras.log_model(model, 'model')\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/keras.py:416, in log_model(keras_model, artifact_path, conda_env, code_paths, custom_objects, keras_module, registered_model_name, signature, input_example, await_registration_for, pip_requirements, extra_pip_requirements, **kwargs)\r\n    404 if signature is not None:\r\n    405     warnings.warn(\r\n    406         \"The pyfunc inference behavior of Keras models logged \"\r\n    407         \"with signatures differs from the behavior of Keras \"\r\n   (...)\r\n    414         \"a Pandas DataFrame output in response to a Pandas DataFrame input.\"\r\n    415     )\r\n--> 416 return Model.log(\r\n    417     artifact_path=artifact_path,\r\n    418     flavor=mlflow.keras,\r\n    419     keras_model=keras_model,\r\n    420     conda_env=conda_env,\r\n    421     code_paths=code_paths,\r\n    422     custom_objects=custom_objects,\r\n    423     keras_module=keras_module,\r\n    424     registered_model_name=registered_model_name,\r\n    425     signature=signature,\r\n    426     input_example=input_example,\r\n    427     await_registration_for=await_registration_for,\r\n    428     pip_requirements=pip_requirements,\r\n    429     extra_pip_requirements=extra_pip_requirements,\r\n    430     **kwargs,\r\n    431 )\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/models/model.py:294, in Model.log(cls, artifact_path, flavor, registered_model_name, await_registration_for, **kwargs)\r\n    292 run_id = mlflow.tracking.fluent._get_or_start_run().info.run_id\r\n    293 mlflow_model = cls(artifact_path=artifact_path, run_id=run_id)\r\n--> 294 flavor.save_model(path=local_path, mlflow_model=mlflow_model, **kwargs)\r\n    295 mlflow.tracking.fluent.log_artifacts(local_path, artifact_path)\r\n    296 try:\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/site-packages/mlflow/keras.py:268, in save_model(keras_model, path, conda_env, code_paths, mlflow_model, custom_objects, keras_module, signature, input_example, pip_requirements, extra_pip_requirements, **kwargs)\r\n    266         shutil.copyfile(src=f.name, dst=model_path)\r\n    267 else:\r\n--> 268     keras_model.save(model_path, **kwargs)\r\n    270 # update flavor info to mlflow_model\r\n    271 mlflow_model.add_flavor(\r\n    272     FLAVOR_NAME,\r\n    273     keras_module=keras_module.__name__,\r\n   (...)\r\n    277     code=code_dir_subpath,\r\n    278 )\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/site-packages/keras/utils/traceback_utils.py:67, in filter_traceback.<locals>.error_handler(*args, **kwargs)\r\n     65 except Exception as e:  # pylint: disable=broad-except\r\n     66   filtered_tb = _process_traceback_frames(e.__traceback__)\r\n---> 67   raise e.with_traceback(filtered_tb) from None\r\n     68 finally:\r\n     69   del filtered_tb\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/contextlib.py:120, in _GeneratorContextManager.__exit__(self, type, value, traceback)\r\n    118 if type is None:\r\n    119     try:\r\n--> 120         next(self.gen)\r\n    121     except StopIteration:\r\n    122         return False\r\n\r\nFile ~/miniforge3/envs/py38/lib/python3.8/site-packages/tensorflow_probability/python/layers/distribution_layer.py:224, in DistributionLambda.__call__(self, inputs, *args, **kwargs)\r\n    222 def __call__(self, inputs, *args, **kwargs):\r\n    223   self._enter_dunder_call = True\r\n--> 224   distribution, _ = super(DistributionLambda, self).__call__(\r\n    225       inputs, *args, **kwargs)\r\n    226   self._enter_dunder_call = False\r\n    227   return distribution\r\n\r\nOperatorNotAllowedInGraphError: Iterating over a symbolic `tf.Tensor` is not allowed: AutoGraph did convert this function. This might indicate you are trying to use an unsupported feature.\r\n```\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6873/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6873/timeline","performed_via_github_app":null,"state_reason":null}