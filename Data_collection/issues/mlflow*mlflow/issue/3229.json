{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3229","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3229/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3229/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3229/events","html_url":"https://github.com/mlflow/mlflow/issues/3229","id":673113574,"node_id":"MDU6SXNzdWU2NzMxMTM1NzQ=","number":3229,"title":"[BUG] ONNX predict fails for high-dimensional models","user":{"login":"avflor","id":18666312,"node_id":"MDQ6VXNlcjE4NjY2MzEy","avatar_url":"https://avatars.githubusercontent.com/u/18666312?v=4","gravatar_id":"","url":"https://api.github.com/users/avflor","html_url":"https://github.com/avflor","followers_url":"https://api.github.com/users/avflor/followers","following_url":"https://api.github.com/users/avflor/following{/other_user}","gists_url":"https://api.github.com/users/avflor/gists{/gist_id}","starred_url":"https://api.github.com/users/avflor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avflor/subscriptions","organizations_url":"https://api.github.com/users/avflor/orgs","repos_url":"https://api.github.com/users/avflor/repos","events_url":"https://api.github.com/users/avflor/events{/privacy}","received_events_url":"https://api.github.com/users/avflor/received_events","type":"User","site_admin":true},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"open","locked":false,"assignee":{"login":"avflor","id":18666312,"node_id":"MDQ6VXNlcjE4NjY2MzEy","avatar_url":"https://avatars.githubusercontent.com/u/18666312?v=4","gravatar_id":"","url":"https://api.github.com/users/avflor","html_url":"https://github.com/avflor","followers_url":"https://api.github.com/users/avflor/followers","following_url":"https://api.github.com/users/avflor/following{/other_user}","gists_url":"https://api.github.com/users/avflor/gists{/gist_id}","starred_url":"https://api.github.com/users/avflor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avflor/subscriptions","organizations_url":"https://api.github.com/users/avflor/orgs","repos_url":"https://api.github.com/users/avflor/repos","events_url":"https://api.github.com/users/avflor/events{/privacy}","received_events_url":"https://api.github.com/users/avflor/received_events","type":"User","site_admin":true},"assignees":[{"login":"avflor","id":18666312,"node_id":"MDQ6VXNlcjE4NjY2MzEy","avatar_url":"https://avatars.githubusercontent.com/u/18666312?v=4","gravatar_id":"","url":"https://api.github.com/users/avflor","html_url":"https://github.com/avflor","followers_url":"https://api.github.com/users/avflor/followers","following_url":"https://api.github.com/users/avflor/following{/other_user}","gists_url":"https://api.github.com/users/avflor/gists{/gist_id}","starred_url":"https://api.github.com/users/avflor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avflor/subscriptions","organizations_url":"https://api.github.com/users/avflor/orgs","repos_url":"https://api.github.com/users/avflor/repos","events_url":"https://api.github.com/users/avflor/events{/privacy}","received_events_url":"https://api.github.com/users/avflor/received_events","type":"User","site_admin":true}],"milestone":null,"comments":2,"created_at":"2020-08-04T22:08:25Z","updated_at":"2020-10-21T11:05:13Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: \r\n- **MLflow installed from (source or binary)**: Source \r\n- **MLflow version (run ``mlflow --version``)**: 1.10\r\n- **Python version**: 3.6\r\n- **npm version, if running the dev UI**:NA\r\n- **Exact command to reproduce**: \r\n\r\n### Describe the problem\r\nThe predict function in the onnx model fails for high-dimensional model inputs (e.g, image models). \r\nThe reason is that the data corresponding to each model input is represented as a pandas dataframe column\r\nand accessed though  `dataFrame[colName].values ` whose rank is always 1. This is because the column is of dtype(object)\r\nand does not recognize the high-dimensions of the object. Here is an example:\r\n\r\n>`df = pd.DataFrame([[1,2, [[3,4,5]]],[6,7,[[8,9,10]]]], columns=['a','b','c'])`\r\n\r\n>`df['c'].values`\r\narray([list([[3, 4, 5]]), list([[8, 9, 10]])], dtype=object)\r\n\r\n>`df['c'].values.shape`\r\n(2,)\r\n\r\nAs shown the 'c' column has rank 1 (shape = (2,)) whereas the data in the column is of rank 3 (shape=(1,2,3)).\r\n\r\nThe ONNXRuntime though expects a higher-rank object and as a result the prediction fails. The predict function should check the input model shape and bring the dataframe columns in the correct form before feeding them in the ONNXRuntime. Similarly, the output of predict (which is again a dataframe) should conform to the expected shape of the model output.\r\n\r\n### Code to reproduce issue\r\n \r\n   ```\r\n    import onnx\r\n    import mlflow.onnx\r\n    import tf2onnx\r\n    import tensorflow as tf\r\n```\r\n\r\n ```\r\n   graph = tf.Graph()\r\n    with graph.as_default():\r\n        t_in1 = tf.placeholder(tf.int32, (1, 2, 2), name=\"first_input\")\r\n        t_in2 = tf.placeholder(tf.int32, (1, 2, 2), name=\"second_input\")\r\n        t_out = tf.add(t_in1, t_in2)\r\n        t_out_named = tf.identity(t_out, name=\"output\")\r\n\r\n    sess = tf.Session(graph=graph)\r\n\r\n    onnx_graph = tf2onnx.tfonnx.process_tf_graph(\r\n        sess.graph,\r\n        input_names=[\"first_input:0\", \"second_input:0\",],\r\n        output_names=[\"output:0\"],\r\n    )\r\n    high_dim_model = onnx_graph.make_model(\"test\")\r\n```\r\n```\r\n    mlflow.onnx.save_model(high_dim_model, \"model\")\r\n    # Loading pyfunc model\r\n    pyfunc_loaded = mlflow.pyfunc.load_pyfunc(\"model\")\r\n\r\n     data_high_dim_inputs = pd.DataFrame(\r\n        {\r\n            \"first_input:0\": [np.arange(2 * 2, dtype=np.int32).reshape(2, 2)],\r\n            \"second_input:0\": [np.arange(2 * 2, dtype=np.int32).reshape(2, 2)],\r\n        },\r\n    )  \r\n    pyfunc_loaded.predict(data_high_dim_inputs)\r\n```\r\n\r\n\r\nThis test fails with error:\r\n\r\n`E       RuntimeError: Method run failed due to: [ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Unexpected input data type. Actual: (N11onnxruntime11NonOnnxTypeINSt3__112basic_stringIcNS1_11char_traitsIcEENS1_9allocatorIcEEEEEE) , expected: (N11onnxruntime11NonOnnxTypeIiEE)`\r\n\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3229/timeline","performed_via_github_app":null,"state_reason":null}