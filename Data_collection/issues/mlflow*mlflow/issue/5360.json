{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5360","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5360/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5360/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5360/events","html_url":"https://github.com/mlflow/mlflow/issues/5360","id":1127677094,"node_id":"I_kwDOCB5Jx85DNvym","number":5360,"title":"[BUG] INTERNAL_SERVER_ERROR when using MSSQL as backend store","user":{"login":"dianacarvalho1","id":63718157,"node_id":"MDQ6VXNlcjYzNzE4MTU3","avatar_url":"https://avatars.githubusercontent.com/u/63718157?v=4","gravatar_id":"","url":"https://api.github.com/users/dianacarvalho1","html_url":"https://github.com/dianacarvalho1","followers_url":"https://api.github.com/users/dianacarvalho1/followers","following_url":"https://api.github.com/users/dianacarvalho1/following{/other_user}","gists_url":"https://api.github.com/users/dianacarvalho1/gists{/gist_id}","starred_url":"https://api.github.com/users/dianacarvalho1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dianacarvalho1/subscriptions","organizations_url":"https://api.github.com/users/dianacarvalho1/orgs","repos_url":"https://api.github.com/users/dianacarvalho1/repos","events_url":"https://api.github.com/users/dianacarvalho1/events{/privacy}","received_events_url":"https://api.github.com/users/dianacarvalho1/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-08T19:36:12Z","updated_at":"2022-02-22T07:45:44Z","closed_at":"2022-02-22T07:45:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac OS Big Sur\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: version 1.23.1\r\n- **Python version**: Python 3.9.9\r\n- **npm version, if running the dev UI**: -\r\n\r\n### Describe the problem\r\nWhen running a tracking ui with `mlflow ui --backend-store-uri  <connection_str>` and specifying the backend store a MSSQL database, there is a problem when trying to access the UI. \r\n<img width=\"1274\" alt=\"image\" src=\"https://user-images.githubusercontent.com/63718157/153061210-2ca9fdc5-1090-4468-a99d-02dfa7f6f227.png\">\r\n\r\n### Code to reproduce issue\r\nStart the tracking UI with a backend store a MSSQL database.\r\nOr do:\r\n````\r\nmlflow.set_tracking_uri(connection_str_to_mssql_db)\r\nmlflow.search_runs(experiment_ids=[0], order_by= ['attributes.start_time DESC'])\r\n````\r\n\r\n\r\n### Other info / logs\r\nIn the logs, there is the following error:\r\n````\r\n2022/02/08 14:30:14 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/runs/search [POST]\r\nTraceback (most recent call last):\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 1802, in _execute_context\r\n    self.dialect.do_execute(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/default.py\", line 732, in do_execute\r\n    cursor.execute(statement, parameters)\r\npyodbc.ProgrammingError: ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW)')\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/store/db/utils.py\", line 79, in make_managed_session\r\n    yield session\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 788, in _search_runs\r\n    query.distinct()\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/orm/query.py\", line 2759, in all\r\n    return self._iter().all()\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/orm/query.py\", line 2894, in _iter\r\n    result = self.session.execute(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/orm/session.py\", line 1692, in execute\r\n    result = conn._execute_20(statement, params or {}, execution_options)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 1614, in _execute_20\r\n    return meth(self, args_10style, kwargs_10style, execution_options)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/sql/elements.py\", line 325, in _execute_on_connection\r\n    return connection._execute_clauseelement(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 1481, in _execute_clauseelement\r\n    ret = self._execute_context(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 1845, in _execute_context\r\n    self._handle_dbapi_exception(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 2026, in _handle_dbapi_exception\r\n    util.raise_(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/util/compat.py\", line 207, in raise_\r\n    raise exception\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/base.py\", line 1802, in _execute_context\r\n    self.dialect.do_execute(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/sqlalchemy/engine/default.py\", line 732, in do_execute\r\n    cursor.execute(statement, parameters)\r\nsqlalchemy.exc.ProgrammingError: (pyodbc.ProgrammingError) ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW)')\r\n[SQL: SELECT DISTINCT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END AS anon_1 \r\nFROM runs \r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END, runs.start_time DESC, runs.run_uuid\r\n OFFSET ? ROWS\r\n FETCH FIRST ? ROWS ONLY]\r\n[parameters: (1, 0, '0', 'active', 1, 0, 0, 100)]\r\n(Background on this error at: https://sqlalche.me/e/14/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/server/handlers.py\", line 238, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/server/handlers.py\", line 298, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/server/handlers.py\", line 549, in _search_runs\r\n    run_entities = _get_tracking_store().search_runs(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/store/tracking/abstract_store.py\", line 242, in search_runs\r\n    runs, token = self._search_runs(\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/store/tracking/sqlalchemy_store.py\", line 802, in _search_runs\r\n    next_page_token = compute_next_token(len(runs))\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/contextlib.py\", line 137, in __exit__\r\n    self.gen.throw(typ, value, traceback)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/store/db/utils.py\", line 86, in make_managed_session\r\n    raise MlflowException(message=e, error_code=INTERNAL_ERROR)\r\nmlflow.exceptions.MlflowException: (pyodbc.ProgrammingError) ('42000', '[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]ORDER BY items must appear in the select list if SELECT DISTINCT is specified. (145) (SQLExecDirectW)')\r\n[SQL: SELECT DISTINCT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END AS anon_1 \r\nFROM runs \r\nWHERE runs.experiment_id IN (?) AND runs.lifecycle_stage IN (?) ORDER BY CASE WHEN (runs.start_time IS NULL) THEN ? ELSE ? END, runs.start_time DESC, runs.run_uuid\r\n OFFSET ? ROWS\r\n FETCH FIRST ? ROWS ONLY]\r\n[parameters: (1, 0, '0', 'active', 1, 0, 0, 100)]\r\n(Background on this error at: https://sqlalche.me/e/14/f405)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/flask/app.py\", line 2073, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/flask/app.py\", line 1518, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/flask/app.py\", line 1516, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/flask/app.py\", line 1502, in dispatch_request\r\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/server/handlers.py\", line 241, in wrapper\r\n    response.set_data(e.serialize_as_json())\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/site-packages/mlflow/exceptions.py\", line 60, in serialize_as_json\r\n    return json.dumps(exception_dict)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/json/__init__.py\", line 231, in dumps\r\n    return _default_encoder.encode(obj)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/json/encoder.py\", line 199, in encode\r\n    chunks = self.iterencode(o, _one_shot=True)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/json/encoder.py\", line 257, in iterencode\r\n    return _iterencode(o, 0)\r\n  File \"/Users/dianacarvalho/opt/anaconda3/envs/vpdc-complete/lib/python3.9/json/encoder.py\", line 179, in default\r\n    raise TypeError(f'Object of type {o.__class__.__name__} '\r\nTypeError: Object of type ProgrammingError is not JSON serializable\r\n````\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [x] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [x] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5360/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5360/timeline","performed_via_github_app":null,"state_reason":"completed"}