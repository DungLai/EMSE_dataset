{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4061","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4061/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4061/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4061/events","html_url":"https://github.com/mlflow/mlflow/issues/4061","id":801099950,"node_id":"MDU6SXNzdWU4MDEwOTk5NTA=","number":4061,"title":"[BUG] Cannot load multiple python_function models with the same script file name","user":{"login":"potoo0","id":34411681,"node_id":"MDQ6VXNlcjM0NDExNjgx","avatar_url":"https://avatars.githubusercontent.com/u/34411681?v=4","gravatar_id":"","url":"https://api.github.com/users/potoo0","html_url":"https://github.com/potoo0","followers_url":"https://api.github.com/users/potoo0/followers","following_url":"https://api.github.com/users/potoo0/following{/other_user}","gists_url":"https://api.github.com/users/potoo0/gists{/gist_id}","starred_url":"https://api.github.com/users/potoo0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/potoo0/subscriptions","organizations_url":"https://api.github.com/users/potoo0/orgs","repos_url":"https://api.github.com/users/potoo0/repos","events_url":"https://api.github.com/users/potoo0/events{/privacy}","received_events_url":"https://api.github.com/users/potoo0/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-02-04T09:31:41Z","updated_at":"2021-08-18T13:05:23Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code**: Yes, as shown below.\r\n- **OS Platform and Distribution**: win10 20H2\r\n- **MLflow installed from**: binary\r\n- **MLflow version**: mlflow, version 1.13.1\r\n- **Python version**: 3.8.5\r\n\r\n### Describe the problem\r\nCannot load multiple python_function models with the same script file name in one file, it seems that the second loaded model did not download artifact.\r\n\r\n### Code to reproduce issue\r\nproject tree:\r\n```\r\n$ tree\r\n.\r\n├── model1\r\n│   ├── model_builder.py\r\n│   └── regist_model1.py\r\n├── model2\r\n│   ├── model_builder.py\r\n│   └── regist_model2.py\r\n└── model_load.py\r\n\r\n2 directories, 5 files\r\n```\r\nproject files: mlflow_bug.zip\r\n[mlflow_bug.zip](https://github.com/mlflow/mlflow/files/5924532/mlflow_bug.zip)\r\n\r\ncore script:\r\n```python\r\n# model1.model_builder.py:\r\nclass Test1(mlflow.pyfunc.PythonModel):\r\n    def __init__(self):\r\n        super().__init__()\r\n\r\n    def load_context(self, context):\r\n        import numpy as np\r\n\r\n        return\r\n\r\n    def predict(self, context, model_input):\r\n        '''\r\n        Args:\r\n            model_input: ndarray, shape: (-1)\r\n        '''\r\n        res = np.sum(model_input)\r\n\r\n        return res\r\n\r\n\r\n# model2.model_builder.py:\r\nclass Test2(mlflow.pyfunc.PythonModel):\r\n    def __init__(self):\r\n        super().__init__()\r\n\r\n    def load_context(self, context):\r\n        import numpy as np\r\n\r\n        return\r\n\r\n    def predict(self, context, model_input):\r\n        '''\r\n        Args:\r\n            model_input: ndarray, shape: (-1)\r\n        '''\r\n        res = np.mean(model_input)\r\n\r\n        return res\r\n\r\n\r\n# model_load.py\r\nimport mlflow\r\nimport numpy as np\r\nfrom mlflow.pyfunc import load_model\r\n\r\n# config\r\ntracking_server = 'http://localhost:8088'\r\nmlflow.tracking.set_tracking_uri(tracking_server)\r\n\r\nmodel_1_reg_name = 'pyfunc_model_t1'\r\nmodel_2_reg_name = 'pyfunc_model_t2'\r\nstage = None\r\n\r\n# input\r\nx = np.arange(1, 10)\r\n\r\n# model inference\r\nloadedml_1 = load_model(f\"models:/{model_1_reg_name}/{stage}\")\r\nprint(f'loadedml_1.pred: {loadedml_1.predict(x)}')\r\n\r\nloadedml_2 = load_model(f\"models:/{model_2_reg_name}/{stage}\")\r\nprint(f'loadedml_2.pred: {loadedml_2.predict(x)}')\r\n```\r\n\r\nissue reproduce:\r\n```powershell\r\ncd xxx\\mlflow_bug\r\n# register model1\r\ncd .\\model1\\\r\npython .\\regist_model1.py\r\n# register model2\r\ncd ..\\model2\\\r\npython .\\regist_model2.py\r\ncd ..\r\n\r\n# load two python_function\r\npython .\\model_load.py\r\n```\r\n\r\n### Other info / logs\r\n```\r\nloadedml_1.pred: 45\r\nTraceback (most recent call last):\r\n  File \"E:\\mlflow_bug\\model_load.py\", line 20, in <module>\r\n    loadedml_2 = load_model(f\"models:/{model_2_reg_name}/{stage}\")\r\n  File \"D:\\Miniconda3\\lib\\site-packages\\mlflow\\pyfunc\\__init__.py\", line 522, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"D:\\Miniconda3\\lib\\site-packages\\mlflow\\pyfunc\\model.py\", line 223, in _load_pyfunc\r\n    python_model = cloudpickle.load(f)\r\nAttributeError: Can't get attribute 'Test2' on <module 'model_builder' from 'C:\\\\Users\\\\potoo\\\\AppData\\\\Local\\\\Temp\\\\tmps9pobp26\\\\code\\\\model_builder.py'>\r\n```\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4061/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4061/timeline","performed_via_github_app":null,"state_reason":null}