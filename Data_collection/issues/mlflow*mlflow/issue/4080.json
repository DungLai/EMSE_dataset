{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4080","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4080/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4080/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4080/events","html_url":"https://github.com/mlflow/mlflow/issues/4080","id":804062954,"node_id":"MDU6SXNzdWU4MDQwNjI5NTQ=","number":4080,"title":"[BUG] Concurrent deployment calls cause [Errno 2] No such file or directory","user":{"login":"kkolli","id":6346601,"node_id":"MDQ6VXNlcjYzNDY2MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6346601?v=4","gravatar_id":"","url":"https://api.github.com/users/kkolli","html_url":"https://github.com/kkolli","followers_url":"https://api.github.com/users/kkolli/followers","following_url":"https://api.github.com/users/kkolli/following{/other_user}","gists_url":"https://api.github.com/users/kkolli/gists{/gist_id}","starred_url":"https://api.github.com/users/kkolli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkolli/subscriptions","organizations_url":"https://api.github.com/users/kkolli/orgs","repos_url":"https://api.github.com/users/kkolli/repos","events_url":"https://api.github.com/users/kkolli/events{/privacy}","received_events_url":"https://api.github.com/users/kkolli/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-02-08T23:48:23Z","updated_at":"2021-02-08T23:50:53Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Alpine\r\n- **MLflow installed from (source or binary)**: Binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.13.0\r\n- **Python version**: 3.7\r\n\r\n\r\n### Describe the problem\r\nConcurrent deployment calls cause `[Errno 2] No such file or directory: '/tmp/tmpuwt29r5d'` errors. It almost seems to lock the directory while deploying so other threads cannot create files or access the directory for reads. This doesn't happen if a deployment happens synchronously, where at any given time, only one deployment is happening to Azure across the server. However, if i'm deploying 5 Mlflow projects at the same time, where no project has finished deployment, atleast one of the deployments will fail with this error.\r\n\r\n\r\n### Code to reproduce issue\r\n\r\n1. Create a simple model and save\r\n```\r\nclass AddN(mlflow.pyfunc.PythonModel):\r\n    def __init__(self, n):\r\n        self.n = n\r\n\r\n    def predict(self, context, model_input):\r\n        return model_input.apply(lambda column: column + self.n)\r\n\r\nadd5_model = AddN(n=5)\r\nmlflow.pyfunc.save_model(path=path, python_model=add5_model)\r\n\r\n```\r\n2. Three files generated: Mlmodel, Conda.yaml, python_model.pkl\r\nMLmodel\r\n```\r\nflavors:\r\n  python_function:\r\n    cloudpickle_version: 1.6.0\r\n    env: conda.yaml\r\n    loader_module: mlflow.pyfunc.model\r\n    python_model: python_model.pkl\r\n    python_version: 3.7.5\r\nutc_time_created: '2021-01-28 21:04:48.582692'\r\n```\r\n\r\nconda.yaml\r\n```\r\nchannels:\r\n- defaults\r\n- conda-forge\r\ndependencies:\r\n- python=3.7.5\r\n- pip\r\n- pip:\r\n  - mlflow\r\n  - cloudpickle==1.6.0\r\nname: mlflow-env\r\n```\r\n3. 5 Threads concurrently deploying model\r\n```\r\nazure_image, azure_model = mlflow.azureml.build_image(\r\n        model_uri=model_temp_uri,\r\n        workspace=azure_workspace,\r\n        synchronous=True)\r\n\r\nwebservice = Webservice.deploy_from_image(\r\n                    image=azure_image,\r\n                    workspace=azure_workspace,\r\n                    name=service_name,\r\n                    deployment_config=aks_webservice_config,\r\n                    deployment_target=ComputeTarget(\r\n                        azure_workspace,\r\n                        os.environ.get('COMPUTE_TARGET_NAME')\r\n                        )\r\n                    )\r\nwebservice.wait_for_deployment(show_output=True)\r\n```\r\n\r\n4. ~3 Threads will successfully deploy. ~2 might fail with `No such file or directory: '/tmp/tmp13cmus54'` error\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [x] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nIntegrations\r\n- [x] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4080/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4080/timeline","performed_via_github_app":null,"state_reason":null}