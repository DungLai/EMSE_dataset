{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3679","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3679/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3679/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3679/events","html_url":"https://github.com/mlflow/mlflow/issues/3679","id":741918308,"node_id":"MDU6SXNzdWU3NDE5MTgzMDg=","number":3679,"title":"[BUG]","user":{"login":"ntorba","id":32570754,"node_id":"MDQ6VXNlcjMyNTcwNzU0","avatar_url":"https://avatars.githubusercontent.com/u/32570754?v=4","gravatar_id":"","url":"https://api.github.com/users/ntorba","html_url":"https://github.com/ntorba","followers_url":"https://api.github.com/users/ntorba/followers","following_url":"https://api.github.com/users/ntorba/following{/other_user}","gists_url":"https://api.github.com/users/ntorba/gists{/gist_id}","starred_url":"https://api.github.com/users/ntorba/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ntorba/subscriptions","organizations_url":"https://api.github.com/users/ntorba/orgs","repos_url":"https://api.github.com/users/ntorba/repos","events_url":"https://api.github.com/users/ntorba/events{/privacy}","received_events_url":"https://api.github.com/users/ntorba/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-11-12T20:48:26Z","updated_at":"2022-06-02T06:43:17Z","closed_at":"2020-11-13T16:15:47Z","author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\nNo\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nT2.medium nodes running as part of \r\n- **MLflow installed from (source or binary)**:\r\n\r\n- **MLflow version (run ``mlflow --version``)**:\r\nmlflow[extras]==1.9.1\r\n- **Python version**:\r\n3.8.2\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Include descriptions of the expected behavior and the actual behavior.\r\n\r\nI am running an mlflow tracking server as a kubernetes deployment, and attempting to use an s3 bucket as an artifact repository. When I run this example code: \r\n```python\r\nfrom random import random, randint\r\nfrom sklearn.ensemble import RandomForestRegressor\r\n\r\nimport mlflow\r\nimport mlflow.sklearn\r\nimport os\r\n\r\nos.environ[\"MLFLOW_TRACKING_INSECURE_TLS\"] = \"true\"\r\n\r\nmlflow.set_tracking_uri(\"https://url-to-tracking-server/\")\r\nwith mlflow.start_run(run_name=\"YOUR_RUN_NAME\") as run:\r\n    print(run)\r\n    print(type(run))\r\n    print(dir(run))\r\n    params = {\"n_estimators\": 5, \"random_state\": 42}\r\n    sk_learn_rfr = RandomForestRegressor(**params)\r\n    \r\n    # Log parameters and metrics using the MLflow APIs\r\n    mlflow.log_params(params)\r\n    mlflow.log_param(\"param_1\", randint(0, 100))\r\n    mlflow.log_metrics({\"metric_1\": random(), \"metric_2\": random() + 1})\r\n\r\n    # Log the sklearn model and register as version 1\r\n    mlflow.sklearn.log_model(\r\n        sk_model=sk_learn_rfr,\r\n        artifact_path=\"vsg/sklearn-models\",\r\n        registered_model_name=\"sk-learn-random-forest-reg-model\"\r\n    )\r\n```\r\n\r\nI see that the experiment is succesfully logged in the UI, and the artifacts are created in s3. However, when I click on an experiment run, I get a blank screen and this message: \r\n\r\n```bash\r\nUnable to list artifacts stored unders3://amp-mlflow-artifacts/0/7d5e7e633f9e4202910496bbfd63aa89/artifacts for the current run. Please contact your tracking server administrator to notify them of this error, which can happen when the tracking server lacks permission to list artifacts under the current run's root artifact directory.\r\n```\r\n\r\nMy nodegroup IAM has full s3 access, and if I can write the objects to s3, I would think that I should be able to read them. \r\n\r\nI can grab the stored model with the line `clf = mlflow.sklearn.load_model(model_uri=\"models:/sk-learn-random-forest-reg-model/1\")` as well. \r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\nLogs from kubernetes pod: \r\n```bash\r\nbotocore.exceptions.HTTPClientError: An HTTP Client raised an unhandled exception: 's3'\r\n[2020-11-12 20:47:08 +0000] [14] [INFO] Booting worker with pid: 14\r\n2020/11/12 20:47:08 ERROR mlflow.server: Exception on /ajax-api/2.0/preview/mlflow/artifacts/list [GET]\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/httpsession.py\", line 250, in send\r\n    conn = manager.connection_from_url(request.url)\r\n  File \"/usr/local/lib/python3.8/site-packages/urllib3/poolmanager.py\", line 291, in connection_from_url\r\n    return self.connection_from_host(\r\n  File \"/usr/local/lib/python3.8/site-packages/urllib3/poolmanager.py\", line 240, in connection_from_host\r\n    return self.connection_from_context(request_context)\r\n  File \"/usr/local/lib/python3.8/site-packages/urllib3/poolmanager.py\", line 250, in connection_from_context\r\n    pool_key_constructor = self.key_fn_by_scheme[scheme]\r\nKeyError: 's3'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 2447, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1952, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1821, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/_compat.py\", line 39, in reraise\r\n    raise value\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1950, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/usr/local/lib/python3.8/site-packages/flask/app.py\", line 1936, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/server/handlers.py\", line 155, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/server/handlers.py\", line 413, in _list_artifacts\r\n    artifact_entities = _get_artifact_repo(run).list_artifacts(path)\r\n  File \"/usr/local/lib/python3.8/site-packages/mlflow/store/artifact/s3_artifact_repo.py\", line 104, in list_artifacts\r\n    for result in results:\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/paginate.py\", line 255, in __iter__\r\n    response = self._make_request(current_kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/paginate.py\", line 332, in _make_request\r\n    return self._method(**current_kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 357, in _api_call\r\n    return self._make_api_call(operation_name, kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 662, in _make_api_call\r\n    http, parsed_response = self._make_request(\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 682, in _make_request\r\n    return self._endpoint.make_request(operation_model, request_dict)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 102, in make_request\r\n    return self._send_request(request_dict, operation_model)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 136, in _send_request\r\n    while self._needs_retry(attempts, operation_model, request_dict,\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 253, in _needs_retry\r\n    responses = self._event_emitter.emit(\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 356, in emit\r\n    return self._emitter.emit(aliased_event_name, **kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 228, in emit\r\n    return self._emit(event_name, kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 211, in _emit\r\n    response = handler(**kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 183, in __call__\r\n    if self._checker(attempts, response, caught_exception):\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 250, in __call__\r\n    should_retry = self._should_retry(attempt_number, response,\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 269, in _should_retry\r\n    return self._checker(attempt_number, response, caught_exception)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 316, in __call__\r\n    checker_response = checker(attempt_number, response,\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 222, in __call__\r\n    return self._check_caught_exception(\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/retryhandler.py\", line 359, in _check_caught_exception\r\n    raise caught_exception\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 200, in _do_get_response\r\n    http_response = self._send(request)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 269, in _send\r\n    return self.http_session.send(request)\r\n  File \"/usr/local/lib/python3.8/site-packages/botocore/httpsession.py\", line 299, in send\r\n    raise HTTPClientError(error=e)\r\nbotocore.exceptions.HTTPClientError: An HTTP Client raised an unhandled exception: 's3'\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n","closed_by":{"login":"ntorba","id":32570754,"node_id":"MDQ6VXNlcjMyNTcwNzU0","avatar_url":"https://avatars.githubusercontent.com/u/32570754?v=4","gravatar_id":"","url":"https://api.github.com/users/ntorba","html_url":"https://github.com/ntorba","followers_url":"https://api.github.com/users/ntorba/followers","following_url":"https://api.github.com/users/ntorba/following{/other_user}","gists_url":"https://api.github.com/users/ntorba/gists{/gist_id}","starred_url":"https://api.github.com/users/ntorba/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ntorba/subscriptions","organizations_url":"https://api.github.com/users/ntorba/orgs","repos_url":"https://api.github.com/users/ntorba/repos","events_url":"https://api.github.com/users/ntorba/events{/privacy}","received_events_url":"https://api.github.com/users/ntorba/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3679/timeline","performed_via_github_app":null,"state_reason":"completed"}