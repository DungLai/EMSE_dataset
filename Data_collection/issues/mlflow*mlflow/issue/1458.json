{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1458","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1458/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1458/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1458/events","html_url":"https://github.com/mlflow/mlflow/issues/1458","id":456574695,"node_id":"MDU6SXNzdWU0NTY1NzQ2OTU=","number":1458,"title":"Unable to load model after being saved to a dbfs s3 mount","user":{"login":"antwhite","id":899144,"node_id":"MDQ6VXNlcjg5OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/899144?v=4","gravatar_id":"","url":"https://api.github.com/users/antwhite","html_url":"https://github.com/antwhite","followers_url":"https://api.github.com/users/antwhite/followers","following_url":"https://api.github.com/users/antwhite/following{/other_user}","gists_url":"https://api.github.com/users/antwhite/gists{/gist_id}","starred_url":"https://api.github.com/users/antwhite/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antwhite/subscriptions","organizations_url":"https://api.github.com/users/antwhite/orgs","repos_url":"https://api.github.com/users/antwhite/repos","events_url":"https://api.github.com/users/antwhite/events{/privacy}","received_events_url":"https://api.github.com/users/antwhite/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-06-15T20:49:43Z","updated_at":"2019-07-19T00:03:09Z","closed_at":"2019-07-19T00:03:09Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:  Databricks 5.4 ML (includes Apache Spark 2.4.3, Scala 2.11)\r\n- **MLflow installed from (source or binary)**:  Databricks\r\n- **MLflow version (run ``mlflow --version``)**: 1.0.0\r\n- **Python version**:  3.6.5\r\n- **npm version (if running the dev UI): -\r\n- **Exact command to reproduce**:  See below for code example\r\n\r\n### Describe the problem\r\nWhen attempting to load a model from S3, the `ArtifactRepository.download_artifacts` method gets stuck in an infinite loop downloading an empty root directory over and over\r\n\r\nIt appears this is unique to models saved to s3 using DBFS FUSE s3 filesystem. \r\nI have tracked the issue  down to when the artifacts are listed  in the `S3ArtifactRepository.list_artifacts` method the root directory / key is listed under `Contents` and thus is always returned to be attempted to be downloaded again.\r\n\r\nI have been unable to replicate using moto.mock_s3, or using an s3 artefact repository directly.\r\n\r\n### Source code / logs\r\n## Save Model (on databricks)\r\n```python\r\n# mount s3 bucket\r\n\r\nACCESS_KEY = \"<aws-access-key>\"\r\nSECRET_KEY = \"<aws-secret-key>\"\r\nENCODED_SECRET_KEY = SECRET_KEY.replace(\"/\", \"%2F\")\r\nAWS_BUCKET_NAME = \"my-bucket\"\r\nMOUNT_NAME = \"my-bucket\"\r\n\r\ndbutils.fs.mount(\"s3a://{}:{}@{}\".format(ACCESS_KEY, ENCODED_SECRET_KEY, AWS_BUCKET_NAME), \"/mnt/{}\".format(MOUNT_NAME))\r\n\r\nfrom datetime import datetime\r\nfrom os import path\r\n\r\nfrom keras.layers import Embedding, LSTM, Dense\r\nfrom keras.models import Sequential\r\n\r\nmodel = Sequential()\r\nmodel.add(Embedding(2500, 128,input_length = 10, dropout = 0.2))\r\nmodel.add(LSTM(32, dropout_U = 0.2, dropout_W = 0.2))\r\nmodel.add(Dense(2,activation='softmax'))\r\nmodel.compile(loss = 'categorical_crossentropy', optimizer='adam',metrics = ['accuracy'])\r\n\r\n# training  omitted\r\n\r\nMODEL_VERSION = str.format(\"{:%Y%m%dT%H%M%S}\", datetime.utcnow())\r\nMODEL_NAME = 'model'\r\n\r\nmodel_save_path = path.join('/dbfs/mnt/', MOUNT_NAME, MODEL_VERSION, MODEL_NAME)\r\n\r\nmlflow.keras.save_model(model, model_save_path)\r\n```\r\n\r\n## Load Model:\r\n\r\n```python\r\nAWS_PATH = posixpath.join('s3://', AWS_BUCKET_NAME, MODEL_VERSION, MODEL_NAME)\r\nmlflow.keras.load_model(AWS_PATH)\r\n# Infinite loop\r\n```\r\n","closed_by":{"login":"sueann","id":4411489,"node_id":"MDQ6VXNlcjQ0MTE0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/4411489?v=4","gravatar_id":"","url":"https://api.github.com/users/sueann","html_url":"https://github.com/sueann","followers_url":"https://api.github.com/users/sueann/followers","following_url":"https://api.github.com/users/sueann/following{/other_user}","gists_url":"https://api.github.com/users/sueann/gists{/gist_id}","starred_url":"https://api.github.com/users/sueann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sueann/subscriptions","organizations_url":"https://api.github.com/users/sueann/orgs","repos_url":"https://api.github.com/users/sueann/repos","events_url":"https://api.github.com/users/sueann/events{/privacy}","received_events_url":"https://api.github.com/users/sueann/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1458/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1458/timeline","performed_via_github_app":null,"state_reason":"completed"}