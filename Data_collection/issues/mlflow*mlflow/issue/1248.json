{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1248","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1248/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1248/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1248/events","html_url":"https://github.com/mlflow/mlflow/issues/1248","id":443029194,"node_id":"MDU6SXNzdWU0NDMwMjkxOTQ=","number":1248,"title":"Postgres backend store crashes when an experiment run is logged","user":{"login":"joshpeng","id":22549127,"node_id":"MDQ6VXNlcjIyNTQ5MTI3","avatar_url":"https://avatars.githubusercontent.com/u/22549127?v=4","gravatar_id":"","url":"https://api.github.com/users/joshpeng","html_url":"https://github.com/joshpeng","followers_url":"https://api.github.com/users/joshpeng/followers","following_url":"https://api.github.com/users/joshpeng/following{/other_user}","gists_url":"https://api.github.com/users/joshpeng/gists{/gist_id}","starred_url":"https://api.github.com/users/joshpeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshpeng/subscriptions","organizations_url":"https://api.github.com/users/joshpeng/orgs","repos_url":"https://api.github.com/users/joshpeng/repos","events_url":"https://api.github.com/users/joshpeng/events{/privacy}","received_events_url":"https://api.github.com/users/joshpeng/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-05-11T19:36:41Z","updated_at":"2019-05-13T05:22:23Z","closed_at":"2019-05-13T05:22:23Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Amazon Linux\r\n- **MLflow installed from (source or binary)**: pip install mlflow\r\n- **MLflow version (run ``mlflow --version``)**: 0.9.1\r\n- **Python version**: 3.7.3\r\n- **Exact command to reproduce**: `mlflow server --backend-store-uri postgresql://user:password@localhost:5432/mlflow --default-artifact-root s3://somebucket/ --host 0.0.0.0`\r\n\r\n### Describe the problem\r\nRunning the mlflow server on an EC2 box with a Postgres server with the following command starts the server with no issues. However, when an example experiment run is triggered, the mlflow UI can't figure out how to store it properly and breaks the server with a `TypeError: 0 has type int, but expected one of: bytes, unicode` error.\r\n\r\n```\r\n[2019-05-11 19:37:38,603] ERROR in app: Exception on /ajax-api/2.0/preview/mlflow/runs/search [POST]\r\nTraceback (most recent call last):\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 2292, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1815, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1718, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/_compat.py\", line 35, in reraise\r\n    raise value\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1813, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1799, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 81, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 288, in _search_runs\r\n    response_message.runs.extend([r.to_proto() for r in run_entities])\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 288, in <listcomp>\r\n    response_message.runs.extend([r.to_proto() for r in run_entities])\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/entities/run.py\", line 38, in to_proto\r\n    run.info.MergeFrom(self.info.to_proto())\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/entities/run_info.py\", line 150, in to_proto\r\n    proto.experiment_id = self.experiment_id\r\nTypeError: 0 has type int, but expected one of: bytes, unicode\r\n[2019-05-11 19:37:38,617] ERROR in app: Exception on /ajax-api/2.0/preview/mlflow/experiments/get [GET]\r\nTraceback (most recent call last):\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 2292, in wsgi_app\r\n    response = self.full_dispatch_request()\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1815, in full_dispatch_request\r\n    rv = self.handle_user_exception(e)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1718, in handle_user_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/_compat.py\", line 35, in reraise\r\n    raise value\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1813, in full_dispatch_request\r\n    rv = self.dispatch_request()\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/flask/app.py\", line 1799, in dispatch_request\r\n    return self.view_functions[rule.endpoint](**req.view_args)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 81, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 143, in _get_experiment\r\n    response_message.runs.extend([r.to_proto() for r in run_info_entities])\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/server/handlers.py\", line 143, in <listcomp>\r\n    response_message.runs.extend([r.to_proto() for r in run_info_entities])\r\n  File \"/home/ec2-user/anaconda3/lib/python3.7/site-packages/mlflow/entities/run_info.py\", line 150, in to_proto\r\n    proto.experiment_id = self.experiment_id\r\nTypeError: 0 has type int, but expected one of: bytes, unicode\r\n```\r\n\r\n### Source code / logs\r\nHere is the actual experiment run. It is just a dummy run without any real logic:\r\n```python\r\nimport os\r\nimport mlflow\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\n\r\n\r\nMLFLOW_USER = os.environ['MLFLOW_USER']\r\nMLFLOW_PASSWORD = os.environ['MLFLOW_PASSWORD']\r\nMLFLOW_HOST = os.environ['MLFLOW_HOST']\r\n# Include user name and password to request\r\nTRACKING_URI = f'http://{MLFLOW_USER}:{MLFLOW_PASSWORD}@{MLFLOW_HOST}'\r\n\r\n\r\n# set up tracking uri\r\nmlflow.set_tracking_uri(TRACKING_URI)\r\nclient = mlflow.tracking.MlflowClient(TRACKING_URI)\r\n\r\n\r\n# create plot that we will track as an artifact\r\nx = np.linspace(0, 2*np.pi, num=100)\r\ny = np.cos(x)\r\nplt.plot(x,y)\r\nplt.savefig('./test_picture.png')\r\n\r\n\r\n# log parameters, metrics and artifacts on server\r\nwith mlflow.start_run(experiment_id=0):\r\n    mlflow.log_param('parameter', 1)\r\n    mlflow.log_metric('metric', 2)\r\n```\r\n","closed_by":{"login":"joshpeng","id":22549127,"node_id":"MDQ6VXNlcjIyNTQ5MTI3","avatar_url":"https://avatars.githubusercontent.com/u/22549127?v=4","gravatar_id":"","url":"https://api.github.com/users/joshpeng","html_url":"https://github.com/joshpeng","followers_url":"https://api.github.com/users/joshpeng/followers","following_url":"https://api.github.com/users/joshpeng/following{/other_user}","gists_url":"https://api.github.com/users/joshpeng/gists{/gist_id}","starred_url":"https://api.github.com/users/joshpeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshpeng/subscriptions","organizations_url":"https://api.github.com/users/joshpeng/orgs","repos_url":"https://api.github.com/users/joshpeng/repos","events_url":"https://api.github.com/users/joshpeng/events{/privacy}","received_events_url":"https://api.github.com/users/joshpeng/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1248/timeline","performed_via_github_app":null,"state_reason":"completed"}