{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3840","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3840/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3840/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3840/events","html_url":"https://github.com/mlflow/mlflow/issues/3840","id":766846438,"node_id":"MDU6SXNzdWU3NjY4NDY0Mzg=","number":3840,"title":"[BUG] Model signatures with space-separated fields crashes UI","user":{"login":"Trollgeir","id":7591857,"node_id":"MDQ6VXNlcjc1OTE4NTc=","avatar_url":"https://avatars.githubusercontent.com/u/7591857?v=4","gravatar_id":"","url":"https://api.github.com/users/Trollgeir","html_url":"https://github.com/Trollgeir","followers_url":"https://api.github.com/users/Trollgeir/followers","following_url":"https://api.github.com/users/Trollgeir/following{/other_user}","gists_url":"https://api.github.com/users/Trollgeir/gists{/gist_id}","starred_url":"https://api.github.com/users/Trollgeir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Trollgeir/subscriptions","organizations_url":"https://api.github.com/users/Trollgeir/orgs","repos_url":"https://api.github.com/users/Trollgeir/repos","events_url":"https://api.github.com/users/Trollgeir/events{/privacy}","received_events_url":"https://api.github.com/users/Trollgeir/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":1673521876,"node_id":"MDU6TGFiZWwxNjczNTIxODc2","url":"https://api.github.com/repos/mlflow/mlflow/labels/language/java","name":"language/java","color":"349cd8","default":false,"description":"Java APIs and clients"},{"id":2022847714,"node_id":"MDU6TGFiZWwyMDIyODQ3NzE0","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/model-registry","name":"area/model-registry","color":"48eabc","default":false,"description":"Model registry, model registry APIs, and the fluent client calls for model registry"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-12-14T19:23:38Z","updated_at":"2021-07-30T17:35:34Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md) for additional information about bug reports. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\n**Please fill in this bug report template to ensure a timely and thorough response.**\r\n\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.04\r\n- **MLflow installed from (source or binary)**: source\r\n- **MLflow version (run ``mlflow --version``)**: 1.12.1\r\n- **Python version**: 3.7.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: See below.\r\n\r\n### Describe the problem\r\nWhen creating a model with a model signature with space-separated fields, like:\r\n```\r\nsignature:\r\n  inputs: '[{\"name\": \"fixed acidity\", \"type\": \"double\"}, {\"name\": \"volatile acidity\",\r\n    \"type\": \"double\"}, {\"name\": \"citric acid\", \"type\": \"double\"}, {\"name\": \"residual\r\n    sugar\", \"type\": \"double\"}, {\"name\": \"chlorides\", \"type\": \"double\"}, {\"name\": \"free\r\n    sulfur dioxide\", \"type\": \"double\"}, {\"name\": \"total sulfur dioxide\", \"type\": \"double\"},\r\n    {\"name\": \"density\", \"type\": \"double\"}, {\"name\": \"pH\", \"type\": \"double\"}, {\"name\":\r\n    \"sulphates\", \"type\": \"double\"}, {\"name\": \"alcohol\", \"type\": \"double\"}]'\r\n```\r\n..the UI for registered models displaying the schema crashes when trying to parse this field:\r\n\r\n```\r\nSyntaxError: Unexpected token \r\n in JSON at position 155\r\n    at JSON.parse (<anonymous>)\r\n    at _t (reducers.js:140)\r\n    at Function.mapToProps (ModelVersionPage.js:228)\r\n    at r (wrapMapToProps.js:41)\r\n    at h (selectorFactory.js:41)\r\n    at selectorFactory.js:74\r\n    at Object.run (connectAdvanced.js:72)\r\n    at a.componentWillReceiveProps (connectAdvanced.js:192)\r\n    at l (react-dom.production.min.js:2237)\r\n    at updateClassInstance (react-dom.production.min.js:2369)\r\n```\r\nSpecifically at:\r\n```\r\nif (artifact.signature.inputs) {\r\n        schemaMap['inputs'] = JSON.parse(artifact.signature.inputs);\r\n      }\r\n```\r\nIt will probably crash for outputs too, have not tested.\r\n\r\nWhen filling in the spaces with underscores for every feature before inferring the model signature (`data.columns = [c.replace(\" \", \"_\") for c in data.columns]`) the bug disappears.\r\n\r\nError is related to JSON-parsing, or that it shouldn't be possible to log models where signatures contain spaces for feature-names.\r\n\r\n### Code to reproduce issue\r\n\r\nHave an MLFlow tracking server online, insert the url / token into your envs, run this script:\r\n\r\n```\r\nimport os\r\nimport warnings\r\nimport pandas as pd\r\nfrom mlflow.models.signature import infer_signature\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.linear_model import ElasticNet\r\nfrom urllib.parse import urlparse\r\nimport mlflow\r\nimport mlflow.sklearn\r\nimport os\r\nimport logging\r\n\r\nlogging.basicConfig(level=logging.WARN)\r\nlogger = logging.getLogger(__name__)\r\n\r\nos.environ['MLFLOW_TRACKING_URI'] = \"\"\r\nos.environ['MLFLOW_TRACKING_TOKEN'] = \"\"\r\n\r\nif __name__ == \"__main__\":\r\n    warnings.filterwarnings(\"ignore\")\r\n    # Read the wine-quality csv file from the URL\r\n    csv_url = (\r\n        \"http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv\"\r\n    )\r\n    try:\r\n        data = pd.read_csv(csv_url, sep=\";\")\r\n        # Uncomment line below to make bug related to signature parsing in MLFlow UI to disappear\r\n        #  data.columns = [c.replace(\" \", \"_\") for c in data.columns]\r\n    except Exception as e:\r\n        logger.exception(\r\n            \"Unable to download training & test CSV, check your internet connection. Error: %s\", e\r\n        )\r\n    # Split the data into training and test sets. (0.75, 0.25) split.\r\n    train, test = train_test_split(data)\r\n    # The predicted column is \"quality\" which is a scalar from [3, 9]\r\n    train_x = train.drop([\"quality\"], axis=1)\r\n    test_x = test.drop([\"quality\"], axis=1)\r\n    train_y = train[[\"quality\"]]\r\n    test_y = test[[\"quality\"]]\r\n\r\n    mlflow.set_experiment('default')\r\n    with mlflow.start_run():\r\n        lr = ElasticNet(alpha=0.5, l1_ratio=0.5, random_state=42)\r\n        lr.fit(train_x, train_y)\r\n        signature = infer_signature(train_x, lr.predict(train_x))\r\n        mlflow.sklearn.log_model(lr, \"default-model\", signature=signature)\r\n```\r\n* Browse your MLFlow UI into the model you created.\r\n* Register the model\r\n* Browse into the Model Registry\r\n* Click into the model you registered\r\n* Click at the newest version\r\n* UI Crash.  \r\n\r\n\r\n### Other info / logs\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [x] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [x] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [x] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3840/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3840/timeline","performed_via_github_app":null,"state_reason":null}