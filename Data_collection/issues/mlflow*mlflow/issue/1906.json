{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1906","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1906/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1906/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1906/events","html_url":"https://github.com/mlflow/mlflow/issues/1906","id":502916323,"node_id":"MDU6SXNzdWU1MDI5MTYzMjM=","number":1906,"title":"[BUG]Deployment failed - Spark ML model logged in Mleap format","user":{"login":"ShumzZ","id":20703213,"node_id":"MDQ6VXNlcjIwNzAzMjEz","avatar_url":"https://avatars.githubusercontent.com/u/20703213?v=4","gravatar_id":"","url":"https://api.github.com/users/ShumzZ","html_url":"https://github.com/ShumzZ","followers_url":"https://api.github.com/users/ShumzZ/followers","following_url":"https://api.github.com/users/ShumzZ/following{/other_user}","gists_url":"https://api.github.com/users/ShumzZ/gists{/gist_id}","starred_url":"https://api.github.com/users/ShumzZ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShumzZ/subscriptions","organizations_url":"https://api.github.com/users/ShumzZ/orgs","repos_url":"https://api.github.com/users/ShumzZ/repos","events_url":"https://api.github.com/users/ShumzZ/events{/privacy}","received_events_url":"https://api.github.com/users/ShumzZ/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-10-05T04:53:46Z","updated_at":"2019-10-11T16:48:33Z","closed_at":"2019-10-09T19:18:37Z","author_association":"NONE","active_lock_reason":null,"body":"**Update**: Bug fixed, see @smurching 's comment and PR below. \r\n\r\nThank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\nfor information on what types of issues we address. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\nPlease fill in this template and do not delete it unless you are sure your issue is outside its scope.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 16.04.6 LTS \r\n- **MLflow installed from (source or binary)**:  `pip install mlflow[extra]`\r\n- **MLflow version (run ``mlflow --version``)**: 1.3.0 same error message with 1.2.0\r\n- **Python version**:  3.7.3\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: see the following part, all the above info can be found in the Databricks notebook link\r\n\r\n### Describe the problem\r\nI trained a Spark ML Pipeline model on Databricks, logged the model in Mleap format using Mlflow and tried to deploy locally and remotely to AWS SageMaker. Both failed with the same error message:\r\n```\r\nError: A JNI error has occurred, please check your installation and try again\r\nException in thread \"main\" java.lang.NoClassDefFoundError: org/eclipse/jetty/util/thread/ThreadPool\r\n#011at java.lang.Class.getDeclaredMethods0(Native Method)\r\n#011at java.lang.Class.privateGetDeclaredMethods(Class.java:2701)\r\n#011at java.lang.Class.privateGetMethodRecursive(Class.java:3048)\r\n#011at java.lang.Class.getMethod0(Class.java:3018)\r\n#011at java.lang.Class.getMethod(Class.java:1784)\r\n#011at sun.launcher.LauncherHelper.validateMainClass(LauncherHelper.java:544)\r\n#011at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:526)\r\nCaused by: java.lang.ClassNotFoundException: org.eclipse.jetty.util.thread.ThreadPool\r\n#011at java.net.URLClassLoader.findClass(URLClassLoader.java:382)\r\n#011at java.lang.ClassLoader.loadClass(ClassLoader.java:424)\r\n#011at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:349)\r\n#011at java.lang.ClassLoader.loadClass(ClassLoader.java:357)\r\n#011... 7 more\r\nGot sigterm signal, exiting.\r\n```\r\nThe following focuses on the local deployment.\r\n\r\n### Code to reproduce issue\r\nFor a better formatting, see this [Databricks Notebook Link](https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/6227236730275197/3745858467845905/5214049462728440/latest.html).\r\n\r\nEssentially:\r\n```\r\n# Load training data\r\ndf = spark.read.parquet(\"/databricks-datasets/news20.binary/data-001/training\").select(\"text\", \"topic\")\r\ntrain, test = df.randomSplit([0.8, 0.2], 42)\r\ntrain.cache().count()\r\ntest.cache().count()\r\n\r\nfrom pyspark.ml import Pipeline\r\nfrom pyspark.ml.classification import DecisionTreeClassifier\r\nfrom pyspark.ml.feature import StringIndexer, Tokenizer, HashingTF\r\nfrom pyspark.ml.evaluation import MulticlassClassificationEvaluator\r\nfrom pyspark.ml.tuning import CrossValidator, ParamGridBuilder\r\n\r\n# Define pipeline components\r\nlabelIndexer = StringIndexer(inputCol=\"topic\", outputCol=\"label\", handleInvalid=\"keep\")\r\ntokenizer = Tokenizer(inputCol=\"text\", outputCol=\"words\")\r\nhashingTF = HashingTF(inputCol=\"words\", outputCol=\"features\")\r\ndt = DecisionTreeClassifier()\r\n\r\n# Construct a Pipeline object using the defined components\r\npipeline = Pipeline(stages=[labelIndexer, tokenizer, hashingTF, dt])\r\n\r\n# Fine-tune the model, for simplicity purposes, only tune the 'numFeatures' parameter in HashingTF() vectorizer\r\nparamGrid = (ParamGridBuilder()\r\n             .addGrid(hashingTF.numFeatures, [100, 200])\r\n             .build()\r\n            )\r\ncv = CrossValidator(estimator=pipeline, \r\n                    evaluator=MulticlassClassificationEvaluator(), \r\n                    estimatorParamMaps=paramGrid\r\n                   )\r\n\r\n# use Mlflow to log the best model into Mleap format\r\nimport mlflow\r\nimport mlflow.mleap\r\nwith mlflow.start_run() as run:\r\n  cvmodel = cv.fit(train)\r\n  # extract the optimal Pipeline model to be logged\r\n  model = cvmodel.bestModel\r\n  mlflow.mleap.log_model(spark_model=model, sample_input=train, artifact_path=\"test_model_dbr60\")\r\n```\r\nLocally I used the Mlflow buit-in functionalities to build the docker image, copy the logged model to a local Macbook and deploy:\r\n\r\n- build a pre-configured docker image\r\n`$ mlflow sagemaker build-and-push-container --no-push`\r\n - use Databricks CLI to copy the logged model to a local directory:\r\n`$ databricks fs cp -r </databricks/path/to/logged/test_model/dbr60> </local/path/to/test_model_dbr60/>`\r\n - run local test:\r\n`$ mlflow sagemaker run-local -m </local/path/to/test_model_dbr60/>`\r\n\r\n\r\n### Other info / logs\r\n\r\n(all the details are included in the above [Databricks Notebook Link](https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/6227236730275197/3745858467845905/5214049462728440/latest.html))\r\n\r\nThe whole log was:\r\n```\r\n(base) aFrustratedUsers-MBP:~ aFrustratedUser$ mlflow sagemaker run-local -m ~/Downloads/test_model_dbr60/\r\nUsing the mleap flavor for local serving!\r\n2019/10/04 18:53:23 INFO mlflow.sagemaker: launching docker image with path /Users/aFrustratedUser/Downloads/test_model_dbr60\r\n2019/10/04 18:53:23 INFO mlflow.sagemaker: executing: docker run -v /Users/aFrustratedUser/Downloads/test_model_dbr60:/opt/ml/model/ -p 5000:8080 -e MLFLOW_DEPLOYMENT_FLAVOR_NAME=mleap --rm mlflow-pyfunc serve\r\nError: A JNI error has occurred, please check your installation and try again\r\nException in thread \"main\" java.lang.NoClassDefFoundError: org/eclipse/jetty/util/thread/ThreadPool\r\n\tat java.lang.Class.getDeclaredMethods0(Native Method)\r\n\tat java.lang.Class.privateGetDeclaredMethods(Class.java:2701)\r\n\tat java.lang.Class.privateGetMethodRecursive(Class.java:3048)\r\n\tat java.lang.Class.getMethod0(Class.java:3018)\r\n\tat java.lang.Class.getMethod(Class.java:1784)\r\n\tat sun.launcher.LauncherHelper.validateMainClass(LauncherHelper.java:544)\r\n\tat sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:526)\r\nCaused by: java.lang.ClassNotFoundException: org.eclipse.jetty.util.thread.ThreadPool\r\n\tat java.net.URLClassLoader.findClass(URLClassLoader.java:382)\r\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:424)\r\n\tat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:349)\r\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:357)\r\n\t... 7 more\r\nGot sigterm signal, exiting.\r\n```\r\n\r\nTo reproduce the error, it requires:\r\n#### Databricks:\r\na Python3 cluster with Databricks Runtime 6.0 with:\r\n - instance type: m4.large\r\n - spark config: `spark.databricks.mlflow.trackMLlib.enabled true` # helps to automatically track parameters when using `pyspark.ml.tuning.CrossValidator()`\r\n - an AWS IAM role: with full access to AWS SageMaker\r\n - libraries:\r\n   - PyPI:\r\n     - `boto3==1.9.215`\r\n     - `mleap==0.8.1`\r\n     - `mlflow[extra]`\r\n     - `sagemaker==1.42.4`\r\n   - Maven:\r\n     - `ml.combust.mleap:mleap-spark_2.11:0.13.0`\r\n     - `ml.dmlc:xgboost4j-spark:0.90`\r\n\r\n#### Locally:\r\n  - setup proper AWS authorization and Databricks CLI\r\n    - `$ aws --version`  aws-cli/1.16.225 Python/3.7.3 Darwin/18.7.0 botocore/1.12.215  \r\n    - `$ databricks --version` Version 0.8.7  \r\n  - pip install mlflow==1.3.0 locally \r\n  - install docker locally and start docker service\r\n    -`$ docker version`  \r\n  Client: Docker Engine - Community  \r\n   Version:           19.03.2  \r\n   API version:       1.40  \r\n   Go version:        go1.12.8  \r\n   Git commit:        6a30dfc  \r\n   Built:             Thu Aug 29 05:26:49 2019  \r\n   OS/Arch:           darwin/amd64  \r\n   Experimental:      false  \r\n  Server: Docker Engine - Community  \r\n   Engine:  \r\n    Version:          19.03.2  \r\n    API version:      1.40 (minimum version 1.12)  \r\n    Go version:       go1.12.8  \r\n    Git commit:       6a30dfc  \r\n    Built:            Thu Aug 29 05:32:21 2019  \r\n    OS/Arch:          linux/amd64  \r\n    Experimental:     false  \r\n   containerd:  \r\n    Version:          v1.2.6  \r\n    GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb  \r\n   runc:  \r\n    Version:          1.0.0-rc8  \r\n    GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f  \r\n   docker-init:  \r\n    Version:          0.18.0  \r\n    GitCommit:        fec3683","closed_by":{"login":"ShumzZ","id":20703213,"node_id":"MDQ6VXNlcjIwNzAzMjEz","avatar_url":"https://avatars.githubusercontent.com/u/20703213?v=4","gravatar_id":"","url":"https://api.github.com/users/ShumzZ","html_url":"https://github.com/ShumzZ","followers_url":"https://api.github.com/users/ShumzZ/followers","following_url":"https://api.github.com/users/ShumzZ/following{/other_user}","gists_url":"https://api.github.com/users/ShumzZ/gists{/gist_id}","starred_url":"https://api.github.com/users/ShumzZ/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShumzZ/subscriptions","organizations_url":"https://api.github.com/users/ShumzZ/orgs","repos_url":"https://api.github.com/users/ShumzZ/repos","events_url":"https://api.github.com/users/ShumzZ/events{/privacy}","received_events_url":"https://api.github.com/users/ShumzZ/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1906/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1906/timeline","performed_via_github_app":null,"state_reason":"completed"}