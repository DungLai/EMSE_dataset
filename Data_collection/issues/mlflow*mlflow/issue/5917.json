{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5917","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5917/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5917/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5917/events","html_url":"https://github.com/mlflow/mlflow/issues/5917","id":1242842285,"node_id":"I_kwDOCB5Jx85KFESt","number":5917,"title":"[BUG] How to set sqlite database backend mlflow in computing cluster?","user":{"login":"Jingnan-Jia","id":34941987,"node_id":"MDQ6VXNlcjM0OTQxOTg3","avatar_url":"https://avatars.githubusercontent.com/u/34941987?v=4","gravatar_id":"","url":"https://api.github.com/users/Jingnan-Jia","html_url":"https://github.com/Jingnan-Jia","followers_url":"https://api.github.com/users/Jingnan-Jia/followers","following_url":"https://api.github.com/users/Jingnan-Jia/following{/other_user}","gists_url":"https://api.github.com/users/Jingnan-Jia/gists{/gist_id}","starred_url":"https://api.github.com/users/Jingnan-Jia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jingnan-Jia/subscriptions","organizations_url":"https://api.github.com/users/Jingnan-Jia/orgs","repos_url":"https://api.github.com/users/Jingnan-Jia/repos","events_url":"https://api.github.com/users/Jingnan-Jia/events{/privacy}","received_events_url":"https://api.github.com/users/Jingnan-Jia/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-20T08:56:48Z","updated_at":"2022-05-25T19:10:38Z","closed_at":"2022-05-25T09:28:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Discussed in https://github.com/mlflow/mlflow/discussions/5908\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **Jingnan-Jia** May 19, 2022</sup>\r\nI use cluster (10 GPU computing nodes, 20 CPU computing nodes, 1 login nodes, 1 management node, with the shared file system) in my daily life. I found mlflow is very useful and convenient to track the experiments run on different computing nodes. But when I have more and more experiments/runs, I found that the mlflow web UI  becomes very slow. This is because the default storage method is file storage system. So the mlflow has to iterately search every directory and read the files. I think database based storage method can speed up it. So I want to set sqlite database as the backend of mlflow. Then I met some difficulties. \r\n\r\nIf I want to use the default file storage system, I \r\n1. do not need to set `mlflow.set_tracking_uri()` in my python script,\r\n2. do not need to run `mlflow server <args>` in my linux terminal,\r\n3. use `mlflow.log_metrics()` and other log functions in my python script and then run `mlflow ui` in my linux terminal. \r\nThen I can successfully view the experiments records on `localhost: 5000` (I set the port local forward to view the ui in my local PC).\r\n\r\nBut if I want to use sqlite database backend, these are the steps I applied:\r\n1. set `mlflow.set_tracking_uri()` in my python script,\r\n2. run `mlflow server <args>` in my linux terminal,\r\n3. use `mlflow.log_metrics()` and other log functions in my python script. \r\n4. Do not need to run `mlflow ui` in my linux terminal, because `mlflow server <>` has coved the function of `mlflow ui` I think.\r\n\r\nThe key issue here is how to set  `mlflow.set_tracking_uri()` in my python script, and how to set `mlflow server <args>` in my linux terminal. \r\n\r\nAt first, I run the following line in my linux terminal on my **login node**:\r\n`mlflow server --backend-store-uri=sqlite:///mlrunsdb.db --default-artifact-root=file:mlruns`. I hope the `Parameters`, `Metrics`, and other small files are saved in `mlrunsdb.db`, and big files like `artifacts` and `model` are saved in file directory `mlruns`.**Is my command right?**\r\n\r\nThen, I need to set mlflow.set_tracking_uri. From the [docs](https://www.mlflow.org/docs/latest/python_api/mlflow.html#:~:text=mlflow.set_tracking_uri(uri,%5Bsource%5D), there are 4 options:\r\n1. An empty string, or a local file path, prefixed with file:/. Data is stored locally at the provided file (or ./mlruns if empty).\r\n2. An HTTP URI like https://my-tracking-server:5000.\r\n3. A Databricks workspace, provided as the string “databricks” or, to use a Databricks CLI [profile](https://github.com/databricks/databricks-cli#installation), “databricks://<profileName>”.\r\n4. A pathlib.Path instance\r\n\r\nNow the question is how to set it in a sqlite backend mlflow in distriuted cluster? I tried several settings:\r\nAt first, do not set `mlflow.set_tracking_uri()` at all just as what I have done for the file storage system before. The result is that the code can be run successfully but the web ui did not record anything. In contrast, when I terminated the command `mlflow server --backend-store-uri=sqlite:///mlrunsdb.db --default-artifact-root=file:mlruns` using `ctrl+c`, then run `mlflow ui`, the recorded runs/experiments could be viewed now! So this means that I have to set `mlflow.set_tracking_uri()` if I want the mlflow to record parameters to database instead of default file system.\r\n\r\n\r\n- So then I tried to set uri as `mlflow.set_tracking_uri(\"http://localhost:5000\")`.\r\nThen I noticed that if I ran the code on different computing nodes, these experiments all failed because of the error: `ConnectionRefusedError: [Errno 111] Connection refused`. But if I ran the code on the login node, it was okay. I guess this is because the `localhost` in my `set_tracking_uri(\"http://localhost:5000\")` means the localhost of the login node instead of any other computing nodes. **Is it right?**\r\n\r\n\r\n- So I tried to set `mlflow.set_tracking_uri(\"http://10.161.27.235:5000\")` (Here 10.161.27.235 is the IP address of the login node). But the code can not be run successfully at all no matter on computing nodes or login node. The error is: `requests.exceptions.ConnectionError: HTTPConnectionPool(host='10.161.27.235', port=5000): Max retries exceeded with url: /api/2.0/mlflow/experiments/list?view_type=ALL (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x2aabd74e12e0>: Failed to establish a new connection: [Errno 111] Connection refused'))`\r\nSo my conclusion is that maybe I should not set HTTP URI for such a computing cluster. **Is my conclusion right?**\r\n\r\n\r\n- So I tried `mlflow.set_tracking_uri('sqlite:///mlrunsdb2.db')` (before that I ran `mlflow server --backend-store-uri=sqlite:///mlrunsdb2.db --default-artifact-root=file:mlruns` on my linux terminal in login node). \r\nThe result was very weird. \r\n  1. The code can be run successfully on computing node for several minute, but when I refresh the web ui or just no reason, the experiment would broke down immediatly. The error information is: `mlflow.exceptions.MlflowException: (sqlite3.OperationalError) disk I/O error (Background on this error at: https://sqlalche.me/e/14/e3q8) `\r\n  2. The code can be run successfully on login node, even refreshing the web ui can not lead it to break down. But when I launched another experiment in a computing node, the two experiments (one in login node, anoter one in computing node) will break down at the same time because of unclear reason (error is: `mlflow.exceptions.MlflowException: (sqlite3.OperationalError) disk I/O error\r\n(Background on this error at: https://sqlalche.me/e/14/e3q8)`).\r\n\r\n\r\nTo summarize, I tried `set_tracking_uri` using HTTP URL or `sqlite:///mlrunsdb2.db`, but both failed. Errors are different. \r\n\r\n**Can you tell me what is the correct way to achieve sqlite database backend mlflow in computing cluster?**\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n</div>","closed_by":{"login":"Jingnan-Jia","id":34941987,"node_id":"MDQ6VXNlcjM0OTQxOTg3","avatar_url":"https://avatars.githubusercontent.com/u/34941987?v=4","gravatar_id":"","url":"https://api.github.com/users/Jingnan-Jia","html_url":"https://github.com/Jingnan-Jia","followers_url":"https://api.github.com/users/Jingnan-Jia/followers","following_url":"https://api.github.com/users/Jingnan-Jia/following{/other_user}","gists_url":"https://api.github.com/users/Jingnan-Jia/gists{/gist_id}","starred_url":"https://api.github.com/users/Jingnan-Jia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jingnan-Jia/subscriptions","organizations_url":"https://api.github.com/users/Jingnan-Jia/orgs","repos_url":"https://api.github.com/users/Jingnan-Jia/repos","events_url":"https://api.github.com/users/Jingnan-Jia/events{/privacy}","received_events_url":"https://api.github.com/users/Jingnan-Jia/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5917/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5917/timeline","performed_via_github_app":null,"state_reason":"completed"}