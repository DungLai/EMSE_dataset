{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4921","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4921/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4921/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4921/events","html_url":"https://github.com/mlflow/mlflow/issues/4921","id":1032498760,"node_id":"I_kwDOCB5Jx849iq5I","number":4921,"title":"[FR] Allow Deploying SageMaker Endpoints to Another AWS Account","user":{"login":"andresionek91","id":5912422,"node_id":"MDQ6VXNlcjU5MTI0MjI=","avatar_url":"https://avatars.githubusercontent.com/u/5912422?v=4","gravatar_id":"","url":"https://api.github.com/users/andresionek91","html_url":"https://github.com/andresionek91","followers_url":"https://api.github.com/users/andresionek91/followers","following_url":"https://api.github.com/users/andresionek91/following{/other_user}","gists_url":"https://api.github.com/users/andresionek91/gists{/gist_id}","starred_url":"https://api.github.com/users/andresionek91/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andresionek91/subscriptions","organizations_url":"https://api.github.com/users/andresionek91/orgs","repos_url":"https://api.github.com/users/andresionek91/repos","events_url":"https://api.github.com/users/andresionek91/events{/privacy}","received_events_url":"https://api.github.com/users/andresionek91/received_events","type":"User","site_admin":false},"labels":[{"id":955449434,"node_id":"MDU6TGFiZWw5NTU0NDk0MzQ=","url":"https://api.github.com/repos/mlflow/mlflow/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"},{"id":2022860064,"node_id":"MDU6TGFiZWwyMDIyODYwMDY0","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/sagemaker","name":"integrations/sagemaker","color":"ffbce5","default":false,"description":"Sagemaker integrations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-10-21T13:26:36Z","updated_at":"2021-11-17T21:28:56Z","closed_at":"2021-11-17T21:28:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Willingness to contribute\r\nThe MLflow Community encourages new feature contributions. Would you or another member of your organization be willing to contribute an implementation of this feature (either as an MLflow Plugin or an enhancement to the MLflow code base)?\r\n\r\n- [x] Yes. I can contribute this feature independently.\r\n- [ ] Yes. I would be willing to contribute this feature with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute this feature at this time.\r\n\r\n## Proposal Summary\r\n\r\nCurrently, MLFlow will only allows deploying SageMaker endpoints to the currently active AWS account. This feature request aims to allow deployment to a different account by assuming a cross-account role.  \r\n\r\n## Motivation\r\n- What is the use case for this feature?\r\n\r\nIt is quite common to have architectures where the infrastructure resides in multiple AWS accounts and you might want to allow a service in one account to deploy SageMaker into another account.\r\n\r\n- Why is this use case valuable to support for MLflow users in general?\r\n\r\nOne practical example is using MlFlow to deploy SageMaker using Databricks. One of the recommended ways of deploying Databricks is by creating a separate AWS Account to host the workspace infrastructure. Separating the Databricks infrastructure from other business-critical infrastructure (S3 buckets, EC2s, RDS, etc). \r\n\r\nIn that case, a user might want to deploy SageMaker into the AWS account that holds the business infrastructure, and not in the Databricks account.\r\n\r\nDeploying Sagemaker to the same account that holds the rest of the business infrastructure is critical to avoid infrastructure overhead such as VPC peering between Databricks and Business/Production VPCs. \r\n\r\n- Why is this use case valuable to support for your project(s) or organization?\r\n\r\nSome companies have restrictions in allowing VPC peering. Also as an architecture principle, it is good practice to keep all production services in the same account (so that a lambda function can access SageMaker endpoint in the same account, for example).\r\n\r\nAllowing MlFlow to assume a role and deploy to a different AWS account will make it easier to deploy resources to a different account and also make the architecture more straightforward.\r\n\r\n- Why is it currently difficult to achieve this use case? (please be as specific as possible about why related MLflow features and components are insufficient)\r\n\r\nMLflow currently only allows deploying to the current active AWS Account. In the case someone is using Databricks, that means the account where Databricks infrastructure is running.\r\n\r\n### What component(s), interfaces, languages, and integrations does this feature affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterfaces\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguages \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [x] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n\r\n## Details\r\n\r\nImplementation can be achieved by assuming a role using `boto3` sts client. And then passing the credentials to `sage_client`.\r\n```\r\nboto_sts = boto3.client(\"sts\")\r\n\r\nsts_response = boto_sts.assume_role(\r\n    RoleArn=\"arn:aws:iam::123456789:role/cross-account-role-arn\",\r\n    RoleSessionName='newsession'\r\n)\r\n\r\nsts_credentials = {\r\n    \"aws_access_key_id\": stsresponse[\"Credentials\"][\"AccessKeyId\"],\r\n    \"aws_secret_access_key\": stsresponse[\"Credentials\"][\"SecretAccessKey\"],\r\n    \"aws_session_token\": stsresponse[\"Credentials\"][\"SessionToken\"]\r\n}\r\n\r\nsage_client = boto3.client(\"sagemaker\", region_name=region, **sts_credentials)\r\n```\r\n\r\nOf course that we also need to get `role_arn` as an optional parameter in all SageMaker APIs and make all adjustments in the code to make that work. But I don't see this as being a breaking change, and it is a nice functionality to have available.","closed_by":{"login":"andresionek91","id":5912422,"node_id":"MDQ6VXNlcjU5MTI0MjI=","avatar_url":"https://avatars.githubusercontent.com/u/5912422?v=4","gravatar_id":"","url":"https://api.github.com/users/andresionek91","html_url":"https://github.com/andresionek91","followers_url":"https://api.github.com/users/andresionek91/followers","following_url":"https://api.github.com/users/andresionek91/following{/other_user}","gists_url":"https://api.github.com/users/andresionek91/gists{/gist_id}","starred_url":"https://api.github.com/users/andresionek91/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andresionek91/subscriptions","organizations_url":"https://api.github.com/users/andresionek91/orgs","repos_url":"https://api.github.com/users/andresionek91/repos","events_url":"https://api.github.com/users/andresionek91/events{/privacy}","received_events_url":"https://api.github.com/users/andresionek91/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4921/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4921/timeline","performed_via_github_app":null,"state_reason":"completed"}