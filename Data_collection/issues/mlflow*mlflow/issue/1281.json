{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1281","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1281/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1281/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1281/events","html_url":"https://github.com/mlflow/mlflow/issues/1281","id":444782514,"node_id":"MDU6SXNzdWU0NDQ3ODI1MTQ=","number":1281,"title":"Invalid artifact directory when logging model with artifacts to tracking server","user":{"login":"jason-huling","id":7820042,"node_id":"MDQ6VXNlcjc4MjAwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/7820042?v=4","gravatar_id":"","url":"https://api.github.com/users/jason-huling","html_url":"https://github.com/jason-huling","followers_url":"https://api.github.com/users/jason-huling/followers","following_url":"https://api.github.com/users/jason-huling/following{/other_user}","gists_url":"https://api.github.com/users/jason-huling/gists{/gist_id}","starred_url":"https://api.github.com/users/jason-huling/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jason-huling/subscriptions","organizations_url":"https://api.github.com/users/jason-huling/orgs","repos_url":"https://api.github.com/users/jason-huling/repos","events_url":"https://api.github.com/users/jason-huling/events{/privacy}","received_events_url":"https://api.github.com/users/jason-huling/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-05-16T06:49:59Z","updated_at":"2019-05-17T16:39:08Z","closed_at":"2019-05-17T16:39:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### System information\r\n#### Tracking Server Setup\r\nI have setup the tracking server in Google's App Engine using the standard Python 3.7 environment and the following `app.yaml`:\r\n```\r\nservice: mlflow\r\nruntime: python37\r\nentrypoint: mlflow server --workers 4 --backend-store-uri mysql://mlflow:<password>@/mlflow?unix_socket=/cloudsql/<project-id>:<region>:<cloud-sql-instance> --default-artifact-root gs://<mlflow-bucket>/ --host 0.0.0.0 --port $PORT\r\n\r\nbeta_settings:\r\n  cloud_sql_instances: <project-id>:<region>:<cloud-sql-instance>\r\n```\r\nWith the following requirements text:\r\n```\r\nmlflow==0.9.0\r\nsqlalchemy\r\nmysqlclient\r\ngoogle-cloud-storage\r\n```\r\nI am currently using 0.9.0 and also tried the master branch which I believe is 0.9.2.dev0. The 0.9.1 version wouldn't work for me because of https://github.com/mlflow/mlflow/issues/1165.\r\n\r\nI'm using Google's Cloud SQL (MySQL) for the backend-store-uri and a Google Storage bucket for the default-artifact-root.\r\n\r\n#### Client Setup\r\nThe client is running in Python 3.7 on Dataproc with the 1.4-debian9 image version. I have tried using 0.9.0, 0.9.1, and 0.9.2.dev0 on the client side.\r\n\r\n### Describe the problem\r\nWhen using the remote tracking server described above and `mlflow.pyfunc.log_model`, the `artifacts` passed to `log_model` are being saved to a sub directory of the model literally named `..` in the Google Storage bucket. I believe that as a result of this, when the files are downloaded through `mlflow.pyfunc.load_model`, the path `tmp/model/../foo` is interpreted as `tmp/foo`, when mlflow expects it to be at `tmp/model/artifacts/foo`.\r\n\r\nI will note that when using `mlflow.pyfunc.log_model` and setting `MLFLOW_TRACKING_URI` to the local file system there are no issues, and the sub directory of the model that was named `..` above, is correctly named `artifacts`.\r\n\r\n### Source code / logs\r\n#### Logging the Model w/ Artifacts\r\n```\r\nimport mlflow.pyfunc\r\nos.environ['MLFLOW_TRACKING_URI'] = 'https://<mlflow-instance>.appspot.com/'\r\n\r\nclass CustomModel(mlflow.pyfunc.PythonModel):\r\n    # Define load_context and predict...\r\n\r\nmlflow.pyfunc.log_model(\r\n    artifact_path='model',\r\n    python_model=CustomModel(), \r\n    artifacts={\r\n        'foo': local_foo_path\r\n    },\r\n    conda_env=conda_env\r\n)\r\n```\r\nThe above code will create the following structure in the Google Storage bucket when using the remote tracking server:\r\n```\r\ngs://<bucket>/1/<run-id>/artifacts\r\n|-- model\r\n    |-- MLmodel\r\n    |-- conda.yaml\r\n    |-- python_model.pkl\r\n    |-- ../\r\n        |-- foo\r\n```\r\nSo the path for foo is actually `gs://<bucket>/1/<run-id>/artifacts/model/../foo`.\r\n\r\nIf you instead set the `MLFLOW_TRACKING_URI` to `./mlflow`, it would look like the following:\r\n```\r\n./mlflow/1/<run-id>/artifacts\r\n|-- model\r\n    |-- MLmodel\r\n    |-- conda.yaml\r\n    |-- python_model.pkl\r\n    |-- artifacts/\r\n        |-- foo\r\n```\r\n\r\n#### Loading the model\r\n```\r\n# version 0.9.2.dev0\r\nloaded_model = mlflow.pyfunc.load_model('runs:/<id>/model')\r\n# version 0.9.0-0.9.1\r\nloaded_model = mlflow.pyfunc.load_pyfunc('model', run_id='<id>')\r\n```\r\n\r\nThis is the error from 0.9.2.dev0, but it is very similar in the earlier versions.\r\n```\r\n---------------------------------------------------------------------------\r\nFileNotFoundError                         Traceback (most recent call last)\r\n<timed exec> in <module>\r\n\r\n~/myproject/env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py in load_model(model_uri, suppress_warnings)\r\n    282                               are emitted.\r\n    283     \"\"\"\r\n--> 284     return load_pyfunc(model_uri, suppress_warnings)\r\n    285 \r\n    286 \r\n\r\n~/myproject/env/lib/python3.7/site-packages/mlflow/pyfunc/__init__.py in load_pyfunc(model_uri, suppress_warnings)\r\n    314         mlflow.pyfunc.utils._add_code_to_system_path(code_path=code_path)\r\n    315     data_path = os.path.join(local_model_path, conf[DATA]) if (DATA in conf) else local_model_path\r\n--> 316     return importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n    317 \r\n    318 \r\n\r\n~/myproject/env/lib/python3.7/site-packages/mlflow/pyfunc/model.py in _load_pyfunc(model_path)\r\n    225                         model_path, saved_artifact_info[CONFIG_KEY_ARTIFACT_RELATIVE_PATH]),\r\n    226                     dst=tmp_artifacts_dir_path,\r\n--> 227                     dst_dir=saved_artifact_name))\r\n    228         artifacts[saved_artifact_name] = tmp_artifact_path\r\n    229 \r\n\r\n~/myproject/env/lib/python3.7/site-packages/mlflow/utils/file_utils.py in _copy_file_or_tree(src, dst, dst_dir)\r\n    334         shutil.copy(src=src, dst=dst_path)\r\n    335     else:\r\n--> 336         shutil.copytree(src=src, dst=dst_path)\r\n    337     return dst_subpath\r\n    338 \r\n\r\n~/myproject/env/lib/python3.7/shutil.py in copytree(src, dst, symlinks, ignore, copy_function, ignore_dangling_symlinks)\r\n    313 \r\n    314     \"\"\"\r\n--> 315     names = os.listdir(src)\r\n    316     if ignore is not None:\r\n    317         ignored_names = ignore(src, names)\r\n\r\nFileNotFoundError: [Errno 2] No such file or directory: '/tmp/tmp8emll8qw/model/artifacts/foo'\r\n```\r\nWhen I list the contents of the temp directory, I get the following:\r\n```\r\n/tmp/tmp8emll8qw\r\n|-- model\r\n    |-- MLmodel\r\n    |-- conda.yaml\r\n    |-- python_model.pkl\r\n|-- foo\r\n```\r\nSo it seems as though `/tmp/tmp8emll8qw/model/../foo` was interpreted as `/tmp/tmp8emll8qw/foo` when it was expected to be at `/tmp/tmp8emll8qw/model/artifacts/foo`.\r\n\r\n\r\n","closed_by":{"login":"jason-huling","id":7820042,"node_id":"MDQ6VXNlcjc4MjAwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/7820042?v=4","gravatar_id":"","url":"https://api.github.com/users/jason-huling","html_url":"https://github.com/jason-huling","followers_url":"https://api.github.com/users/jason-huling/followers","following_url":"https://api.github.com/users/jason-huling/following{/other_user}","gists_url":"https://api.github.com/users/jason-huling/gists{/gist_id}","starred_url":"https://api.github.com/users/jason-huling/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jason-huling/subscriptions","organizations_url":"https://api.github.com/users/jason-huling/orgs","repos_url":"https://api.github.com/users/jason-huling/repos","events_url":"https://api.github.com/users/jason-huling/events{/privacy}","received_events_url":"https://api.github.com/users/jason-huling/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1281/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1281/timeline","performed_via_github_app":null,"state_reason":"completed"}