{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5148","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5148/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5148/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5148/events","html_url":"https://github.com/mlflow/mlflow/issues/5148","id":1073316192,"node_id":"I_kwDOCB5Jx84_-YFg","number":5148,"title":"[SETUP-BUG] asyncpg driver does not work with mlflow for a postgres backend db","user":{"login":"bgalvao","id":17158288,"node_id":"MDQ6VXNlcjE3MTU4Mjg4","avatar_url":"https://avatars.githubusercontent.com/u/17158288?v=4","gravatar_id":"","url":"https://api.github.com/users/bgalvao","html_url":"https://github.com/bgalvao","followers_url":"https://api.github.com/users/bgalvao/followers","following_url":"https://api.github.com/users/bgalvao/following{/other_user}","gists_url":"https://api.github.com/users/bgalvao/gists{/gist_id}","starred_url":"https://api.github.com/users/bgalvao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bgalvao/subscriptions","organizations_url":"https://api.github.com/users/bgalvao/orgs","repos_url":"https://api.github.com/users/bgalvao/repos","events_url":"https://api.github.com/users/bgalvao/events{/privacy}","received_events_url":"https://api.github.com/users/bgalvao/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-12-07T12:50:47Z","updated_at":"2021-12-07T13:05:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Docker 20.10.10; `docker-compose` 2.1.1; `Linux 5.13.19-2-MANJARO`\r\n- **MLflow installed from (source or binary)**: pip\r\n- **MLflow version (run ``mlflow --version``)**: 1.21.0\r\n- **Python version**: 3.10.0\r\n- **Exact command to reproduce** (in effect):\r\n```bash\r\nmlflow server --host 0.0.0.0 -p 5000 --default-artifact-root /home/mlflow \\\r\n--backend-store-uri postgresql+asyncpg://postgres:${MLFLOW_DB_PASSWORD}@mlflow-db:5432/${MLFLOW_DB_NAME}\r\n```\r\n\r\n### Description\r\n\r\nI am trying to make mlflow run as a service in docker-compose engine. And I succeeded, provided I only run the sync driver for postgres (`postgresql`). However, using the async driver `asyncpg` makes it so that MLFlow makes SQLAlchemy not be able to create the engine. The relevant files are in [this public gist](https://gist.github.com/bgalvao/49706a5eb30aef2288c6687993ed9879).\r\n\r\n### Steps to reproduce\r\n\r\n1. Download the [Dockerfile](https://gist.github.com/bgalvao/49706a5eb30aef2288c6687993ed9879#file-dockerfile) and place it in `./mlflow` so that it follows the build context specified at the docker compose file.\r\n2. Download [.env](https://gist.github.com/bgalvao/49706a5eb30aef2288c6687993ed9879#file-env) and [docker-compose.yml](https://gist.github.com/bgalvao/49706a5eb30aef2288c6687993ed9879#file-docker-compose-yml), and place them in `./`.\r\n3. From `./`, run `docker-compose up`.\r\n\r\n\r\n### Other info / logs\r\n\r\nTLDR from interpreting the gist is that in effect, the mlflow command that is invoked is\r\n\r\n```bash\r\nmlflow server --host 0.0.0.0 -p 5000 --default-artifact-root /home/mlflow \\\r\n--backend-store-uri postgresql+asyncpg://postgres:${MLFLOW_DB_PASSWORD}@mlflow-db:5432/${MLFLOW_DB_NAME}\r\n```\r\n\r\nI've tried this procedure with and without `+asyncpg` in the SQLAlchemy URI. In the latter case, everything worked:\r\n![image](https://user-images.githubusercontent.com/17158288/145032834-30074deb-ef37-4d77-9127-f2b64ba3795e.png)\r\n\r\nIn the former case (with the `+asyncpg` driver), the GUI does not even start, and this is what the log from `docker-compose up mlflow` has to say:\r\n```\r\n ⠿ Network docker_mlflow         Created                                                             0.0s\r\n ⠿ Container docker-mlflow-db-1  Created                                                             0.0s\r\n ⠿ Container docker-mlflow-1     Created                                                             0.0s\r\nAttaching to docker-mlflow-1\r\ndocker-mlflow-1  | 2021/12/07 12:12:34 WARNING mlflow.store.db.utils: SQLAlchemy engine could not be created. The following exception is caught.\r\ndocker-mlflow-1  | greenlet_spawn has not been called; can't call await_() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/14/xd2s)\r\ndocker-mlflow-1  | Operation will be retried in 0.1 seconds\r\n```\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5148/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5148/timeline","performed_via_github_app":null,"state_reason":null}