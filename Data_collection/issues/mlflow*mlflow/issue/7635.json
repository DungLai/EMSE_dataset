{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7635","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7635/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7635/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7635/events","html_url":"https://github.com/mlflow/mlflow/issues/7635","id":1516488458,"node_id":"I_kwDOCB5Jx85aY8cK","number":7635,"title":"[BUG] TypeError: an integer is required (got type bytes)","user":{"login":"hjilke","id":41083139,"node_id":"MDQ6VXNlcjQxMDgzMTM5","avatar_url":"https://avatars.githubusercontent.com/u/41083139?v=4","gravatar_id":"","url":"https://api.github.com/users/hjilke","html_url":"https://github.com/hjilke","followers_url":"https://api.github.com/users/hjilke/followers","following_url":"https://api.github.com/users/hjilke/following{/other_user}","gists_url":"https://api.github.com/users/hjilke/gists{/gist_id}","starred_url":"https://api.github.com/users/hjilke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjilke/subscriptions","organizations_url":"https://api.github.com/users/hjilke/orgs","repos_url":"https://api.github.com/users/hjilke/repos","events_url":"https://api.github.com/users/hjilke/events{/privacy}","received_events_url":"https://api.github.com/users/hjilke/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-01-02T15:06:25Z","updated_at":"2023-01-06T05:51:18Z","closed_at":"2023-01-06T05:51:11Z","author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\r\n\r\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\n\r\n### Willingness to contribute\r\n\r\nYes. I can contribute a fix for this bug independently.\r\n\r\n### MLflow version\r\n\r\n- Client: 1.28.0\r\n- Tracking server: 1.28.0\r\n\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: OS\r\n- **Python version**: 3.8.8\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\nHey All!\r\n\r\nI have trained a Pytorch model and serialised this to an S3 bucket via MLflow. All this was done with python 3.7.9. \r\nNow loading the model works fine with python 3.7.9, but does not work with e.g. python 3.8.8. \r\n\r\nE.g.\r\n\r\n```\r\nfrom mlflow import pyfunc\r\n\r\npyfunc.load_model(model_uri=\"s3://..../7a359a813c6b4242930e3cebb780209a/artifacts/model\")\r\n\r\n```\r\nresults in:\r\n\r\n```\r\n2023/01/02 15:39:51 WARNING mlflow.pyfunc: Detected one or more mismatches between the model's dependencies and the current Python environment:\r\n - cloudpickle (current: 2.2.0, required: cloudpickle==2.1.0)\r\n - ipython (current: uninstalled, required: ipython==7.32.0)\r\n - tqdm (current: uninstalled, required: tqdm==4.64.0)\r\nTo fix the mismatches, call `mlflow.pyfunc.get_model_dependencies(model_uri)` to fetch the model's environment and install dependencies using the resulting environment file.\r\n2023/01/02 15:39:51 WARNING mlflow.pyfunc: The version of Python that the model was saved in, `Python 3.7.9`, differs from the version of Python that is currently running, `Python 3.8.8`, and may be incompatible\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \".../lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 756, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \".../lib/python3.8/site-packages/mlflow/pytorch/__init__.py\", line 735, in _load_pyfunc\r\n    return _PyTorchWrapper(_load_model(path, **kwargs))\r\n  File \".../lib/python3.8/site-packages/mlflow/pytorch/__init__.py\", line 643, in _load_model\r\n    return torch.load(model_path, **kwargs)\r\n  File \"..../lib/python3.8/site-packages/torch/serialization.py\", line 594, in load\r\n    return _load(opened_zipfile, map_location, pickle_module, **pickle_load_args)\r\n  File \"..../lib/python3.8/site-packages/torch/serialization.py\", line 853, in _load\r\n    result = unpickler.load()\r\nTypeError: an integer is required (got type bytes)\r\n```\r\n\r\nIs this intended, as the pickle protocol should be backwards compatible?\r\n\r\nThanks!\r\n\r\n\r\n### Code to reproduce issue\r\n\r\n<!-- PLEASE KEEP BACKTICKS AND CHECK PREVIEW -->\r\n```\r\nfrom mlflow import pyfunc\r\n\r\npyfunc.load_model(model_uri=\"s3://..../7a359a813c6b4242930e3cebb780209a/artifacts/model\")\r\n```\r\n\r\n\r\n### Stack trace\r\n\r\n<!-- PLEASE KEEP BACKTICKS AND CHECK PREVIEW -->\r\n```\r\n2023/01/02 15:39:51 WARNING mlflow.pyfunc: Detected one or more mismatches between the model's dependencies and the current Python environment:\r\n - cloudpickle (current: 2.2.0, required: cloudpickle==2.1.0)\r\n - ipython (current: uninstalled, required: ipython==7.32.0)\r\n - tqdm (current: uninstalled, required: tqdm==4.64.0)\r\nTo fix the mismatches, call `mlflow.pyfunc.get_model_dependencies(model_uri)` to fetch the model's environment and install dependencies using the resulting environment file.\r\n2023/01/02 15:39:51 WARNING mlflow.pyfunc: The version of Python that the model was saved in, `Python 3.7.9`, differs from the version of Python that is currently running, `Python 3.8.8`, and may be incompatible\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \".../lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 756, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \".../lib/python3.8/site-packages/mlflow/pytorch/__init__.py\", line 735, in _load_pyfunc\r\n    return _PyTorchWrapper(_load_model(path, **kwargs))\r\n  File \".../lib/python3.8/site-packages/mlflow/pytorch/__init__.py\", line 643, in _load_model\r\n    return torch.load(model_path, **kwargs)\r\n  File \"..../lib/python3.8/site-packages/torch/serialization.py\", line 594, in load\r\n    return _load(opened_zipfile, map_location, pickle_module, **pickle_load_args)\r\n  File \"..../lib/python3.8/site-packages/torch/serialization.py\", line 853, in _load\r\n    result = unpickler.load()\r\nTypeError: an integer is required (got type bytes)\r\n```\r\n\r\n\r\n### Other info / logs\r\n\r\n\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7635/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7635/timeline","performed_via_github_app":null,"state_reason":"completed"}