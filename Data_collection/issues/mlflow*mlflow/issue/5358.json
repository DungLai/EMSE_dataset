{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5358","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5358/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5358/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5358/events","html_url":"https://github.com/mlflow/mlflow/issues/5358","id":1126535742,"node_id":"I_kwDOCB5Jx85DJZI-","number":5358,"title":"[BUG] No basic auth in MlflowArtifactsRepository ","user":{"login":"TimNooren","id":17043587,"node_id":"MDQ6VXNlcjE3MDQzNTg3","avatar_url":"https://avatars.githubusercontent.com/u/17043587?v=4","gravatar_id":"","url":"https://api.github.com/users/TimNooren","html_url":"https://github.com/TimNooren","followers_url":"https://api.github.com/users/TimNooren/followers","following_url":"https://api.github.com/users/TimNooren/following{/other_user}","gists_url":"https://api.github.com/users/TimNooren/gists{/gist_id}","starred_url":"https://api.github.com/users/TimNooren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimNooren/subscriptions","organizations_url":"https://api.github.com/users/TimNooren/orgs","repos_url":"https://api.github.com/users/TimNooren/repos","events_url":"https://api.github.com/users/TimNooren/events{/privacy}","received_events_url":"https://api.github.com/users/TimNooren/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-02-07T21:48:16Z","updated_at":"2022-02-23T20:10:31Z","closed_at":"2022-02-17T15:57:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.23.0\r\n- **Python version**: 3.9\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nWe are trying to use the MLFlow server as a proxy to push artifacts to S3 using the `--serve-artifacts` flag. Our MLFlow server is behind a reverse proxy which requires basic auth. We use the default artifacts uri `mlflow-artifacts:/`, without specifying a host, which means clients will assume the host is the tracking server uri. To support basic auth for the tracking server, clients have the option to set `MLFLOW_TRACKING_USERNAME` and `MLFLOW_TRACKING_PASSWORD`, however these variables are not included in calls to the artifact proxy (`HttpArtifactRepository` constructs a `Session` without any authentication [here](https://github.com/mlflow/mlflow/blob/v1.23.1/mlflow/store/artifact/http_artifact_repo.py#L16)). There are also no dedicated variables for the artifacts proxy specifically. Providing username and password in the url directly is also not possible since these are stripped from the tracking uri when constructing the artifacts proxy uri ([here](https://github.com/mlflow/mlflow/blob/v1.23.1/mlflow/store/artifact/mlflow_artifacts_repo.py#L13)).\r\n\r\nWhen the tracking server is used as the artifacts proxy we would expect calls to the artifacts proxy to include the same authentication headers as specified for the tracking server.\r\n\r\nA pragmatic fix would be something like https://github.com/mlflow/mlflow/compare/master...TimNooren:mlflow_artifact_repo_basic_auth, but maybe the implementation could rely more on what is already provided in `mlflow.utils.rest_utils` (more similar to `mlflow.store.tracking.rest_store.RestStore`). Some guidance here would be great:)\r\n\r\n### Code to reproduce issue\r\n```python\r\nimport os\r\n\r\nfrom mlflow.store.artifact.mlflow_artifacts_repo import MlflowArtifactsRepository\r\nfrom mlflow.store.tracking import DEFAULT_ARTIFACTS_URI\r\n\r\nos.environ[\"MLFLOW_TRACKING_URI\"] = \"https://my.mlflow.server:443/\"  # Using basic auth\r\nos.environ[\"MLFLOW_TRACKING_USERNAME\"] = \"username\"\r\nos.environ[\"MLFLOW_TRACKING_PASSWORD\"] = \"password\"\r\n\r\nMlflowArtifactsRepository(DEFAULT_ARTIFACTS_URI).list_artifacts(). # Unauthorized\r\n```\r\n### Other info / logs\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5358/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5358/timeline","performed_via_github_app":null,"state_reason":"completed"}