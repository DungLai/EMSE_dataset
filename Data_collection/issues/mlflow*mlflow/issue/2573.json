{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2573","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2573/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2573/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2573/events","html_url":"https://github.com/mlflow/mlflow/issues/2573","id":579562413,"node_id":"MDU6SXNzdWU1Nzk1NjI0MTM=","number":2573,"title":"[BUG] SageMaker deploy fails due to invalid link to model","user":{"login":"Tradunsky","id":4522842,"node_id":"MDQ6VXNlcjQ1MjI4NDI=","avatar_url":"https://avatars.githubusercontent.com/u/4522842?v=4","gravatar_id":"","url":"https://api.github.com/users/Tradunsky","html_url":"https://github.com/Tradunsky","followers_url":"https://api.github.com/users/Tradunsky/followers","following_url":"https://api.github.com/users/Tradunsky/following{/other_user}","gists_url":"https://api.github.com/users/Tradunsky/gists{/gist_id}","starred_url":"https://api.github.com/users/Tradunsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tradunsky/subscriptions","organizations_url":"https://api.github.com/users/Tradunsky/orgs","repos_url":"https://api.github.com/users/Tradunsky/repos","events_url":"https://api.github.com/users/Tradunsky/events{/privacy}","received_events_url":"https://api.github.com/users/Tradunsky/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1893072438,"node_id":"MDU6TGFiZWwxODkzMDcyNDM4","url":"https://api.github.com/repos/mlflow/mlflow/labels/help%20wanted","name":"help wanted","color":"c5def5","default":true,"description":"We would like help from the community to add this support"},{"id":2022860064,"node_id":"MDU6TGFiZWwyMDIyODYwMDY0","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/sagemaker","name":"integrations/sagemaker","color":"ffbce5","default":false,"description":"Sagemaker integrations"}],"state":"closed","locked":false,"assignee":{"login":"smurching","id":2358483,"node_id":"MDQ6VXNlcjIzNTg0ODM=","avatar_url":"https://avatars.githubusercontent.com/u/2358483?v=4","gravatar_id":"","url":"https://api.github.com/users/smurching","html_url":"https://github.com/smurching","followers_url":"https://api.github.com/users/smurching/followers","following_url":"https://api.github.com/users/smurching/following{/other_user}","gists_url":"https://api.github.com/users/smurching/gists{/gist_id}","starred_url":"https://api.github.com/users/smurching/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smurching/subscriptions","organizations_url":"https://api.github.com/users/smurching/orgs","repos_url":"https://api.github.com/users/smurching/repos","events_url":"https://api.github.com/users/smurching/events{/privacy}","received_events_url":"https://api.github.com/users/smurching/received_events","type":"User","site_admin":false},"assignees":[{"login":"smurching","id":2358483,"node_id":"MDQ6VXNlcjIzNTg0ODM=","avatar_url":"https://avatars.githubusercontent.com/u/2358483?v=4","gravatar_id":"","url":"https://api.github.com/users/smurching","html_url":"https://github.com/smurching","followers_url":"https://api.github.com/users/smurching/followers","following_url":"https://api.github.com/users/smurching/following{/other_user}","gists_url":"https://api.github.com/users/smurching/gists{/gist_id}","starred_url":"https://api.github.com/users/smurching/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smurching/subscriptions","organizations_url":"https://api.github.com/users/smurching/orgs","repos_url":"https://api.github.com/users/smurching/repos","events_url":"https://api.github.com/users/smurching/events{/privacy}","received_events_url":"https://api.github.com/users/smurching/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-03-11T21:43:59Z","updated_at":"2022-06-02T01:41:30Z","closed_at":"2022-06-02T01:41:29Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Nope\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac\r\n- **MLflow installed from (source or binary)**: yep\r\n- **MLflow version (run ``mlflow --version``)**: 0.9.1\r\n- **Python version**: 2.7\r\n- **Exact command to reproduce**: mlflow sagemaker deploy --app-name super-model --model-path model --execution-role-arn arn:aws:iam::<account_id>:role/service-role/AmazonSageMaker-ExecutionRole --run-id d02fd1b8c16d4efa93a85a0510cd1b12 --image-url ecr.amazonaws.com/mlflow:0.9.1 --mode replace --instance-type ml.t2.xlarge --instance-count 1 --vpc-config vpc_config_us_west_1.json --async --archive **--bucket bucket_in_us_east_1 --region-name us-west-1** \r\n\r\n### Describe the problem\r\nWhen SageMaker endpoint starts it fails with an error:\r\n`Failed to download model data for container \\\\\\“container_1\\\\\\” from URL: \\\\\\“https://s3.us-west-1.amazonaws.com/bucket_in_us_east_1/d02fd1b8c16d4efa93a85a0510cd1b12/model/model.tar.gz\\\\\\“. Please ensure that there is an object located at the URL and that the role passed to CreateModel has permissions to download the object.\\“,\\“region\\“:\\“us-west-1\\“}”`\r\n\r\nSo in fact the bucket **bucket_in_us_east_1** does exist, but in different region us-east-1 whereas specified us-west-1.\r\n\r\n### Other info / logs\r\nI think the root cause of the error is that mlflow doesn't check the bucket region, but relies on url from the specified region.\r\nSo basically in order to this line of code to work:\r\nhttps://github.com/mlflow/mlflow/blob/c2f76f1aff4f12b80456c36427d8b2f55a8e5d32/mlflow/sagemaker/__init__.py#L599\r\nthe client initialisation:\r\n`sess = boto3.Session(region_name=region_name)`\r\n needs to be in the same region as bucket:\r\n```\r\ns3 = boto3.resource('s3')\r\nbucket_region = s3.get_bucket_location(Bucket=bucket)['LocationConstraint']\r\nif bucket_region:\r\n    sess = boto3.Session(region_name = bucket_region) \r\nelse:\r\n    sess = boto3.Session()\r\n```\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2573/timeline","performed_via_github_app":null,"state_reason":"completed"}