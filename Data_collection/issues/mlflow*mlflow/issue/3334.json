{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3334","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3334/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3334/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3334/events","html_url":"https://github.com/mlflow/mlflow/issues/3334","id":686220969,"node_id":"MDU6SXNzdWU2ODYyMjA5Njk=","number":3334,"title":"[BUG] http.client.RemoteDisconnected for get_metric_history","user":{"login":"mberr","id":36984984,"node_id":"MDQ6VXNlcjM2OTg0OTg0","avatar_url":"https://avatars.githubusercontent.com/u/36984984?v=4","gravatar_id":"","url":"https://api.github.com/users/mberr","html_url":"https://github.com/mberr","followers_url":"https://api.github.com/users/mberr/followers","following_url":"https://api.github.com/users/mberr/following{/other_user}","gists_url":"https://api.github.com/users/mberr/gists{/gist_id}","starred_url":"https://api.github.com/users/mberr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mberr/subscriptions","organizations_url":"https://api.github.com/users/mberr/orgs","repos_url":"https://api.github.com/users/mberr/repos","events_url":"https://api.github.com/users/mberr/events{/privacy}","received_events_url":"https://api.github.com/users/mberr/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-08-26T10:52:23Z","updated_at":"2022-03-07T01:51:27Z","closed_at":"2022-03-07T01:51:27Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: yes (cf. below)\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.04.1 LTS\r\n- **MLflow installed from (source or binary)**: binary (via pip)\r\n- **MLflow version (run ``mlflow --version``)**: mlflow, version 1.10.0\r\n- **Python version**: Python 3.8.2\r\n- **npm version, if running the dev UI**: n/a\r\n- **Exact command to reproduce**: cf. code to reproduce\r\n\r\n### Describe the problem\r\nI use Mlflow to track results throughout the training of a model.\r\n\r\nThe Mlflow server uses a Postgres backend and is started via\r\n```console\r\n$ mlflow server --backend-store-uri postgresql://mlflow_user:mlflow@localhost/mlflow_db --default-artifact-root /path/to/artifacts --host HOSTNAME\r\n```\r\non a separate machine only used for tracking results. The actual training happens on workers which log to Mlflow via `http://HOSTNAME:5000`.\r\n\r\nTo analyse the training progress, I want to use `get_metric_history` to get the values of a metric of interest throughout the training. However, the number of tracked metrics (`32k`) seems to be large enough to cause a timeout during the HTTP request. This error also occurs when running the `get_metric_history` request directly on the tracking server. \r\n\r\nIn the web frontend I can view the metrics, although it takes a long time until the page finishes loading (`~80 sec`, Mozilla Firefox 79.0).\r\n\r\nWhen I directly issue the HTTP request taken from the browser's debug tools, the result comes back quickly\r\n\r\n```console\r\n$ time curl 'http://HOSTNAME:5000/ajax-api/2.0/preview/mlflow/metrics/get-history?run_uuid=bc82535154804601a1e1dcb91e9048b5&metric_key=eval.test.hits_at_1' -o /dev/null\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100 90681  100 90681    0     0   147k      0 --:--:-- --:--:-- --:--:--  146k\r\n\r\nreal\t0m0,770s\r\nuser\t0m0,004s\r\nsys\t0m0,011s\r\n```\r\n\r\n\r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\n```python-console\r\n>>> from mlflow.tracking import MlflowClient\r\n>>> client = MlflowClient(tracking_uri='http://HOSTNAME:5000')\r\n>>> history = client.get_metric_history(run_id='bc82535154804601a1e1dcb91e9048b5', key='eval.train.hits_at_1')\r\n```\r\n\r\n<details>\r\n<summary>Full traceback</summary>\r\n\r\n```python-traceback\r\nTraceback (most recent call last):\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 670, in urlopen\r\n    httplib_response = self._make_request(\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 426, in _make_request\r\n    six.raise_from(e, None)\r\n  File \"<string>\", line 3, in raise_from\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 421, in _make_request\r\n    httplib_response = conn.getresponse()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 1332, in getresponse\r\n    response.begin()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 303, in begin\r\n    version, status, reason = self._read_status()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 272, in _read_status\r\n    raise RemoteDisconnected(\"Remote end closed connection without\"\r\nhttp.client.RemoteDisconnected: Remote end closed connection without response\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/path/to/venv/lib/python3.8/site-packages/requests/adapters.py\", line 439, in send\r\n    resp = conn.urlopen(\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 724, in urlopen\r\n    retries = retries.increment(\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/util/retry.py\", line 403, in increment\r\n    raise six.reraise(type(error), error, _stacktrace)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/packages/six.py\", line 734, in reraise\r\n    raise value.with_traceback(tb)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 670, in urlopen\r\n    httplib_response = self._make_request(\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 426, in _make_request\r\n    six.raise_from(e, None)\r\n  File \"<string>\", line 3, in raise_from\r\n  File \"/path/to/venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 421, in _make_request\r\n    httplib_response = conn.getresponse()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 1332, in getresponse\r\n    response.begin()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 303, in begin\r\n    version, status, reason = self._read_status()\r\n  File \"/usr/lib/python3.8/http/client.py\", line 272, in _read_status\r\n    raise RemoteDisconnected(\"Remote end closed connection without\"\r\nurllib3.exceptions.ProtocolError: ('Connection aborted.', RemoteDisconnected('Remote end closed connection without response'))\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/tracking/client.py\", line 110, in get_metric_history\r\n    return self._tracking_client.get_metric_history(run_id, key)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/tracking/_tracking_service/client.py\", line 60, in get_metric_history\r\n    return self.store.get_metric_history(run_id=run_id, metric_key=key)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 187, in get_metric_history\r\n    response_proto = self._call_endpoint(GetMetricHistory, req_body)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/store/tracking/rest_store.py\", line 32, in _call_endpoint\r\n    return call_endpoint(self.get_host_creds(), endpoint, method, json_body, response_proto)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 139, in call_endpoint\r\n    response = http_request(\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 76, in http_request\r\n    response = request_with_ratelimit_retries(max_rate_limit_interval,\r\n  File \"/path/to/venv/lib/python3.8/site-packages/mlflow/utils/rest_utils.py\", line 58, in request_with_ratelimit_retries\r\n    response = requests.request(**kwargs)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/requests/api.py\", line 61, in request\r\n    return session.request(method=method, url=url, **kwargs)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/requests/sessions.py\", line 530, in request\r\n    resp = self.send(prep, **send_kwargs)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/requests/sessions.py\", line 643, in send\r\n    r = adapter.send(request, **kwargs)\r\n  File \"/path/to/venv/lib/python3.8/site-packages/requests/adapters.py\", line 498, in send\r\n    raise ConnectionError(err, request=request)\r\nrequests.exceptions.ConnectionError: ('Connection aborted.', RemoteDisconnected('Remote end closed connection without response'))\r\n```\r\n\r\n</details>\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n<details>\r\n  <summary>Full list of installed packages in venv</summary>\r\n  \r\n  ```console\r\nPackage                   Version\r\n------------------------- ---------\r\nalembic                   1.4.2\r\nazure-core                1.7.0\r\nazure-storage-blob        12.3.2\r\ncertifi                   2020.6.20\r\ncffi                      1.14.0\r\nchardet                   3.0.4\r\nclick                     7.1.2\r\ncloudpickle               1.5.0\r\ncryptography              2.9.2\r\ndatabricks-cli            0.11.0\r\ndocker                    4.2.2\r\nentrypoints               0.3\r\nFlask                     1.1.2\r\ngitdb                     4.0.5\r\nGitPython                 3.1.3\r\ngorilla                   0.3.0\r\ngunicorn                  20.0.4\r\nidna                      2.10\r\nisodate                   0.6.0\r\nitsdangerous              1.1.0\r\nJinja2                    2.11.2\r\nMako                      1.1.3\r\nMarkupSafe                1.1.1\r\nmlflow                    1.10.0\r\nmsrest                    0.6.17\r\nnumpy                     1.19.0\r\noauthlib                  3.1.0\r\npandas                    1.0.5\r\npip                       20.2.2\r\npkg-resources             0.0.0\r\nprometheus-client         0.8.0\r\nprometheus-flask-exporter 0.14.1\r\nprotobuf                  3.12.2\r\npsycopg2                  2.8.5\r\npycparser                 2.20\r\npython-dateutil           2.8.1\r\npython-editor             1.0.4\r\npytz                      2020.1\r\nPyYAML                    5.3.1\r\nquerystring-parser        1.2.4\r\nrequests                  2.24.0\r\nrequests-oauthlib         1.3.0\r\nsetuptools                49.6.0\r\nsix                       1.15.0\r\nsmmap                     3.0.4\r\nSQLAlchemy                1.3.13\r\nsqlparse                  0.3.1\r\ntabulate                  0.8.7\r\nurllib3                   1.25.9\r\nwebsocket-client          0.57.0\r\nWerkzeug                  1.0.1\r\nwheel                     0.35.1\r\n```\r\n</details>\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3334/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3334/timeline","performed_via_github_app":null,"state_reason":"completed"}