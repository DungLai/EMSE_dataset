{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6608","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6608/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6608/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6608/events","html_url":"https://github.com/mlflow/mlflow/issues/6608","id":1352455388,"node_id":"I_kwDOCB5Jx85QnNTc","number":6608,"title":"[BUG] Uncaught warning: WARN FileStreamSink: Assume no metadata directory. Error while looking for metadata directory in the path: mlflowdbfs:///artifact?run_id=foo&path=/bar.","user":{"login":"philmassie","id":18571935,"node_id":"MDQ6VXNlcjE4NTcxOTM1","avatar_url":"https://avatars.githubusercontent.com/u/18571935?v=4","gravatar_id":"","url":"https://api.github.com/users/philmassie","html_url":"https://github.com/philmassie","followers_url":"https://api.github.com/users/philmassie/followers","following_url":"https://api.github.com/users/philmassie/following{/other_user}","gists_url":"https://api.github.com/users/philmassie/gists{/gist_id}","starred_url":"https://api.github.com/users/philmassie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/philmassie/subscriptions","organizations_url":"https://api.github.com/users/philmassie/orgs","repos_url":"https://api.github.com/users/philmassie/repos","events_url":"https://api.github.com/users/philmassie/events{/privacy}","received_events_url":"https://api.github.com/users/philmassie/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-08-26T16:02:33Z","updated_at":"2022-08-30T05:32:40Z","closed_at":"2022-08-30T05:32:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\n1.28.0\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Amazon Linux 2\r\n- **Python version**: 3.7.11\r\n- **yarn version, if running the dev UI**: Unknown\r\n- Spark 3.2.1\r\n\n\n### Describe the problem\n\nHello\r\nI dont know if this belongs here or in Spark, but I'll start here.\r\nThe warning doesn't show up in earlier Spark version (I had 3.0.3 handy), but in 3.2.1\r\n`mlflow.spark.log_model(model_trained, \"spark-model\")`\r\nproduces:\r\n```\r\n22/08/26 15:12:26 WARN FileStreamSink: Assume no metadata directory. Error while looking for metadata directory in the path: mlflowdbfs:///artifact?run_id=foo&path=/bar.\r\norg.apache.hadoop.fs.UnsupportedFileSystemException: No FileSystem for scheme \"mlflowdbfs\"\r\n\tat org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:3342)\r\n\tat org.apache.hadoop.fs.FileSystem.createFileSystem(FileSystem.java:3362)\r\n\tat org.apache.hadoop.fs.FileSystem.access$200(FileSystem.java:123)\r\n\tat org.apache.hadoop.fs.FileSystem$Cache.getInternal(FileSystem.java:3413)\r\n\tat org.apache.hadoop.fs.FileSystem$Cache.get(FileSystem.java:3381)\r\n\tat org.apache.hadoop.fs.FileSystem.get(FileSystem.java:486)\r\n\tat org.apache.hadoop.fs.Path.getFileSystem(Path.java:365)\r\n\tat org.apache.spark.sql.execution.streaming.FileStreamSink$.hasMetadata(FileStreamSink.scala:53)\r\n\tat org.apache.spark.sql.execution.datasources.DataSource.resolveRelation(DataSource.scala:370)\r\n\tat org.apache.spark.sql.DataFrameReader.loadV1Source(DataFrameReader.scala:274)\r\n\tat org.apache.spark.sql.DataFrameReader.$anonfun$load$3(DataFrameReader.scala:245)\r\n\tat scala.Option.getOrElse(Option.scala:189)\r\n\tat org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:245)\r\n\tat org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:188)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)\r\n\tat py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357)\r\n\tat py4j.Gateway.invoke(Gateway.java:282)\r\n\tat py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)\r\n\tat py4j.commands.CallCommand.execute(CallCommand.java:79)\r\n\tat py4j.ClientServerConnection.waitForCommands(ClientServerConnection.java:182)\r\n\tat py4j.ClientServerConnection.run(ClientServerConnection.java:106)\r\n\tat java.lang.Thread.run(Thread.java:750)\r\n```\r\n\r\nThe model does get saved to S3, and parameters are logged successfully. but the long warnings ruin the iterative model training output.\r\n\r\nApologies if this should be in Spark, or if its not actually a bug.\r\nIf someone has a workaround please let me know, I'm trying to sell my team on MLFlow at the moment.\r\n\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\nPoking around the warning originates with the following function call\r\n`_get_active_spark_session().read.load(\"mlflowdbfs:///artifact?run_id=foo&path=/bar\")` within `mlflow.spark._should_use_mlflowdbfs(root_uri)` and can be reproduced on my system in a clean Conda environment with only  PySpark 3.2.1 installed:\r\n```\r\ntry:\r\n    spark.read.load(\"mlflowdbfs:///artifact?run_id=foo&path=/bar\")\r\nexcept Exception as e:\r\n    print(\"Exception\")\r\n```\r\nPySpark 3.0.3 doesn't throw the warning. I don't understand why the exception isn't getting caught by the Python try/catch.\n\n### Stack trace\n\n22/08/26 15:12:26 WARN FileStreamSink: Assume no metadata directory. Error while looking for metadata directory in the path: mlflowdbfs:///artifact?run_id=foo&path=/bar.\r\norg.apache.hadoop.fs.UnsupportedFileSystemException: No FileSystem for scheme \"mlflowdbfs\"\r\n\tat org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:3342)\r\n\tat org.apache.hadoop.fs.FileSystem.createFileSystem(FileSystem.java:3362)\r\n\tat org.apache.hadoop.fs.FileSystem.access$200(FileSystem.java:123)\r\n\tat org.apache.hadoop.fs.FileSystem$Cache.getInternal(FileSystem.java:3413)\r\n\tat org.apache.hadoop.fs.FileSystem$Cache.get(FileSystem.java:3381)\r\n\tat org.apache.hadoop.fs.FileSystem.get(FileSystem.java:486)\r\n\tat org.apache.hadoop.fs.Path.getFileSystem(Path.java:365)\r\n\tat org.apache.spark.sql.execution.streaming.FileStreamSink$.hasMetadata(FileStreamSink.scala:53)\r\n\tat org.apache.spark.sql.execution.datasources.DataSource.resolveRelation(DataSource.scala:370)\r\n\tat org.apache.spark.sql.DataFrameReader.loadV1Source(DataFrameReader.scala:274)\r\n\tat org.apache.spark.sql.DataFrameReader.$anonfun$load$3(DataFrameReader.scala:245)\r\n\tat scala.Option.getOrElse(Option.scala:189)\r\n\tat org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:245)\r\n\tat org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:188)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)\r\n\tat py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357)\r\n\tat py4j.Gateway.invoke(Gateway.java:282)\r\n\tat py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)\r\n\tat py4j.commands.CallCommand.execute(CallCommand.java:79)\r\n\tat py4j.ClientServerConnection.waitForCommands(ClientServerConnection.java:182)\r\n\tat py4j.ClientServerConnection.run(ClientServerConnection.java:106)\r\n\tat java.lang.Thread.run(Thread.java:750)\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6608/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6608/timeline","performed_via_github_app":null,"state_reason":"completed"}