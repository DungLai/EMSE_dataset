{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4607","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4607/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4607/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4607/events","html_url":"https://github.com/mlflow/mlflow/issues/4607","id":952947820,"node_id":"MDU6SXNzdWU5NTI5NDc4MjA=","number":4607,"title":"[BUG] h2o model inference error","user":{"login":"vas610","id":64650227,"node_id":"MDQ6VXNlcjY0NjUwMjI3","avatar_url":"https://avatars.githubusercontent.com/u/64650227?v=4","gravatar_id":"","url":"https://api.github.com/users/vas610","html_url":"https://github.com/vas610","followers_url":"https://api.github.com/users/vas610/followers","following_url":"https://api.github.com/users/vas610/following{/other_user}","gists_url":"https://api.github.com/users/vas610/gists{/gist_id}","starred_url":"https://api.github.com/users/vas610/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vas610/subscriptions","organizations_url":"https://api.github.com/users/vas610/orgs","repos_url":"https://api.github.com/users/vas610/repos","events_url":"https://api.github.com/users/vas610/events{/privacy}","received_events_url":"https://api.github.com/users/vas610/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022860064,"node_id":"MDU6TGFiZWwyMDIyODYwMDY0","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/sagemaker","name":"integrations/sagemaker","color":"ffbce5","default":false,"description":"Sagemaker integrations"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-07-26T14:10:18Z","updated_at":"2022-07-04T17:23:04Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\n- **MLflow installed from (source or binary)**: source\r\n- **MLflow version (run ``mlflow --version``)**: **1.19.0**\r\n- **Python version**: **3.6**\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\n\r\nI have trained and logged a h2o model in mlflow. I'm getting **errors** when I try to use the model for predictions using `mlflow-sagemaker` functionality or plain prediction using `mlflow.pyfunc`\r\n\r\n### Code to reproduce issue\r\n\r\n   - Train Model (Used a Jupyter Notebook)\r\n   \r\n```python\r\n    # !pip install requests\r\n    # !pip install tabulate\r\n    # !pip install \"colorama>=0.3.8\"\r\n    # !pip install future\r\n    # !pip install -f http://h2o-release.s3.amazonaws.com/h2o/latest_stable_Py.html h2o\r\n    # !pip install mlflow\r\n    # !wget https://github.com/mlflow/mlflow-example/blob/master/wine-quality.csv\r\n\r\n    import h2o\r\n    import random\r\n    import mlflow\r\n    import mlflow.h2o\r\n    from h2o.estimators.random_forest import H2ORandomForestEstimator\r\n    h2o.init()\r\n    wine = h2o.import_file(path=\"winequality.csv\")\r\n    r = wine['quality'].runif()\r\n    train = wine[r  < 0.7]\r\n    test  = wine[0.3 <= r]\r\n    mlflow.set_tracking_uri('https://mlflow.xxxxxxx.cloud/')\r\n    mlflow.set_experiment(\"H2ORandomForestEstimator\")\r\n    \r\n    def train_random_forest(ntrees):\r\n        with mlflow.start_run():\r\n            rf = H2ORandomForestEstimator(ntrees=ntrees)\r\n            train_cols = [n for n in wine.col_names if n != \"quality\"]\r\n            rf.train(train_cols, \"quality\", training_frame=train, validation_frame=test)      \r\n            mlflow.log_param(\"ntrees\", ntrees)        \r\n            mlflow.log_metric(\"rmse\", rf.rmse())\r\n            mlflow.log_metric(\"r2\", rf.r2())\r\n            mlflow.log_metric(\"mae\", rf.mae())       \r\n            mlflow.h2o.log_model(rf, \"model\")        \r\n            h2o.save_model(rf)            \r\n            predict = rf.predict(test)        \r\n            print(predict.head())\r\n\r\n    for ntrees in [10, 20, 50, 100]:\r\n        train_random_forest(ntrees)\r\n```\r\n\r\n\r\n   - Build and Push SageMaker Container\r\n   \r\n```   \r\n    mlflow sagemaker build-and-push-container\r\n\r\n    mlflow sagemaker run-local --model-uri \"s3://mlflow-sagemaker/1/66f7c015fe8d4fb080940f3d31003f49/artifacts/model\"\r\n```    \r\n    \r\n\r\n   - Error when trying to invoke local endpoint\r\n\r\n```bash\r\n    curl -i -X POST -H \"Content-Type: application/json; format=pandas-split\" -d '{\"fixed acidity\":\"8.1\", \"volatile acidity\":\"0.28\", \"citric acid\":\"0.4\", \"residual sugar\": \"6.9\", \"chlorides\": \"0.05\", \"free sulfur dioxide\": \"30\", \"total sulfur dioxide\": \"97\", \"density\": \"0.9951\", \"pH\": \"3.26\", \"sulphates\": \"0.44\",  \"alcohol\":\"10.1\"}' http://127.0.0.1:5000/invocations\r\n\r\n    {\"error_code\": \"MALFORMED_REQUEST\", \"message\": \"Failed to parse input as a Pandas DataFrame. Ensure that the input is a valid JSON-formatted Pandas DataFrame with the `split` orient produced using the `pandas.DataFrame.to_json(..., orient='split')` method.\", \"stack_trace\": \"Traceback (most recent call last):\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/mlflow/pyfunc/scoring_server/__init__.py\\\", line 117, in parse_json_input\\n    return _dataframe_from_json(json_input, pandas_orient=orient, schema=schema)\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/mlflow/utils/proto_json_utils.py\\\", line 130, in _dataframe_from_json\\n    path_or_str, orient=pandas_orient, dtype=False, precise_float=precise_float\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/util/_decorators.py\\\", line 199, in wrapper\\n    return func(*args, **kwargs)\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/util/_decorators.py\\\", line 296, in wrapper\\n    return func(*args, **kwargs)\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 618, in read_json\\n    result = json_reader.read()\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 755, in read\\n    obj = self._get_object_parser(self.data)\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 777, in _get_object_parser\\n    obj = FrameParser(json, **kwargs).parse()\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 886, in parse\\n    self._parse_no_numpy()\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 1126, in _parse_no_numpy\\n    self.check_keys_split(decoded)\\n  File \\\"/miniconda/envs/custom_env/lib/python3.6/site-packages/pandas/io/json/_json.py\\\", line 876, in check_keys_split\\n    raise ValueError(f\\\"JSON data had unexpected key(s): {bad_keys}\\\")\\nValueError: JSON data had unexpected key(s): pH, free sulfur dioxide, volatile acidity, density, citric acid, chlorides, alcohol, fixed acidity, total sulfur dioxide, residual sugar, sulphates\\n\"}sh-4.2$ \r\n    \r\n```\r\n\r\n   - Also tried getting a prediction without using mlflow.pyfunc   \r\n```python   \r\n    import mlflow\r\n    logged_model = 's3://mlflow-sagemaker/1/66f7c015fe8d4fb080940f3d31003f49/artifacts/model'\r\n\r\n    # Load model as a PyFuncModel.\r\n    loaded_model = mlflow.pyfunc.load_model(logged_model)\r\n\r\n    # Predict on a Pandas DataFrame.\r\n    import pandas as pd\r\n    loaded_model.predict(pd.DataFrame(test))\r\n```\r\n```bash\r\n   Error\r\n   Job with key $03017f00000132d4ffffffff$_990da74b0db027b33cc49d1d90934149 failed with an exception: java.lang.IllegalArgumentException: Test/Validation dataset has no columns in common with the training set  \r\n```\r\n\r\n   - Works fine when I load the model directly using h2o for prediction\r\n   \r\n```python   \r\n\r\n   model = h2o.load_model('DRF_model_python_1626812026003_6') \r\n\r\n   model.predict(test)\r\n   \r\n```\r\n```html\r\n   predict\r\n   --\r\n   5.82059\r\n   5.5\r\n   5.5\r\n   6\r\n   5.82059\r\n   5.9\r\n   5.88\r\n   5.1\r\n   5.3\r\n   5.3\r\n```\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [x] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [ ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [x] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4607/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4607/timeline","performed_via_github_app":null,"state_reason":null}