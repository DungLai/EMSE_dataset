{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865/events","html_url":"https://github.com/mlflow/mlflow/issues/1865","id":496304324,"node_id":"MDU6SXNzdWU0OTYzMDQzMjQ=","number":1865,"title":"[BUG] _search_runs takes a lot of memory","user":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2019-09-20T11:41:04Z","updated_at":"2019-10-09T20:18:53Z","closed_at":"2019-10-09T20:18:53Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\nfor information on what types of issues we address. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\nPlease fill in this template and do not delete it unless you are sure your issue is outside its scope.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: CentOS 7\r\n- **MLflow installed from (source or binary)**: Source master branch\r\n- **MLflow version (run ``mlflow --version``)**: 1.2.1.dev0\r\n- **Python version**: 3.6\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nI tried the tracking server with the latest changes including the latest_metrics table, and I noticed that when trying to list runs for my experiments, the server was OOM killed, and it didn't happen before. \r\n\r\nI took a look in the code and I saw that in _search_runs we now we perform one big query joining the runs, parameters, tags and latest_metrics table. The result of this query is really huge since for each run it will return number of tags * number of metrics * number of parameters lines. \r\nSince we have runs with an average of ~55 tags, 20 parameters and 15 metrics, we have 16500 lines by run. Our biggest experiment has more than 1000 runs, and it causes out of memory errors, and if it did succeed I am not sure it would be faster than before.\r\n\r\nA solution could be to paginate the runs directly in SQL using LIMIT and OFFSET instead of doing it at the end of the _search_runs function, so the server wouldn't have to get so many rows. It would mitigate the out of memory error, but I am still not sure that it would be faster than before since the query returns a huge number of lines.\r\n\r\nFor information, my server has 6GB of RAM.\r\n\r\n### Code to reproduce issue\r\nCreate an experiment with runs that have a high cardinality of parameters, tags and metrics, and try to call _search_runs on this experiment.\r\nIf you want I can add a test with such an experiment.\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks,\r\nplease include the full traceback. Large logs and files should be attached.\r\n","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1865/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865/timeline","performed_via_github_app":null,"state_reason":"completed"}