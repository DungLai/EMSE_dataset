{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3729","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3729/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3729/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3729/events","html_url":"https://github.com/mlflow/mlflow/issues/3729","id":749214272,"node_id":"MDU6SXNzdWU3NDkyMTQyNzI=","number":3729,"title":"[BUG] Tracker metrics don't log when Ray Tune is enabled","user":{"login":"dukeeagle","id":10426513,"node_id":"MDQ6VXNlcjEwNDI2NTEz","avatar_url":"https://avatars.githubusercontent.com/u/10426513?v=4","gravatar_id":"","url":"https://api.github.com/users/dukeeagle","html_url":"https://github.com/dukeeagle","followers_url":"https://api.github.com/users/dukeeagle/followers","following_url":"https://api.github.com/users/dukeeagle/following{/other_user}","gists_url":"https://api.github.com/users/dukeeagle/gists{/gist_id}","starred_url":"https://api.github.com/users/dukeeagle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dukeeagle/subscriptions","organizations_url":"https://api.github.com/users/dukeeagle/orgs","repos_url":"https://api.github.com/users/dukeeagle/repos","events_url":"https://api.github.com/users/dukeeagle/events{/privacy}","received_events_url":"https://api.github.com/users/dukeeagle/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-11-24T00:00:29Z","updated_at":"2020-11-30T17:26:30Z","closed_at":"2020-11-30T17:26:30Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 18.04.5 LTS\r\n- **MLflow installed from (source or binary)**: source\r\n- **MLflow version (run ``mlflow --version``)**: 1.12.1\r\n- **Python version**: 3.7\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nI am successfully running experiments and reporting metrics to my remote tracking server on my custom Ray model. However, metrics fail to report when I run this same model with Ray **Tune**. \r\n\r\nI'm attempting to log my results dictionary at the end of each epoch through the following function call:\r\n```python\r\ndef mlflow_log(data,  epoch=None):\r\n\tfor k in data.keys():\r\n\t\tmlflow.log_metric(k, float(data[k]), epoch)\r\n```\r\nThe above method call works when my model runs **without** Tune, but not with Tune.\r\n\r\nCode for calling model **without** Tune:\r\n ```python\r\n\r\n    config, client = setup_mlflow(project='3dreconstruction', config=config, experiment_name=args.experiment_name, run_name=args.run_name)\r\n\r\n\ttrainer = CustomRayTrainable(config)\r\n\ttrainer._setup(config)\r\n\r\n\tfor _ in range(config[\"train_epochs\"]):\r\n\t\ttrainer._train() # mlflow_log() is called at the end of this function\r\n\t\ttrainer._save(DESTINATION)\r\n\r\n```\r\nCalling model **with** Tune:\r\n ```python\r\n    config, client = setup_mlflow(project='3dreconstruction', config=config, experiment_name=args.experiment_name, run_name=args.run_name)\r\n    analysis = tune.run(\r\n\t\tCustomRayTrainable,\r\n\t\tname=args.experiment_name,\r\n\t\tupload_dir='s3://[url]/'+args.user+'/' if args.use_s3 else None,\r\n\t\tcheckpoint_at_end=True,\r\n\t\tnum_samples = args.num_samples,\r\n\t\tstop={\"training_iteration\": config[\"train_epochs\"]},\r\n\t\tscheduler = ASHAScheduler(metric=\"mean_accuracy\", mode=\"max\", grace_period=1),\r\n\t\tconfig = config,\r\n\t\tloggers=DEFAULT_LOGGERS,\r\n\t\tresources_per_trial = {\"gpu\": args.ngpus, \"cpu\": args.ncpus},\r\n\t\tcheckpoint_freq=args.ckpt_freq,\r\n\t\tmax_failures=-1,\r\n\t)\r\n\r\n```\r\n\r\nWhen I look to my remote server, I see that metrics are not logged in the case where **Tune** is enabled. I tried making sure that every value logged is a float, but that didn't solve it. This is failing silently, so there's no way for me to determine whether this is an issue with MLFlow or with my own system. I'm happy to share more code if necessary.\r\n\r\n### Tracking server view\r\n![image](https://user-images.githubusercontent.com/10426513/100028928-a249ad00-2db5-11eb-8091-6f18eb7503f5.png)\r\nThe most recent runs are called **with** Tune, resulting in no logged metrics. Previous runs are without Tune.\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging","closed_by":{"login":"dmatrix","id":1117597,"node_id":"MDQ6VXNlcjExMTc1OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1117597?v=4","gravatar_id":"","url":"https://api.github.com/users/dmatrix","html_url":"https://github.com/dmatrix","followers_url":"https://api.github.com/users/dmatrix/followers","following_url":"https://api.github.com/users/dmatrix/following{/other_user}","gists_url":"https://api.github.com/users/dmatrix/gists{/gist_id}","starred_url":"https://api.github.com/users/dmatrix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dmatrix/subscriptions","organizations_url":"https://api.github.com/users/dmatrix/orgs","repos_url":"https://api.github.com/users/dmatrix/repos","events_url":"https://api.github.com/users/dmatrix/events{/privacy}","received_events_url":"https://api.github.com/users/dmatrix/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3729/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3729/timeline","performed_via_github_app":null,"state_reason":"completed"}