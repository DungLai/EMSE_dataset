{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1750","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1750/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1750/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1750/events","html_url":"https://github.com/mlflow/mlflow/issues/1750","id":481703960,"node_id":"MDU6SXNzdWU0ODE3MDM5NjA=","number":1750,"title":"[BUG] Deploying spark model to azureml","user":{"login":"Ben-Epstein","id":22605641,"node_id":"MDQ6VXNlcjIyNjA1NjQx","avatar_url":"https://avatars.githubusercontent.com/u/22605641?v=4","gravatar_id":"","url":"https://api.github.com/users/Ben-Epstein","html_url":"https://github.com/Ben-Epstein","followers_url":"https://api.github.com/users/Ben-Epstein/followers","following_url":"https://api.github.com/users/Ben-Epstein/following{/other_user}","gists_url":"https://api.github.com/users/Ben-Epstein/gists{/gist_id}","starred_url":"https://api.github.com/users/Ben-Epstein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ben-Epstein/subscriptions","organizations_url":"https://api.github.com/users/Ben-Epstein/orgs","repos_url":"https://api.github.com/users/Ben-Epstein/repos","events_url":"https://api.github.com/users/Ben-Epstein/events{/privacy}","received_events_url":"https://api.github.com/users/Ben-Epstein/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-08-16T17:13:12Z","updated_at":"2019-09-21T04:24:17Z","closed_at":"2019-09-21T04:24:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Please do not delete this template unless you are sure your issue is outside its scope.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux centos 7\r\n- **MLflow installed from (source or binary)**: source\r\n- **MLflow version (run ``mlflow --version``)**: 1.1.0\r\n- **Python version**: 3.7.0\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: full function listed above\r\n\r\n### Describe the problem\r\nWhen trying to deploy our pyspark model to azureml, we (myself and @abaveja313) encounter a bug where the JRE is not being installed and therefore not able to deploy the spark model.\r\n\r\n\r\n\r\n### Code to reproduce issue\r\nCode:\r\n```\r\nfrom azureml.core import Workspace\r\nfrom azureml.core.webservice import AciWebservice, Webservice\r\nfrom mlflow.azureml import build_image\r\nfrom os import environ\r\nworkspace_name = \"amrittest\"\r\nsubscription_id = os.environ['SUBSCRIPTION_ID']\r\nresource_group = \"amrittest\"\r\nlocation = \"East US\"\r\nazure_workspace = Workspace.create(name=workspace_name,\r\n                                  subscription_id=subscription_id,\r\n                                  resource_group=resource_group,\r\n                                  location=location,\r\n                                  create_resource_group=True,\r\n                                  exist_ok=True)\r\nazure_image, azure_model = build_image(model_uri=\"/tmp/model2\",\r\n                                                     workspace=azure_workspace,\r\n                                                     description=\"Wine regression model 1\",\r\n                                                     synchronous=True)\r\nprint(\"Access the following URI for build logs: {}\".format(azure_image.image_build_log_uri))\r\n# Deploy the container image to ACI\r\nwebservice_deployment_config = AciWebservice.deploy_configuration()\r\nwebservice = Webservice.deploy_from_image(\r\n                   image=azure_image, workspace=azure_workspace, name=\"amrittesttt\")\r\nwebservice.wait_for_deployment()\r\n```\r\n\r\n### Other info / logs\r\nError on azureml container instance logs (where JAVA_HOME is not being set):\r\n```\r\n2019-08-16T16:43:37,939683552+00:00 - iot-server/run \r\n2019-08-16T16:43:37,940440658+00:00 - gunicorn/run \r\n2019-08-16T16:43:37,941200563+00:00 - rsyslog/run \r\n2019-08-16T16:43:38,137124526+00:00 - nginx/run \r\nEdgeHubConnectionString and IOTEDGE_IOTHUBHOSTNAME are not set. Exiting...\r\n2019-08-16T16:43:40,241560271+00:00 - iot-server/finish 1 0\r\n2019-08-16T16:43:40,245790300+00:00 - Exit code 1 is normal. Not restarting iot-server.\r\nStarting gunicorn 19.6.0\r\nListening at: http://127.0.0.1:31311 (11)\r\nUsing worker: sync\r\nworker timeout is set to 300\r\nBooting worker with pid: 43\r\nInitializing logger\r\nStarting up app insights client\r\nStarting up request id generator\r\nStarting up app insight hooks\r\nInvoking user's init function\r\n2019-08-16 16:44:36,744 | azureml.core.run | DEBUG | Could not load run context RunEnvironmentException:\r\n    Message: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n    InnerException None\r\n    ErrorResponse {\"error\": {\"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"}}, switching offline: False\r\n2019-08-16 16:44:36,744 | azureml.core.run | DEBUG | Could not load the run context and allow_offline set to False\r\n2019-08-16 16:44:36,744 | azureml.core.model | DEBUG | RunEnvironmentException: RunEnvironmentException:\r\n    Message: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n    InnerException RunEnvironmentException:\r\n    Message: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n    InnerException None\r\n    ErrorResponse {\"error\": {\"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"}}\r\n    ErrorResponse {\"error\": {\"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"}}\r\n2019-08-16 16:44:36,745 | azureml.core.model | DEBUG | Using passed in version 1\r\n2019-08-16 16:44:36,745 | azureml.core.model | DEBUG | Found model path at azureml-models/mlflow-y4ct2veitj6uszrg9sjjfq/1/model2\r\n2019/08/16 16:44:36 WARNING mlflow.pyfunc: The version of Python that the model was saved in, `Python 3.7.3`, differs from the version of Python that is currently running, `Python 3.6.8`, and may be incompatible\r\nJAVA_HOME is not set\r\nUser's init function failed\r\nEncountered Exception Traceback (most recent call last):\r\n  File \"/var/azureml-server/aml_blueprint.py\", line 162, in register\r\n    main.init()\r\n  File \"/var/azureml-app/main.py\", line 88, in init\r\n    driver_module.init()\r\n  File \"execution_script.py\", line 12, in init\r\n    model = load_pyfunc(model_path)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/mlflow/pyfunc/__init__.py\", line 314, in load_pyfunc\r\n    return importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/mlflow/spark.py\", line 383, in _load_pyfunc\r\n    .master(\"local[1]\").getOrCreate()\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/sql/session.py\", line 173, in getOrCreate\r\n    sc = SparkContext.getOrCreate(sparkConf)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/context.py\", line 367, in getOrCreate\r\n    SparkContext(conf=conf or SparkConf())\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/context.py\", line 133, in __init__\r\n    SparkContext._ensure_initialized(self, gateway=gateway, conf=conf)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/context.py\", line 316, in _ensure_initialized\r\n    SparkContext._gateway = gateway or launch_gateway(conf)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/java_gateway.py\", line 46, in launch_gateway\r\n    return _launch_gateway(conf)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/pyspark/java_gateway.py\", line 108, in _launch_gateway\r\n    raise Exception(\"Java gateway process exited before sending its port number\")\r\nException: Java gateway process exited before sending its port number\r\nWorker exiting (pid: 43)\r\nShutting down: Master\r\nReason: Worker failed to boot.\r\n2019-08-16T16:44:41,539825892+00:00 - gunicorn/finish 3 0\r\n2019-08-16T16:44:41,541275102+00:00 - Exit code 3 is not normal. Killing image.\r\n```\r\n\r\nError on our local logs:\r\n```\r\n \"message\": \"Aci Deployment failed with exception: Your container application crashed. This may be caused by errors in your scoring file's init() function.\\nPlease check the logs for your container instance: amritest. From the AML SDK, you can run print(service.get_logs()) if you have service object to fetch the logs.\r\n```\r\n\r\nOur proposed fix is to add:\r\n`apt-get update && apt-get install default-jre` \r\nto the generated docker file inside mlflow.azureml._create_docker_file()\r\n\r\nLocal testing has shown that this solves the problem. We can create a PR as well.\r\n","closed_by":{"login":"Ben-Epstein","id":22605641,"node_id":"MDQ6VXNlcjIyNjA1NjQx","avatar_url":"https://avatars.githubusercontent.com/u/22605641?v=4","gravatar_id":"","url":"https://api.github.com/users/Ben-Epstein","html_url":"https://github.com/Ben-Epstein","followers_url":"https://api.github.com/users/Ben-Epstein/followers","following_url":"https://api.github.com/users/Ben-Epstein/following{/other_user}","gists_url":"https://api.github.com/users/Ben-Epstein/gists{/gist_id}","starred_url":"https://api.github.com/users/Ben-Epstein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ben-Epstein/subscriptions","organizations_url":"https://api.github.com/users/Ben-Epstein/orgs","repos_url":"https://api.github.com/users/Ben-Epstein/repos","events_url":"https://api.github.com/users/Ben-Epstein/events{/privacy}","received_events_url":"https://api.github.com/users/Ben-Epstein/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1750/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1750/timeline","performed_via_github_app":null,"state_reason":"completed"}