{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6307","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6307/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6307/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6307/events","html_url":"https://github.com/mlflow/mlflow/issues/6307","id":1315479609,"node_id":"I_kwDOCB5Jx85OaKA5","number":6307,"title":"[BUG] Cannot Deploy MLeap flavor of spark model in Sagemaker","user":{"login":"EPond89","id":10733830,"node_id":"MDQ6VXNlcjEwNzMzODMw","avatar_url":"https://avatars.githubusercontent.com/u/10733830?v=4","gravatar_id":"","url":"https://api.github.com/users/EPond89","html_url":"https://github.com/EPond89","followers_url":"https://api.github.com/users/EPond89/followers","following_url":"https://api.github.com/users/EPond89/following{/other_user}","gists_url":"https://api.github.com/users/EPond89/gists{/gist_id}","starred_url":"https://api.github.com/users/EPond89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EPond89/subscriptions","organizations_url":"https://api.github.com/users/EPond89/orgs","repos_url":"https://api.github.com/users/EPond89/repos","events_url":"https://api.github.com/users/EPond89/events{/privacy}","received_events_url":"https://api.github.com/users/EPond89/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2022860064,"node_id":"MDU6TGFiZWwyMDIyODYwMDY0","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/sagemaker","name":"integrations/sagemaker","color":"ffbce5","default":false,"description":"Sagemaker integrations"},{"id":4300304016,"node_id":"LA_kwDOCB5Jx88AAAABAFFukA","url":"https://api.github.com/repos/mlflow/mlflow/labels/has-closing-pr","name":"has-closing-pr","color":"fef2c0","default":false,"description":"This issue has a closing PR"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-07-22T23:06:41Z","updated_at":"2022-07-27T18:41:31Z","closed_at":"2022-07-27T18:41:31Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n1.27.0\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 18.04 (mlflow-pyfunc:1.27.0)\r\n- **Python version**: 3.9.5\r\n\r\nNotes: \r\n- Have Tried also with mlflow-pyfunc:1.26.1 container (and client libs) and encounter the same issue, this is the first time attempting to save to MLeap format.\r\n- Container is pushed from Windows 10 machine (not sure if that matters but thought it wouldn't hurt to add)\r\n- Model is built in Databricks ML 11.1 Beta Runtime (for mlflow 1.26.1 version, Databricks ML 11.0 Runtime was used)\r\n\r\n\r\n\r\n### Describe the problem\r\nI am trying to save my spark model in mleap format and deploy my mleap model to a sagemaker endpoint.  I save and push the model over to sagemaker model registry, and subsequently another script is used to create an endpoint variant (boto3 sagemaker api) using the model that was pushed over using the mlflow.sagemaker API\r\n\r\nThe endpoint spits out some error logs from the scoring server (Java) and fails to deploy with the following message:\r\n\r\n_Exception in thread \"main\" org.mlflow.sagemaker.PredictorLoadingException: Failed to load the configuration for the MLflow model at the specified path._\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\nCreate mlflow-pyfunc:1.27.0 container:\r\n```shell\r\nmlflow build-and-push-container\r\n```\r\n\r\nIn Databricks Notebook:\r\n```python\r\nfrom pyspark.ml import Pipeline\r\n\r\n\"\"\"\r\nConstruct Model Pipeline using pyspark.ml.feature(s)\r\nTraining schema: {'text' -> String, 'label' -> Int}\r\n\"\"\"\r\n\r\nmodel = pipeline.fit(training)\r\nsample_model_input = spark.createDataFrame(training.select('text').head(10))\r\nmlflow.spark.log_model(model, 'mleap_model', sample_input=sample_model_input )\r\n```\r\n\r\nOnce the model has been registered in the Databricks tracking server (Through the Run UI), the following is ran:\r\n```python\r\nimport mlflow.sagemaker\r\n\r\nmodel_name = \"my-model\"\r\nmodel_version = 1\r\n\r\nsm_model_name = f\"{model_name}-v{model_version}\"\r\nmlflow_model_uri = f\"models:/{model_name}/{model_version}\"\r\n\r\nexec_role_arn = \"<EXEC-ROLE-ARN>\"\r\nbucket = \"<MY-S3-BUCKET>\"\r\nsm_image_url = \"<ACCOUNT-ECR>/mlflow-pyfunc:1.27.0\"\r\naws_region = \"us-east-2\"\r\n\r\nmlflow.sagemaker.push_model_to_sagemaker(sm_model_name, mlflow_model_uri, execution_role_arn=exec_role_arn,\r\n                                             bucket=bucket, image_url=sm_image_url, region_name=aws_region, flavor='mleap')\r\n```\r\n\r\nThe boto3 sagemaker client API is then used to deploy the saved mleap model\r\n\r\n### Other info / logs\r\n\r\nStack Trace from cloudwatch logs:\r\n```java-traceback\r\n2022/07/22 19:21:57 INFO mlflow.models.container: Got sigterm signal, exiting.\r\nException in thread \"main\" org.mlflow.sagemaker.PredictorLoadingException: Failed to load the configuration for the MLflow model at the specified path.\r\n  #011at org.mlflow.sagemaker.ScoringServer.loadPredictorFromPath(ScoringServer.java:79)\r\n  #011at org.mlflow.sagemaker.ScoringServer.<init>(ScoringServer.java:70)\r\n  #011at org.mlflow.sagemaker.ScoringServer.main(ScoringServer.java:258)\r\nCaused by: com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field \"databricks_runtime\" (class org.mlflow.models.Model), not marked as ignorable (9 known properties: \"utc_time_created\", \"artifact_path\", \"flavors\", \"mlflow_version\", \"rootPath\", \"signature\", \"run_id\", \"model_uuid\", \"input_example\"]) at [Source: (File); line: 2, column: 44] (through reference chain: org.mlflow.models.Model[\"databricks_runtime\"])\r\n  #011at com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException.from(UnrecognizedPropertyException.java:61)\r\n  #011at com.fasterxml.jackson.databind.DeserializationContext.handleUnknownProperty(DeserializationContext.java:840)\r\n  #011at com.fasterxml.jackson.databind.deser.std.StdDeserializer.handleUnknownProperty(StdDeserializer.java:1179)\r\n  #011at com.fasterxml.jackson.databind.deser.BeanDeserializerBase.handleUnknownProperty(BeanDeserializerBase.java:1592)\r\n  #011at com.fasterxml.jackson.databind.deser.BeanDeserializerBase.handleUnknownVanilla(BeanDeserializerBase.java:1570)\r\n  #011at com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize(BeanDeserializer.java:294)\r\n  #011at com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize(BeanDeserializer.java:151)\r\n  #011at com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4202)\r\n  #011at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3070)\r\n  #011at org.mlflow.utils.SerializationUtils.parseFromFile(SerializationUtils.java:81)\r\n  #011at org.mlflow.utils.SerializationUtils.parseYamlFromFile(SerializationUtils.java:76)\r\n  #011at org.mlflow.models.Model.fromConfigPath(Model.java:70)\r\n  #011at org.mlflow.models.Model.fromRootPath(Model.java:60)\r\n  #011at org.mlflow.sagemaker.ScoringServer.loadPredictorFromPath(ScoringServer.java:76)\r\n  #011... 2 more\r\n```\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [x] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [X] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [X] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6307/timeline","performed_via_github_app":null,"state_reason":"completed"}