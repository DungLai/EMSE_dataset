{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7385","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7385/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7385/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7385/events","html_url":"https://github.com/mlflow/mlflow/issues/7385","id":1460807393,"node_id":"I_kwDOCB5Jx85XEibh","number":7385,"title":"[BUG] cannot load synapseML LightGBM model using MLflow","user":{"login":"llzhng","id":118865419,"node_id":"U_kgDOBxW-Cw","avatar_url":"https://avatars.githubusercontent.com/u/118865419?v=4","gravatar_id":"","url":"https://api.github.com/users/llzhng","html_url":"https://github.com/llzhng","followers_url":"https://api.github.com/users/llzhng/followers","following_url":"https://api.github.com/users/llzhng/following{/other_user}","gists_url":"https://api.github.com/users/llzhng/gists{/gist_id}","starred_url":"https://api.github.com/users/llzhng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/llzhng/subscriptions","organizations_url":"https://api.github.com/users/llzhng/orgs","repos_url":"https://api.github.com/users/llzhng/repos","events_url":"https://api.github.com/users/llzhng/events{/privacy}","received_events_url":"https://api.github.com/users/llzhng/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"},{"id":2237251966,"node_id":"MDU6TGFiZWwyMjM3MjUxOTY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/language/new","name":"language/new","color":"349cd8","default":false,"description":"Proposals for new client languages"}],"state":"open","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-11-23T01:53:40Z","updated_at":"2022-12-23T00:19:45Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nNo. I cannot contribute a bug fix at this time.\n\n### MLflow version\n\n- Client: 1.18.0\r\n- Tracking server: 1.18.0\r\n\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: azure synapse workspace\r\n- **Python version**: python3.8\r\n- **yarn version, if running the dev UI**:\r\n \n\n### Describe the problem\n\nafter registering  synapseML LightGBM model using MLflow into azure ml model registry, when loading the model back using MLflow, it's throwing errors:\r\nbut for other models registered into AML and can be loaded back. they all don't have this *.crc files. \r\nplease help with that.\r\n\r\nAzureMLException: AzureMLException:\r\n\tMessage: Download of file failed with error: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\r\n\tInnerException None\r\n\tErrorResponse \r\n{\r\n    \"error\": {\r\n        \"code\": \"UserError\",\r\n        \"message\": \"Download of file failed with error: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\",\r\n        \"inner_error\": {\r\n            \"code\": \"ConnectionFailure\"\r\n        }\r\n    }\r\n}\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\n#!/usr/bin/env python\r\n# coding: utf-8\r\n\r\n# ## MLflow_github\r\n# \r\n# \r\n# \r\n\r\n# In[54]:\r\n\r\n\r\nimport sparklemlutils\r\nsparklemlutils.artifacts.init(spark)\r\n\r\n\r\n# In[4]:\r\n\r\n\r\nget_ipython().run_cell_magic('configure', '-f', '\\r\\n{\\r\\n\\r\\n  \"name\": \"synapseml\",\\r\\n\\r\\n  \"conf\": {\\r\\n\\r\\n      \"spark.jars.packages\": \"com.microsoft.azure:synapseml_2.12:0.10.0-36-7e90d190-SNAPSHOT\",\\r\\n\\r\\n      \"spark.jars.repositories\": \"https://mmlspark.azureedge.net/maven\",\\r\\n\\r\\n      \"spark.jars.excludes\": \"org.scala-lang:scala-reflect,org.apache.spark:spark-tags_2.12,org.scalactic:scalactic_2.12,org.scalatest:scalatest_2.12,com.fasterxml.jackson.core:jackson-databind\",\\r\\n\\r\\n      \"spark.yarn.user.classpath.first\": \"true\"\\r\\n\\r\\n  }\\r\\n\\r\\n}\\n')\r\n\r\n\r\n# In[1]:\r\n\r\n\r\nfrom synapse.ml.lightgbm import LightGBMClassificationModel\r\nimport mlflow\r\n# from mlflow import spark\r\n\r\n\r\n# In[3]:\r\n\r\n\r\nmlflow.__version__\r\n\r\n\r\n# In[2]:\r\n\r\n\r\nadl_out = 'spklswasamlplayground'\r\ncontainer = 'analytics'\r\ntable_path = f'abfss://{container}@{adl_out}.dfs.core.windows.net/dependencies/driveFP.model'\r\n\r\n\r\n# In[3]:\r\n\r\n\r\nlgbmModel = LightGBMClassificationModel.loadNativeModelFromFile(table_path)\r\n\r\n\r\n# In[59]:\r\n\r\n\r\nazureml_mlflow_uri = 'azureml://eastus.api.azureml.ms/mlflow/v1.0/subscriptions/39915866-d034-4c80-b4e7-4e617cb94722/resourceGroups/spklamldeveusx0/providers/Microsoft.MachineLearningServices/workspaces/spklamldeveusx0'\r\nmlflow.set_tracking_uri(azureml_mlflow_uri)\r\nmlflow.set_registry_uri(azureml_mlflow_uri)\r\n# mlflow.end_run()\r\n\r\n\r\n# In[60]:\r\n\r\n\r\n# from pyspark.ml.pipeline.PipelineModel\r\nmodel_name = 'DriveFP_SynapseML'\r\n# your pyspark.ml.pipeline.PipelineModel type\r\n# mlflow.spark.save_model(lgbmModel, path)\r\nmlflow.spark.log_model(lgbmModel,artifact_path = model_name, registered_model_name  = model_name )\r\n\r\n\r\n# In[62]:\r\n\r\n\r\ngbm_model = mlflow.spark.load_model(path)\r\n\r\n\n\n### Stack trace\n\n2022/10/21 22:13:06 INFO mlflow.spark: 'models:/DriveFP_SynapseML/4' resolved as 'azureml://experiments/Default/runs/97748d37-0e7e-47f2-9ee4-387896c73d00/artifacts/DriveFP_SynapseML'\r\n2022/10/21 22:13:07 INFO mlflow.spark: File 'azureml://experiments/Default/runs/97748d37-0e7e-47f2-9ee4-387896c73d00/artifacts/DriveFP_SynapseML/sparkml' not found on DFS. Will attempt to upload the file.\r\nFailed to download file with error: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\r\n---------------------------------------------------------------------------\r\nNotADirectoryError                        Traceback (most recent call last)\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_file_utils/file_utils.py in _retry(exec_func, clean_up_func, max_retries, exceptions)\r\n    436         try:\r\n--> 437             return exec_func()\r\n    438         except exceptions as request_exception:\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_file_utils/file_utils.py in exec_func()\r\n    210         def exec_func():\r\n--> 211             metadata_dict = blob_service.get_blob_to_path(container_name=container_name,\r\n    212                                                           blob_name=blob_name,\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_vendor/azure_storage/blob/baseblobservice.py in get_blob_to_path(self, container_name, blob_name, file_path, open_mode, snapshot, start_range, end_range, validate_content, progress_callback, max_connections, lease_id, if_modified_since, if_unmodified_since, if_match, if_none_match, timeout)\r\n   1855 \r\n-> 1856         with open(file_path, open_mode) as stream:\r\n   1857             blob = self.get_blob_to_stream(\r\n\r\nNotADirectoryError: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nAzureMLException                          Traceback (most recent call last)\r\n<ipython-input-9-42ffd3af> in <module>\r\n----> 1 gbm_model = mlflow.spark.load_model(path)\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/spark.py in load_model(model_uri, dfs_tmpdir)\r\n    623     flavor_conf = _get_flavor_configuration_from_uri(model_uri, FLAVOR_NAME)\r\n    624     model_uri = append_to_uri_path(model_uri, flavor_conf[\"model_data\"])\r\n--> 625     return _load_model(model_uri=model_uri, dfs_tmpdir_base=dfs_tmpdir)\r\n    626 \r\n    627 \r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/spark.py in _load_model(model_uri, dfs_tmpdir_base)\r\n    574     if databricks_utils.is_in_cluster() and databricks_utils.is_dbfs_fuse_available():\r\n    575         return _load_model_databricks(model_uri, dfs_tmpdir)\r\n--> 576     model_uri = _HadoopFileSystem.maybe_copy_from_uri(model_uri, dfs_tmpdir)\r\n    577     return PipelineModel.load(model_uri)\r\n    578 \r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/spark.py in maybe_copy_from_uri(cls, src_uri, dst_path)\r\n    348             _logger.info(\"URI '%s' does not point to the current DFS.\", src_uri)\r\n    349         _logger.info(\"File '%s' not found on DFS. Will attempt to upload the file.\", src_uri)\r\n--> 350         return cls.maybe_copy_from_local_file(_download_artifact_from_uri(src_uri), dst_path)\r\n    351 \r\n    352     @classmethod\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/tracking/artifact_utils.py in _download_artifact_from_uri(artifact_uri, output_path)\r\n     77         root_uri = prefix + urllib.parse.urlunparse(parsed_uri)\r\n     78 \r\n---> 79     return get_artifact_repository(artifact_uri=root_uri).download_artifacts(\r\n     80         artifact_path=artifact_path, dst_path=output_path\r\n     81     )\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/mlflow/_internal/artifact_repo.py in download_artifacts(self, artifact_path, dst_path)\r\n    137     def download_artifacts(self, artifact_path, dst_path=None):\r\n    138         artifact_path = self._get_full_artifact_path(artifact_path)\r\n--> 139         return super(AzureMLflowArtifactRepository, self).download_artifacts(artifact_path, dst_path=dst_path)\r\n    140 \r\n    141     def _download_file(self, remote_file_path, local_path, **kwargs):\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repo.py in download_artifacts(self, artifact_path, dst_path)\r\n    179         # Check if the artifacts points to a directory\r\n    180         if self._is_directory(artifact_path):\r\n--> 181             return download_artifact_dir(\r\n    182                 src_artifact_dir_path=artifact_path, dst_local_dir_path=dst_path\r\n    183             )\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repo.py in download_artifact_dir(src_artifact_dir_path, dst_local_dir_path)\r\n    146                 for file_info in dir_content:\r\n    147                     if file_info.is_dir:\r\n--> 148                         download_artifact_dir(\r\n    149                             src_artifact_dir_path=file_info.path,\r\n    150                             dst_local_dir_path=dst_local_dir_path,\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repo.py in download_artifact_dir(src_artifact_dir_path, dst_local_dir_path)\r\n    151                         )\r\n    152                     else:\r\n--> 153                         download_artifact(\r\n    154                             src_artifact_path=file_info.path, dst_local_dir_path=dst_local_dir_path\r\n    155                         )\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/mlflow/store/artifact/artifact_repo.py in download_artifact(src_artifact_path, dst_local_dir_path)\r\n    128                 src_artifact_path=src_artifact_path, dst_local_dir_path=dst_local_dir_path\r\n    129             )\r\n--> 130             self._download_file(\r\n    131                 remote_file_path=src_artifact_path, local_path=local_destination_file_path\r\n    132             )\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/mlflow/_internal/artifact_repo.py in _download_file(self, remote_file_path, local_path, **kwargs)\r\n    150         \"\"\"\r\n    151         # kwargs handling was added to protect against a newly introduced kwarg causing a regression\r\n--> 152         self.artifacts.download_artifact(remote_file_path, local_path)\r\n    153 \r\n    154     @staticmethod\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/mlflow/_internal/run_artifact_repository_client.py in download_artifact(self, path, output_file_path)\r\n     43         else:\r\n     44             self._logger.debug(\"output_file_path for download_artifact is not a directory.\")\r\n---> 45         self._run_artifacts_client.download_artifact(self._run_id, path, output_file_path)\r\n     46 \r\n     47     def _create_empty_artifacts(self, paths):\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_restclient/run_artifacts_client.py in download_artifact(self, run_id, path, output_file_path)\r\n     88             else:\r\n     89                 raise\r\n---> 90         download_file(uri, output_file_path)\r\n     91 \r\n     92     def get_file_paths(self, run_id):\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_file_utils/file_utils.py in download_file(source_uri, path, max_retries, stream, protocol, session, _validate_check_sum, max_concurrency)\r\n    223                 raise AzureMLException._with_error(azureml_error)\r\n    224 \r\n--> 225         return _retry(exec_func, max_retries=max_retries)\r\n    226 \r\n    227     # download using requests.Session\r\n\r\n~/cluster-env/clonedenv/lib/python3.8/site-packages/azureml/_file_utils/file_utils.py in _retry(exec_func, clean_up_func, max_retries, exceptions)\r\n    450                     DownloadFailed, error=request_exception\r\n    451                 )\r\n--> 452                 raise AzureMLException._with_error(azureml_error)\r\n    453         finally:\r\n    454             clean_up_func()\r\n\r\nAzureMLException: AzureMLException:\r\n\tMessage: Download of file failed with error: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\r\n\tInnerException None\r\n\tErrorResponse \r\n{\r\n    \"error\": {\r\n        \"code\": \"UserError\",\r\n        \"message\": \"Download of file failed with error: [Errno 20] Not a directory: '/tmp/tmpwhzw6t7c/DriveFP_SynapseML/sparkml/metadata/._SUCCESS.crc'\",\r\n        \"inner_error\": {\r\n            \"code\": \"ConnectionFailure\"\r\n        }\r\n    }\r\n}\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [X] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [X] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [X] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7385/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7385/timeline","performed_via_github_app":null,"state_reason":null}