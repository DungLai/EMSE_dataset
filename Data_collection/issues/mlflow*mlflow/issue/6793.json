{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6793","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6793/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6793/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6793/events","html_url":"https://github.com/mlflow/mlflow/issues/6793","id":1372740045,"node_id":"I_kwDOCB5Jx85R0lnN","number":6793,"title":"[BUG] mlflow.tensorflow.autolog cannot log custom object","user":{"login":"anneadb","id":46241952,"node_id":"MDQ6VXNlcjQ2MjQxOTUy","avatar_url":"https://avatars.githubusercontent.com/u/46241952?v=4","gravatar_id":"","url":"https://api.github.com/users/anneadb","html_url":"https://github.com/anneadb","followers_url":"https://api.github.com/users/anneadb/followers","following_url":"https://api.github.com/users/anneadb/following{/other_user}","gists_url":"https://api.github.com/users/anneadb/gists{/gist_id}","starred_url":"https://api.github.com/users/anneadb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anneadb/subscriptions","organizations_url":"https://api.github.com/users/anneadb/orgs","repos_url":"https://api.github.com/users/anneadb/repos","events_url":"https://api.github.com/users/anneadb/events{/privacy}","received_events_url":"https://api.github.com/users/anneadb/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-09-14T10:25:15Z","updated_at":"2022-09-28T15:14:58Z","closed_at":"2022-09-14T15:11:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nNo. I cannot contribute a bug fix at this time.\r\n\r\n### MLflow version\r\n\r\n1.28.0\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: macOS 12.6\r\n- **Python version**: 3.10\r\n- **Tensorflow version**: 2.9.1\r\n\r\n\r\n### Describe the problem\r\n\r\nI'm trying to wrap the code used in this tensorflow tutorial https://www.tensorflow.org/tutorials/keras/text_classification into mlflow.\r\n\r\nI am encountering the following issues:\r\n- Metrics are logged correctly but no artifacts are logged.\r\n- mlflow.pyfunc.load_model() is not aware of the custom objects I am using for my model.\r\n    - In keras I can register these objects like this: \r\n    ```\r\n    custom_objects = {\"custom_standardization\": custom_standardization}\r\n    model: keras.Sequential = keras.models.load_model(\r\n        os.path.join(MODEL_DIR, model_name),\r\n        custom_objects=custom_objects,\r\n    )\r\n    ```\r\n    but I do not see a similar option in the documentation for `autolog`\r\n- `autolog` appears to have no write permissions for the folder it wants to write to. This seems strange because the run folder is created and metrics are written there.\r\n\r\n### Tracking information\r\n\r\nMLflow version: 1.28.0\r\nTracking URI: file:///Users/myusername/git/category-mapping/tutorials/mlflow/mlruns\r\nArtifact URI: file://Users/myusername/git/category-mapping/tutorials/mlflow/mlruns/0/1b4fc9877e274c19ae04f7888582017a/artifacts\r\n\r\n### Code to reproduce issue\r\n\r\n```\r\nimport logging\r\nimport os\r\n\r\nimport mlflow\r\n\r\nfrom tutorials.tf_basic_text_classification.tutorial import (\r\n    create_model,\r\n    create_vectorizer,\r\n    custom_standardization,\r\n    load_dataset,\r\n    train_and_save_model,\r\n)\r\n\r\nlogging.getLogger(\"mlflow\").setLevel(logging.DEBUG)\r\n\r\nSCRIPT_DIR = os.path.dirname(__file__)\r\nmlflow.set_tracking_uri(f\"file://{SCRIPT_DIR}/mlruns\")\r\nmlflow.set_experiment(\"tutorial\")\r\n\r\nITERATION = 1\r\nMODEL_NAME = f\"model_{ITERATION}\"\r\nRUN_NAME = f\"run_{ITERATION}\"\r\n\r\nmlflow.tensorflow.autolog(registered_model_name=MODEL_NAME)\r\n\r\nif __name__ == \"__main__\":\r\n\r\n    mlflow.start_run(run_name=RUN_NAME)\r\n\r\n    raw_train_ds, raw_val_ds, raw_test_ds = load_dataset()\r\n    vectorizer = create_vectorizer(raw_train_ds)\r\n    model = create_model(vectorizer)\r\n    history = train_and_save_model(MODEL_NAME, model, raw_train_ds, raw_val_ds)\r\n\r\n    mlflow.end_run()\r\n```\r\n\r\n### Stack trace\r\n\r\n```\r\n2022/09/14 12:00:48 DEBUG mlflow.utils.autologging_utils: Called autolog() method for tensorflow autologging with args '()' and kwargs '{'every_n_iter': 1, 'log_models': True, 'disable': False, 'exclusive': False, 'disable_for_unsupported_versions': False, 'silent': False, 'registered_model_name': 'model_1', 'log_input_examples': False, 'log_model_signatures': False}'\r\nFound 25000 files belonging to 2 classes.\r\nUsing 20000 files for training.\r\n2022-09-14 12:00:50.512149: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA\r\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\r\nFound 25000 files belonging to 2 classes.\r\nUsing 5000 files for validation.\r\nFound 25000 files belonging to 2 classes.\r\nLabel 0 corresponds to neg\r\nLabel 1 corresponds to pos\r\nVocabulary sample: ['', '[UNK]', 'the', 'and', 'a', 'of', 'to', 'is', 'in', 'it', 'i', 'this', 'that', 'was', 'as', 'for', 'with', 'movie', 'but', 'film']\r\nModel: \"sequential\"\r\n_________________________________________________________________\r\n Layer (type)                Output Shape              Param #   \r\n=================================================================\r\n text_vectorization (TextVec  (None, 250)              0         \r\n torization)                                                     \r\n                                                                 \r\n embedding (Embedding)       (None, 250, 16)           160016    \r\n                                                                 \r\n dropout (Dropout)           (None, 250, 16)           0         \r\n                                                                 \r\n global_average_pooling1d (G  (None, 16)               0         \r\n lobalAveragePooling1D)                                          \r\n                                                                 \r\n dropout_1 (Dropout)         (None, 16)                0         \r\n                                                                 \r\n dense (Dense)               (None, 1)                 17        \r\n                                                                 \r\n=================================================================\r\nTotal params: 160,033\r\nTrainable params: 160,033\r\nNon-trainable params: 0\r\n_________________________________________________________________\r\nNone\r\n2022/09/14 12:00:56 DEBUG mlflow.utils.autologging_utils: Invoked patched API '<class 'keras.engine.training.Model'>.fit' for tensorflow autologging with args '(<keras.engine.sequential.Sequential object at 0x123fccf40>, <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>)' and kwargs '{'validation_data': <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>, 'epochs': 2, 'callbacks': [<keras.callbacks.ModelCheckpoint object at 0x123fcfb50>]}'\r\n2022/09/14 12:00:56 DEBUG mlflow.utils.autologging_utils: Original function invoked during execution of patched API '<class 'keras.engine.training.Model'>.fit' for tensorflow autologging. Original function was invoked with args '(<keras.engine.sequential.Sequential object at 0x123fccf40>, <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>)' and kwargs '{'validation_data': <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>, 'epochs': 2, 'callbacks': [<keras.callbacks.ModelCheckpoint object at 0x123fcfb50>, <mlflow.tensorflow._autolog._TensorBoard object at 0x123b32a70>, <mlflow.tensorflow._autolog.__MLflowTfKeras2Callback object at 0x123b33190>]}'\r\n2022/09/14 12:00:56 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during autologging: [Errno 30] Read-only file system: '/myusername'\r\nEpoch 1/2\r\n621/625 [============================>.] - ETA: 0s - loss: 0.6653 - binary_accuracy: 0.6931  \r\nEpoch 1: saving model to /Users/myusername/git/category-mapping/tutorials/tf_basic_text_classification/model/training_cp/cp.ckpt\r\n625/625 [==============================] - 5s 7ms/step - loss: 0.6651 - binary_accuracy: 0.6938 - val_loss: 0.6166 - val_binary_accuracy: 0.7712\r\nEpoch 2/2\r\n621/625 [============================>.] - ETA: 0s - loss: 0.5503 - binary_accuracy: 0.7985  \r\nEpoch 2: saving model to /Users/myusername/git/category-mapping/tutorials/tf_basic_text_classification/model/training_cp/cp.ckpt\r\n625/625 [==============================] - 4s 7ms/step - loss: 0.5500 - binary_accuracy: 0.7986 - val_loss: 0.4994 - val_binary_accuracy: 0.8216\r\n2022/09/14 12:01:06 DEBUG mlflow.utils.autologging_utils: Original function invocation completed successfully during execution of patched API call '<class 'keras.engine.training.Model'>.fit' for tensorflow autologging. Original function was invoked with with args '(<keras.engine.sequential.Sequential object at 0x123fccf40>, <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>)' and kwargs '{'validation_data': <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>, 'epochs': 2, 'callbacks': [<keras.callbacks.ModelCheckpoint object at 0x123fcfb50>, <mlflow.tensorflow._autolog._TensorBoard object at 0x123b32a70>, <mlflow.tensorflow._autolog.__MLflowTfKeras2Callback object at 0x123b33190>]}'\r\n2022/09/14 12:01:15 WARNING mlflow.utils.environment: Encountered an unexpected error while inferring pip requirements (model URI: /var/folders/3y/2phvw3b15d1c6h9p0723h_n00000gp/T/tmp5n91wuqv/model, flavor: keras), fall back to return ['tensorflow==2.9.1', 'keras==2.9.0']. Set logging level to DEBUG to see the full traceback.\r\n2022/09/14 12:01:15 DEBUG mlflow.utils.environment: \r\nTraceback (most recent call last):\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/environment.py\", line 378, in infer_pip_requirements\r\n    return _infer_requirements(model_uri, flavor)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/requirements_utils.py\", line 345, in _infer_requirements\r\n    modules = _capture_imported_modules(model_uri, flavor)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/requirements_utils.py\", line 266, in _capture_imported_modules\r\n    _run_command(\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/requirements_utils.py\", line 218, in _run_command\r\n    raise MlflowException(msg)\r\nmlflow.exceptions.MlflowException: Encountered an unexpected error while running ['/Users/myusername/git/category-mapping/.venv/bin/python', '/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/_capture_modules.py', '--model-path', '/var/folders/3y/2phvw3b15d1c6h9p0723h_n00000gp/T/tmp5n91wuqv/model', '--flavor', 'keras', '--output-file', '/var/folders/3y/2phvw3b15d1c6h9p0723h_n00000gp/T/tmp7ggbqvt3/imported_modules.txt', '--sys-path', '[\"/Users/myusername/git/category-mapping/tutorials/mlflow\", \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/git/ext/gitdb\", \"/Users/myusername/git/category-mapping\", \"/Users/myusername/.pyenv/versions/3.10.6/lib/python310.zip\", \"/Users/myusername/.pyenv/versions/3.10.6/lib/python3.10\", \"/Users/myusername/.pyenv/versions/3.10.6/lib/python3.10/lib-dynload\", \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages\", \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/gitdb/ext/smmap\"]']\r\nexit status: 1\r\nstdout: \r\nstderr: /Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/_capture_modules.py:42: DeprecationWarning: the imp module is deprecated in favour of importlib and slated for removal in Python 3.12; see the module's documentation for alternative uses\r\n  return original(name, globals, locals, fromlist, level)\r\n/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/keras/backend.py:450: UserWarning: `tf.keras.backend.set_learning_phase` is deprecated and will be removed after 2020-10-11. To update it, simply pass a True/False value to the `training` argument of the `__call__` method of your layer or model.\r\n  warnings.warn('`tf.keras.backend.set_learning_phase` is deprecated and '\r\n2022-09-14 12:01:15.058168: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA\r\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\r\nTraceback (most recent call last):\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/_capture_modules.py\", line 134, in <module>\r\n    main()\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/_capture_modules.py\", line 109, in main\r\n    mlflow.pyfunc.load_model(model_path)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/pyfunc/__init__.py\", line 756, in load_model\r\n    model_impl = importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/utils/_capture_modules.py\", line 106, in _load_pyfunc_patch\r\n    return original(*args, **kwargs)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/keras.py\", line 541, in _load_pyfunc\r\n    m = _load_model(\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/mlflow/keras.py\", line 486, in _load_model\r\n    return keras_models.load_model(model_path, custom_objects=custom_objects, **kwargs)\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/keras/utils/traceback_utils.py\", line 67, in error_handler\r\n    raise e.with_traceback(filtered_tb) from None\r\n  File \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/keras/utils/layer_utils.py\", line 92, in validate_string_arg\r\n    raise ValueError(\r\nValueError: Unkown value for `standardize` argument of layer TextVectorization. If restoring a model and `standardize` is a custom callable, please ensure the callable is registered as a custom object. See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object for details. Allowed values are: `None`, a `Callable`, or one of the following values: ('lower_and_strip_punctuation', 'lower', 'strip_punctuation'). Received: custom_standardization\r\n\r\n2022/09/14 12:01:15 WARNING mlflow.utils.autologging_utils: MLflow autologging encountered a warning: \"/Users/myusername/git/category-mapping/.venv/lib/python3.10/site-packages/_distutils_hack/__init__.py:33: UserWarning: Setuptools is replacing distutils.\"\r\n2022/09/14 12:01:15 DEBUG mlflow.utils.autologging_utils: Patched API call '<class 'keras.engine.training.Model'>.fit' for tensorflow autologging threw exception. Patched API was called with args '(<keras.engine.sequential.Sequential object at 0x123fccf40>, <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>)' and kwargs '{'validation_data': <BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.string, name=None), TensorSpec(shape=(None,), dtype=tf.int32, name=None))>, 'epochs': 2, 'callbacks': [<keras.callbacks.ModelCheckpoint object at 0x123fcfb50>]}'. Exception: [Errno 30] Read-only file system: '/myusername'\r\n2022/09/14 12:01:15 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during tensorflow autologging: [Errno 30] Read-only file system: '/myusername'\r\n```\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6793/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6793/timeline","performed_via_github_app":null,"state_reason":"completed"}