{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6450","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6450/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6450/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6450/events","html_url":"https://github.com/mlflow/mlflow/issues/6450","id":1336173526,"node_id":"I_kwDOCB5Jx85PpGPW","number":6450,"title":"[BUG] Cannot load/serve spark model with custom transformer ","user":{"login":"EPond89","id":10733830,"node_id":"MDQ6VXNlcjEwNzMzODMw","avatar_url":"https://avatars.githubusercontent.com/u/10733830?v=4","gravatar_id":"","url":"https://api.github.com/users/EPond89","html_url":"https://github.com/EPond89","followers_url":"https://api.github.com/users/EPond89/followers","following_url":"https://api.github.com/users/EPond89/following{/other_user}","gists_url":"https://api.github.com/users/EPond89/gists{/gist_id}","starred_url":"https://api.github.com/users/EPond89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EPond89/subscriptions","organizations_url":"https://api.github.com/users/EPond89/orgs","repos_url":"https://api.github.com/users/EPond89/repos","events_url":"https://api.github.com/users/EPond89/events{/privacy}","received_events_url":"https://api.github.com/users/EPond89/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":4300304016,"node_id":"LA_kwDOCB5Jx88AAAABAFFukA","url":"https://api.github.com/repos/mlflow/mlflow/labels/has-closing-pr","name":"has-closing-pr","color":"fef2c0","default":false,"description":"This issue has a closing PR"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-08-11T16:02:27Z","updated_at":"2022-10-04T04:15:01Z","closed_at":"2022-10-04T04:15:01Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### MLflow version\r\n\r\n1.27.0 (also in 1.26.1)\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 20.04.4 LTS ([Databricks 11.1 ML Runtime](https://docs.databricks.com/release-notes/runtime/11.1ml.html))\r\n- **Python version**: 3.9.5\r\n\r\n\r\n\r\n### Describe the problem\r\n\r\nI have a custom transformer class (SQLTokenizer) written in spark and run into issues when trying to load/serve when this transformer is part of the spark model pipeline.  I believe I should be using the `code_paths` parameter in `mlflow.spark.log_model()` or `mlflow.spark.save_model()` to save custom transformer code with the model (https://www.mlflow.org/docs/1.27.0/python_api/mlflow.spark.html#mlflow.spark.log_model).  I should note that the documentation lists this as a parameter but there is no definition on the API page as to what this parameter is.\r\n\r\nWhen passing in the `code_paths` parameter, I am able to see my custom code packaged inside of a 'code' directory inside of the model artifact directory (artifact structure shown below).  \r\n\r\nSubsequently, when I open a new notebook and try to load the model, I get the following error message:\r\n\"FileNotFoundError: [Errno 2] No such file or directory: '/tmp/tmp7shd760i/sparkml/code'\"\r\n\r\nSideNote: Is there a Databricks Runtime + mlflow version that this capability is known to work?\r\n\r\n### Tracking information\r\n\r\n_No response_\r\n\r\n### Code to reproduce issue\r\n\r\nMinimal code to have a single transformer in spark pipeline that can also be served\r\n```python\r\nfrom pyspark.ml import Pipeline\r\nimport mlflow\r\n\r\n# Define SQLTokenizer Class inline, omitted for space but can be added if needed\r\n\r\nsql_tokenizer = SQLTokenizer(inputCol=\"merged_query\", outputCol=\"prediction\")\r\nsql_pipeline = Pipeline(stages=[sql_tokenizer])\r\nsql_model = sql_pipeline.fit(data)\r\nmlflow.spark.log_model(sql_model, 'sql_model', code_paths=['/dbfs/path/to/sql_tokenizer.py'])\r\n```\r\n\r\nSaved model structure from `mlflow.spark.log_model()`\r\n```sh\r\n|-sql_model\r\n    |-code\r\n        |-sql_tokenizer.py\r\n    |-sparkml\r\n        |-metadata\r\n            |-SUCCESS\r\n            |-part-00000\r\n        |-stages\r\n            |-0_SQLTokenizer_182199978fae\r\n                |-metadata\r\n                    |-SUCCESS\r\n                    |-part-00000\r\n    |-MLmodel\r\n    |-conda.yaml\r\n    |-python_env.yaml\r\n    |-requirements.txt\r\n```\r\n\r\nSubsequently try to load the model from other notebook\r\n```python\r\nimport mlflow\r\n\r\nmodel_path = 'runs:/6921219571d64a4dab2c0160dbca63db/sql_model'\r\ncustom_layer = mlflow.spark.load_model(model_path)\r\n```\r\n\r\n### Stack trace\r\n\r\n```python\r\n---------------------------------------------------------------------------\r\nFileNotFoundError                         Traceback (most recent call last)\r\n<command-3019178> in <cell line: 5>()\r\n      3 \r\n      4 model_path = 'runs:/6921219571d64a4dab2c0160dbca63db/sql_model'\r\n----> 5 custom_layer = mlflow.spark.load_model(model_path)\r\n      6 \r\n      7 display(custom_layer.transform(merged_data))\r\n\r\n/databricks/python/lib/python3.9/site-packages/mlflow/spark.py in load_model(model_uri, dfs_tmpdir)\r\n    707     model_uri = append_to_uri_path(model_uri, flavor_conf[\"model_data\"])\r\n    708     local_model_path = _download_artifact_from_uri(model_uri)\r\n--> 709     _add_code_from_conf_to_system_path(local_model_path, flavor_conf)\r\n    710 \r\n    711     return _load_model(model_uri=model_uri, dfs_tmpdir_base=dfs_tmpdir)\r\n\r\n/databricks/python/lib/python3.9/site-packages/mlflow/utils/model_utils.py in _add_code_from_conf_to_system_path(local_path, conf, code_key)\r\n    153     if code_key in conf and conf[code_key]:\r\n    154         code_path = os.path.join(local_path, conf[code_key])\r\n--> 155         _add_code_to_system_path(code_path)\r\n\r\n/databricks/python/lib/python3.9/site-packages/mlflow/utils/model_utils.py in _add_code_to_system_path(code_path)\r\n    119 \r\n    120 def _add_code_to_system_path(code_path):\r\n--> 121     sys.path = [code_path] + _get_code_dirs(code_path) + sys.path\r\n    122     # Delete cached modules so they will get reloaded anew from the correct code path\r\n    123     # Otherwise python will use the cached modules\r\n\r\n/databricks/python/lib/python3.9/site-packages/mlflow/utils/model_utils.py in _get_code_dirs(src_code_path, dst_code_path)\r\n     87     return [\r\n     88         (os.path.join(dst_code_path, x))\r\n---> 89         for x in os.listdir(src_code_path)\r\n     90         if os.path.isdir(os.path.join(src_code_path, x)) and not x == \"__pycache__\"\r\n     91     ]\r\n\r\nFileNotFoundError: [Errno 2] No such file or directory: '/tmp/tmp7shd760i/sparkml/code'\r\n```\r\n\r\nInspection of /tmp/tmp7sh760i/\r\n```sh\r\n|-tmp7shd760i\r\n    |-sparkml\r\n        |-metadata\r\n            |-SUCCESS\r\n            |-part-00000\r\n        |-stages\r\n            |-0_SQLTokenizer_182199978fae\r\n                |-metadata\r\n                    |-SUCCESS\r\n                    |-part-00000\r\n```\r\nit appears that the custom python code is missing from this /tmp directory\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6450/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6450/timeline","performed_via_github_app":null,"state_reason":"completed"}