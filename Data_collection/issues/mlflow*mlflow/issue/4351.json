{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4351","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4351/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4351/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4351/events","html_url":"https://github.com/mlflow/mlflow/issues/4351","id":890351765,"node_id":"MDU6SXNzdWU4OTAzNTE3NjU=","number":4351,"title":"[BUG] Deleting the 'Default' Experiment breaks MLflow initialization","user":{"login":"asaf400","id":14169006,"node_id":"MDQ6VXNlcjE0MTY5MDA2","avatar_url":"https://avatars.githubusercontent.com/u/14169006?v=4","gravatar_id":"","url":"https://api.github.com/users/asaf400","html_url":"https://github.com/asaf400","followers_url":"https://api.github.com/users/asaf400/followers","following_url":"https://api.github.com/users/asaf400/following{/other_user}","gists_url":"https://api.github.com/users/asaf400/gists{/gist_id}","starred_url":"https://api.github.com/users/asaf400/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asaf400/subscriptions","organizations_url":"https://api.github.com/users/asaf400/orgs","repos_url":"https://api.github.com/users/asaf400/repos","events_url":"https://api.github.com/users/asaf400/events{/privacy}","received_events_url":"https://api.github.com/users/asaf400/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022851725,"node_id":"MDU6TGFiZWwyMDIyODUxNzI1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docker","name":"area/docker","color":"ede978","default":false,"description":"Docker use anywhere, such as MLprojects and MLmodels"},{"id":2022852620,"node_id":"MDU6TGFiZWwyMDIyODUyNjIw","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/sqlalchemy","name":"area/sqlalchemy","color":"ede978","default":false,"description":"Use of SQL alchemy in tracking service or model registry"},{"id":2237250735,"node_id":"MDU6TGFiZWwyMjM3MjUwNzM1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/server-infra","name":"area/server-infra","color":"48eabc","default":false,"description":"MLflow Tracking server backend"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-05-12T18:02:34Z","updated_at":"2021-05-27T04:00:08Z","closed_at":"2021-05-27T04:00:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"\r\n### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ probably ] Yes. I can contribute a fix for this bug independently.\r\n- [ maybe ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n\r\n### System information\r\n- MLflow docker image based on 'python:3.9-slim-buster'\r\n- MLflow installed from official pip \\ pypi\r\n- MLflow version 1.16.0\r\n- MLflow backend store: AWS RDS MySQL 8.0.23\r\n- MLflow artifact root: AWS S3 bucket\r\n- Python version: 3.9\r\n- command: mlflow server --backend-store-uri mysql+pymysql://root:${mlflow_rds_root_password}@${address}/${stack_env} --default-artifact-root \"s3://${s3_bucket}/${s3_bucket_prefix}/${stack_env}/\" --host 0.0.0.0:8080\r\n\r\n### Describe the problem\r\nAfter running MLflow for the first time, against an AWS RDS backend store,\r\na chaos engineer could request MLflow to delete the 'Default' experiment, which is created by the db migration mechanisms used by MLflow ( SQLalchemy migrations ).\r\n\r\nafter the default experiment (id 0) is deleted, MLflow continues to function fine, **until** the next service restart,\r\nif the service is restarted, then it would fail to initialize successfully with these errors:\r\n\r\n\r\n```\r\n2021/05/12 17:20:12 ERROR mlflow.cli: Error initializing backend store\r\n2021/05/12 17:20:12 ERROR mlflow.cli: (pymysql.err.IntegrityError) (1062, \"Duplicate entry '0' for key 'experiments.PRIMARY'\")\r\n[SQL: INSERT INTO experiments (experiment_id, name, artifact_location, lifecycle_stage) VALUES (0, 'Default', '\"s3://aura-data-mlflow/MLflow/dev/\"/0', 'active');]\r\n(Background on this error at: http://sqlalche.me/e/14/gkpj)\r\nTraceback (most recent call last):\r\n...\r\n...\r\n...\r\npymysql.err.IntegrityError: (1062, \"Duplicate entry '0' for key 'experiments.PRIMARY'\")\r\n[SQL: INSERT INTO experiments (experiment_id, name, artifact_location, lifecycle_stage) VALUES (0, 'Default', '\"s3://aura-data-mlflow/MLflow/dev/\"/0', 'active');]\r\n```\r\n\r\nClearly, the migration process attempts to insert a new default experiment at id 0, while it was already there, but removed due to user request to delete it..\r\n\r\n### Code to reproduce issue\r\nUser action based, but I guess someone could also do it with:\r\n\r\n```\r\n#!/usr/bin/env python\r\nimport mlflow\r\nTRACKING_URI = 'https://mlflow-dev.yourdomain.com/'\r\n\r\nmlflow.set_tracking_uri(TRACKING_URI)\r\nmlflow.delete_experiment('0')\r\n# OR \r\nclient = mlflow.tracking.MlflowClient(TRACKING_URI)\r\nclient.delete_experiment('0')\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ X ] `area/server-infra`: MLflow server, JavaScript dev server\r\n- [ X ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ X ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ X ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4351/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4351/timeline","performed_via_github_app":null,"state_reason":"completed"}