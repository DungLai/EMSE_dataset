{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4298","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/4298/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/4298/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/4298/events","html_url":"https://github.com/mlflow/mlflow/issues/4298","id":869698521,"node_id":"MDU6SXNzdWU4Njk2OTg1MjE=","number":4298,"title":"[BUG] Cant retrieve tracking uri from Azure ML - SSL Handshake error ","user":{"login":"codingmercy1993","id":71288410,"node_id":"MDQ6VXNlcjcxMjg4NDEw","avatar_url":"https://avatars.githubusercontent.com/u/71288410?v=4","gravatar_id":"","url":"https://api.github.com/users/codingmercy1993","html_url":"https://github.com/codingmercy1993","followers_url":"https://api.github.com/users/codingmercy1993/followers","following_url":"https://api.github.com/users/codingmercy1993/following{/other_user}","gists_url":"https://api.github.com/users/codingmercy1993/gists{/gist_id}","starred_url":"https://api.github.com/users/codingmercy1993/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codingmercy1993/subscriptions","organizations_url":"https://api.github.com/users/codingmercy1993/orgs","repos_url":"https://api.github.com/users/codingmercy1993/repos","events_url":"https://api.github.com/users/codingmercy1993/events{/privacy}","received_events_url":"https://api.github.com/users/codingmercy1993/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022859639,"node_id":"MDU6TGFiZWwyMDIyODU5NjM5","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/azure","name":"integrations/azure","color":"ffbce5","default":false,"description":"Azure and Azure ML integrations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-04-28T08:47:55Z","updated_at":"2021-04-28T14:22:46Z","closed_at":"2021-04-28T14:22:46Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [X ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Windows 10 Enterprise\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.15.0\r\n- **Python version**: 3.6.6.\r\n- **Exact command to reproduce**:\r\n\r\n      import mlflow\r\n      from azureml.core import Workspace\r\n      from azureml.core.authentication import ServicePrincipalAuthentication\r\n   \r\n      svc_pr=ServicePrincipalAuthentication(\r\n                  tenant_id=\"my-tenant-id-here\",\r\n                  service_principal_id=\"my-principal-id-here\",\r\n                  service_principal_password=\"my-service-principal-pw-here\")\r\n      \r\n      ws=Workspace(\r\n                  subscription_id='my-subscription-id-here',\r\n                  resource_group='my-rg',\r\n                  workspace_name=\"defaultworkspace\",\r\n                  auth=svc_pr)\r\n      \r\n      workspace_uri=ws.get_mlflow_tracking_uri()\r\n\r\n      mlflow.set_tracking_uri(workspace_uri)\r\n      experiment_name='experiment_with_mlflow'\r\n      mlflow.set_experiment(experiment_name)\r\n      \r\n      withmlflow.start_run():\r\n      mlflow.log_metric('alpha',0.03)\r\n\r\n\r\n### Describe the problem\r\n\r\n tried to execute an standard azure machine learning / ml flow example to log model params from my local machine into an experiment in my azure ML workspace. I created a service principal for authentication wich works without errors. Also the init of the workspace object works as expected. But when calling the get_mlflow_tracking_uri I get the error attached below.\r\nI am behind a corporate proxy. Also monkey patching proxy settings in request lib didnt change the outcome.\r\n\r\nI also have an ml flow instance on my maschine.\r\nAll the ml flow related parts work fine when I set the tracking uri to my local instance.\r\n\r\nMy problem is that I simply dont get the tracking uri with that get_mlflow_tracking_uri method.\r\n\r\nIf this problem cant be solved: Is there another way to get the tracking uri for a AML workspace?\r\nEven with az cli/ azure web ui I couldnt find the uri.\r\n\r\n### Other info / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n    During handling of the above exception, another exception occurred:\r\n    \r\n    Traceback (most recent call last):\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\adapters.py\", line 449, in send\r\n        timeout=timeout\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\connectionpool.py\", line 756, in urlopen\r\n        method, url, error=e, _pool=self, _stacktrace=sys.exc_info()[2]\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\util\\retry.py\", line 532, in increment\r\n        raise six.reraise(type(error), error, _stacktrace)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\packages\\six.py\", line 734, in reraise\r\n        raise value.with_traceback(tb)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\connectionpool.py\", line 706, in urlopen\r\n        chunked=chunked,\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\connectionpool.py\", line 382, in _make_request\r\n        self._validate_conn(conn)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\connectionpool.py\", line 1010, in _validate_conn\r\n        conn.connect()\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\connection.py\", line 421, in connect\r\n        tls_in_tls=tls_in_tls,\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\util\\ssl_.py\", line 429, in ssl_wrap_socket\r\n        sock, context, tls_in_tls, server_hostname=server_hostname\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\urllib3\\util\\ssl_.py\", line 472, in _ssl_wrap_socket_impl\r\n        return ssl_context.wrap_socket(sock, server_hostname=server_hostname)\r\n      File \"C:\\develop\\Microsoft Visual Studio\\Shared\\Python36_64\\lib\\ssl.py\", line 407, in wrap_socket\r\n        _context=self, _session=session)\r\n      File \"C:\\develop\\Microsoft Visual Studio\\Shared\\Python36_64\\lib\\ssl.py\", line 814, in __init__\r\n        self.do_handshake()\r\n      File \"C:\\develop\\Microsoft Visual Studio\\Shared\\Python36_64\\lib\\ssl.py\", line 1068, in do_handshake\r\n        self._sslobj.do_handshake()\r\n      File \"C:\\develop\\Microsoft Visual Studio\\Shared\\Python36_64\\lib\\ssl.py\", line 689, in do_handshake\r\n        self._sslobj.do_handshake()\r\n    urllib3.exceptions.ProtocolError: ('Connection aborted.', ConnectionResetError(10054,\r\n    “Connection forcibly closed by remote host”, None, 10054, None))\r\n    \r\n    During handling of the above exception, another exception occurred:\r\n    \r\n    Traceback (most recent call last):\r\n      File \"C:/develop/vssource/devops/Persoenlich_Deka/MlFlowPoC/az_AML.py\", line 22, in <module>\r\n        workspace_uri = ws.get_mlflow_tracking_uri()\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\core\\workspace.py\", line 1072, in get_mlflow_tracking_uri\r\n        return get_mlflow_tracking_uri(self)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\mlflow\\__init__.py\", line 59, in get_mlflow_tracking_uri\r\n        parse.urlparse(workspace.service_context._get_run_history_url()).netloc)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\core\\workspace.py\", line 818, in service_context\r\n        self._auth)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\service_context.py\", line 168, in __init__\r\n        self._endpoints = self._fetch_endpoints()\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\service_context.py\", line 295, in _fetch_endpoints\r\n        service_name=discovery_key)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 121, in get_service_url\r\n        unique_id=workspace_id, discovery_url=workspace_discovery_url)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 283, in get_cached_service_url\r\n        discovery_url=discovery_url)[service_name]\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 182, in wrapper\r\n        return test_function(self, *args, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 257, in get_cached_services_uris\r\n        cache[cache_key][DEFAULT_FLIGHT] = super(CachedServiceDiscovery, self).discover_services_uris_from_arm_scope(arm_scope, discovery_url)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 138, in discover_services_uris_from_arm_scope\r\n        return self.discover_services_uris(discovery_url)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_base_sdk_common\\service_discovery.py\", line 141, in discover_services_uris\r\n        status = ClientBase._execute_func(requests.get, discovery_url)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\clientbase.py\", line 375, in _execute_func\r\n        DEFAULT_SHORT_BACKOFF, DEFAULT_RETRIES, module_logger, func, _noop_reset, *args, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\clientbase.py\", line 367, in _execute_func_internal\r\n        left_retry = cls._handle_retry(back_off, left_retry, total_retry, error, logger, func)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\clientbase.py\", line 399, in _handle_retry\r\n        raise error\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\azureml\\_restclient\\clientbase.py\", line 358, in _execute_func_internal\r\n        response = func(*args, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\api.py\", line 76, in get\r\n        return request('get', url, params=params, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\api.py\", line 61, in request\r\n        return session.request(method=method, url=url, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\sessions.py\", line 542, in request\r\n        resp = self.send(prep, **send_kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\sessions.py\", line 655, in send\r\n        r = adapter.send(request, **kwargs)\r\n      File \"C:\\develop\\venv\\venv_repo\\all_venv\\lib\\site-packages\\requests\\adapters.py\", line 498, in send\r\n        raise ConnectionError(err, request=request)\r\n    requests.exceptions.ConnectionError: ('Connection aborted.', ConnectionResetError(10054, 'Connection forcibly closed by remote host', None, 10054, None))\r\n    \r\n    \r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nLanguage \r\n- [X ] `language/Python`: Python APIs and clients\r\n\r\nIntegrations\r\n- [X] `integrations/azure`: Azure and Azure ML integrations","closed_by":{"login":"codingmercy1993","id":71288410,"node_id":"MDQ6VXNlcjcxMjg4NDEw","avatar_url":"https://avatars.githubusercontent.com/u/71288410?v=4","gravatar_id":"","url":"https://api.github.com/users/codingmercy1993","html_url":"https://github.com/codingmercy1993","followers_url":"https://api.github.com/users/codingmercy1993/followers","following_url":"https://api.github.com/users/codingmercy1993/following{/other_user}","gists_url":"https://api.github.com/users/codingmercy1993/gists{/gist_id}","starred_url":"https://api.github.com/users/codingmercy1993/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codingmercy1993/subscriptions","organizations_url":"https://api.github.com/users/codingmercy1993/orgs","repos_url":"https://api.github.com/users/codingmercy1993/repos","events_url":"https://api.github.com/users/codingmercy1993/events{/privacy}","received_events_url":"https://api.github.com/users/codingmercy1993/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/4298/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/4298/timeline","performed_via_github_app":null,"state_reason":"completed"}