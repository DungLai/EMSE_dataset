{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1657","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1657/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1657/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1657/events","html_url":"https://github.com/mlflow/mlflow/issues/1657","id":472047358,"node_id":"MDU6SXNzdWU0NzIwNDczNTg=","number":1657,"title":"[MLflow 1.1] Loading models with mlflow.pyfunc.spark_udf broken on Databricks clusters","user":{"login":"smurching","id":2358483,"node_id":"MDQ6VXNlcjIzNTg0ODM=","avatar_url":"https://avatars.githubusercontent.com/u/2358483?v=4","gravatar_id":"","url":"https://api.github.com/users/smurching","html_url":"https://github.com/smurching","followers_url":"https://api.github.com/users/smurching/followers","following_url":"https://api.github.com/users/smurching/following{/other_user}","gists_url":"https://api.github.com/users/smurching/gists{/gist_id}","starred_url":"https://api.github.com/users/smurching/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smurching/subscriptions","organizations_url":"https://api.github.com/users/smurching/orgs","repos_url":"https://api.github.com/users/smurching/repos","events_url":"https://api.github.com/users/smurching/events{/privacy}","received_events_url":"https://api.github.com/users/smurching/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-07-24T02:23:18Z","updated_at":"2019-07-30T23:07:39Z","closed_at":"2019-07-30T23:07:39Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 16.04\r\n- **MLflow installed from (source or binary)**:  Binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.1.0\r\n- **Python version**: 3.6\r\n- **npm version (if running the dev UI): N/A\r\n- **Exact command to reproduce**: Try to load a model as a Spark UDF via `mlflow.pyfunc.spark_udf`\r\n\r\n### Describe the problem\r\nLoading models using a Spark UDF is broken in MLflow 1.1 due to a bug in zipping files from DBFS FUSE (the timestamps on the files are misconfigured or read incorrectly).\r\n\r\nAs a workaround, you can disable the DBFS FUSE logic before loading your model via:\r\n```\r\nimport os\r\nos.environ[\"MLFLOW_ENABLE_DBFS_FUSE_ARTIFACT_REPO\"] = 'false'\r\n```\r\n\r\n\r\n### Source code / logs\r\n```\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<command-3584523> in <module>()\r\n     1 import mlflow.pyfunc\r\n     2\r\n----> 3 trained_model = mlflow.pyfunc.spark_udf(spark, model_uri='runs:/c4569266b782467cacd91c3d0ef8f9fc/model')\r\n\r\n/databricks/python/lib/python3.6/site-packages/mlflow/pyfunc/__init__.py in spark_udf(spark, model_uri, result_type)\r\n   416\r\n   417     local_model_path = _download_artifact_from_uri(artifact_uri=model_uri)\r\n--> 418     archive_path = SparkModelCache.add_local_model(spark, local_model_path)\r\n   419\r\n   420     def predict(*args):\r\n\r\n/databricks/python/lib/python3.6/site-packages/mlflow/pyfunc/spark_model_cache.py in add_local_model(spark, model_path)\r\n    35         # NB: We must archive the directory as Spark.addFile does not support non-DFS\r\n    36         # directories when recursive=True.\r\n---> 37         archive_path = shutil.make_archive(archive_basepath, 'zip', model_path)\r\n    38         spark.sparkContext.addFile(archive_path)\r\n    39         return archive_path\r\n\r\n/databricks/python/lib/python3.6/shutil.py in make_archive(base_name, format, root_dir, base_dir, verbose, dry_run, owner, group, logger)\r\n   798\r\n   799     try:\r\n--> 800         filename = func(base_name, base_dir, **kwargs)\r\n   801     finally:\r\n   802         if root_dir is not None:\r\n\r\n/databricks/python/lib/python3.6/shutil.py in _make_zipfile(base_name, base_dir, verbose, dry_run, logger)\r\n   690                 for name in sorted(dirnames):\r\n   691                     path = os.path.normpath(os.path.join(dirpath, name))\r\n--> 692                     zf.write(path, path)\r\n   693                     if logger is not None:\r\n   694                         logger.info(\"adding '%s'\", path)\r\n\r\n/databricks/python/lib/python3.6/zipfile.py in write(self, filename, arcname, compress_type)\r\n  1592             )\r\n  1593\r\n-> 1594         zinfo = ZipInfo.from_file(filename, arcname)\r\n  1595\r\n  1596         if zinfo.is_dir():\r\n\r\n/databricks/python/lib/python3.6/zipfile.py in from_file(cls, filename, arcname)\r\n   494         if isdir:\r\n   495             arcname += '/'\r\n--> 496         zinfo = cls(arcname, date_time)\r\n   497         zinfo.external_attr = (st.st_mode & 0xFFFF) << 16  # Unix attributes\r\n   498         if isdir:\r\n\r\n/databricks/python/lib/python3.6/zipfile.py in __init__(self, filename, date_time)\r\n   336\r\n   337         if date_time[0] < 1980:\r\n--> 338             raise ValueError('ZIP does not support timestamps before 1980')\r\n   339\r\n   340         # Standard values:\r\n\r\nValueError: ZIP does not support timestamps before 1980\r\n```","closed_by":{"login":"smurching","id":2358483,"node_id":"MDQ6VXNlcjIzNTg0ODM=","avatar_url":"https://avatars.githubusercontent.com/u/2358483?v=4","gravatar_id":"","url":"https://api.github.com/users/smurching","html_url":"https://github.com/smurching","followers_url":"https://api.github.com/users/smurching/followers","following_url":"https://api.github.com/users/smurching/following{/other_user}","gists_url":"https://api.github.com/users/smurching/gists{/gist_id}","starred_url":"https://api.github.com/users/smurching/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smurching/subscriptions","organizations_url":"https://api.github.com/users/smurching/orgs","repos_url":"https://api.github.com/users/smurching/repos","events_url":"https://api.github.com/users/smurching/events{/privacy}","received_events_url":"https://api.github.com/users/smurching/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1657/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1657/timeline","performed_via_github_app":null,"state_reason":"completed"}