{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6129","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6129/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6129/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6129/events","html_url":"https://github.com/mlflow/mlflow/issues/6129","id":1283515155,"node_id":"I_kwDOCB5Jx85MgOMT","number":6129,"title":"[BUG] `mlflow.spark.log_model` produces sparkml folder with only SUCCESS files with s3 as artifact store","user":{"login":"mjstel","id":23032465,"node_id":"MDQ6VXNlcjIzMDMyNDY1","avatar_url":"https://avatars.githubusercontent.com/u/23032465?v=4","gravatar_id":"","url":"https://api.github.com/users/mjstel","html_url":"https://github.com/mjstel","followers_url":"https://api.github.com/users/mjstel/followers","following_url":"https://api.github.com/users/mjstel/following{/other_user}","gists_url":"https://api.github.com/users/mjstel/gists{/gist_id}","starred_url":"https://api.github.com/users/mjstel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjstel/subscriptions","organizations_url":"https://api.github.com/users/mjstel/orgs","repos_url":"https://api.github.com/users/mjstel/repos","events_url":"https://api.github.com/users/mjstel/events{/privacy}","received_events_url":"https://api.github.com/users/mjstel/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022847714,"node_id":"MDU6TGFiZWwyMDIyODQ3NzE0","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/model-registry","name":"area/model-registry","color":"48eabc","default":false,"description":"Model registry, model registry APIs, and the fluent client calls for model registry"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-24T09:37:08Z","updated_at":"2022-12-20T15:33:22Z","closed_at":"2022-06-27T11:44:52Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\n\nNo. I cannot contribute a bug fix at this time.\n\n### MLflow version\n\n1.26.1\n\n### System information\n\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: apache/spark-py:3.2.1 Docker Image on K8s\r\n- **Python version**: 3.9\n\n### Describe the problem\n\nHello, we are trying to create a KMeans model using spark.ml. The spark job runs against our Kubernetes cluster in cluster-mode.\r\n\r\nSaving the model directly via `model.save(...)` works as expected, but using `mlflow.spark.log_model` uploads the model to our tracking server, but when looking inside the sparkml folder, we only see a folder structure with some SUCCESS files.\r\n\r\n![image](https://user-images.githubusercontent.com/23032465/175505852-2d75aee3-a4b7-4d5b-b8f8-a6535b1d3383.png)\r\n\r\nWhen loading the model with `mlflow.spark.load_model` we're getting the following Error:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/tmp/spark-36be34e7-5e43-4293-8542-3cf41f99ae18/main.py\", line 140, in <module>\r\n    model_info = mlflow.spark.load_model(model_uri=model_info.model_uri)\r\n  File \"/usr/local/lib/python3.9/dist-packages/mlflow/spark.py\", line 711, in load_model\r\n    return _load_model(model_uri=model_uri, dfs_tmpdir_base=dfs_tmpdir)\r\n  File \"/usr/local/lib/python3.9/dist-packages/mlflow/spark.py\", line 660, in _load_model\r\n    return PipelineModel.load(model_uri)\r\n  File \"/opt/spark/python/lib/pyspark.zip/pyspark/ml/util.py\", line 332, in load\r\n  File \"/opt/spark/python/lib/pyspark.zip/pyspark/ml/pipeline.py\", line 256, in load\r\n  File \"/opt/spark/python/lib/pyspark.zip/pyspark/ml/util.py\", line 525, in loadMetadata\r\n  File \"/opt/spark/python/lib/pyspark.zip/pyspark/rdd.py\", line 1591, in first\r\nValueError: RDD is empty\r\n```\n\n### Tracking information\n\nMLflow version: 1.26.1\r\nTracking URI: http://mlflow.mlflow.svc.cluster.local:5000\r\nArtifact URI: s3://<omitted>/0/6881283daca5440ba5c701ce6a5795e5/artifacts\n\n### Code to reproduce issue\n\n```python\r\nimport mlflow.spark\r\nfrom pyspark.sql import SparkSession\r\nfrom pyspark import SparkConf, SparkContext\r\nfrom pyspark.ml.clustering import KMeans\r\nfrom pyspark.sql import Row\r\nfrom pyspark.ml.linalg import DenseVector\r\n\r\nconf = SparkConf()\r\nsc = SparkContext(conf=conf)\r\nspark = SparkSession(sc)\r\nmlflow.set_tracking_uri(\"http://mlflow.mlflow.svc.cluster.local:5000\")\r\n\r\nml_input = spark.createDataFrame(\r\n    [\r\n        Row(features=DenseVector([38851.2266, 62739.2031, 23.0, 2.0, 8.0, 155.0, 0.0, 886.0, -863.0]), scaled_features=DenseVector([1.5453, 2.3341, 0.4422, 0.1807, 0.255, 1.0514, 0.0, 1.6196, -1.7345])),\r\n        Row(features=DenseVector([485.0, 230.5168, 3.0, 0.0, 0.0, 0.0, 0.0, 1.0, 2.0]), scaled_features=DenseVector([0.0193, 0.0086, 0.0577, 0.0, 0.0, 0.0, 0.0, 0.0018, 0.004]))\r\n    ]\r\n)\r\n\r\nmodel = KMeans(k=50, featuresCol=\"scaled_features\").fit(ml_input)\r\nmodel_info = mlflow.spark.log_model(spark_model=model, artifact_path=\"botspotter-kmeans\", registered_model_name=\"kmeans\")\r\nloaded_model =  mlflow.spark.load_model(model_uri=model_info.model_uri)\r\n```\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [X] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [X] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"mjstel","id":23032465,"node_id":"MDQ6VXNlcjIzMDMyNDY1","avatar_url":"https://avatars.githubusercontent.com/u/23032465?v=4","gravatar_id":"","url":"https://api.github.com/users/mjstel","html_url":"https://github.com/mjstel","followers_url":"https://api.github.com/users/mjstel/followers","following_url":"https://api.github.com/users/mjstel/following{/other_user}","gists_url":"https://api.github.com/users/mjstel/gists{/gist_id}","starred_url":"https://api.github.com/users/mjstel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjstel/subscriptions","organizations_url":"https://api.github.com/users/mjstel/orgs","repos_url":"https://api.github.com/users/mjstel/repos","events_url":"https://api.github.com/users/mjstel/events{/privacy}","received_events_url":"https://api.github.com/users/mjstel/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6129/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6129/timeline","performed_via_github_app":null,"state_reason":"completed"}