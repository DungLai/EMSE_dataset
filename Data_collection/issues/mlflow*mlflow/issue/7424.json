{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7424","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/7424/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/7424/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/7424/events","html_url":"https://github.com/mlflow/mlflow/issues/7424","id":1468077412,"node_id":"I_kwDOCB5Jx85XgRVk","number":7424,"title":"[BUG] Cannot use databricks connection with R","user":{"login":"nathaneastwood","id":9799530,"node_id":"MDQ6VXNlcjk3OTk1MzA=","avatar_url":"https://avatars.githubusercontent.com/u/9799530?v=4","gravatar_id":"","url":"https://api.github.com/users/nathaneastwood","html_url":"https://github.com/nathaneastwood","followers_url":"https://api.github.com/users/nathaneastwood/followers","following_url":"https://api.github.com/users/nathaneastwood/following{/other_user}","gists_url":"https://api.github.com/users/nathaneastwood/gists{/gist_id}","starred_url":"https://api.github.com/users/nathaneastwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nathaneastwood/subscriptions","organizations_url":"https://api.github.com/users/nathaneastwood/orgs","repos_url":"https://api.github.com/users/nathaneastwood/repos","events_url":"https://api.github.com/users/nathaneastwood/events{/privacy}","received_events_url":"https://api.github.com/users/nathaneastwood/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":968461607,"node_id":"MDU6TGFiZWw5Njg0NjE2MDc=","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/windows","name":"area/windows","color":"ede978","default":false,"description":"Issue is unique to windows."},{"id":1041183632,"node_id":"MDU6TGFiZWwxMDQxMTgzNjMy","url":"https://api.github.com/repos/mlflow/mlflow/labels/language/r","name":"language/r","color":"349cd8","default":false,"description":"R APIs and clients"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2114036915,"node_id":"MDU6TGFiZWwyMTE0MDM2OTE1","url":"https://api.github.com/repos/mlflow/mlflow/labels/integrations/databricks","name":"integrations/databricks","color":"ffbce5","default":false,"description":"Databricks integrations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-11-29T13:35:01Z","updated_at":"2022-11-29T14:45:31Z","closed_at":"2022-11-29T14:26:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Issues Policy acknowledgement\n\n- [X] I have read and agree to submit bug reports in accordance with the [issues policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\n\n### Willingness to contribute\n\nYes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\n\n### MLflow version\n\nmlflow, version 1.27.0\n\n### System information\n\n- Window\r\n- **Python version**: Python 3.10.0\r\n- **R version**: R version 4.1.2 (2021-11-01)\r\n- **mlflow R package version**: 2.0.1\n\n### Describe the problem\n\nI am attempting to track and log parameters within DataBricks using mlflow. I can see the runs that I am creating quite clearly:\r\n\r\n![image](https://user-images.githubusercontent.com/9799530/204539837-57d3adf2-1dd5-409c-9f1b-8c2906699093.png)\r\n\r\nHowever there is an issue whereby I cannot actually log anything to this run. This is due to the way the package sets the active run ID - or rather doesn't set it - when there is a client provided. See [here](https://github.com/mlflow/mlflow/blob/master/mlflow/R/mlflow/R/tracking-runs.R#L516-L517). The result of this is that whenever you try to log something, it will not work as there is a check for the active run ID that takes place [here](https://github.com/mlflow/mlflow/blob/master/mlflow/R/mlflow/R/tracking-utils.R#L50-L52). Ultimately this is because `mlflow:::mlflow_get_active_run_id()` is `NULL` because it is never set in `mlflow::mlflow_start_run()` when there is a `client_id` provided.\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\n```r\r\nlibrary(mlflow)\r\nclient <- mlflow::mlflow_client(tracking_uri = \"databricks\")\r\nexperiment <- \"1709256526326232\"\r\nrun <- mlflow::mlflow_start_run(experiment_id = \"1709256526326232\", client = client)\r\n\r\nmlflow:::mlflow_get_active_run_id()\r\n# NULL\r\n\r\n# Try to log a parameter\r\nwith(run, {\r\n  mlflow::mlflow_log_param(\r\n    key = \"test\",\r\n    value = 1,\r\n    client = client\r\n  )\r\n})\r\n# Error: `with()` should only be used with `mlflow_start_run()`.\r\n\r\n# Try to use `mlflow::mlflow_start_run()`:\r\nwith(\r\n  mlflow::mlflow_start_run(\r\n    experiment_id = \"1709256526326232\",\r\n    client = mlflow::mlflow_client(tracking_uri = \"databricks\")\r\n  ), {\r\n  mlflow::mlflow_log_param(\r\n    key = \"test\",\r\n    value = 1,\r\n    client = client\r\n  )\r\n})\r\n# Error: `with()` should only be used with `mlflow_start_run()`.\r\n```\n\n### Stack trace\n\n```\r\n3: stop(\"`with()` should only be used with `mlflow_start_run()`.\",\r\n       call. = FALSE)\r\n2: with.mlflow_run(mlflow::mlflow_start_run(experiment_id = \"1709256526326232\", \r\n       client = mlflow::mlflow_client(tracking_uri = \"databricks\")),\r\n       {\r\n           mlflow::mlflow_log_param(key = \"test\", value = 1, client = client)   \r\n       })\r\n1: with(mlflow::mlflow_start_run(experiment_id = \"1709256526326232\",\r\n       client = mlflow::mlflow_client(tracking_uri = \"databricks\")),\r\n       {\r\n           mlflow::mlflow_log_param(key = \"test\", value = 1, client = client)\r\n       })\r\n```\n\n### Other info / logs\n\n_No response_\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/recipes`: Recipes, Recipe APIs, Recipe configs, Recipe Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [X] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [X] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [X] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [X] `integrations/databricks`: Databricks integrations","closed_by":{"login":"nathaneastwood","id":9799530,"node_id":"MDQ6VXNlcjk3OTk1MzA=","avatar_url":"https://avatars.githubusercontent.com/u/9799530?v=4","gravatar_id":"","url":"https://api.github.com/users/nathaneastwood","html_url":"https://github.com/nathaneastwood","followers_url":"https://api.github.com/users/nathaneastwood/followers","following_url":"https://api.github.com/users/nathaneastwood/following{/other_user}","gists_url":"https://api.github.com/users/nathaneastwood/gists{/gist_id}","starred_url":"https://api.github.com/users/nathaneastwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nathaneastwood/subscriptions","organizations_url":"https://api.github.com/users/nathaneastwood/orgs","repos_url":"https://api.github.com/users/nathaneastwood/repos","events_url":"https://api.github.com/users/nathaneastwood/events{/privacy}","received_events_url":"https://api.github.com/users/nathaneastwood/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/7424/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/7424/timeline","performed_via_github_app":null,"state_reason":"completed"}