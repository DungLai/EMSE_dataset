{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2255","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2255/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2255/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2255/events","html_url":"https://github.com/mlflow/mlflow/issues/2255","id":544787775,"node_id":"MDU6SXNzdWU1NDQ3ODc3NzU=","number":2255,"title":"[BUG] Derived PythonModel's `predict()` implementation not persisted to model ","user":{"login":"TheTravellingSalesman","id":36421850,"node_id":"MDQ6VXNlcjM2NDIxODUw","avatar_url":"https://avatars.githubusercontent.com/u/36421850?v=4","gravatar_id":"","url":"https://api.github.com/users/TheTravellingSalesman","html_url":"https://github.com/TheTravellingSalesman","followers_url":"https://api.github.com/users/TheTravellingSalesman/followers","following_url":"https://api.github.com/users/TheTravellingSalesman/following{/other_user}","gists_url":"https://api.github.com/users/TheTravellingSalesman/gists{/gist_id}","starred_url":"https://api.github.com/users/TheTravellingSalesman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TheTravellingSalesman/subscriptions","organizations_url":"https://api.github.com/users/TheTravellingSalesman/orgs","repos_url":"https://api.github.com/users/TheTravellingSalesman/repos","events_url":"https://api.github.com/users/TheTravellingSalesman/events{/privacy}","received_events_url":"https://api.github.com/users/TheTravellingSalesman/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-01-02T23:16:27Z","updated_at":"2021-03-02T16:40:26Z","closed_at":"2020-01-09T21:12:38Z","author_association":"NONE","active_lock_reason":null,"body":"Thank you for submitting an issue. Please refer to our [issue policy](https://www.github.com/mlflow/mlflow/blob/master/ISSUE_POLICY.md)\r\nfor information on what types of issues we address. For help with debugging your code, please refer to [Stack Overflow](https://stackoverflow.com/questions/tagged/mlflow).\r\n\r\nPlease fill in this template and do not delete it unless you are sure your issue is outside its scope.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**:\r\n\r\nI have written custom code -- an mlflow.pyfunc example does not exist, so far as I can tell.\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\n\r\nmacOS Mojave 10.14.6\r\n\r\n- **MLflow installed from (source or binary)**:\r\n\r\nInstalled via conda.\r\n\r\n- **MLflow version (run ``mlflow --version``)**:\r\n\r\n1.5.0\r\n\r\n- **Python version**:\r\n\r\npython 3.8.0\r\ncython 0.29.14\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Include descriptions of the expected behavior and the actual behavior.\r\n\r\nI wrote a custom derived class of `PythonModel` as per the documentation listed for `mlflow.pyfunc`, which I'll refer to as `derived_PythonModel`. \r\n\r\nI wrote out the model as an MLflow model artifact using `mlflow.pyfunc.save_model('/path/to/model.mlflow', python_model=derived_PythonModel, artifacts={'model': 'model_path/model.pkl'}`. After that I read in the model using `model = mlflow.pyfunc.load_model('/path/to/model.mlflow')`. Then, I tried to run `model.predict(input_data)`, which gave the following error, which shows that the derived class implementation of `predict()` is not being used:\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-21-74ce3ea5e386> in <module>\r\n----> 1 read_lr_model.predict(model_df)\r\n\r\n~/.conda/envs/DS-3837-MLflow-pyfunc-spike/lib/python3.8/site-packages/mlflow/pyfunc/model.py in predict(self, model_input)\r\n    241 \r\n    242     def predict(self, model_input):\r\n--> 243         return self.python_model.predict(self.context, model_input)\r\n\r\nTypeError: predict() takes 2 positional arguments but 3 were given\r\n```\r\n\r\nI expected that the `predict()` implementation from the derived class would override the implementation of `predict()` in the base class, and be used upon calling the `predict()` function of the read MLflow model artifact that I had written out along with the derived class.\r\n\r\n### Code to reproduce issue\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\nThis is code will recreate the issue, but will require scikit-learn to run:\r\n\r\n```\r\nimport mlflow\r\nimport mlflow.pyfunc\r\nimport pandas as pd\r\nimport pickle\r\nfrom sklearn.linear_model import LogisticRegression\r\n\r\nmodel_df = pd.DataFrame({'model_input': ['hello world'])\r\n\r\nlr_model = LogisticRegression()\r\n\r\npkl_filename = \"LR_model.pkl\"\r\nwith open(pkl_filename, 'wb') as file:\r\n    pickle.dump(lr_model, file)\r\n\r\nclass LR_Model(mlflow.pyfunc.PythonModel):\r\n    \r\n    def __init__(self, lr_model):\r\n        self.model = lr_model\r\n        super().__init__()\r\n    \r\n    def predict(self, model_input):\r\n        # returning a string just so we don't actually have to call it on real data to see output\r\n        return \"self.model.predict(model_input)\"\r\n\r\nmlflow.pyfunc.save_model('./LR_model.mlflow', \r\n                         python_model=LR_Model(lr_model), artifacts={'model': './LR_model.pkl'})\r\n\r\nread_lr_model = mlflow.pyfunc.load_model('./LR_model.mlflow')\r\n\r\nread_lr_model.predict(model_df)\r\n```\r\n","closed_by":{"login":"TheTravellingSalesman","id":36421850,"node_id":"MDQ6VXNlcjM2NDIxODUw","avatar_url":"https://avatars.githubusercontent.com/u/36421850?v=4","gravatar_id":"","url":"https://api.github.com/users/TheTravellingSalesman","html_url":"https://github.com/TheTravellingSalesman","followers_url":"https://api.github.com/users/TheTravellingSalesman/followers","following_url":"https://api.github.com/users/TheTravellingSalesman/following{/other_user}","gists_url":"https://api.github.com/users/TheTravellingSalesman/gists{/gist_id}","starred_url":"https://api.github.com/users/TheTravellingSalesman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TheTravellingSalesman/subscriptions","organizations_url":"https://api.github.com/users/TheTravellingSalesman/orgs","repos_url":"https://api.github.com/users/TheTravellingSalesman/repos","events_url":"https://api.github.com/users/TheTravellingSalesman/events{/privacy}","received_events_url":"https://api.github.com/users/TheTravellingSalesman/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2255/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2255/timeline","performed_via_github_app":null,"state_reason":"completed"}