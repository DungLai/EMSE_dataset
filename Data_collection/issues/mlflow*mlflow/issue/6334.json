{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6334","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6334/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6334/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6334/events","html_url":"https://github.com/mlflow/mlflow/issues/6334","id":1318521297,"node_id":"I_kwDOCB5Jx85OlwnR","number":6334,"title":"[BUG] \"No schema\" shown on model version page ","user":{"login":"abbas123456","id":915598,"node_id":"MDQ6VXNlcjkxNTU5OA==","avatar_url":"https://avatars.githubusercontent.com/u/915598?v=4","gravatar_id":"","url":"https://api.github.com/users/abbas123456","html_url":"https://github.com/abbas123456","followers_url":"https://api.github.com/users/abbas123456/followers","following_url":"https://api.github.com/users/abbas123456/following{/other_user}","gists_url":"https://api.github.com/users/abbas123456/gists{/gist_id}","starred_url":"https://api.github.com/users/abbas123456/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abbas123456/subscriptions","organizations_url":"https://api.github.com/users/abbas123456/orgs","repos_url":"https://api.github.com/users/abbas123456/repos","events_url":"https://api.github.com/users/abbas123456/events{/privacy}","received_events_url":"https://api.github.com/users/abbas123456/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1470945519,"node_id":"MDU6TGFiZWwxNDcwOTQ1NTE5","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/uiux","name":"area/uiux","color":"ede978","default":false,"description":"Front-end, user experience, plotting, JavaScript, JavaScript dev server"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"}],"state":"closed","locked":false,"assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"assignees":[{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-07-26T16:57:18Z","updated_at":"2022-11-17T07:28:12Z","closed_at":"2022-08-09T17:42:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I can contribute a fix for this bug independently.\r\n\r\n### MLflow version\r\n\r\n1.27.0\r\n\r\n### System information\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux version 5.10.104-linuxkit\r\n- **Python version**: 3.7.13\r\n- **yarn version, if running the dev UI**:\r\n\r\n\r\n### Describe the problem\r\n\r\nWhen running an experiment and registering a model with a signature, the signature can be seen in the \"Artifacts\" section on the run page but does not show in the \"Schema\" section on the model version page.\r\n\r\n**Run page:**\r\n\r\n<img width=\"1416\" alt=\"Screenshot 2022-07-26 at 17 15 10\" src=\"https://user-images.githubusercontent.com/915598/181057808-e6c45dbe-da68-4de1-bba3-b6a3de496b61.png\">\r\n\r\n**Model version page:**\r\n\r\n<img width=\"839\" alt=\"Screenshot 2022-07-26 at 17 15 22\" src=\"https://user-images.githubusercontent.com/915598/181057819-44354847-a738-44f4-8677-2183aa616209.png\">\r\n\r\nThis appears to only be an issue when using the proxied artifact storage set-up described at https://www.mlflow.org/docs/latest/tracking.html#scenario-5-mlflow-tracking-server-enabled-with-proxied-artifact-storage-access. \r\n\r\nI was able to fix the issue by modifying the `get_model_version_artifact_handler` at https://github.com/mlflow/mlflow/blob/master/mlflow/server/handlers.py#L1294 to determine the `artifact_path` in a similar way to how the `get_artifact_handler` determines it at https://github.com/mlflow/mlflow/blob/master/mlflow/server/handlers.py#L518\r\n\r\n\r\n### Tracking information\r\n\r\nMLflow version: 1.27.0\r\nTracking URI: http://0.0.0.0\r\nArtifact URI: mlflow-artifacts:/0/0907b0b94e5b4230bde0a177c5a01899/artifacts\r\n\r\n\r\n```\r\nmlflow server\r\n      --host 0.0.0.0\r\n      --port 5000\r\n      --serve-artifacts\r\n      --artifacts-destination s3://my-bucket\r\n      --backend-store-uri postgresql://postgres:postgres@backend-store:5432/mlflow\r\n      --gunicorn-opts \"--log-level debug\"\r\n```\r\n\r\n### Code to reproduce issue\r\n\r\n**Commands to run:**\r\n`$ docker-compose up --build`\r\n`$ MLFLOW_TRACKING_URI=http://0.0.0.0 MLFLOW_TRACKING_USERNAME=username MLFLOW_TRACKING_PASSWORD=password python example.py`\r\n\r\n**Files needed:**\r\n\r\n**docker-compose.yml**\r\n```version: \"3\"\r\n\r\nservices:\r\n  tracking-server:\r\n    build:\r\n      context: .\r\n      dockerfile: Dockerfile\r\n    depends_on:\r\n      - backend-store\r\n    ports:\r\n      - \"5000:5000\"\r\n    environment:\r\n      MLFLOW_S3_ENDPOINT_URL:  http://mlflow-artifacts:9000\r\n      AWS_ACCESS_KEY_ID: AKIAIOSFODNN7EXAMPLE\r\n      AWS_SECRET_ACCESS_KEY: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n      AWS_DEFAULT_REGION: eu-west-2\r\n    command: >\r\n      mlflow server\r\n      --host 0.0.0.0\r\n      --port 5000\r\n      --serve-artifacts\r\n      --artifacts-destination s3://my-bucket\r\n      --backend-store-uri postgresql://postgres:postgres@backend-store:5432/mlflow\r\n      --gunicorn-opts \"--log-level debug\"\r\n\r\n  nginx-proxy:\r\n    build:\r\n      context: nginx\r\n      dockerfile: Dockerfile\r\n    depends_on:\r\n      - tracking-server\r\n    ports:\r\n      - \"80:80\"\r\n\r\n  backend-store:\r\n    image: postgres:12\r\n    volumes:\r\n      - ./init.sql:/docker-entrypoint-initdb.d/init.sql\r\n      - postgres_data:/var/lib/postgresql/data/\r\n    environment:\r\n      POSTGRES_USER: \"postgres\"\r\n      POSTGRES_HOST_AUTH_METHOD: \"trust\"\r\n\r\n  mlflow-artifacts:\r\n    image: minio/minio:RELEASE.2021-10-08T23-58-24Z.fips\r\n    environment:\r\n      MINIO_ROOT_USER: AKIAIOSFODNN7EXAMPLE\r\n      MINIO_ROOT_PASSWORD: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n      MINIO_REGION: eu-west-2\r\n    ports:\r\n      - \"9000:9000\"\r\n      - \"9001:9001\"\r\n    entrypoint: sh\r\n    volumes:\r\n      - \".minio:/data\"\r\n    command: ['-c', 'mkdir -p /data/my-bucket && minio server /data --console-address \":9001\"']\r\n\r\nvolumes:\r\n  postgres_data:\r\n  minio:\r\n```\r\n\r\n**Dockerfile**\r\n```\r\nFROM python:3.7-buster\r\n\r\nWORKDIR /app\r\n\r\nRUN pip install sklearn mlflow psycopg2 boto3\r\n```\r\n\r\n**example.py**\r\n```\r\nimport sys\r\n\r\nimport pandas as pd\r\nimport numpy as np\r\nfrom sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.linear_model import ElasticNet\r\nimport mlflow\r\nimport mlflow.sklearn\r\nfrom mlflow.models.signature import ModelSignature\r\nfrom mlflow.types.schema import Schema, ColSpec\r\n\r\ndef eval_metrics(actual, pred):\r\n    rmse = np.sqrt(mean_squared_error(actual, pred))\r\n    mae = mean_absolute_error(actual, pred)\r\n    r2 = r2_score(actual, pred)\r\n    return rmse, mae, r2\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    np.random.seed(40)\r\n\r\n    # Read the wine-quality csv file from the URL\r\n    csv_url = (\r\n        \"http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv\"\r\n    )\r\n    data = pd.read_csv(csv_url, sep=\";\")\r\n\r\n    # Split the data into training and test sets. (0.75, 0.25) split.\r\n    train, test = train_test_split(data)\r\n\r\n    # The predicted column is \"quality\" which is a scalar from [3, 9]\r\n    train_x = train.drop([\"quality\"], axis=1)\r\n    test_x = test.drop([\"quality\"], axis=1)\r\n    train_y = train[[\"quality\"]]\r\n    test_y = test[[\"quality\"]]\r\n\r\n    alpha = float(sys.argv[1]) if len(sys.argv) > 1 else 0.5\r\n    l1_ratio = float(sys.argv[2]) if len(sys.argv) > 2 else 0.5\r\n\r\n    with mlflow.start_run():\r\n        lr = ElasticNet(alpha=alpha, l1_ratio=l1_ratio, random_state=42)\r\n        lr.fit(train_x, train_y)\r\n\r\n        predicted_qualities = lr.predict(test_x)\r\n\r\n        (rmse, mae, r2) = eval_metrics(test_y, predicted_qualities)\r\n\r\n        mlflow.log_param(\"alpha\", alpha)\r\n        mlflow.log_param(\"l1_ratio\", l1_ratio)\r\n        mlflow.log_metric(\"rmse\", rmse)\r\n        mlflow.log_metric(\"r2\", r2)\r\n        mlflow.log_metric(\"mae\", mae)\r\n\r\n        input_schema = Schema([\r\n            ColSpec(\"double\", \"sepal length (cm)\"),\r\n            ColSpec(\"double\", \"sepal width (cm)\"),\r\n            ColSpec(\"double\", \"petal length (cm)\"),\r\n            ColSpec(\"double\", \"petal width (cm)\"),\r\n        ])\r\n        output_schema = Schema([ColSpec(\"long\")])\r\n        signature = ModelSignature(inputs=input_schema, outputs=output_schema)\r\n\r\n        mlflow.sklearn.log_model(lr, \"model\", registered_model_name=\"ElasticnetWineModel\", signature=signature)\r\n```\r\n\r\n**init.sql**\r\n```\r\nCREATE DATABASE mlflow;\r\n```\r\n\r\n**nginx/Dockerfile**\r\n```\r\nFROM nginx\r\nCOPY nginx.conf /etc/nginx/nginx.conf\r\nCOPY htpasswd /etc/nginx/conf.d/htpasswd\r\n```\r\n\r\n**nginx/htpasswd**\r\n```\r\nusername:jRlgfrjACzG6Y\r\n```\r\n\r\n**nginx/nginx.conf**\r\n```\r\nuser  nginx;\r\nworker_processes  auto;\r\n\r\nerror_log  /var/log/nginx/error.log notice;\r\npid        /var/run/nginx.pid;\r\n\r\n\r\nevents {\r\n    worker_connections  1024;\r\n}\r\n\r\n\r\nhttp {\r\n    include       /etc/nginx/mime.types;\r\n    default_type  application/octet-stream;\r\n\r\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\r\n                      '$status $body_bytes_sent \"$http_referer\" '\r\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\r\n\r\n    access_log  /var/log/nginx/access.log  main;\r\n\r\n    sendfile        on;\r\n    #tcp_nopush     on;\r\n\r\n    keepalive_timeout  65;\r\n\r\n    #gzip  on;\r\n\r\n    server {\r\n        location / {\r\n            auth_basic           \"closed site\";\r\n            auth_basic_user_file conf.d/htpasswd;\r\n\r\n            proxy_pass http://tracking-server:5000/;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n### Other info / logs\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [X] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [X] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6334/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6334/timeline","performed_via_github_app":null,"state_reason":"completed"}