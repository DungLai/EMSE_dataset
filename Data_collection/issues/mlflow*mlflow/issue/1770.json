{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1770","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1770/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1770/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1770/events","html_url":"https://github.com/mlflow/mlflow/issues/1770","id":483859902,"node_id":"MDU6SXNzdWU0ODM4NTk5MDI=","number":1770,"title":"[FR] add support for model deployment on Google Cloud Run","user":{"login":"ngallot","id":22400245,"node_id":"MDQ6VXNlcjIyNDAwMjQ1","avatar_url":"https://avatars.githubusercontent.com/u/22400245?v=4","gravatar_id":"","url":"https://api.github.com/users/ngallot","html_url":"https://github.com/ngallot","followers_url":"https://api.github.com/users/ngallot/followers","following_url":"https://api.github.com/users/ngallot/following{/other_user}","gists_url":"https://api.github.com/users/ngallot/gists{/gist_id}","starred_url":"https://api.github.com/users/ngallot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ngallot/subscriptions","organizations_url":"https://api.github.com/users/ngallot/orgs","repos_url":"https://api.github.com/users/ngallot/repos","events_url":"https://api.github.com/users/ngallot/events{/privacy}","received_events_url":"https://api.github.com/users/ngallot/received_events","type":"User","site_admin":false},"labels":[{"id":955449434,"node_id":"MDU6TGFiZWw5NTU0NDk0MzQ=","url":"https://api.github.com/repos/mlflow/mlflow/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-08-22T08:57:24Z","updated_at":"2019-09-04T07:02:31Z","closed_at":"2019-09-04T07:02:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"\r\n## Describe the proposal\r\nUsing the current built-in fully managed deployment tools (Microsoft Azure ML and Amazon Sagemaker), we can deploy an MLflow model to a REST endpoint. While this is already a very cool feature, it becomes quickly expensive to host models on those platforms as it requires 1 instance per model, running 24/7.\r\nDeploying models on [Google Cloud Run](https://cloud.google.com/run/) would reduce significantly this bill.\r\n\r\n### Motivation\r\nGoogle Cloud Run enables deployment of Docker containers on a serverless, pay-as-you-go infrastructure (you are billed at the millisecond). It is a very good target deployment infrastructure for lightweight models (RAM limited at 2 GO) and should cover a lot of ML cases (as also mentioned by @amutz in issue #866).\r\n\r\n### Proposed Changes\r\nThe full support of model deployment on Google Cloud Run would come in a second step. Here, I propose to enable a Docker container build with the ```mlflow models build-docker``` command to be deployed on Google Cloud Run. This container can then be manually deployed using the ```gcloud``` command line tool.\r\nCurrently, images build with mlflow cannot be deployed to Cloud Run for 2 reasons:\r\n- the below commands (```mlflow/models/container/__init__.py```) fail because of limited rights on the environment provided by Google to run the container: \r\n```python\r\ncheck_call(['ln', '-sf', '/dev/stdout', '/var/log/nginx/access.log'])\r\ncheck_call(['ln', '-sf', '/dev/stderr', '/var/log/nginx/error.log'])\r\n```\r\n- the nginx process makes the Cloud Run service startup failing. The same container deployed without starting the nginx process starts successfully.\r\n\r\nTo make the deployment possible on Cloud Run, I propose the following changes:\r\n- Introduce an environment variable to disable nginx, and start only the gunicorn process. To keep the default behavior, nginx will be started unless explicitly specified in environment variable. Also, if nginx is disabled, then we also disable the logs redirection and solve th e2 problems at once.\r\n\r\nI already have the code ready and I've successfully deployed a model on Cloud Run, and would be happy to make a pull request.\r\n","closed_by":{"login":"mateiz","id":228859,"node_id":"MDQ6VXNlcjIyODg1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228859?v=4","gravatar_id":"","url":"https://api.github.com/users/mateiz","html_url":"https://github.com/mateiz","followers_url":"https://api.github.com/users/mateiz/followers","following_url":"https://api.github.com/users/mateiz/following{/other_user}","gists_url":"https://api.github.com/users/mateiz/gists{/gist_id}","starred_url":"https://api.github.com/users/mateiz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mateiz/subscriptions","organizations_url":"https://api.github.com/users/mateiz/orgs","repos_url":"https://api.github.com/users/mateiz/repos","events_url":"https://api.github.com/users/mateiz/events{/privacy}","received_events_url":"https://api.github.com/users/mateiz/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1770/reactions","total_count":22,"+1":17,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":5,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1770/timeline","performed_via_github_app":null,"state_reason":"completed"}