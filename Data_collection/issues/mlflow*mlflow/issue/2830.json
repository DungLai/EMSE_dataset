{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2830","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/2830/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/2830/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/2830/events","html_url":"https://github.com/mlflow/mlflow/issues/2830","id":618588765,"node_id":"MDU6SXNzdWU2MTg1ODg3NjU=","number":2830,"title":"[BUG] Predict N-dimensional data with pyfunc from MLmodel","user":{"login":"aseltmann","id":48986196,"node_id":"MDQ6VXNlcjQ4OTg2MTk2","avatar_url":"https://avatars.githubusercontent.com/u/48986196?v=4","gravatar_id":"","url":"https://api.github.com/users/aseltmann","html_url":"https://github.com/aseltmann","followers_url":"https://api.github.com/users/aseltmann/followers","following_url":"https://api.github.com/users/aseltmann/following{/other_user}","gists_url":"https://api.github.com/users/aseltmann/gists{/gist_id}","starred_url":"https://api.github.com/users/aseltmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aseltmann/subscriptions","organizations_url":"https://api.github.com/users/aseltmann/orgs","repos_url":"https://api.github.com/users/aseltmann/repos","events_url":"https://api.github.com/users/aseltmann/events{/privacy}","received_events_url":"https://api.github.com/users/aseltmann/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":978584226,"node_id":"MDU6TGFiZWw5Nzg1ODQyMjY=","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/docs","name":"area/docs","color":"48eabc","default":false,"description":"Documentation issues"},{"id":2022848043,"node_id":"MDU6TGFiZWwyMDIyODQ4MDQz","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/models","name":"area/models","color":"48eabc","default":false,"description":"MLmodel format, model serialization/deserialization, flavors"},{"id":2022848902,"node_id":"MDU6TGFiZWwyMDIyODQ4OTAy","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/scoring","name":"area/scoring","color":"48eabc","default":false,"description":"MLflow Model server, model deployment tools, Spark UDFs"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"},{"id":2022865338,"node_id":"MDU6TGFiZWwyMDIyODY1MzM4","url":"https://api.github.com/repos/mlflow/mlflow/labels/priority/important-longterm","name":"priority/important-longterm","color":"534cb5","default":false,"description":"Important over the long term, but may not be staffed or may need multiple releases to complete."}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-05-14T23:09:39Z","updated_at":"2020-10-21T11:03:40Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [x] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Manjaro Kernel: 5.5.19-1-MANJARO\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.8.0\r\n- **Python version**: 3.8.2\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: \r\n\r\n### Describe the problem\r\nI have trained a model using `tensorflow.keras` and logged the training using `mlflow.tensorflow.autolog(every_n_iter=1)`. My training data and test data comes as `tf.Datasets`. I construct the model using the TensorFlow Functional API. The model is serialisable and I am saving it using `model.save('data/exp-devtest/unet.tf', save_format='tf')`. Mlflow successfully logs the model (see other info / logs). I noticed some irregularities while trying to load this model and predict with it.\r\nI tried the following things (see below):\r\n- using the pyfunc model to predict the data with shape (1, 3, 1)→ problem: \"Must pass 2-d input\" → I guess since it expects a pandas DataFrame or similar. But this shape is not convertible to DataFrame (and I can not change that sadly...). \r\n- even if we reshape and give the pyfunc model data with shape (3, 1) → problem: the model was trained with (1, 3, 1), so we get a ValueError there.\r\n- I was actually able to load the model with `mlflow.keras.load_model()`. ~~While this works, at the same time `mlflow.keras.get_default_conda_env()` throws `ModuleNotFoundError: No module named 'keras'` - which is true, I don't have keras itself installed - but is that necessary to make this work, shouldn't `tensorflow.keras` be enough? If it is necessary, than it is confusing, that `mlflow.keras.load_model()` works.~~\r\n- could I just add a tensorflow flavour to the `MLmodel` file and load it with `mlflow.tensorflow.load_model`? Or does it actually make a difference to using `mlflow.keras.load_model` in this case, since the model class is already `<class 'tensorflow.python.keras.engine.sequential.Sequential'>`\r\n\r\n### Code to reproduce issue\r\nTrain a model\r\n```python\r\nimport sys\r\nimport mlflow\r\nimport mlflow.tensorflow\r\nimport numpy as np\r\nimport tensorflow as tf\r\n\r\nmlflow.tensorflow.autolog(every_n_iter=1)\r\n\r\ndata = np.array([[[5.1], [5.9], [6.9]], \r\n                 [[3.3], [3.0], [3.1]],\r\n                 [[1.7], [4.2], [5.4]],\r\n                 [[0.5], [1.5], [2.1]]])\r\nlabels = np.array([[[0], [1], [1]],\r\n                   [[1], [1], [0]],\r\n                   [[0], [1], [0]],\r\n                   [[0], [0], [1]]])\r\nprint(data.shape, labels.shape) # (4, 3, 1) (4, 3, 1)\r\n\r\ndata_tensor = tf.convert_to_tensor(value=data)\r\nlabels_tensor = tf.convert_to_tensor(value=labels)\r\nlabels_tensor = tf.cast(labels_tensor, tf.float32)\r\n\r\ndataset = tf.data.Dataset.from_tensor_slices((data_tensor, labels_tensor))\r\ndataset = dataset.shuffle(buffer_size=1000).repeat().batch(batch_size=2)\r\n\r\nmodel = tf.keras.models.Sequential([\r\n    tf.keras.layers.Dense(16, activation='relu', input_shape=(3, 1)),\r\n    tf.keras.layers.Dropout(0.2),\r\n    tf.keras.layers.Dense(3)\r\n])\r\noptimizer = tf.keras.optimizers.Adam(learning_rate=0.001)\r\nloss = tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)\r\n\r\nmodel.compile(loss=loss,\r\n              optimizer=optimizer,\r\n              metrics=['accuracy'])\r\nmodel.fit(x=x,\r\n          epochs=3,\r\n          steps_per_epoch=2)\r\n\r\nmodel.predict(data[0].reshape(1, -1, 1))\r\n# array([[[-0.9764497 , -1.236287  ,  0.59304774],\r\n#         [-1.1315356 , -1.4329386 ,  0.68833333],\r\n#         [-1.3253928 , -1.6787525 ,  0.8074404 ]]], dtype=float32)\r\n```\r\nThe model info can be seen below. We later load the model like this:\r\n```python\r\nclient = mlflow.tracking.MlflowClient(tracking_uri=mlflow.get_tracking_uri())\r\nrun_idx = 1\r\nmodel_path = client.download_artifacts(\r\n    run_id=runs.iloc[run_idx].run_id,\r\n    path='model')\r\nmodel_pyfunc = mlflow.pyfunc.load_model(model_path)\r\nprint(type(model_pyfunc)) \r\n# <class 'mlflow.keras._KerasModelWrapper'>\r\nmodel_pyfunc.predict(data[0].reshape(1, -1, 1))\r\n# ValueError: Must pass 2-d input \r\n# For log see below\r\nmodel_pyfunc.predict(data[0].reshape(-1, 1))\r\n# ValueError: Error when checking input: expected dense_2_input to have 3 dimensions, but got array with shape (3, 1)\r\n# For log see below\r\nmodel_keras = mlflow.keras.load_model(model_path)\r\nprint(type(model_keras))\r\n# <class 'tensorflow.python.keras.engine.sequential.Sequential'>\r\nmodel_keras.predict(data[0].reshape(1, -1, 1))\r\n# array([[[-0.9764497 , -1.236287  ,  0.59304774],\r\n#         [-1.1315356 , -1.4329386 ,  0.68833333],\r\n#         [-1.3253928 , -1.6787525 ,  0.8074404 ]]], dtype=float32)\r\n```\r\n\r\n### Other info / logs\r\nThese logs come from the test case code, which I executed on another machine - that's why the Python version is 3.7 here. But the tracebacks looked similar and I could not access the remote machine at the moment.\r\n\r\n```python\r\n>>> model.predict(data[0].reshape(1, -1, 1))\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-59-7cadbe6c606f> in <module>\r\n----> 1 model_pyfunc.predict(data[0].reshape(1, -1, 1))\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/mlflow/keras.py in predict(self, dataframe)\r\n    328         # In TensorFlow >= 2.0, we do not use a graph and session to predict\r\n    329         else:\r\n--> 330             predicted = pd.DataFrame(self.keras_model.predict(dataframe))\r\n    331         predicted.index = dataframe.index\r\n    332         return predicted\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/pandas/core/frame.py in __init__(self, data, index, columns, dtype, copy)\r\n    438                 mgr = init_dict({data.name: data}, index, columns, dtype=dtype)\r\n    439             else:\r\n--> 440                 mgr = init_ndarray(data, index, columns, dtype=dtype, copy=copy)\r\n    441 \r\n    442         # For data is list-like, or Iterable (will consume into list)\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/pandas/core/internals/construction.py in init_ndarray(values, index, columns, dtype, copy)\r\n    169     # by definition an array here\r\n    170     # the dtypes will be coerced to a single dtype\r\n--> 171     values = prep_ndarray(values, copy=copy)\r\n    172 \r\n    173     if dtype is not None:\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/pandas/core/internals/construction.py in prep_ndarray(values, copy)\r\n    293         values = values.reshape((values.shape[0], 1))\r\n    294     elif values.ndim != 2:\r\n--> 295         raise ValueError(\"Must pass 2-d input\")\r\n    296 \r\n    297     return values\r\n\r\nValueError: Must pass 2-d input\r\n```\r\n\r\n```python\r\n>>> model_pyfunc.predict(data[0].reshape(-1, 1))\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-60-8cdf9d1f028f> in <module>\r\n----> 1 model_pyfunc.predict(data[0].reshape(-1, 1))\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/mlflow/keras.py in predict(self, dataframe)\r\n    328         # In TensorFlow >= 2.0, we do not use a graph and session to predict\r\n    329         else:\r\n--> 330             predicted = pd.DataFrame(self.keras_model.predict(dataframe))\r\n    331         predicted.index = dataframe.index\r\n    332         return predicted\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py in predict(self, x, batch_size, verbose, steps, callbacks, max_queue_size, workers, use_multiprocessing)\r\n    907         max_queue_size=max_queue_size,\r\n    908         workers=workers,\r\n--> 909         use_multiprocessing=use_multiprocessing)\r\n    910 \r\n    911   def reset_metrics(self):\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_arrays.py in predict(self, model, x, batch_size, verbose, steps, callbacks, **kwargs)\r\n    713     batch_size = model._validate_or_infer_batch_size(batch_size, steps, x)\r\n    714     x, _, _ = model._standardize_user_data(\r\n--> 715         x, check_steps=True, steps_name='steps', steps=steps)\r\n    716     return predict_loop(\r\n    717         model,\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py in _standardize_user_data(self, x, y, sample_weight, class_weight, batch_size, check_steps, steps_name, steps, validation_split, shuffle, extract_tensors_from_dataset)\r\n   2470           feed_input_shapes,\r\n   2471           check_batch_axis=False,  # Don't enforce the batch size.\r\n-> 2472           exception_prefix='input')\r\n   2473 \r\n   2474     # Get typespecs for the input data and sanitize it if necessary.\r\n\r\n~/Programme/miniconda3/envs/tensorflow_env/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py in standardize_input_data(data, names, shapes, check_batch_axis, exception_prefix)\r\n    563                            ': expected ' + names[i] + ' to have ' +\r\n    564                            str(len(shape)) + ' dimensions, but got array '\r\n--> 565                            'with shape ' + str(data_shape))\r\n    566         if not check_batch_axis:\r\n    567           data_shape = data_shape[1:]\r\n\r\nValueError: Error when checking input: expected dense_2_input to have 3 dimensions, but got array with shape (3, 1)\r\n```\r\n\r\nThese are from my 3.8.2 machine.\r\n```yaml\r\n>>> ls $model_path\r\n    conda.yaml  data/  MLmodel\r\n\r\n>>> ls $model_path/data\r\n    keras_module.txt  model.h5\r\n\r\n>>> cat $model_path/MLmodel\r\n    artifact_path: model\r\n    flavors:\r\n      keras:\r\n        data: data\r\n        keras_module: tensorflow.keras\r\n        keras_version: 2.2.4-tf\r\n      python_function:\r\n        data: data\r\n        env: conda.yaml\r\n        loader_module: mlflow.keras\r\n        python_version: 3.8.2\r\n    run_id: 52764cca60c64d9bbdbf89293ef01f48\r\n    utc_time_created: '2020-05-14 14:36:15.881485'\r\n\r\n>>> cat $model_path/conda.yaml\r\n    channels:\r\n    - defaults\r\n    dependencies:\r\n    - python=3.8.2\r\n    - pip\r\n    - pip:\r\n      - mlflow\r\n      - tensorflow==2.2.0-dev20200506\r\n    name: mlflow-env\r\n\r\n>>> cat $model_path/data/keras_module.txt\r\n    tensorflow.keras\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [X] `area/docs`: MLflow documentation pages (maybe? I find little docs to N-dimensional data and wouldn't have thought that it will be a problem)\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for\r\nModel Registry\r\n- [X] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [X] `area/scoring`: Local serving, model deployment tools, spark UDFs\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging (maybe?)\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, JavaScript, plotting\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n\r\nEDIT 22/05/20: removed the remarks regarding `mlflow.keras.get_default_conda_env(keras_module=tf.keras)` - it works, I just forgot the `keras_module` parameter.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/2830/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/2830/timeline","performed_via_github_app":null,"state_reason":null}