{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1773","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1773/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1773/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1773/events","html_url":"https://github.com/mlflow/mlflow/issues/1773","id":484398981,"node_id":"MDU6SXNzdWU0ODQzOTg5ODE=","number":1773,"title":"[BUG] Deploying custom python models on azureml","user":{"login":"cymonti","id":52413238,"node_id":"MDQ6VXNlcjUyNDEzMjM4","avatar_url":"https://avatars.githubusercontent.com/u/52413238?v=4","gravatar_id":"","url":"https://api.github.com/users/cymonti","html_url":"https://github.com/cymonti","followers_url":"https://api.github.com/users/cymonti/followers","following_url":"https://api.github.com/users/cymonti/following{/other_user}","gists_url":"https://api.github.com/users/cymonti/gists{/gist_id}","starred_url":"https://api.github.com/users/cymonti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cymonti/subscriptions","organizations_url":"https://api.github.com/users/cymonti/orgs","repos_url":"https://api.github.com/users/cymonti/repos","events_url":"https://api.github.com/users/cymonti/events{/privacy}","received_events_url":"https://api.github.com/users/cymonti/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-08-23T08:28:53Z","updated_at":"2020-01-31T11:22:26Z","closed_at":"2019-09-01T11:50:23Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 19.04)**:\r\n- **MLflow installed from (source or binary)**: pip\r\n- **MLflow version : 1.2.0\r\n- **Python version**: 3.7.3\r\n\r\n### Describe the problem\r\nI am trying to deploy a custom python models on azureml. I built an image with mlflow command mlflow.azureml.build_image() and everything works well. However, when I try to deploy the image, I get the following errors (I used the example provided by mlflow : https://mlflow.org/docs/latest/python_api/mlflow.azureml.html).\r\n\r\n```\r\n2019-08-23T07:55:58,344543219+00:00 - gunicorn/run \r\n2019-08-23T07:55:58,349952130+00:00 - rsyslog/run \r\n2019-08-23T07:55:58,350110131+00:00 - iot-server/run \r\n2019-08-23T07:55:58,354993641+00:00 - nginx/run \r\nEdgeHubConnectionString and IOTEDGE_IOTHUBHOSTNAME are not set. Exiting...\r\n2019-08-23T07:55:58,587014416+00:00 - iot-server/finish 1 0\r\n2019-08-23T07:55:58,591098524+00:00 - Exit code 1 is normal. Not restarting iot-server.\r\nStarting gunicorn 19.6.0\r\nListening at: http://127.0.0.1:31311 (12)\r\nUsing worker: sync\r\nworker timeout is set to 300\r\nBooting worker with pid: 43\r\nInitializing logger\r\nStarting up app insights client\r\nStarting up request id generator\r\nStarting up app insight hooks\r\nInvoking user's init function\r\n2019-08-23 07:56:04,085 | azureml.core.run | DEBUG | Could not load run context RunEnvironmentException:\r\n\tMessage: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n\tInnerException None\r\n\tErrorResponse \r\n{\r\n    \"error\": {\r\n        \"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"\r\n    }\r\n}, switching offline: False\r\n2019-08-23 07:56:04,085 | azureml.core.run | DEBUG | Could not load the run context and allow_offline set to False\r\n2019-08-23 07:56:04,085 | azureml.core.model | DEBUG | RunEnvironmentException: RunEnvironmentException:\r\n\tMessage: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n\tInnerException RunEnvironmentException:\r\n\tMessage: Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\r\n\tInnerException None\r\n\tErrorResponse \r\n{\r\n    \"error\": {\r\n        \"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"\r\n    }\r\n}\r\n\tErrorResponse \r\n{\r\n    \"error\": {\r\n        \"message\": \"Could not load a submitted run, if outside of an execution context, use experiment.start_logging to initialize an azureml.core.Run.\"\r\n    }\r\n}\r\n2019-08-23 07:56:04,086 | azureml.core.model | DEBUG | Using passed in version 1\r\n2019-08-23 07:56:04,086 | azureml.core.model | DEBUG | Found model path at azureml-models/mlflow-bzjxjqqwrzyxvt2xlpr7ow/1/ad_short_name_model\r\nexecution_script.py:12: DeprecationWarning: .. Warning:: ``mlflow.pyfunc.load_pyfunc`` is deprecated since 1.0. This method will be removed in a near future release. Use ``mlflow.pyfunc.load_model`` instead.\r\n  model = load_pyfunc(model_path)\r\n2019/08/23 07:56:04 WARNING mlflow.pyfunc: The version of Python that the model was saved in, `Python 3.7.3`, differs from the version of Python that is currently running, `Python 3.6.8`, and may be incompatible\r\nXXX lineno: 44, opcode: 160\r\nUser's init function failed\r\n/opt/miniconda/lib/python3.6/site-packages/plac_ext.py:6: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses\r\n  import imp\r\n/opt/miniconda/lib/python3.6/site-packages/spacy/cli/converters/iob2json.py:24: DeprecationWarning: invalid escape sequence \\w\r\n  tokens = [re.split(\"[^\\w\\-]\", line.strip())]\r\nEncountered Exception Traceback (most recent call last):\r\n  File \"/var/azureml-server/aml_blueprint.py\", line 162, in register\r\n    main.init()\r\n  File \"/var/azureml-app/main.py\", line 88, in init\r\n    driver_module.init()\r\n  File \"execution_script.py\", line 12, in init\r\n    model = load_pyfunc(model_path)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/mlflow/utils/annotations.py\", line 40, in deprecated_func\r\n    return func(*args, **kwargs)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/mlflow/pyfunc/__init__.py\", line 313, in load_pyfunc\r\n    return importlib.import_module(conf[MAIN])._load_pyfunc(data_path)\r\n  File \"/opt/miniconda/lib/python3.6/site-packages/mlflow/pyfunc/model.py\", line 223, in _load_pyfunc\r\n    python_model.load_context(context=context)\r\n  File \"main.py\", line 44, in load_context\r\n    if run_supports_request_headers:\r\nSystemError: unknown opcode\r\n\r\nWorker exiting (pid: 43)\r\nShutting down: Master\r\nReason: Worker failed to boot.\r\n2019-08-23T07:56:04,512021494+00:00 - gunicorn/finish 3 0\r\n2019-08-23T07:56:04,513133796+00:00 - Exit code 3 is not normal. Killing image.\r\n```\r\n\r\n### Code to reproduce issue\r\n```python\r\nwebservice = Webservice.deploy_from_image(image=azure_image,workspace=azure_workspace, name=\"<deployment-name>\")\r\n```\r\n","closed_by":{"login":"cymonti","id":52413238,"node_id":"MDQ6VXNlcjUyNDEzMjM4","avatar_url":"https://avatars.githubusercontent.com/u/52413238?v=4","gravatar_id":"","url":"https://api.github.com/users/cymonti","html_url":"https://github.com/cymonti","followers_url":"https://api.github.com/users/cymonti/followers","following_url":"https://api.github.com/users/cymonti/following{/other_user}","gists_url":"https://api.github.com/users/cymonti/gists{/gist_id}","starred_url":"https://api.github.com/users/cymonti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cymonti/subscriptions","organizations_url":"https://api.github.com/users/cymonti/orgs","repos_url":"https://api.github.com/users/cymonti/repos","events_url":"https://api.github.com/users/cymonti/events{/privacy}","received_events_url":"https://api.github.com/users/cymonti/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1773/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1773/timeline","performed_via_github_app":null,"state_reason":"completed"}