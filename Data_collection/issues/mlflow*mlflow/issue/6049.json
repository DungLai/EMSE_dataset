{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6049","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6049/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6049/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6049/events","html_url":"https://github.com/mlflow/mlflow/issues/6049","id":1268576533,"node_id":"I_kwDOCB5Jx85LnPEV","number":6049,"title":"[FR] Automatically split metrics, tags, etc into smaller chunks to avoid request limit error","user":{"login":"nzw0301","id":7121753,"node_id":"MDQ6VXNlcjcxMjE3NTM=","avatar_url":"https://avatars.githubusercontent.com/u/7121753?v=4","gravatar_id":"","url":"https://api.github.com/users/nzw0301","html_url":"https://github.com/nzw0301","followers_url":"https://api.github.com/users/nzw0301/followers","following_url":"https://api.github.com/users/nzw0301/following{/other_user}","gists_url":"https://api.github.com/users/nzw0301/gists{/gist_id}","starred_url":"https://api.github.com/users/nzw0301/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nzw0301/subscriptions","organizations_url":"https://api.github.com/users/nzw0301/orgs","repos_url":"https://api.github.com/users/nzw0301/repos","events_url":"https://api.github.com/users/nzw0301/events{/privacy}","received_events_url":"https://api.github.com/users/nzw0301/received_events","type":"User","site_admin":false},"labels":[{"id":955449434,"node_id":"MDU6TGFiZWw5NTU0NDk0MzQ=","url":"https://api.github.com/repos/mlflow/mlflow/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/mlflow/mlflow/milestones/3","html_url":"https://github.com/mlflow/mlflow/milestone/3","labels_url":"https://api.github.com/repos/mlflow/mlflow/milestones/3/labels","id":7155995,"node_id":"MI_kwDOCB5Jx84AbTEb","number":3,"title":"MLflow Roadmap","description":"We are looking for help from the community to implement many of these features and bug fixes, which are annotated with the ``help wanted`` label. If you are interested in contributing to the implementation of one or more of these roadmap items, please leave a comment on the corresponding GitHub issue and we will assign a maintainer to support your development (if needed) efforts and aid in getting this feature merged.\r\nPlease carefully review the details within the issue and understand the scope of the implementation as marked within the issue prior to agreeing to take on the implementation work.","creator":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"open_issues":11,"closed_issues":21,"state":"open","created_at":"2021-09-15T20:15:38Z","updated_at":"2023-01-09T04:13:10Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2022-06-12T13:08:33Z","updated_at":"2022-06-23T18:55:10Z","closed_at":"2022-06-23T18:55:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Willingness to contribute\r\n\r\nYes. I would be willing to contribute this feature with guidance from the MLflow community.\r\n\r\n### Proposal Summary\r\n\r\nAs in the title, MLflow might be able to avoid request limits by automatically splitting data that contains too many elements into smaller ones when we call `mlflow.log_metrics`, `mlflow.log_params`, and `mlflow.set_tags` (possible other API, too).   \r\n\r\n\r\n### Motivation\r\n\r\n> #### What is the use case for this feature?\r\n\r\nSuppose `mlflow.log_metrics` case. We would like to save many parameters at once as follows:\r\n\r\n```python\r\nimport mlflow\r\n\r\n\r\nmetrics = {f\"param_{i}\": i for i in range(mlflow.utils.validation.MAX_METRICS_PER_BATCH+1)}\r\n\r\n# Log a batch of metrics\r\nwith mlflow.start_run():\r\n    mlflow.log_metrics(metrics)\r\n```\r\n\r\nHowever, mlflow yields the following error:\r\n\r\n```\r\nFile /opt/homebrew/Caskroom/miniconda/base/envs/optuna/lib/python3.9/site-packages/mlflow/utils/validation.py:296, in _validate_batch_limit(entity_name, limit, length)\r\n    290 if length > limit:\r\n    291     error_msg = (\r\n    292         \"A batch logging request can contain at most {limit} {name}. \"\r\n    293         \"Got {count} {name}. Please split up {name} across multiple requests and try \"\r\n    294         \"again.\"\r\n    295     ).format(name=entity_name, count=length, limit=limit)\r\n--> 296     raise MlflowException(error_msg, error_code=INVALID_PARAMETER_VALUE)\r\n\r\nMlflowException: A batch logging request can contain at most 1000 metrics. Got 1001 metrics. Please split up metrics across multiple requests and try again.\r\n```\r\n\r\n> #### Why is this use case valuable to support for MLflow users in general?\r\n\r\nTo avoid this, users need to split `metrics` into smaller subsets like \r\n\r\n```python\r\nfrom itertools import islice\r\nimport mlflow\r\n\r\n\r\nmetrics = {f\"param_{i}\": i for i in range(mlflow.utils.validation.MAX_METRICS_PER_BATCH+1)}\r\n\r\n\r\n# Log a batch of metrics\r\nwith mlflow.start_run():\r\n    if len(metrics) > mlflow.utils.validation.MAX_METRICS_PER_BATCH:\r\n        it = iter(metrics)\r\n        for _ in range(0, len(metrics), mlflow.utils.validation.MAX_METRICS_PER_BATCH):\r\n            sub_metrics = {k: metrics[k] for k in islice(it, mlflow.utils.validation.MAX_METRICS_PER_BATCH)}\r\n            mlflow.log_metrics(sub_metrics)\r\n    else:\r\n        mlflow.log_metrics(metrics)\r\n```\r\n\r\nI suppose this can handle in `mlflow.log_metrics`. By doing so, users do not need to care about the number of elements of `metrics`. \r\n\r\n> #### Why is this use case valuable to support for your project(s) or organization?\r\n\r\nI'm from [optuna](https://github.com/optuna/optuna), a black-box optimisation framework library, community. Optuna provides an MLFlow callback that enables us to save optimisation results by using MLFlow API. If this feature request can be done by MLFlow side, we do not need the added changes by https://github.com/optuna/optuna/pull/3651.\r\n\r\n> #### Why is it currently difficult to achieve this use case?\r\n\r\nN/A\r\n\r\n### Details\r\n\r\n_No response_\r\n\r\n### What component(s) does this bug affect?\r\n\r\n- [ ] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\n### What interface(s) does this bug affect?\r\n\r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\n### What language(s) does this bug affect?\r\n\r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\n### What integration(s) does this bug affect?\r\n\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6049/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":2,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6049/timeline","performed_via_github_app":null,"state_reason":"completed"}