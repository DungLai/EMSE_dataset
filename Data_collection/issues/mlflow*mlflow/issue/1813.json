{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1813","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1813/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1813/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1813/events","html_url":"https://github.com/mlflow/mlflow/issues/1813","id":489590136,"node_id":"MDU6SXNzdWU0ODk1OTAxMzY=","number":1813,"title":"[BUG] Mlfow client is failing to write artifacts to s3, AWS Access Key Id doesn't exist in our records","user":{"login":"tarekmehrez","id":1910918,"node_id":"MDQ6VXNlcjE5MTA5MTg=","avatar_url":"https://avatars.githubusercontent.com/u/1910918?v=4","gravatar_id":"","url":"https://api.github.com/users/tarekmehrez","html_url":"https://github.com/tarekmehrez","followers_url":"https://api.github.com/users/tarekmehrez/followers","following_url":"https://api.github.com/users/tarekmehrez/following{/other_user}","gists_url":"https://api.github.com/users/tarekmehrez/gists{/gist_id}","starred_url":"https://api.github.com/users/tarekmehrez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tarekmehrez/subscriptions","organizations_url":"https://api.github.com/users/tarekmehrez/orgs","repos_url":"https://api.github.com/users/tarekmehrez/repos","events_url":"https://api.github.com/users/tarekmehrez/events{/privacy}","received_events_url":"https://api.github.com/users/tarekmehrez/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-09-05T07:57:24Z","updated_at":"2019-09-06T13:17:02Z","closed_at":"2019-09-06T13:17:02Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n\r\n- **OS Platform and Distribution: macOS 10.14.6**\r\n- **MLflow installed: using pip**\r\n- **MLflow version: version 1.1.0**\r\n- **Python version: *3.6* **\r\n\r\n### Describe the problem\r\nMy setup is working as follows:\r\n- Mlflow service running on kuberntes\r\n- A client on my machine where I am trying to create new experiments and log some files\r\n\r\nProblem:\r\n- I cannot log artifacts to s3 (minio in my case) from the client. \r\n- It seems that the connection to s3 is working as expected since I can log artifacts to the experiment using the cli from the service container itself, by running:\r\n`mlflow artifacts log-artifact -r <id> -l <local_file>`\r\n- However when i try to log artifacts from the client (code below) I get an error that s3 credentials are not recognized\r\n- running `aws configure` and adding the credentials, or setting the env vars `AWS_SECRET_ACCESS_KEY` and   `AWS_ACCESS_KEY_ID` didn't help either.\r\n\r\n\r\n\r\n### Code to reproduce issue\r\n```python\r\nrun_id = '1f3bccf78b3048a48a0e95aafc6e0032'\r\nwith mlflow.start_run(run_id) as _:\r\n\r\n    # test1 and test2 are files in the same dir\r\n    for path in ['test1', 'test2']:\r\n        mlflow.log_artifact(path)\r\n```\r\n\r\n### Other info / logs\r\n```\r\n---------------------------------------------------------------------------\r\nClientError                               Traceback (most recent call last)\r\n~/.envs/mlflow/lib/python3.7/site-packages/boto3/s3/transfer.py in upload_file(self, filename, bucket, key, callback, extra_args)\r\n    278         try:\r\n--> 279             future.result()\r\n    280         # If a client error was raised, add the backwards compatibility layer\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/s3transfer/futures.py in result(self)\r\n    105             # out of this and propogate the exception.\r\n--> 106             return self._coordinator.result()\r\n    107         except KeyboardInterrupt as e:\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/s3transfer/futures.py in result(self)\r\n    264         if self._exception:\r\n--> 265             raise self._exception\r\n    266         return self._result\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/s3transfer/tasks.py in __call__(self)\r\n    125             if not self._transfer_coordinator.done():\r\n--> 126                 return self._execute_main(kwargs)\r\n    127         except Exception as e:\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/s3transfer/tasks.py in _execute_main(self, kwargs)\r\n    149 \r\n--> 150         return_value = self._main(**kwargs)\r\n    151         # If the task is the final task, then set the TransferFuture's\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/s3transfer/upload.py in _main(self, client, fileobj, bucket, key, extra_args)\r\n    691         with fileobj as body:\r\n--> 692             client.put_object(Bucket=bucket, Key=key, Body=body, **extra_args)\r\n    693 \r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/botocore/client.py in _api_call(self, *args, **kwargs)\r\n    356             # The \"self\" in this scope is referring to the BaseClient.\r\n--> 357             return self._make_api_call(operation_name, kwargs)\r\n    358 \r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/botocore/client.py in _make_api_call(self, operation_name, api_params)\r\n    660             error_class = self.exceptions.from_code(error_code)\r\n--> 661             raise error_class(parsed_response, operation_name)\r\n    662         else:\r\n\r\nClientError: An error occurred (InvalidAccessKeyId) when calling the PutObject operation: The AWS Access Key Id you provided does not exist in our records.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nS3UploadFailedError                       Traceback (most recent call last)\r\n<ipython-input-17-1444f0b96073> in <module>\r\n      2 # with mlflow.start_run(run_id) as _:\r\n      3 for path in ['test4', 'test5']:\r\n----> 4     mlflow.log_artifact(path)\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/mlflow/tracking/fluent.py in log_artifact(local_path, artifact_path)\r\n    264     \"\"\"\r\n    265     run_id = _get_or_start_run().info.run_id\r\n--> 266     MlflowClient().log_artifact(run_id, local_path, artifact_path)\r\n    267 \r\n    268 \r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/mlflow/tracking/client.py in log_artifact(self, run_id, local_path, artifact_path)\r\n    226         run = self.get_run(run_id)\r\n    227         artifact_repo = get_artifact_repository(run.info.artifact_uri)\r\n--> 228         artifact_repo.log_artifact(local_path, artifact_path)\r\n    229 \r\n    230     def log_artifacts(self, run_id, local_dir, artifact_path=None):\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/mlflow/store/s3_artifact_repo.py in log_artifact(self, local_file, artifact_path)\r\n     36             dest_path, os.path.basename(local_file))\r\n     37         s3_client = self._get_s3_client()\r\n---> 38         s3_client.upload_file(local_file, bucket, dest_path)\r\n     39 \r\n     40     def log_artifacts(self, local_dir, artifact_path=None):\r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/boto3/s3/inject.py in upload_file(self, Filename, Bucket, Key, ExtraArgs, Callback, Config)\r\n    129         return transfer.upload_file(\r\n    130             filename=Filename, bucket=Bucket, key=Key,\r\n--> 131             extra_args=ExtraArgs, callback=Callback)\r\n    132 \r\n    133 \r\n\r\n~/.envs/mlflow/lib/python3.7/site-packages/boto3/s3/transfer.py in upload_file(self, filename, bucket, key, callback, extra_args)\r\n    285             raise S3UploadFailedError(\r\n    286                 \"Failed to upload %s to %s: %s\" % (\r\n--> 287                     filename, '/'.join([bucket, key]), e))\r\n    288 \r\n    289     def download_file(self, bucket, key, filename, extra_args=None,\r\n\r\nS3UploadFailedError: Failed to upload test1 to ./mlflow-adapter-test/1f3bccf78b3048a48a0e95aafc6e0032/artifacts/test1: An error occurred (InvalidAccessKeyId) when calling the PutObject operation: The AWS Access Key Id you provided does not exist in our records.\r\n\r\n```\r\n","closed_by":{"login":"tarekmehrez","id":1910918,"node_id":"MDQ6VXNlcjE5MTA5MTg=","avatar_url":"https://avatars.githubusercontent.com/u/1910918?v=4","gravatar_id":"","url":"https://api.github.com/users/tarekmehrez","html_url":"https://github.com/tarekmehrez","followers_url":"https://api.github.com/users/tarekmehrez/followers","following_url":"https://api.github.com/users/tarekmehrez/following{/other_user}","gists_url":"https://api.github.com/users/tarekmehrez/gists{/gist_id}","starred_url":"https://api.github.com/users/tarekmehrez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tarekmehrez/subscriptions","organizations_url":"https://api.github.com/users/tarekmehrez/orgs","repos_url":"https://api.github.com/users/tarekmehrez/repos","events_url":"https://api.github.com/users/tarekmehrez/events{/privacy}","received_events_url":"https://api.github.com/users/tarekmehrez/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1813/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1813/timeline","performed_via_github_app":null,"state_reason":"completed"}