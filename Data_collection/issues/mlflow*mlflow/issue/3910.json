{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3910","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/3910/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/3910/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/3910/events","html_url":"https://github.com/mlflow/mlflow/issues/3910","id":774748068,"node_id":"MDU6SXNzdWU3NzQ3NDgwNjg=","number":3910,"title":"[BUG] TF2/Keras autologging failed to log model with default h5 save format","user":{"login":"nemanja-m","id":20483530,"node_id":"MDQ6VXNlcjIwNDgzNTMw","avatar_url":"https://avatars.githubusercontent.com/u/20483530?v=4","gravatar_id":"","url":"https://api.github.com/users/nemanja-m","html_url":"https://github.com/nemanja-m","followers_url":"https://api.github.com/users/nemanja-m/followers","following_url":"https://api.github.com/users/nemanja-m/following{/other_user}","gists_url":"https://api.github.com/users/nemanja-m/gists{/gist_id}","starred_url":"https://api.github.com/users/nemanja-m/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nemanja-m/subscriptions","organizations_url":"https://api.github.com/users/nemanja-m/orgs","repos_url":"https://api.github.com/users/nemanja-m/repos","events_url":"https://api.github.com/users/nemanja-m/events{/privacy}","received_events_url":"https://api.github.com/users/nemanja-m/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-12-25T15:20:23Z","updated_at":"2021-02-04T16:30:38Z","closed_at":"2021-02-04T16:30:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [ ] Yes. I can contribute a fix for this bug independently.\r\n- [x] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\nMLflow Version: 1.13.0\r\nTensorFlow version: 2.3.1\r\nPython Version: 3.8.5\r\nOperating System: Mac OS X 10.15.6 19G2021\r\n\r\n### Describe the problem\r\n\r\nKeras/TF2 models can be saved in the `SavedModel` format from the MLflow version 1.13.0 when `saved_format='tf'` is provided to `mlflow.keras.log_model`. When `mlflow.tensorflow.autolog(log_models=True)` is used, some trained models can't be saved on the train end callback in the default 'h5' format.\r\n\r\nIt seems that this happens because of https://github.com/mlflow/mlflow/blob/cbe0627428bc2692d851f4180a2ea59073040a63/mlflow/tensorflow.py#L779-L781 This callback calls `mlflow.keras.log_model` with default save format, which is `h5`.\r\n\r\nOne way to address this is to update `mlflow.tensorflow.autolog` with the `save_format: str = 'h5'` parameter, and propagate `save_format` option to callbacks.\r\n\r\n### Code to reproduce issue\r\n\r\n```python\r\nimport mlflow\r\nimport mlflow.tensorflow\r\nimport tensorflow as tf\r\nfrom tensorflow.keras.layers.experimental.preprocessing import TextVectorization\r\n\r\nVOCAB_SIZE = 10\r\nSEQUENCE_LENGTH = 16\r\nEMBEDDING_DIM = 32\r\n\r\ntrain_samples = [\"this is an example\", \"another example\"]\r\ntrain_labels = [0.43, 0.23]\r\n\r\nmlflow.tensorflow.autolog()\r\n\r\nwith mlflow.start_run():\r\n    vectorizer_layer = TextVectorization(\r\n        input_shape=(1,),\r\n        max_tokens=VOCAB_SIZE,\r\n        output_mode=\"int\",\r\n        output_sequence_length=SEQUENCE_LENGTH,\r\n    )\r\n    vectorizer_layer.adapt(train_samples)\r\n\r\n    model = tf.keras.Sequential(\r\n        [\r\n            vectorizer_layer,\r\n            tf.keras.layers.Embedding(\r\n                VOCAB_SIZE,\r\n                EMBEDDING_DIM,\r\n                name=\"embedding\",\r\n                mask_zero=True,\r\n                input_shape=(1,),\r\n            ),\r\n            tf.keras.layers.GlobalAveragePooling1D(),\r\n            tf.keras.layers.Dense(32, activation=\"relu\"),\r\n            tf.keras.layers.Dense(1, activation=\"tanh\"),\r\n        ]\r\n    )\r\n    model.compile(optimizer=\"adam\", loss=\"mse\", metrics=\"mae\")\r\n    model.fit(train_samples, train_labels, epochs=1)\r\n```\r\n\r\n### Other info / logs\r\n\r\n```\r\n2020/12/25 16:15:23 INFO mlflow.utils.autologging_utils: tensorflow autologging will track hyperparameters, performance metrics, model artifacts, and lineage information for the current tensorflow workflow to the MLflow run with ID '334a468262d64e7392594a859d2e7da5'\r\n2020-12-25 16:15:23.657399: I tensorflow/core/profiler/lib/profiler_session.cc:164] Profiler session started.\r\n1/1 [==============================] - 0s 31ms/step - loss: 0.1191 - mae: 0.3325\r\n2020/12/25 16:15:24 WARNING mlflow.utils.autologging_utils: MLflow issued a warning during tensorflow autologging: \"/Users/user/.pyenv/versions/example/lib/python3.8/site-packages/mlflow/tensorflow.py:786: UserWarning: Logging to MLflow failed: Save or restore weights that is not an instance of `tf.Variable` is not supported in h5, use `save_format='tf'` instead. Got a model or layer TextVectorization with weights [<tensorflow.python.keras.engine.base_layer_utils.TrackableWeightHandler object at 0x14f40a460>]\"\r\n```\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\n\r\n- [x] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n","closed_by":{"login":"harupy","id":17039389,"node_id":"MDQ6VXNlcjE3MDM5Mzg5","avatar_url":"https://avatars.githubusercontent.com/u/17039389?v=4","gravatar_id":"","url":"https://api.github.com/users/harupy","html_url":"https://github.com/harupy","followers_url":"https://api.github.com/users/harupy/followers","following_url":"https://api.github.com/users/harupy/following{/other_user}","gists_url":"https://api.github.com/users/harupy/gists{/gist_id}","starred_url":"https://api.github.com/users/harupy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harupy/subscriptions","organizations_url":"https://api.github.com/users/harupy/orgs","repos_url":"https://api.github.com/users/harupy/repos","events_url":"https://api.github.com/users/harupy/events{/privacy}","received_events_url":"https://api.github.com/users/harupy/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/3910/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/3910/timeline","performed_via_github_app":null,"state_reason":"completed"}