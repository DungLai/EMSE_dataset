{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1728","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/1728/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/1728/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/1728/events","html_url":"https://github.com/mlflow/mlflow/issues/1728","id":479689681,"node_id":"MDU6SXNzdWU0Nzk2ODk2ODE=","number":1728,"title":"[BUG] call tree multiplication in FileStore leading to excessive YAML load","user":{"login":"tolomea","id":805072,"node_id":"MDQ6VXNlcjgwNTA3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/805072?v=4","gravatar_id":"","url":"https://api.github.com/users/tolomea","html_url":"https://github.com/tolomea","followers_url":"https://api.github.com/users/tolomea/followers","following_url":"https://api.github.com/users/tolomea/following{/other_user}","gists_url":"https://api.github.com/users/tolomea/gists{/gist_id}","starred_url":"https://api.github.com/users/tolomea/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolomea/subscriptions","organizations_url":"https://api.github.com/users/tolomea/orgs","repos_url":"https://api.github.com/users/tolomea/repos","events_url":"https://api.github.com/users/tolomea/events{/privacy}","received_events_url":"https://api.github.com/users/tolomea/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1554650079,"node_id":"MDU6TGFiZWwxNTU0NjUwMDc5","url":"https://api.github.com/repos/mlflow/mlflow/labels/stale","name":"stale","color":"828282","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-08-12T14:50:33Z","updated_at":"2019-11-12T18:49:47Z","closed_at":"2019-11-12T18:49:47Z","author_association":"NONE","active_lock_reason":null,"body":"### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: We have a library that wraps MLFLOW\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac Darwin 18.6.0\r\n- **MLflow installed from (source or binary)**: Pip\r\n- **MLflow version (run ``mlflow --version``)**: 1.0.0\r\n- **Python version**: 3.7.3\r\n- **npm version, if running the dev UI**: n/a\r\n- **Exact command to reproduce**: n/a\r\n\r\n### Describe the problem\r\nWe have a library built on top of mlflow. Profiling the test suite for our library I noticed it was spending a lot of time doing an excessive number of yaml loads. The following call paths within the filestore seem to be the cause of this.\r\n\r\n1: 4x multiplication down tree from `get_run`\r\n`get_run` calls `get_all_metrics`, `get_all_tags` and `get_all_params`\r\nthese each call `_get_run_files` which in turn calls `_get_run_info`\r\n`_get_run_info` is also called by `get_run`\r\n`_get_run_info` calls read_yaml\r\nThis results in 4 calls to read_yaml for each call to get_run.\r\nA simple fix for this would be having `get_run` call `_get_run_info` and then call `_get_run_files` passing the result of `_get_run_info` and then pass the results of `_get_run_files` into `get_all_metrics`, `get_all_tags` and `get_all_params.\r\n\r\n2: N+1 multiplication from `log_batch` to `get_run`\r\n`log_batch` calls `get_run` and then unspools the batch into `log_metric` / `log_param` which also call `get_run`.\r\nThis results in N+1 calls to `get_run` per call to `log_batch`.  \r\nA simple fix for this would be having `log_batch` pass the run into `log_metric` / `log_param` via an optional argument and only have them call `get_run` if it's not passed .\r\n\r\n3: N(tags) multiplication from `create_run` to `get_run`\r\n`create_run` calls `create_tag` per tag and `create_tag` calls `get_run`.\r\nThis results in a call to `get_run` per tag.\r\n\r\nAlternatively some of this could be handled by caching the results of `get_run`.\r\n\r\n\r\n","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/1728/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/1728/timeline","performed_via_github_app":null,"state_reason":"completed"}