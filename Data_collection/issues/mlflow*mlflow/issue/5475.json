{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5475","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/5475/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/5475/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/5475/events","html_url":"https://github.com/mlflow/mlflow/issues/5475","id":1164453441,"node_id":"I_kwDOCB5Jx85FaCZB","number":5475,"title":"[BUG] EvaluationResult from DefaultEvaluator throws ValueError (unknown file extension) when calling .save()","user":{"login":"MarkYHZhang","id":9274754,"node_id":"MDQ6VXNlcjkyNzQ3NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9274754?v=4","gravatar_id":"","url":"https://api.github.com/users/MarkYHZhang","html_url":"https://github.com/MarkYHZhang","followers_url":"https://api.github.com/users/MarkYHZhang/followers","following_url":"https://api.github.com/users/MarkYHZhang/following{/other_user}","gists_url":"https://api.github.com/users/MarkYHZhang/gists{/gist_id}","starred_url":"https://api.github.com/users/MarkYHZhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarkYHZhang/subscriptions","organizations_url":"https://api.github.com/users/MarkYHZhang/orgs","repos_url":"https://api.github.com/users/MarkYHZhang/repos","events_url":"https://api.github.com/users/MarkYHZhang/events{/privacy}","received_events_url":"https://api.github.com/users/MarkYHZhang/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022845866,"node_id":"MDU6TGFiZWwyMDIyODQ1ODY2","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/artifacts","name":"area/artifacts","color":"48eabc","default":false,"description":"Artifact stores and artifact logging"}],"state":"closed","locked":false,"assignee":{"login":"MarkYHZhang","id":9274754,"node_id":"MDQ6VXNlcjkyNzQ3NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9274754?v=4","gravatar_id":"","url":"https://api.github.com/users/MarkYHZhang","html_url":"https://github.com/MarkYHZhang","followers_url":"https://api.github.com/users/MarkYHZhang/followers","following_url":"https://api.github.com/users/MarkYHZhang/following{/other_user}","gists_url":"https://api.github.com/users/MarkYHZhang/gists{/gist_id}","starred_url":"https://api.github.com/users/MarkYHZhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarkYHZhang/subscriptions","organizations_url":"https://api.github.com/users/MarkYHZhang/orgs","repos_url":"https://api.github.com/users/MarkYHZhang/repos","events_url":"https://api.github.com/users/MarkYHZhang/events{/privacy}","received_events_url":"https://api.github.com/users/MarkYHZhang/received_events","type":"User","site_admin":false},"assignees":[{"login":"MarkYHZhang","id":9274754,"node_id":"MDQ6VXNlcjkyNzQ3NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9274754?v=4","gravatar_id":"","url":"https://api.github.com/users/MarkYHZhang","html_url":"https://github.com/MarkYHZhang","followers_url":"https://api.github.com/users/MarkYHZhang/followers","following_url":"https://api.github.com/users/MarkYHZhang/following{/other_user}","gists_url":"https://api.github.com/users/MarkYHZhang/gists{/gist_id}","starred_url":"https://api.github.com/users/MarkYHZhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarkYHZhang/subscriptions","organizations_url":"https://api.github.com/users/MarkYHZhang/orgs","repos_url":"https://api.github.com/users/MarkYHZhang/repos","events_url":"https://api.github.com/users/MarkYHZhang/events{/privacy}","received_events_url":"https://api.github.com/users/MarkYHZhang/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-03-09T21:20:40Z","updated_at":"2022-03-17T19:41:52Z","closed_at":"2022-03-17T19:41:52Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"### Willingness to contribute\r\nThe MLflow Community encourages bug fix contributions. Would you or another member of your organization be willing to contribute a fix for this bug to the MLflow code base?\r\n\r\n- [x] Yes. I can contribute a fix for this bug independently.\r\n- [ ] Yes. I would be willing to contribute a fix for this bug with guidance from the MLflow community.\r\n- [ ] No. I cannot contribute a bug fix at this time.\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in MLflow)**: Added one additional line.\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MacOS Big Sur\r\n- **MLflow installed from (source or binary)**: binary\r\n- **MLflow version (run ``mlflow --version``)**: 1.24.0\r\n- **Python version**: 3.9.7\r\n- **npm version, if running the dev UI**:\r\n- **Exact command to reproduce**: Add `result.save(\"output\")` to the end of [`evaluate_on_regressor.py`](https://github.com/mlflow/mlflow/blob/master/examples%2Fevaluation%2Fevaluate_on_regressor.py). Then `python mlflow/examples/evaluation/evaluate_on_regressor.py`\r\n\r\n### Describe the problem\r\nThis error occurs because `ImageEvaluationArtifact` relies on [pillow's save() method](https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.Image.save). It infers the image format based on the provided path's file extension. However, the provided path to [`EvaluationResult.save`](https://github.com/mlflow/mlflow/blob/78df312065d73cbd117767157a72cc68ae176d35/mlflow/models/evaluation/base.py#L135) by `DefaultEvaluator` from [here](https://github.com/mlflow/mlflow/blob/4c38389e15e44b8ac2bc00ab89d7b288d2f1e9da/mlflow/models/evaluation/default_evaluator.py#L381) consists of only the artifact's name (without extension).\r\n\r\n### Code to reproduce issue\r\n```python\r\nimport mlflow\r\nfrom sklearn.datasets import fetch_california_housing\r\nfrom sklearn.linear_model import LinearRegression\r\nfrom sklearn.model_selection import train_test_split\r\n\r\nmlflow.sklearn.autolog()\r\n\r\ncalifornia_housing_data = fetch_california_housing()\r\n\r\nX_train, X_test, y_train, y_test = train_test_split(\r\n    california_housing_data.data, california_housing_data.target, test_size=0.33, random_state=42\r\n)\r\n\r\nwith mlflow.start_run() as run:\r\n    model = LinearRegression().fit(X_train, y_train)\r\n    model_uri = mlflow.get_artifact_uri(\"model\")\r\n\r\n    result = mlflow.evaluate(\r\n        model_uri,\r\n        X_test,\r\n        targets=y_test,\r\n        model_type=\"regressor\",\r\n        dataset_name=\"california_housing\",\r\n        evaluators=\"default\",\r\n        feature_names=california_housing_data.feature_names,\r\n        evaluator_config={\"explainability_nsamples\": 1000},\r\n    )\r\nresult.save(\"output\")\r\n```\r\n\r\n### Other info / logs\r\n```console\r\n---------------------------------------------------------------------------\r\nKeyError                                  Traceback (most recent call last)\r\n/usr/local/anaconda3/lib/python3.9/site-packages/PIL/Image.py in save(self, fp, format, **params)\r\n   2219             try:\r\n-> 2220                 format = EXTENSION[ext]\r\n   2221             except KeyError as e:\r\n\r\nKeyError: ''\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nValueError                                Traceback (most recent call last)\r\n/var/folders/5d/lcq9fgm918l8mg8vlbcq4d0c0000gp/T/ipykernel_77385/2290762558.py in <module>\r\n     26         evaluator_config={\"explainability_nsamples\": 1000},\r\n     27     )\r\n---> 28 result.save(\"output\")\r\n\r\n/usr/local/anaconda3/lib/python3.9/site-packages/mlflow/models/evaluation/base.py in save(self, path)\r\n    133 \r\n    134         for artifact_name, artifact in self.artifacts.items():\r\n--> 135             artifact._save(os.path.join(artifacts_dir, artifact_name))\r\n    136 \r\n    137     @property\r\n\r\n/usr/local/anaconda3/lib/python3.9/site-packages/mlflow/models/evaluation/artifacts.py in _save(self, output_artifact_path)\r\n      6 class ImageEvaluationArtifact(EvaluationArtifact):\r\n      7     def _save(self, output_artifact_path):\r\n----> 8         self._content.save(output_artifact_path)\r\n      9 \r\n     10     def _load_content_from_file(self, local_artifact_path):\r\n\r\n/usr/local/anaconda3/lib/python3.9/site-packages/PIL/Image.py in save(self, fp, format, **params)\r\n   2220                 format = EXTENSION[ext]\r\n   2221             except KeyError as e:\r\n-> 2222                 raise ValueError(f\"unknown file extension: {ext}\") from e\r\n   2223 \r\n   2224         if format.upper() not in SAVE:\r\n\r\nValueError: unknown file extension: \r\n```\r\n\r\n\r\n\r\n### What component(s), interfaces, languages, and integrations does this bug affect?\r\nComponents \r\n- [x] `area/artifacts`: Artifact stores and artifact logging\r\n- [ ] `area/build`: Build and test infrastructure for MLflow\r\n- [ ] `area/docs`: MLflow documentation pages\r\n- [ ] `area/examples`: Example code\r\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\r\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\r\n- [ ] `area/projects`: MLproject format, project running backends\r\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\r\n- [ ] `area/server-infra`: MLflow Tracking server backend\r\n- [ ] `area/tracking`: Tracking Service, tracking client APIs, autologging\r\n\r\nInterface \r\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\r\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\r\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\r\n- [ ] `area/windows`: Windows support\r\n\r\nLanguage \r\n- [ ] `language/r`: R APIs and clients\r\n- [ ] `language/java`: Java APIs and clients\r\n- [ ] `language/new`: Proposals for new client languages\r\n\r\nIntegrations\r\n- [ ] `integrations/azure`: Azure and Azure ML integrations\r\n- [ ] `integrations/sagemaker`: SageMaker integrations\r\n- [ ] `integrations/databricks`: Databricks integrations\r\n","closed_by":{"login":"MarkYHZhang","id":9274754,"node_id":"MDQ6VXNlcjkyNzQ3NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9274754?v=4","gravatar_id":"","url":"https://api.github.com/users/MarkYHZhang","html_url":"https://github.com/MarkYHZhang","followers_url":"https://api.github.com/users/MarkYHZhang/followers","following_url":"https://api.github.com/users/MarkYHZhang/following{/other_user}","gists_url":"https://api.github.com/users/MarkYHZhang/gists{/gist_id}","starred_url":"https://api.github.com/users/MarkYHZhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarkYHZhang/subscriptions","organizations_url":"https://api.github.com/users/MarkYHZhang/orgs","repos_url":"https://api.github.com/users/MarkYHZhang/repos","events_url":"https://api.github.com/users/MarkYHZhang/events{/privacy}","received_events_url":"https://api.github.com/users/MarkYHZhang/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/5475/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/5475/timeline","performed_via_github_app":null,"state_reason":"completed"}