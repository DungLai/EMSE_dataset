{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6155","repository_url":"https://api.github.com/repos/mlflow/mlflow","labels_url":"https://api.github.com/repos/mlflow/mlflow/issues/6155/labels{/name}","comments_url":"https://api.github.com/repos/mlflow/mlflow/issues/6155/comments","events_url":"https://api.github.com/repos/mlflow/mlflow/issues/6155/events","html_url":"https://github.com/mlflow/mlflow/issues/6155","id":1286919342,"node_id":"I_kwDOCB5Jx85MtNSu","number":6155,"title":"[BUG] mlflow.tensorflow.autolog(log_model=False) doesn't log earlystopping callback ","user":{"login":"MSthe00","id":12585803,"node_id":"MDQ6VXNlcjEyNTg1ODAz","avatar_url":"https://avatars.githubusercontent.com/u/12585803?v=4","gravatar_id":"","url":"https://api.github.com/users/MSthe00","html_url":"https://github.com/MSthe00","followers_url":"https://api.github.com/users/MSthe00/followers","following_url":"https://api.github.com/users/MSthe00/following{/other_user}","gists_url":"https://api.github.com/users/MSthe00/gists{/gist_id}","starred_url":"https://api.github.com/users/MSthe00/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MSthe00/subscriptions","organizations_url":"https://api.github.com/users/MSthe00/orgs","repos_url":"https://api.github.com/users/MSthe00/repos","events_url":"https://api.github.com/users/MSthe00/events{/privacy}","received_events_url":"https://api.github.com/users/MSthe00/received_events","type":"User","site_admin":false},"labels":[{"id":955449428,"node_id":"MDU6TGFiZWw5NTU0NDk0Mjg=","url":"https://api.github.com/repos/mlflow/mlflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2022849295,"node_id":"MDU6TGFiZWwyMDIyODQ5Mjk1","url":"https://api.github.com/repos/mlflow/mlflow/labels/area/tracking","name":"area/tracking","color":"48eabc","default":false,"description":"Tracking service, tracking client APIs, autologging"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-28T07:35:42Z","updated_at":"2022-07-01T03:04:29Z","closed_at":"2022-07-01T03:04:29Z","author_association":"NONE","active_lock_reason":null,"body":"### Willingness to contribute\n\nNo. I cannot contribute a bug fix at this time.\n\n### MLflow version\n\n1.26.1\n\n### System information\n\n- **OS: Red Hat Enterprise Linux Server release 7.9 (Maipo)**:\r\n- **Python version: 3.9 **:\r\n\n\n### Describe the problem\n\nWhen using mlflow.tensorflow.autolog() with log_model=False, the callback for early stopping is not logged (e.g. restored_epoch, stopped_epoch, etc). When using log_model=True, it works fine.\r\n\r\nThe same issue is not happening when using mlflow.keras.autolog(), there the callback is logged with either log_model=True or log_model=False.\n\n### Tracking information\n\n_No response_\n\n### Code to reproduce issue\n\n```python\r\nimport mlflow\r\n\r\nfrom numpy import loadtxt\r\nimport tensorflow as tf\r\nfrom tensorflow.keras.models import Sequential\r\nfrom tensorflow.keras.layers import Dense\r\n\r\nmlflow.tensorflow.autolog(log_models=False)\r\n#note: when changing this to log_models=True or mlflow.keras.autolog it works flawlessly\r\nmlflow.set_tracking_uri(\"sqlite:///artifacts/mlruns.db\")\r\nmlflow.set_experiment(\"testing123\")\r\n\r\n# load the dataset\r\ndataset = loadtxt('data.csv', delimiter=',')\r\nX = dataset[50:,0:8]\r\ny = dataset[50:,8]\r\nval_X = dataset[:50,0:8]\r\nval_y = dataset[:50,8]\r\n\r\nmodel = Sequential()\r\nmodel.add(Dense(12, input_dim=8, activation='relu'))\r\nmodel.add(Dense(8, activation='relu'))\r\nmodel.add(Dense(1, activation='sigmoid'))\r\n\r\noptimizer = getattr(tf.keras.optimizers, \"Adam\")(\r\n    learning_rate=0.001\r\n)\r\nmodel.compile(loss='binary_crossentropy', optimizer=optimizer)\r\n\r\ncb = tf.keras.callbacks.EarlyStopping(\r\n    patience=5,\r\n    monitor=\"val_loss\",\r\n    restore_best_weights=True,\r\n)\r\nmodel.fit(X, y, epochs=200, batch_size=10, callbacks=[cb], validation_data=(val_X, val_y))\r\n```\n\n### Other info / logs\n\n```log\r\n(note: I am not using any GPU so these CUDA warnings can be ignored)\r\n<Experiment: artifact_location='./mlruns/3', experiment_id='3', lifecycle_stage='active', name='testing123', tags={}>\r\n\r\n2022-06-28 09:29:29.845226: E tensorflow/stream_executor/cuda/cuda_driver.cc:271] failed call to cuInit: CUDA_ERROR_NO_DEVICE: no CUDA-capable device is detected\r\n2022-06-28 09:29:29.845287: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (tsa-ln003): /proc/driver/nvidia/version does not exist\r\n2022-06-28 09:29:29.846183: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA\r\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\r\n2022/06/28 09:29:30 INFO mlflow.utils.autologging_utils: Created MLflow autologging run with ID '216a90fa7a1a4299992d5ef985709381', which will track hyperparameters, performance metrics, model artifacts, and lineage information for the current tensorflow workflow\r\n\r\nEpoch 1/200\r\n 1/72 [..............................] - ETA: 31s - loss: 52.3960WARNING:tensorflow:Callback method `on_train_batch_end` is slow compared to the batch time (batch time: 0.0008s vs `on_train_batch_end` time: 0.0019s). Check your callbacks.\r\n72/72 [==============================] - 1s 4ms/step - loss: 23.0852 - val_loss: 5.9279\r\nEpoch 2/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 2.7776 - val_loss: 3.1511\r\nEpoch 3/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 2.2781 - val_loss: 2.9743\r\nEpoch 4/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 1.9314 - val_loss: 2.3075\r\nEpoch 5/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 1.6068 - val_loss: 1.7178\r\nEpoch 6/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 1.3135 - val_loss: 1.4827\r\nEpoch 7/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 1.1177 - val_loss: 1.1858\r\nEpoch 8/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.9740 - val_loss: 1.0683\r\nEpoch 9/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.8737 - val_loss: 0.9651\r\nEpoch 10/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.8360 - val_loss: 0.8862\r\nEpoch 11/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.7893 - val_loss: 0.8844\r\nEpoch 12/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.7504 - val_loss: 0.9511\r\nEpoch 13/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.7052 - val_loss: 0.8350\r\nEpoch 14/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6803 - val_loss: 0.7436\r\nEpoch 15/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6664 - val_loss: 0.7783\r\nEpoch 16/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6710 - val_loss: 0.7530\r\nEpoch 17/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6671 - val_loss: 0.7035\r\nEpoch 18/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6233 - val_loss: 0.8090\r\nEpoch 19/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6366 - val_loss: 0.7028\r\nEpoch 20/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6198 - val_loss: 0.7543\r\nEpoch 21/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6236 - val_loss: 0.7227\r\nEpoch 22/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6370 - val_loss: 0.7402\r\nEpoch 23/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6277 - val_loss: 0.7003\r\nEpoch 24/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6056 - val_loss: 0.6909\r\nEpoch 25/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6055 - val_loss: 0.6256\r\nEpoch 26/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6020 - val_loss: 0.6821\r\nEpoch 27/200\r\n72/72 [==============================] - 0s 2ms/step - loss: 0.6004 - val_loss: 0.7282\r\nEpoch 28/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6025 - val_loss: 0.7228\r\nEpoch 29/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.5990 - val_loss: 0.7228\r\nEpoch 30/200\r\n72/72 [==============================] - 0s 1ms/step - loss: 0.6022 - val_loss: 0.6725\r\n<keras.callbacks.History at 0x2b493ff77c10>\r\n```\n\n### What component(s) does this bug affect?\n\n- [ ] `area/artifacts`: Artifact stores and artifact logging\n- [ ] `area/build`: Build and test infrastructure for MLflow\n- [ ] `area/docs`: MLflow documentation pages\n- [ ] `area/examples`: Example code\n- [ ] `area/model-registry`: Model Registry service, APIs, and the fluent client calls for Model Registry\n- [ ] `area/models`: MLmodel format, model serialization/deserialization, flavors\n- [ ] `area/pipelines`: Pipelines, Pipeline APIs, Pipeline configs, Pipeline Templates\n- [ ] `area/projects`: MLproject format, project running backends\n- [ ] `area/scoring`: MLflow Model server, model deployment tools, Spark UDFs\n- [ ] `area/server-infra`: MLflow Tracking server backend\n- [X] `area/tracking`: Tracking Service, tracking client APIs, autologging\n\n### What interface(s) does this bug affect?\n\n- [ ] `area/uiux`: Front-end, user experience, plotting, JavaScript, JavaScript dev server\n- [ ] `area/docker`: Docker use across MLflow's components, such as MLflow Projects and MLflow Models\n- [ ] `area/sqlalchemy`: Use of SQLAlchemy in the Tracking Service or Model Registry\n- [ ] `area/windows`: Windows support\n\n### What language(s) does this bug affect?\n\n- [ ] `language/r`: R APIs and clients\n- [ ] `language/java`: Java APIs and clients\n- [ ] `language/new`: Proposals for new client languages\n\n### What integration(s) does this bug affect?\n\n- [ ] `integrations/azure`: Azure and Azure ML integrations\n- [ ] `integrations/sagemaker`: SageMaker integrations\n- [ ] `integrations/databricks`: Databricks integrations","closed_by":{"login":"WeichenXu123","id":19235986,"node_id":"MDQ6VXNlcjE5MjM1OTg2","avatar_url":"https://avatars.githubusercontent.com/u/19235986?v=4","gravatar_id":"","url":"https://api.github.com/users/WeichenXu123","html_url":"https://github.com/WeichenXu123","followers_url":"https://api.github.com/users/WeichenXu123/followers","following_url":"https://api.github.com/users/WeichenXu123/following{/other_user}","gists_url":"https://api.github.com/users/WeichenXu123/gists{/gist_id}","starred_url":"https://api.github.com/users/WeichenXu123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WeichenXu123/subscriptions","organizations_url":"https://api.github.com/users/WeichenXu123/orgs","repos_url":"https://api.github.com/users/WeichenXu123/repos","events_url":"https://api.github.com/users/WeichenXu123/events{/privacy}","received_events_url":"https://api.github.com/users/WeichenXu123/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/6155/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/mlflow/mlflow/issues/6155/timeline","performed_via_github_app":null,"state_reason":"completed"}