[{"id":2650036785,"node_id":"MDEyOkxhYmVsZWRFdmVudDI2NTAwMzY3ODU=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2650036785","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-09-20T11:41:04Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/534696397","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-534696397","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":534696397,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDY5NjM5Nw==","user":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"created_at":"2019-09-24T18:47:11Z","updated_at":"2019-09-24T18:49:27Z","author_association":"COLLABORATOR","body":"@t-henri Can you clarify where the error occurs? Is your SQL database instance experiencing OOM exceptions, or is this an issue with the MLflow tracking server instance?\r\n\r\nIn the case of the MLflow Tracking server instance, it's not immediately apparent why reducing the number of database would produce this behavior because the tracking server fetches the same set of data from the database on the current `master` branch as it does on the release branch (release version `1.2`); the updates to `master` simply reduce the number of queries required to fetch this information.","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/534696397/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}},{"id":2659157251,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY1OTE1NzI1MQ==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2659157251","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-24T18:47:11Z","performed_via_github_app":null},{"id":2659157252,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NTkxNTcyNTI=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2659157252","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-24T18:47:11Z","performed_via_github_app":null},{"id":2659163356,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQyNjU5MTYzMzU2","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2659163356","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2019-09-24T18:49:13Z","assignee":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/534988753","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-534988753","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":534988753,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDk4ODc1Mw==","user":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T12:03:04Z","updated_at":"2019-09-25T13:43:29Z","author_association":"CONTRIBUTOR","body":"Hello @dbczumar, the error occurs in the MLflow tracking server instance.\r\n\r\nYou indeed reduced the number of queries made to the SQL database, but you also increased a lot the number of rows we receive.\r\n\r\nBefore your changes, we made one query to get run informations and then 3 queries to get the corresponding params, tags and metrics. So the total number of lines we got for a run was 1 + number of params + number of tags + number of metrics.\r\n\r\nNow, with the latest metrics table, we do a single query that join the tables runs, params, metrics and tags, and it returns the cartesian product between the params, metrics and tags. So now we have number of params * number of tags * number of metrics lines for each run. \r\nThe query we run is the following: \r\n```\r\nSELECT runs.run_uuid AS runs_run_uuid, runs.name AS runs_name, runs.source_type AS runs_source_type, runs.source_name AS runs_source_name, runs.entry_point_name AS runs_entry_point_name, runs.user_id AS runs_user_id, runs.status AS runs_status, runs.start_time AS runs_start_time, runs.end_time AS runs_end_time, runs.source_version AS runs_source_version, runs.lifecycle_stage AS runs_lifecycle_stage, runs.artifact_uri AS runs_artifact_uri, runs.experiment_id AS runs_experiment_id, tags_1.`key` AS tags_1_key, tags_1.value AS tags_1_value, tags_1.run_uuid AS tags_1_run_uuid, latest_metrics_1.`key` AS latest_metrics_1_key, latest_metrics_1.value AS latest_metrics_1_value, latest_metrics_1.timestamp AS latest_metrics_1_timestamp, latest_metrics_1.step AS latest_metrics_1_step, latest_metrics_1.is_nan AS latest_metrics_1_is_nan, latest_metrics_1.run_uuid AS latest_metrics_1_run_uuid, params_1.`key` AS params_1_key, params_1.value AS params_1_value, params_1.run_uuid AS params_1_run_uuid\r\nFROM runs LEFT OUTER JOIN tags AS tags_1 ON runs.run_uuid = tags_1.run_uuid LEFT OUTER JOIN latest_metrics AS latest_metrics_1 ON runs.run_uuid = latest_metrics_1.run_uuid LEFT OUTER JOIN params AS params_1 ON runs.run_uuid = params_1.run_uuid\r\nWHERE runs.experiment_id IN (%s) AND runs.lifecycle_stage IN (%s)\r\n```\r\nIf you test it on an experiment with 10 runs, each with 3 params, 2 tags and 2 metrics it will return you 420 rows. Before, we would have had 80 rows. \r\n\r\nI added a test in sqlalchemy_store were I create 1000 runs and add 100 params, 100 tags and 100 metrics in each run. This test is successful with the 1.2 version but fails on master. When I run it locally (inside a docker container with 6GB of ram), with master branch, my container is OOM killed, and on branch 1.2 it succeed and the max ram is ~600MB.\r\nYou can check these two branches and their corresponding build on Travis:\r\nFrom 1.2: \r\nhttps://github.com/criteo-forks/mlflow/pull/9\r\nhttps://travis-ci.com/criteo-forks/mlflow/jobs/238957880 line 1567\r\nFrom master:\r\nhttps://github.com/criteo-forks/mlflow/pull/8\r\nhttps://travis-ci.com/criteo-forks/mlflow/jobs/238692118 line 1580\r\nYou can see that the python tests were successful with the 1.2 version, and with the master version the test timeouts on the test I added (test_big_experiment).","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/534988753/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false}},{"id":2661407782,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2MTQwNzc4Mg==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2661407782","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-25T12:03:04Z","performed_via_github_app":null},{"id":2661407784,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NjE0MDc3ODQ=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2661407784","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-25T12:03:04Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535275289","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-535275289","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":535275289,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTI3NTI4OQ==","user":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T00:20:17Z","updated_at":"2019-09-26T00:20:17Z","author_association":"COLLABORATOR","body":"@t-henri Thank you for your detailed analysis. I've reproduced the problem and am working on a patch that should reduce memory usage while minimizing the number of database roundtrips.","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535275289/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}},{"id":2663516980,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2MzUxNjk4MA==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2663516980","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-26T00:20:17Z","performed_via_github_app":null},{"id":2663516981,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NjM1MTY5ODE=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2663516981","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-26T00:20:17Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535281083","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-535281083","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":535281083,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTI4MTA4Mw==","user":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T00:49:53Z","updated_at":"2019-09-26T00:49:53Z","author_association":"COLLABORATOR","body":"@t-henri I've filed https://github.com/mlflow/mlflow/pull/1878 to correct this issue by using a `subquery` load for eager loading instead of a `joinedload` (see https://docs.sqlalchemy.org/en/13/orm/loading_relationships.html#subquery-eager-loading for more information). Please take a look! It would be very helpful if you could try it out and confirm that it resolves your memory utilization issues.\r\n\r\nJust to confirm, are you running your production MLflow database on a separate instance/machine, or are you running it on the same machine as your tracking server?\r\n\r\nMy current working theory is that the `joinedload` procedure is very memory-intensive for the *database instance* because the cross product of latest metrics, parameters, and tags are held in memory for each run. However, the SqlAlchemy documentation for the `joinedload` technique is very adamant in stating that the query result should be identical to the result set produced by other loading techniques (e.g., lazy loading); this would imply that the tracking instance receives the same amount of output. Please let me know if your setup/experience contradicts this reasoning (e.g., if your tracking instance exhibits OOM exceptions while the database instance does not exhibit any issues with memory utilization). For reference, here's the documentation on `joinedload`: https://docs.sqlalchemy.org/en/13/orm/loading_relationships.html#the-zen-of-joined-eager-loading. In the mean time, I will continue to investigate this hypothesis.","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535281083/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}},{"id":2663553890,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2MzU1Mzg5MA==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2663553890","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-26T00:49:53Z","performed_via_github_app":null},{"id":2663553891,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NjM1NTM4OTE=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2663553891","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-26T00:49:53Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535427386","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-535427386","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":535427386,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTQyNzM4Ng==","user":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T09:45:46Z","updated_at":"2019-09-26T15:38:44Z","author_association":"CONTRIBUTOR","body":"Hello @dbczumar, yes I am running my database on a separate instance than my MLflow tracking server, and the memory issue only occurs in the tracking server. The memory issue occurs because even if sqlalchemy returns the same objects than with lazy loading, it has to perform the huge query at some point.\r\n\r\nI tried your fix and it is much better, there is no more memory issues and it is also faster, that is a great fix. The memory spikes at 600MB for the same task that killed my container with 6GB of RAM before. \r\n\r\nI still have some questions I would like to ask you about the search_runs method:\r\n\r\n- I fear it will not scale indefinitely, since we perform a 'SELECT *' in the database, with the growth of the database we might reach a point where it becomes slow again.\r\n- I see that after this SELECT, we loop through the runs in python to sort/filter them and then we return only a subset to paginate, which means we potentially make a lot of operations that we don't need. Don't you think it would be better to filter/sort directly in SQL and then we could also paginate in SQL too using limit and offset ?\r\n\r\nAlso, do you think I should make a PR to add the test I created for this issue ? So we can detect early a similar error ?","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535427386/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false}},{"id":2664620829,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2NDYyMDgyOQ==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2664620829","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-26T09:45:46Z","performed_via_github_app":null},{"id":2664620830,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NjQ2MjA4MzA=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2664620830","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-26T09:45:46Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535585115","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-535585115","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":535585115,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTU4NTExNQ==","user":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T16:34:49Z","updated_at":"2019-09-26T16:34:49Z","author_association":"COLLABORATOR","body":"@t-henri You're absolutely correct that we should eventually push pagination logic into the SQL execution layer for performance and scalability reasons. We'd love to review a PR implementing this behavior!\r\n\r\nRegarding a test PR, that would be very useful! Feel free to file a separate PR or push to the branch associated with #1878!","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535585115/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false}},{"id":2665952461,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2NTk1MjQ2MQ==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2665952461","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-26T16:34:49Z","performed_via_github_app":null},{"id":2665952462,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2NjU5NTI0NjI=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2665952462","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-26T16:34:49Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535839342","html_url":"https://github.com/mlflow/mlflow/issues/1865#issuecomment-535839342","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/1865","id":535839342,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTgzOTM0Mg==","user":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false},"created_at":"2019-09-27T08:09:57Z","updated_at":"2019-09-27T08:11:07Z","author_association":"CONTRIBUTOR","body":"Hello @dbczumar, so I created this PR with the test I linked you before: https://github.com/mlflow/mlflow/pull/1880\r\nIt will fail for now, but when your changes are merged it should be ok.\r\n\r\nFeel free to ping me if you have any remark.","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/535839342/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"t-henri","id":51711739,"node_id":"MDQ6VXNlcjUxNzExNzM5","avatar_url":"https://avatars.githubusercontent.com/u/51711739?v=4","gravatar_id":"","url":"https://api.github.com/users/t-henri","html_url":"https://github.com/t-henri","followers_url":"https://api.github.com/users/t-henri/followers","following_url":"https://api.github.com/users/t-henri/following{/other_user}","gists_url":"https://api.github.com/users/t-henri/gists{/gist_id}","starred_url":"https://api.github.com/users/t-henri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/t-henri/subscriptions","organizations_url":"https://api.github.com/users/t-henri/orgs","repos_url":"https://api.github.com/users/t-henri/repos","events_url":"https://api.github.com/users/t-henri/events{/privacy}","received_events_url":"https://api.github.com/users/t-henri/received_events","type":"User","site_admin":false}},{"id":2667790263,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjY2Nzc5MDI2Mw==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2667790263","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-09-27T08:09:57Z","performed_via_github_app":null},{"id":2667790264,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI2Njc3OTAyNjQ=","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2667790264","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-09-27T08:09:57Z","performed_via_github_app":null},{"id":2700362361,"node_id":"MDExOkNsb3NlZEV2ZW50MjcwMDM2MjM2MQ==","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/2700362361","actor":{"login":"dbczumar","id":39497902,"node_id":"MDQ6VXNlcjM5NDk3OTAy","avatar_url":"https://avatars.githubusercontent.com/u/39497902?v=4","gravatar_id":"","url":"https://api.github.com/users/dbczumar","html_url":"https://github.com/dbczumar","followers_url":"https://api.github.com/users/dbczumar/followers","following_url":"https://api.github.com/users/dbczumar/following{/other_user}","gists_url":"https://api.github.com/users/dbczumar/gists{/gist_id}","starred_url":"https://api.github.com/users/dbczumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbczumar/subscriptions","organizations_url":"https://api.github.com/users/dbczumar/orgs","repos_url":"https://api.github.com/users/dbczumar/repos","events_url":"https://api.github.com/users/dbczumar/events{/privacy}","received_events_url":"https://api.github.com/users/dbczumar/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-10-09T20:18:53Z","state_reason":null,"performed_via_github_app":null}]