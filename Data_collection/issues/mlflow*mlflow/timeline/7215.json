[{"id":7710158534,"node_id":"LE_lADOCB5Jx85VSXRLzwAAAAHLj67G","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710158534","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:06:01Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"id":7710159526,"node_id":"LE_lADOCB5Jx85VSXRLzwAAAAHLj7Km","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710159526","actor":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:06:16Z","label":{"name":"area/model-registry","color":"48eabc"},"performed_via_github_app":null},{"id":7710159529,"node_id":"LE_lADOCB5Jx85VSXRLzwAAAAHLj7Kp","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710159529","actor":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:06:16Z","label":{"name":"area/tracking","color":"48eabc"},"performed_via_github_app":null},{"id":7710169430,"node_id":"RTE_lADOCB5Jx85VSXRLzwAAAAHLj9lW","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710169430","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:08:30Z","rename":{"from":"[BUG] log_explanation failed because of type caset","to":"[BUG] log_explanation failed because of type cast"},"performed_via_github_app":null},{"id":7710170490,"node_id":"RTE_lADOCB5Jx85VSXRLzwAAAAHLj916","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710170490","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:08:43Z","rename":{"from":"[BUG] log_explanation failed because of type cast","to":"[BUG] log_explanation failed due of type cast"},"performed_via_github_app":null},{"id":7710171624,"node_id":"RTE_lADOCB5Jx85VSXRLzwAAAAHLj-Ho","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710171624","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:09:00Z","rename":{"from":"[BUG] log_explanation failed due of type cast","to":"[BUG] log_explanation failed due of type cast in `_enforce_mlflow_datatype`"},"performed_via_github_app":null},{"id":7710172535,"node_id":"RTE_lADOCB5Jx85VSXRLzwAAAAHLj-V3","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7710172535","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2022-11-01T05:09:13Z","rename":{"from":"[BUG] log_explanation failed due of type cast in `_enforce_mlflow_datatype`","to":"[BUG] log_explanation failed due to type cast in `_enforce_mlflow_datatype`"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1298884757","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1298884757","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1298884757,"node_id":"IC_kwDOCB5Jx85Na2iV","user":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"created_at":"2022-11-01T17:41:47Z","updated_at":"2022-11-01T17:41:47Z","author_association":"COLLABORATOR","body":"I'm afraid that I can't reproduce this. \r\nCould you take a look at the below unit test and see if I'm capturing what you're reporting as an issue?\r\n\r\n``` python\r\ndef test_float_precision_kernel_explainer():\r\n\r\n    # Train on 32bit float, explain on 64bit float\r\n\r\n    num_rows = 50\r\n\r\n    X, y = get_diabetes()\r\n    X_cast = X.astype('float32')  # training set cast to 32bit float\r\n\r\n    X_cast, y = X_cast.iloc[:num_rows], y[:num_rows]\r\n    X = X.iloc[:num_rows]\r\n    X = X.astype('float64')  # SHAP kernel explainer on 64bit float\r\n\r\n    model = RandomForestRegressor()\r\n    model.fit(X_cast, y)  # fit on 32bit float\r\n\r\n    with mlflow.start_run() as run:\r\n        explanation_uri = mlflow.shap.log_explanation(model.predict, X)\r\n\r\n    artifact_path = \"model_explanations_shap\"\r\n    artifacts = set(yield_artifacts(run.info.run_id))\r\n\r\n    assert explanation_uri == os.path.join(run.info.artifact_uri, artifact_path)\r\n    assert artifacts == {\r\n        os.path.join(artifact_path, \"base_values.npy\"),\r\n        os.path.join(artifact_path, \"shap_values.npy\"),\r\n        os.path.join(artifact_path, \"summary_bar_plot.png\"),\r\n    }\r\n\r\n    explainer = shap.KernelExplainer(model.predict, shap.kmeans(X, num_rows))\r\n    shap_values_expected = explainer.shap_values(X)\r\n\r\n    base_values = np.load(os.path.join(explanation_uri, \"base_values.npy\"))\r\n    shap_values = np.load(os.path.join(explanation_uri, \"shap_values.npy\"))\r\n    np.testing.assert_array_equal(base_values, explainer.expected_value)\r\n    np.testing.assert_array_equal(shap_values, shap_values_expected)\r\n\r\n    # Train on 64bit float, explain on 32bit float\r\n\r\n    num_rows = 50\r\n\r\n    X, y = get_diabetes()\r\n    X_cast = X.astype('float64')  # cast training set to 64bit float\r\n\r\n    X_cast, y = X_cast.iloc[:num_rows], y[:num_rows]\r\n    X = X.iloc[:num_rows]\r\n    X = X.astype('float32')  # shap validation on 32bit float\r\n\r\n    model = RandomForestRegressor()\r\n    model.fit(X_cast, y)  # fit on 64bit float\r\n\r\n    with mlflow.start_run() as run:\r\n        explanation_uri = mlflow.shap.log_explanation(model.predict, X)\r\n\r\n    artifact_path = \"model_explanations_shap\"\r\n    artifacts = set(yield_artifacts(run.info.run_id))\r\n\r\n    assert explanation_uri == os.path.join(run.info.artifact_uri, artifact_path)\r\n    assert artifacts == {\r\n        os.path.join(artifact_path, \"base_values.npy\"),\r\n        os.path.join(artifact_path, \"shap_values.npy\"),\r\n        os.path.join(artifact_path, \"summary_bar_plot.png\"),\r\n    }\r\n\r\n    explainer = shap.KernelExplainer(model.predict, shap.kmeans(X, num_rows))\r\n    shap_values_expected = explainer.shap_values(X)\r\n\r\n    base_values = np.load(os.path.join(explanation_uri, \"base_values.npy\"))\r\n    shap_values = np.load(os.path.join(explanation_uri, \"shap_values.npy\"))\r\n    np.testing.assert_array_equal(base_values, explainer.expected_value)\r\n    np.testing.assert_array_equal(shap_values, shap_values_expected)\r\n\r\n\r\n\r\n```","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1298884757/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1298888584","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1298888584","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1298888584,"node_id":"IC_kwDOCB5Jx85Na3eI","user":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"created_at":"2022-11-01T17:45:18Z","updated_at":"2022-11-01T17:45:18Z","author_association":"COLLABORATOR","body":"The exception that you're getting is raised from here:\r\n\r\nhttps://github.com/mlflow/mlflow/blob/6bddc546abb9001120fe09a1329e53b8eafcaf8f/mlflow/models/utils.py#L543-L549\r\n\r\nCan you verify that you're passing in all of the required columns (see my example above for guidance).","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1298888584/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1303109261","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1303109261","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1303109261,"node_id":"IC_kwDOCB5Jx85Nq96N","user":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"created_at":"2022-11-04T08:24:30Z","updated_at":"2022-11-05T00:32:03Z","author_association":"NONE","body":"I reproduce the problem. I think that it causes when model signature is registed.\r\n\r\n- disable autolog, work fine\r\n\r\n```python\r\nimport os\r\n\r\nimport numpy as np\r\nimport pandas as pd\r\nfrom sklearn.datasets import load_diabetes\r\nfrom lightgbm import LGBMRegressor\r\n\r\nimport mlflow\r\nfrom mlflow import MlflowClient\r\n\r\n# prepare training data\r\nX, y = dataset = load_diabetes(return_X_y=True, as_frame=True)\r\nX = pd.DataFrame(dataset.data[:50, :8], columns=dataset.feature_names[:8])\r\ny = dataset.target[:50]\r\n\r\n# train a model\r\nmodel = LGBMRegressor()\r\nmodel.fit(X, y)\r\n\r\n# register model\r\nmlflow.lightgbm.log_model(model, \"diabates_lgbm_model\")\r\n\r\n# register to model registry\r\n# operation in webui\r\n\r\n# load_model\r\nmodel_uri=\"models:/diabates_lgbm_model/1\"\r\nfrom mlflow.pyfunc import load_model as mlflow_load_model\r\nload_model = mlflow_load_model(model_uri)\r\n\r\nmlflow.shap.log_explanation(load_model.predict, X)\r\n```\r\n\r\nresult\r\n```\r\nUsage of np.ndarray subset (sliced data) is not recommended due to it will double the peak memory cost in LightGBM.\r\n  8%|███████▌                                                                                          | 34/442 [00:20<03:58,  1.71it/s]Usage of np.ndarray subset (sliced data) is not recommended due to it will double the peak memory cost in LightGBM.\r\n  8%|███████▊                                                                                          | 35/442 [00:21<04:04,  1.67it/s]Usage of np.ndarray subset (sliced data) is not recommended due to it will double the peak memory cost in LightGBM.\r\n  8%|███████▉                                                                                          | 36/442 [00:21<03:56,  1.72it/s]Usage of np.ndarray subset (sliced data) is not recommended due to it will double the peak memory cost in LightGBM.\r\n```\r\n\r\n\r\n- Enable autolog, raise error\r\n\r\n```python\r\nimport os\r\n\r\nimport numpy as np\r\nimport pandas as pd\r\nfrom sklearn.datasets import load_diabetes\r\nfrom lightgbm import LGBMRegressor\r\n\r\nimport mlflow\r\nfrom mlflow import MlflowClient\r\n\r\n# prepare training data\r\nX, y = dataset = load_diabetes(return_X_y=True, as_frame=True)\r\nX = pd.DataFrame(dataset.data[:50, :8], columns=dataset.feature_names[:8])\r\ny = dataset.target[:50]\r\n\r\nmlflow.lightgbm.autolog()\r\n\r\n# train a model\r\nmodel = LGBMRegressor()\r\n\r\n\r\nwith mlflow.start_run():\r\n  model.fit(X, y)\r\n\r\n# register to model registry\r\n# operation in webui\r\n\r\n# load_model\r\nmodel_uri=\"models:/diabates_lgbm_model/2\"\r\nfrom mlflow.pyfunc import load_model as mlflow_load_model\r\nload_model = mlflow_load_model(model_uri)\r\nmlflow.shap.log_explanation(load_model.predict, X)\r\n```\r\n\r\nresult\r\n```\r\nProvided model function fails when applied to the provided data set.\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/nkuromat/git/hoge/.venv/lib/python3.8/site-packages/mlflow/shap.py\", line 277, in log_explanation\r\n    explainer = shap.KernelExplainer(predict_function, background_data)\r\n  File \"/Users/nkuromat/git/hoge/.venv/lib/python3.8/site-packages/shap/explainers/_kernel.py\", line 69, in __init__\r\n    model_null = match_model_to_data(self.model, self.data)\r\n  File \"/Users/nkuromat/git/hoge/.venv/lib/python3.8/site-packages/shap/utils/_legacy.py\", line 112, in match_model_to_data\r\n    out_val = model.f(data.data)\r\n  File \"/Users/nkuromat/git/hoge/.venv/lib/python3.8/site-packages/mlflow/pyfunc/__init__.py\", line 372, in predict\r\n    data = _enforce_schema(data, input_schema)\r\n  File \"/Users/nkuromat/git/hoge/.venv/lib/python3.8/site-packages/mlflow/models/utils.py\", line 545, in _enforce_schema\r\n    raise MlflowException(message)\r\nmlflow.exceptions.MlflowException: Model is missing inputs ['age', 'sex', 'bmi', 'bp', 's1', 's2', 's3', 's4', 's5', 's6']. Note that there were extra inputs: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\r\n```\r\n\r\nIn my environment, run with shap==0.40\r\n\r\n```\r\n$ pip freeze |grep -e mlflow -e shap\r\nmlflow==1.29.0\r\nshap==0.40.0\r\n```","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1303109261/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1303129920","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1303129920","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1303129920,"node_id":"IC_kwDOCB5Jx85NrC9A","user":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"created_at":"2022-11-04T08:48:33Z","updated_at":"2022-11-04T08:48:33Z","author_association":"NONE","body":"I found a workaround.\r\n\r\n```\r\nload_model.metadata.signature = None\r\n```","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1303129920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1305640119","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1305640119","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1305640119,"node_id":"IC_kwDOCB5Jx85N0ny3","user":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false},"created_at":"2022-11-07T13:46:19Z","updated_at":"2022-11-07T13:46:19Z","author_association":"NONE","body":"@BenWilson2 What do you think about the error? \r\nShould MLflow support explain with loaded model?","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1305640119/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"kuromt","id":6327712,"node_id":"MDQ6VXNlcjYzMjc3MTI=","avatar_url":"https://avatars.githubusercontent.com/u/6327712?v=4","gravatar_id":"","url":"https://api.github.com/users/kuromt","html_url":"https://github.com/kuromt","followers_url":"https://api.github.com/users/kuromt/followers","following_url":"https://api.github.com/users/kuromt/following{/other_user}","gists_url":"https://api.github.com/users/kuromt/gists{/gist_id}","starred_url":"https://api.github.com/users/kuromt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuromt/subscriptions","organizations_url":"https://api.github.com/users/kuromt/orgs","repos_url":"https://api.github.com/users/kuromt/repos","events_url":"https://api.github.com/users/kuromt/events{/privacy}","received_events_url":"https://api.github.com/users/kuromt/received_events","type":"User","site_admin":false}},{"id":7752790259,"node_id":"MEE_lADOCB5Jx85VSXRLzwAAAAHOGjDz","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7752790259","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-11-07T13:46:19Z","performed_via_github_app":null},{"id":7752790264,"node_id":"SE_lADOCB5Jx85VSXRLzwAAAAHOGjD4","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7752790264","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-11-07T13:46:19Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1306104403","html_url":"https://github.com/mlflow/mlflow/issues/7215#issuecomment-1306104403","issue_url":"https://api.github.com/repos/mlflow/mlflow/issues/7215","id":1306104403,"node_id":"IC_kwDOCB5Jx85N2ZJT","user":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"created_at":"2022-11-07T19:47:28Z","updated_at":"2022-11-07T19:47:28Z","author_association":"COLLABORATOR","body":"I was able to reproduce what you're seeing. That being said, the APIs aren't really designed for what you're trying to do. There ARE ways to wrap an `Explainer` in a `pyfunc`. \r\n\r\n```python\r\nfrom sklearn.datasets import load_diabetes\r\nfrom lightgbm import LGBMRegressor\r\nimport shap\r\nimport mlflow\r\nfrom mlflow.tracking.artifact_utils import _download_artifact_from_uri\r\n\r\nmlflow.set_tracking_uri(\"http://127.0.0.1:5000\")\r\n\r\n# prepare training data\r\nX, y = load_diabetes(return_X_y=True, as_frame=True)\r\n\r\nmlflow.lightgbm.autolog(log_input_examples=True, log_model_signatures=True)\r\n\r\nwith mlflow.start_run():\r\n    \r\n    model = LGBMRegressor().fit(X, y)\r\n    \r\n#     mlflow.shap.log_explanation(pyfunc_model.predict, X) # This throws. As it should.\r\n\r\n    explainer_original = shap.Explainer(model.predict, X, algorithm=\"permutation\")\r\n\r\n    mlflow.shap.log_explainer(explainer_original, \"test_explainer\")\r\n    \r\n    explainer_uri = mlflow.get_artifact_uri(\"test_explainer\")\r\n    explainer_path = _download_artifact_from_uri(explainer_uri)\r\n    \r\n    explainer_pyfunc = mlflow.shap._load_pyfunc(explainer_path)\r\n    \r\n#     mlflow.shap.log_explanation(explainer_pyfunc.predict, X) # This fails, as it should.\r\n    \r\n    mlflow.shap.log_explanation(model.predict, X)\r\n\r\n```\r\n\r\nThere ARE ways to perform logging of Explainer details to a run while still supporting model signature inference.\r\n\r\n```python\r\nimport xgboost\r\nimport shap\r\nimport json\r\nimport mlflow\r\nfrom sklearn.model_selection import train_test_split\r\n\r\nmlflow.xgboost.autolog(log_input_examples=True, log_model_signatures=True)\r\n\r\nwith mlflow.start_run() as run:\r\n    \r\n    # Load the UCI Adult Dataset\r\n    X, y = shap.datasets.adult()\r\n\r\n    # Split the data into training and test sets\r\n    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=42)\r\n\r\n    # Fit an XGBoost binary classifier on the training data split\r\n    model = xgboost.XGBClassifier().fit(X_train, y_train)\r\n\r\n    # Build the Evaluation Dataset from the test set\r\n    eval_data = X_test\r\n    eval_data[\"label\"] = y_test\r\n\r\n    # Log the baseline model to MLflow\r\n    model_uri = mlflow.get_artifact_uri(\"model\")\r\n    \r\n    # Evaluate the logged model\r\n    result = mlflow.evaluate(\r\n        model_uri,\r\n        eval_data,\r\n        targets=\"label\",\r\n        model_type=\"classifier\",\r\n        evaluators=[\"default\"],\r\n    )\r\n\r\nfrom mlflow import MlflowClient\r\n\r\nclient = mlflow.MlflowClient()\r\n\r\nprint(json.dumps(\r\n        {key: json.loads(x) for key, x in json.loads(\r\n            client.get_run(run.info.run_id).data.tags.get(\"mlflow.log-model.history\"))[0][\"signature\"].items()\r\n        }, indent=2)\r\n     )\r\n\r\n```\r\n\r\n```shell\r\n{\r\n  \"inputs\": [\r\n    {\r\n      \"name\": \"Age\",\r\n      \"type\": \"float\"\r\n    },\r\n    {\r\n      \"name\": \"Workclass\",\r\n      \"type\": \"integer\"\r\n    },\r\n    {\r\n      \"name\": \"Education-Num\",\r\n      \"type\": \"float\"\r\n    },\r\n    {\r\n      \"name\": \"Marital Status\",\r\n      \"type\": \"integer\"\r\n    },\r\n    {\r\n      \"name\": \"Occupation\",\r\n      \"type\": \"integer\"\r\n    },\r\n    {\r\n      \"name\": \"Relationship\",\r\n      \"type\": \"long\"\r\n    },\r\n    {\r\n      \"name\": \"Race\",\r\n      \"type\": \"integer\"\r\n    },\r\n    {\r\n      \"name\": \"Sex\",\r\n      \"type\": \"integer\"\r\n    },\r\n    {\r\n      \"name\": \"Capital Gain\",\r\n      \"type\": \"float\"\r\n    },\r\n    {\r\n      \"name\": \"Capital Loss\",\r\n      \"type\": \"float\"\r\n    },\r\n    {\r\n      \"name\": \"Hours per week\",\r\n      \"type\": \"float\"\r\n    },\r\n    {\r\n      \"name\": \"Country\",\r\n      \"type\": \"integer\"\r\n    }\r\n  ],\r\n  \"outputs\": [\r\n    {\r\n      \"type\": \"tensor\",\r\n      \"tensor-spec\": {\r\n        \"dtype\": \"int64\",\r\n        \"shape\": [\r\n          -1\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\n```\r\n\r\nThere aren't ways of loading an arbitrary `pyfunc` model and running explanations on it (since the structure of the passed-in data is going to be different (which is the exception that you're seeing). This is by design. Please see the two examples above for the approved ways of trying to do what you're doing. \r\nWe currently do not have any plans to support the use case that you originally were trying to do. ","reactions":{"url":"https://api.github.com/repos/mlflow/mlflow/issues/comments/1306104403/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false}},{"id":7755805470,"node_id":"CE_lADOCB5Jx85VSXRLzwAAAAHOSDMe","url":"https://api.github.com/repos/mlflow/mlflow/issues/events/7755805470","actor":{"login":"BenWilson2","id":39283302,"node_id":"MDQ6VXNlcjM5MjgzMzAy","avatar_url":"https://avatars.githubusercontent.com/u/39283302?v=4","gravatar_id":"","url":"https://api.github.com/users/BenWilson2","html_url":"https://github.com/BenWilson2","followers_url":"https://api.github.com/users/BenWilson2/followers","following_url":"https://api.github.com/users/BenWilson2/following{/other_user}","gists_url":"https://api.github.com/users/BenWilson2/gists{/gist_id}","starred_url":"https://api.github.com/users/BenWilson2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BenWilson2/subscriptions","organizations_url":"https://api.github.com/users/BenWilson2/orgs","repos_url":"https://api.github.com/users/BenWilson2/repos","events_url":"https://api.github.com/users/BenWilson2/events{/privacy}","received_events_url":"https://api.github.com/users/BenWilson2/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-11-07T19:47:29Z","state_reason":null,"performed_via_github_app":null}]