[{"actor":{"login":"anthony-sarkis","id":18080164,"node_id":"MDQ6VXNlcjE4MDgwMTY0","avatar_url":"https://avatars.githubusercontent.com/u/18080164?v=4","gravatar_id":"","url":"https://api.github.com/users/anthony-sarkis","html_url":"https://github.com/anthony-sarkis","followers_url":"https://api.github.com/users/anthony-sarkis/followers","following_url":"https://api.github.com/users/anthony-sarkis/following{/other_user}","gists_url":"https://api.github.com/users/anthony-sarkis/gists{/gist_id}","starred_url":"https://api.github.com/users/anthony-sarkis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anthony-sarkis/subscriptions","organizations_url":"https://api.github.com/users/anthony-sarkis/orgs","repos_url":"https://api.github.com/users/anthony-sarkis/repos","events_url":"https://api.github.com/users/anthony-sarkis/events{/privacy}","received_events_url":"https://api.github.com/users/anthony-sarkis/received_events","type":"User","site_admin":false},"created_at":"2022-02-14T20:19:23Z","updated_at":"2022-02-14T20:19:23Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/593","repository_url":"https://api.github.com/repos/diffgram/diffgram","labels_url":"https://api.github.com/repos/diffgram/diffgram/issues/593/labels{/name}","comments_url":"https://api.github.com/repos/diffgram/diffgram/issues/593/comments","events_url":"https://api.github.com/repos/diffgram/diffgram/issues/593/events","html_url":"https://github.com/diffgram/diffgram/pull/593","id":1134766392,"node_id":"PR_kwDOCM48Rc4ypOBj","number":593,"title":"Change file path from original file to the actual thumbnail file","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-02-12T23:09:25Z","updated_at":"2022-02-14T20:19:23Z","closed_at":"2022-02-14T20:17:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"draft":false,"repository":{"id":147733573,"node_id":"MDEwOlJlcG9zaXRvcnkxNDc3MzM1NzM=","name":"diffgram","full_name":"diffgram/diffgram","private":false,"owner":{"login":"diffgram","id":41310671,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQxMzEwNjcx","avatar_url":"https://avatars.githubusercontent.com/u/41310671?v=4","gravatar_id":"","url":"https://api.github.com/users/diffgram","html_url":"https://github.com/diffgram","followers_url":"https://api.github.com/users/diffgram/followers","following_url":"https://api.github.com/users/diffgram/following{/other_user}","gists_url":"https://api.github.com/users/diffgram/gists{/gist_id}","starred_url":"https://api.github.com/users/diffgram/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diffgram/subscriptions","organizations_url":"https://api.github.com/users/diffgram/orgs","repos_url":"https://api.github.com/users/diffgram/repos","events_url":"https://api.github.com/users/diffgram/events{/privacy}","received_events_url":"https://api.github.com/users/diffgram/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/diffgram/diffgram","description":"Training Data (Annotation, Catalog, Workflow) for all Data Types (Image, Video, 3D, Text, Geo, Audio, more) at scale.","fork":false,"url":"https://api.github.com/repos/diffgram/diffgram","forks_url":"https://api.github.com/repos/diffgram/diffgram/forks","keys_url":"https://api.github.com/repos/diffgram/diffgram/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diffgram/diffgram/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diffgram/diffgram/teams","hooks_url":"https://api.github.com/repos/diffgram/diffgram/hooks","issue_events_url":"https://api.github.com/repos/diffgram/diffgram/issues/events{/number}","events_url":"https://api.github.com/repos/diffgram/diffgram/events","assignees_url":"https://api.github.com/repos/diffgram/diffgram/assignees{/user}","branches_url":"https://api.github.com/repos/diffgram/diffgram/branches{/branch}","tags_url":"https://api.github.com/repos/diffgram/diffgram/tags","blobs_url":"https://api.github.com/repos/diffgram/diffgram/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diffgram/diffgram/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diffgram/diffgram/git/refs{/sha}","trees_url":"https://api.github.com/repos/diffgram/diffgram/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diffgram/diffgram/statuses/{sha}","languages_url":"https://api.github.com/repos/diffgram/diffgram/languages","stargazers_url":"https://api.github.com/repos/diffgram/diffgram/stargazers","contributors_url":"https://api.github.com/repos/diffgram/diffgram/contributors","subscribers_url":"https://api.github.com/repos/diffgram/diffgram/subscribers","subscription_url":"https://api.github.com/repos/diffgram/diffgram/subscription","commits_url":"https://api.github.com/repos/diffgram/diffgram/commits{/sha}","git_commits_url":"https://api.github.com/repos/diffgram/diffgram/git/commits{/sha}","comments_url":"https://api.github.com/repos/diffgram/diffgram/comments{/number}","issue_comment_url":"https://api.github.com/repos/diffgram/diffgram/issues/comments{/number}","contents_url":"https://api.github.com/repos/diffgram/diffgram/contents/{+path}","compare_url":"https://api.github.com/repos/diffgram/diffgram/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diffgram/diffgram/merges","archive_url":"https://api.github.com/repos/diffgram/diffgram/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diffgram/diffgram/downloads","issues_url":"https://api.github.com/repos/diffgram/diffgram/issues{/number}","pulls_url":"https://api.github.com/repos/diffgram/diffgram/pulls{/number}","milestones_url":"https://api.github.com/repos/diffgram/diffgram/milestones{/number}","notifications_url":"https://api.github.com/repos/diffgram/diffgram/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diffgram/diffgram/labels{/name}","releases_url":"https://api.github.com/repos/diffgram/diffgram/releases{/id}","deployments_url":"https://api.github.com/repos/diffgram/diffgram/deployments","created_at":"2018-09-06T21:04:23Z","updated_at":"2023-01-19T12:20:49Z","pushed_at":"2023-01-19T20:27:21Z","git_url":"git://github.com/diffgram/diffgram.git","ssh_url":"git@github.com:diffgram/diffgram.git","clone_url":"https://github.com/diffgram/diffgram.git","svn_url":"https://github.com/diffgram/diffgram","homepage":"https://diffgram.com","size":55216,"stargazers_count":1611,"watchers_count":1611,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":98,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":365,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["annotation","annotation-tool","annotations","data","data-analytics","data-annotation","data-science","datasets","deep-learning","helm","image-annotation","kubernetes","labeling","machine-learning","mlops","object-detection","segmentation","training-data","training-data-storage","video-annotation"],"visibility":"public","forks":98,"open_issues":365,"watchers":1611,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/diffgram/diffgram/pulls/593","html_url":"https://github.com/diffgram/diffgram/pull/593","diff_url":"https://github.com/diffgram/diffgram/pull/593.diff","patch_url":"https://github.com/diffgram/diffgram/pull/593.patch","merged_at":"2022-02-14T20:17:26Z"},"body":"I think the original file got uploaded instead of the thumbnail. Result is shown below (file 14 + thumb is old code, file 15 + thumb is the new code)\r\n\r\n![image](https://user-images.githubusercontent.com/1612886/153731639-626c5c90-3fe0-49c1-8b33-a9ceba5f0326.png)\r\n\r\n\r\nThis will fix #592","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/593/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diffgram/diffgram/issues/593/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6069979900,"node_id":"LE_lADOCM48Rc5D0Vx5zwAAAAFpzIr8","url":"https://api.github.com/repos/diffgram/diffgram/issues/events/6069979900","actor":{"login":"anthony-sarkis","id":18080164,"node_id":"MDQ6VXNlcjE4MDgwMTY0","avatar_url":"https://avatars.githubusercontent.com/u/18080164?v=4","gravatar_id":"","url":"https://api.github.com/users/anthony-sarkis","html_url":"https://github.com/anthony-sarkis","followers_url":"https://api.github.com/users/anthony-sarkis/followers","following_url":"https://api.github.com/users/anthony-sarkis/following{/other_user}","gists_url":"https://api.github.com/users/anthony-sarkis/gists{/gist_id}","starred_url":"https://api.github.com/users/anthony-sarkis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anthony-sarkis/subscriptions","organizations_url":"https://api.github.com/users/anthony-sarkis/orgs","repos_url":"https://api.github.com/users/anthony-sarkis/repos","events_url":"https://api.github.com/users/anthony-sarkis/events{/privacy}","received_events_url":"https://api.github.com/users/anthony-sarkis/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-02-14T20:24:30Z","label":{"name":"discussion","color":"E49EC3"},"performed_via_github_app":null},{"id":6069979903,"node_id":"LE_lADOCM48Rc5D0Vx5zwAAAAFpzIr_","url":"https://api.github.com/repos/diffgram/diffgram/issues/events/6069979903","actor":{"login":"anthony-sarkis","id":18080164,"node_id":"MDQ6VXNlcjE4MDgwMTY0","avatar_url":"https://avatars.githubusercontent.com/u/18080164?v=4","gravatar_id":"","url":"https://api.github.com/users/anthony-sarkis","html_url":"https://github.com/anthony-sarkis","followers_url":"https://api.github.com/users/anthony-sarkis/followers","following_url":"https://api.github.com/users/anthony-sarkis/following{/other_user}","gists_url":"https://api.github.com/users/anthony-sarkis/gists{/gist_id}","starred_url":"https://api.github.com/users/anthony-sarkis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anthony-sarkis/subscriptions","organizations_url":"https://api.github.com/users/anthony-sarkis/orgs","repos_url":"https://api.github.com/users/anthony-sarkis/repos","events_url":"https://api.github.com/users/anthony-sarkis/events{/privacy}","received_events_url":"https://api.github.com/users/anthony-sarkis/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-02-14T20:24:30Z","label":{"name":"question","color":"d876e3"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040341784","html_url":"https://github.com/diffgram/diffgram/issues/596#issuecomment-1040341784","issue_url":"https://api.github.com/repos/diffgram/diffgram/issues/596","id":1040341784,"node_id":"IC_kwDOCM48Rc4-AlsY","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"created_at":"2022-02-15T14:30:50Z","updated_at":"2022-02-15T14:30:50Z","author_association":"CONTRIBUTOR","body":"In my opinion having the facing media just as a copy of the raw media would be the best option (by default). When using userscripts you want them to use the original unaltered file, and not a lower quality one in the case of lossy formats.\r\n\r\nFor lossless formats my concern is processing power. Bandwith and storage are relatively cheap, but if someone wants to upload 10.000 already optimized PNG images (say compress_level=8) this would take a long time to process, because the imageio.imwrite function for PNG defaults to compression level 9 (best compression but slowest). I think in case someone forgets to optimize their PNG this is going to be beneficial, but if someone already has heavily optimized PNG images we will only make them bigger if we select a lower compress_level.\r\n\r\nThe table below gives some file size results, starting with no compression (0) and ending with highest compression (9).\r\n\r\n| compress_level| Time | Filesize  |Percentage|\r\n|---|---|---|---|\r\n|0|0.07|7047.2kB|100.0| \r\n|1|0.14|2238.1kB|31.8| \r\n|2|0.17|2169.2kB|30.8| \r\n|3|0.24|2037.3kB|28.9| \r\n|4|0.23|1896.8kB|26.9| \r\n|5|0.45|1851.0kB|26.3| \r\n|6|0.75|1804.9kB|25.6| \r\n|7|1.21|1782.1kB|25.3| \r\n|8|4.52|1726.0kB|24.5| \r\n|9|9.30|1700.9kB|24.1| \r\n\r\nWhat we could do is calculate the compression level of a file, and if it is above a threshold, say 50%, the facing media gets written to a new file with compress_level=4 for example. Otherwise the original media gets used.\r\n\r\nLet me know your thoughts.","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040341784/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040407549","html_url":"https://github.com/diffgram/diffgram/issues/596#issuecomment-1040407549","issue_url":"https://api.github.com/repos/diffgram/diffgram/issues/596","id":1040407549,"node_id":"IC_kwDOCM48Rc4-A1v9","user":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"created_at":"2022-02-15T15:24:13Z","updated_at":"2022-02-15T15:24:13Z","author_association":"MEMBER","body":"> In my opinion having the facing media just as a copy of the raw media would be the best option (by default). When using userscripts you want them to use the original unaltered file, and not a lower quality one in the case of lossy formats.\r\n> \r\n> For lossless formats my concern is processing power. Bandwith and storage are relatively cheap, but if someone wants to upload 10.000 already optimized PNG images (say compress_level=8) this would take a long time to process, because the imageio.imwrite function for PNG defaults to compression level 9 (best compression but slowest). I think in case someone forgets to optimize their PNG this is going to be beneficial, but if someone already has heavily optimized PNG images we will only make them bigger if we select a lower compress_level.\r\n> \r\n> The table below gives some file size results, starting with no compression (0) and ending with highest compression (9).\r\n> \r\n> compress_level\tTime\tFilesize\tPercentage\r\n> 0\t0.07\t7047.2kB\t100.0\r\n> 1\t0.14\t2238.1kB\t31.8\r\n> 2\t0.17\t2169.2kB\t30.8\r\n> 3\t0.24\t2037.3kB\t28.9\r\n> 4\t0.23\t1896.8kB\t26.9\r\n> 5\t0.45\t1851.0kB\t26.3\r\n> 6\t0.75\t1804.9kB\t25.6\r\n> 7\t1.21\t1782.1kB\t25.3\r\n> 8\t4.52\t1726.0kB\t24.5\r\n> 9\t9.30\t1700.9kB\t24.1\r\n> What we could do is calculate the compression level of a file, and if it is above a threshold, say 50%, the facing media gets written to a new file with compress_level=4 for example. Otherwise the original media gets used.\r\n> \r\n> Let me know your thoughts.\r\n\r\nThis table was very useful thanks for putting that together. \r\n\r\nI really like the idea of having a compression threshold. It's a nice balance between storage optimization and CPU optimization.  Is the compressions level calculation a low cost operation? If so I think that would be the best route to have the optimized images","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040407549/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040651773","html_url":"https://github.com/diffgram/diffgram/issues/596#issuecomment-1040651773","issue_url":"https://api.github.com/repos/diffgram/diffgram/issues/596","id":1040651773,"node_id":"IC_kwDOCM48Rc4-BxX9","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"created_at":"2022-02-15T18:48:16Z","updated_at":"2022-02-15T18:48:16Z","author_association":"CONTRIBUTOR","body":"Yes it actually is. I haven't found out if the actual compression level is stored in the file, but the calculation is simple and fast.\r\nfile_size / (image_width * image_height * image_depth * image_channels) = compression ratio.\r\n\r\nThere is 1 problem though, and that is that not every PNG file has the same characteristics.\r\n\r\nI did some more testing with a PNG with Perlin noise. Those results are wildly different.\r\n![image](https://user-images.githubusercontent.com/1612886/154127262-ad5d29f3-f007-42af-b7db-812bd8203c6f.png)\r\n\r\n| Compression  | Time | Filesize  |Percentage|\r\n|---|---|---|---|\r\n|0|0.12|7047.2kB|100.0| \r\n|1|0.27|5214.3kB|74.0| \r\n|2|0.27|5213.7kB|74.0| \r\n|3|0.27|5213.7kB|74.0| \r\n|4|0.35|4929.9kB|70.0| \r\n|5|0.32|4929.9kB|70.0| \r\n|6|0.46|4929.9kB|70.0| \r\n|7|0.47|4929.9kB|70.0| \r\n|8|0.36|4929.9kB|70.0| \r\n|9|0.33|4929.9kB|70.0| \r\n\r\nBoth the compression (bad, to be expected) but also the amount of time being used. It just gives up faster if it can't compress good enough.\r\n\r\nMaybe the best approach would be to pick compress_level=2, compare the file size and pick the smallest one? This is getting kind of complicated because there isn't a one size fits all solution.\r\n\r\nIf the main focus is scale, then it might even be better to not apply compression at all or to do that client side.\r\n\r\n@PJEstrada What are your thoughts after this update?","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040651773/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false}},{"id":6077400487,"node_id":"MEE_lADOCM48Rc5D0Vx5zwAAAAFqPcWn","url":"https://api.github.com/repos/diffgram/diffgram/issues/events/6077400487","actor":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-02-15T18:48:16Z","performed_via_github_app":null},{"id":6077400492,"node_id":"SE_lADOCM48Rc5D0Vx5zwAAAAFqPcWs","url":"https://api.github.com/repos/diffgram/diffgram/issues/events/6077400492","actor":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-02-15T18:48:16Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040824708","html_url":"https://github.com/diffgram/diffgram/issues/596#issuecomment-1040824708","issue_url":"https://api.github.com/repos/diffgram/diffgram/issues/596","id":1040824708,"node_id":"IC_kwDOCM48Rc4-CbmE","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"created_at":"2022-02-15T21:43:49Z","updated_at":"2022-02-15T21:43:49Z","author_association":"CONTRIBUTOR","body":"I just stumbled upon this post:\r\nhttps://stackoverflow.com/questions/33037971/how-to-detect-the-compression-level-of-a-png-file\r\n\r\nSo there should be something in the header of the file that can be converted to a compression level. I will look if there is a python equivalent to check this.","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040824708/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040939758","html_url":"https://github.com/diffgram/diffgram/issues/596#issuecomment-1040939758","issue_url":"https://api.github.com/repos/diffgram/diffgram/issues/596","id":1040939758,"node_id":"IC_kwDOCM48Rc4-C3ru","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"created_at":"2022-02-16T00:34:19Z","updated_at":"2022-02-16T00:35:28Z","author_association":"CONTRIBUTOR","body":"**TLDR: Uploaded files should not be compressed unless no compression was used at all.**\r\n\r\nIt seems to be that the compression header can be found easier in the file itself than on the internet.\r\n\r\nhttps://stackoverflow.com/questions/9050260/what-does-a-zlib-header-look-like\r\n\r\n\r\n|Level | ZLIB   | DESCRIPTION |\r\n|---|---|---|\r\n|  0   | 78 01 |superfast|\r\n|  1   | 78 01 |superfast|\r\n|  2   | 78 5E |fast|\r\n|  3   | 78 5E |fast|\r\n|  4   | 78 5E |fast|\r\n|  5   | 78 5E |fast|\r\n|  6   | 78 9C |default|\r\n|  7   | 78 DA |maximum|\r\n|  8   | 78 DA |maximum|\r\n|  9   | 78 DA |maximum|\r\n\r\nSo this means reading byte 63 from the file and comparing it with the ZLIB compression level number will give the current compression level.\r\n\r\nConsidering the marginal gains on anything over fast compression I think checking if superfast compression was used, and if so apply fast compression at compress_level=2.\r\n\r\nBecause of the relatively complex code to determine the compression level an easier way is to see if level 0 was used (by calculating the ratio (width * height * channels) / filesize, and in that case only apply compress_level=2 to the file, because the difference between level 0 and 1 is already pretty big.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/comments/1040939758/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false}},{"actor":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"created_at":"2022-02-16T02:14:50Z","updated_at":"2022-02-16T02:14:50Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/606","repository_url":"https://api.github.com/repos/diffgram/diffgram","labels_url":"https://api.github.com/repos/diffgram/diffgram/issues/606/labels{/name}","comments_url":"https://api.github.com/repos/diffgram/diffgram/issues/606/comments","events_url":"https://api.github.com/repos/diffgram/diffgram/issues/606/events","html_url":"https://github.com/diffgram/diffgram/pull/606","id":1139439018,"node_id":"PR_kwDOCM48Rc4y5XD4","number":606,"title":"Fix image compression on facing media","user":{"login":"MathijsNL","id":1612886,"node_id":"MDQ6VXNlcjE2MTI4ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1612886?v=4","gravatar_id":"","url":"https://api.github.com/users/MathijsNL","html_url":"https://github.com/MathijsNL","followers_url":"https://api.github.com/users/MathijsNL/followers","following_url":"https://api.github.com/users/MathijsNL/following{/other_user}","gists_url":"https://api.github.com/users/MathijsNL/gists{/gist_id}","starred_url":"https://api.github.com/users/MathijsNL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MathijsNL/subscriptions","organizations_url":"https://api.github.com/users/MathijsNL/orgs","repos_url":"https://api.github.com/users/MathijsNL/repos","events_url":"https://api.github.com/users/MathijsNL/events{/privacy}","received_events_url":"https://api.github.com/users/MathijsNL/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-16T02:14:50Z","updated_at":"2022-02-18T13:53:02Z","closed_at":"2022-02-18T13:53:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"draft":false,"repository":{"id":147733573,"node_id":"MDEwOlJlcG9zaXRvcnkxNDc3MzM1NzM=","name":"diffgram","full_name":"diffgram/diffgram","private":false,"owner":{"login":"diffgram","id":41310671,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQxMzEwNjcx","avatar_url":"https://avatars.githubusercontent.com/u/41310671?v=4","gravatar_id":"","url":"https://api.github.com/users/diffgram","html_url":"https://github.com/diffgram","followers_url":"https://api.github.com/users/diffgram/followers","following_url":"https://api.github.com/users/diffgram/following{/other_user}","gists_url":"https://api.github.com/users/diffgram/gists{/gist_id}","starred_url":"https://api.github.com/users/diffgram/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diffgram/subscriptions","organizations_url":"https://api.github.com/users/diffgram/orgs","repos_url":"https://api.github.com/users/diffgram/repos","events_url":"https://api.github.com/users/diffgram/events{/privacy}","received_events_url":"https://api.github.com/users/diffgram/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/diffgram/diffgram","description":"Training Data (Annotation, Catalog, Workflow) for all Data Types (Image, Video, 3D, Text, Geo, Audio, more) at scale.","fork":false,"url":"https://api.github.com/repos/diffgram/diffgram","forks_url":"https://api.github.com/repos/diffgram/diffgram/forks","keys_url":"https://api.github.com/repos/diffgram/diffgram/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diffgram/diffgram/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diffgram/diffgram/teams","hooks_url":"https://api.github.com/repos/diffgram/diffgram/hooks","issue_events_url":"https://api.github.com/repos/diffgram/diffgram/issues/events{/number}","events_url":"https://api.github.com/repos/diffgram/diffgram/events","assignees_url":"https://api.github.com/repos/diffgram/diffgram/assignees{/user}","branches_url":"https://api.github.com/repos/diffgram/diffgram/branches{/branch}","tags_url":"https://api.github.com/repos/diffgram/diffgram/tags","blobs_url":"https://api.github.com/repos/diffgram/diffgram/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diffgram/diffgram/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diffgram/diffgram/git/refs{/sha}","trees_url":"https://api.github.com/repos/diffgram/diffgram/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diffgram/diffgram/statuses/{sha}","languages_url":"https://api.github.com/repos/diffgram/diffgram/languages","stargazers_url":"https://api.github.com/repos/diffgram/diffgram/stargazers","contributors_url":"https://api.github.com/repos/diffgram/diffgram/contributors","subscribers_url":"https://api.github.com/repos/diffgram/diffgram/subscribers","subscription_url":"https://api.github.com/repos/diffgram/diffgram/subscription","commits_url":"https://api.github.com/repos/diffgram/diffgram/commits{/sha}","git_commits_url":"https://api.github.com/repos/diffgram/diffgram/git/commits{/sha}","comments_url":"https://api.github.com/repos/diffgram/diffgram/comments{/number}","issue_comment_url":"https://api.github.com/repos/diffgram/diffgram/issues/comments{/number}","contents_url":"https://api.github.com/repos/diffgram/diffgram/contents/{+path}","compare_url":"https://api.github.com/repos/diffgram/diffgram/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diffgram/diffgram/merges","archive_url":"https://api.github.com/repos/diffgram/diffgram/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diffgram/diffgram/downloads","issues_url":"https://api.github.com/repos/diffgram/diffgram/issues{/number}","pulls_url":"https://api.github.com/repos/diffgram/diffgram/pulls{/number}","milestones_url":"https://api.github.com/repos/diffgram/diffgram/milestones{/number}","notifications_url":"https://api.github.com/repos/diffgram/diffgram/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diffgram/diffgram/labels{/name}","releases_url":"https://api.github.com/repos/diffgram/diffgram/releases{/id}","deployments_url":"https://api.github.com/repos/diffgram/diffgram/deployments","created_at":"2018-09-06T21:04:23Z","updated_at":"2023-01-19T12:20:49Z","pushed_at":"2023-01-19T20:27:21Z","git_url":"git://github.com/diffgram/diffgram.git","ssh_url":"git@github.com:diffgram/diffgram.git","clone_url":"https://github.com/diffgram/diffgram.git","svn_url":"https://github.com/diffgram/diffgram","homepage":"https://diffgram.com","size":55216,"stargazers_count":1611,"watchers_count":1611,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":98,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":365,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["annotation","annotation-tool","annotations","data","data-analytics","data-annotation","data-science","datasets","deep-learning","helm","image-annotation","kubernetes","labeling","machine-learning","mlops","object-detection","segmentation","training-data","training-data-storage","video-annotation"],"visibility":"public","forks":98,"open_issues":365,"watchers":1611,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/diffgram/diffgram/pulls/606","html_url":"https://github.com/diffgram/diffgram/pull/606","diff_url":"https://github.com/diffgram/diffgram/pull/606.diff","patch_url":"https://github.com/diffgram/diffgram/pull/606.patch","merged_at":"2022-02-18T13:53:02Z"},"body":"This fixes #596\r\n\r\nNew behavior for lossy formats is to save original raw image as facing media.\r\n\r\nNew behavior for PNG is to only rewrite the file if compress_level=0 or 1. It will apply compress level 2 in that case.\r\n\r\nLossy formats can be verified by uploading jpg through diffgram and download from cloud storage and compare the hash.\r\nPNG format can be verified by uploading any PNG with compress_level=2..9 and download from cloud storage and compare the hash. For level 0 and 1 you can upload and see the file size decrease (although the difference between level 1 and 2 is small sometimes).\r\n\r\nAs for the reason I didn't go for the idea of using the filesize is because there isn't a reliable way to determine the alpha channel after it is removed.\r\n\r\nThe check for compression level takes about 0.7 seconds per 10.000 PNG files (reading the byte and assigning the Boolean). \r\n\r\nAltering this to use default compression is possible as well. I leave that design choice to you.\r\n\r\nJust need to check for Superfast and Fast compression\r\n```\r\ncompress = ( f.read(1) in [b'\\x01', b'^'] )\r\n```\r\n\r\nAnd change the compress_level to 6\r\n```\r\nimwrite(new_temp_filename, np.asarray(self.raw_numpy_image), compress_level=6)\r\n```\r\n\r\n\r\nBulk uploads of 10K images could take up to an hour to process if the compression needs to be applied to all of them in case level 6 gets chosen. The space saved for images at level 5 could be 470mB, and for to level 2 and 6 could be 4.340mB.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/606/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diffgram/diffgram/issues/606/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6099301709,"node_id":"CE_lADOCM48Rc5D0Vx5zwAAAAFri_VN","url":"https://api.github.com/repos/diffgram/diffgram/issues/events/6099301709","actor":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-02-18T13:53:02Z","state_reason":null,"performed_via_github_app":null}]