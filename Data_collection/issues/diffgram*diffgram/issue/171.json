{"url":"https://api.github.com/repos/diffgram/diffgram/issues/171","repository_url":"https://api.github.com/repos/diffgram/diffgram","labels_url":"https://api.github.com/repos/diffgram/diffgram/issues/171/labels{/name}","comments_url":"https://api.github.com/repos/diffgram/diffgram/issues/171/comments","events_url":"https://api.github.com/repos/diffgram/diffgram/issues/171/events","html_url":"https://github.com/diffgram/diffgram/issues/171","id":951692328,"node_id":"MDU6SXNzdWU5NTE2OTIzMjg=","number":171,"title":"Max Connection Pool Reached When Importing 200k images on Walrus","user":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"labels":[{"id":1048365663,"node_id":"MDU6TGFiZWwxMDQ4MzY1NjYz","url":"https://api.github.com/repos/diffgram/diffgram/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"},{"id":3194400357,"node_id":"MDU6TGFiZWwzMTk0NDAwMzU3","url":"https://api.github.com/repos/diffgram/diffgram/labels/walrus","name":"walrus","color":"0927AC","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"assignees":[{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2021-07-23T15:44:56Z","updated_at":"2021-07-23T20:07:21Z","closed_at":"2021-07-23T20:07:21Z","author_association":"MEMBER","active_lock_reason":null,"body":"While importing 200k images,  the process stopped with the following log error on the Walrus service.\r\n\r\n![image](https://user-images.githubusercontent.com/73854485/126805273-a6710dfc-40bd-4fdf-8a45-a870fa9391d3.png)\r\n\r\n```\r\nAttaching to diffgram_walrus_1\r\nwalrus_1      | Exception in thread Thread-83199:\r\nwalrus_1      | Traceback (most recent call last):\r\nwalrus_1      |   File \"/usr/lib/python3.6/threading.py\", line 916, in _bootstrap_inner\r\nwalrus_1      |     self.run()\r\nwalrus_1      |   File \"/usr/lib/python3.6/threading.py\", line 864, in run\r\nwalrus_1      |     self._target(*self._args, **self._kwargs)\r\nwalrus_1      |   File \"/app/shared/database/event/event.py\", line 207, in __new_event_threaded\r\nwalrus_1      |     event = Event.new(**event_args)\r\nwalrus_1      |   File \"/app/shared/database/event/event.py\", line 290, in new\r\nwalrus_1      |     session.flush()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2540, in flush\r\nwalrus_1      |     self._flush(objects)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2682, in _flush\r\nwalrus_1      |     transaction.rollback(_capture_exception=True)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\nwalrus_1      |     with_traceback=exc_tb,\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/util/compat.py\", line 182, in raise_\r\nwalrus_1      |     raise exception\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2642, in _flush\r\nwalrus_1      |     flush_context.execute()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 422, in execute\r\nwalrus_1      |     rec.execute(self)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 589, in execute\r\nwalrus_1      |     uow,\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 213, in save_obj\r\nwalrus_1      |     ) in _organize_states_for_save(base_mapper, states, uowtransaction):\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 374, in _organize_states_for_save\r\nwalrus_1      |     base_mapper, uowtransaction, states\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 1602, in _connections_for_states\r\nwalrus_1      |     connection = uowtransaction.transaction.connection(base_mapper)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 314, in connection\r\nwalrus_1      |     return self._connection_for_bind(bind, execution_options)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 421, in _connection_for_bind\r\nwalrus_1      |     conn = self._parent._connection_for_bind(bind, execution_options)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 433, in _connection_for_bind\r\nwalrus_1      |     conn = bind._contextual_connect()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/engine/base.py\", line 2302, in _contextual_connect\r\nwalrus_1      |     self._wrap_pool_connect(self.pool.connect, None),\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/engine/base.py\", line 2336, in _wrap_pool_connect\r\nwalrus_1      |     return fn()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 364, in connect\r\nwalrus_1      |     return _ConnectionFairy._checkout(self)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 778, in _checkout\r\nwalrus_1      |     fairy = _ConnectionRecord.checkout(pool)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 495, in checkout\r\nwalrus_1      |     rec = pool._do_get()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/impl.py\", line 132, in _do_get\r\nwalrus_1      |     code=\"3o7r\",\r\nwalrus_1      | sqlalchemy.exc.TimeoutError: QueuePool limit of size 10 overflow 2 reached, connection timed out, timeout 30 (Background on this error at: http://sqlalche.me/e/13/3o7r)\r\nwalrus_1      | \r\nwalrus_1      | Exception in thread Thread-88477:\r\nwalrus_1      | Traceback (most recent call last):\r\nwalrus_1      |   File \"/usr/lib/python3.6/threading.py\", line 916, in _bootstrap_inner\r\nwalrus_1      |     self.run()\r\nwalrus_1      |   File \"/usr/lib/python3.6/threading.py\", line 864, in run\r\nwalrus_1      |     self._target(*self._args, **self._kwargs)\r\nwalrus_1      |   File \"/app/shared/database/event/event.py\", line 207, in __new_event_threaded\r\nwalrus_1      |     event = Event.new(**event_args)\r\nwalrus_1      |   File \"/app/shared/database/event/event.py\", line 290, in new\r\nwalrus_1      |     session.flush()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2540, in flush\r\nwalrus_1      |     self._flush(objects)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2682, in _flush\r\nwalrus_1      |     transaction.rollback(_capture_exception=True)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/util/langhelpers.py\", line 70, in __exit__\r\nwalrus_1      |     with_traceback=exc_tb,\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/util/compat.py\", line 182, in raise_\r\nwalrus_1      |     raise exception\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 2642, in _flush\r\nwalrus_1      |     flush_context.execute()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 422, in execute\r\nwalrus_1      |     rec.execute(self)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/unitofwork.py\", line 589, in execute\r\nwalrus_1      |     uow,\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 213, in save_obj\r\nwalrus_1      |     ) in _organize_states_for_save(base_mapper, states, uowtransaction):\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 374, in _organize_states_for_save\r\nwalrus_1      |     base_mapper, uowtransaction, states\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/persistence.py\", line 1602, in _connections_for_states\r\nwalrus_1      |     connection = uowtransaction.transaction.connection(base_mapper)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 314, in connection\r\nwalrus_1      |     return self._connection_for_bind(bind, execution_options)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 421, in _connection_for_bind\r\nwalrus_1      |     conn = self._parent._connection_for_bind(bind, execution_options)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/orm/session.py\", line 433, in _connection_for_bind\r\nwalrus_1      |     conn = bind._contextual_connect()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/engine/base.py\", line 2302, in _contextual_connect\r\nwalrus_1      |     self._wrap_pool_connect(self.pool.connect, None),\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/engine/base.py\", line 2336, in _wrap_pool_connect\r\nwalrus_1      |     return fn()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 364, in connect\r\nwalrus_1      |     return _ConnectionFairy._checkout(self)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 778, in _checkout\r\nwalrus_1      |     fairy = _ConnectionRecord.checkout(pool)\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/base.py\", line 495, in checkout\r\nwalrus_1      |     rec = pool._do_get()\r\nwalrus_1      |   File \"/usr/local/lib/python3.6/dist-packages/sqlalchemy/pool/impl.py\", line 132, in _do_get\r\nwalrus_1      |     code=\"3o7r\",\r\nwalrus_1      | sqlalchemy.exc.TimeoutError: QueuePool limit of size 10 overflow 2 reached, connection timed out, timeout 30 (Background on this error at: http://sqlalche.me/e/13/3o7r)\r\n\r\n```\r\n\r\n_Originally posted by @cvm-int in https://github.com/diffgram/diffgram/issues/160#issuecomment-885720379_","closed_by":{"login":"PJEstrada","id":6606958,"node_id":"MDQ6VXNlcjY2MDY5NTg=","avatar_url":"https://avatars.githubusercontent.com/u/6606958?v=4","gravatar_id":"","url":"https://api.github.com/users/PJEstrada","html_url":"https://github.com/PJEstrada","followers_url":"https://api.github.com/users/PJEstrada/followers","following_url":"https://api.github.com/users/PJEstrada/following{/other_user}","gists_url":"https://api.github.com/users/PJEstrada/gists{/gist_id}","starred_url":"https://api.github.com/users/PJEstrada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PJEstrada/subscriptions","organizations_url":"https://api.github.com/users/PJEstrada/orgs","repos_url":"https://api.github.com/users/PJEstrada/repos","events_url":"https://api.github.com/users/PJEstrada/events{/privacy}","received_events_url":"https://api.github.com/users/PJEstrada/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diffgram/diffgram/issues/171/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diffgram/diffgram/issues/171/timeline","performed_via_github_app":null,"state_reason":"completed"}