[{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514531726","html_url":"https://github.com/kpe/bert-for-tf2/issues/5#issuecomment-514531726","issue_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/5","id":514531726,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDUzMTcyNg==","user":{"login":"kpe","id":2535923,"node_id":"MDQ6VXNlcjI1MzU5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/2535923?v=4","gravatar_id":"","url":"https://api.github.com/users/kpe","html_url":"https://github.com/kpe","followers_url":"https://api.github.com/users/kpe/followers","following_url":"https://api.github.com/users/kpe/following{/other_user}","gists_url":"https://api.github.com/users/kpe/gists{/gist_id}","starred_url":"https://api.github.com/users/kpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpe/subscriptions","organizations_url":"https://api.github.com/users/kpe/orgs","repos_url":"https://api.github.com/users/kpe/repos","events_url":"https://api.github.com/users/kpe/events{/privacy}","received_events_url":"https://api.github.com/users/kpe/received_events","type":"User","site_admin":false},"created_at":"2019-07-24T08:22:22Z","updated_at":"2019-07-24T08:22:22Z","author_association":"OWNER","body":"@breadbread1984 Your code above looks OK to me (keep in mind the `freeze_bert_layers` will not freeze the `LayerNorm` layers, which is needed for adapter-BERT). \r\nHow do you call `model.predict`?","reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514531726/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"kpe","id":2535923,"node_id":"MDQ6VXNlcjI1MzU5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/2535923?v=4","gravatar_id":"","url":"https://api.github.com/users/kpe","html_url":"https://github.com/kpe","followers_url":"https://api.github.com/users/kpe/followers","following_url":"https://api.github.com/users/kpe/following{/other_user}","gists_url":"https://api.github.com/users/kpe/gists{/gist_id}","starred_url":"https://api.github.com/users/kpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpe/subscriptions","organizations_url":"https://api.github.com/users/kpe/orgs","repos_url":"https://api.github.com/users/kpe/repos","events_url":"https://api.github.com/users/kpe/events{/privacy}","received_events_url":"https://api.github.com/users/kpe/received_events","type":"User","site_admin":false}},{"id":2505492729,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjUwNTQ5MjcyOQ==","url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/events/2505492729","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-07-24T08:22:22Z","performed_via_github_app":null},{"id":2505492731,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI1MDU0OTI3MzE=","url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/events/2505492731","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-07-24T08:22:22Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514626899","html_url":"https://github.com/kpe/bert-for-tf2/issues/5#issuecomment-514626899","issue_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/5","id":514626899,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDYyNjg5OQ==","user":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"created_at":"2019-07-24T13:14:48Z","updated_at":"2019-07-24T13:30:20Z","author_association":"NONE","body":"I just tokenize the input string pair and feed into bert.\r\nmy code is [here](https://github.com/breadbread1984/QASystem/blob/3338b1f02dd0d3e26aa502e8419a537a37c23d9d/Predictor.py#L177)\r\nthe bert is called at [here](https://github.com/breadbread1984/QASystem/blob/3338b1f02dd0d3e26aa502e8419a537a37c23d9d/Predictor.py#L154)\r\nthe preprocess code was copied from run_classifier.py from google official bert project.\r\nreally appreciate for your help.","reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514626899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514655200","html_url":"https://github.com/kpe/bert-for-tf2/issues/5#issuecomment-514655200","issue_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/5","id":514655200,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDY1NTIwMA==","user":{"login":"kpe","id":2535923,"node_id":"MDQ6VXNlcjI1MzU5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/2535923?v=4","gravatar_id":"","url":"https://api.github.com/users/kpe","html_url":"https://github.com/kpe","followers_url":"https://api.github.com/users/kpe/followers","following_url":"https://api.github.com/users/kpe/following{/other_user}","gists_url":"https://api.github.com/users/kpe/gists{/gist_id}","starred_url":"https://api.github.com/users/kpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpe/subscriptions","organizations_url":"https://api.github.com/users/kpe/orgs","repos_url":"https://api.github.com/users/kpe/repos","events_url":"https://api.github.com/users/kpe/events{/privacy}","received_events_url":"https://api.github.com/users/kpe/received_events","type":"User","site_admin":false},"created_at":"2019-07-24T14:26:57Z","updated_at":"2019-07-24T22:05:18Z","author_association":"OWNER","body":"@breadbread1984 - I think, it doesn't work because, there is no `Model` in your `_classify()` function. Keras needs a Model instance to wire a TF graph. You have built a model in `BERT.py` (e.g. calling `model.build()`), but you have a classifier (dropout and dense layers belonging to no model) in `_classify()` - and they are not wired into the execution graph. For this you either need a separate Model calling the bert-Model, or as an alternative, you can return the bert layer from `BERT.py`, and build a single classifier model to be used in `_classify()` (i.e. calling `model.build()` in `Predictor` only). Does this explanation make sense?\r\n\r\nTo make it work, you could change your code like this:\r\n\r\n```diff\r\ndiff --git a/BERT.py b/BERT.py\r\nindex 722d4bb..1a3b7f4 100644\r\n--- a/BERT.py\r\n+++ b/BERT.py\r\n@@ -39,7 +39,7 @@ def BERT(max_seq_len = 128, bert_model_dir = 'models/chinese_L-12_H-768_A-12', d\r\n     output = bert([input_token_ids, input_segment_ids]);\r\n     # create model containing only bert layer\r\n     model = tf.keras.Model(inputs = [input_token_ids, input_segment_ids], outputs = output);\r\n-    model.build(input_shape = [(None, max_seq_len), (None, max_seq_len)]);\r\n+    #model.build(input_shape = [(None, max_seq_len), (None, max_seq_len)]);\r\n     # freeze_bert_layers\r\n     freeze_bert_layers(bert);\r\n     # load bert layer weights\r\ndiff --git a/Predictor.py b/Predictor.py\r\nindex 2c7e6da..dd1dcfe 100644\r\n--- a/Predictor.py\r\n+++ b/Predictor.py\r\n@@ -151,15 +151,20 @@ class Predictor(object):\r\n     def _classify(self, inputs, mask, training = None):\r\n \r\n         # the first element of output sequence.\r\n-        outputs = self.bert(inputs, mask, training);\r\n+        outputs = self.bert.predict(inputs)\r\n+\r\n+        cls_input = tf.keras.Input((128,768,), dtype=tf.float32)\r\n         # first_token.shape = (batch, hidden_size)\r\n-        first_token = tf.keras.layers.Lambda(lambda seq: seq[:, 0, :])(outputs);\r\n-        first_token = tf.keras.Dropout(rate = 0.5)(first_token);\r\n+        first_token = tf.keras.layers.Lambda(lambda seq: seq[:, 0, :])(cls_input);\r\n+        first_token = tf.keras.layers.Dropout(rate = 0.5)(first_token);\r\n         pooled_output = tf.keras.layers.Dense(units = first_token.shape[-1], activation = tf.math.tanh)(first_token);\r\n         dropout = tf.keras.layers.Dropout(rate = 0.5)(pooled_output);\r\n         logits = tf.keras.layers.Dense(units = 2, activation = tf.nn.softmax)(dropout);\r\n \r\n-        return logits;\r\n+        model = tf.keras.models.Model(inputs=cls_input, outputs=logits)\r\n+        model.build(input_shape = (None, 128, 768))\r\n+\r\n+        return model.predict(outputs)\r\n \r\n     def predict(self, question, answer):\r\n \r\n@@ -167,6 +172,10 @@ class Predictor(object):\r\n         input_ids = tf.constant(input_ids, dtype = tf.int32);\r\n         input_mask = tf.constant(input_mask, dtype = tf.int32);\r\n         segment_ids = tf.constant(segment_ids, dtype = tf.int32);\r\n+\r\n+        input_ids = tf.expand_dims(input_ids, axis=0)\r\n+        segment_ids = tf.expand_dims(segment_ids, axis=0)\r\n+        \r\n         logits = self._classify([input_ids, segment_ids], input_mask, False);\r\n         probabilities = tf.nn.softmax(logits);\r\n         out = tf.math.argmax(probabilities);\r\n@@ -174,6 +183,7 @@ class Predictor(object):\r\n \r\n if __name__ == \"__main__\":\r\n \r\n+    tf.enable_eager_execution()\r\n     assert tf.executing_eagerly();\r\n     predictor = Predictor();\r\n     print(predictor.predict('今天天气如何？','感觉很不错！'));\r\n```\r\n\r\nbut this is not what you want, as it first predicts on the BERT model, and then feeds its output to a second classifier model. A single classifier model with a bert layer would be be better (and easier to train).\r\n\r\nAlso note, that you need the batch dimension, when feeding data into the model (therefore the call to `tf.expand_dims()` above).","reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514655200/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"kpe","id":2535923,"node_id":"MDQ6VXNlcjI1MzU5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/2535923?v=4","gravatar_id":"","url":"https://api.github.com/users/kpe","html_url":"https://github.com/kpe","followers_url":"https://api.github.com/users/kpe/followers","following_url":"https://api.github.com/users/kpe/following{/other_user}","gists_url":"https://api.github.com/users/kpe/gists{/gist_id}","starred_url":"https://api.github.com/users/kpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpe/subscriptions","organizations_url":"https://api.github.com/users/kpe/orgs","repos_url":"https://api.github.com/users/kpe/repos","events_url":"https://api.github.com/users/kpe/events{/privacy}","received_events_url":"https://api.github.com/users/kpe/received_events","type":"User","site_admin":false}},{"id":2506525099,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjUwNjUyNTA5OQ==","url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/events/2506525099","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-07-24T14:26:57Z","performed_via_github_app":null},{"id":2506525101,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI1MDY1MjUxMDE=","url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/events/2506525101","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-07-24T14:26:57Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514852175","html_url":"https://github.com/kpe/bert-for-tf2/issues/5#issuecomment-514852175","issue_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/5","id":514852175,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDg1MjE3NQ==","user":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"created_at":"2019-07-25T00:53:04Z","updated_at":"2019-07-25T00:53:04Z","author_association":"NONE","body":"got it. thx for your informative and kindly reply!","reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/comments/514852175/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false}},{"id":2508013204,"node_id":"MDExOkNsb3NlZEV2ZW50MjUwODAxMzIwNA==","url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/events/2508013204","actor":{"login":"breadbread1984","id":1930282,"node_id":"MDQ6VXNlcjE5MzAyODI=","avatar_url":"https://avatars.githubusercontent.com/u/1930282?v=4","gravatar_id":"","url":"https://api.github.com/users/breadbread1984","html_url":"https://github.com/breadbread1984","followers_url":"https://api.github.com/users/breadbread1984/followers","following_url":"https://api.github.com/users/breadbread1984/following{/other_user}","gists_url":"https://api.github.com/users/breadbread1984/gists{/gist_id}","starred_url":"https://api.github.com/users/breadbread1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breadbread1984/subscriptions","organizations_url":"https://api.github.com/users/breadbread1984/orgs","repos_url":"https://api.github.com/users/breadbread1984/repos","events_url":"https://api.github.com/users/breadbread1984/events{/privacy}","received_events_url":"https://api.github.com/users/breadbread1984/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-07-25T00:53:06Z","state_reason":null,"performed_via_github_app":null}]