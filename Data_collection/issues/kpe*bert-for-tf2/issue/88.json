{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88","repository_url":"https://api.github.com/repos/kpe/bert-for-tf2","labels_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88/labels{/name}","comments_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88/comments","events_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88/events","html_url":"https://github.com/kpe/bert-for-tf2/issues/88","id":861086789,"node_id":"MDU6SXNzdWU4NjEwODY3ODk=","number":88,"title":"how to using this in functional model","user":{"login":"cmcai0104","id":44265239,"node_id":"MDQ6VXNlcjQ0MjY1MjM5","avatar_url":"https://avatars.githubusercontent.com/u/44265239?v=4","gravatar_id":"","url":"https://api.github.com/users/cmcai0104","html_url":"https://github.com/cmcai0104","followers_url":"https://api.github.com/users/cmcai0104/followers","following_url":"https://api.github.com/users/cmcai0104/following{/other_user}","gists_url":"https://api.github.com/users/cmcai0104/gists{/gist_id}","starred_url":"https://api.github.com/users/cmcai0104/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmcai0104/subscriptions","organizations_url":"https://api.github.com/users/cmcai0104/orgs","repos_url":"https://api.github.com/users/cmcai0104/repos","events_url":"https://api.github.com/users/cmcai0104/events{/privacy}","received_events_url":"https://api.github.com/users/cmcai0104/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-04-19T09:11:41Z","updated_at":"2021-04-29T08:27:38Z","closed_at":"2021-04-29T08:27:38Z","author_association":"NONE","active_lock_reason":null,"body":"I want to use this pre-trained model in my functional model like following:\r\n\r\n```\r\ndef build_model(model_dir, batch_size, max_seq_num, max_seq_len):\r\n    bert_params = bert.params_from_pretrained_ckpt(model_dir)\r\n    l_bert = bert.BertModelLayer.from_params(bert_params, name=\"bert\", trainable=False)\r\n\r\n    input_ids = tf.keras.layers.Input(shape=(max_seq_num, max_seq_len,), dtype='int32', name='input_ids')\r\n    reshaped_input_ids = tf.reshape(input_ids, (batch_size * max_seq_num, max_seq_len))\r\n\r\n    token_type_ids = tf.keras.layers.Input(shape=(max_seq_num, max_seq_len,), dtype='int32', name='token_type')\r\n    reshaped_token_type_ids = tf.reshape(token_type_ids, (batch_size * max_seq_num, max_seq_len))\r\n\r\n    mask_ids = tf.keras.layers.Input(shape=(max_seq_num, max_seq_len,), dtype='int32', name='mask_ids')\r\n    reshaped_mask_ids = tf.reshape(mask_ids, (batch_size * max_seq_num, max_seq_len))\r\n\r\n    # provide a custom token_type/segment id as a layer input\r\n    bert_embedd = l_bert([reshaped_input_ids, reshaped_token_type_ids], mask=reshaped_mask_ids)  # [batch_size*max_seq_num, max_seq_len, hidden_size]\r\n    model = tf.keras.models.Model(inputs=[input_ids, token_type_ids, mask_ids], outputs=bert_embedd)\r\n    model.build(input_shape=[(batch_size, max_seq_num, max_seq_len), \r\n                                                  (batch_size, max_seq_num, max_seq_len),\r\n                                                  (batch_size, max_seq_num, max_seq_len)])\r\n    bert.load_bert_weights(l_bert, os.path.join(model_dir, \"bert_model.ckpt\"))  # should be called after model.build()\r\n    model.summary()\r\n    tf.keras.utils.plot_model(model, show_shapes=True)\r\n    learning_rate = 1e-2\r\n    model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=learning_rate), \r\n                              loss=tf.keras.losses.MeanSquaredError(), metrics=['mse'])\r\n    return model\r\n```\r\n\r\nI can build the model succeed. But when I feed data to the model, \r\n```\r\nmodel = build_model(path, 16, 16, 16)\r\nx_input = np.random.randint(0, 10000, size=[16, 16, 16])\r\nx_token_type = [[[i] * 16 for i in range(16)] for _ in range(16)]\r\nx_mask = np.ones(shape=[16, 16, 16])\r\ny_predict = model(x_input, x_token_type, x_mask)\r\n```\r\nthe error appears:  \r\n```\r\nValueError: Layer model expects 2 input(s), but it received 1 input tensors. Inputs received: ...\r\n```","closed_by":{"login":"cmcai0104","id":44265239,"node_id":"MDQ6VXNlcjQ0MjY1MjM5","avatar_url":"https://avatars.githubusercontent.com/u/44265239?v=4","gravatar_id":"","url":"https://api.github.com/users/cmcai0104","html_url":"https://github.com/cmcai0104","followers_url":"https://api.github.com/users/cmcai0104/followers","following_url":"https://api.github.com/users/cmcai0104/following{/other_user}","gists_url":"https://api.github.com/users/cmcai0104/gists{/gist_id}","starred_url":"https://api.github.com/users/cmcai0104/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmcai0104/subscriptions","organizations_url":"https://api.github.com/users/cmcai0104/orgs","repos_url":"https://api.github.com/users/cmcai0104/repos","events_url":"https://api.github.com/users/cmcai0104/events{/privacy}","received_events_url":"https://api.github.com/users/cmcai0104/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/88/timeline","performed_via_github_app":null,"state_reason":"completed"}