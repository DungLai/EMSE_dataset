{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56","repository_url":"https://api.github.com/repos/kpe/bert-for-tf2","labels_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56/labels{/name}","comments_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56/comments","events_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56/events","html_url":"https://github.com/kpe/bert-for-tf2/issues/56","id":582700033,"node_id":"MDU6SXNzdWU1ODI3MDAwMzM=","number":56,"title":"There may be something wrong with this convenient module when using model_to_estimator in tensorflow 2.0","user":{"login":"Bin4writing","id":45061870,"node_id":"MDQ6VXNlcjQ1MDYxODcw","avatar_url":"https://avatars.githubusercontent.com/u/45061870?v=4","gravatar_id":"","url":"https://api.github.com/users/Bin4writing","html_url":"https://github.com/Bin4writing","followers_url":"https://api.github.com/users/Bin4writing/followers","following_url":"https://api.github.com/users/Bin4writing/following{/other_user}","gists_url":"https://api.github.com/users/Bin4writing/gists{/gist_id}","starred_url":"https://api.github.com/users/Bin4writing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bin4writing/subscriptions","organizations_url":"https://api.github.com/users/Bin4writing/orgs","repos_url":"https://api.github.com/users/Bin4writing/repos","events_url":"https://api.github.com/users/Bin4writing/events{/privacy}","received_events_url":"https://api.github.com/users/Bin4writing/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-03-17T01:59:43Z","updated_at":"2020-03-17T05:16:46Z","closed_at":"2020-03-17T05:14:50Z","author_association":"NONE","active_lock_reason":null,"body":"## My scripts raise a Value Error when invoking model_to_estimator:\r\n![image](https://user-images.githubusercontent.com/45061870/76813967-7cd2cf80-6834-11ea-9c82-bc8462ecc657.png)\r\n-----\r\n## My code:\r\n\r\n```\r\n        input_token_ids = tf.keras.Input((max_seq_len,), dtype=tf.int32, name='input_ids')\r\n        input_segment_ids = tf.keras.Input((max_seq_len,), dtype=tf.int32, name='token_type_ids')\r\n        input_mask = tf.keras.Input((max_seq_len,), dtype=tf.int32, name='input_mask')\r\n        bert_params = bert.params_from_pretrained_ckpt(model_dir)\r\n        l_bert = bert.BertModelLayer.from_params(bert_params)\r\n        bert_output = l_bert(inputs=[input_token_ids, input_segment_ids], mask=input_mask)\r\n        first_token = tf.keras.layers.Lambda(lambda seq: seq[:, 0, :])(bert_output)\r\n        pooled_output = tf.keras.layers.Dense(units=first_token.shape[-1], activation=tf.math.tanh)(first_token)\r\n        dropout = tf.keras.layers.Dropout(rate=0.1)(pooled_output)\r\n        logits = tf.keras.layers.Dense(units=num_labels, name='logits')(dropout)\r\n        output_prob = tf.keras.layers.Softmax(name='output_prob')(logits)\r\n        model = tf.keras.Model(inputs=[input_token_ids, input_segment_ids, input_mask], outputs=[logits, output_prob])\r\n        model.build(input_shape=[(None, max_seq_len,), (None, max_seq_len,), (None, max_seq_len,)])\r\n        freeze_bert_layers(l_bert)\r\n        bert.load_stock_weights(l_bert, op.join(model_dir, 'bert_model.ckpt'))\r\n        weight_decays = get_weight_decays(model)\r\n        for k, v in weight_decays.items():\r\n            if use_weight_decay(k):\r\n                weight_decays[k] = 0.01\r\n            else:\r\n                del weight_decays[k]\r\n        model.compile(\r\n            optimizer=create_optimizer(\r\n                init_lr=learning_rate,\r\n                steps=steps,\r\n                warmup_steps=warmup_steps,\r\n                weight_decays=weight_decays\r\n            ),\r\n            loss={\r\n                      'logits': tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)\r\n            },  \r\n            metrics=[tf.keras.metrics.AUC()]\r\n        )\r\n        model.summary()\r\n        return tf.keras.estimator.model_to_estimator(keras_model=model,\r\n                                                     model_dir=args.model_dir)\r\n```\r\n\r\nCould u help me? I am all gratitude.","closed_by":{"login":"Bin4writing","id":45061870,"node_id":"MDQ6VXNlcjQ1MDYxODcw","avatar_url":"https://avatars.githubusercontent.com/u/45061870?v=4","gravatar_id":"","url":"https://api.github.com/users/Bin4writing","html_url":"https://github.com/Bin4writing","followers_url":"https://api.github.com/users/Bin4writing/followers","following_url":"https://api.github.com/users/Bin4writing/following{/other_user}","gists_url":"https://api.github.com/users/Bin4writing/gists{/gist_id}","starred_url":"https://api.github.com/users/Bin4writing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bin4writing/subscriptions","organizations_url":"https://api.github.com/users/Bin4writing/orgs","repos_url":"https://api.github.com/users/Bin4writing/repos","events_url":"https://api.github.com/users/Bin4writing/events{/privacy}","received_events_url":"https://api.github.com/users/Bin4writing/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/kpe/bert-for-tf2/issues/56/timeline","performed_via_github_app":null,"state_reason":"completed"}