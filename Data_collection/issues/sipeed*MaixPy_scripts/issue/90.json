{"url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90","repository_url":"https://api.github.com/repos/sipeed/MaixPy_scripts","labels_url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90/labels{/name}","comments_url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90/comments","events_url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90/events","html_url":"https://github.com/sipeed/MaixPy_scripts/issues/90","id":789731256,"node_id":"MDU6SXNzdWU3ODk3MzEyNTY=","number":90,"title":"分类训练结果标签顺序出错，标签文本格式建议修改！","user":{"login":"embedream","id":47808447,"node_id":"MDQ6VXNlcjQ3ODA4NDQ3","avatar_url":"https://avatars.githubusercontent.com/u/47808447?v=4","gravatar_id":"","url":"https://api.github.com/users/embedream","html_url":"https://github.com/embedream","followers_url":"https://api.github.com/users/embedream/followers","following_url":"https://api.github.com/users/embedream/following{/other_user}","gists_url":"https://api.github.com/users/embedream/gists{/gist_id}","starred_url":"https://api.github.com/users/embedream/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/embedream/subscriptions","organizations_url":"https://api.github.com/users/embedream/orgs","repos_url":"https://api.github.com/users/embedream/repos","events_url":"https://api.github.com/users/embedream/events{/privacy}","received_events_url":"https://api.github.com/users/embedream/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-01-20T07:52:18Z","updated_at":"2021-01-27T03:13:04Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"尝试MaixHub上的模型训练，简单用了三个模型，按教程用MaixBit采集图片，上传训练，一起顺利，只是遇到点小困惑：其中两个标签交换了，确定不是我图片文件夹名称错所致。\r\n\r\n在尝试修改标签时，发现所提供的程序根本没有使用输出结果中的标签文件 Labels.txt\r\n\r\n尝试修改程序，发现标签文档格式不太合理，原始输出的内容是：\r\nlabels = [\"SDCard\", \"cover\", \"pencil\"]\r\n\r\n这个导入到程序中，转换为 list 有点麻烦。\r\n\r\n建议将 labels.txt 的内容修改为：\r\n[\"SDCard\", \"cover\", \"pencil\"]\r\n\r\n这样就可以使用 json.loads(str) 方式导入了。\r\n\r\n修改后的程序附在下面，供学习者参考：\r\n\r\n# object classifier boot.py\r\n# generated by maixhub.com\r\n\r\nimport sensor, image, lcd, time\r\nimport KPU as kpu\r\nimport gc, sys\r\nimport ujson\r\n\r\n\r\ndef lcd_show_except(e):\r\n    import uio\r\n    err_str = uio.StringIO()\r\n    sys.print_exception(e, err_str)\r\n    err_str = err_str.getvalue()\r\n    img = image.Image(size=(224,224))\r\n    img.draw_string(0, 10, err_str, scale=1, color=(0xff,0x00,0x00))\r\n    lcd.display(img)\r\n\r\ndef main(labels = None, model_addr=\"/sd/m.kmodel\", sensor_window=(224, 224), lcd_rotation=0, sensor_hmirror=True, sensor_vflip=True):\r\n    sensor.reset()\r\n    sensor.set_pixformat(sensor.RGB565)\r\n    sensor.set_framesize(sensor.QVGA)\r\n    sensor.set_windowing(sensor_window)\r\n    sensor.set_hmirror(sensor_hmirror)\r\n    sensor.set_vflip(sensor_vflip)\r\n    sensor.run(1)\r\n\r\n    lcd.init(type=1)\r\n    lcd.rotation(lcd_rotation)\r\n    lcd.clear(lcd.WHITE)\r\n\r\n    if not labels:\r\n        try:\r\n            with open('labels.txt','r') as f:\r\n                labelstr = f.read()\r\n                print(labelstr)\r\n                labels = ujson.loads(labelstr)\r\n        except Exception as e:\r\n            print(\"no labels.txt\")\r\n            img = image.Image(size=(320, 240))\r\n            img.draw_string(90, 110, \"no labels.txt\", color=(255, 0, 0), scale=2)\r\n            lcd.display(img)\r\n            return 1\r\n\r\n    try:\r\n        img = image.Image(\"startup.jpg\")\r\n        lcd.display(img)\r\n    except Exception:\r\n        img = image.Image(size=(320, 240))\r\n        img.draw_string(90, 110, \"loading model...\", color=(255, 255, 255), scale=2)\r\n        lcd.display(img)\r\n\r\n    try:\r\n        task = None\r\n        task = kpu.load(model_addr)\r\n        while(True):\r\n            img = sensor.snapshot()\r\n            t = time.ticks_ms()\r\n            fmap = kpu.forward(task, img)\r\n            t = time.ticks_ms() - t\r\n            plist=fmap[:]\r\n            pmax=max(plist)\r\n            max_index=plist.index(pmax)\r\n            img.draw_string(0,0, \"%.2f : %s\" %(pmax, labels[max_index].strip()), scale=2, color=(255, 0, 0))\r\n            img.draw_string(0, 200, \"t:%dms\" %(t), scale=2, color=(255, 0, 0))\r\n            lcd.display(img)\r\n    except Exception as e:\r\n        raise e\r\n    finally:\r\n        if not task is None:\r\n            kpu.deinit(task)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    try:\r\n        labels = [\"SDCard\", \"cover\", \"pencil\"]\r\n        # main(labels=labels, model_addr=0x300000)\r\n        # main(labels=labels, model_addr=\"/sd/m.kmodel\")\r\n        main(model_addr=\"/sd/m.kmodel\")\r\n    except Exception as e:\r\n        sys.print_exception(e)\r\n        lcd_show_except(e)\r\n    finally:\r\n        gc.collect()\r\n\r\n","closed_by":{"login":"Neutree","id":8625829,"node_id":"MDQ6VXNlcjg2MjU4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/8625829?v=4","gravatar_id":"","url":"https://api.github.com/users/Neutree","html_url":"https://github.com/Neutree","followers_url":"https://api.github.com/users/Neutree/followers","following_url":"https://api.github.com/users/Neutree/following{/other_user}","gists_url":"https://api.github.com/users/Neutree/gists{/gist_id}","starred_url":"https://api.github.com/users/Neutree/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Neutree/subscriptions","organizations_url":"https://api.github.com/users/Neutree/orgs","repos_url":"https://api.github.com/users/Neutree/repos","events_url":"https://api.github.com/users/Neutree/events{/privacy}","received_events_url":"https://api.github.com/users/Neutree/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sipeed/MaixPy_scripts/issues/90/timeline","performed_via_github_app":null,"state_reason":null}