{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/937","id":735676102,"node_id":"MDU6SXNzdWU3MzU2NzYxMDI=","number":937,"title":"Error: Conv2DCustomBackpropFilterOp only supports NHWC.","user":{"login":"MotorCityCobra","id":14045554,"node_id":"MDQ6VXNlcjE0MDQ1NTU0","avatar_url":"https://avatars.githubusercontent.com/u/14045554?v=4","gravatar_id":"","url":"https://api.github.com/users/MotorCityCobra","html_url":"https://github.com/MotorCityCobra","followers_url":"https://api.github.com/users/MotorCityCobra/followers","following_url":"https://api.github.com/users/MotorCityCobra/following{/other_user}","gists_url":"https://api.github.com/users/MotorCityCobra/gists{/gist_id}","starred_url":"https://api.github.com/users/MotorCityCobra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MotorCityCobra/subscriptions","organizations_url":"https://api.github.com/users/MotorCityCobra/orgs","repos_url":"https://api.github.com/users/MotorCityCobra/repos","events_url":"https://api.github.com/users/MotorCityCobra/events{/privacy}","received_events_url":"https://api.github.com/users/MotorCityCobra/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-11-03T22:28:01Z","updated_at":"2020-11-04T00:05:28Z","closed_at":"2020-11-04T00:05:28Z","author_association":"NONE","active_lock_reason":null,"body":"Everything with my images appear to be in order. I've tried reducing batch sizes and looking for this same error elsewhere on the internet for a quick fix but the error persists. It always happens after the samples from the dst and src have been 100% loaded and it is about to start training.  \r\nI'm on Linux so I'm using the scripts [here](https://github.com/lbfs/DeepFaceLab_Linux/tree/master/scripts) namely the `./6_train_SAEHD.sh` scipt when I encounter this error.  \r\n\r\n    ================ Model Summary =================\r\n    ==                                            ==\r\n    ==            Model name: new_SAEHD           ==\r\n    ==                                            ==\r\n    ==     Current iteration: 0                   ==\r\n    ==                                            ==\r\n    ==-------------- Model Options ---------------==\r\n    ==                                            ==\r\n    ==            resolution: 128                 ==\r\n    ==             face_type: f                   ==\r\n    ==     models_opt_on_gpu: True                ==\r\n    ==                 archi: df                  ==\r\n    ==               ae_dims: 128                 ==\r\n    ==                e_dims: 32                  ==\r\n    ==                d_dims: 32                  ==\r\n    ==           d_mask_dims: 16                  ==\r\n    ==       masked_training: True                ==\r\n    ==             eyes_prio: False               ==\r\n    ==           uniform_yaw: False               ==\r\n    ==            lr_dropout: n                   ==\r\n    ==           random_warp: True                ==\r\n    ==             gan_power: 0.0                 ==\r\n    ==       true_face_power: 0.0                 ==\r\n    ==      face_style_power: 0.0                 ==\r\n    ==        bg_style_power: 0.0                 ==\r\n    ==               ct_mode: none                ==\r\n    ==              clipgrad: False               ==\r\n    ==              pretrain: False               ==\r\n    ==       autobackup_hour: 4                   ==\r\n    == write_preview_history: False               ==\r\n    ==           target_iter: 0                   ==\r\n    ==           random_flip: True                ==\r\n    ==            batch_size: 4                   ==\r\n    ==                                            ==\r\n    ==---------------- Running On ----------------==\r\n    ==                                            ==\r\n    ==          Device index: 0                   ==\r\n    ==                  Name: GeForce GTX 1080 Ti ==\r\n    ==                  VRAM: 10.91GB             ==\r\n    ==          Device index: 1                   ==\r\n    ==                  Name: GeForce GTX 1080 Ti ==\r\n    ==                  VRAM: 10.92GB             ==\r\n    ==                                            ==\r\n    ================================================\r\n    Starting. Press \"Enter\" to stop training and save model.\r\n\r\n    Trying to do the first iteration. If an error occurs, reduce the model parameters.\r\n\r\n    You are training the model from scratch. It is strongly recommended to use a pretrained model to speed up the training and improve the quality.\r\n\r\n    Error: Conv2DCustomBackpropFilterOp only supports NHWC.\r\n        [[node gradients/Conv2D_27_grad/Conv2DBackpropFilter (defined at media/iii/Q2/tor/face/DeepFaceLab/core/leras/ops/__init__.py:55) ]]\r\n\r\n    Errors may have originated from an input operation.\r\n    Input Source operations connected to node gradients/Conv2D_27_grad/Conv2DBackpropFilter:\r\n    Pad_26 (defined at media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/Conv2D.py:97)\r\n\r\n    Original stack trace for 'gradients/Conv2D_27_grad/Conv2DBackpropFilter':\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 890, in _bootstrap\r\n        self._bootstrap_inner()\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 932, in _bootstrap_inner\r\n        self.run()\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 870, in run\r\n        self._target(*self._args, **self._kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/mainscripts/Trainer.py\", line 45, in trainerThread\r\n        model = models.import_model(model_class_name)(\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/ModelBase.py\", line 189, in __init__\r\n        self.on_initialize()\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 471, in on_initialize\r\n        gpu_G_loss_gvs += [ nn.gradients ( gpu_G_loss, self.src_dst_trainable_weights ) ]\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/ops/__init__.py\", line 55, in tf_gradients\r\n        grads = gradients.gradients(loss, vars, colocate_gradients_with_ops=True )\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_impl.py\", line 169, in gradients\r\n        return gradients_util._GradientsHelper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 668, in _GradientsHelper\r\n        in_grads = _MaybeCompile(grad_scope, op, func_call,\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 336, in _MaybeCompile\r\n        return grad_fn()  # Exit early\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 669, in <lambda>\r\n        lambda: grad_fn(op, *out_grads))\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/nn_grad.py\", line 597, in _Conv2DGrad\r\n        gen_nn_ops.conv2d_backprop_filter(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1132, in conv2d_backprop_filter\r\n        _, _, _op, _outputs = _op_def_library._apply_op_helper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/op_def_library.py\", line 742, in _apply_op_helper\r\n        op = g._create_op_internal(op_type_name, inputs, dtypes=None,\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/ops.py\", line 3477, in _create_op_internal\r\n        ret = Operation(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/ops.py\", line 1949, in __init__\r\n        self._traceback = tf_stack.extract_stack()\r\n\r\n    ...which was originally created as op 'Conv2D_27', defined at:\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 890, in _bootstrap\r\n        self._bootstrap_inner()\r\n    [elided 3 identical lines from previous traceback]\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/ModelBase.py\", line 189, in __init__\r\n        self.on_initialize()\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 337, in on_initialize\r\n        gpu_pred_src_src, gpu_pred_src_srcm = self.decoder_src(gpu_src_code)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/models/ModelBase.py\", line 117, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/archis/DeepFakeArchi.py\", line 190, in forward\r\n        m = self.upscalem2(m)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/models/ModelBase.py\", line 117, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/archis/DeepFakeArchi.py\", line 57, in forward\r\n        x = self.conv1(x)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/LayerBase.py\", line 14, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/Conv2D.py\", line 99, in forward\r\n        x = tf.nn.conv2d(x, weight, self.strides, 'VALID', dilations=self.dilations, data_format=nn.data_format)\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/util/dispatch.py\", line 201, in wrapper\r\n        return target(*args, **kwargs)\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/nn_ops.py\", line 2264, in conv2d\r\n        return gen_nn_ops.conv2d(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 975, in conv2d\r\n        _, _, _op, _outputs = _op_def_library._apply_op_helper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/op_def_library.py\", line 742, in _apply_op_helper\r\n        op = g._create_op_internal(op_type_name, inputs, dtypes=None,\r\n\r\n    Traceback (most recent call last):\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1365, in _do_call\r\n        return fn(*args)\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1349, in _run_fn\r\n        return self._call_tf_sessionrun(options, feed_dict, fetch_list,\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1441, in _call_tf_sessionrun\r\n        return tf_session.TF_SessionRun_wrapper(self._session, options, feed_dict,\r\n    tensorflow.python.framework.errors_impl.InvalidArgumentError: Conv2DCustomBackpropFilterOp only supports NHWC.\r\n        [[{{node gradients/Conv2D_27_grad/Conv2DBackpropFilter}}]]\r\n\r\n    During handling of the above exception, another exception occurred:\r\n\r\n    Traceback (most recent call last):\r\n    File \"/media/iii/Q2/tor/face/DeepFaceLab/mainscripts/Trainer.py\", line 123, in trainerThread\r\n        iter, iter_time = model.train_one_iter()\r\n    File \"/media/iii/Q2/tor/face/DeepFaceLab/models/ModelBase.py\", line 462, in train_one_iter\r\n        losses = self.onTrainOneIter()\r\n    File \"/media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 636, in onTrainOneIter\r\n        src_loss, dst_loss = self.src_dst_train (warped_src, target_src, target_srcm_all, warped_dst, target_dst, target_dstm_all)\r\n    File \"/media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 497, in src_dst_train\r\n        s, d, _ = nn.tf_sess.run ( [ src_loss, dst_loss, src_dst_loss_gv_op],\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 957, in run\r\n        result = self._run(None, fetches, feed_dict, options_ptr,\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1180, in _run\r\n        results = self._do_run(handle, final_targets, final_fetches,\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1358, in _do_run\r\n        return self._do_call(_run_fn, feeds, fetches, targets, options,\r\n    File \"/home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/client/session.py\", line 1384, in _do_call\r\n        raise type(e)(node_def, op, message)\r\n    tensorflow.python.framework.errors_impl.InvalidArgumentError: Conv2DCustomBackpropFilterOp only supports NHWC.\r\n        [[node gradients/Conv2D_27_grad/Conv2DBackpropFilter (defined at media/iii/Q2/tor/face/DeepFaceLab/core/leras/ops/__init__.py:55) ]]\r\n\r\n    Errors may have originated from an input operation.\r\n    Input Source operations connected to node gradients/Conv2D_27_grad/Conv2DBackpropFilter:\r\n    Pad_26 (defined at media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/Conv2D.py:97)\r\n\r\n    Original stack trace for 'gradients/Conv2D_27_grad/Conv2DBackpropFilter':\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 890, in _bootstrap\r\n        self._bootstrap_inner()\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 932, in _bootstrap_inner\r\n        self.run()\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 870, in run\r\n        self._target(*self._args, **self._kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/mainscripts/Trainer.py\", line 45, in trainerThread\r\n        model = models.import_model(model_class_name)(\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/ModelBase.py\", line 189, in __init__\r\n        self.on_initialize()\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 471, in on_initialize\r\n        gpu_G_loss_gvs += [ nn.gradients ( gpu_G_loss, self.src_dst_trainable_weights ) ]\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/ops/__init__.py\", line 55, in tf_gradients\r\n        grads = gradients.gradients(loss, vars, colocate_gradients_with_ops=True )\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_impl.py\", line 169, in gradients\r\n        return gradients_util._GradientsHelper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 668, in _GradientsHelper\r\n        in_grads = _MaybeCompile(grad_scope, op, func_call,\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 336, in _MaybeCompile\r\n        return grad_fn()  # Exit early\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gradients_util.py\", line 669, in <lambda>\r\n        lambda: grad_fn(op, *out_grads))\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/nn_grad.py\", line 597, in _Conv2DGrad\r\n        gen_nn_ops.conv2d_backprop_filter(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1132, in conv2d_backprop_filter\r\n        _, _, _op, _outputs = _op_def_library._apply_op_helper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/op_def_library.py\", line 742, in _apply_op_helper\r\n        op = g._create_op_internal(op_type_name, inputs, dtypes=None,\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/ops.py\", line 3477, in _create_op_internal\r\n        ret = Operation(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/ops.py\", line 1949, in __init__\r\n        self._traceback = tf_stack.extract_stack()\r\n\r\n    ...which was originally created as op 'Conv2D_27', defined at:\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/threading.py\", line 890, in _bootstrap\r\n        self._bootstrap_inner()\r\n    [elided 3 identical lines from previous traceback]\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/ModelBase.py\", line 189, in __init__\r\n        self.on_initialize()\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/models/Model_SAEHD/Model.py\", line 337, in on_initialize\r\n        gpu_pred_src_src, gpu_pred_src_srcm = self.decoder_src(gpu_src_code)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/models/ModelBase.py\", line 117, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/archis/DeepFakeArchi.py\", line 190, in forward\r\n        m = self.upscalem2(m)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/models/ModelBase.py\", line 117, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/archis/DeepFakeArchi.py\", line 57, in forward\r\n        x = self.conv1(x)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/LayerBase.py\", line 14, in __call__\r\n        return self.forward(*args, **kwargs)\r\n    File \"media/iii/Q2/tor/face/DeepFaceLab/core/leras/layers/Conv2D.py\", line 99, in forward\r\n        x = tf.nn.conv2d(x, weight, self.strides, 'VALID', dilations=self.dilations, data_format=nn.data_format)\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/util/dispatch.py\", line 201, in wrapper\r\n        return target(*args, **kwargs)\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/nn_ops.py\", line 2264, in conv2d\r\n        return gen_nn_ops.conv2d(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 975, in conv2d\r\n        _, _, _op, _outputs = _op_def_library._apply_op_helper(\r\n    File \"home/iii/miniconda3/envs/face4/lib/python3.8/site-packages/tensorflow/python/framework/op_def_library.py\", line 742, in _apply_op_helper\r\n        op = g._create_op_internal(op_type_name, inputs, dtypes=None,\r\n\r\n    ^Z\r\n    [2]+  Stopped                 ./6_train_SAEHD.sh\r\n    (face4) iii@iii-MS-7A32:/media/iii/Q2/tor/face/scripts$ python\r\n \r\n\r\n","closed_by":{"login":"MotorCityCobra","id":14045554,"node_id":"MDQ6VXNlcjE0MDQ1NTU0","avatar_url":"https://avatars.githubusercontent.com/u/14045554?v=4","gravatar_id":"","url":"https://api.github.com/users/MotorCityCobra","html_url":"https://github.com/MotorCityCobra","followers_url":"https://api.github.com/users/MotorCityCobra/followers","following_url":"https://api.github.com/users/MotorCityCobra/following{/other_user}","gists_url":"https://api.github.com/users/MotorCityCobra/gists{/gist_id}","starred_url":"https://api.github.com/users/MotorCityCobra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MotorCityCobra/subscriptions","organizations_url":"https://api.github.com/users/MotorCityCobra/orgs","repos_url":"https://api.github.com/users/MotorCityCobra/repos","events_url":"https://api.github.com/users/MotorCityCobra/events{/privacy}","received_events_url":"https://api.github.com/users/MotorCityCobra/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/937/timeline","performed_via_github_app":null,"state_reason":"completed"}