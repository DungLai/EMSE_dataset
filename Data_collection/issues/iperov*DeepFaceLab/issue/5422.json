{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5422","id":1041126280,"node_id":"I_kwDOCBuapc4-DlOI","number":5422,"title":"Crash when using \"6) export AMP as dfm.bat\"","user":{"login":"BlankFX1","id":26005942,"node_id":"MDQ6VXNlcjI2MDA1OTQy","avatar_url":"https://avatars.githubusercontent.com/u/26005942?v=4","gravatar_id":"","url":"https://api.github.com/users/BlankFX1","html_url":"https://github.com/BlankFX1","followers_url":"https://api.github.com/users/BlankFX1/followers","following_url":"https://api.github.com/users/BlankFX1/following{/other_user}","gists_url":"https://api.github.com/users/BlankFX1/gists{/gist_id}","starred_url":"https://api.github.com/users/BlankFX1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BlankFX1/subscriptions","organizations_url":"https://api.github.com/users/BlankFX1/orgs","repos_url":"https://api.github.com/users/BlankFX1/repos","events_url":"https://api.github.com/users/BlankFX1/events{/privacy}","received_events_url":"https://api.github.com/users/BlankFX1/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-11-01T12:35:45Z","updated_at":"2021-12-16T00:27:34Z","closed_at":"2021-12-16T00:27:34Z","author_association":"NONE","active_lock_reason":null,"body":"## Expected behavior\r\n\r\nI trained an AMP Model in SRC-SRC-Mode and am trying to convert it to an dfm-File for using it in DeepFaceLive.\r\n\r\nWhat I did:\r\n- Start \"6) export AMP as dfm.bat\"\r\n- Choose AMP-Model\r\n- \"Export Quantized?\" = no\r\n\r\nI expected the tool to convert the AMP Model to a dfm-File.\r\n\r\n## Actual behavior\r\n\r\nInstead it crashed and gave me the following output:\r\n\r\n> Choose one of saved models, or enter a name to create a new model.\r\n> [r] : rename\r\n> [d] : delete\r\n>\r\n> [0] : SiaV2 - latest\r\n> [1] : SiaV1\r\n>  : 0\r\n> Loading SiaV2_AMP model...\r\n> [n] Export quantized? ( y/n ?:help ) :\r\n> n\r\n> Initializing models: 100%|####################################################################################################################################################################################| 4/4 [00:00<00:00,  7.81it/s]\r\n> ================ Model Summary =================\r\n> ==                                            ==\r\n> ==            Model name: SiaV2_AMP ==\r\n> ==                                            ==\r\n> ==     Current iteration: 220536              ==\r\n> ==                                            ==\r\n> ==-------------- Model Options ---------------==\r\n> ==                                            ==\r\n> ==            resolution: 320                 ==\r\n> ==             face_type: wf                  ==\r\n> ==     models_opt_on_gpu: True                ==\r\n> ==               ae_dims: 256                 ==\r\n> ==            inter_dims: 320                 ==\r\n> ==                e_dims: 72                  ==\r\n> ==                d_dims: 72                  ==\r\n> ==           d_mask_dims: 22                  ==\r\n> ==          morph_factor: 0.5                 ==\r\n> ==           uniform_yaw: True                ==\r\n> ==         blur_out_mask: False               ==\r\n> ==            lr_dropout: n                   ==\r\n> ==           random_warp: True                ==\r\n> ==               ct_mode: none                ==\r\n> ==              clipgrad: False               ==\r\n> ==       autobackup_hour: 1                   ==\r\n> == write_preview_history: True                ==\r\n> ==           target_iter: 0                   ==\r\n> ==       random_src_flip: False               ==\r\n> ==       random_dst_flip: True                ==\r\n> ==            batch_size: 11                  ==\r\n> ==             gan_power: 0.0                 ==\r\n> ==        gan_patch_size: 40                  ==\r\n> ==              gan_dims: 16                  ==\r\n> ==                                            ==\r\n> ==---------------- Running On ----------------==\r\n> ==                                            ==\r\n> ==          Using device: CPU                 ==\r\n> ==                                            ==\r\n> ================================================\r\n> Dumping .dfm to S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\workspace\\model\\SiaV2_AMP_model.dfm\r\n> Failed to convert node 'Slice_3' (fct=<bound method Slice.version_1 of <class 'tf2onnx.onnx_opset.tensor.Slice'>>)\r\n> ''\r\n> Traceback (most recent call last):\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 294, in tensorflow_onnx_mapping\r\n>     func(g, node, **kwargs, initialized_tables=initialized_tables, dequantize=dequantize)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\onnx_opset\\tensor.py\", line 343, in version_1\r\n>     _ = GraphBuilder(ctx).make_slice(kwargs, name=node.name)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 40, in make_slice\r\n>     starts = self.convert_to_attribute(kwargs.pop(\"starts\"))\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 224, in convert_to_attribute\r\n>     res = const_node.get_tensor_value(as_list=True)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph.py\", line 317, in get_tensor_value\r\n>     raise ValueError(\"get tensor value: '{}' must be Const\".format(self.name))\r\n> ValueError: get tensor value: 'Slice_3/begin_Concat__109' must be Const\r\n> Failed to convert node 'Slice_2' (fct=<bound method Slice.version_1 of <class 'tf2onnx.onnx_opset.tensor.Slice'>>)\r\n> ''\r\n> Traceback (most recent call last):\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 294, in tensorflow_onnx_mapping\r\n>     func(g, node, **kwargs, initialized_tables=initialized_tables, dequantize=dequantize)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\onnx_opset\\tensor.py\", line 343, in version_1\r\n>     _ = GraphBuilder(ctx).make_slice(kwargs, name=node.name)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 41, in make_slice\r\n>     ends = self.convert_to_attribute(kwargs.pop(\"ends\"))\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 224, in convert_to_attribute\r\n>     res = const_node.get_tensor_value(as_list=True)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph.py\", line 317, in get_tensor_value\r\n>     raise ValueError(\"get tensor value: '{}' must be Const\".format(self.name))\r\n> ValueError: get tensor value: 'Add__133' must be Const\r\n> Failed to convert node 'concat_3' (fct=<bound method ConcatV2.version_1 of <class 'tf2onnx.onnx_opset.tensor.ConcatV2'>>)\r\n> 'OP=Concat\\nName=concat_3\\nInputs:\\n\\tSlice_2:0=N/A, None, None\\n\\tSlice_3:0=N/A, None, None\\n\\tconcat_3/axis:0=Const, [], 6\\nOutpus:\\n\\tconcat_3:0=[-1, -1, 10, 10], 1'\r\n> Traceback (most recent call last):\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 294, in tensorflow_onnx_mapping\r\n>     func(g, node, **kwargs, initialized_tables=initialized_tables, dequantize=dequantize)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\onnx_opset\\tensor.py\", line 274, in version_1\r\n>     if inp.is_const() and inp.get_tensor_value(as_list=False).size == 0:\r\n> AttributeError: 'NoneType' object has no attribute 'is_const'\r\n> Traceback (most recent call last):\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\main.py\", line 343, in <module>\r\n>     arguments.func(arguments)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\main.py\", line 154, in process_exportdfm\r\n>     ExportDFM.main(model_class_name = arguments.model_name, saved_models_path = Path(arguments.model_dir))\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\mainscripts\\ExportDFM.py\", line 22, in main\r\n>     model.export_dfm ()\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\Model_AMP\\Model.py\", line 629, in export_dfm\r\n>     output_path=output_path)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\convert.py\", line 153, in _convert_common\r\n>     g = process_tf_graph(tf_graph, const_node_values=const_node_values, **kwargs)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 535, in process_tf_graph\r\n>     output_names, initialized_tables, outputs_to_values, outputs_to_dtypes, op_cnt, attr_cnt)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 637, in process_parsed_graph\r\n>     raise exceptions[0]\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\tfonnx.py\", line 294, in tensorflow_onnx_mapping\r\n>     func(g, node, **kwargs, initialized_tables=initialized_tables, dequantize=dequantize)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\onnx_opset\\tensor.py\", line 343, in version_1\r\n>     _ = GraphBuilder(ctx).make_slice(kwargs, name=node.name)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 40, in make_slice\r\n>     starts = self.convert_to_attribute(kwargs.pop(\"starts\"))\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph_builder.py\", line 224, in convert_to_attribute\r\n>     res = const_node.get_tensor_value(as_list=True)\r\n>   File \"S:\\DeepFaceLab3080Ti\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tf2onnx\\graph.py\", line 317, in get_tensor_value\r\n>     raise ValueError(\"get tensor value: '{}' must be Const\".format(self.name))\r\n> ValueError: get tensor value: 'Slice_3/begin_Concat__109' must be Const\r\n\r\n\r\n## Steps to reproduce\r\n\r\n*Describe, in some detail, the steps you tried that resulted in the behavior described above.*\r\nTried the above mentioned steps and settings, also tried with another AMP-Model (SiaV1 which had an higher resolution) with the exact same outcome.\r\n\r\n## Other relevant information\r\n**Operating system and version:** Windows, macOS, Linux \r\n- Windows 10, Ryzen 3950x, 64 GByte RAM, 700 GByte Paging File, RTX 3080 Ti\r\n\r\n- **Python version:** 3.5, 3.6.4, ... (if you are not using prebuilt windows binary)\r\n- tested using Windows Build DeepFaceLab_NVIDIA_RTX3000_series_build_10_20_2021\r\n\r\n\r\n(Sorry for the size text format above, was unable to fix it.)","closed_by":{"login":"BlankFX1","id":26005942,"node_id":"MDQ6VXNlcjI2MDA1OTQy","avatar_url":"https://avatars.githubusercontent.com/u/26005942?v=4","gravatar_id":"","url":"https://api.github.com/users/BlankFX1","html_url":"https://github.com/BlankFX1","followers_url":"https://api.github.com/users/BlankFX1/followers","following_url":"https://api.github.com/users/BlankFX1/following{/other_user}","gists_url":"https://api.github.com/users/BlankFX1/gists{/gist_id}","starred_url":"https://api.github.com/users/BlankFX1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BlankFX1/subscriptions","organizations_url":"https://api.github.com/users/BlankFX1/orgs","repos_url":"https://api.github.com/users/BlankFX1/repos","events_url":"https://api.github.com/users/BlankFX1/events{/privacy}","received_events_url":"https://api.github.com/users/BlankFX1/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5422/timeline","performed_via_github_app":null,"state_reason":"completed"}