{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5438","id":1070965647,"node_id":"I_kwDOCBuapc4_1aOP","number":5438,"title":"oom when allocating tensor with shape","user":{"login":"Silomat","id":79842299,"node_id":"MDQ6VXNlcjc5ODQyMjk5","avatar_url":"https://avatars.githubusercontent.com/u/79842299?v=4","gravatar_id":"","url":"https://api.github.com/users/Silomat","html_url":"https://github.com/Silomat","followers_url":"https://api.github.com/users/Silomat/followers","following_url":"https://api.github.com/users/Silomat/following{/other_user}","gists_url":"https://api.github.com/users/Silomat/gists{/gist_id}","starred_url":"https://api.github.com/users/Silomat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Silomat/subscriptions","organizations_url":"https://api.github.com/users/Silomat/orgs","repos_url":"https://api.github.com/users/Silomat/repos","events_url":"https://api.github.com/users/Silomat/events{/privacy}","received_events_url":"https://api.github.com/users/Silomat/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-12-03T21:03:16Z","updated_at":"2021-12-13T02:45:48Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"THIS IS NOT TECH SUPPORT FOR NEWBIE FAKERS\r\nPOST ONLY ISSUES RELATED TO BUGS OR CODE\r\n\r\n## Expected behavior\r\n\r\nI was trying to train the ai, but instead I got this error:\r\n\r\nRunning trainer.\r\n\r\n[new] No saved models found. Enter a name of a new model : mal\r\nmal\r\n\r\nModel first run.\r\n\r\nChoose one or several GPU idxs (separated by comma).\r\n\r\n[CPU] : CPU\r\n  [0] : NVIDIA GeForce GTX 1650\r\n\r\n[0] Which GPU indexes to choose? :\r\n0\r\n\r\n[0] Autobackup every N hour ( 0..24 ?:help ) : 0.5\r\n0\r\n[n] Write preview history ( y/n ?:help ) :\r\nn\r\n[300000] Target iteration :\r\n300000\r\n[n] Flip SRC faces randomly ( y/n ?:help ) :\r\nn\r\n[y] Flip DST faces randomly ( y/n ?:help ) :\r\ny\r\n[10] Batch_size ( ?:help ) :\r\n10\r\n[128] Resolution ( 64-640 ?:help ) :\r\n128\r\n[f] Face type ( h/mf/f/wf/head ?:help ) :\r\nf\r\n[liae-ud] AE architecture ( ?:help ) :\r\nliae-ud\r\n[256] AutoEncoder dimensions ( 32-1024 ?:help ) :\r\n256\r\n[64] Encoder dimensions ( 16-256 ?:help ) :\r\n64\r\n[64] Decoder dimensions ( 16-256 ?:help ) :\r\n64\r\n[22] Decoder mask dimensions ( 16-256 ?:help ) :\r\n22\r\n[n] Eyes and mouth priority ( y/n ?:help ) :\r\nn\r\n[n] Uniform yaw distribution of samples ( y/n ?:help ) :\r\nn\r\n[n] Blur out mask ( y/n ?:help ) :\r\nn\r\n[y] Place models and optimizer on GPU ( y/n ?:help ) :\r\ny\r\n[y] Use AdaBelief optimizer? ( y/n ?:help ) :\r\ny\r\n[n] Use learning rate dropout ( n/y/cpu ?:help ) :\r\nn\r\n[y] Enable random warp of samples ( y/n ?:help ) :\r\ny\r\n[0.0] Random hue/saturation/light intensity ( 0.0 .. 0.3 ?:help ) :\r\n0.0\r\n[0.0] GAN power ( 0.0 .. 5.0 ?:help ) :\r\n0.0\r\n[0.0] Face style power ( 0.0..100.0 ?:help ) :\r\n0.0\r\n[0.0] Background style power ( 0.0..100.0 ?:help ) :\r\n0.0\r\n[none] Color transfer for src faceset ( none/rct/lct/mkl/idt/sot ?:help ) :\r\nnone\r\n[y] Enable gradient clipping ( y/n ?:help ) :\r\ny\r\n[y] Enable pretraining mode ( y/n ?:help ) :\r\ny\r\nInitializing models: 100%|###############################################################| 5/5 [00:01<00:00,  2.51it/s]\r\nLoaded 15843 packed faces from D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\pretrain_faces\r\nSort by yaw: 100%|##################################################################| 128/128 [00:00<00:00, 361.55it/s]\r\nSort by yaw: 100%|##################################################################| 128/128 [00:00<00:00, 368.88it/s]\r\n================== Model Summary ===================\r\n==                                                ==\r\n==            Model name: mal_SAEHD               ==\r\n==                                                ==\r\n==     Current iteration: 0                       ==\r\n==                                                ==\r\n==---------------- Model Options -----------------==\r\n==                                                ==\r\n==            resolution: 128                     ==\r\n==             face_type: f                       ==\r\n==     models_opt_on_gpu: True                    ==\r\n==                 archi: liae-ud                 ==\r\n==               ae_dims: 256                     ==\r\n==                e_dims: 64                      ==\r\n==                d_dims: 64                      ==\r\n==           d_mask_dims: 22                      ==\r\n==       masked_training: True                    ==\r\n==       eyes_mouth_prio: False                   ==\r\n==           uniform_yaw: True                    ==\r\n==         blur_out_mask: False                   ==\r\n==             adabelief: True                    ==\r\n==            lr_dropout: n                       ==\r\n==           random_warp: False                   ==\r\n==      random_hsv_power: 0.0                     ==\r\n==       true_face_power: 0.0                     ==\r\n==      face_style_power: 0.0                     ==\r\n==        bg_style_power: 0.0                     ==\r\n==               ct_mode: none                    ==\r\n==              clipgrad: True                    ==\r\n==              pretrain: True                    ==\r\n==       autobackup_hour: 0                       ==\r\n== write_preview_history: False                   ==\r\n==           target_iter: 300000                  ==\r\n==       random_src_flip: False                   ==\r\n==       random_dst_flip: True                    ==\r\n==            batch_size: 10                      ==\r\n==             gan_power: 0.0                     ==\r\n==        gan_patch_size: 16                      ==\r\n==              gan_dims: 16                      ==\r\n==                                                ==\r\n==------------------ Running On ------------------==\r\n==                                                ==\r\n==          Device index: 0                       ==\r\n==                  Name: NVIDIA GeForce GTX 1650 ==\r\n==                  VRAM: 2.86GB                  ==\r\n==                                                ==\r\n====================================================\r\nStarting. Target iteration: 300000. Press \"Enter\" to stop training and save model.\r\n\r\nTrying to do the first iteration. If an error occurs, reduce the model parameters.\r\n\r\n!!!\r\nWindows 10 users IMPORTANT notice. You should set this setting in order to work correctly.\r\nhttps://i.imgur.com/B7cmDCB.jpg\r\n!!!\r\nError: OOM when allocating tensor with shape[10,128,64,64] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node DepthToSpace_13 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:345) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[node concat_8 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py:563) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\r\nCaused by op 'DepthToSpace_13', defined at:\r\n  File \"threading.py\", line 884, in _bootstrap\r\n  File \"threading.py\", line 916, in _bootstrap_inner\r\n  File \"threading.py\", line 864, in run\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 193, in __init__\r\n    self.on_initialize()\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 425, in on_initialize\r\n    gpu_pred_dst_dst, gpu_pred_dst_dstm = self.decoder(gpu_dst_code)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 225, in forward\r\n    x = self.upscale2(x)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 73, in forward\r\n    x = nn.depth_to_space(x, 2)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py\", line 345, in depth_to_space\r\n    return tf.depth_to_space(x, size, data_format=nn.data_format)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\array_ops.py\", line 2703, in depth_to_space\r\n    return gen_array_ops.depth_to_space(input, block_size, data_format, name=name)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\gen_array_ops.py\", line 1593, in depth_to_space\r\n    data_format=data_format, name=name)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 788, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\util\\deprecation.py\", line 507, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3300, in create_op\r\n    op_def=op_def)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1801, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[10,128,64,64] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node DepthToSpace_13 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:345) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[node concat_8 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py:563) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\r\nTraceback (most recent call last):\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1334, in _do_call\r\n    return fn(*args)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1319, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1407, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: OOM when allocating tensor with shape[10,128,64,64] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[{{node DepthToSpace_13}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[{{node concat_8}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 129, in trainerThread\r\n    iter, iter_time = model.train_one_iter()\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 474, in train_one_iter\r\n    losses = self.onTrainOneIter()\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 774, in onTrainOneIter\r\n    src_loss, dst_loss = self.src_dst_train (warped_src, target_src, target_srcm, target_srcm_em, warped_dst, target_dst, target_dstm, target_dstm_em)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 584, in src_dst_train\r\n    self.target_dstm_em:target_dstm_em,\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 929, in run\r\n    run_metadata_ptr)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1152, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1328, in _do_run\r\n    run_metadata)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1348, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: OOM when allocating tensor with shape[10,128,64,64] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node DepthToSpace_13 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:345) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[node concat_8 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py:563) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\r\nCaused by op 'DepthToSpace_13', defined at:\r\n  File \"threading.py\", line 884, in _bootstrap\r\n  File \"threading.py\", line 916, in _bootstrap_inner\r\n  File \"threading.py\", line 864, in run\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 193, in __init__\r\n    self.on_initialize()\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 425, in on_initialize\r\n    gpu_pred_dst_dst, gpu_pred_dst_dstm = self.decoder(gpu_dst_code)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 225, in forward\r\n    x = self.upscale2(x)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 73, in forward\r\n    x = nn.depth_to_space(x, 2)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py\", line 345, in depth_to_space\r\n    return tf.depth_to_space(x, size, data_format=nn.data_format)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\array_ops.py\", line 2703, in depth_to_space\r\n    return gen_array_ops.depth_to_space(input, block_size, data_format, name=name)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\gen_array_ops.py\", line 1593, in depth_to_space\r\n    data_format=data_format, name=name)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 788, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\util\\deprecation.py\", line 507, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3300, in create_op\r\n    op_def=op_def)\r\n  File \"D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1801, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[10,128,64,64] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node DepthToSpace_13 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:345) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[node concat_8 (defined at D:\\lol\\DeepFaceLab_NVIDIA_up_to_RTX2080Ti\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py:563) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\r\nI have no idea what that could mean, theorattically I've done everything correct","closed_by":null,"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5438/timeline","performed_via_github_app":null,"state_reason":null}