{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5236","id":782203882,"node_id":"MDU6SXNzdWU3ODIyMDM4ODI=","number":5236,"title":"Can't load saved model","user":{"login":"SonOfDiablo","id":9123250,"node_id":"MDQ6VXNlcjkxMjMyNTA=","avatar_url":"https://avatars.githubusercontent.com/u/9123250?v=4","gravatar_id":"","url":"https://api.github.com/users/SonOfDiablo","html_url":"https://github.com/SonOfDiablo","followers_url":"https://api.github.com/users/SonOfDiablo/followers","following_url":"https://api.github.com/users/SonOfDiablo/following{/other_user}","gists_url":"https://api.github.com/users/SonOfDiablo/gists{/gist_id}","starred_url":"https://api.github.com/users/SonOfDiablo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SonOfDiablo/subscriptions","organizations_url":"https://api.github.com/users/SonOfDiablo/orgs","repos_url":"https://api.github.com/users/SonOfDiablo/repos","events_url":"https://api.github.com/users/SonOfDiablo/events{/privacy}","received_events_url":"https://api.github.com/users/SonOfDiablo/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-01-08T15:37:14Z","updated_at":"2021-01-08T15:37:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"## Expected behavior\r\n\r\nWhen running `6) train SAEHD.bat` again after having ran it once and saved the model, I would expect it to continue training.\r\n\r\n## Actual behavior\r\n\r\nThrows the following error:\r\n```\r\nRunning trainer.\r\n\r\nChoose one of saved models, or enter a name to create a new model.\r\n[r] : rename\r\n[d] : delete\r\n\r\n[0] : AubreyGillian - latest\r\n :\r\n0\r\nLoading AubreyGillian_SAEHD model...\r\n\r\nChoose one or several GPU idxs (separated by comma).\r\n\r\n[CPU] : CPU\r\n  [0] : GeForce RTX 2060\r\n\r\n[0] Which GPU indexes to choose? :\r\n0\r\n\r\nInitializing models: 100%|###############################################################| 5/5 [00:12<00:00,  2.43s/it]\r\nLoading samples: 100%|############################################################| 1045/1045 [00:08<00:00, 123.68it/s]\r\nLoading samples: 100%|###############################################################| 617/617 [00:16<00:00, 38.24it/s]\r\n================ Model Summary =================\r\n==                                            ==\r\n==            Model name: AubreyGillian_SAEHD ==\r\n==                                            ==\r\n==     Current iteration: 10368               ==\r\n==                                            ==\r\n==-------------- Model Options ---------------==\r\n==                                            ==\r\n==            resolution: 128                 ==\r\n==             face_type: f                   ==\r\n==     models_opt_on_gpu: True                ==\r\n==                 archi: liae-ud             ==\r\n==               ae_dims: 256                 ==\r\n==                e_dims: 64                  ==\r\n==                d_dims: 64                  ==\r\n==           d_mask_dims: 22                  ==\r\n==       masked_training: True                ==\r\n==       eyes_mouth_prio: False               ==\r\n==           uniform_yaw: False               ==\r\n==             adabelief: True                ==\r\n==            lr_dropout: n                   ==\r\n==           random_warp: True                ==\r\n==       true_face_power: 0.0                 ==\r\n==      face_style_power: 0.0                 ==\r\n==        bg_style_power: 0.0                 ==\r\n==               ct_mode: none                ==\r\n==              clipgrad: True                ==\r\n==              pretrain: False               ==\r\n==       autobackup_hour: 1                   ==\r\n== write_preview_history: False               ==\r\n==           target_iter: 0                   ==\r\n==           random_flip: True                ==\r\n==            batch_size: 20                  ==\r\n==             gan_power: 0.0                 ==\r\n==        gan_patch_size: 16                  ==\r\n==              gan_dims: 16                  ==\r\n==                                            ==\r\n==---------------- Running On ----------------==\r\n==                                            ==\r\n==          Device index: 0                   ==\r\n==                  Name: GeForce RTX 2060    ==\r\n==                  VRAM: 6.00GB              ==\r\n==                                            ==\r\n================================================\r\nStarting. Press \"Enter\" to stop training and save model.\r\nError: 2 root error(s) found.\r\n  (0) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node Conv2D_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:99) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[concat_39/concat/_809]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n  (1) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node Conv2D_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:99) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nErrors may have originated from an input operation.\r\nInput Source operations connected to node Conv2D_12:\r\n Pad_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:97)\r\n decoder/res0/conv1/weight/read (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:76)\r\n\r\nInput Source operations connected to node Conv2D_12:\r\n Pad_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:97)\r\n decoder/res0/conv1/weight/read (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:76)\r\n\r\nOriginal stack trace for 'Conv2D_12':\r\n  File \"threading.py\", line 884, in _bootstrap\r\n  File \"threading.py\", line 916, in _bootstrap_inner\r\n  File \"threading.py\", line 864, in run\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug,\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 189, in __init__\r\n    self.on_initialize()\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 381, in on_initialize\r\n    gpu_pred_src_src, gpu_pred_src_srcm = self.decoder(gpu_src_code)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 154, in forward\r\n    x = self.res0(x)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 68, in forward\r\n    x = self.conv1(inp)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\LayerBase.py\", line 14, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py\", line 99, in forward\r\n    x = tf.nn.conv2d(x, weight, self.strides, 'VALID', dilations=self.dilations, data_format=nn.data_format)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\util\\dispatch.py\", line 201, in wrapper\r\n    return target(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 2279, in conv2d\r\n    name=name)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\gen_nn_ops.py\", line 972, in conv2d\r\n    data_format=data_format, dilations=dilations, name=name)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 750, in _apply_op_helper\r\n    attrs=attr_protos, op_def=op_def)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3536, in _create_op_internal\r\n    op_def=op_def)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1990, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nTraceback (most recent call last):\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1375, in _do_call\r\n    return fn(*args)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1360, in _run_fn\r\n    target_list, run_metadata)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1453, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: 2 root error(s) found.\r\n  (0) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[{{node Conv2D_12}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[concat_39/concat/_809]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n  (1) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[{{node Conv2D_12}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 130, in trainerThread\r\n    iter, iter_time = model.train_one_iter()\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 462, in train_one_iter\r\n    losses = self.onTrainOneIter()\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 678, in onTrainOneIter\r\n    src_loss, dst_loss = self.src_dst_train (warped_src, target_src, target_srcm, target_srcm_em, warped_dst, target_dst, target_dstm, target_dstm_em)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 538, in src_dst_train\r\n    self.target_dstm_em:target_dstm_em,\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 968, in run\r\n    run_metadata_ptr)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1191, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1369, in _do_run\r\n    run_metadata)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1394, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: 2 root error(s) found.\r\n  (0) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node Conv2D_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:99) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n         [[concat_39/concat/_809]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n  (1) Resource exhausted: OOM when allocating tensor with shape[512,512,3,3] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n         [[node Conv2D_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:99) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nErrors may have originated from an input operation.\r\nInput Source operations connected to node Conv2D_12:\r\n Pad_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:97)\r\n decoder/res0/conv1/weight/read (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:76)\r\n\r\nInput Source operations connected to node Conv2D_12:\r\n Pad_12 (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:97)\r\n decoder/res0/conv1/weight/read (defined at C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py:76)\r\n\r\nOriginal stack trace for 'Conv2D_12':\r\n  File \"threading.py\", line 884, in _bootstrap\r\n  File \"threading.py\", line 916, in _bootstrap_inner\r\n  File \"threading.py\", line 864, in run\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug,\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 189, in __init__\r\n    self.on_initialize()\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 381, in on_initialize\r\n    gpu_pred_src_src, gpu_pred_src_srcm = self.decoder(gpu_src_code)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 154, in forward\r\n    x = self.res0(x)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 68, in forward\r\n    x = self.conv1(inp)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\LayerBase.py\", line 14, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\DeepFaceLab\\core\\leras\\layers\\Conv2D.py\", line 99, in forward\r\n    x = tf.nn.conv2d(x, weight, self.strides, 'VALID', dilations=self.dilations, data_format=nn.data_format)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\util\\dispatch.py\", line 201, in wrapper\r\n    return target(*args, **kwargs)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 2279, in conv2d\r\n    name=name)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\gen_nn_ops.py\", line 972, in conv2d\r\n    data_format=data_format, dilations=dilations, name=name)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 750, in _apply_op_helper\r\n    attrs=attr_protos, op_def=op_def)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3536, in _create_op_internal\r\n    op_def=op_def)\r\n  File \"C:\\Programs\\DeepFaceLab_NVIDIA\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1990, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n```\r\n\r\n## Steps to reproduce\r\n\r\nRun `6) train SAEHD.bat` once, then hit enter to stop and save, run `6) train SAEHD.bat` again.\r\n\r\n## Other relevant information\r\n- **Command lined used (if not specified in steps to reproduce)**: The content of `6) train SAEHD.bat`:\r\n```\r\n@echo off\r\ncall _internal\\setenv.bat\r\n\r\n\"%PYTHON_EXECUTABLE%\" \"%DFL_ROOT%\\main.py\" train ^\r\n    --training-data-src-dir \"%WORKSPACE%\\data_src\\aligned\" ^\r\n    --training-data-dst-dir \"%WORKSPACE%\\data_dst\\aligned\" ^\r\n    --pretraining-data-dir \"%INTERNAL%\\pretrain_CelebA\" ^\r\n    --model-dir \"%WORKSPACE%\\model\" ^\r\n    --model SAEHD\r\n\r\npause\r\n```\r\n- **Operating system and version:** Windows 10 Home [64-bit] (10.0.19042)\r\n- **Python version:** 3.9.1","closed_by":null,"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5236/timeline","performed_via_github_app":null,"state_reason":null}