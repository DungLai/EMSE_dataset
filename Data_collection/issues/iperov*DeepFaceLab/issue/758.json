{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/758","id":623691130,"node_id":"MDU6SXNzdWU2MjM2OTExMzA=","number":758,"title":"Xseg Mask applyed dataset training, Possible Memory Leak","user":{"login":"w-e-w","id":40751091,"node_id":"MDQ6VXNlcjQwNzUxMDkx","avatar_url":"https://avatars.githubusercontent.com/u/40751091?v=4","gravatar_id":"","url":"https://api.github.com/users/w-e-w","html_url":"https://github.com/w-e-w","followers_url":"https://api.github.com/users/w-e-w/followers","following_url":"https://api.github.com/users/w-e-w/following{/other_user}","gists_url":"https://api.github.com/users/w-e-w/gists{/gist_id}","starred_url":"https://api.github.com/users/w-e-w/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/w-e-w/subscriptions","organizations_url":"https://api.github.com/users/w-e-w/orgs","repos_url":"https://api.github.com/users/w-e-w/repos","events_url":"https://api.github.com/users/w-e-w/events{/privacy}","received_events_url":"https://api.github.com/users/w-e-w/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-05-23T16:11:17Z","updated_at":"2020-05-29T06:05:19Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"## Expected behavior\r\nfolling the Xseg Mini tutorial video\r\nafter Xseg has been applyed to dataset, the mask is checked mask some more if needed then train some more\r\nI also train the SAEHD mode with Xesg mask applyed.\r\nI've try this workflow (with good result) with data set size of 5,000 faces.\r\nbut when try the same thing on a larger **datset of 60,000 faces, I couldent start the trainer.**\r\n\r\n## Actual behavior\r\nwhen initializing traing for Xseg and SAEHD model with Dataset have Xseg mask Applyed\r\nit's useing so much RAM as to filled up the Ram and Pagefiles.\r\nthis happens when I have a large datasets (on my computer it's 30K~60K of aligned frames)\r\nnot able to start training, even after I set the max pagefile size to a very large ammount (160GB) it still won't start training\r\nI check in the task manager at the time and found that DFL was useing around 30GB~~60GB of ram & pagefile.\r\n(lot of RAM but still hasent reach the pagefile limit)\r\nI consider this to be Memory Leaking.\r\n\r\nthis happend on **both Xsrg and SAEHD** training, during initializing phase after loadind in the sample, the prpgram erros and stops\r\nmemory usege start climbing while loading the Xseg mask applyed facesets\r\n\r\n##  Consol logs\r\n**4 cases both for the SAEHD and Xseg, and with enough and not enough pagefile:**\r\n**SAEHD with Enough Pagefile:**\r\n```\r\nRunning trainer.\r\nChoose one of saved models, or enter a name to create a new model.\r\n[r] : rename\r\n[d] : delete\r\n[0] : 128 DF 256 64 64 16 - latest\r\n :\r\n0\r\nLoading 128 DF 256 64 64 16_SAEHD model...\r\nChoose one or several GPU idxs (separated by comma).\r\n[CPU] : CPU\r\n  [0] : GeForce GTX 1650\r\n[0] Which GPU indexes to choose? :\r\n0\r\nInitializing models: 100%|####################| 5/5 [00:02<00:00,  1.80it/s]\r\nLoading samples: 100%|####################| 1794/1794 [00:05<00:00, 350.12it/s]\r\nLoading samples: 100%|####################| 62987/62987 [02:15<00:00, 464.19it/s]\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"multiprocessing\\spawn.py\", line 105, in spawn_main\r\n  File \"multiprocessing\\spawn.py\", line 115, in _main\r\n  File \"multiprocessing\\heap.py\", line 55, in __setstate__\r\nOSError: [WinError 1450] Insufficient system resources exist to complete the requested service\r\n```\r\n\r\n**SAEHD with not Enough Pagefile**\r\n```\r\nInitializing models: 100%|####################| 5/5 [00:02<00:00,  1.89it/s]\r\nLoading samples: 100%|####################| 1794/1794 [00:04<00:00, 412.70it/s]\r\nLoading samples: 100%|####################| 62987/62987 [02:15<00:00, 466.56it/s]\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"multiprocessing\\spawn.py\", line 105, in spawn_main\r\n  File \"multiprocessing\\spawn.py\", line 115, in _main\r\n  File \"multiprocessing\\heap.py\", line 55, in __setstate__\r\nOSError: [WinError 1455] The paging file is too small for this operation to complete\r\n```\r\n\r\n**Xseg with Enough Pagefile**\r\n```\r\nRunning trainer.\r\nLoading XSeg model...\r\nChoose one or several GPU idxs (separated by comma).\r\n[CPU] : CPU\r\n  [0] : GeForce GTX 1650\r\n[0] Which GPU indexes to choose? :\r\n0\r\nLoading samples: 100%|####################| 1794/1794 [00:03<00:00, 450.25it/s]\r\nLoading samples: 100%|####################| 62987/62987 [02:12<00:00, 475.27it/s]\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"multiprocessing\\spawn.py\", line 105, in spawn_main\r\n  File \"multiprocessing\\spawn.py\", line 115, in _main\r\n  File \"multiprocessing\\heap.py\", line 55, in __setstate__\r\nOSError: [WinError 1450] Insufficient system resources exist to complete the requested service\r\n```\r\n\r\n**Xseg with not Enough Pagefile**\r\n```\r\nLoading samples: 100%|####################| 1794/1794 [00:03<00:00, 490.42it/s]\r\nLoading samples: 100%|####################| 62987/62987 [02:11<00:00, 478.69it/s]\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"multiprocessing\\spawn.py\", line 105, in spawn_main\r\n  File \"multiprocessing\\spawn.py\", line 115, in _main\r\n  File \"multiprocessing\\heap.py\", line 55, in __setstate__\r\nOSError: [WinError 1455] The paging file is too small for this operation to complete\r\n```\r\n\r\n**note: the error log are cleaned, some time it randomly prints out the same thing multiple times**\r\n\r\n## Steps to reproduce\r\ntrain a large data set's Xseg mode, (for system of 16GB ram, try using 30k~60k faces)\r\napply the Xseg Mask on to the data set,\r\ntrain the dataset either Xseg or SAEHD\r\nmonitor RAM usage with Task Manager\r\nmemory usage shoud clim, Error should occur after Sample are loaded in.\r\n\r\n## My Thoughts\r\nthis ment I count train with Xseg mask applyed and had to remove Xseg mask before training\r\nI still have good results without training SAEHD model Xseg mask applyed and mergeing with learned-prd*learned-dst*XSeg-prd*XSeg-dst, though I have good results, I still think the result could be better if I can train the SAEHD model with Xseg applyed.\r\nwhat more from what I understand Xseg training don't even use the Apply Xseg mask, I only use the manual mask which we marke by hand.\r\n\r\nfrom what I understnd, the Xseg mask should not need to be loaded in to RAM, or at lest only the one that are going to be use need to be loaded, and even it needs to be fully loaded into the ram, I don't understad where the 30+GB ram/pagefile usage is comming form, I compare the size of the faceset and only found there's only a 76MB increase for the 63000 faces, even if what's loaded in RAM is it the compress raw form, I still can't comprehend for the 400+ fold increase in size,\r\nI think ther must be somthing wrong when loadind in the sample data sets.\r\n\r\na temporary fix would be for the trainer to have an option to not load in the Xseg data.\r\n\r\n\r\n## Other relevant information\r\nDFL Windows build: DeepFaceLab_NVIDIA_build_05_06_2020\r\nOS: Win10 64bit\r\nCPU: i5-9300H (yes I am useing a laptop)\r\nRAM: 16G\r\nGPU: GTX1650 VRAM 4G\r\nStorage: 2 500GB SSD\r\ndst faceset size of 60,000","closed_by":null,"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/758/timeline","performed_via_github_app":null,"state_reason":null}