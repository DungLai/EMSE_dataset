{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5311","id":860683556,"node_id":"MDU6SXNzdWU4NjA2ODM1NTY=","number":5311,"title":"Proposed solution for extremely rotated aligned faces","user":{"login":"stohrendorf","id":7853507,"node_id":"MDQ6VXNlcjc4NTM1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/7853507?v=4","gravatar_id":"","url":"https://api.github.com/users/stohrendorf","html_url":"https://github.com/stohrendorf","followers_url":"https://api.github.com/users/stohrendorf/followers","following_url":"https://api.github.com/users/stohrendorf/following{/other_user}","gists_url":"https://api.github.com/users/stohrendorf/gists{/gist_id}","starred_url":"https://api.github.com/users/stohrendorf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stohrendorf/subscriptions","organizations_url":"https://api.github.com/users/stohrendorf/orgs","repos_url":"https://api.github.com/users/stohrendorf/repos","events_url":"https://api.github.com/users/stohrendorf/events{/privacy}","received_events_url":"https://api.github.com/users/stohrendorf/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-04-18T14:52:29Z","updated_at":"2021-05-14T17:19:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"## Expected behavior\r\n\r\nProfile-like images should have their head's vertical axis also vertically aligned to the cut-out even if the head is slightly tilted to the side.\r\n\r\n## Actual behavior\r\n\r\nFor faces in profile or close to profile positions, which are also tilted to the side, the cut-out is usually rotated so that in extreme cases the aligned face is nearly horizontal.\r\n\r\n## Steps to reproduce\r\n\r\nSee above.\r\n\r\n## Other relevant information\r\nThe issue is that in `get_transform_mat` most of the reference points are brows and eyes. In a tilted profile view, eyes are basically vertically aligned, leading to a rotation of the cut-out because there's not enough weight on the vertical axis. I came up with the following \"solution\" (there might be a better one) to increase the weight on the vertical axis, which significantly reduced nearly all problems related to these extreme rotations, except when there are _very_ extreme head rotations. It also slightly increased the convergence speed of the training as there's less rotational variation in more frontal face images.\r\n\r\nIn `get_transform_mat`, the current line of code determining the transformation matrix is\r\n```python\r\n    mat = umeyama( np.concatenate ( [ image_landmarks[17:49] , image_landmarks[54:55] ] ) , landmarks_2D_new, True)[0:2]\r\n```\r\nI replaced this with the following lines of code, putting much more weight on the chin point (not sure which point exactly that is):\r\n```python\r\n    CHIN_WEIGHT = 30\r\n    mat = umeyama(\r\n        np.concatenate([image_landmarks[17:49], image_landmarks[54]*np.ones((CHIN_WEIGHT, 2))]),\r\n        np.concatenate([landmarks_2D_new[:-1], landmarks_2D_new[-1]*np.ones((CHIN_WEIGHT, 2))]),\r\n        True)[0:2]\r\n```\r\n\r\nThis is a solution that works, but it's a bit hacky. Another one could be to average the eye reference points per eye and exclude the brows, so you have 3 points in the end from which to calculate the transformation matrix. The reason for excluding the brows is that they can be transformed asymmetrically, e.g. the axis between these points is not necessarily orthogonal to the face's vertical axis when only one brow is lifted, while eyes stay at the same point.\r\n\r\nI hope this helps.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5311/timeline","performed_via_github_app":null,"state_reason":null}