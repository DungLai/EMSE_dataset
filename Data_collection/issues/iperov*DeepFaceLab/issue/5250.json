{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5250","id":789390536,"node_id":"MDU6SXNzdWU3ODkzOTA1MzY=","number":5250,"title":"Issue training on GeoForce GTX 1060 with DFL 2.x","user":{"login":"leducjjr","id":20494342,"node_id":"MDQ6VXNlcjIwNDk0MzQy","avatar_url":"https://avatars.githubusercontent.com/u/20494342?v=4","gravatar_id":"","url":"https://api.github.com/users/leducjjr","html_url":"https://github.com/leducjjr","followers_url":"https://api.github.com/users/leducjjr/followers","following_url":"https://api.github.com/users/leducjjr/following{/other_user}","gists_url":"https://api.github.com/users/leducjjr/gists{/gist_id}","starred_url":"https://api.github.com/users/leducjjr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leducjjr/subscriptions","organizations_url":"https://api.github.com/users/leducjjr/orgs","repos_url":"https://api.github.com/users/leducjjr/repos","events_url":"https://api.github.com/users/leducjjr/events{/privacy}","received_events_url":"https://api.github.com/users/leducjjr/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-01-19T21:34:21Z","updated_at":"2021-06-27T22:32:08Z","closed_at":"2021-06-27T21:08:26Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, please can someone review and advise?  This looks like an issue between my hardware/software and tensorflow, but I've reached the end of my analysis effort ideas.  I've been working on this for a while now,\r\n\r\nI'm trying different things like updating drivers, using different versions of tensorflow-gpu (which massively failed to work, haha), downgrading my CUDA setup, etc.  I'm posting here in the hopes that 1) someone may have seen this and addressed it already and will share the solution so I can fix my kit and 2) others with the same issue can find the solution. \r\n\r\nI know it's an issue related to tensorflow but i'm posting it here because this may also impact other DFL users who may find this thread to be useful.\r\n\r\n## Expected behavior\r\n\r\nIn DFL 1.x I could train on my GeoForce GTX 1060 with no problem.  \r\n\r\n## Actual behavior\r\n\r\nWhen I updated by kit to use DFL 2.x and updated dependencies, I received the message below when trying to use the GPU.  \r\n\r\nError: No OpKernel was registered to support Op 'DepthToSpace' used by node DepthToSpace (defined at D:\\adm\\dfl\\code\\trunk\\core\\leras\\ops\\__init__.py:336)  with these attrs: [block_size=2, T=DT_FLOAT, data_format=\"NCHW\"]\r\n\r\n*Describe, in some detail, what the program does instead. Be sure to include any error message or screenshots.*\r\n\r\nWhen I try to use the GPU I get the error message and the training session halts.\r\n\r\nUsing the CPU works, but isn't sustainable.  CPU is at 100% all the time and progress is tremendously slow.\r\n\r\nI looked up the error message and it's coming from tensorflow code on github. I see solutions but they involve coding that I'm not comfortable applying to my local version of DFL.  \r\n\r\nIt looks like tensorflow can find what it's looking for (\"NHWC\") on my CPUs but not on my GPUs.  I know it's a tensorflow message because I accidentally found the source code on GitHub where the text \"data_format=\"NCHW\"\" in it.  Like a doofus I forgot to bookmark the page and can't find it again.  I'm downloading the tensorflow repo now to try to provide better detail but that'll take a while. When I find the module again I'll add that info to this post as a comment.\r\n\r\n## Steps to reproduce\r\n\r\nRan my handy dandy batch file\r\n\r\n## Other relevant information\r\n- GFX card: GeForce GTX 1060 6GB\r\n\r\n- **Command lined used:  This is the actual command line.  I created a batch file that uses relative pathing to get to the main.py script and to reference the src and dst and model folders.\r\n\r\npython \"..\\..\\..\\code\\trunk\\main.py\" train --training-data-src-dir \"..\\..\\src\\kristi\\faces-all\" --training-data-dst-dir \"..\\..\\dst\\liliana\\pics\\faces\" --model-dir \"..\\..\\models\\liliana\\pics(kristi)\" --model \"SAEHD\"-   \r\n\r\n- **Operating system and version:** Windows 10\r\n- **Python version:** Python 3.6.8\r\n- dependencies loaded using pip: https://github.com/iperov/DeepFaceLab.git/trunk/requirements-cuda.txt\r\n- CUDA_PATH = C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v10.2\r\n- CUDAnn = cudnn-10.2-windows10-x64-v8.0.5.39\r\n- VC_redist.x64 downloaded and installed as per TensorFlow's documentation for Windows users\r\n\r\n## Full session and error message\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set DST=liliana\\pics\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set SRC=kristi\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set SRCDIR=..\\..\\src\\kristi\\faces-all\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set DSTDIR=..\\..\\dst\\liliana\\pics\\faces\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set MODELDIR=..\\..\\models\\liliana\\pics(kristi)\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set MODEL=SAEHD\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>set PRGPATH=..\\..\\..\\code\\trunk\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>md \"..\\..\\models\\liliana\\pics(kristi)\"\r\nA subdirectory or file ..\\..\\models\\liliana\\pics(kristi) already exists.\r\n\r\nD:\\adm\\dfl\\data\\batch_scripts\\liliana-pics(kristi)>python \"..\\..\\..\\code\\trunk\\main.py\" train --training-data-src-dir \"..\\..\\src\\kristi\\faces-all\" --training-data-dst-dir \"..\\..\\dst\\liliana\\pics\\faces\" --model-dir \"..\\..\\models\\liliana\\pics(kristi)\" --model \"SAEHD\"\r\nRunning trainer.\r\n\r\nChoose one of saved models, or enter a name to create a new model.\r\n[r] : rename\r\n[d] : delete\r\n\r\n[0] : new - latest\r\n :\r\n0\r\nLoading new_SAEHD model...\r\n\r\nChoose one or several GPU idxs (separated by comma).\r\n\r\n[CPU] : CPU\r\n  [0] : GeForce GTX 1060 6GB\r\n\r\n[0] Which GPU indexes to choose? :\r\n0\r\n\r\nInitializing models:   0%|                                                                       | 0/5 [00:00<?, ?it/s]\r\nError: No OpKernel was registered to support Op 'DepthToSpace' used by node DepthToSpace (defined at D:\\adm\\dfl\\code\\trunk\\core\\leras\\ops\\__init__.py:336)  with these attrs: [block_size=2, T=DT_FLOAT, data_format=\"NCHW\"]\r\nRegistered devices: [CPU]\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_UINT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_HALF]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BFLOAT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_FLOAT]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_DOUBLE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX128]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BOOL]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_STRING]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_RESOURCE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_VARIANT]; data_format in [\"NHWC\"]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_QINT8]\r\n\r\n         [[DepthToSpace]]\r\n\r\nErrors may have originated from an input operation.\r\nInput Source operations connected to node DepthToSpace:\r\n LeakyRelu_4 (defined at D:\\adm\\dfl\\code\\trunk\\core\\leras\\archis\\DeepFakeArchi.py:58)\r\nTraceback (most recent call last):\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1375, in _do_call\r\n    return fn(*args)\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1358, in _run_fn\r\n    self._extend_graph()\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1398, in _extend_graph\r\n    tf_session.ExtendSession(self._session)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: No OpKernel was registered to support Op 'DepthToSpace' used by {{node DepthToSpace}} with these attrs: [block_size=2, T=DT_FLOAT, data_format=\"NCHW\"]\r\nRegistered devices: [CPU]\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_UINT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_HALF]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BFLOAT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_FLOAT]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_DOUBLE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX128]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BOOL]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_STRING]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_RESOURCE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_VARIANT]; data_format in [\"NHWC\"]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_QINT8]\r\n\r\n         [[DepthToSpace]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"D:\\adm\\dfl\\code\\trunk\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug,\r\n  File \"D:\\adm\\dfl\\code\\trunk\\models\\ModelBase.py\", line 189, in __init__\r\n    self.on_initialize()\r\n  File \"D:\\adm\\dfl\\code\\trunk\\models\\Model_SAEHD\\Model.py\", line 611, in on_initialize\r\n    model.init_weights()\r\n  File \"D:\\adm\\dfl\\code\\trunk\\core\\leras\\layers\\Saveable.py\", line 104, in init_weights\r\n    nn.init_weights(self.get_weights())\r\n  File \"D:\\adm\\dfl\\code\\trunk\\core\\leras\\ops\\__init__.py\", line 48, in init_weights\r\n    nn.tf_sess.run (ops)\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 968, in run\r\n    run_metadata_ptr)\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1191, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1369, in _do_run\r\n    run_metadata)\r\n  File \"C:\\Program Files\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1394, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: No OpKernel was registered to support Op 'DepthToSpace' used by node DepthToSpace (defined at D:\\adm\\dfl\\code\\trunk\\core\\leras\\ops\\__init__.py:336)  with these attrs: [block_size=2, T=DT_FLOAT, data_format=\"NCHW\"]\r\nRegistered devices: [CPU]\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_UINT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_UINT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT8]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_INT32]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_HALF]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BFLOAT16]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_FLOAT]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_DOUBLE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX64]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_COMPLEX128]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_BOOL]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_STRING]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_RESOURCE]; data_format in [\"NHWC\"]\r\n  device='CPU'; T in [DT_VARIANT]; data_format in [\"NHWC\"]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_QINT8]\r\n\r\n         [[DepthToSpace]]\r\n\r\nErrors may have originated from an input operation.\r\nInput Source operations connected to node DepthToSpace:\r\n LeakyRelu_4 (defined at D:\\adm\\dfl\\code\\trunk\\core\\leras\\archis\\DeepFakeArchi.py:58)\r\n\r\n","closed_by":{"login":"leducjjr","id":20494342,"node_id":"MDQ6VXNlcjIwNDk0MzQy","avatar_url":"https://avatars.githubusercontent.com/u/20494342?v=4","gravatar_id":"","url":"https://api.github.com/users/leducjjr","html_url":"https://github.com/leducjjr","followers_url":"https://api.github.com/users/leducjjr/followers","following_url":"https://api.github.com/users/leducjjr/following{/other_user}","gists_url":"https://api.github.com/users/leducjjr/gists{/gist_id}","starred_url":"https://api.github.com/users/leducjjr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leducjjr/subscriptions","organizations_url":"https://api.github.com/users/leducjjr/orgs","repos_url":"https://api.github.com/users/leducjjr/repos","events_url":"https://api.github.com/users/leducjjr/events{/privacy}","received_events_url":"https://api.github.com/users/leducjjr/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5250/timeline","performed_via_github_app":null,"state_reason":"completed"}