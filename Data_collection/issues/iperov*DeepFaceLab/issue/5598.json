{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598","repository_url":"https://api.github.com/repos/iperov/DeepFaceLab","labels_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598/labels{/name}","comments_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598/comments","events_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598/events","html_url":"https://github.com/iperov/DeepFaceLab/issues/5598","id":1489139171,"node_id":"I_kwDOCBuapc5YwnXj","number":5598,"title":"3070TI (laptop) shows better compatibility with DX12 build compared to 3000 build (More memoryerrors)","user":{"login":"JulesLiu","id":60243348,"node_id":"MDQ6VXNlcjYwMjQzMzQ4","avatar_url":"https://avatars.githubusercontent.com/u/60243348?v=4","gravatar_id":"","url":"https://api.github.com/users/JulesLiu","html_url":"https://github.com/JulesLiu","followers_url":"https://api.github.com/users/JulesLiu/followers","following_url":"https://api.github.com/users/JulesLiu/following{/other_user}","gists_url":"https://api.github.com/users/JulesLiu/gists{/gist_id}","starred_url":"https://api.github.com/users/JulesLiu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JulesLiu/subscriptions","organizations_url":"https://api.github.com/users/JulesLiu/orgs","repos_url":"https://api.github.com/users/JulesLiu/repos","events_url":"https://api.github.com/users/JulesLiu/events{/privacy}","received_events_url":"https://api.github.com/users/JulesLiu/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-12-10T23:50:51Z","updated_at":"2022-12-18T08:40:35Z","closed_at":"2022-12-18T08:40:35Z","author_association":"NONE","active_lock_reason":null,"body":"First of all, I want to ask that, theoretically, should 3000 build provide a better performance or not? If not, maybe I will stop trying to figure out how to run 3000 build properly.\r\n\r\nOK, now the description of the problems:\r\nIn general, for training, 3000 build always crashes, and usually with a MemoryError or low paging file message. (There were many times just nothing happened after finished loading samples, I searched the Issues here, it seems most ppl think it's due to low paging file)\r\nI tried to increase the paging file, 32-42G for the C drive, and 32-64G for the drive where the project locate in. (Which is the one the codes really use? The system drive C: in this case?) Only in very very rare case, this works for very light load training like batch size 2 and lowest for all parameters.\r\nThe errors and where the codes crash are different almost every time, the error messages are very similar to #5524 . So I tried his method. by reducing the number of worker, change the Model.py 669 to:\r\ncpu_count = multiprocessing.cpu_count() // 2\r\nI did this to both AMP and SAEHD training codes. The good thing is, the AMP works for most time, but the SAEHD still crashes.\r\nSo for SAEHD, if I start a new model training with a batch size of 2, lowest for all parameters, it can run. But if I increase the batch size to 4, no other changes, it crashes. With DX12 build, I can train with a pretrained model (res: 256, dims: 256/64/64/22) bs=8.\r\nThe followings are images to show that 3000 build only recognizes 5+G VRAM even when the AMP works, while the DX12 recognized 6+ available, and also the latest error message I got when I ran the SAEHD training codes:\r\n\r\n![Screenshot 2022-12-10 033749](https://user-images.githubusercontent.com/60243348/206879865-d79bf8f9-50f9-4db1-aa0f-00500e6b23f9.png)\r\n![Screenshot 2022-12-10 050344](https://user-images.githubusercontent.com/60243348/206879866-74e3fdf3-7c0c-416d-90c0-1a35631dd62b.png)\r\n![Screenshot 2022-12-10 022324](https://user-images.githubusercontent.com/60243348/206879867-69531c21-20f9-45ca-8ab9-2dbd59125532.png)\r\n\r\n`Error:\r\nTraceback (most recent call last):\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1375, in _do_call\r\n    return fn(*args)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1360, in _run_fn\r\n    target_list, run_metadata)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1453, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.InternalError: 2 root error(s) found.\r\n  (0) Internal: Attempting to perform BLAS operation using StreamExecutor without BLAS support\r\n         [[{{node MatMul}}]]\r\n         [[Sigmoid_5/_821]]\r\n  (1) Internal: Attempting to perform BLAS operation using StreamExecutor without BLAS support\r\n         [[{{node MatMul}}]]\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 263, in update_sample_for_preview\r\n    self.get_history_previews()\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 383, in get_history_previews\r\n    return self.onGetPreview (self.sample_for_preview, for_history=True)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 789, in onGetPreview\r\n    S, D, SS, DD, DDM, SD, SDM = [ np.clip( nn.to_data_format(x,\"NHWC\", self.model_data_format), 0.0, 1.0) for x in ([target_src,target_dst] + self.AE_view (target_src, target_dst) ) ]\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 611, in AE_view\r\n    self.warped_dst:warped_dst})\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 968, in run\r\n    run_metadata_ptr)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1191, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1369, in _do_run\r\n    run_metadata)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1394, in _do_call\r\n    raise type(e)(node_def, op, message)  # pylint: disable=no-value-for-parameter\r\ntensorflow.python.framework.errors_impl.InternalError: 2 root error(s) found.\r\n  (0) Internal: Attempting to perform BLAS operation using StreamExecutor without BLAS support\r\n         [[node MatMul (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\Dense.py:66) ]]\r\n         [[Sigmoid_5/_821]]\r\n  (1) Internal: Attempting to perform BLAS operation using StreamExecutor without BLAS support\r\n         [[node MatMul (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\Dense.py:66) ]]\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nErrors may have originated from an input operation.\r\nInput Source operations connected to node MatMul:\r\n inter_AB/dense1/weight/read (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\Dense.py:47)\r\n mul_6 (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:400)\r\n\r\nInput Source operations connected to node MatMul:\r\n inter_AB/dense1/weight/read (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\Dense.py:47)\r\n mul_6 (defined at A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\ops\\__init__.py:400)\r\n\r\nOriginal stack trace for 'MatMul':\r\n  File \"threading.py\", line 884, in _bootstrap\r\n  File \"threading.py\", line 916, in _bootstrap_inner\r\n  File \"threading.py\", line 864, in run\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 193, in __init__\r\n    self.on_initialize()\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 416, in on_initialize\r\n    gpu_src_inter_AB_code = self.inter_AB (gpu_src_code)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\models\\ModelBase.py\", line 117, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\archis\\DeepFakeArchi.py\", line 151, in forward\r\n    x = self.dense1(x)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\LayerBase.py\", line 14, in __call__\r\n    return self.forward(*args, **kwargs)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\leras\\layers\\Dense.py\", line 66, in forward\r\n    x = tf.matmul(x, weight)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\util\\dispatch.py\", line 206, in wrapper\r\n    return target(*args, **kwargs)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\math_ops.py\", line 3655, in matmul\r\n    a, b, transpose_a=transpose_a, transpose_b=transpose_b, name=name)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\ops\\gen_math_ops.py\", line 5713, in mat_mul\r\n    name=name)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 750, in _apply_op_helper\r\n    attrs=attr_protos, op_def=op_def)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3569, in _create_op_internal\r\n    op_def=op_def)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\python-3.6.8\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 2045, in __init__\r\n    self._traceback = tf_stack.extract_stack_for_node(self._c_op)\r\n\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\mainscripts\\Trainer.py\", line 58, in trainerThread\r\n    debug=debug)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 193, in __init__\r\n    self.on_initialize()\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\Model_SAEHD\\Model.py\", line 698, in on_initialize\r\n    self.update_sample_for_preview(force_new=True)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 265, in update_sample_for_preview\r\n    self.sample_for_preview = self.generate_next_samples()\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\models\\ModelBase.py\", line 461, in generate_next_samples\r\n    sample.append ( generator.generate_next() )\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\samplelib\\SampleGeneratorBase.py\", line 21, in generate_next\r\n    self.last_generation = next(self)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\samplelib\\SampleGeneratorFace.py\", line 112, in __next__\r\n    return next(generator)\r\n  File \"A:\\AIprojects\\DeepFaceLab_NVIDIA_RTX3000_series\\_internal\\DeepFaceLab\\core\\joblib\\SubprocessGenerator.py\", line 73, in __next__\r\n    gen_data = self.cs_queue.get()\r\n  File \"multiprocessing\\queues.py\", line 94, in get\r\n  File \"multiprocessing\\connection.py\", line 216, in recv_bytes\r\n  File \"multiprocessing\\connection.py\", line 318, in _recv_bytes\r\n  File \"multiprocessing\\connection.py\", line 340, in _get_more_data\r\nMemoryError`","closed_by":{"login":"JulesLiu","id":60243348,"node_id":"MDQ6VXNlcjYwMjQzMzQ4","avatar_url":"https://avatars.githubusercontent.com/u/60243348?v=4","gravatar_id":"","url":"https://api.github.com/users/JulesLiu","html_url":"https://github.com/JulesLiu","followers_url":"https://api.github.com/users/JulesLiu/followers","following_url":"https://api.github.com/users/JulesLiu/following{/other_user}","gists_url":"https://api.github.com/users/JulesLiu/gists{/gist_id}","starred_url":"https://api.github.com/users/JulesLiu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JulesLiu/subscriptions","organizations_url":"https://api.github.com/users/JulesLiu/orgs","repos_url":"https://api.github.com/users/JulesLiu/repos","events_url":"https://api.github.com/users/JulesLiu/events{/privacy}","received_events_url":"https://api.github.com/users/JulesLiu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/iperov/DeepFaceLab/issues/5598/timeline","performed_via_github_app":null,"state_reason":"completed"}