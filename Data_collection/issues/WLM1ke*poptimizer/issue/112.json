{"url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112","repository_url":"https://api.github.com/repos/WLM1ke/poptimizer","labels_url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112/labels{/name}","comments_url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112/comments","events_url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112/events","html_url":"https://github.com/WLM1ke/poptimizer/issues/112","id":1393508133,"node_id":"I_kwDOCYyMws5TDz8l","number":112,"title":"V3. POptimizer: abnormal termination with uncaught error -> KeyError('positions')","user":{"login":"vSINKS","id":61885366,"node_id":"MDQ6VXNlcjYxODg1MzY2","avatar_url":"https://avatars.githubusercontent.com/u/61885366?v=4","gravatar_id":"","url":"https://api.github.com/users/vSINKS","html_url":"https://github.com/vSINKS","followers_url":"https://api.github.com/users/vSINKS/followers","following_url":"https://api.github.com/users/vSINKS/following{/other_user}","gists_url":"https://api.github.com/users/vSINKS/gists{/gist_id}","starred_url":"https://api.github.com/users/vSINKS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vSINKS/subscriptions","organizations_url":"https://api.github.com/users/vSINKS/orgs","repos_url":"https://api.github.com/users/vSINKS/repos","events_url":"https://api.github.com/users/vSINKS/events{/privacy}","received_events_url":"https://api.github.com/users/vSINKS/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-10-01T18:36:47Z","updated_at":"2022-10-01T20:02:41Z","closed_at":"2022-10-01T20:02:41Z","author_association":"NONE","active_lock_reason":null,"body":"Добрый день! \r\nНовая версия \"из коробки\" не завелась. \r\nОпытным путем удалось выяснить,  что пока web-сервер \"не рухнул\" необходимо успеть добавить и сохранить тикер в портфель. После этого, при следующем старте - успеть создать новый счет (например Acc1), добавить ему баланс и сохранить изменения. После этого web-сервер более \"не рушился\".\r\nПолагаю, при первом запуске (если БД data_new только создается) необходимо  добавлять какой-нибудь \"тикер по умолчанию\" (Газпром, например), далее пользователь сам удалит \"тикер. по умолчанию\" если он ему не нужен. Правда потребуется защита, что нельзя удалять все тикеры (иначе после удаления \"тикера по умолчанию\" -  снова может сломаться web-сервер)\r\n\r\nНа вкладке Tickers не очевидно, то необходимо начать набирать имя тикера, чтобы что-то стало отображаться, выглядит как будто не прогрузился интерфейс (может отображать там первые 100 тикеров, но серым цветом).\r\n\r\n2022-10-01 21:12:54 INF POptimizer: starting...\r\n2022-10-01 21:12:54 INF Server:     started on http://localhost:5000 - press CTRL+C to quit\r\n2022-10-01 21:12:54 INF Updater:    started with last update for 1970-01-01\r\n2022-10-01 21:12:54 INF Updater:    checking new trading data for 2022-09-30\r\n2022-10-01 21:12:55 INF Updater:    updates are beginning\r\n2022-10-01 21:12:55 INF Securities: update is completed\r\n2022-10-01 21:12:55 INF USD:        update is completed\r\n2022-10-01 21:13:03 INF CPI:        update is completed\r\n2022-10-01 21:13:04 ERR POptimizer: abnormal termination with uncaught error -> KeyError('positions')\r\nTraceback (most recent call last):\r\n  File \"/home/poptimizer/poptimizer/__main__.py\", line 43, in _run\r\n    await task\r\n  File \"/usr/lib/python3.10/asyncio/tasks.py\", line 571, in _wait_for_one\r\n    return f.result()  # May raise f.exception().\r\n  File \"/home/poptimizer/poptimizer/data/updater.py\", line 84, in run\r\n    await self._try_to_update()\r\n  File \"/home/poptimizer/poptimizer/data/updater.py\", line 124, in _try_to_update\r\n    await self._update(new_update_day)\r\n  File \"/home/poptimizer/poptimizer/data/updater.py\", line 132, in _update\r\n    await asyncio.gather(\r\n  File \"/home/poptimizer/poptimizer/data/updater.py\", line 148, in _update_sec\r\n    await asyncio.gather(\r\n  File \"/home/poptimizer/poptimizer/data/updater.py\", line 155, in _update_raw_div\r\n    status_rows = await self._status_srv.update(update_day, sec)\r\n  File \"/home/poptimizer/poptimizer/data/update/raw/status.py\", line 75, in update\r\n    status = await self._update(update_day, sec)\r\n  File \"/home/poptimizer/poptimizer/data/update/raw/status.py\", line 89, in _update\r\n    selected = set(await self._adapter.tickers())\r\n  File \"/home/poptimizer/poptimizer/portfolio/adapter.py\", line 16, in tickers\r\n    return tuple(pos[\"ticker\"] for pos in port[\"positions\"])\r\nKeyError: 'positions'\r\n2022-10-01 21:13:13 INF Dividends:  update is completed\r\n2022-10-01 21:13:14 INF Server:     PUT /tickers 200 OK 158b 12.3s\r\n2022-10-01 21:13:14 INF Server:     shutdown completed\r\n2022-10-01 21:13:14 INF POptimizer: shutdown completed","closed_by":{"login":"WLM1ke","id":35304528,"node_id":"MDQ6VXNlcjM1MzA0NTI4","avatar_url":"https://avatars.githubusercontent.com/u/35304528?v=4","gravatar_id":"","url":"https://api.github.com/users/WLM1ke","html_url":"https://github.com/WLM1ke","followers_url":"https://api.github.com/users/WLM1ke/followers","following_url":"https://api.github.com/users/WLM1ke/following{/other_user}","gists_url":"https://api.github.com/users/WLM1ke/gists{/gist_id}","starred_url":"https://api.github.com/users/WLM1ke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WLM1ke/subscriptions","organizations_url":"https://api.github.com/users/WLM1ke/orgs","repos_url":"https://api.github.com/users/WLM1ke/repos","events_url":"https://api.github.com/users/WLM1ke/events{/privacy}","received_events_url":"https://api.github.com/users/WLM1ke/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/WLM1ke/poptimizer/issues/112/timeline","performed_via_github_app":null,"state_reason":"completed"}