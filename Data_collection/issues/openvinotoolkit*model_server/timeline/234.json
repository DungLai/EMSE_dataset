[{"id":3333633579,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQzMzMzNjMzNTc5","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3333633579","actor":{"login":"ryanloney","id":15709723,"node_id":"MDQ6VXNlcjE1NzA5NzIz","avatar_url":"https://avatars.githubusercontent.com/u/15709723?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanloney","html_url":"https://github.com/ryanloney","followers_url":"https://api.github.com/users/ryanloney/followers","following_url":"https://api.github.com/users/ryanloney/following{/other_user}","gists_url":"https://api.github.com/users/ryanloney/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanloney/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanloney/subscriptions","organizations_url":"https://api.github.com/users/ryanloney/orgs","repos_url":"https://api.github.com/users/ryanloney/repos","events_url":"https://api.github.com/users/ryanloney/events{/privacy}","received_events_url":"https://api.github.com/users/ryanloney/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2020-05-13T19:43:51Z","assignee":{"login":"dtrawins","id":20400806,"node_id":"MDQ6VXNlcjIwNDAwODA2","avatar_url":"https://avatars.githubusercontent.com/u/20400806?v=4","gravatar_id":"","url":"https://api.github.com/users/dtrawins","html_url":"https://github.com/dtrawins","followers_url":"https://api.github.com/users/dtrawins/followers","following_url":"https://api.github.com/users/dtrawins/following{/other_user}","gists_url":"https://api.github.com/users/dtrawins/gists{/gist_id}","starred_url":"https://api.github.com/users/dtrawins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dtrawins/subscriptions","organizations_url":"https://api.github.com/users/dtrawins/orgs","repos_url":"https://api.github.com/users/dtrawins/repos","events_url":"https://api.github.com/users/dtrawins/events{/privacy}","received_events_url":"https://api.github.com/users/dtrawins/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"id":3333633588,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQzMzMzNjMzNTg4","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3333633588","actor":{"login":"ryanloney","id":15709723,"node_id":"MDQ6VXNlcjE1NzA5NzIz","avatar_url":"https://avatars.githubusercontent.com/u/15709723?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanloney","html_url":"https://github.com/ryanloney","followers_url":"https://api.github.com/users/ryanloney/followers","following_url":"https://api.github.com/users/ryanloney/following{/other_user}","gists_url":"https://api.github.com/users/ryanloney/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanloney/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanloney/subscriptions","organizations_url":"https://api.github.com/users/ryanloney/orgs","repos_url":"https://api.github.com/users/ryanloney/repos","events_url":"https://api.github.com/users/ryanloney/events{/privacy}","received_events_url":"https://api.github.com/users/ryanloney/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2020-05-13T19:43:51Z","assignee":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"id":3333636816,"node_id":"MDEyOkxhYmVsZWRFdmVudDMzMzM2MzY4MTY=","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3333636816","actor":{"login":"ryanloney","id":15709723,"node_id":"MDQ6VXNlcjE1NzA5NzIz","avatar_url":"https://avatars.githubusercontent.com/u/15709723?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanloney","html_url":"https://github.com/ryanloney","followers_url":"https://api.github.com/users/ryanloney/followers","following_url":"https://api.github.com/users/ryanloney/following{/other_user}","gists_url":"https://api.github.com/users/ryanloney/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanloney/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanloney/subscriptions","organizations_url":"https://api.github.com/users/ryanloney/orgs","repos_url":"https://api.github.com/users/ryanloney/repos","events_url":"https://api.github.com/users/ryanloney/events{/privacy}","received_events_url":"https://api.github.com/users/ryanloney/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-05-13T19:44:52Z","label":{"name":"help wanted","color":"008672"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628278252","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-628278252","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":628278252,"node_id":"MDEyOklzc3VlQ29tbWVudDYyODI3ODI1Mg==","user":{"login":"dtrawins","id":20400806,"node_id":"MDQ6VXNlcjIwNDAwODA2","avatar_url":"https://avatars.githubusercontent.com/u/20400806?v=4","gravatar_id":"","url":"https://api.github.com/users/dtrawins","html_url":"https://github.com/dtrawins","followers_url":"https://api.github.com/users/dtrawins/followers","following_url":"https://api.github.com/users/dtrawins/following{/other_user}","gists_url":"https://api.github.com/users/dtrawins/gists{/gist_id}","starred_url":"https://api.github.com/users/dtrawins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dtrawins/subscriptions","organizations_url":"https://api.github.com/users/dtrawins/orgs","repos_url":"https://api.github.com/users/dtrawins/repos","events_url":"https://api.github.com/users/dtrawins/events{/privacy}","received_events_url":"https://api.github.com/users/dtrawins/received_events","type":"User","site_admin":false},"created_at":"2020-05-13T22:27:10Z","updated_at":"2020-05-13T22:27:10Z","author_association":"COLLABORATOR","body":"@Steedance my first observation is that the plugin_config should be inside the config section for the model. Compare it with this [config](https://github.com/openvinotoolkit/model_server/blob/ams/tests/functional/config.json)\r\nWith number of streams you can balance between optimal throughput and latency. It shouldn't be higher than the number of expected parallel clients.\r\nAlso make sure configured number of grpc workers exceeds the number of nireq. It is a global setting configurable as CLI param (not in config.json) \r\nUsing streams in async mode might give similar gain in performance like using bigger batches. While you are using streams, big batches should not be needed to improve throughput.","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628278252/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dtrawins","id":20400806,"node_id":"MDQ6VXNlcjIwNDAwODA2","avatar_url":"https://avatars.githubusercontent.com/u/20400806?v=4","gravatar_id":"","url":"https://api.github.com/users/dtrawins","html_url":"https://github.com/dtrawins","followers_url":"https://api.github.com/users/dtrawins/followers","following_url":"https://api.github.com/users/dtrawins/following{/other_user}","gists_url":"https://api.github.com/users/dtrawins/gists{/gist_id}","starred_url":"https://api.github.com/users/dtrawins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dtrawins/subscriptions","organizations_url":"https://api.github.com/users/dtrawins/orgs","repos_url":"https://api.github.com/users/dtrawins/repos","events_url":"https://api.github.com/users/dtrawins/events{/privacy}","received_events_url":"https://api.github.com/users/dtrawins/received_events","type":"User","site_admin":false}},{"id":3334137317,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzMzNDEzNzMxNw==","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3334137317","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-05-13T22:27:10Z","performed_via_github_app":null},{"id":3334137319,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMzMzQxMzczMTk=","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3334137319","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-05-13T22:27:10Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628452419","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-628452419","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":628452419,"node_id":"MDEyOklzc3VlQ29tbWVudDYyODQ1MjQxOQ==","user":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"created_at":"2020-05-14T07:40:32Z","updated_at":"2020-05-14T07:40:32Z","author_association":"COLLABORATOR","body":"Hi @Steedance,\r\n\r\nI'm not sure if `CPU_THREADS_NUM` set to 32 is really helpful here. OpenVINO does not use virtual cores and from my experience setting this param to number of threads didn't improve performance. \r\n\r\nOptimal number of streams is quite big, but if you got that number from benchmark app then it's probably good for your setup. Although you are using multiple models and from my observations throughput mode works better than classic only if you can provide enough data to the model. \r\nIn case you want to use  those 6 models and have no more than 8 parallel inferences on each, you could try not setting plugin config at all (use default settings) and set `grpc_workers` parameter to 48. It should also work better if you don't have big, constant loads of data incoming. \r\n\r\nAbout that `grpc_workers` parameter. As Darek said, it's arbitrary value and should be set specifically for configuration. In your config, if you expect all models being used with full capacity (processing 8 requests each) most of the time, then setting 48 grpc_workers seems like a good idea.\r\nIf you'll for example use one model at a time, then `grpc_workers=8` might be a good fit.\r\n`grpc_workers` is defined from CLI for whole OVMS.\r\n\r\nFor performance with batches, could you provide a script you were using and how `grpc_workers` was set? ","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628452419/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false}},{"id":3335264476,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzMzNTI2NDQ3Ng==","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3335264476","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-05-14T07:40:32Z","performed_via_github_app":null},{"id":3335264480,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMzMzUyNjQ0ODA=","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3335264480","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-05-14T07:40:32Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628650695","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-628650695","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":628650695,"node_id":"MDEyOklzc3VlQ29tbWVudDYyODY1MDY5NQ==","user":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"created_at":"2020-05-14T13:52:01Z","updated_at":"2020-05-14T13:52:19Z","author_association":"NONE","body":"Thanks for the replies.\r\n\r\nI will try the suggestions when I get some time. Could one of you please give me a brief explanation on what a stream actually is?\r\nAlso I should mention that my use case is one client processing images as fast as possible, so it will be requesting inference constantly. In this case, does your (@dtrawins) comment relating to streams being no higher than expected parallel clients still stand?\r\n\r\n@mzegla,\r\n\r\nThis is the docker run command I use to launch the model server:\r\n``` sudo docker run --rm -d --net=host --env LOG_LEVEL=DEBUG --name openvino-server test:fdpd /ie-serving-py/start_server.sh ie_serving config --config_path /opt/ml/config.json --port 9001 --grpc_workers 16 ```\r\n**Note this is a test server and script so it is slightly different to my main use case** \r\nThis test server only has 1 model (person detection) and I have tried different values for ```grpc_workers``` with seemingly no difference in performance.\r\n\r\nBelow is the script I used where I noticed the performance was best with batch size of 3-5:\r\n``` import grpc\r\nimport cv2\r\nimport numpy as np\r\nimport tensorflow.contrib.util as tf_contrib_util\r\nimport time\r\nimport tensorflow as tf\r\nfrom tensorflow_serving.apis import predict_pb2\r\nfrom tensorflow_serving.apis import prediction_service_pb2_grpc\r\nfrom tensorflow_serving.apis import get_model_metadata_pb2\r\nimport threading\r\nimport random\r\n\r\ndef getInferenceData(input_data, input_name, model_outputs, modelName):\r\n    request = predict_pb2.PredictRequest()\r\n    request.model_spec.name = modelName\r\n    request.inputs[input_name].CopyFrom(tf_contrib_util.make_tensor_proto(input_data, shape=(input_data.shape)))\r\n    \r\n    response = stub.Predict(request, 30)\r\n    return response\r\n        \r\ndef imagePreparation(image, width, height):\r\n    preparedData = []\r\n    for eachImage in image:\r\n        c, h, w = 3, height, width\r\n        in_frame = cv2.resize(eachImage, (w, h))\r\n        in_frame = in_frame.transpose((2, 0, 1))\r\n        in_frame = in_frame.reshape((c, h, w))\r\n        preparedData.append(in_frame)\r\n    return np.stack(preparedData)\r\n\r\ndef detectPeople(frame, num):\r\n    print(num, \" is starting\")\r\n    response = getInferenceData(frame, 'data', 'detection_out', 'person-detection-retail-0013')\r\n    newResponse = tf.make_ndarray(response.outputs[\"detection_out\"])\r\n    print(num, \" is done\")\r\n\r\n\r\ngrpc_port = '9001'\r\ngrpc_address = '0.0.0.0'\r\nmax_message_length =  100 * 1024 * 1024\r\noptions = [('grpc.max_receive_message_length', max_message_length)]\r\nchannel = grpc.insecure_channel(\"{}:{}\".format(grpc_address, grpc_port), options=options)\r\nstub = prediction_service_pb2_grpc.PredictionServiceStub(channel)\r\n\r\ndeadFrame = np.zeros((320, 544, 3), np.uint8)\r\ndeadFrame[:] = (0, 0, 0)\r\nimg = deadFrame\r\nimg2 = deadFrame.copy()\r\npersonBatch = []\r\nmaxImages = 500\r\nbatchSize = 4\r\n\r\npersonJobs = []\r\npersonInputData = []\r\n\r\narrayOfBatchSizes = []\r\nimagesLeft = maxImages\r\ni = 0\r\nwhile imagesLeft > 0:\r\n    personBatch = []\r\n    #batchSize = random.randint(1, 10)\r\n    if batchSize > imagesLeft: batchSize = imagesLeft\r\n    imagesLeft -= batchSize\r\n    for j in range(0, batchSize):\r\n        personBatch.append(img)\r\n    personInputData.append(imagePreparation(personBatch, 544, 320))\r\n    personJobs.append(threading.Thread(target=detectPeople, args=(personInputData[i], i + 1)))\r\n\r\n    arrayOfBatchSizes.append(len(personInputData[i]))\r\n    i += 1\r\n\r\nprint(arrayOfBatchSizes, \"-\", len(arrayOfBatchSizes),\"batches\")\r\nstart = int(time.time() * 1000)\r\nprint(\"starting async\")\r\n\r\nfor j in personJobs:\r\n    j.start()\r\nfor j in personJobs:\r\n    j.join()\r\n\r\nduration = int(time.time() * 1000) - start\r\nprint(duration, \" ms\")\r\nframes = maxImages\r\nprint(frames / (duration / 1000), \"fps\") ```\r\n\r\n\r\nI appreciate the support.","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/628650695/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false}},{"id":3336717106,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzMzNjcxNzEwNg==","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3336717106","actor":{"login":"dtrawins","id":20400806,"node_id":"MDQ6VXNlcjIwNDAwODA2","avatar_url":"https://avatars.githubusercontent.com/u/20400806?v=4","gravatar_id":"","url":"https://api.github.com/users/dtrawins","html_url":"https://github.com/dtrawins","followers_url":"https://api.github.com/users/dtrawins/followers","following_url":"https://api.github.com/users/dtrawins/following{/other_user}","gists_url":"https://api.github.com/users/dtrawins/gists{/gist_id}","starred_url":"https://api.github.com/users/dtrawins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dtrawins/subscriptions","organizations_url":"https://api.github.com/users/dtrawins/orgs","repos_url":"https://api.github.com/users/dtrawins/repos","events_url":"https://api.github.com/users/dtrawins/events{/privacy}","received_events_url":"https://api.github.com/users/dtrawins/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-05-14T13:52:01Z","performed_via_github_app":null},{"id":3336717108,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMzMzY3MTcxMDg=","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3336717108","actor":{"login":"dtrawins","id":20400806,"node_id":"MDQ6VXNlcjIwNDAwODA2","avatar_url":"https://avatars.githubusercontent.com/u/20400806?v=4","gravatar_id":"","url":"https://api.github.com/users/dtrawins","html_url":"https://github.com/dtrawins","followers_url":"https://api.github.com/users/dtrawins/followers","following_url":"https://api.github.com/users/dtrawins/following{/other_user}","gists_url":"https://api.github.com/users/dtrawins/gists{/gist_id}","starred_url":"https://api.github.com/users/dtrawins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dtrawins/subscriptions","organizations_url":"https://api.github.com/users/dtrawins/orgs","repos_url":"https://api.github.com/users/dtrawins/repos","events_url":"https://api.github.com/users/dtrawins/events{/privacy}","received_events_url":"https://api.github.com/users/dtrawins/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-05-14T13:52:01Z","performed_via_github_app":null},{"id":3336717112,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzMzNjcxNzExMg==","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3336717112","actor":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-05-14T13:52:01Z","performed_via_github_app":null},{"id":3336717113,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMzMzY3MTcxMTM=","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3336717113","actor":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-05-14T13:52:01Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/629248005","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-629248005","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":629248005,"node_id":"MDEyOklzc3VlQ29tbWVudDYyOTI0ODAwNQ==","user":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"created_at":"2020-05-15T13:52:11Z","updated_at":"2020-05-15T13:52:11Z","author_association":"COLLABORATOR","body":"Ok, so from my understanding `CPU_THROUGHPUT_STREAMS` specifies number of streams i.e. groups of cores that would separately handle inference requests. So if you have 16 cores and 2 streams, then you're able to perform 2 inferences in parallel (first 8 cores will handle first request, next 8 cores will handle second request). \r\nNormally, if you don't set CPU_THORUGHPUT_STREAMS, you get one stream and all cores are handling one request (so requests are handled in sequence, one by one). When you have a lot of cores, then using all of them to handle the same request is not very effective (unless you only care about latency), so to achieve better throughput with such CPUs you can split cores into groups (streams) and make each of them handle its own request. This way you can effectively do multiple inferences at the same time. \r\nIf you decide to use multiple streams, make sure `nireq` is more or equal to the number of streams.\r\nFor your use case I encourage you to try with default settings (1 stream) , because to me it looks like you'll have trouble with providing enough data to the model to make multiple streams approach effective. From what I've observed, when model does not get enough data, using multiple streams performs worse than using single one.\r\n\r\nThis drop in performance for batch size bigger than 4 might be caused by using 8 cpu streams. \r\nPlease, try with default plugin config (1 stream) and let me know about the findings 😃 ","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/629248005/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/630203164","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-630203164","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":630203164,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDIwMzE2NA==","user":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"created_at":"2020-05-18T14:01:56Z","updated_at":"2020-05-18T14:01:56Z","author_association":"NONE","body":"Thanks mzegla. Apologies, a few more questions based on what you have said here but it's very useful for my understanding. So the way that you talk it sounds that the stream almost reserves CPU threads for use. If that is the case then using the multiple model configuration from my initial comment here how would it behave if we were making requests for different models in parallel? For example sending 8 requests to person and face detection in parallel. Would they fight for CPU threads? Would it be better to reserve a subset of the total threads for each function \r\n\r\ne.g.\r\n\r\n-  person: \"plugin_config\": {\"CPU_THROUGHPUT_STREAMS\": 4, \"CPU_THREADS_NUM\": 16}\r\n-  face: \"plugin_config\": {\"CPU_THROUGHPUT_STREAMS\": 4, \"CPU_THREADS_NUM\": 16}\r\n\r\nas opposed to always specifying the max threads = 32.\r\n\r\nAlso why do you think that I will struggle to get data to my server? The code above is just a small testing piece but we are aiming for max throughput against model server here so if there's anything I might be missing then I would love to know. We are processing many many more images than the test script above.\r\n\r\nw.r.t your final comment I ran a small number of tests on the benchmarking tool using command:\r\n`benchmark_app.py -m /opt/intel/openvino/deployment_tools/open_model_zoo/tools/downloader/intel/person-detection-retail-0013/FP32/person-detection-retail-0013.xml -nstreams 1 -t 30`\r\n\r\n\r\n![image](https://user-images.githubusercontent.com/45638338/82221412-e1370b80-9917-11ea-8037-468e4e938c8e.png)\r\n","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/630203164/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/630673874","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-630673874","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":630673874,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDY3Mzg3NA==","user":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false},"created_at":"2020-05-19T08:37:04Z","updated_at":"2020-05-19T08:37:04Z","author_association":"COLLABORATOR","body":"I'm not sure, but I believe that it's not exactly that certain model reserves some number of cores. From my experience it looks more like they're assigned dynamically. I haven't tested OVMS that way (with multiple models using multiple streams), but I think that your example:\r\n\r\n- person: \"plugin_config\": {\"CPU_THROUGHPUT_STREAMS\": 4, \"CPU_THREADS_NUM\": 16}\r\n- face: \"plugin_config\": {\"CPU_THROUGHPUT_STREAMS\": 4, \"CPU_THREADS_NUM\": 16}\r\n\r\nWould result in each model using at most 25% of all cores and that would mean you'll be having 4 streams for those two models, not 8 (4 per one). I think this plugin config takes into account all cores for each model. That's my understanding, but as I mentioned, I have not tested it myself so I might be wrong. \r\n\r\nAbout providing enough data to the server. It all depends. Depends on the model, input size etc. \r\nOVMS does not always reproduce OpenVINO performance, especially for high throughput use cases. Model server itself can be  incapable of handling certain amount of requests. \r\nWhat I mean by that is that OV might be able to perform more inferences than OVMS can process at a time. You don't see that problem when using benchmarking app (OV directly and locally).\r\nAnd for the amount of requests when model server starts to be the bottleneck, using multiple streams might be not that effective. \r\nCould you compare the results running tests on OVMS rather than OpenVINO and see if it still is better with multiple streams? Because maybe for your model it's okay.\r\n\r\nWell it seems that even benchmarking app reports worse performance for bigger batch sizes, so it might be natural for that model.","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/630673874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mzegla","id":41325006,"node_id":"MDQ6VXNlcjQxMzI1MDA2","avatar_url":"https://avatars.githubusercontent.com/u/41325006?v=4","gravatar_id":"","url":"https://api.github.com/users/mzegla","html_url":"https://github.com/mzegla","followers_url":"https://api.github.com/users/mzegla/followers","following_url":"https://api.github.com/users/mzegla/following{/other_user}","gists_url":"https://api.github.com/users/mzegla/gists{/gist_id}","starred_url":"https://api.github.com/users/mzegla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mzegla/subscriptions","organizations_url":"https://api.github.com/users/mzegla/orgs","repos_url":"https://api.github.com/users/mzegla/repos","events_url":"https://api.github.com/users/mzegla/events{/privacy}","received_events_url":"https://api.github.com/users/mzegla/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/643206148","html_url":"https://github.com/openvinotoolkit/model_server/issues/234#issuecomment-643206148","issue_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/234","id":643206148,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MzIwNjE0OA==","user":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"created_at":"2020-06-12T10:45:52Z","updated_at":"2020-06-12T10:45:52Z","author_association":"NONE","body":"Hi,  \r\nApologies for the late response. I managed to get an increased performance by using multiple clients so thanks for all of the help and information.","reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/comments/643206148/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false}},{"id":3437913629,"node_id":"MDExOkNsb3NlZEV2ZW50MzQzNzkxMzYyOQ==","url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/events/3437913629","actor":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-06-12T10:45:55Z","state_reason":null,"performed_via_github_app":null}]