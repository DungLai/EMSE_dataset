{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640","repository_url":"https://api.github.com/repos/openvinotoolkit/model_server","labels_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640/labels{/name}","comments_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640/comments","events_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640/events","html_url":"https://github.com/openvinotoolkit/model_server/issues/640","id":869014300,"node_id":"MDU6SXNzdWU4NjkwMTQzMDA=","number":640,"title":"Dynamic Batch Size and Shape in DAG Pipelines","user":{"login":"Steedance","id":45638338,"node_id":"MDQ6VXNlcjQ1NjM4MzM4","avatar_url":"https://avatars.githubusercontent.com/u/45638338?v=4","gravatar_id":"","url":"https://api.github.com/users/Steedance","html_url":"https://github.com/Steedance","followers_url":"https://api.github.com/users/Steedance/followers","following_url":"https://api.github.com/users/Steedance/following{/other_user}","gists_url":"https://api.github.com/users/Steedance/gists{/gist_id}","starred_url":"https://api.github.com/users/Steedance/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Steedance/subscriptions","organizations_url":"https://api.github.com/users/Steedance/orgs","repos_url":"https://api.github.com/users/Steedance/repos","events_url":"https://api.github.com/users/Steedance/events{/privacy}","received_events_url":"https://api.github.com/users/Steedance/received_events","type":"User","site_admin":false},"labels":[{"id":1070321725,"node_id":"MDU6TGFiZWwxMDcwMzIxNzI1","url":"https://api.github.com/repos/openvinotoolkit/model_server/labels/question","name":"question","color":"d876e3","default":true,"description":"Further information is requested"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-04-27T16:08:55Z","updated_at":"2021-06-29T07:12:43Z","closed_at":"2021-06-29T07:12:43Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nI have managed to implement a pipeline with a custom node that takes results from a face detection model and transforms the results into something an emotion detection model can use, which is great, I really like this feature.\r\n\r\nMy current client code uses batching to get more performance out of the model server and I am trying to replicate this inside the pipeline, with no success so far. For example, I would want to send 4 images into the pipeline, where the custom node would use the face detection results for each image to then output all of the faces detected across all of the images into the emotion detection model. I have not managed to get this working using a fixed nor dynamic batch size.\r\n\r\nMy first question is, is the above example possible?\r\n\r\nIf so, how can I adjust the batch size or shape of the face detection model if the DAG pipeline limits batch size when using demultiplexer nodes?\r\n\r\nMy current model server config, which works well with a single input image, is:\r\n\r\n```\r\n{\r\n   \"model_config_list\":[\r\n      {\r\n         \"config\":{\r\n            \"name\":\"face-detection-retail-0004\",\r\n            \"base_path\":\"/opt/test/face-detection-retail-0004\"\r\n         }\r\n      },\r\n      {\r\n         \"config\":{\r\n            \"name\":\"emotions-recognition-retail-0003\",\r\n            \"base_path\":\"/opt/test/emotions-recognition-retail-0003\",\r\n            \"shape\": \"(1, 3, 64, 64)\"\r\n         }\r\n      }\r\n   ],\r\n   \"custom_node_library_config_list\": [\r\n        {\r\n            \"name\": \"andyTestNode\",\r\n            \"base_path\": \"/opt/test/lib/libcustom_node_andyTest.so\"\r\n        }\r\n    ],\r\n   \"pipeline_config_list\": [\r\n      {\r\n        \"name\": \"fullFace\",\r\n        \"inputs\": [\"image\", \"fullSizeImage\"],\r\n        \"nodes\": [\r\n            {\r\n                \"name\": \"faceDetection\",\r\n                \"model_name\": \"face-detection-retail-0004\",\r\n                \"version\": 2,\r\n                \"type\": \"DL model\",\r\n                \"inputs\": [\r\n                    {\"data\": {\"node_name\": \"request\",\r\n                               \"data_item\": \"image\"}}\r\n                ], \r\n                \"outputs\": [\r\n                    {\"data_item\": \"detection_out\",\r\n                     \"alias\": \"faceDetections\"}\r\n                ]\r\n            },\r\n            {\r\n                \"name\": \"customNode\",\r\n                \"library_name\": \"andyTestNode\",\r\n                \"type\": \"custom\",\r\n                \"demultiply_count\": 0,\r\n                \"params\": {\r\n                    \"original_image_width\": \"640\",\r\n                    \"original_image_height\": \"480\",\r\n                    \"target_image_width\": \"64\",\r\n                    \"target_image_height\": \"64\",\r\n                    \"debug\": \"true\",\r\n                    \"imOutputDir\": \"/home/ovms\"\r\n                },\r\n                \"inputs\": [\r\n                    {\"image\": {\"node_name\": \"request\",\r\n                               \"data_item\": \"image\"}},\r\n                    {\"faceDetections\": {\"node_name\": \"faceDetection\",\r\n                                \"data_item\": \"faceDetections\"}},\r\n                    {\"fullSizeImage\": {\"node_name\": \"request\",\r\n                                \"data_item\": \"fullSizeImage\"}}\r\n                ],\r\n                \"outputs\": [\r\n                    {\"data_item\": \"faceImages\",\r\n                     \"alias\": \"faces\"},\r\n                    {\"data_item\": \"formattedFaceDetections\",\r\n                     \"alias\": \"faceDetections\"}\r\n                ]\r\n            },\r\n            {\r\n                \"name\": \"emotions\",\r\n                \"model_name\": \"emotions-recognition-retail-0003\",\r\n                \"type\": \"DL model\",\r\n                \"inputs\": [\r\n                    {\"data\": {\"node_name\": \"customNode\",\r\n                               \"data_item\": \"faces\"}}\r\n                ], \r\n                \"outputs\": [\r\n                    {\"data_item\": \"prob_emotion\",\r\n                     \"alias\": \"emotion\"}\r\n                ]\r\n            }\r\n        ],\r\n        \"outputs\": [\r\n            {\"boundingBoxes\": {\"node_name\": \"customNode\",\r\n                       \"data_item\": \"faceDetections\"}},\r\n            {\"faces\": {\"node_name\": \"customNode\",\r\n                       \"data_item\": \"faces\"}},\r\n            {\"emotion\": {\"node_name\": \"emotions\",\r\n                       \"data_item\": \"emotion\"}}\r\n        ]\r\n      }\r\n   ]\r\n}\r\n\r\n```\r\n\r\nTrying to change the batch size or shape of the face detection model produces errors, adding \"shape\": \"auto\" gives a shape forbidden error and adding \"shape\": \"(2, 3, 300, 300)\" gives the error:\r\n```\r\n[modelmanager][error][pipelinedefinition.cpp:361] Pipeline: fullFace, node: faceDetection, inputName: data, inputShape: (2,3,300,300). Batch size >= 2 is not allowed for non gathering nodes\r\n```\r\n\r\nAny help on how to set up the model server config would be appreciated.\r\n\r\nAndy","closed_by":{"login":"rasapala","id":58549742,"node_id":"MDQ6VXNlcjU4NTQ5NzQy","avatar_url":"https://avatars.githubusercontent.com/u/58549742?v=4","gravatar_id":"","url":"https://api.github.com/users/rasapala","html_url":"https://github.com/rasapala","followers_url":"https://api.github.com/users/rasapala/followers","following_url":"https://api.github.com/users/rasapala/following{/other_user}","gists_url":"https://api.github.com/users/rasapala/gists{/gist_id}","starred_url":"https://api.github.com/users/rasapala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rasapala/subscriptions","organizations_url":"https://api.github.com/users/rasapala/orgs","repos_url":"https://api.github.com/users/rasapala/repos","events_url":"https://api.github.com/users/rasapala/events{/privacy}","received_events_url":"https://api.github.com/users/rasapala/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/openvinotoolkit/model_server/issues/640/timeline","performed_via_github_app":null,"state_reason":"completed"}