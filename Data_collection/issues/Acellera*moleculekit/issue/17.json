{"url":"https://api.github.com/repos/Acellera/moleculekit/issues/17","repository_url":"https://api.github.com/repos/Acellera/moleculekit","labels_url":"https://api.github.com/repos/Acellera/moleculekit/issues/17/labels{/name}","comments_url":"https://api.github.com/repos/Acellera/moleculekit/issues/17/comments","events_url":"https://api.github.com/repos/Acellera/moleculekit/issues/17/events","html_url":"https://github.com/Acellera/moleculekit/issues/17","id":464888392,"node_id":"MDU6SXNzdWU0NjQ4ODgzOTI=","number":17,"title":"Error with getVoxelDescriptors: protein has less bonds than atoms","user":{"login":"larry0x","id":26318510,"node_id":"MDQ6VXNlcjI2MzE4NTEw","avatar_url":"https://avatars.githubusercontent.com/u/26318510?v=4","gravatar_id":"","url":"https://api.github.com/users/larry0x","html_url":"https://github.com/larry0x","followers_url":"https://api.github.com/users/larry0x/followers","following_url":"https://api.github.com/users/larry0x/following{/other_user}","gists_url":"https://api.github.com/users/larry0x/gists{/gist_id}","starred_url":"https://api.github.com/users/larry0x/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/larry0x/subscriptions","organizations_url":"https://api.github.com/users/larry0x/orgs","repos_url":"https://api.github.com/users/larry0x/repos","events_url":"https://api.github.com/users/larry0x/events{/privacy}","received_events_url":"https://api.github.com/users/larry0x/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-07-06T20:33:32Z","updated_at":"2019-07-19T15:25:32Z","closed_at":"2019-07-15T08:47:03Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nI am trying to generate voxel descriptors for some peptide segments. If I use the `mol.filter()` method to select a segment in a protein then generate voxel descriptors, I get the following error. If I do not do the filtering, the code works fine without error.\r\n\r\n```python\r\nfrom moleculekit.molecule import Molecule\r\nfrom moleculekit.tools.atomtyper import prepareProteinForAtomtyping\r\nfrom moleculekit.tools.voxeldescriptors import getVoxelDescriptors\r\n\r\nmol = Molecule(\"1h8d\")\r\nmol.filter(\"protein\")\r\nmol.filter(\"chain H and resid 16 to 21\")  # If I comment this line, the code works fine!\r\nmol = prepareProteinForAtomtyping(mol)\r\nmol.center()\r\nfeatures, _, _ = getVoxelDescriptors(mol,\r\n                                     boxsize=(32., 32., 32.),\r\n                                     voxelsize=1.,\r\n                                     center=(0., 0., 0.))\r\nfeatures = features.reshape(32, 32, 32, 8)\r\n```\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-5-7702ebcfca0a> in <module>\r\n     11                               boxsize=(32., 32., 32.),\r\n     12                               voxelsize=1.,\r\n---> 13                               center=(0., 0., 0.))\r\n     14 v = v.reshape(32, 32, 32, 8)\r\n\r\n~/.conda/envs/test-env/lib/python3.6/site-packages/moleculekit/tools/voxeldescriptors.py in getVoxelDescriptors(mol, boxsize, voxelsize, buffer, center, usercenters, userchannels, usercoords, aromaticNitrogen, method, version, validitychecks)\r\n    193     channels = userchannels\r\n    194     if channels is None:\r\n--> 195         channels, mol = getChannels(mol, aromaticNitrogen, version, validitychecks)\r\n    196 \r\n    197     if channels.dtype == bool:\r\n\r\n~/.conda/envs/test-env/lib/python3.6/site-packages/moleculekit/tools/voxeldescriptors.py in getChannels(mol, aromaticNitrogen, version, validitychecks)\r\n     83         elif version == 2:\r\n     84             from moleculekit.tools.atomtyper import getFeatures, getPDBQTAtomTypesAndCharges\r\n---> 85             mol.atomtype, mol.charge = getPDBQTAtomTypesAndCharges(mol, aromaticNitrogen=aromaticNitrogen, validitychecks=validitychecks)\r\n     86             channels = getFeatures(mol)\r\n     87 \r\n\r\n~/.conda/envs/test-env/lib/python3.6/site-packages/moleculekit/tools/atomtyper.py in getPDBQTAtomTypesAndCharges(mol, aromaticNitrogen, validitychecks)\r\n    160 def getPDBQTAtomTypesAndCharges(mol, aromaticNitrogen=False, validitychecks=True):\r\n    161     if validitychecks:\r\n--> 162         atomtypingValidityChecks(mol)\r\n    163 \r\n    164     atomsProp = getProperties(mol)\r\n\r\n~/.conda/envs/test-env/lib/python3.6/site-packages/moleculekit/tools/atomtyper.py in atomtypingValidityChecks(mol)\r\n    139 \r\n    140     if mol.bonds.shape[0] < mol.numAtoms:\r\n--> 141         raise ValueError('The protein has less bonds than atoms. This seems incorrect. Assign them with `mol.bonds = mol._getBonds()`')\r\n    142 \r\n    143     if np.all(mol.segid == '') or np.all(mol.chain == ''):\r\n\r\nValueError: The protein has less bonds than atoms. This seems incorrect. Assign them with `mol.bonds = mol._getBonds()`\r\n```\r\n\r\nInterestingly, I found that a workaround is to save the filtered segment and load it again:\r\n\r\n```python\r\nmol = Molecule(\"1h8d\")\r\nmol.filter(\"protein\")\r\nmol.filter(\"chain H and resid 16 to 21\")\r\nmol = prepareProteinForAtomtyping(mol)\r\nmol.center()\r\n# Save the Molecule object to file...\r\nmol.write(\"test.pdb\")\r\n# ...and load it again\r\nmol = Molecule(\"test.pdb\")\r\n# Then it works fine without error!\r\nfeatures, _, _ = getVoxelDescriptors(mol,\r\n                                     boxsize=(32., 32., 32.),\r\n                                     voxelsize=1.,\r\n                                     center=(0., 0., 0.))\r\nfeatures = features.reshape(32, 32, 32, 8)\r\n```\r\n\r\nAny idea? Thanks.","closed_by":{"login":"stefdoerr","id":7935362,"node_id":"MDQ6VXNlcjc5MzUzNjI=","avatar_url":"https://avatars.githubusercontent.com/u/7935362?v=4","gravatar_id":"","url":"https://api.github.com/users/stefdoerr","html_url":"https://github.com/stefdoerr","followers_url":"https://api.github.com/users/stefdoerr/followers","following_url":"https://api.github.com/users/stefdoerr/following{/other_user}","gists_url":"https://api.github.com/users/stefdoerr/gists{/gist_id}","starred_url":"https://api.github.com/users/stefdoerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stefdoerr/subscriptions","organizations_url":"https://api.github.com/users/stefdoerr/orgs","repos_url":"https://api.github.com/users/stefdoerr/repos","events_url":"https://api.github.com/users/stefdoerr/events{/privacy}","received_events_url":"https://api.github.com/users/stefdoerr/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Acellera/moleculekit/issues/17/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Acellera/moleculekit/issues/17/timeline","performed_via_github_app":null,"state_reason":"completed"}