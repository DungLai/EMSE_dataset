{"url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24","repository_url":"https://api.github.com/repos/adambielski/siamese-triplet","labels_url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24/labels{/name}","comments_url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24/comments","events_url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24/events","html_url":"https://github.com/adambielski/siamese-triplet/issues/24","id":401402487,"node_id":"MDU6SXNzdWU0MDE0MDI0ODc=","number":24,"title":"Semi-hard triplet loss implementation","user":{"login":"WrathOfGrapes","id":11215039,"node_id":"MDQ6VXNlcjExMjE1MDM5","avatar_url":"https://avatars.githubusercontent.com/u/11215039?v=4","gravatar_id":"","url":"https://api.github.com/users/WrathOfGrapes","html_url":"https://github.com/WrathOfGrapes","followers_url":"https://api.github.com/users/WrathOfGrapes/followers","following_url":"https://api.github.com/users/WrathOfGrapes/following{/other_user}","gists_url":"https://api.github.com/users/WrathOfGrapes/gists{/gist_id}","starred_url":"https://api.github.com/users/WrathOfGrapes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WrathOfGrapes/subscriptions","organizations_url":"https://api.github.com/users/WrathOfGrapes/orgs","repos_url":"https://api.github.com/users/WrathOfGrapes/repos","events_url":"https://api.github.com/users/WrathOfGrapes/events{/privacy}","received_events_url":"https://api.github.com/users/WrathOfGrapes/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-01-21T15:28:30Z","updated_at":"2019-09-26T18:35:46Z","closed_at":"2019-01-22T08:16:27Z","author_association":"NONE","active_lock_reason":null,"body":"Excuse me, if I'm wrong, but i believe there is a minor mistake in your semi-hard negative selector:\r\n\r\n```\r\ndef semihard_negative(loss_values, margin):\r\n    semihard_negatives = np.where(np.logical_and(loss_values < margin, loss_values > 0))[0]\r\nreturn np.random.choice(semihard_negatives) if len(semihard_negatives) > 0 else None\r\n```\r\nIn the FaceNet paper it says that \r\n\r\n> We call these negative exemplars semi-hard , as they are further away from the anchor than the positive exemplar, but still hard because the squared distance is close to the anchorpositive distance. Those negatives lie inside the margin α\r\n\r\nConsidering that `loss_values` is computed as `ap_distance - distance_matrix[torch.LongTensor(np.array([anchor_positive[0]])), torch.LongTensor(negative_indices)] + self.margin`, you want the |f(x_a) - f(x_p)| - |f(x_a) - f(x_n)| to lie on segment [α, 2α], instead of lying on the interval [-α, \\inf].\r\n\r\n\r\n**Briefly put**: i believe that the function should be defined this way:\r\n```\r\ndef semihard_negative(loss_values, margin):\r\n    semihard_negatives = np.where(loss_values > 0)[0]\r\nreturn np.random.choice(semihard_negatives) if len(semihard_negatives) > 0 else None\r\n```","closed_by":{"login":"WrathOfGrapes","id":11215039,"node_id":"MDQ6VXNlcjExMjE1MDM5","avatar_url":"https://avatars.githubusercontent.com/u/11215039?v=4","gravatar_id":"","url":"https://api.github.com/users/WrathOfGrapes","html_url":"https://github.com/WrathOfGrapes","followers_url":"https://api.github.com/users/WrathOfGrapes/followers","following_url":"https://api.github.com/users/WrathOfGrapes/following{/other_user}","gists_url":"https://api.github.com/users/WrathOfGrapes/gists{/gist_id}","starred_url":"https://api.github.com/users/WrathOfGrapes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WrathOfGrapes/subscriptions","organizations_url":"https://api.github.com/users/WrathOfGrapes/orgs","repos_url":"https://api.github.com/users/WrathOfGrapes/repos","events_url":"https://api.github.com/users/WrathOfGrapes/events{/privacy}","received_events_url":"https://api.github.com/users/WrathOfGrapes/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/adambielski/siamese-triplet/issues/24/timeline","performed_via_github_app":null,"state_reason":"completed"}