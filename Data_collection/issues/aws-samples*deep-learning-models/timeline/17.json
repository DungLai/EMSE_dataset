[{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635411962","html_url":"https://github.com/aws-samples/deep-learning-models/issues/17#issuecomment-635411962","issue_url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/17","id":635411962,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNTQxMTk2Mg==","user":{"login":"jarednielsen","id":4564897,"node_id":"MDQ6VXNlcjQ1NjQ4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4564897?v=4","gravatar_id":"","url":"https://api.github.com/users/jarednielsen","html_url":"https://github.com/jarednielsen","followers_url":"https://api.github.com/users/jarednielsen/followers","following_url":"https://api.github.com/users/jarednielsen/following{/other_user}","gists_url":"https://api.github.com/users/jarednielsen/gists{/gist_id}","starred_url":"https://api.github.com/users/jarednielsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jarednielsen/subscriptions","organizations_url":"https://api.github.com/users/jarednielsen/orgs","repos_url":"https://api.github.com/users/jarednielsen/repos","events_url":"https://api.github.com/users/jarednielsen/events{/privacy}","received_events_url":"https://api.github.com/users/jarednielsen/received_events","type":"User","site_admin":false},"created_at":"2020-05-28T15:12:23Z","updated_at":"2020-05-28T15:12:23Z","author_association":"CONTRIBUTOR","body":"Hi @008karan, thanks for stopping by! The original paper uses a global batch size of 4096, so to achieve that you'll need to use either gradient accumulation (`--gradient_accumulation_steps`) or scale out to more nodes. We also found that 64 is the largest per-gpu batch size that fits within V100 memory on albert-base with sequence length 512. \r\n\r\nCompare this to bert-base, [which can fit only batch size 6](https://github.com/google-research/bert#out-of-memory-issues) into memory with sequence length 512.\r\n\r\nWhat command-line flags are you using to launch training?","reactions":{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635411962/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jarednielsen","id":4564897,"node_id":"MDQ6VXNlcjQ1NjQ4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4564897?v=4","gravatar_id":"","url":"https://api.github.com/users/jarednielsen","html_url":"https://github.com/jarednielsen","followers_url":"https://api.github.com/users/jarednielsen/followers","following_url":"https://api.github.com/users/jarednielsen/following{/other_user}","gists_url":"https://api.github.com/users/jarednielsen/gists{/gist_id}","starred_url":"https://api.github.com/users/jarednielsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jarednielsen/subscriptions","organizations_url":"https://api.github.com/users/jarednielsen/orgs","repos_url":"https://api.github.com/users/jarednielsen/repos","events_url":"https://api.github.com/users/jarednielsen/events{/privacy}","received_events_url":"https://api.github.com/users/jarednielsen/received_events","type":"User","site_admin":false}},{"id":3383289468,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzM4MzI4OTQ2OA==","url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/events/3383289468","actor":{"login":"008karan","id":18630864,"node_id":"MDQ6VXNlcjE4NjMwODY0","avatar_url":"https://avatars.githubusercontent.com/u/18630864?v=4","gravatar_id":"","url":"https://api.github.com/users/008karan","html_url":"https://github.com/008karan","followers_url":"https://api.github.com/users/008karan/followers","following_url":"https://api.github.com/users/008karan/following{/other_user}","gists_url":"https://api.github.com/users/008karan/gists{/gist_id}","starred_url":"https://api.github.com/users/008karan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/008karan/subscriptions","organizations_url":"https://api.github.com/users/008karan/orgs","repos_url":"https://api.github.com/users/008karan/repos","events_url":"https://api.github.com/users/008karan/events{/privacy}","received_events_url":"https://api.github.com/users/008karan/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-05-28T15:12:23Z","performed_via_github_app":null},{"id":3383289475,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMzODMyODk0NzU=","url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/events/3383289475","actor":{"login":"008karan","id":18630864,"node_id":"MDQ6VXNlcjE4NjMwODY0","avatar_url":"https://avatars.githubusercontent.com/u/18630864?v=4","gravatar_id":"","url":"https://api.github.com/users/008karan","html_url":"https://github.com/008karan","followers_url":"https://api.github.com/users/008karan/followers","following_url":"https://api.github.com/users/008karan/following{/other_user}","gists_url":"https://api.github.com/users/008karan/gists{/gist_id}","starred_url":"https://api.github.com/users/008karan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/008karan/subscriptions","organizations_url":"https://api.github.com/users/008karan/orgs","repos_url":"https://api.github.com/users/008karan/repos","events_url":"https://api.github.com/users/008karan/events{/privacy}","received_events_url":"https://api.github.com/users/008karan/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-05-28T15:12:23Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635420160","html_url":"https://github.com/aws-samples/deep-learning-models/issues/17#issuecomment-635420160","issue_url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/17","id":635420160,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNTQyMDE2MA==","user":{"login":"008karan","id":18630864,"node_id":"MDQ6VXNlcjE4NjMwODY0","avatar_url":"https://avatars.githubusercontent.com/u/18630864?v=4","gravatar_id":"","url":"https://api.github.com/users/008karan","html_url":"https://github.com/008karan","followers_url":"https://api.github.com/users/008karan/followers","following_url":"https://api.github.com/users/008karan/following{/other_user}","gists_url":"https://api.github.com/users/008karan/gists{/gist_id}","starred_url":"https://api.github.com/users/008karan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/008karan/subscriptions","organizations_url":"https://api.github.com/users/008karan/orgs","repos_url":"https://api.github.com/users/008karan/repos","events_url":"https://api.github.com/users/008karan/events{/privacy}","received_events_url":"https://api.github.com/users/008karan/received_events","type":"User","site_admin":false},"created_at":"2020-05-28T15:27:12Z","updated_at":"2020-05-28T15:27:12Z","author_association":"NONE","body":"I used the new trainer functionality as of now.\r\n```\r\ntraining_args = TrainingArguments(\r\n    output_dir=\"albert_model\",\r\n    overwrite_output_dir=True,\r\n    num_train_epochs=1,\r\n    per_gpu_train_batch_size=128,\r\n    learning_rate=5e-5,\r\n    save_steps=5000,\r\n    save_total_limit=20,\r\n    do_train=True,\r\n    logging_steps=100\r\n\r\n)\r\n\r\ntrainer = Trainer(\r\n    model=model,\r\n    args=training_args,\r\n    data_collator=data_collator,\r\n    train_dataset=dataset,\r\n    prediction_loss_only=True,\r\n)\r\n``` \r\n But GPU utilisation is around 50% and getting only 85 batch size on this system and above this OOM.\r\n```\r\n+-----------------------------------------------------------------------------+\r\n| NVIDIA-SMI 440.33.01    Driver Version: 440.33.01    CUDA Version: 10.2     |\r\n|-------------------------------+----------------------+----------------------+\r\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\r\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\r\n|===============================+======================+======================|\r\n|   0  Tesla V100-SXM2...  On   | 00000000:00:16.0 Off |                    0 |\r\n| N/A   77C    P0   291W / 300W |  30931MiB / 32510MiB |    100%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   1  Tesla V100-SXM2...  On   | 00000000:00:17.0 Off |                    0 |\r\n| N/A   71C    P0   255W / 300W |  18963MiB / 32510MiB |    100%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   2  Tesla V100-SXM2...  On   | 00000000:00:18.0 Off |                    0 |\r\n| N/A   71C    P0    95W / 300W |  18963MiB / 32510MiB |     98%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   3  Tesla V100-SXM2...  On   | 00000000:00:19.0 Off |                    0 |\r\n| N/A   68C    P0    89W / 300W |  18963MiB / 32510MiB |     72%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   4  Tesla V100-SXM2...  On   | 00000000:00:1A.0 Off |                    0 |\r\n| N/A   68C    P0    78W / 300W |  18963MiB / 32510MiB |    100%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   5  Tesla V100-SXM2...  On   | 00000000:00:1B.0 Off |                    0 |\r\n| N/A   69C    P0    96W / 300W |  18963MiB / 32510MiB |     65%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   6  Tesla V100-SXM2...  On   | 00000000:00:1C.0 Off |                    0 |\r\n| N/A   69C    P0    79W / 300W |  18963MiB / 32510MiB |     95%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n|   7  Tesla V100-SXM2...  On   | 00000000:00:1D.0 Off |                    0 |\r\n| N/A   74C    P0    80W / 300W |  18963MiB / 32510MiB |     12%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n\r\n```\r\n\r\nI tried distributed training also using python -m torch.distributed.launch --nproc_per_node 8 test_lm.py but It started new job for each and every GPU.\r\n```\r\nSetting OMP_NUM_THREADS environment variable for each process to be 1 in default, to avoid your system being overloaded, please further tune the variable for optimal performance in your application as needed. \r\n*****************************************\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\nCalling AlbertTokenizer.from_pretrained() with the path to a single file or url is deprecated\r\n/language_model/lm/lib/python3.6/site-packages/transformers/tokenization_utils.py:830: FutureWarning: Parameter max_len is deprecated and will be removed in a future release. Use model_max_length instead.\r\n  category=FutureWarning,\r\n```\r\ncan you suggest what should I do?","reactions":{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635420160/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"008karan","id":18630864,"node_id":"MDQ6VXNlcjE4NjMwODY0","avatar_url":"https://avatars.githubusercontent.com/u/18630864?v=4","gravatar_id":"","url":"https://api.github.com/users/008karan","html_url":"https://github.com/008karan","followers_url":"https://api.github.com/users/008karan/followers","following_url":"https://api.github.com/users/008karan/following{/other_user}","gists_url":"https://api.github.com/users/008karan/gists{/gist_id}","starred_url":"https://api.github.com/users/008karan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/008karan/subscriptions","organizations_url":"https://api.github.com/users/008karan/orgs","repos_url":"https://api.github.com/users/008karan/repos","events_url":"https://api.github.com/users/008karan/events{/privacy}","received_events_url":"https://api.github.com/users/008karan/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635435220","html_url":"https://github.com/aws-samples/deep-learning-models/issues/17#issuecomment-635435220","issue_url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/17","id":635435220,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNTQzNTIyMA==","user":{"login":"jarednielsen","id":4564897,"node_id":"MDQ6VXNlcjQ1NjQ4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4564897?v=4","gravatar_id":"","url":"https://api.github.com/users/jarednielsen","html_url":"https://github.com/jarednielsen","followers_url":"https://api.github.com/users/jarednielsen/followers","following_url":"https://api.github.com/users/jarednielsen/following{/other_user}","gists_url":"https://api.github.com/users/jarednielsen/gists{/gist_id}","starred_url":"https://api.github.com/users/jarednielsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jarednielsen/subscriptions","organizations_url":"https://api.github.com/users/jarednielsen/orgs","repos_url":"https://api.github.com/users/jarednielsen/repos","events_url":"https://api.github.com/users/jarednielsen/events{/privacy}","received_events_url":"https://api.github.com/users/jarednielsen/received_events","type":"User","site_admin":false},"created_at":"2020-05-28T15:53:41Z","updated_at":"2020-05-28T15:53:41Z","author_association":"CONTRIBUTOR","body":"Tough to say, since our implementation here is focused on TensorFlow 2. From reading through https://pytorch.org/docs/stable/distributed.html, you might want to try:\r\n- `torch.distributed.init_process_group(...)`\r\n- Environment variable initialization\r\n- Using `torch.distributed.allreduce(...)` in your training script.\r\n\r\nIt looks like `Trainer` natively supports either single-GPU training or distributed TPU training. Could be wrong there, haven't dived into the details.","reactions":{"url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/comments/635435220/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jarednielsen","id":4564897,"node_id":"MDQ6VXNlcjQ1NjQ4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4564897?v=4","gravatar_id":"","url":"https://api.github.com/users/jarednielsen","html_url":"https://github.com/jarednielsen","followers_url":"https://api.github.com/users/jarednielsen/followers","following_url":"https://api.github.com/users/jarednielsen/following{/other_user}","gists_url":"https://api.github.com/users/jarednielsen/gists{/gist_id}","starred_url":"https://api.github.com/users/jarednielsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jarednielsen/subscriptions","organizations_url":"https://api.github.com/users/jarednielsen/orgs","repos_url":"https://api.github.com/users/jarednielsen/repos","events_url":"https://api.github.com/users/jarednielsen/events{/privacy}","received_events_url":"https://api.github.com/users/jarednielsen/received_events","type":"User","site_admin":false}},{"id":3922840610,"node_id":"MDExOkNsb3NlZEV2ZW50MzkyMjg0MDYxMA==","url":"https://api.github.com/repos/aws-samples/deep-learning-models/issues/events/3922840610","actor":{"login":"jarednielsen","id":4564897,"node_id":"MDQ6VXNlcjQ1NjQ4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4564897?v=4","gravatar_id":"","url":"https://api.github.com/users/jarednielsen","html_url":"https://github.com/jarednielsen","followers_url":"https://api.github.com/users/jarednielsen/followers","following_url":"https://api.github.com/users/jarednielsen/following{/other_user}","gists_url":"https://api.github.com/users/jarednielsen/gists{/gist_id}","starred_url":"https://api.github.com/users/jarednielsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jarednielsen/subscriptions","organizations_url":"https://api.github.com/users/jarednielsen/orgs","repos_url":"https://api.github.com/users/jarednielsen/repos","events_url":"https://api.github.com/users/jarednielsen/events{/privacy}","received_events_url":"https://api.github.com/users/jarednielsen/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-10-26T21:11:20Z","state_reason":null,"performed_via_github_app":null}]