{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59","repository_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt","labels_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59/labels{/name}","comments_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59/comments","events_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59/events","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/59","id":852014189,"node_id":"MDU6SXNzdWU4NTIwMTQxODk=","number":59,"title":"Dice Loss/Score question","user":{"login":"JanSobus","id":17416468,"node_id":"MDQ6VXNlcjE3NDE2NDY4","avatar_url":"https://avatars.githubusercontent.com/u/17416468?v=4","gravatar_id":"","url":"https://api.github.com/users/JanSobus","html_url":"https://github.com/JanSobus","followers_url":"https://api.github.com/users/JanSobus/followers","following_url":"https://api.github.com/users/JanSobus/following{/other_user}","gists_url":"https://api.github.com/users/JanSobus/gists{/gist_id}","starred_url":"https://api.github.com/users/JanSobus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JanSobus/subscriptions","organizations_url":"https://api.github.com/users/JanSobus/orgs","repos_url":"https://api.github.com/users/JanSobus/repos","events_url":"https://api.github.com/users/JanSobus/events{/privacy}","received_events_url":"https://api.github.com/users/JanSobus/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-04-07T05:15:42Z","updated_at":"2022-10-20T20:19:49Z","closed_at":"2022-10-20T20:19:49Z","author_association":"NONE","active_lock_reason":null,"body":"Hey Eugene,\r\n\r\nFirst of all, thank you for this very useful package. I'm transferring my environment from TF to Pytorch now and having your advanced losses is very helpful. However, when I trained the same model on the same data using same loss functions in both frameworks, I noticed that I get very different loss numbers (I'm using multilabel approach). Digging a little deeper in your code I noticed that when you calculate the Dice Loss you always calculate per sample AND per channel loss and then average it. I don't understand why are you doing the per channel calculation ad averaging, and not the Dice loss for all classes together. I can show What I mean on a dummy example below:\r\n\r\nLet's prepare 2 dummy multilabel matrices - ground truth (d_gt) and prediction (d_pr) with 3 classes each, 0 Red, 1 Green and 2 Blue:\r\n`d_gt = np.zeros(shape=(20,20,3))`\r\n`d_gt[5:10,5:10,0] =1`\r\n`d_gt[10:15,10:15,1] =1`\r\n`d_gt[:,:,2] = (1 - d_gt.sum(axis=-1, keepdims=True)).squeeze()`\r\n`plt.imshow(d_gt)`\r\n \r\n![image](https://user-images.githubusercontent.com/17416468/113812273-2888ed80-97b1-11eb-84a7-517001ef64a3.png)\r\n\r\n`d_pr = np.zeros(shape=(20,20,3))`\r\n`d_pr[4:9,4:9,0] =1`\r\n`d_pr[11:14,11:14,1] =1`\r\n`d_pr[:,:,2] = (1 - d_pr.sum(axis=-1, keepdims=True)).squeeze()`\r\n`plt.imshow(d_pr)`\r\n\r\n![image](https://user-images.githubusercontent.com/17416468/113812328-40f90800-97b1-11eb-88c5-227732c53514.png)\r\n\r\nOne can see that (using Dice Loss = 1- Dice Score):\r\n\r\n-  Dice Loss for Red is 1- ((16+ 16) / (25+ 25))  = 0.36\r\n-  Dice Loss for Green is 1 - ((9+9)/(9+25) = 0.4706\r\n-  Dice Loss for Blue is 1 - ((341+341)/(350+366)) = 0.0474\r\n\r\nHowever, total Dice Loss for the whole picture is 1 - (2*(16+9+341)/(2*400) = 0.085\r\n\r\nAfter wrapping them into tensors\r\n`d_gt_tensor = torch.from_numpy(np.transpose(d_gt,(2,0,1))).unsqueeze(0)`\r\n`d_pr_tensor = torch.from_numpy(np.transpose(d_pr,(2,0,1))).unsqueeze(0)`\r\nwhat your Dice Loss (with from_logits=False) is returning is 0.2927 which is the averaged loss of individual channels instead of the total loss. The culprit seems to be passing dims=(0,2) to the soft_dice_score function, I think that dims=(1,2) should be passed instead to get individual scores for each item in the batch? Unless this behaviour is intended but then I'd need some more explanation why. \r\n\r\nSecond smaller question regrading your Dice Loss is why you use from_logits= True by default? \r\n\r\nThanks in advance!  \r\n ","closed_by":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/59/timeline","performed_via_github_app":null,"state_reason":"completed"}