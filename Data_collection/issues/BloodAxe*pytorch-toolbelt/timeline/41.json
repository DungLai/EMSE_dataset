[{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/591819741","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/41#issuecomment-591819741","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/41","id":591819741,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MTgxOTc0MQ==","user":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false},"created_at":"2020-02-27T07:15:18Z","updated_at":"2020-02-27T07:15:18Z","author_association":"OWNER","body":"The code looks pretty much legit from my point of view. I don’t see any\nissues with it straight away.\nBut there are a few things you can check:\n1) is model in eval mode and code is executing in torch.no_grad() scope?\n2) I see you are using it inside notebook. Maybe there is some dangling\npointers to cuda tensor a are left somewhere that prevents freeing unused\ncuda memory?\n3) what’s is the actual GPU memory utilization before doing the inference?\n\nчт, 27 февр. 2020 г. в 8:25 AM, Инсаф Ашрапов <notifications@github.com>:\n\n> I have tried pretty small slices but get cuda out of memory on ---> 23\n> pred_batch = best_model(tiles_batch)[:, 0:1, :,:] As I can see it finally\n> preceded few steps but failed\n> :\n>\n> import numpy as np\n> import torch\n> import cv2\n> from tqdm import tqdm_notebook\n> from pytorch_toolbelt.inference.tiles import ImageSlicer, CudaTileMerger\n> from pytorch_toolbelt.utils.torch_utils import tensor_from_rgb_image, to_numpy\n>\n>\n> image = img_to_predict\n>\n> # Cut large image into overlapping tiles\n> tiler = ImageSlicer(image.shape, tile_size=(64, 64), tile_step=(64, 64), weight='pyramid')\n>\n> # HCW -> CHW. Optionally, do normalization here\n> tiles = [tensor_from_rgb_image(tile) for tile in tiler.split(image)]\n>\n> # Allocate a CUDA buffer for holding entire mask\n> merger = CudaTileMerger(tiler.target_shape, 1, tiler.weight)\n>\n> # Run predictions for tiles and accumulate them\n> for tiles_batch, coords_batch in tqdm_notebook(DataLoader(list(zip(tiles, tiler.crops)), batch_size=1, pin_memory=True)):\n>     tiles_batch = tiles_batch.float().cuda()\n>     pred_batch = best_model(tiles_batch)[:, 0:1, :,:] # taking only first channel\n>\n>     merger.integrate_batch(pred_batch, coords_batch)\n>\n> # Normalize accumulated mask and convert back to numpy\n> merged_mask = np.moveaxis(to_numpy(merger.merge()), 0, -1).astype(np.uint8)\n> merged_mask = tiler.crop_to_orignal_size(merged_mask)\n>\n> —\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/BloodAxe/pytorch-toolbelt/issues/41?email_source=notifications&email_token=AAEB6YESFRKCXVN2DCEV2PTRE5MGLA5CNFSM4K4UTQM2YY3PNVWWK3TUL52HS4DFUVEXG43VMWVGG33NNVSW45C7NFSM4IQVYRGA>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAEB6YEFYL3KT4J4OJBDXYTRE5MGLANCNFSM4K4UTQMQ>\n> .\n>\n","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/591819741/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/592112098","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/41#issuecomment-592112098","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/41","id":592112098,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjExMjA5OA==","user":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false},"created_at":"2020-02-27T18:37:39Z","updated_at":"2020-02-27T18:37:39Z","author_association":"NONE","body":"You were right, no_grad did the trick!\r\nI had only this:\r\n```\r\nbest_model = torch.load('best_model_{}.pth'.format(ENCODER))\r\nbest_model.eval()\r\n```\r\n\r\nAdded this - worked like a charm, thank you:\r\n```\r\n...\r\nwith torch.no_grad():\r\n    tiler = ImageSlicer(image.shape, tile_size=(512, 512), tile_step=(256, 256), weight='pyramid')\r\n...\r\n```","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/592112098/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false}},{"id":3079006733,"node_id":"MDExOkNsb3NlZEV2ZW50MzA3OTAwNjczMw==","url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/events/3079006733","actor":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-02-27T18:37:39Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/592115014","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/41#issuecomment-592115014","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/41","id":592115014,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjExNTAxNA==","user":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false},"created_at":"2020-02-27T18:44:07Z","updated_at":"2020-02-27T18:44:07Z","author_association":"NONE","body":"In addition, in the initial code  model output needed to be multiplied by 255, otherwise I got zero mask\r\n\r\n```\r\nfor tiles_batch, coords_batch in tqdm_notebook(DataLoader(list(zip(tiles, tiler.crops)), batch_size=1, pin_memory=True)):\r\n        tiles_batch = tiles_batch.float().cuda()\r\n        pred_batch = 255*best_model(tiles_batch)[:, 0:1, :,:]\r\n```","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/592115014/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false}}]