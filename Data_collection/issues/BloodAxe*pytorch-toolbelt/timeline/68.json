[{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007587896","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/68#issuecomment-1007587896","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/68","id":1007587896,"node_id":"IC_kwDOCntH-848DpI4","user":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false},"created_at":"2022-01-07T17:21:13Z","updated_at":"2022-01-07T17:21:13Z","author_association":"OWNER","body":"Hi! Can you please attach the code snippet that I can use to reproduce the\nissue?\n\n\n\nПт, 7 янв. 2022 г. в 18:27, Jokober ***@***.***>:\n\n> Hi, I'm trying to use your tiling tools with my yolov5 model but in the\n> following line I get following error:\n>\n>\n> https://github.com/BloodAxe/pytorch-toolbelt/blob/cab4fc4e209d9c9e5db18cf1e01bb979c65cf08b/pytorch_toolbelt/inference/tiles.py#L341\n>\n> RuntimeError: The size of tensor a (6) must match the size of tensor b\n> (928) at non-singleton dimension 2\n>\n> The debugger shows a tile tensor size of (52983,6) and a weight tensor\n> size of (1, 928,928). What could be the reason for the difference in the\n> tensor size?\n>\n> *Some more infos:*\n> model size: 928x928\n> image size is 3840*2160\n> I am leading the model using DetectMultiBackend from yolov5\n>\n> —\n> Reply to this email directly, view it on GitHub\n> <https://github.com/BloodAxe/pytorch-toolbelt/issues/68>, or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAEB6YDH3EPBVTZFQIXKCFDUU4H6BANCNFSM5LPER2IA>\n> .\n> You are receiving this because you are subscribed to this thread.Message\n> ID: ***@***.***>\n>\n","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007587896/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007623886","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/68#issuecomment-1007623886","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/68","id":1007623886,"node_id":"IC_kwDOCntH-848Dx7O","user":{"login":"jokober","id":4704377,"node_id":"MDQ6VXNlcjQ3MDQzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4704377?v=4","gravatar_id":"","url":"https://api.github.com/users/jokober","html_url":"https://github.com/jokober","followers_url":"https://api.github.com/users/jokober/followers","following_url":"https://api.github.com/users/jokober/following{/other_user}","gists_url":"https://api.github.com/users/jokober/gists{/gist_id}","starred_url":"https://api.github.com/users/jokober/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jokober/subscriptions","organizations_url":"https://api.github.com/users/jokober/orgs","repos_url":"https://api.github.com/users/jokober/repos","events_url":"https://api.github.com/users/jokober/events{/privacy}","received_events_url":"https://api.github.com/users/jokober/received_events","type":"User","site_admin":false},"created_at":"2022-01-07T18:12:26Z","updated_at":"2022-01-07T18:12:26Z","author_association":"NONE","body":"Sure, it is pretty much the code from your readme:\r\n```\r\nweights = \"./yolov5/runs/train/exp9/weights/best.pt\"\r\ndevice = 1\r\nimg_path = \"./yolov5_playground/images/10054_721234.png\"\r\n\r\nimage = cv2.imread(img_path)\r\ndevice = select_device(device)\r\nmodel = DetectMultiBackend(weights, device=device, dnn=True)\r\n\r\n# Cut large image into overlapping tiles\r\ntiler = ImageSlicer(image.shape, tile_size=(928, 928), tile_step=(626,728))\r\n\r\n# HCW -> CHW. Optionally, do normalization here\r\ntiles = [tensor_from_rgb_image(tile) for tile in tiler.split(image)]\r\n\r\n# Allocate a CUDA buffer for holding entire mask\r\nmerger = CudaTileMerger(tiler.target_shape, 1, tiler.weight)\r\n\r\n# Run predictions for tiles and accumulate them\r\nfor tiles_batch, coords_batch in DataLoader(list(zip(tiles, tiler.crops)), batch_size=15, pin_memory=True):\r\n    tiles_batch = tiles_batch.float().cuda()\r\n    pred_batch = model(tiles_batch)\r\n\r\n    merger.integrate_batch(pred_batch, coords_batch)\r\n\r\n# Normalize accumulated mask and convert back to numpy\r\nmerged_mask = np.moveaxis(to_numpy(merger.merge()), 0, -1).astype(np.uint8)\r\nmerged_mask = tiler.crop_to_orignal_size(merged_mask)\r\n```","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007623886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jokober","id":4704377,"node_id":"MDQ6VXNlcjQ3MDQzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4704377?v=4","gravatar_id":"","url":"https://api.github.com/users/jokober","html_url":"https://github.com/jokober","followers_url":"https://api.github.com/users/jokober/followers","following_url":"https://api.github.com/users/jokober/following{/other_user}","gists_url":"https://api.github.com/users/jokober/gists{/gist_id}","starred_url":"https://api.github.com/users/jokober/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jokober/subscriptions","organizations_url":"https://api.github.com/users/jokober/orgs","repos_url":"https://api.github.com/users/jokober/repos","events_url":"https://api.github.com/users/jokober/events{/privacy}","received_events_url":"https://api.github.com/users/jokober/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007802501","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/68#issuecomment-1007802501","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/68","id":1007802501,"node_id":"IC_kwDOCntH-848EdiF","user":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false},"created_at":"2022-01-07T22:54:50Z","updated_at":"2022-01-07T22:54:50Z","author_association":"OWNER","body":"I'm not quite familiar with YOLO architecture, but I feel this would not work out of the box. The example from the README assumes the model returns a tensor of shape [B, Co, H, W] for input tensor of shape [B, Ci, H, W]. In other words, it expects the model returns same-sized segmentation map (for example). In case when returned feature map is smaller than original image you want to instantiate CudaTileMerger with shape scaled down according to the output stride of your model.\r\n\r\nSo what you can do:\r\n1) Find the place in the model where you still have the tensor [B,C,H',W'] before you reshape it. This output should be accumulated into tile merger.\r\n2) Run all tiles and generated final output features map\r\n3) Feed this feature map to remaining decoder layers / nms / whatever comes next to get predictions from the entire image.\r\n\r\nI believe this is the only correct way to run detection on arbitrary large images. One can run detection for each patch independently, but by doing so one has another problem of merging detection around patch edges. \r\n\r\n","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1007802501/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1011379317","html_url":"https://github.com/BloodAxe/pytorch-toolbelt/issues/68#issuecomment-1011379317","issue_url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/68","id":1011379317,"node_id":"IC_kwDOCntH-848SGx1","user":{"login":"jokober","id":4704377,"node_id":"MDQ6VXNlcjQ3MDQzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4704377?v=4","gravatar_id":"","url":"https://api.github.com/users/jokober","html_url":"https://github.com/jokober","followers_url":"https://api.github.com/users/jokober/followers","following_url":"https://api.github.com/users/jokober/following{/other_user}","gists_url":"https://api.github.com/users/jokober/gists{/gist_id}","starred_url":"https://api.github.com/users/jokober/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jokober/subscriptions","organizations_url":"https://api.github.com/users/jokober/orgs","repos_url":"https://api.github.com/users/jokober/repos","events_url":"https://api.github.com/users/jokober/events{/privacy}","received_events_url":"https://api.github.com/users/jokober/received_events","type":"User","site_admin":false},"created_at":"2022-01-12T19:26:48Z","updated_at":"2022-01-12T19:26:48Z","author_association":"NONE","body":"Thanks for your helpful explanation! It totally makes sense. I was looking into the yolov5 implementation to get the feature map but as I already did the tiling and dataset preparation using DarkHelp and DarkMark (which support tiling) I just switched to the yolov4 darknet implementation. However I will very likely use try your suggestions for a segmentation task soon.","reactions":{"url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/comments/1011379317/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jokober","id":4704377,"node_id":"MDQ6VXNlcjQ3MDQzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4704377?v=4","gravatar_id":"","url":"https://api.github.com/users/jokober","html_url":"https://github.com/jokober","followers_url":"https://api.github.com/users/jokober/followers","following_url":"https://api.github.com/users/jokober/following{/other_user}","gists_url":"https://api.github.com/users/jokober/gists{/gist_id}","starred_url":"https://api.github.com/users/jokober/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jokober/subscriptions","organizations_url":"https://api.github.com/users/jokober/orgs","repos_url":"https://api.github.com/users/jokober/repos","events_url":"https://api.github.com/users/jokober/events{/privacy}","received_events_url":"https://api.github.com/users/jokober/received_events","type":"User","site_admin":false}},{"id":6223944310,"node_id":"CE_lADOCntH-85BWskozwAAAAFy-dp2","url":"https://api.github.com/repos/BloodAxe/pytorch-toolbelt/issues/events/6223944310","actor":{"login":"BloodAxe","id":532320,"node_id":"MDQ6VXNlcjUzMjMyMA==","avatar_url":"https://avatars.githubusercontent.com/u/532320?v=4","gravatar_id":"","url":"https://api.github.com/users/BloodAxe","html_url":"https://github.com/BloodAxe","followers_url":"https://api.github.com/users/BloodAxe/followers","following_url":"https://api.github.com/users/BloodAxe/following{/other_user}","gists_url":"https://api.github.com/users/BloodAxe/gists{/gist_id}","starred_url":"https://api.github.com/users/BloodAxe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BloodAxe/subscriptions","organizations_url":"https://api.github.com/users/BloodAxe/orgs","repos_url":"https://api.github.com/users/BloodAxe/repos","events_url":"https://api.github.com/users/BloodAxe/events{/privacy}","received_events_url":"https://api.github.com/users/BloodAxe/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-03-11T10:38:26Z","state_reason":null,"performed_via_github_app":null}]