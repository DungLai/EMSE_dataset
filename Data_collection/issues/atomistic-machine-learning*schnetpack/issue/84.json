{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84","repository_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack","labels_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84/labels{/name}","comments_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84/comments","events_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84/events","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/84","id":427096290,"node_id":"MDU6SXNzdWU0MjcwOTYyOTA=","number":84,"title":"Force training with angular symmetry functions for clusters with different number of atoms","user":{"login":"lmj1029123","id":34913961,"node_id":"MDQ6VXNlcjM0OTEzOTYx","avatar_url":"https://avatars.githubusercontent.com/u/34913961?v=4","gravatar_id":"","url":"https://api.github.com/users/lmj1029123","html_url":"https://github.com/lmj1029123","followers_url":"https://api.github.com/users/lmj1029123/followers","following_url":"https://api.github.com/users/lmj1029123/following{/other_user}","gists_url":"https://api.github.com/users/lmj1029123/gists{/gist_id}","starred_url":"https://api.github.com/users/lmj1029123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmj1029123/subscriptions","organizations_url":"https://api.github.com/users/lmj1029123/orgs","repos_url":"https://api.github.com/users/lmj1029123/repos","events_url":"https://api.github.com/users/lmj1029123/events{/privacy}","received_events_url":"https://api.github.com/users/lmj1029123/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false},"assignees":[{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false},{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-03-29T17:25:25Z","updated_at":"2019-04-01T14:55:20Z","closed_at":"2019-04-01T14:55:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi,\r\n\r\nIt seems that the trainer is not working properly when I did force training with angular symmetry functions for clusters with different number of atoms.  (ElementalEnergy)\r\n\r\nWhen I did the training for clusters with same number of atoms, it is OK. By looking at the log, it seems that the losses are going down. However, if I use it for clusters with different number of atoms, the losses become nan. This applies to both \"Behler\" and \"Weighted\" mode. Changing the learning rate of the Adam optimizer does not help. I don't know exactly why this is the case. My guess is that it could be due to the padding you do to the \"representation\" when you have clusters of different size. Could you have a look at that? Thanks!\r\n\r\n```\r\nfrom schnetpack.data import AtomsData\r\nimport torch\r\nimport torch.nn.functional as F\r\nfrom torch.optim import Adam\r\nfrom torch.optim import LBFGS\r\nimport pickle \r\nimport schnetpack as spk\r\nimport schnetpack.atomistic as atm\r\nimport schnetpack.representation as rep\r\nfrom schnetpack.datasets import *\r\nimport schnetpack.evaluation as eva\r\nfrom schnetpack.metrics import MeanSquaredError\r\n\r\nName = 'debug'  # (ref:Name)\r\n\r\nif not os.path.exists(Name):\r\n    os.makedirs(Name)\r\n\r\n\r\ndata = AtomsData('./db/master-jb.db', required_properties=['energy','forces'],collect_triples=True)\r\n\r\n#40 training data, 5 val data, rest are for test\r\ntrain, val, test = data.create_splits(30, 30)\r\ntrain_loader = spk.data.AtomsLoader(train, batch_size=3, num_workers=0)\r\nval_loader = spk.data.AtomsLoader(val)\r\ntest_loader = spk.data.AtomsLoader(test)\r\nloader = [train_loader, val_loader, test_loader]\r\npickle.dump(loader, open('./'+Name+'/loader.sav','wb'))\r\n\r\nreps = rep.BehlerSFBlock(n_radial=2, n_angular=2, elements=frozenset([46,79]), cutoff_radius=6.0, mode = 'weighted')\r\n#print(reps.n_symfuncs)\r\noutput = ElementalEnergy(n_in=reps.n_symfuncs,n_layers=3,n_hidden=10, elements=frozenset([46,79]),return_force=True,create_graph=True)\r\nmodel = atm.AtomisticModel(reps, output)\r\n\r\ntrainable_params = filter(lambda p: p.requires_grad, model.parameters())\r\n\r\nmetric_E = [MeanSquaredError(target = 'energy',model_output='y'),MeanSquaredError(target = 'forces',model_output='dydx')]\r\nhook_E = spk.train.CSVHook(\"./\"+Name, metric_E)\r\n\r\nopt = Adam(trainable_params, lr=1e-4)\r\n\r\nloss = lambda b, p: F.mse_loss(p[\"y\"], b['energy'])+F.mse_loss(p[\"dydx\"], b['forces'])\r\ntrainer = spk.train.Trainer(Name+\"/\", model, loss,\r\n                      opt, train_loader, val_loader,hooks = [hook_E])\r\n\r\n# start training\r\ntrainer.train(torch.device(\"cpu\"))\r\n```\r\n\r\n\r\n\r\nBest,\r\nMingjie","closed_by":{"login":"ktschuett","id":6585114,"node_id":"MDQ6VXNlcjY1ODUxMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6585114?v=4","gravatar_id":"","url":"https://api.github.com/users/ktschuett","html_url":"https://github.com/ktschuett","followers_url":"https://api.github.com/users/ktschuett/followers","following_url":"https://api.github.com/users/ktschuett/following{/other_user}","gists_url":"https://api.github.com/users/ktschuett/gists{/gist_id}","starred_url":"https://api.github.com/users/ktschuett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ktschuett/subscriptions","organizations_url":"https://api.github.com/users/ktschuett/orgs","repos_url":"https://api.github.com/users/ktschuett/repos","events_url":"https://api.github.com/users/ktschuett/events{/privacy}","received_events_url":"https://api.github.com/users/ktschuett/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/84/timeline","performed_via_github_app":null,"state_reason":"completed"}