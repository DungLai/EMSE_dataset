{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96","repository_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack","labels_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96/labels{/name}","comments_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96/comments","events_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96/events","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/96","id":430932531,"node_id":"MDU6SXNzdWU0MzA5MzI1MzE=","number":96,"title":"Dataloader stuck with AseEnvironmentProvider","user":{"login":"Dom1L","id":20482947,"node_id":"MDQ6VXNlcjIwNDgyOTQ3","avatar_url":"https://avatars.githubusercontent.com/u/20482947?v=4","gravatar_id":"","url":"https://api.github.com/users/Dom1L","html_url":"https://github.com/Dom1L","followers_url":"https://api.github.com/users/Dom1L/followers","following_url":"https://api.github.com/users/Dom1L/following{/other_user}","gists_url":"https://api.github.com/users/Dom1L/gists{/gist_id}","starred_url":"https://api.github.com/users/Dom1L/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Dom1L/subscriptions","organizations_url":"https://api.github.com/users/Dom1L/orgs","repos_url":"https://api.github.com/users/Dom1L/repos","events_url":"https://api.github.com/users/Dom1L/events{/privacy}","received_events_url":"https://api.github.com/users/Dom1L/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false},"assignees":[{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2019-04-09T12:12:12Z","updated_at":"2019-04-12T19:30:10Z","closed_at":"2019-04-12T19:30:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi guys,\r\n\r\nthanks for the suggestions with the AseEnvironmentProvider. \r\nIt worked well with my dummy test set of 100 structures, but I discovered that for a larger database size the whole data loading procedure gets stuck. This means when the data is initialized the first time (either during `loader.get_statistics()` or in the trainer function later) it doesn't finish. I also had an issue where it continued to fill up my ram and I needed to stop at 90Gb. \r\nI set the number of workers in the dataloader to 0 to debug a bit and it seems to be stuck in the ase neighbour list function.\r\nI tested this also with small molecules and its reproducible with the qm9 dataset.\r\n\r\nHave you experienced something similar? \r\n\r\nI used the same script as before with the AseEnvironment addition. The issue already arises with a database size of 3000 molecules.\r\n\r\nThanks for your help!\r\n\r\n```python\r\nimport torch\r\nimport torch.nn.functional as F\r\nfrom torch.optim import Adam\r\n\r\nimport schnetpack as spk\r\nfrom schnetpack.data import AtomsData\r\nimport schnetpack.atomistic as atm\r\nimport schnetpack.representation as rep\r\n\r\ncutoff = 5.  # Angstrom\r\nenvironment_provider = spk.environment.AseEnvironmentProvider(cutoff)\r\ndata = AtomsData('trypsin.db', required_properties=['energy'], environment_provider=environment_provider)\r\n\r\n# split in train and val\r\ntrain, val, test = data.create_splits(2800, 100)\r\nloader = spk.data.AtomsLoader(train, batch_size=10, num_workers=4)\r\nval_loader = spk.data.AtomsLoader(val)\r\n\r\n# create model\r\nreps = rep.SchNet(\r\n    n_atom_basis=128,\r\n    n_filters=128,\r\n    n_interactions=1,\r\n    cutoff=5.0,\r\n    n_gaussians=25,\r\n    normalize_filter=False,\r\n    coupled_interactions=False,\r\n    return_intermediate=False,\r\n    max_z=100,\r\n    trainable_gaussians=False,\r\n    distance_expansion=None)\r\noutput = atm.Atomwise()\r\nmodel = atm.AtomisticModel(reps, output).cuda()\r\n\r\nopt = Adam(model.parameters(), lr=1e-3)\r\nloss = lambda b, p: F.mse_loss(p[\"y\"], b['energy'])\r\nout_dir = 'test'\r\ntrainer = spk.train.Trainer(out_dir, model, loss, opt, loader, val_loader,\r\n                            hooks=[spk.train.CSVHook(f'{out_dir}/log',\r\n                                                     [spk.metrics.MeanAbsoluteError('energy', \"y\"),\r\n                                                      spk.metrics.RootMeanSquaredError('energy', \"y\")],\r\n                                                     every_n_epochs=1)])\r\ntrainer.train(torch.device(\"cuda\"))\r\n```\r\n","closed_by":{"login":"ktschuett","id":6585114,"node_id":"MDQ6VXNlcjY1ODUxMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6585114?v=4","gravatar_id":"","url":"https://api.github.com/users/ktschuett","html_url":"https://github.com/ktschuett","followers_url":"https://api.github.com/users/ktschuett/followers","following_url":"https://api.github.com/users/ktschuett/following{/other_user}","gists_url":"https://api.github.com/users/ktschuett/gists{/gist_id}","starred_url":"https://api.github.com/users/ktschuett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ktschuett/subscriptions","organizations_url":"https://api.github.com/users/ktschuett/orgs","repos_url":"https://api.github.com/users/ktschuett/repos","events_url":"https://api.github.com/users/ktschuett/events{/privacy}","received_events_url":"https://api.github.com/users/ktschuett/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/96/timeline","performed_via_github_app":null,"state_reason":"completed"}