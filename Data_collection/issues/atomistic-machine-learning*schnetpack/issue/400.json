{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400","repository_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack","labels_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400/labels{/name}","comments_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400/comments","events_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400/events","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/400","id":1212663123,"node_id":"I_kwDOCMZ5Ls5IR8VT","number":400,"title":"Problems with PBC and units","user":{"login":"pwrobel5","id":37253863,"node_id":"MDQ6VXNlcjM3MjUzODYz","avatar_url":"https://avatars.githubusercontent.com/u/37253863?v=4","gravatar_id":"","url":"https://api.github.com/users/pwrobel5","html_url":"https://github.com/pwrobel5","followers_url":"https://api.github.com/users/pwrobel5/followers","following_url":"https://api.github.com/users/pwrobel5/following{/other_user}","gists_url":"https://api.github.com/users/pwrobel5/gists{/gist_id}","starred_url":"https://api.github.com/users/pwrobel5/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pwrobel5/subscriptions","organizations_url":"https://api.github.com/users/pwrobel5/orgs","repos_url":"https://api.github.com/users/pwrobel5/repos","events_url":"https://api.github.com/users/pwrobel5/events{/privacy}","received_events_url":"https://api.github.com/users/pwrobel5/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false},"assignees":[{"login":"Stefaanhess","id":23171261,"node_id":"MDQ6VXNlcjIzMTcxMjYx","avatar_url":"https://avatars.githubusercontent.com/u/23171261?v=4","gravatar_id":"","url":"https://api.github.com/users/Stefaanhess","html_url":"https://github.com/Stefaanhess","followers_url":"https://api.github.com/users/Stefaanhess/followers","following_url":"https://api.github.com/users/Stefaanhess/following{/other_user}","gists_url":"https://api.github.com/users/Stefaanhess/gists{/gist_id}","starred_url":"https://api.github.com/users/Stefaanhess/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stefaanhess/subscriptions","organizations_url":"https://api.github.com/users/Stefaanhess/orgs","repos_url":"https://api.github.com/users/Stefaanhess/repos","events_url":"https://api.github.com/users/Stefaanhess/events{/privacy}","received_events_url":"https://api.github.com/users/Stefaanhess/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-04-22T18:33:39Z","updated_at":"2022-05-04T12:36:42Z","closed_at":"2022-05-04T12:36:42Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\r\n\r\nPreviously I successfully used schnetpack for training models on energies, forces an dipole moments and performing MD simulations for small non-periodic system. Now I am trying to use it for periodic system consisting of 500 atoms. I created extended .xyz file with included lattice vector and used it to create database with either AseEnvironmentProvider or TorchEnvironmentProvider. The problem begins with training NN - AseEnvironmentProvider results in extremely large training times (about 1 day/epoch), while TorchEnvironmentProvider seems to be faster, however is completely unusuable - it produces NaNs in loss function since first training epoch. The problem seems to be related with PBC, since training with standard environment provider has an acceptable speed.\r\n\r\nIs the system too big to use PBC? I am also not sure if I use correct units - every position, lattice vectors and cutoff are defined in Angstroms.\r\n\r\nI include sample snapshot from extxyz file and script used for training.\r\n[ext_sample.txt](https://github.com/atomistic-machine-learning/schnetpack/files/8543183/ext_sample.txt)\r\n\r\n```python\r\nimport os\r\n\r\nimport schnetpack as spk\r\nimport schnetpack.train as trn\r\nimport torch\r\nfrom schnetpack.datasets import AtomsData\r\nfrom schnetpack.environment import AseEnvironmentProvider\r\nfrom torch.optim import Adam\r\n\r\nexample = \"./ec\"\r\nif not os.path.exists(example):\r\n    os.makedirs(example)\r\n\r\nemim_fsi_data = AtomsData(\"ec-01-ase.db\", environment_provider=AseEnvironmentProvider(7.5))\r\n\r\ntrain, val, test = spk.train_test_split(\r\n    data=emim_fsi_data,\r\n    num_train=22000,\r\n    num_val=3000,\r\n    split_file=os.path.join(example, \"split.npz\"),\r\n)\r\n\r\ntrain_loader = spk.AtomsLoader(train, batch_size=2, shuffle=True)\r\nval_loader = spk.AtomsLoader(val, batch_size=2)\r\n\r\nmeans, stddevs = train_loader.get_statistics(spk.Properties.energy, divide_by_atoms=True)\r\n\r\nn_features = 128\r\n\r\nschnet = spk.representation.SchNet(\r\n    n_atom_basis=n_features,\r\n    n_filters=n_features,\r\n    n_gaussians=25,\r\n    n_interactions=3,\r\n    cutoff=5.,\r\n    cutoff_network=spk.nn.CosineCutoff\r\n)\r\n\r\nenergy_model = spk.atomistic.Atomwise(\r\n    n_in=n_features,\r\n    property=spk.Properties.energy,\r\n    mean=means[spk.Properties.energy],\r\n    stddev=stddevs[spk.Properties.energy],\r\n    derivative=spk.Properties.forces,\r\n    negative_dr=True\r\n)\r\n\r\nmodel = spk.AtomisticModel(representation=schnet, output_modules=energy_model)\r\n\r\nrho_tradeoff = 0.1\r\n\r\n\r\ndef loss(batch, result):\r\n    diff_energy = batch[spk.Properties.energy] - result[spk.Properties.energy]\r\n    err_sq_energy = torch.mean(diff_energy ** 2)\r\n\r\n    diff_forces = batch[spk.Properties.forces] - result[spk.Properties.forces]\r\n    err_sq_forces = torch.mean(diff_forces ** 2)\r\n\r\n    err_sq = rho_tradeoff * err_sq_energy + (1 - rho_tradeoff) * err_sq_forces\r\n    return err_sq\r\n\r\n\r\noptimizer = Adam(model.parameters(), lr=5e-4)\r\n\r\nmetrics = [\r\n    spk.metrics.MeanAbsoluteError(spk.Properties.energy),\r\n    spk.metrics.MeanAbsoluteError(spk.Properties.forces)\r\n]\r\n\r\nhooks = [\r\n    trn.CSVHook(log_path=example, metrics=metrics),\r\n    trn.ReduceLROnPlateauHook(\r\n        optimizer,\r\n        patience=5, factor=0.8, min_lr=1e-6,\r\n        stop_after_min=True\r\n    )\r\n]\r\n\r\ntrainer = trn.Trainer(\r\n    model_path=example,\r\n    model=model,\r\n    hooks=hooks,\r\n    loss_fn=loss,\r\n    optimizer=optimizer,\r\n    train_loader=train_loader,\r\n    validation_loader=val_loader\r\n)\r\n\r\nif torch.cuda.is_available():\r\n    device = \"cuda\"\r\nelse:\r\n    device = \"cpu\"\r\n\r\nn_epochs = 200\r\ntrainer.train(device=device, n_epochs=n_epochs)\r\n```\r\n\r\nCheers,\r\nPiotr","closed_by":{"login":"ktschuett","id":6585114,"node_id":"MDQ6VXNlcjY1ODUxMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6585114?v=4","gravatar_id":"","url":"https://api.github.com/users/ktschuett","html_url":"https://github.com/ktschuett","followers_url":"https://api.github.com/users/ktschuett/followers","following_url":"https://api.github.com/users/ktschuett/following{/other_user}","gists_url":"https://api.github.com/users/ktschuett/gists{/gist_id}","starred_url":"https://api.github.com/users/ktschuett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ktschuett/subscriptions","organizations_url":"https://api.github.com/users/ktschuett/orgs","repos_url":"https://api.github.com/users/ktschuett/repos","events_url":"https://api.github.com/users/ktschuett/events{/privacy}","received_events_url":"https://api.github.com/users/ktschuett/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/400/timeline","performed_via_github_app":null,"state_reason":"completed"}