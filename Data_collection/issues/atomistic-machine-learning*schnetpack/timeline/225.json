[{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621923297","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-621923297","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":621923297,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTkyMzI5Nw==","user":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T15:22:45Z","updated_at":"2020-04-30T15:28:29Z","author_association":"COLLABORATOR","body":"Unfortunately, the internal MD in the current master branch only works with the primitive environment provider. We are working on that. \r\n\r\nThere is a branch \"pbc_update\" where these features are currently being introduced. There you can pass the following argument to the calculator:\r\n`neighbor_list=schnetpack.nn.ASENeighborList`\r\nwhere the latter is a wrapper for the `AseEnvironmentProvider`. If no cutoff is given, the one used during training the model should be detected automatically. Otherwise, you can add the\r\n`cutoff=5.0`\r\nargument to the calculator.","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621923297/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621927620","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-621927620","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":621927620,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTkyNzYyMA==","user":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T15:29:58Z","updated_at":"2020-04-30T15:29:58Z","author_association":"NONE","body":"Alright, I think I may have (partly?) solved the problem by modifying the `_generate_input` function under `schnet_calculator.py`. Here is the modification I made\r\n\r\n```\r\n    def _generate_input(self, system):\r\n        \"\"\"\r\n        Function to extracts neighbor lists, atom_types, positions e.t.c. from the system and generate a properly\r\n        formatted input for the schnetpack model.\r\n\r\n        Args:\r\n            system (schnetpack.md.System): System object containing current state of the simulation.\r\n\r\n        Returns:\r\n            dict(torch.Tensor): Schnetpack inputs in dictionary format.\r\n        \"\"\"\r\n\r\n        positions, atom_types, atom_masks = self._get_system_molecules(system)\r\n        cell      = system.cell.astype(np.float32)\r\n        atoms = ase.Atoms(numbers = atom_types[0].detach().numpy(),\r\n                  positions = positions[0].detach().numpy(),\r\n                  cell = cell,pbc=True)\r\n        environment_provider            = AseEnvironmentProvider(5) # I manually put the environment here\r\n        neighbor_list_org, offset_org = environment_provider.get_environment(atoms)\r\n        neighbor_list_org                     =  neighbor_list_org.astype(int)\r\n        \r\n        nbh    = torch.tensor(neighbor_list_org)[None,:]\r\n        offset = torch.tensor(offset_org)[None,:]\r\n        mask = nbh >= 0\r\n        neighbor_mask = mask.long()\r\n        neighbors = (nbh * mask.long())\r\n\r\n        inputs = {\r\n            Properties.R: positions,\r\n            Properties.Z: atom_types,\r\n            Properties.atom_mask: atom_masks, # not change\r\n            Properties.cell: torch.tensor(cell)[None,:],\r\n            Properties.cell_offset: offset,\r\n            Properties.neighbors: neighbors,\r\n            Properties.neighbor_mask: neighbor_mask,\r\n        }\r\n\r\n        return inputs\r\n```\r\nThe output force and potential are close to what they should be. Does this modification make sense to you?\r\nThank you!","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621927620/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621933314","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-621933314","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":621933314,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTkzMzMxNA==","user":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T15:39:32Z","updated_at":"2020-04-30T15:39:32Z","author_association":"COLLABORATOR","body":"This looks reasonable. Basically the only thing the above wrapper adds is an additional buffer zone and a check how far the atoms moved so that the neighbor list does only have to be recomputed if the atoms move too far.\r\n\r\nThe only thing to look out for are the units, the MD system uses atomic units (Bohr etc) internally. This needs to be consistent with the cutoff, if no conversion happens when you get the atoms from the system.","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621933314/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621937027","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-621937027","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":621937027,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTkzNzAyNw==","user":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T15:45:44Z","updated_at":"2020-04-30T15:45:44Z","author_association":"NONE","body":"I see. Thank you. One more question is that when the starting molecule structure is loaded using the `System` class, it seems that the cell information is not loaded. I wonder if the cell size info is discarded in the MD simulation.  Also, is the periodic boundary condition is taken care in the MD simulation?  I tried reading the source code but could find the implementation of periodic boundary condition in MD simulation modules.\r\n","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621937027/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621939752","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-621939752","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":621939752,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTkzOTc1Mg==","user":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T15:50:35Z","updated_at":"2020-04-30T15:50:35Z","author_association":"COLLABORATOR","body":"Unfortunately, these are all parts missing from the current master. All these things (+barostats, wrapping etc.) are present in the `pbc_update` branch (hence the name). Since there are other updates to come, we did not integrate into the master yet. It should work without problems for models trained in the master branch, as basic SchNet was not touched. This might be worth giving a try in your case.","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/621939752/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mgastegger","id":36198330,"node_id":"MDQ6VXNlcjM2MTk4MzMw","avatar_url":"https://avatars.githubusercontent.com/u/36198330?v=4","gravatar_id":"","url":"https://api.github.com/users/mgastegger","html_url":"https://github.com/mgastegger","followers_url":"https://api.github.com/users/mgastegger/followers","following_url":"https://api.github.com/users/mgastegger/following{/other_user}","gists_url":"https://api.github.com/users/mgastegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mgastegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgastegger/subscriptions","organizations_url":"https://api.github.com/users/mgastegger/orgs","repos_url":"https://api.github.com/users/mgastegger/repos","events_url":"https://api.github.com/users/mgastegger/events{/privacy}","received_events_url":"https://api.github.com/users/mgastegger/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/624965709","html_url":"https://github.com/atomistic-machine-learning/schnetpack/issues/225#issuecomment-624965709","issue_url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/225","id":624965709,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDk2NTcwOQ==","user":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false},"created_at":"2020-05-07T00:48:07Z","updated_at":"2020-05-07T00:48:07Z","author_association":"NONE","body":"Thank you. `pbc_update` branch is very helpful. ","reactions":{"url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/comments/624965709/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false}},{"id":3310789502,"node_id":"MDExOkNsb3NlZEV2ZW50MzMxMDc4OTUwMg==","url":"https://api.github.com/repos/atomistic-machine-learning/schnetpack/issues/events/3310789502","actor":{"login":"neojie","id":44279474,"node_id":"MDQ6VXNlcjQ0Mjc5NDc0","avatar_url":"https://avatars.githubusercontent.com/u/44279474?v=4","gravatar_id":"","url":"https://api.github.com/users/neojie","html_url":"https://github.com/neojie","followers_url":"https://api.github.com/users/neojie/followers","following_url":"https://api.github.com/users/neojie/following{/other_user}","gists_url":"https://api.github.com/users/neojie/gists{/gist_id}","starred_url":"https://api.github.com/users/neojie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neojie/subscriptions","organizations_url":"https://api.github.com/users/neojie/orgs","repos_url":"https://api.github.com/users/neojie/repos","events_url":"https://api.github.com/users/neojie/events{/privacy}","received_events_url":"https://api.github.com/users/neojie/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-05-07T00:48:08Z","state_reason":null,"performed_via_github_app":null}]