{"url":"https://api.github.com/repos/brendanhasz/probflow/issues/12","repository_url":"https://api.github.com/repos/brendanhasz/probflow","labels_url":"https://api.github.com/repos/brendanhasz/probflow/issues/12/labels{/name}","comments_url":"https://api.github.com/repos/brendanhasz/probflow/issues/12/comments","events_url":"https://api.github.com/repos/brendanhasz/probflow/issues/12/events","html_url":"https://github.com/brendanhasz/probflow/issues/12","id":523193455,"node_id":"MDU6SXNzdWU1MjMxOTM0NTU=","number":12,"title":"Memory leak when training models","user":{"login":"brendanhasz","id":3465846,"node_id":"MDQ6VXNlcjM0NjU4NDY=","avatar_url":"https://avatars.githubusercontent.com/u/3465846?v=4","gravatar_id":"","url":"https://api.github.com/users/brendanhasz","html_url":"https://github.com/brendanhasz","followers_url":"https://api.github.com/users/brendanhasz/followers","following_url":"https://api.github.com/users/brendanhasz/following{/other_user}","gists_url":"https://api.github.com/users/brendanhasz/gists{/gist_id}","starred_url":"https://api.github.com/users/brendanhasz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brendanhasz/subscriptions","organizations_url":"https://api.github.com/users/brendanhasz/orgs","repos_url":"https://api.github.com/users/brendanhasz/repos","events_url":"https://api.github.com/users/brendanhasz/events{/privacy}","received_events_url":"https://api.github.com/users/brendanhasz/received_events","type":"User","site_admin":false},"labels":[{"id":1181357312,"node_id":"MDU6TGFiZWwxMTgxMzU3MzEy","url":"https://api.github.com/repos/brendanhasz/probflow/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":{"login":"brendanhasz","id":3465846,"node_id":"MDQ6VXNlcjM0NjU4NDY=","avatar_url":"https://avatars.githubusercontent.com/u/3465846?v=4","gravatar_id":"","url":"https://api.github.com/users/brendanhasz","html_url":"https://github.com/brendanhasz","followers_url":"https://api.github.com/users/brendanhasz/followers","following_url":"https://api.github.com/users/brendanhasz/following{/other_user}","gists_url":"https://api.github.com/users/brendanhasz/gists{/gist_id}","starred_url":"https://api.github.com/users/brendanhasz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brendanhasz/subscriptions","organizations_url":"https://api.github.com/users/brendanhasz/orgs","repos_url":"https://api.github.com/users/brendanhasz/repos","events_url":"https://api.github.com/users/brendanhasz/events{/privacy}","received_events_url":"https://api.github.com/users/brendanhasz/received_events","type":"User","site_admin":false},"assignees":[{"login":"brendanhasz","id":3465846,"node_id":"MDQ6VXNlcjM0NjU4NDY=","avatar_url":"https://avatars.githubusercontent.com/u/3465846?v=4","gravatar_id":"","url":"https://api.github.com/users/brendanhasz","html_url":"https://github.com/brendanhasz","followers_url":"https://api.github.com/users/brendanhasz/followers","following_url":"https://api.github.com/users/brendanhasz/following{/other_user}","gists_url":"https://api.github.com/users/brendanhasz/gists{/gist_id}","starred_url":"https://api.github.com/users/brendanhasz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brendanhasz/subscriptions","organizations_url":"https://api.github.com/users/brendanhasz/orgs","repos_url":"https://api.github.com/users/brendanhasz/repos","events_url":"https://api.github.com/users/brendanhasz/events{/privacy}","received_events_url":"https://api.github.com/users/brendanhasz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2019-11-15T01:01:35Z","updated_at":"2019-11-15T01:01:35Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"Especially noticable when training on large datasets.  Not sure if it's on ProbFlow's end or TensorFlow's (but almost surely ProbFlow's haha).\r\n\r\nTraining on 1M rows from the [taxi trip dataset](https://console.cloud.google.com/marketplace/details/city-of-new-york/nyc-tlc-trips) w/ TF GPU caused a leak of around 50MB/epoch :grimacing:  Was even worse w/ TF CPU\r\n\r\nLikely is a problem with [DataGenerator](https://probflow.readthedocs.io/en/latest/api_data.html).  50MB with that test was about exactly the size of the x+y dataset, so DataGenerator is probably making copies when shuffling (instead of creating views) and somehow holding on to them ad infinitum.\r\n\r\nAlso was using MonitorMetric callback, that might be the problem instead (or the corresponding Model.metric / metric function).\r\n\r\nAlso some preliminary poking around w/ pympler found that a bunch of large pandas Series were being created, but wasn't training using pandas arrays, so don't know where those were coming from.\r\n\r\nA few things to test:\r\n\r\n* Does training w/o shuffling solve the problem?\r\n* Does training w/o MonitorMetric callback solve the problem?\r\n\r\nSimplified code causing the problem:\r\n```python\r\nimport numpy as np\r\nimport probflow as pf\r\n\r\n# Data\r\nx_train = np.random.randn(1000000, 8).astype('float32')\r\ny_train = np.random.randn(1000000, 1).astype('float32')\r\nx_val =   np.random.randn( 100000, 8).astype('float32')\r\ny_val =   np.random.randn( 100000, 1).astype('float32')\r\n\r\n# Callbacks\r\nmonitor_elbo = pf.MonitorELBO()\r\nmonitor_mae = pf.MonitorMetric('mae', x_val, y_val)\r\nlr_scheduler = pf.LearningRateScheduler(lambda e: 2e-4-2e-6*e)\r\ncallbacks = [monitor_elbo, monitor_mae, lr_scheduler]\r\n\r\n# Model\r\nmodel = pf.DenseRegression([7, 256, 128, 64, 32, 1])\r\n\r\n# Train\r\nmodel.fit(x_train, y_train,\r\n          epochs=100,\r\n          batch_size=1024,\r\n          callbacks=callbacks)\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/brendanhasz/probflow/issues/12/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/brendanhasz/probflow/issues/12/timeline","performed_via_github_app":null,"state_reason":null}