{"url":"https://api.github.com/repos/regel/loudml/issues/213","repository_url":"https://api.github.com/repos/regel/loudml","labels_url":"https://api.github.com/repos/regel/loudml/issues/213/labels{/name}","comments_url":"https://api.github.com/repos/regel/loudml/issues/213/comments","events_url":"https://api.github.com/repos/regel/loudml/issues/213/events","html_url":"https://github.com/regel/loudml/issues/213","id":568949058,"node_id":"MDU6SXNzdWU1Njg5NDkwNTg=","number":213,"title":"is_anomaly tag not written correctly to InfluxDB for eval function","user":{"login":"simplelife2010","id":22767935,"node_id":"MDQ6VXNlcjIyNzY3OTM1","avatar_url":"https://avatars.githubusercontent.com/u/22767935?v=4","gravatar_id":"","url":"https://api.github.com/users/simplelife2010","html_url":"https://github.com/simplelife2010","followers_url":"https://api.github.com/users/simplelife2010/followers","following_url":"https://api.github.com/users/simplelife2010/following{/other_user}","gists_url":"https://api.github.com/users/simplelife2010/gists{/gist_id}","starred_url":"https://api.github.com/users/simplelife2010/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simplelife2010/subscriptions","organizations_url":"https://api.github.com/users/simplelife2010/orgs","repos_url":"https://api.github.com/users/simplelife2010/repos","events_url":"https://api.github.com/users/simplelife2010/events{/privacy}","received_events_url":"https://api.github.com/users/simplelife2010/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-02-21T13:16:15Z","updated_at":"2020-12-15T07:38:28Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I set up an eval job for a trained model to classify 1 month of historical data.\r\n\r\n```settings.json```:\r\n```\r\n{ \r\n   \"type\":\"donut\",\r\n   \"interval\":\"5m\",\r\n   \"grace_period\":0,\r\n   \"forecast\":3,\r\n   \"span\":24,\r\n   \"max_threshold\":0,\r\n   \"run\":{ \r\n      \"detect_anomalies\":true,\r\n      \"datasink\":\"frame_wise\",\r\n      \"save_prediction\":true\r\n   },\r\n   \"bucket_interval\":\"60m\",\r\n   \"default_bucket\":\"frame_wise\",\r\n   \"min_threshold\":0,\r\n   \"features\":[ \r\n      { \r\n         \"field\":\"failure_mode_3\",\r\n         \"metric\":\"mean\",\r\n         \"name\":\"mean_failure_mode_3\",\r\n         \"io\":\"io\",\r\n         \"match_all\":[ \r\n            { \r\n               \"value\":\"aim-node-46723892\",\r\n               \"tag\":\"node_id\"\r\n            },\r\n            { \r\n               \"value\":1,\r\n               \"tag\":\"channel_id\"\r\n            }\r\n         ],\r\n         \"measurement\":\"frame_wise\",\r\n         \"default\":\"previous\",\r\n         \"anomaly_type\":\"high\"\r\n      }\r\n   ],\r\n   \"seasonality\":{ \r\n      \"weekday\":true,\r\n      \"daytime\":true\r\n   },\r\n   \"offset\":\"120s\"\r\n}\r\n```\r\n\r\nI start the eval job with ```-s -a```. Looking at the logs, I can see that the model correctly recognizes the beginning and the end of anomalies:\r\n\r\n```\r\n...\r\n  | INFO:root:found 624 time periods\r\n  | INFO:root:generating prediction\r\n  | INFO:root:job[fedbf2b6-7da3-4ed8-ad88-27ea08c00ed5] predicted values for 601 time buckets\r\n  | WARNING:root:detected anomaly for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T13:00:00.000Z (score = 100.0)\r\n  | WARNING:root:anomaly still in progress for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T14:00:00.000Z (score = 100.0)\r\n  | INFO:root:anomaly ended for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T17:00:00.000Z (score = 48.1)\r\n  | WARNING:root:detected anomaly for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T18:00:00.000Z (score = 100.0)\r\n  | WARNING:root:anomaly still in progress for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T19:00:00.000Z (score = 100.0)\r\n  | WARNING:root:anomaly still in progress for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T20:00:00.000Z (score = 99.9)\r\n  | WARNING:root:anomaly still in progress for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-15T23:00:00.000Z (score = 100.0)\r\n  | INFO:root:anomaly ended for model 'aim-node-46723892__ch1__failure_mode_3' at 2020-01-16T00:00:00.000Z (score = 0.0)\r\n...\r\n```\r\n\r\nUnfortunately, is_anomaly is always set to 'False' in InfluxDB:\r\n```\r\n> select \"is_anomaly\", \"anomaly_status\", \"mean_failure_mode_3\" from \"frame_wise\" where \"node_id\"='aim-node-46723892' and \"is_anomaly\"='True' limit 10\r\n> select \"is_anomaly\", \"anomaly_status\", \"mean_failure_mode_3\" from \"frame_wise\" where \"node_id\"='aim-node-46723892' and \"is_anomaly\"='False' limit 10\r\nname: frame_wise\r\ntime                 is_anomaly anomaly_status mean_failure_mode_3\r\n----                 ---------- -------------- -------------------\r\n2020-01-06T10:00:00Z False      0              0.0023477811854920056\r\n2020-01-06T10:00:00Z False      0              0.013609253183039275\r\n2020-01-06T11:00:00Z False      0              0.002307761789002598\r\n2020-01-06T11:00:00Z False      0              0.015566123863361769\r\n2020-01-06T12:00:00Z False      0              0.0023304504448748223\r\n2020-01-06T12:00:00Z False      0              0.015258330362213654\r\n2020-01-06T13:00:00Z False      0              0.00232402175622729\r\n2020-01-06T13:00:00Z False      0              0.017373437567896065\r\n2020-01-06T14:00:00Z False      0              0.002308551880774874\r\n2020-01-06T14:00:00Z False      0              0.01593361254672802\r\n```\r\n\r\nInterestingly, persisting the is_anomaly flag in InfluxDB seems to work ok when doing an online anomaly detection using ```start-model``` instead of ```eval-model```.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/regel/loudml/issues/213/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/regel/loudml/issues/213/timeline","performed_via_github_app":null,"state_reason":null}