{"url":"https://api.github.com/repos/regel/loudml/issues/60","repository_url":"https://api.github.com/repos/regel/loudml","labels_url":"https://api.github.com/repos/regel/loudml/issues/60/labels{/name}","comments_url":"https://api.github.com/repos/regel/loudml/issues/60/comments","events_url":"https://api.github.com/repos/regel/loudml/issues/60/events","html_url":"https://github.com/regel/loudml/issues/60","id":372494059,"node_id":"MDU6SXNzdWUzNzI0OTQwNTk=","number":60,"title":"Duplicate anomalies pushed to Elasticsearch","user":{"login":"daradermody","id":7104356,"node_id":"MDQ6VXNlcjcxMDQzNTY=","avatar_url":"https://avatars.githubusercontent.com/u/7104356?v=4","gravatar_id":"","url":"https://api.github.com/users/daradermody","html_url":"https://github.com/daradermody","followers_url":"https://api.github.com/users/daradermody/followers","following_url":"https://api.github.com/users/daradermody/following{/other_user}","gists_url":"https://api.github.com/users/daradermody/gists{/gist_id}","starred_url":"https://api.github.com/users/daradermody/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daradermody/subscriptions","organizations_url":"https://api.github.com/users/daradermody/orgs","repos_url":"https://api.github.com/users/daradermody/repos","events_url":"https://api.github.com/users/daradermody/events{/privacy}","received_events_url":"https://api.github.com/users/daradermody/received_events","type":"User","site_admin":false},"labels":[{"id":806419189,"node_id":"MDU6TGFiZWw4MDY0MTkxODk=","url":"https://api.github.com/repos/regel/loudml/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-10-22T12:09:58Z","updated_at":"2020-05-15T05:27:37Z","closed_at":"2020-05-15T05:27:37Z","author_association":"NONE","active_lock_reason":null,"body":"I am seeing duplicate anomaly entries being written to Elasticsearch:\r\n```\r\n[\r\n    {\r\n        \"_index\": \"ml-my-sine-wave-2\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"rgagm2YBtFE6FUhu_0xd\",\r\n        \"_score\": 3.9267395,\r\n        \"_source\": {\r\n            \"lower_value\": -1.1230436942770323,\r\n            \"is_anomaly\": true,\r\n            \"score\": 43.94052888607426,\r\n            \"upper_value\": -0.7867065288827582,\r\n            \"@timestamp\": 1540209300000,\r\n            \"value\": -0.954875111579895\r\n        }\r\n    },\r\n    {\r\n        \"_index\": \"ml-my-sine-wave-2\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"tAahm2YBtFE6FUhuJkzb\",\r\n        \"_score\": 3.5902672,\r\n        \"_source\": {\r\n            \"lower_value\": -1.1230436942770323,\r\n            \"is_anomaly\": true,\r\n            \"score\": 43.94052888607426,\r\n            \"upper_value\": -0.7867065288827582,\r\n            \"@timestamp\": 1540209300000,\r\n            \"value\": -0.954875111579895\r\n        }\r\n    }\r\n]\r\n```\r\n\r\nI expected to have only one entry per anomaly detected. The logs from the Loud ML instance are a bit confusing as it seems to be checking a much wider range than the bucket interval:\r\n```\r\nINFO:root:job[dfc03aa4-a9ca-42ea-a60c-9e1e08fb51f1] starting\r\nINFO:root:setting threshold range min=25.700082 max=40.886495\r\nINFO:root:forecast(ml-my-sine-wave-2) range=2018-10-22T12:02:05.000Z-2018-10-22T12:02:55.000Z\r\nINFO:root:extracting data for range=2018-10-22T12:01:15.000Z-2018-10-22T12:02:55.000Z\r\nINFO:root:connecting to elasticsearch on 192.168.0.1:9200\r\nINFO:root:found 20 time periods\r\nINFO:root:generating forecast\r\nINFO:root:forecast(ml-my-sine-wave-2) range=2018-10-22T12:02:05.000Z-2018-10-22T12:03:00.000Z\r\nINFO:root:extracting data for range=2018-10-22T12:01:15.000Z-2018-10-22T12:03:00.000Z\r\nINFO:root:found 21 time periods\r\nINFO:root:generating forecast\r\nINFO:root:forecast(ml-my-sine-wave-2) range=2018-10-22T12:02:05.000Z-2018-10-22T12:03:05.000Z\r\nINFO:root:extracting data for range=2018-10-22T12:01:15.000Z-2018-10-22T12:03:05.000Z\r\nINFO:root:found 22 time periods\r\nINFO:root:generating forecast\r\nINFO:root:job[dfc03aa4-a9ca-42ea-a60c-9e1e08fb51f1] predicted values for 3 time buckets\r\nWARNING:root:detected anomaly for model 'ml-my-sine-wave-2' at 2018-10-22T12:02:55.000Z (score = 45.8)\r\nWARNING:root:anomaly still in progress for model 'ml-my-sine-wave-2' at 2018-10-22T12:03:00.000Z (score = 49.0)\r\nINFO:root:commit 3 change(s) to elasticsearch\r\nINFO:root:job[dfc03aa4-a9ca-42ea-a60c-9e1e08fb51f1] done\r\n```\r\n\r\nThe model is as follows:\r\n```\r\n{\r\n    \"settings\": {\r\n        \"bucket_interval\": \"5s\",\r\n        \"default_datasource\": \"sine_wave\",\r\n        \"features\": [\r\n            {\r\n                \"anomaly_type\": \"low_high\",\r\n                \"field\": \"value\",\r\n                \"metric\": \"avg\",\r\n                \"name\": \"value\"\r\n            }\r\n        ],\r\n        \"grace_period\": 0,\r\n        \"interval\": 10,\r\n        \"max_evals\": 50,\r\n        \"max_threshold\": 0,\r\n        \"min_threshold\": 0,\r\n        \"name\": \"ml-my-sine-wave-2\",\r\n        \"offset\": 10,\r\n        \"run\": {\r\n            \"detect_anomalies\": true,\r\n            \"save_prediction\": true\r\n        },\r\n        \"seasonality\": {\r\n            \"daytime\": false,\r\n            \"weekday\": false\r\n        },\r\n        \"span\": 10,\r\n        \"timestamp_field\": \"@timestamp\",\r\n        \"type\": \"timeseries\"\r\n    },\r\n    \"state\": {\r\n        \"loss\": 0.0045575396044679846,\r\n        \"trained\": true\r\n    },\r\n    \"training\": {\r\n        \"job_id\": \"b658de03-eb77-4111-a956-7650881ddc08\",\r\n        \"progress\": {\r\n            \"eval\": 51,\r\n            \"max_evals\": 50\r\n        },\r\n        \"state\": \"done\"\r\n    }\r\n}\r\n```","closed_by":{"login":"regel","id":355557,"node_id":"MDQ6VXNlcjM1NTU1Nw==","avatar_url":"https://avatars.githubusercontent.com/u/355557?v=4","gravatar_id":"","url":"https://api.github.com/users/regel","html_url":"https://github.com/regel","followers_url":"https://api.github.com/users/regel/followers","following_url":"https://api.github.com/users/regel/following{/other_user}","gists_url":"https://api.github.com/users/regel/gists{/gist_id}","starred_url":"https://api.github.com/users/regel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/regel/subscriptions","organizations_url":"https://api.github.com/users/regel/orgs","repos_url":"https://api.github.com/users/regel/repos","events_url":"https://api.github.com/users/regel/events{/privacy}","received_events_url":"https://api.github.com/users/regel/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/regel/loudml/issues/60/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/regel/loudml/issues/60/timeline","performed_via_github_app":null,"state_reason":"completed"}