{"url":"https://api.github.com/repos/microsoft/graspologic/issues/582","repository_url":"https://api.github.com/repos/microsoft/graspologic","labels_url":"https://api.github.com/repos/microsoft/graspologic/issues/582/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/graspologic/issues/582/comments","events_url":"https://api.github.com/repos/microsoft/graspologic/issues/582/events","html_url":"https://github.com/microsoft/graspologic/issues/582","id":740273817,"node_id":"MDU6SXNzdWU3NDAyNzM4MTc=","number":582,"title":"[BUG] Bug in joblib transitive dependency causes exception when multi-threading","user":{"login":"jonmclean","id":4429525,"node_id":"MDQ6VXNlcjQ0Mjk1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4429525?v=4","gravatar_id":"","url":"https://api.github.com/users/jonmclean","html_url":"https://github.com/jonmclean","followers_url":"https://api.github.com/users/jonmclean/followers","following_url":"https://api.github.com/users/jonmclean/following{/other_user}","gists_url":"https://api.github.com/users/jonmclean/gists{/gist_id}","starred_url":"https://api.github.com/users/jonmclean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonmclean/subscriptions","organizations_url":"https://api.github.com/users/jonmclean/orgs","repos_url":"https://api.github.com/users/jonmclean/repos","events_url":"https://api.github.com/users/jonmclean/events{/privacy}","received_events_url":"https://api.github.com/users/jonmclean/received_events","type":"User","site_admin":false},"labels":[{"id":1048646805,"node_id":"MDU6TGFiZWwxMDQ4NjQ2ODA1","url":"https://api.github.com/repos/microsoft/graspologic/labels/bug","name":"bug","color":"cded2d","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"jonmclean","id":4429525,"node_id":"MDQ6VXNlcjQ0Mjk1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4429525?v=4","gravatar_id":"","url":"https://api.github.com/users/jonmclean","html_url":"https://github.com/jonmclean","followers_url":"https://api.github.com/users/jonmclean/followers","following_url":"https://api.github.com/users/jonmclean/following{/other_user}","gists_url":"https://api.github.com/users/jonmclean/gists{/gist_id}","starred_url":"https://api.github.com/users/jonmclean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonmclean/subscriptions","organizations_url":"https://api.github.com/users/jonmclean/orgs","repos_url":"https://api.github.com/users/jonmclean/repos","events_url":"https://api.github.com/users/jonmclean/events{/privacy}","received_events_url":"https://api.github.com/users/jonmclean/received_events","type":"User","site_admin":false},"assignees":[{"login":"jonmclean","id":4429525,"node_id":"MDQ6VXNlcjQ0Mjk1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4429525?v=4","gravatar_id":"","url":"https://api.github.com/users/jonmclean","html_url":"https://github.com/jonmclean","followers_url":"https://api.github.com/users/jonmclean/followers","following_url":"https://api.github.com/users/jonmclean/following{/other_user}","gists_url":"https://api.github.com/users/jonmclean/gists{/gist_id}","starred_url":"https://api.github.com/users/jonmclean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonmclean/subscriptions","organizations_url":"https://api.github.com/users/jonmclean/orgs","repos_url":"https://api.github.com/users/jonmclean/repos","events_url":"https://api.github.com/users/jonmclean/events{/privacy}","received_events_url":"https://api.github.com/users/jonmclean/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2020-11-10T22:00:39Z","updated_at":"2020-11-12T18:09:02Z","closed_at":"2020-11-12T18:09:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Expected Behavior\r\nMulti-threading LatentDistributionTest using a \"workers\" value != 1 should return without error on all platforms.\r\n\r\n## Actual Behavior\r\nWhen using any \"workers\" value > 1 or equal to -1 on a Windows computer, the code throws an exception.\r\n\r\n## Example Code\r\n\r\n```python\r\ntest = LatentDistributionTest(input_graph=False, workers=10)\r\nresult = test.fit_predict(graph1, graph2)\r\n```\r\n\r\n## Full Traceback\r\n```pytb\r\nC:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\disk.py:122: UserWarning: Unable to delete folder C:\\Users\\msrwinadm4\\AppData\\Local\\Temp\\5\\joblib_memmapping_folder_11132_7308949288 after 5 tentatives.\r\n  .format(folder_path, RM_SUBDIRS_N_RETRY))\r\nTraceback (most recent call last):\r\n  File \"GraphsByOrg.py\", line 79, in <module>\r\n    logger.info(f'Calculating nonpar for {org1} and {org2}')\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\graspologic\\inference\\latent_distribution_test.py\", line 487, in fit_predict\r\n    self.fit(A1, A2)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\graspologic\\inference\\latent_distribution_test.py\", line 449, in fit\r\n    X1_hat, X2_hat, reps=self.n_bootstraps, workers=self.workers, auto=False\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\hyppo\\ksample\\ksamp.py\", line 166, in test\r\n    return self.indep_test.test(u, v, reps, workers, auto=auto)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\hyppo\\independence\\dcorr.py\", line 215, in test\r\n    stat, pvalue = super(Dcorr, self).test(x, y, reps, workers)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\hyppo\\independence\\base.py\", line 67, in test\r\n    self._statistic, x, y, reps=reps, workers=workers, is_distsim=is_distsim\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\hyppo\\_utils.py\", line 140, in perm_test\r\n    [delayed(_perm_stat)(calc_stat, x, y, is_distsim) for rep in range(reps)]\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\parallel.py\", line 1027, in __call__\r\n    self._terminate_backend()\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\parallel.py\", line 734, in _terminate_backend\r\n    self._backend.terminate()\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\_parallel_backends.py\", line 571, in terminate\r\n    delete_folder(self._workers._temp_folder)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\disk.py\", line 115, in delete_folder\r\n    shutil.rmtree(folder_path, False, None)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\shutil.py\", line 516, in rmtree\r\n    return _rmtree_unsafe(path, onerror)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\shutil.py\", line 400, in _rmtree_unsafe\r\n    onerror(os.unlink, fullname, sys.exc_info())\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\shutil.py\", line 398, in _rmtree_unsafe\r\n    os.unlink(fullname)\r\nPermissionError: [WinError 32] The process cannot access the file because it is being used by another process: 'C:\\\\Users\\\\msrwinadm4\\\\AppData\\\\Local\\\\Temp\\\\5\\\\joblib_memmapping_folder_11132_7308949288\\\\11132-1819792920136-683b9c4b033b449dbac251acbe3decfb.pkl'\r\nC:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\disk.py:122: UserWarning: Unable to delete folder C:\\Users\\msrwinadm4\\AppData\\Local\\Temp\\5\\joblib_memmapping_folder_11132_7308949288 after 5 tentatives.\r\n  .format(folder_path, RM_SUBDIRS_N_RETRY))\r\nC:\\ProgramData\\Anaconda3\\lib\\site-packages\\joblib\\_memmapping_reducer.py:409: UserWarning: Failed to clean temporary folder: C:\\Users\\msrwinadm4\\AppData\\Local\\Temp\\5\\joblib_memmapping_folder_11132_7308949288\r\n  .format(pool_folder))\r\n\r\n```\r\n\r\n## Your Environment\r\n* Python version: 3.7.6 (Anaconda)\r\n* graspologic version: 0.1.0.dev331219603\r\n* Windows 2016 Datacenter (448 GB RAM) x64\r\n\r\n## Additional Details\r\ngraspologic==0.1.0.dev331219603\r\njoblib==0.14.1\r\nhyppo==0.1.3\r\nscikit-image==0.16.2\r\nscikit-learn==0.22.1\r\nscipy==1.4.1\r\nnumpy==1.18.1\r\n\r\n## Underlying problem:\r\nOlder versions of joblib have a known issue running on Windows.  See https://github.com/joblib/joblib/issues/806.  This appears to be fixed on May 3rd, 2020 by https://github.com/joblib/joblib/pull/966.\r\n\r\nHyppo uses joblib as a transitive dependency of scikit-learn but does not declare it as a dependency.  Scikit-learn only requires joblib 0.11 which does not include this fix.  See https://github.com/scikit-learn/scikit-learn/blob/master/sklearn/_min_dependencies.py\r\n","closed_by":{"login":"jonmclean","id":4429525,"node_id":"MDQ6VXNlcjQ0Mjk1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4429525?v=4","gravatar_id":"","url":"https://api.github.com/users/jonmclean","html_url":"https://github.com/jonmclean","followers_url":"https://api.github.com/users/jonmclean/followers","following_url":"https://api.github.com/users/jonmclean/following{/other_user}","gists_url":"https://api.github.com/users/jonmclean/gists{/gist_id}","starred_url":"https://api.github.com/users/jonmclean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonmclean/subscriptions","organizations_url":"https://api.github.com/users/jonmclean/orgs","repos_url":"https://api.github.com/users/jonmclean/repos","events_url":"https://api.github.com/users/jonmclean/events{/privacy}","received_events_url":"https://api.github.com/users/jonmclean/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/graspologic/issues/582/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/graspologic/issues/582/timeline","performed_via_github_app":null,"state_reason":"completed"}