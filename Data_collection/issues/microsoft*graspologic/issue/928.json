{"url":"https://api.github.com/repos/microsoft/graspologic/issues/928","repository_url":"https://api.github.com/repos/microsoft/graspologic","labels_url":"https://api.github.com/repos/microsoft/graspologic/issues/928/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/graspologic/issues/928/comments","events_url":"https://api.github.com/repos/microsoft/graspologic/issues/928/events","html_url":"https://github.com/microsoft/graspologic/issues/928","id":1164969470,"node_id":"I_kwDOCM7Erc5FcAX-","number":928,"title":"[BUG] SBMEstimator is not right; it is systematically underbiased for loopless graphs","user":{"login":"ebridge2","id":8883547,"node_id":"MDQ6VXNlcjg4ODM1NDc=","avatar_url":"https://avatars.githubusercontent.com/u/8883547?v=4","gravatar_id":"","url":"https://api.github.com/users/ebridge2","html_url":"https://github.com/ebridge2","followers_url":"https://api.github.com/users/ebridge2/followers","following_url":"https://api.github.com/users/ebridge2/following{/other_user}","gists_url":"https://api.github.com/users/ebridge2/gists{/gist_id}","starred_url":"https://api.github.com/users/ebridge2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebridge2/subscriptions","organizations_url":"https://api.github.com/users/ebridge2/orgs","repos_url":"https://api.github.com/users/ebridge2/repos","events_url":"https://api.github.com/users/ebridge2/events{/privacy}","received_events_url":"https://api.github.com/users/ebridge2/received_events","type":"User","site_admin":false},"labels":[{"id":1048646805,"node_id":"MDU6TGFiZWwxMDQ4NjQ2ODA1","url":"https://api.github.com/repos/microsoft/graspologic/labels/bug","name":"bug","color":"cded2d","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-10T09:27:54Z","updated_at":"2022-04-13T16:37:31Z","closed_at":"2022-04-13T16:37:31Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"## Expected Behavior\r\n\r\nSBMEstimator does not seem to properly account for loops.\r\n\r\n## Actual Behavior\r\n\r\nI cannot find anywhere in the codebase to support that the loops are properly removed before estimating block probabilities. From what I gather, the SBMEstimator will first obtain block indices for each vertex https://github.com/microsoft/graspologic/blob/ff34382d1ffa0b7ea5f0e005525b7364f977e86f/graspologic/models/sbm_estimators.py#L208, and then move in the next line to calculate the block probability matrix https://github.com/microsoft/graspologic/blob/ff34382d1ffa0b7ea5f0e005525b7364f977e86f/graspologic/models/sbm_estimators.py#L212 but does not take an input for whether or not the network is directed, which feels like it should be critical. This probability is then computed https://github.com/microsoft/graspologic/blob/ff34382d1ffa0b7ea5f0e005525b7364f977e86f/graspologic/models/sbm_estimators.py#L482, which is then passed along to https://github.com/microsoft/graspologic/blob/ff34382d1ffa0b7ea5f0e005525b7364f977e86f/graspologic/models/base.py#L16, all of which are also performed ignorant whether or not there are loops, so I cannot possibly see how loops could be being properly accounted for. Seems unnecessarily tedious to trickle through with a debugger line-by-line, as I can just prove that this mishandle occurs using code instead.\r\n\r\n## Example Code\r\n\r\nThe below code simulates/fits an ER(10, 0.5) graph, and uses the fact that the adjustment factor for the probability is going to be n^2 in the computation (not right) instead of n*(n-1) (which is right). If this adjustment is handled wrong, we should be able to just account for it when producing our probability estimate, which is what I do below.\r\n\r\n```\r\nimport graspologic as gp\r\nimport numpy as np\r\n\r\nn = 10\r\nA = gp.simulations.er_np(n, 0.5, directed=False, loops=False)\r\n# fit it using graspologic\r\nfit_mod = gp.models.EREstimator(directed=False, loops=False).fit(A)\r\n\r\nprint(\"Estimate: {:.4f}\".format(fit_mod.p_))\r\n# if loops were improperly accounted for (e.g., ignored)\r\n# we should get the same answer for the next two...\r\n# the first one assumes that loops result in an overcount by a factor of n^2/(2*binom(n, 2)) based on how\r\n# graspologic's sbm handles directed networks (ignores)\r\nprint(\"Estimate (adjusted with assumption of loops being mishandled): {:.4f}\".format(fit_mod.p_ * (n**2/(n*(n-1)))))\r\n\r\ninds = np.triu_indices(n, k=1)\r\nprint(\"Correct answer: {:.4f}\".format(np.mean(A[inds])))\r\n```\r\n\r\nWhich produces:\r\n\r\n```\r\nEstimate: 0.5400\r\nEstimate (adjusted with assumption of loops being mishandled): 0.6000\r\nCorrect answer: 0.6000\r\n```\r\n\r\nThe first estimate is underbiased in all my attempts, whereas the second two are both *always* correct, which tells me that the diagonal is being ignored, as if the diagonal were not being ignored, these would otherwise not be giving the same answer.\r\n\r\n## Your Environment\r\n* Python version: 3.8.4\r\n* graspologic version: whatever is on master as of 3/10/2022; looks like 1.0.1\r\n\r\n## Additional Details\r\nAny other contextual information you might feel is important.\r\n","closed_by":{"login":"bdpedigo","id":25714207,"node_id":"MDQ6VXNlcjI1NzE0MjA3","avatar_url":"https://avatars.githubusercontent.com/u/25714207?v=4","gravatar_id":"","url":"https://api.github.com/users/bdpedigo","html_url":"https://github.com/bdpedigo","followers_url":"https://api.github.com/users/bdpedigo/followers","following_url":"https://api.github.com/users/bdpedigo/following{/other_user}","gists_url":"https://api.github.com/users/bdpedigo/gists{/gist_id}","starred_url":"https://api.github.com/users/bdpedigo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdpedigo/subscriptions","organizations_url":"https://api.github.com/users/bdpedigo/orgs","repos_url":"https://api.github.com/users/bdpedigo/repos","events_url":"https://api.github.com/users/bdpedigo/events{/privacy}","received_events_url":"https://api.github.com/users/bdpedigo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/graspologic/issues/928/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/graspologic/issues/928/timeline","performed_via_github_app":null,"state_reason":"completed"}