{"url":"https://api.github.com/repos/aiqm/torchani/issues/468","repository_url":"https://api.github.com/repos/aiqm/torchani","labels_url":"https://api.github.com/repos/aiqm/torchani/issues/468/labels{/name}","comments_url":"https://api.github.com/repos/aiqm/torchani/issues/468/comments","events_url":"https://api.github.com/repos/aiqm/torchani/issues/468/events","html_url":"https://github.com/aiqm/torchani/issues/468","id":627266713,"node_id":"MDU6SXNzdWU2MjcyNjY3MTM=","number":468,"title":"Memory consumption on CPU","user":{"login":"wiederm","id":31651017,"node_id":"MDQ6VXNlcjMxNjUxMDE3","avatar_url":"https://avatars.githubusercontent.com/u/31651017?v=4","gravatar_id":"","url":"https://api.github.com/users/wiederm","html_url":"https://github.com/wiederm","followers_url":"https://api.github.com/users/wiederm/followers","following_url":"https://api.github.com/users/wiederm/following{/other_user}","gists_url":"https://api.github.com/users/wiederm/gists{/gist_id}","starred_url":"https://api.github.com/users/wiederm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wiederm/subscriptions","organizations_url":"https://api.github.com/users/wiederm/orgs","repos_url":"https://api.github.com/users/wiederm/repos","events_url":"https://api.github.com/users/wiederm/events{/privacy}","received_events_url":"https://api.github.com/users/wiederm/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-05-29T13:25:00Z","updated_at":"2020-06-17T19:04:07Z","closed_at":"2020-06-17T18:50:49Z","author_association":"NONE","active_lock_reason":null,"body":"Dear torchani developers!\r\n\r\nI have been running a simple test with torchani 1.2 and torch 1.4.0 in which I calculate the energies of 100 molecules each with 10 heavy atoms in a batch. My coordinate tensor has the size `[100, 40, 3]` and I notice that the energy calculation has a substantial memory footprint, taking around 4 GB of RAM.\r\nHere is the output of the memory profiling (running this script https://gist.github.com/wiederm/4b8ebae991f26293905dd701f79f463c):\r\n\r\n```\r\nLine #    Mem usage    Increment   Line Contents\r\n================================================\r\n     5    143.9 MiB    143.9 MiB   @profile\r\n     6                             def setup():\r\n     7    143.9 MiB      0.0 MiB       nr_of_methans = 10\r\n     8    143.9 MiB      0.0 MiB       nr_of_frames = 100\r\n     9    143.9 MiB      0.0 MiB       device = 'cpu'\r\n    10    167.3 MiB     23.4 MiB       model = torchani.models.ANI1ccx(periodic_table_index=True).to(device)\r\n    11    167.3 MiB      0.0 MiB       coordinates = torch.tensor([[[0.03192167, 0.00638559, 0.01301679],\r\n    12    167.3 MiB      0.0 MiB                                   [-0.83140486, 0.39370209, -0.26395324],\r\n    13    167.3 MiB      0.0 MiB                                   [-0.66518241, -0.84461308, 0.20759389],\r\n    14    167.3 MiB      0.0 MiB                                   [0.45554739, 0.54289633, 0.81170881],\r\n    15    167.3 MiB      0.0 MiB                                   [0.66091919, -0.16799635, -0.91037834]]*nr_of_methans]*nr_of_frames,\r\n    16    167.3 MiB      0.0 MiB                               requires_grad=True, device=device)\r\n    17    167.3 MiB      0.0 MiB       species = torch.tensor([[6, 1, 1, 1, 1]*nr_of_methans]*nr_of_frames, device=device)\r\n    18   4016.9 MiB   3849.7 MiB       energy = model((species, coordinates)).energies\r\n```\r\n\r\nI am wondering if:\r\n- this is expected behaviour?\r\n- there is a possibility to minimize the RAM memory consumption?\r\n\r\nthank you very much for you time!","closed_by":{"login":"wiederm","id":31651017,"node_id":"MDQ6VXNlcjMxNjUxMDE3","avatar_url":"https://avatars.githubusercontent.com/u/31651017?v=4","gravatar_id":"","url":"https://api.github.com/users/wiederm","html_url":"https://github.com/wiederm","followers_url":"https://api.github.com/users/wiederm/followers","following_url":"https://api.github.com/users/wiederm/following{/other_user}","gists_url":"https://api.github.com/users/wiederm/gists{/gist_id}","starred_url":"https://api.github.com/users/wiederm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wiederm/subscriptions","organizations_url":"https://api.github.com/users/wiederm/orgs","repos_url":"https://api.github.com/users/wiederm/repos","events_url":"https://api.github.com/users/wiederm/events{/privacy}","received_events_url":"https://api.github.com/users/wiederm/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/aiqm/torchani/issues/468/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/aiqm/torchani/issues/468/timeline","performed_via_github_app":null,"state_reason":"completed"}