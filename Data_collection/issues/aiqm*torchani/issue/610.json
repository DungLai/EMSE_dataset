{"url":"https://api.github.com/repos/aiqm/torchani/issues/610","repository_url":"https://api.github.com/repos/aiqm/torchani","labels_url":"https://api.github.com/repos/aiqm/torchani/issues/610/labels{/name}","comments_url":"https://api.github.com/repos/aiqm/torchani/issues/610/comments","events_url":"https://api.github.com/repos/aiqm/torchani/issues/610/events","html_url":"https://github.com/aiqm/torchani/issues/610","id":1154571276,"node_id":"I_kwDOB5237M5E0VwM","number":610,"title":"Use ASE interface with constraints","user":{"login":"sli259","id":24900061,"node_id":"MDQ6VXNlcjI0OTAwMDYx","avatar_url":"https://avatars.githubusercontent.com/u/24900061?v=4","gravatar_id":"","url":"https://api.github.com/users/sli259","html_url":"https://github.com/sli259","followers_url":"https://api.github.com/users/sli259/followers","following_url":"https://api.github.com/users/sli259/following{/other_user}","gists_url":"https://api.github.com/users/sli259/gists{/gist_id}","starred_url":"https://api.github.com/users/sli259/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sli259/subscriptions","organizations_url":"https://api.github.com/users/sli259/orgs","repos_url":"https://api.github.com/users/sli259/repos","events_url":"https://api.github.com/users/sli259/events{/privacy}","received_events_url":"https://api.github.com/users/sli259/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-28T21:30:22Z","updated_at":"2022-03-01T14:49:34Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi, I am trying to use the ANI2x and ASE interface to do MD simulation with constraints. I found once I apply the bond length constraints, the simulation will fail with the converge issue.\r\n\r\nHere is an example code I used. There won't be an issue if I use the native TIP3P calculator to replace the ANI2x. I do want to use the ANI2x for my small molecules, is there a way to work with the bond length constraints?\r\n\r\nThanks!\r\n\r\n```\r\n\r\nfrom ase import Atoms\r\nfrom ase.constraints import FixBondLengths\r\nfrom ase.md import Langevin\r\nfrom ase.optimize import BFGS\r\nimport ase.units as units\r\nfrom ase.io.trajectory import Trajectory\r\nimport numpy as np\r\nimport torchani\r\n\r\n# Set up water box at 20 deg C density\r\nx = angleHOH * np.pi / 180 / 2\r\npos = [[0, 0, 0],\r\n       [0, rOH * np.cos(x), rOH * np.sin(x)],\r\n       [0, rOH * np.cos(x), -rOH * np.sin(x)]]\r\natoms = Atoms('OH2', positions=pos)\r\n\r\nvol = ((18.01528 / 6.022140857e23) / (0.9982 / 1e24))**(1 / 3.)\r\natoms.set_cell((vol, vol, vol))\r\natoms.center()\r\n\r\natoms = atoms.repeat((3, 3, 3))\r\natoms.set_pbc(True)\r\n\r\n# RATTLE-type constraints on O-H1, O-H2, H1-H2.\r\natoms.constraints = FixBondLengths([(3 * i + j, 3 * i + (j + 1) % 3)\r\n                                    for i in range(3**3)\r\n                                    for j in [0, 1, 2]])\r\n\r\n\r\ncalculator = torchani.models.ANI2x().ase()\r\natoms.set_calculator(calculator)\r\n# atoms.calc = TIP3P(rc=4.5)\r\n\r\nprint(\"Begin minimizing...\")\r\nopt = BFGS(atoms)\r\ntraj = Trajectory('opt.traj', 'w', atoms)\r\nopt.attach(traj)\r\nopt.run(fmax=0.001)\r\nprint()\r\n\r\ndef printenergy(a=atoms):\r\n    \"\"\"Function to print the potential, kinetic and total energy.\"\"\"\r\n    epot = a.get_potential_energy() / len(a)\r\n    ekin = a.get_kinetic_energy() / len(a)\r\n    print('Energy per atom: Epot = %.3feV  Ekin = %.3feV (T=%3.0fK)  '\r\n          'Etot = %.3feV' % (epot, ekin, ekin / (1.5 * units.kB), epot + ekin))\r\n    \r\ndyn = Langevin(atoms, 1 * units.fs, 300 * units.kB, 0.2)\r\ndyn.attach(printenergy, interval=50)\r\n\r\nprint(\"Beginning dynamics...\")\r\nprintenergy()\r\ndyn.run(500)\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/aiqm/torchani/issues/610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/aiqm/torchani/issues/610/timeline","performed_via_github_app":null,"state_reason":null}