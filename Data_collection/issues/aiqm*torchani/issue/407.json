{"url":"https://api.github.com/repos/aiqm/torchani/issues/407","repository_url":"https://api.github.com/repos/aiqm/torchani","labels_url":"https://api.github.com/repos/aiqm/torchani/issues/407/labels{/name}","comments_url":"https://api.github.com/repos/aiqm/torchani/issues/407/comments","events_url":"https://api.github.com/repos/aiqm/torchani/issues/407/events","html_url":"https://github.com/aiqm/torchani/issues/407","id":547035806,"node_id":"MDU6SXNzdWU1NDcwMzU4MDY=","number":407,"title":"Error converting model to TorchScript","user":{"login":"peastman","id":4379786,"node_id":"MDQ6VXNlcjQzNzk3ODY=","avatar_url":"https://avatars.githubusercontent.com/u/4379786?v=4","gravatar_id":"","url":"https://api.github.com/users/peastman","html_url":"https://github.com/peastman","followers_url":"https://api.github.com/users/peastman/followers","following_url":"https://api.github.com/users/peastman/following{/other_user}","gists_url":"https://api.github.com/users/peastman/gists{/gist_id}","starred_url":"https://api.github.com/users/peastman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peastman/subscriptions","organizations_url":"https://api.github.com/users/peastman/orgs","repos_url":"https://api.github.com/users/peastman/repos","events_url":"https://api.github.com/users/peastman/events{/privacy}","received_events_url":"https://api.github.com/users/peastman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2020-01-08T18:39:58Z","updated_at":"2020-01-21T18:44:43Z","closed_at":"2020-01-21T18:44:42Z","author_association":"NONE","active_lock_reason":null,"body":"I'm using TorchANI with the PyTorch plugin for OpenMM (https://github.com/peastman/openmm-torch).  I just updated to the latest TorchANI code, and some change made in the last few months has broken my code.  To use the OpenMM plugin, I need to convert the model to TorchScript and save it to a file.  And in fact the following still works:\r\n\r\n```python\r\nmodel = torchani.models.ANI1ccx()\r\nmodule = torch.jit.script(model[0])\r\n```\r\n\r\nBut the plugin requires the inputs and outputs to have a slightly different format and units, so I created a class to act as an adapter:\r\n\r\n```python\r\nclass ANIForce(torch.nn.Module):\r\n\r\n    def __init__(self, model, species):\r\n        super(ANIForce, self).__init__()\r\n        self.model = model\r\n        self.species = species\r\n    \r\n    def forward(self, positions):\r\n        _, energy = self.model((self.species, 10.0*positions.unsqueeze(0)))\r\n        return 2625.5000885335317*energy\r\n\r\nforce = ANIForce(model[0], species)\r\nmodule = torch.jit.script(force)\r\n```\r\n\r\nPreviously this worked, but after updating to the latest TorchANI code it throws an exception:\r\n\r\n```\r\nRuntimeError: \r\nModule '_ConstModuleList' has no attribute 'forward' :\r\nat modelPdb.py:30:20\r\n    def forward(self, positions):\r\n        _, energy = self.model((self.species, 10.0*positions.unsqueeze(0)))\r\n                    ~~~~~~~~~~ <--- HERE\r\n        return 2625.5000885335317*energy\r\n```\r\n\r\nCan you provide advice on what I need to do to fix it?","closed_by":{"login":"peastman","id":4379786,"node_id":"MDQ6VXNlcjQzNzk3ODY=","avatar_url":"https://avatars.githubusercontent.com/u/4379786?v=4","gravatar_id":"","url":"https://api.github.com/users/peastman","html_url":"https://github.com/peastman","followers_url":"https://api.github.com/users/peastman/followers","following_url":"https://api.github.com/users/peastman/following{/other_user}","gists_url":"https://api.github.com/users/peastman/gists{/gist_id}","starred_url":"https://api.github.com/users/peastman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peastman/subscriptions","organizations_url":"https://api.github.com/users/peastman/orgs","repos_url":"https://api.github.com/users/peastman/repos","events_url":"https://api.github.com/users/peastman/events{/privacy}","received_events_url":"https://api.github.com/users/peastman/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/aiqm/torchani/issues/407/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/aiqm/torchani/issues/407/timeline","performed_via_github_app":null,"state_reason":"completed"}