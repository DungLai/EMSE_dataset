{"url":"https://api.github.com/repos/aiqm/torchani/issues/586","repository_url":"https://api.github.com/repos/aiqm/torchani","labels_url":"https://api.github.com/repos/aiqm/torchani/issues/586/labels{/name}","comments_url":"https://api.github.com/repos/aiqm/torchani/issues/586/comments","events_url":"https://api.github.com/repos/aiqm/torchani/issues/586/events","html_url":"https://github.com/aiqm/torchani/issues/586","id":832085214,"node_id":"MDU6SXNzdWU4MzIwODUyMTQ=","number":586,"title":"Error when converting model to TorchScript","user":{"login":"peastman","id":4379786,"node_id":"MDQ6VXNlcjQzNzk3ODY=","avatar_url":"https://avatars.githubusercontent.com/u/4379786?v=4","gravatar_id":"","url":"https://api.github.com/users/peastman","html_url":"https://github.com/peastman","followers_url":"https://api.github.com/users/peastman/followers","following_url":"https://api.github.com/users/peastman/following{/other_user}","gists_url":"https://api.github.com/users/peastman/gists{/gist_id}","starred_url":"https://api.github.com/users/peastman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peastman/subscriptions","organizations_url":"https://api.github.com/users/peastman/orgs","repos_url":"https://api.github.com/users/peastman/repos","events_url":"https://api.github.com/users/peastman/events{/privacy}","received_events_url":"https://api.github.com/users/peastman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-03-15T18:34:43Z","updated_at":"2021-10-29T20:29:35Z","closed_at":"2021-10-29T20:29:35Z","author_association":"NONE","active_lock_reason":null,"body":"TorchANI models do not work correctly when they are converted to TorchScript.  I'm pretty sure this is a PyTorch bug, but you should be aware of it, and perhaps you can find a workaround.  The following script demonstrates the problem using PyTorch 1.7.1.\r\n\r\n```python\r\nimport torch\r\nimport torchani\r\n\r\ndevice = torch.device('cuda')\r\nspecies = torch.tensor([[2, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0]]).to(device)\r\npositions = torch.tensor([[\r\n    [19.8102, 18.8292, 37.9237],\r\n    [18.5426, 19.4376, 38.3537],\r\n    [20.8406, 19.9389, 38.3717],\r\n    [20.0545, 17.8716, 37.4475],\r\n    [20.6924, 15.5844, 39.6175],\r\n    [19.8118, 20.1167, 36.7419],\r\n    [19.2987, 20.0335, 36.7371],\r\n    [18.6676, 23.4357, 36.8353],\r\n    [20.7095, 18.4540, 36.3641],\r\n    [19.3523, 18.2274, 36.3663],\r\n    [20.8299, 15.0725, 34.6570],\r\n    [20.2751, 20.4366, 35.4269],\r\n    [18.6964, 20.1698, 35.4341],\r\n    [19.4113, 20.8338, 35.7119],\r\n    [20.6836, 18.2203, 33.5049],\r\n    [19.8220, 18.9653, 32.5260],\r\n    [19.3635, 17.9477, 33.4874]]], dtype=torch.float32).to(device)\r\nmodel = torchani.models.ANI1ccx().to(device)\r\nmodule = torch.jit.script(model)\r\nprint(module((species, positions)))\r\nprint(module((species, positions)))\r\n```\r\n\r\nIt fails with this exception.\r\n\r\n```\r\nRuntimeError: The following operation failed in the TorchScript interpreter.\r\nTraceback of TorchScript (most recent call last):\r\n  File \"/home/peastman/miniconda3/envs/openmm/lib/python3.8/site-packages/torchani/aev.py\", line 440, in forward\r\n\r\n        if cell is None and pbc is None:\r\n            aev = compute_aev(species, coordinates, self.triu_index, self.constants(), self.sizes, None)\r\n                  ~~~~~~~~~~~ <--- HERE\r\n        else:\r\n            assert (cell is not None and pbc is not None)\r\n  File \"/home/peastman/miniconda3/envs/openmm/lib/python3.8/site-packages/torchani/aev.py\", line 305, in compute_aev\r\n\r\n    # compute angular aev\r\n    central_atom_index, pair_index12, sign12 = triple_by_molecule(atom_index12)\r\n                                               ~~~~~~~~~~~~~~~~~~ <--- HERE\r\n    species12_small = species12[:, pair_index12]\r\n    vec12 = vec.index_select(0, pair_index12.view(-1)).view(2, -1, 3) * sign12.unsqueeze(-1)\r\n  File \"/home/peastman/miniconda3/envs/openmm/lib/python3.8/site-packages/torchani/aev.py\", line 250, in triple_by_molecule\r\n    print(pair_sizes)\r\n    print(sorted_local_index12.shape, pair_indices.shape, intra_pair_indices.shape, atom_index12.shape, mask.shape)\r\n    sorted_local_index12 += cumsum_from_zero(counts).index_select(0, pair_indices)\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ <--- HERE\r\n\r\n    # unsort result from last part\r\nRuntimeError: The size of tensor a (679) must match the size of tensor b (699) at non-singleton dimension 1\r\n```\r\n\r\nImportant points:\r\n\r\n- This only happens when the model is compiled to TorchScript.\r\n- It only happens with CUDA, not CPU.\r\n- The error only happens the second time the model is invoked.\r\n\r\nI tried to debug it a bit further, and I believe the error is happening in this line:\r\n\r\nhttps://github.com/aiqm/torchani/blob/2007d181c1d650e28ee4e2c6a5f8e74fae54d6bf/torchani/aev.py#L249\r\n\r\nI print out both `counts` and `pair_sizes`, and I can see that the second time it is invoked, `pair_sizes` is computed incorrectly:\r\n\r\n```\r\n 10\r\n  9\r\n  9\r\n 11\r\n  1\r\n 10\r\n 11\r\n  2\r\n 12\r\n 12\r\n  2\r\n 12\r\n 12\r\n 11\r\n  7\r\n  4\r\n  7\r\n[ CUDALongType{17} ]\r\n 49\r\n 40\r\n 40\r\n 60\r\n  0\r\n 49\r\n 60\r\n  1\r\n 71\r\n 71\r\n  1\r\n 71\r\n 71\r\n 60\r\n 24\r\n  7\r\n 24\r\n```\r\n\r\nFor example, the first element should be 10\\*9/2 = 45, not 49.","closed_by":{"login":"yueyericardo","id":9999318,"node_id":"MDQ6VXNlcjk5OTkzMTg=","avatar_url":"https://avatars.githubusercontent.com/u/9999318?v=4","gravatar_id":"","url":"https://api.github.com/users/yueyericardo","html_url":"https://github.com/yueyericardo","followers_url":"https://api.github.com/users/yueyericardo/followers","following_url":"https://api.github.com/users/yueyericardo/following{/other_user}","gists_url":"https://api.github.com/users/yueyericardo/gists{/gist_id}","starred_url":"https://api.github.com/users/yueyericardo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yueyericardo/subscriptions","organizations_url":"https://api.github.com/users/yueyericardo/orgs","repos_url":"https://api.github.com/users/yueyericardo/repos","events_url":"https://api.github.com/users/yueyericardo/events{/privacy}","received_events_url":"https://api.github.com/users/yueyericardo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/aiqm/torchani/issues/586/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/aiqm/torchani/issues/586/timeline","performed_via_github_app":null,"state_reason":"completed"}