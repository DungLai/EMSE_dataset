{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/397","id":546289521,"node_id":"MDU6SXNzdWU1NDYyODk1MjE=","number":397,"title":"ernie tiny 的finetune_classifier异常","user":{"login":"leyiwang","id":10727709,"node_id":"MDQ6VXNlcjEwNzI3NzA5","avatar_url":"https://avatars.githubusercontent.com/u/10727709?v=4","gravatar_id":"","url":"https://api.github.com/users/leyiwang","html_url":"https://github.com/leyiwang","followers_url":"https://api.github.com/users/leyiwang/followers","following_url":"https://api.github.com/users/leyiwang/following{/other_user}","gists_url":"https://api.github.com/users/leyiwang/gists{/gist_id}","starred_url":"https://api.github.com/users/leyiwang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leyiwang/subscriptions","organizations_url":"https://api.github.com/users/leyiwang/orgs","repos_url":"https://api.github.com/users/leyiwang/repos","events_url":"https://api.github.com/users/leyiwang/events{/privacy}","received_events_url":"https://api.github.com/users/leyiwang/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-01-07T13:40:45Z","updated_at":"2020-01-08T08:57:43Z","closed_at":"2020-01-08T08:57:43Z","author_association":"NONE","active_lock_reason":null,"body":"下载了ernie tiny的config, 启动finetune_classifier时，参照reademe的说明：\r\n# 1 线上GPU 容器环境下：\r\n```\r\nERNIE tiny 模型采用了subword粒度输入，需要在数据前处理中加入切词(segmentation)并使用sentence piece进行tokenization. segmentation 以及 tokenization 需要使用的模型包含在了 ERNIE tiny 的预训练模型文件中，分别是 ./subword/dict.wordseg.pickle 和 ./subword/spm_cased_simp_sampled.model.\r\n目前./example/下的代码针对 ERNIE tiny 的前处理进行了适配只需在脚本中通过 --sentence_piece_model 引入tokenization 模型，再通过 --word_dict 引入 segmentation 模型之后即可进行 ERNIE tiny 的 Fine-tune。\r\n```\r\n指定了--sentence_piece_model 和--word_dict参数，\r\n```\r\n# for ernie tiny\r\npython3.6 ernie/finetune_classifier.py \\\r\n    --data_dir ${TASK_DATA_PATH}/chnsenticorp/  \\\r\n    --warm_start_from ${MODEL_PATH}/params \\\r\n    --vocab_file ${MODEL_PATH}/vocab.txt \\\r\n    --max_seqlen 128 \\\r\n    --sentence_piece_model ${MODEL_PATH}/subword/spm_cased_simp_sampled.model \\\r\n    --word_dict ${MODEL_PATH}/subword/dict.wordseg.pickle \\\r\n    --run_config '{\r\n        \"model_dir\": \"output\",\r\n        \"max_steps\": '$((10 * 9600 / 32))',\r\n        \"save_steps\": 100,\r\n        \"log_steps\": 10,\r\n        \"max_ckpt\": 1,\r\n        \"skip_steps\": 0,\r\n        \"eval_steps\": 100\r\n    }' \\\r\n    --hparam ${MODEL_PATH}/ernie_config.json \\\r\n    --hparam '{ # model definition\r\n        \"sent_type_vocab_size\": None,    # default term in official config\r\n        \"use_task_id\": False,\r\n        \"task_id\": 0,\r\n        }' \\\r\n    --hparam '{ # learn\r\n      \"warmup_proportion\":  0.1,\r\n      \"weight_decay\": 0.01,\r\n      \"use_fp16\": 0,\r\n      \"learning_rate\": 0.00005,\r\n      \"num_label\": 2,\r\n      \"batch_size\": 32\r\n    }'\r\n```\r\n![B8C6E20AF49CF70A3E3D59490](https://user-images.githubusercontent.com/10727709/71900819-85a28780-3199-11ea-8995-5f2957995e81.jpg)\r\n# 2 本地mac环境下\r\n线上gpu环境下的docker容器里的ernie tiny 的finetune是使用github上的ernie代码，根据readme说明下载了相关的数据、模型文件，修改了启动的python命令，跑的，报https://github.com/PaddlePaddle/ERNIE/issues/397的错误。\r\n\r\n因为本地没有gpu，直接跑会报错，我根据错误提示将几处cuda_places替换为cpu_places，发现本地用cpu可以跑通，不再报类型转换的错误。 **但是线上gpu环境下的代码和本地差的就是这几处cpu_places的替换，数据、模型一致，却报了类型转换错误。**\r\n```\r\n...\r\n[INFO] 2020-01-08 12:42:39,990 [monitored_executor.py:  230]:\twarm start: encoder_layer_2_post_ffn_layer_norm_bias\r\n[INFO] 2020-01-08 12:42:39,990 [monitored_executor.py:  230]:\twarm start: pooled_fc.w_0\r\n[INFO] 2020-01-08 12:42:39,990 [monitored_executor.py:  230]:\twarm start: pooled_fc.b_0\r\n[DEBUG] 2020-01-08 12:42:41,849 [monitored_executor.py:  281]:\tfreezing program\r\n[INFO] 2020-01-08 12:42:41,849 [monitored_executor.py:  269]:\treplica id 0 of 1\r\n[DEBUG] 2020-01-08 12:42:41,884 [monitored_executor.py:  283]:\tdone freezing\r\n[INFO] 2020-01-08 12:42:41,884 [monitored_executor.py:  284]:\t********** Start Loop ************\r\n[DEBUG] 2020-01-08 12:42:41,884 [monitored_executor.py:  289]:\ttrain loop has hook <propeller.paddle.train.hooks.StopAtStepHook object at 0x12d108cc0>\r\n[DEBUG] 2020-01-08 12:42:41,885 [monitored_executor.py:  289]:\ttrain loop has hook <propeller.paddle.train.hooks.LoggingHook object at 0x12d29c5c0>\r\n[DEBUG] 2020-01-08 12:42:41,885 [monitored_executor.py:  289]:\ttrain loop has hook <propeller.paddle.train.trainer.train_and_eval.<locals>.EvalHookOnTrainLoop object at 0x1391a93c8>\r\n[DEBUG] 2020-01-08 12:42:41,885 [monitored_executor.py:  289]:\ttrain loop has hook <propeller.paddle.train.hooks.CheckpointSaverHook object at 0x12d2d3080>\r\nI0108 12:42:42.160605 3072451456 parallel_executor.cc:421] The number of CPUPlace, which is used in ParallelExecutor, is 1. And the Program will be copied 1 copies\r\nI0108 12:42:42.206982 3072451456 build_strategy.cc:363] SeqOnlyAllReduceOps:0, num_trainers:1\r\nI0108 12:42:42.243758 3072451456 parallel_executor.cc:285] Inplace strategy is enabled, when build_strategy.enable_inplace = True\r\nI0108 12:42:42.325690 3072451456 parallel_executor.cc:315] Cross op memory reuse strategy is enabled, when build_strategy.memory_optimize = True or garbage collection strategy is disabled, which is not recommended\r\nI0108 12:42:42.351922 3072451456 parallel_executor.cc:368] Garbage collection strategy is enabled, when FLAGS_eager_delete_tensor_gb = 0\r\n[DEBUG] 2020-01-08 12:47:09,765 [    hooks.py:  207]:\tstep: 10\tsteps/sec: -1.00000\tloss: 0.77125\tlr:[1.6666667e-06]\r\n[DEBUG] 2020-01-08 12:51:13,554 [    hooks.py:  207]:\tstep: 20\tsteps/sec: 0.03969\tloss: 0.77323\tlr:[3.3333333e-06]\r\n[DEBUG] 2020-01-08 12:56:19,886 [    hooks.py:  207]:\tstep: 30\tsteps/sec: 0.03903\tloss: 0.71317\tlr:[5.e-06]\r\n[INFO] 2020-01-08 12:59:26,841 [monitored_executor.py:  336]:\t********** Stop Loop ************\r\n```","closed_by":{"login":"leyiwang","id":10727709,"node_id":"MDQ6VXNlcjEwNzI3NzA5","avatar_url":"https://avatars.githubusercontent.com/u/10727709?v=4","gravatar_id":"","url":"https://api.github.com/users/leyiwang","html_url":"https://github.com/leyiwang","followers_url":"https://api.github.com/users/leyiwang/followers","following_url":"https://api.github.com/users/leyiwang/following{/other_user}","gists_url":"https://api.github.com/users/leyiwang/gists{/gist_id}","starred_url":"https://api.github.com/users/leyiwang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leyiwang/subscriptions","organizations_url":"https://api.github.com/users/leyiwang/orgs","repos_url":"https://api.github.com/users/leyiwang/repos","events_url":"https://api.github.com/users/leyiwang/events{/privacy}","received_events_url":"https://api.github.com/users/leyiwang/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/397/timeline","performed_via_github_app":null,"state_reason":"completed"}