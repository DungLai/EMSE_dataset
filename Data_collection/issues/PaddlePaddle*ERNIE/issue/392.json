{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/392","id":544732332,"node_id":"MDU6SXNzdWU1NDQ3MzIzMzI=","number":392,"title":"Missing use_task_id in pre-trained ERNIE-en-base","user":{"login":"winston-zillow","id":26907141,"node_id":"MDQ6VXNlcjI2OTA3MTQx","avatar_url":"https://avatars.githubusercontent.com/u/26907141?v=4","gravatar_id":"","url":"https://api.github.com/users/winston-zillow","html_url":"https://github.com/winston-zillow","followers_url":"https://api.github.com/users/winston-zillow/followers","following_url":"https://api.github.com/users/winston-zillow/following{/other_user}","gists_url":"https://api.github.com/users/winston-zillow/gists{/gist_id}","starred_url":"https://api.github.com/users/winston-zillow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/winston-zillow/subscriptions","organizations_url":"https://api.github.com/users/winston-zillow/orgs","repos_url":"https://api.github.com/users/winston-zillow/repos","events_url":"https://api.github.com/users/winston-zillow/events{/privacy}","received_events_url":"https://api.github.com/users/winston-zillow/received_events","type":"User","site_admin":false},"labels":[{"id":1256169225,"node_id":"MDU6TGFiZWwxMjU2MTY5MjI1","url":"https://api.github.com/repos/PaddlePaddle/ERNIE/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-01-02T20:24:10Z","updated_at":"2020-05-28T09:52:47Z","closed_at":"2020-05-28T09:52:47Z","author_association":"NONE","active_lock_reason":null,"body":"Download ` https://ernie.bj.bcebos.com/ERNIE_Base_en_stable-2.0.0.tar.gz`, uncompress and the `ernie_config.json` does not have a value for `use_task_id`.\r\n\r\n```json\r\n{\r\n  \"attention_probs_dropout_prob\": 0.1, \r\n  \"hidden_act\": \"gelu\", \r\n  \"hidden_dropout_prob\": 0.1, \r\n  \"hidden_size\": 768, \r\n  \"initializer_range\": 0.02, \r\n  \"max_position_embeddings\": 512, \r\n  \"num_attention_heads\": 12, \r\n  \"num_hidden_layers\": 12, \r\n  \"sent_type_vocab_size\": 4, \r\n  \"task_type_vocab_size\": 16, \r\n  \"vocab_size\": 30522\r\n}\r\n```\r\n\r\nAs a consequence, when attempting to save the model using `save_inference_model` (so that I can convert it to ONNX using the paddle2onnx tool), it would complain the task id input is missing after pruning the model for inference inside `save_inference_model` as shown in my debug outputs by modifying the save method locally:\r\n\r\n```text\r\ncloned 2 -> read_file_0.tmp_0 VarType.LOD_TENSOR False\r\ncloned 6 -> _input_reader_reader VarType.READER True\r\ncloned 32 -> read_file_0.tmp_6 VarType.LOD_TENSOR False\r\ncloned 41 -> read_file_0.tmp_5 VarType.LOD_TENSOR False\r\ncloned 44 -> read_file_0.tmp_4 VarType.LOD_TENSOR False\r\ncloned 63 -> read_file_0.tmp_1 VarType.LOD_TENSOR False\r\ncloned 219 -> read_file_0.tmp_3 VarType.LOD_TENSOR False\r\ncloned 374 -> read_file_0.tmp_2 VarType.LOD_TENSOR False\r\npruned 116 -> read_file_0.tmp_4 VarType.LOD_TENSOR False\r\npruned 117 -> read_file_0.tmp_0 VarType.LOD_TENSOR False\r\npruned 129 -> read_file_0.tmp_1 VarType.LOD_TENSOR False\r\npruned 718 -> read_file_0.tmp_2 VarType.LOD_TENSOR False\r\n```\r\n\r\nFor your reference, my model saving codes look like\r\n\r\n```python\r\n# cloned and modified from `ernie/finetune/classifier`\r\ndef create_model(args,\r\n                 pyreader_name,\r\n                 ernie_config,\r\n                 is_prediction=False,\r\n                 task_name=\"\",\r\n                 is_classify=False,\r\n                 is_regression=False,\r\n                 ernie_version=\"1.0\"):\r\n     ...\r\n    (src_ids, sent_ids, pos_ids, task_ids, input_mask, labels,\r\n     qids) = fluid.layers.read_file(pyreader)\r\n\r\n    ernie = ErnieModel(\r\n    ...\r\n    cls_feats = ernie.get_pooled_output()\r\n    inputs = (src_ids, sent_ids, pos_ids, task_ids, input_mask)\r\n    return inputs, cls_feats, pyreader, (labels, qids)\r\n\r\n# imitating `run_classifier.py`\r\nstartup_prog = fluid.Program()\r\ntrain_program = fluid.Program()\r\n\r\nwith fluid.program_guard(train_program, startup_prog):\r\n    with fluid.unique_name.guard():\r\n        inputs, ernie_latent, train_pyreader, _ = create_model(\r\n            args,\r\n            pyreader_name='input_reader',\r\n            ernie_config=ernie_config,\r\n            is_classify=args.is_classify,\r\n            is_regression=args.is_regression)\r\n\r\n        # exe.run(startup_prog) . # i think there is no need to run this\r\n        init_pretraining_params(\r\n            exe,\r\n            args.init_pretraining_params,\r\n            main_program=startup_prog,\r\n            use_fp16=args.use_fp16)\r\n    fluid.io.save_inference_model(dirname=\"/ernie_onnx_path\",\r\n                                 feeded_var_names=[var.name for var in inputs],\r\n                                 target_vars=[ernie_latent],\r\n                                 main_program=train_program,\r\n                                 executor=exe)\r\n```\r\n\r\nAfter I set `use_task_id` to `true` in the config file, saving the inference model will work. Please confirm if that's the right fix (and fix the pre-trained archive.)","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/392/timeline","performed_via_github_app":null,"state_reason":"completed"}