{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/694","id":915940393,"node_id":"MDU6SXNzdWU5MTU5NDAzOTM=","number":694,"title":"ERNIE-VIL下游任务测试结果不稳定","user":{"login":"ELFEamp","id":40513738,"node_id":"MDQ6VXNlcjQwNTEzNzM4","avatar_url":"https://avatars.githubusercontent.com/u/40513738?v=4","gravatar_id":"","url":"https://api.github.com/users/ELFEamp","html_url":"https://github.com/ELFEamp","followers_url":"https://api.github.com/users/ELFEamp/followers","following_url":"https://api.github.com/users/ELFEamp/following{/other_user}","gists_url":"https://api.github.com/users/ELFEamp/gists{/gist_id}","starred_url":"https://api.github.com/users/ELFEamp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ELFEamp/subscriptions","organizations_url":"https://api.github.com/users/ELFEamp/orgs","repos_url":"https://api.github.com/users/ELFEamp/repos","events_url":"https://api.github.com/users/ELFEamp/events{/privacy}","received_events_url":"https://api.github.com/users/ELFEamp/received_events","type":"User","site_admin":false},"labels":[{"id":1256169225,"node_id":"MDU6TGFiZWwxMjU2MTY5MjI1","url":"https://api.github.com/repos/PaddlePaddle/ERNIE/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-06-09T08:33:02Z","updated_at":"2021-10-11T04:24:21Z","closed_at":"2021-10-11T04:24:21Z","author_association":"NONE","active_lock_reason":null,"body":"您好，我在一个和VCR类似的下游任务（复用了VCR那部分的代码）上finetuning了erniesmall，但测试时发现，同一个val或者test划分，得到的准确率虽然接近，并不相同，为了排除数据集的问题，我将某条数据复制了1000倍，作为验证集进行测试，发现每次测试的结果都不尽相同。这里贴出了三次运行的结果：\r\n**第一次**\r\n```\r\n~/vilio/vilio/ernie-vil$ python test_run.py \r\n\r\nfinetuning tasks start\r\nattention_probs_dropout_prob: 0.1\r\nclass_attr_size: 401\r\nclass_size: 1601\r\nco_hidden_size: 1024\r\nco_intermediate_size: 1024\r\nco_num_attention_heads: 8\r\nhidden_act: gelu\r\nhidden_dropout_prob: 0.1\r\nhidden_size: 768\r\ninitializer_range: 0.02\r\nmax_position_embeddings: 512\r\nnum_attention_heads: 12\r\nnum_hidden_layers: 12\r\nsent_type_vocab_size: 4\r\nt_biattention_id: [6, 7, 8, 9, 10, 11]\r\ntask_type_vocab_size: 16\r\ntype_vocab_size: 2\r\nv_biattention_id: [0, 1, 2, 3, 4, 5]\r\nv_hidden_size: 1024\r\nv_intermediate_size: 1024\r\nv_num_attention_heads: 8\r\nvocab_size: 30522\r\n------------------------------------------------\r\ntask:  [{'task': 'PMR', 'num_choice': 4, 'annotations_jsonpath_train': './data/pmr/annotations/train.jsonl', 'annotations_jsonpath_val': './data/pmr/annotations/val.jsonl', 'annotations_jsonpath_test': './data/pmr/annotations/test.jsonl', 'feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'gt_feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'unisex_names_table': './data/pmr/annotations/unisex_names_table.csv', 'Proprocessor': 'PreprocessorBasic', 'tokenizer_name': 'FullTokenizer', 'tagger_path': './script/ntc.pickle', 'nltk_data_path': './nltk_data', 'fusion_method': 'mul', 'dropout_rate': 0.1, 'max_seq_len': 60, 'use_gt_fea': False, 'task_prefix': 'pmr'}]\r\n2021-06-09 16:19:43,389-WARNING: paddle.fluid.layers.py_reader() may be deprecated in the near future. Please use paddle.fluid.io.DataLoader.from_generator() instead.\r\ntheoretical memory usage: \r\n(5271.439203643799, 5522.4601181030275, 'MB')\r\nW0609 16:19:44.479754 15199 device_context.cc:252] Please NOTE: device: 4, CUDA Capability: 75, Driver API Version: 11.2, Runtime API Version: 9.0\r\nW0609 16:19:44.481159 15199 device_context.cc:260] device: 4, cuDNN Version: 8.0.\r\nStart to load Faster-RCNN detected objects from ./data/pmr/annotations/pmr_10-36.tsv\r\nLoaded 1 images in file ./data/pmr/annotations/pmr_10-36.tsv in 23 seconds.\r\nonly butd feature\r\nLoad pretraining parameters from ./output_pmr/step_15000train.\r\ntesting on pmr val split\r\ntask name list :  ['mean_0.tmp_0', 'accuracy_0.tmp_0', 'arg_max_0.tmp_0', 'read_file_0.tmp_9', 'read_file_0.tmp_8', 'reshape2_120.tmp_0']\r\ncur_step: 10 cur_acc: 1.0\r\ncur_step: 20 cur_acc: 1.0\r\ncur_step: 30 cur_acc: 1.0\r\ncur_step: 40 cur_acc: 0.9984375\r\ncur_step: 50 cur_acc: 0.99875\r\ncur_step: 60 cur_acc: 0.9979166666666667\r\nEXCEPTING\r\nLEN: 1075 1075\r\n<class 'pandas.core.frame.DataFrame'>\r\nRangeIndex: 1075 entries, 0 to 1074\r\nData columns (total 3 columns):\r\n #   Column  Non-Null Count  Dtype  \r\n---  ------  --------------  -----  \r\n 0   id      1075 non-null   int64  \r\n 1   proba   1075 non-null   float64\r\n 2   label   1075 non-null   int64  \r\ndtypes: float64(1), int64(2)\r\nmemory usage: 25.3 KB\r\nNone\r\naverage_acc: 0.9981617647058824\r\n\r\n```\r\n### 第二次\r\n```\r\nfinetuning tasks start\r\nattention_probs_dropout_prob: 0.1\r\nclass_attr_size: 401\r\nclass_size: 1601\r\nco_hidden_size: 1024\r\nco_intermediate_size: 1024\r\nco_num_attention_heads: 8\r\nhidden_act: gelu\r\nhidden_dropout_prob: 0.1\r\nhidden_size: 768\r\ninitializer_range: 0.02\r\nmax_position_embeddings: 512\r\nnum_attention_heads: 12\r\nnum_hidden_layers: 12\r\nsent_type_vocab_size: 4\r\nt_biattention_id: [6, 7, 8, 9, 10, 11]\r\ntask_type_vocab_size: 16\r\ntype_vocab_size: 2\r\nv_biattention_id: [0, 1, 2, 3, 4, 5]\r\nv_hidden_size: 1024\r\nv_intermediate_size: 1024\r\nv_num_attention_heads: 8\r\nvocab_size: 30522\r\n------------------------------------------------\r\ntask:  [{'task': 'PMR', 'num_choice': 4, 'annotations_jsonpath_train': './data/pmr/annotations/train.jsonl', 'annotations_jsonpath_val': './data/pmr/annotations/val.jsonl', 'annotations_jsonpath_test': './data/pmr/annotations/test.jsonl', 'feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'gt_feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'unisex_names_table': './data/pmr/annotations/unisex_names_table.csv', 'Proprocessor': 'PreprocessorBasic', 'tokenizer_name': 'FullTokenizer', 'tagger_path': './script/ntc.pickle', 'nltk_data_path': './nltk_data', 'fusion_method': 'mul', 'dropout_rate': 0.1, 'max_seq_len': 60, 'use_gt_fea': False, 'task_prefix': 'pmr'}]\r\n2021-06-09 16:22:23,550-WARNING: paddle.fluid.layers.py_reader() may be deprecated in the near future. Please use paddle.fluid.io.DataLoader.from_generator() instead.\r\ntheoretical memory usage: \r\n(5271.439203643799, 5522.4601181030275, 'MB')\r\nW0609 16:22:24.612071 15347 device_context.cc:252] Please NOTE: device: 4, CUDA Capability: 75, Driver API Version: 11.2, Runtime API Version: 9.0\r\nW0609 16:22:24.613502 15347 device_context.cc:260] device: 4, cuDNN Version: 8.0.\r\nStart to load Faster-RCNN detected objects from ./data/pmr/annotations/pmr_10-36.tsv\r\nLoaded 1 images in file ./data/pmr/annotations/pmr_10-36.tsv in 23 seconds.\r\nonly butd feature\r\nLoad pretraining parameters from ./output_pmr/step_15000train.\r\ntesting on pmr val split\r\ntask name list :  ['mean_0.tmp_0', 'accuracy_0.tmp_0', 'arg_max_0.tmp_0', 'read_file_0.tmp_9', 'read_file_0.tmp_8', 'reshape2_120.tmp_0']\r\ncur_step: 10 cur_acc: 1.0\r\ncur_step: 20 cur_acc: 1.0\r\ncur_step: 30 cur_acc: 0.9979166666666667\r\ncur_step: 40 cur_acc: 0.9984375\r\ncur_step: 50 cur_acc: 0.99875\r\ncur_step: 60 cur_acc: 0.9989583333333333\r\nEXCEPTING\r\nLEN: 1075 1075\r\n<class 'pandas.core.frame.DataFrame'>\r\nRangeIndex: 1075 entries, 0 to 1074\r\nData columns (total 3 columns):\r\n #   Column  Non-Null Count  Dtype  \r\n---  ------  --------------  -----  \r\n 0   id      1075 non-null   int64  \r\n 1   proba   1075 non-null   float64\r\n 2   label   1075 non-null   int64  \r\ndtypes: float64(1), int64(2)\r\nmemory usage: 25.3 KB\r\nNone\r\naverage_acc: 0.9981617647058824\r\n```\r\n### 第三次\r\n```\r\nfinetuning tasks start\r\nattention_probs_dropout_prob: 0.1\r\nclass_attr_size: 401\r\nclass_size: 1601\r\nco_hidden_size: 1024\r\nco_intermediate_size: 1024\r\nco_num_attention_heads: 8\r\nhidden_act: gelu\r\nhidden_dropout_prob: 0.1\r\nhidden_size: 768\r\ninitializer_range: 0.02\r\nmax_position_embeddings: 512\r\nnum_attention_heads: 12\r\nnum_hidden_layers: 12\r\nsent_type_vocab_size: 4\r\nt_biattention_id: [6, 7, 8, 9, 10, 11]\r\ntask_type_vocab_size: 16\r\ntype_vocab_size: 2\r\nv_biattention_id: [0, 1, 2, 3, 4, 5]\r\nv_hidden_size: 1024\r\nv_intermediate_size: 1024\r\nv_num_attention_heads: 8\r\nvocab_size: 30522\r\n------------------------------------------------\r\ntask:  [{'task': 'PMR', 'num_choice': 4, 'annotations_jsonpath_train': './data/pmr/annotations/train.jsonl', 'annotations_jsonpath_val': './data/pmr/annotations/val.jsonl', 'annotations_jsonpath_test': './data/pmr/annotations/test.jsonl', 'feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'gt_feature_lmdb_path': './data/pmr/annotations/pmr_10-36.tsv', 'unisex_names_table': './data/pmr/annotations/unisex_names_table.csv', 'Proprocessor': 'PreprocessorBasic', 'tokenizer_name': 'FullTokenizer', 'tagger_path': './script/ntc.pickle', 'nltk_data_path': './nltk_data', 'fusion_method': 'mul', 'dropout_rate': 0.1, 'max_seq_len': 60, 'use_gt_fea': False, 'task_prefix': 'pmr'}]\r\n2021-06-09 16:23:45,356-WARNING: paddle.fluid.layers.py_reader() may be deprecated in the near future. Please use paddle.fluid.io.DataLoader.from_generator() instead.\r\ntheoretical memory usage: \r\n(5271.439203643799, 5522.4601181030275, 'MB')\r\nW0609 16:23:46.432518 15492 device_context.cc:252] Please NOTE: device: 4, CUDA Capability: 75, Driver API Version: 11.2, Runtime API Version: 9.0\r\nW0609 16:23:46.433915 15492 device_context.cc:260] device: 4, cuDNN Version: 8.0.\r\nStart to load Faster-RCNN detected objects from ./data/pmr/annotations/pmr_10-36.tsv\r\nLoaded 1 images in file ./data/pmr/annotations/pmr_10-36.tsv in 24 seconds.\r\nonly butd feature\r\nLoad pretraining parameters from ./output_pmr/step_15000train.\r\ntesting on pmr val split\r\ntask name list :  ['mean_0.tmp_0', 'accuracy_0.tmp_0', 'arg_max_0.tmp_0', 'read_file_0.tmp_9', 'read_file_0.tmp_8', 'reshape2_120.tmp_0']\r\ncur_step: 10 cur_acc: 0.99375\r\ncur_step: 20 cur_acc: 0.996875\r\ncur_step: 30 cur_acc: 0.9958333333333333\r\ncur_step: 40 cur_acc: 0.996875\r\ncur_step: 50 cur_acc: 0.99625\r\ncur_step: 60 cur_acc: 0.9958333333333333\r\nEXCEPTING\r\nLEN: 1075 1075\r\n<class 'pandas.core.frame.DataFrame'>\r\nRangeIndex: 1075 entries, 0 to 1074\r\nData columns (total 3 columns):\r\n #   Column  Non-Null Count  Dtype  \r\n---  ------  --------------  -----  \r\n 0   id      1075 non-null   int64  \r\n 1   proba   1075 non-null   float64\r\n 2   label   1075 non-null   int64  \r\ndtypes: float64(1), int64(2)\r\nmemory usage: 25.3 KB\r\nNone\r\naverage_acc: 0.9963235294117647\r\n```\r\n我之前猜测会不会是忘了设置evaluation模式了，但仔细看了finetune.py里的代码，发现已经有了这句`test_prog = test_prog.clone(for_test=True)`，所以应该不是这个的问题。\r\n您能否帮我分析下可能的原因吗？谢谢","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/694/timeline","performed_via_github_app":null,"state_reason":"completed"}