{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/784","id":1096512930,"node_id":"I_kwDOClgT-M5BW3Wi","number":784,"title":"Modeling_ernie.py 中from_pertrained有bug","user":{"login":"softsweetengineer","id":35911711,"node_id":"MDQ6VXNlcjM1OTExNzEx","avatar_url":"https://avatars.githubusercontent.com/u/35911711?v=4","gravatar_id":"","url":"https://api.github.com/users/softsweetengineer","html_url":"https://github.com/softsweetengineer","followers_url":"https://api.github.com/users/softsweetengineer/followers","following_url":"https://api.github.com/users/softsweetengineer/following{/other_user}","gists_url":"https://api.github.com/users/softsweetengineer/gists{/gist_id}","starred_url":"https://api.github.com/users/softsweetengineer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/softsweetengineer/subscriptions","organizations_url":"https://api.github.com/users/softsweetengineer/orgs","repos_url":"https://api.github.com/users/softsweetengineer/repos","events_url":"https://api.github.com/users/softsweetengineer/events{/privacy}","received_events_url":"https://api.github.com/users/softsweetengineer/received_events","type":"User","site_admin":false},"labels":[{"id":1256169225,"node_id":"MDU6TGFiZWwxMjU2MTY5MjI1","url":"https://api.github.com/repos/PaddlePaddle/ERNIE/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-01-07T17:20:57Z","updated_at":"2022-03-16T03:43:09Z","closed_at":"2022-03-16T03:43:09Z","author_association":"NONE","active_lock_reason":null,"body":"环境：\r\n win10\r\npython3.7\r\npaddle2.2\r\n\r\n问题：\r\n在使用快速开始教程时，代码报错，打印信息：\r\nC:\\ProgramData\\Anaconda3\\lib\\site-packages\\socks.py:58: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working\r\nfrom collections import Callable\r\nC:\\ProgramData\\Anaconda3\\lib\\site-packages\\win32\\lib\\pywintypes.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses\r\nimport imp, sys, os\r\nW0108 00:24:50.315569 18852 device_context.cc:447] Please NOTE: device: 0, GPU Compute Capability: 8.6, Driver API Version: 11.5, Runtime API Version: 11.1\r\nW0108 00:24:50.327234 18852 device_context.cc:465] device: 0, cuDNN Version: 8.1.\r\nTraceback (most recent call last):\r\nFile \".\\topic_main.py\", line 6, in\r\nmodel = ErnieModel.from_pretrained('ernie-1.0') # Try to get pretrained model from server, make sure you have network connection\r\nFile \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\ernie\\modeling_ernie.py\", line 293, in from_pretrained\r\nm = P.load(state_dict_path)\r\nFile \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\paddle\\framework\\io.py\", line 928, in load\r\nwith _open_file_buffer(path, 'rb') as f:\r\nFile \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\paddle\\fluid\\io.py\", line 111, in _open_file_buffer\r\nreturn _buffer_reader(path_or_buffer)\r\nFile \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\paddle\\fluid\\io.py\", line 86, in init\r\nself.initial_tell = self.buffer.tell()\r\nAttributeError: 'WindowsPath' object has no attribute 'tell'\r\n\r\n经查发现在Modeling_ernie.py中，传入了WindowsPath对象到load函数中，单词函数仅接受IO类型或字符串，故可修改原代码第200行from_pretrained函数为：\r\n```\r\n    def from_pretrained(cls,\r\n                        pretrain_dir_or_url,\r\n                        force_download=False,\r\n                        **kwargs):\r\n        if not Path(pretrain_dir_or_url).exists() and str(\r\n                pretrain_dir_or_url) in cls.resource_map:\r\n            url = cls.resource_map[str(pretrain_dir_or_url)]\r\n            log.info('get pretrain dir from %s' % url)\r\n            pretrain_dir = _fetch_from_remote(url, force_download)\r\n        else:\r\n            log.info('pretrain dir %s not in %s, read from local' %\r\n                     (pretrain_dir_or_url, repr(cls.resource_map)))\r\n            pretrain_dir = Path(pretrain_dir_or_url)\r\n\r\n        if not pretrain_dir.exists():\r\n            raise ValueError('pretrain dir not found: %s, optional: %s' % (pretrain_dir, cls.resource_map.keys()))\r\n        state_dict_path = pretrain_dir / 'saved_weights.pdparams'\r\n        config_path = pretrain_dir / 'ernie_config.json'\r\n\r\n        if not config_path.exists():\r\n            raise ValueError('config path not found: %s' % config_path)\r\n        name_prefix = kwargs.pop('name', None)\r\n        cfg_dict = dict(json.loads(config_path.open().read()), **kwargs)\r\n        model = cls(cfg_dict, name=name_prefix)\r\n\r\n        log.info('loading pretrained model from %s' % pretrain_dir)\r\n\r\n        if state_dict_path.exists():\r\n            m = P.load(str(state_dict_path.resolve()))\r\n            for k, v in model.state_dict().items():\r\n                if k not in m:\r\n                    log.warn('param:%s not set in pretrained model, skip' % k)\r\n                    m[k] = v  # FIXME: no need to do this in the future\r\n            model.set_state_dict(m)\r\n        else:\r\n            raise ValueError('weight file not found in pretrain dir: %s' %\r\n                             pretrain_dir)\r\n        return model\r\n```","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/784/timeline","performed_via_github_app":null,"state_reason":"completed"}