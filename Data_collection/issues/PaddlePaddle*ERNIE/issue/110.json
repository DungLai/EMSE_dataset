{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/110","id":436508969,"node_id":"MDU6SXNzdWU0MzY1MDg5Njk=","number":110,"title":"单机单卡能跑通, 单机多卡会在fluid.ParallelExecutor处报SegmentationFault","user":{"login":"daizh","id":15260093,"node_id":"MDQ6VXNlcjE1MjYwMDkz","avatar_url":"https://avatars.githubusercontent.com/u/15260093?v=4","gravatar_id":"","url":"https://api.github.com/users/daizh","html_url":"https://github.com/daizh","followers_url":"https://api.github.com/users/daizh/followers","following_url":"https://api.github.com/users/daizh/following{/other_user}","gists_url":"https://api.github.com/users/daizh/gists{/gist_id}","starred_url":"https://api.github.com/users/daizh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daizh/subscriptions","organizations_url":"https://api.github.com/users/daizh/orgs","repos_url":"https://api.github.com/users/daizh/repos","events_url":"https://api.github.com/users/daizh/events{/privacy}","received_events_url":"https://api.github.com/users/daizh/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"kuke","id":3064195,"node_id":"MDQ6VXNlcjMwNjQxOTU=","avatar_url":"https://avatars.githubusercontent.com/u/3064195?v=4","gravatar_id":"","url":"https://api.github.com/users/kuke","html_url":"https://github.com/kuke","followers_url":"https://api.github.com/users/kuke/followers","following_url":"https://api.github.com/users/kuke/following{/other_user}","gists_url":"https://api.github.com/users/kuke/gists{/gist_id}","starred_url":"https://api.github.com/users/kuke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuke/subscriptions","organizations_url":"https://api.github.com/users/kuke/orgs","repos_url":"https://api.github.com/users/kuke/repos","events_url":"https://api.github.com/users/kuke/events{/privacy}","received_events_url":"https://api.github.com/users/kuke/received_events","type":"User","site_admin":false},"assignees":[{"login":"kuke","id":3064195,"node_id":"MDQ6VXNlcjMwNjQxOTU=","avatar_url":"https://avatars.githubusercontent.com/u/3064195?v=4","gravatar_id":"","url":"https://api.github.com/users/kuke","html_url":"https://github.com/kuke","followers_url":"https://api.github.com/users/kuke/followers","following_url":"https://api.github.com/users/kuke/following{/other_user}","gists_url":"https://api.github.com/users/kuke/gists{/gist_id}","starred_url":"https://api.github.com/users/kuke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuke/subscriptions","organizations_url":"https://api.github.com/users/kuke/orgs","repos_url":"https://api.github.com/users/kuke/repos","events_url":"https://api.github.com/users/kuke/events{/privacy}","received_events_url":"https://api.github.com/users/kuke/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-04-24T05:53:30Z","updated_at":"2019-05-11T06:18:53Z","closed_at":"2019-05-11T06:18:53Z","author_association":"NONE","active_lock_reason":null,"body":"[问题描述]\r\n运行script/run_xnli.sh时, 单机单卡能够顺利运行, 但多卡会在fluid.ParallelExecutor处报SegmentationFault\r\n\r\n[报错位置]\r\nrun_classifier.py中\r\n```\r\n167     if args.do_train:\r\n168         print(\"do_train:\")\r\n169         exec_strategy = fluid.ExecutionStrategy()\r\n170         if args.use_fast_executor:\r\n171             exec_strategy.use_experimental_executor = True\r\n172         exec_strategy.num_threads = dev_count\r\n173         exec_strategy.num_iteration_per_drop_scope = args.num_iteration_per_drop_scope\r\n174\r\n175         print(\"init fluid.ParallelExecutor\")  # 此处之后报错\r\n176         train_exe = fluid.ParallelExecutor(\r\n177             use_cuda=args.use_cuda,\r\n178             loss_name=graph_vars[\"loss\"].name,\r\n179             exec_strategy=exec_strategy,\r\n180             main_program=train_program)\r\n181\r\n182         print(\" train_pyreader.decorate_tensor_provider(train_data_generator)\")\r\n183         train_pyreader.decorate_tensor_provider(train_data_generator)\r\n```\r\n[错误信息]\r\n\r\n![image](https://user-images.githubusercontent.com/15260093/56635533-91e0c600-6698-11e9-9118-542b22a6477f.png)\r\n\r\nTheoretical memory usage in training: 9076.691 - 9508.915 MB\r\nW0424 13:34:08.421407  8512 device_context.cc:263] Please NOTE: device: 0, CUDA Capability: 61, Driver API Version: 9.2, Runtime API Version: 9.0\r\nW0424 13:34:08.421470  8512 device_context.cc:271] device: 0, cuDNN Version: 7.0.\r\nW0424 13:34:08.421519  8512 device_context.cc:295] WARNING: device: 0. The installed Paddle is compiled with CUDNN 7.3, but CUDNN version in your machine is 7.0, which may cause serious incompatible bug. Please recompile or reinstall Paddle with compatible CUDNN version.\r\nLoad pretraining parameters from ./checkpoint/ernie_stable//params.\r\ndo_train:\r\ninit fluid.ParallelExecutor\r\n*** Aborted at 1556084061 (unix time) try \"date -d @1556084061\" if you are using GNU date ***\r\nPC: @                0x0 (unknown)\r\n*** SIGSEGV (@0x0) received by PID 8512 (TID 0x7f99f42ca700) from PID 0; stack trace: ***\r\n    @     0x7f99f3a81160 (unknown)\r\n    @                0x0 (unknown)\r\nscript/run_xnli.sh: line 44:  8512 Segmentation fault      ${PYTHON} -u run_classifier.py --use_cuda true --do_train true --do_val true --do_test true --verbose true --batch_size 4192 --in_tokens true --init_pretraining_params ${MODEL_PATH}/params --train_set ${TASK_DATA_PATH}/xnli/train.tsv --dev_set ${TASK_DATA_PATH}/xnli/dev.tsv --test_set ${TASK_DATA_PATH}/xnli/test.tsv --vocab_path config/vocab.txt --label_map ${TASK_DATA_PATH}/xnli/label_map.json --ernie_config_path config/ernie_config.json --checkpoints ./checkpoints --save_steps 1000 --weight_decay 0.01 --warmup_proportion 0.0 --validation_steps 25 --epoch 3 --max_seq_len 512 --learning_rate 1e-4 --skip_steps 10 --num_iteration_per_drop_scope 1 --num_labels 3 --random_seed 1\r\n\r\n[运行环境]\r\n```\r\npaddlepaddle-gpu==1.3.0.post85\r\ncuda-9.0\r\ncudnn_v7\r\n```\r\n[运行脚本(script/run_xnli.sh)]\r\n```\r\nexport FLAGS_sync_nccl_allreduce=1\r\nexport CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7\r\nexport LD_LIBRARY_PATH=./env/lib/:$LD_LIBRARY_PATH\r\nexport LD_LIBRARY_PATH=/home/work/cuda-9.0/lib64/:/home/work/cudnn/cudnn_v7/cuda/lib64:/home/work/cuda-9.0/extras/CUPTI/lib64/:$LD_LIBRARY_PATH\r\n\r\nTASK_DATA_PATH=./task_data\r\nMODEL_PATH=./checkpoint/ernie_stable/\r\n\r\nPYTHON=./env/python3/bin/python3\r\n${PYTHON} -u run_classifier.py \\\r\n                   --use_cuda true \\\r\n                   --do_train true \\\r\n                   --do_val true \\\r\n                   --do_test true \\\r\n                   --verbose true \\\r\n                   --batch_size 8192 \\\r\n                   --in_tokens true \\\r\n                   --init_pretraining_params ${MODEL_PATH}/params \\\r\n                   --train_set ${TASK_DATA_PATH}/xnli/train.tsv \\\r\n                   --dev_set ${TASK_DATA_PATH}/xnli/dev.tsv \\\r\n                   --test_set ${TASK_DATA_PATH}/xnli/test.tsv \\\r\n                   --vocab_path config/vocab.txt \\\r\n                   --label_map ${TASK_DATA_PATH}/xnli/label_map.json \\\r\n                   --ernie_config_path config/ernie_config.json \\\r\n                   --checkpoints ./checkpoints \\\r\n                   --save_steps 1000 \\\r\n                   --weight_decay  0.01 \\\r\n                   --warmup_proportion 0.0 \\\r\n                   --validation_steps 25 \\\r\n                   --epoch 3 \\\r\n                   --max_seq_len 512 \\\r\n                   --learning_rate 1e-4 \\\r\n                   --skip_steps 10 \\\r\n                   --num_iteration_per_drop_scope 1 \\\r\n                   --num_labels 3 \\\r\n                   --random_seed 1\r\n```","closed_by":{"login":"daizh","id":15260093,"node_id":"MDQ6VXNlcjE1MjYwMDkz","avatar_url":"https://avatars.githubusercontent.com/u/15260093?v=4","gravatar_id":"","url":"https://api.github.com/users/daizh","html_url":"https://github.com/daizh","followers_url":"https://api.github.com/users/daizh/followers","following_url":"https://api.github.com/users/daizh/following{/other_user}","gists_url":"https://api.github.com/users/daizh/gists{/gist_id}","starred_url":"https://api.github.com/users/daizh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daizh/subscriptions","organizations_url":"https://api.github.com/users/daizh/orgs","repos_url":"https://api.github.com/users/daizh/repos","events_url":"https://api.github.com/users/daizh/events{/privacy}","received_events_url":"https://api.github.com/users/daizh/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/110/timeline","performed_via_github_app":null,"state_reason":"completed"}