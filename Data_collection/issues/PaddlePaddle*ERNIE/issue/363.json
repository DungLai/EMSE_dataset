{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/363","id":518213245,"node_id":"MDU6SXNzdWU1MTgyMTMyNDU=","number":363,"title":"搭建向量服务器后客户端请求报错：Assertion `id < N` failed","user":{"login":"fengyunshuo","id":29773906,"node_id":"MDQ6VXNlcjI5NzczOTA2","avatar_url":"https://avatars.githubusercontent.com/u/29773906?v=4","gravatar_id":"","url":"https://api.github.com/users/fengyunshuo","html_url":"https://github.com/fengyunshuo","followers_url":"https://api.github.com/users/fengyunshuo/followers","following_url":"https://api.github.com/users/fengyunshuo/following{/other_user}","gists_url":"https://api.github.com/users/fengyunshuo/gists{/gist_id}","starred_url":"https://api.github.com/users/fengyunshuo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fengyunshuo/subscriptions","organizations_url":"https://api.github.com/users/fengyunshuo/orgs","repos_url":"https://api.github.com/users/fengyunshuo/repos","events_url":"https://api.github.com/users/fengyunshuo/events{/privacy}","received_events_url":"https://api.github.com/users/fengyunshuo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-11-06T03:27:57Z","updated_at":"2019-11-07T06:28:20Z","closed_at":"2019-11-07T06:28:20Z","author_association":"NONE","active_lock_reason":null,"body":"**第一步：使用docker安装paddle**\r\ndocker pull hub.baidubce.com/paddlepaddle/paddle:1.6.0-gpu-cuda10.0-cudnn7\r\n\r\ndocker run --runtime nvidia --name paddle -p 8129:8888 -it -v $PWD:/paddle hub.baidubce.com/paddlepaddle/paddle:1.6.0-gpu-cuda10.0-cudnn7 /bin/bash\r\n\r\n在容器内使用python解释器检查显示Your Paddle Fluid is installed succesfully!\r\n\r\n**第二步：设置变量以及安装所需包**\r\nexport CUDA_VISIBLE_DEVICES=0\r\n\r\npip3 install zmq\r\n\r\nexport PYTHONPATH=./:$PYTHONPATH\r\n\r\n解压中文与训练模型\r\n\r\n等等等\r\n\r\n**第三步：开启向量服务器**\r\n\r\npython3 ernie/service/encoder_server.py -m ./inf_model/ -p 8888 -v --encode_layer pooler\r\n\r\n显示如下：\r\n[INFO] 2019-11-06 03:03:51,781 [encoder_server.py:   65]:\tpropeller server listent on port 8888\r\n[INFO] 2019-11-06 03:03:51,783 [   server.py:  131]:\tInferenceProxy starting...\r\n[DEBUG] 2019-11-06 03:03:51,784 [   server.py:   65]:\trun_worker 0\r\n[DEBUG] 2019-11-06 03:03:51,785 [   server.py:   68]:\tcuda_env 0\r\n[INFO] 2019-11-06 03:03:51,787 [   server.py:  140]:\tQueue init done\r\n[DEBUG] 2019-11-06 03:03:53,028 [   server.py:   76]:\tPredictor building 0\r\n[DEBUG] 2019-11-06 03:03:53,028 [   server.py:   50]:\tcreate predictor on card 0\r\nI1106 03:03:53.876863   559 analysis_predictor.cc:88] Profiler is deactivated, and no profiling report will be generated.\r\nI1106 03:03:53.893898   559 op_compatible_info.cc:201] The default operator required version is missing. Please update the model version.\r\nI1106 03:03:53.893931   559 analysis_predictor.cc:847] MODEL VERSION: 0.0.0\r\nI1106 03:03:53.893942   559 analysis_predictor.cc:849] PREDICTOR VERSION: 1.6.0\r\n--- Running analysis [ir_graph_build_pass]\r\n--- Running analysis [ir_graph_clean_pass]\r\n--- Running analysis [ir_analysis_pass]\r\n--- Running IR pass [is_test_pass]\r\n--- Running IR pass [simplify_with_basic_ops_pass]\r\n--- Running IR pass [conv_affine_channel_fuse_pass]\r\n--- Running IR pass [conv_eltwiseadd_affine_channel_fuse_pass]\r\n--- Running IR pass [conv_bn_fuse_pass]\r\n--- Running IR pass [conv_eltwiseadd_bn_fuse_pass]\r\n--- Running IR pass [multihead_matmul_fuse_pass]\r\nI1106 03:03:55.595218   559 graph_pattern_detector.cc:96] ---  detected 12 subgraphs\r\n--- Running IR pass [fc_fuse_pass]\r\nI1106 03:03:55.610505   559 graph_pattern_detector.cc:96] ---  detected 12 subgraphs\r\nI1106 03:03:55.618679   559 graph_pattern_detector.cc:96] ---  detected 25 subgraphs\r\n--- Running IR pass [fc_elementwise_layernorm_fuse_pass]\r\nI1106 03:03:55.633041   559 graph_pattern_detector.cc:96] ---  detected 24 subgraphs\r\n--- Running IR pass [conv_elementwise_add_act_fuse_pass]\r\n--- Running IR pass [conv_elementwise_add2_act_fuse_pass]\r\n--- Running IR pass [conv_elementwise_add_fuse_pass]\r\n--- Running IR pass [transpose_flatten_concat_fuse_pass]\r\n--- Running IR pass [runtime_context_cache_pass]\r\n--- Running analysis [ir_params_sync_among_devices_pass]\r\nI1106 03:03:55.645728   559 ir_params_sync_among_devices_pass.cc:41] Sync params from CPU to GPU\r\n--- Running analysis [adjust_cudnn_workspace_size_pass]\r\n--- Running analysis [inference_op_replace_pass]\r\n--- Running analysis [ir_graph_to_program_pass]\r\nI1106 03:03:55.840788   559 analysis_predictor.cc:473] ======= optimize end =======\r\n[DEBUG] 2019-11-06 03:03:55,841 [   server.py:   78]:\tPredictor 0\r\n\r\n应该是正确启动了\r\n\r\n**第四步：客户端请求**\r\n\r\npython代码如下：\r\n`from ernie.service.client import ErnieClient`\r\n`client = ErnieClient('./config/vocab.txt', host='localhost', port=8888)`\r\n`ret = client(['谁有狂三这张高清的', '英雄联盟什么英雄最好'])`\r\n\r\n客户端报错：\r\n[INFO] 2019-11-06 03:10:14,655 [   client.py:   60]:\tConnecting to server... tcp://localhost:8888\r\n[ERROR] 2019-11-06 03:10:24,685 [   client.py:   91]:\tResource temporarily unavailable\r\nTraceback (most recent call last):\r\n  File \"/home/ERNIE/propeller/service/client.py\", line 88, in get\r\n    reply = await socket.recv(zmq.NOBLOCK)\r\n  File \"/usr/lib/python3.5/asyncio/futures.py\", line 363, in __iter__\r\n    return self.result()  # May raise too.\r\n  File \"/usr/lib/python3.5/asyncio/futures.py\", line 274, in result\r\n    raise self._exception\r\n  File \"/usr/local/lib/python3.5/dist-packages/zmq/_future.py\", line 315, in _add_recv_event\r\n    r = recv(**kwargs)\r\n  File \"zmq/backend/cython/socket.pyx\", line 796, in zmq.backend.cython.socket.Socket.recv\r\n  File \"zmq/backend/cython/socket.pyx\", line 832, in zmq.backend.cython.socket.Socket.recv\r\n  File \"zmq/backend/cython/socket.pyx\", line 191, in zmq.backend.cython.socket._recv_copy\r\n  File \"zmq/backend/cython/socket.pyx\", line 186, in zmq.backend.cython.socket._recv_copy\r\n  File \"zmq/backend/cython/checkrc.pxd\", line 19, in zmq.backend.cython.checkrc._check_rc\r\nzmq.error.Again: Resource temporarily unavailable\r\nTraceback (most recent call last):\r\n  File \"test_client.py\", line 3, in <module>\r\n    ret = client(['\\u8c01\\u6709\\u72c2\\u4e09\\u8fd9\\u5f20\\u9ad8\\u6e05\\u7684', '\\u82f1\\u96c4\\u8054\\u76df\\u4ec0\\u4e48\\u82f1\\u96c4\\u6700\\u597d'])\r\n  File \"/home/ERNIE/ernie/service/client.py\", line 73, in __call__\r\n    ret, = super(ErnieClient, self).__call__(sen_ids, token_type_ids)\r\n  File \"/home/ERNIE/propeller/service/client.py\", line 102, in __call__\r\n    raise RuntimeError('Client call failed')\r\nRuntimeError: Client call failed\r\n\r\n服务端报错：\r\nW1106 03:21:16.098963  1561 device_context.cc:235] Please NOTE: device: 0, CUDA Capability: 70, Driver API Version: 10.1, Runtime API Version: 10.0\r\nW1106 03:21:16.105224  1561 device_context.cc:243] device: 0, cuDNN Version: 7.5.\r\nW1106 03:21:19.452029  1561 naive_executor.cc:43] The NaiveExecutor can not work properly if the cmake flag ON_INFER is not set.\r\nW1106 03:21:19.452064  1561 naive_executor.cc:45] Unlike the training phase, all the scopes and variables will be reused to save the allocation overhead.\r\nW1106 03:21:19.452075  1561 naive_executor.cc:48] Please re-compile the inference library by setting the cmake flag ON_INFER=ON if you are running Paddle Inference\r\nF1106 03:21:20.245061  1561 device_context.cc:318] cudaStreamSynchronize unspecified launch failure errno: 4\r\n\r\n一堆以下内容：\r\nException: /paddle/paddle/fluid/operators/lookup_table_op.cu:43 Assertion `id < N` failed. Variable value (input) of OP(fluid.layers.embedding) expected >= 0 and < 18000, but got 4656722015836110848. Please check input value.\r\nException: /paddle/paddle/fluid/operators/lookup_table_op.cu:43 Assertion `id < N` failed. Variable value (input) of OP(fluid.layers.embedding) expected >= 0 and < 18000, but got 4656722015836110848. Please check input value.\r\n\r\n*** Check failure stack trace: ***\r\n    @     0x7fa91bd2811d  google::LogMessage::Fail()\r\n    @     0x7fa91bd2bbcc  google::LogMessage::SendToLog()\r\n    @     0x7fa91bd27c43  google::LogMessage::Flush()\r\n    @     0x7fa91bd2d0de  google::LogMessageFatal::~LogMessageFatal()\r\n    @     0x7fa91e50b587  paddle::platform::CUDADeviceContext::Wait()\r\n    @     0x7fa91e4a0163  paddle::framework::TransDataDevice()\r\n    @     0x7fa91e49f11e  paddle::framework::TransformData()\r\n    @     0x7fa91e48212b  paddle::framework::OperatorWithKernel::PrepareData()\r\n    @     0x7fa91e483508  paddle::framework::OperatorWithKernel::RunImpl()\r\n    @     0x7fa91e483af3  paddle::framework::OperatorWithKernel::RunImpl()\r\n    @     0x7fa91e47e2b3  paddle::framework::OperatorBase::Run()\r\n    @     0x7fa91e438ef0  paddle::framework::NaiveExecutor::Run()\r\n    @     0x7fa91be04cac  paddle::AnalysisPredictor::Run()\r\n    @     0x7fa91bcf7cd6  _ZZN8pybind1112cpp_function10initializeIZN6paddle6pybind12_GLOBAL__N_121BindAnalysisPredictorEPNS_6moduleEEUlRNS2_17AnalysisPredictorERKSt6vectorINS2_12PaddleTensorESaISA_EEE_SC_IS8_SE_EINS_4nameENS_9is_methodENS_7siblingEEEEvOT_PFT0_DpT1_EDpRKT2_ENUlRNS_6detail13function_callEE1_4_FUNESW_\r\n    @     0x7fa91bbfc176  pybind11::cpp_function::dispatcher()\r\n    @           0x4e1307  PyCFunction_Call\r\n    @           0x535fcb  PyEval_EvalFrameEx\r\n    @           0x53a81b  PyEval_EvalCodeEx\r\n    @           0x4e3537  (unknown)\r\n    @           0x5c3bd7  PyObject_Call\r\n    @           0x532a22  PyEval_EvalFrameEx\r\n    @           0x53af6a  PyEval_EvalCodeEx\r\n    @           0x4e3423  (unknown)\r\n    @           0x5c3bd7  PyObject_Call\r\n    @           0x4f08be  (unknown)\r\n    @           0x5c3bd7  PyObject_Call\r\n    @           0x55fbf6  (unknown)\r\n    @           0x5c3bd7  PyObject_Call\r\n    @           0x5354af  PyEval_EvalFrameEx\r\n    @           0x53af6a  PyEval_EvalCodeEx\r\n    @           0x4e3537  (unknown)\r\n    @           0x5c3bd7  PyObject_Call\r\n\r\n请问是我的环境问题吗还是什么问题呢？谢谢","closed_by":{"login":"fengyunshuo","id":29773906,"node_id":"MDQ6VXNlcjI5NzczOTA2","avatar_url":"https://avatars.githubusercontent.com/u/29773906?v=4","gravatar_id":"","url":"https://api.github.com/users/fengyunshuo","html_url":"https://github.com/fengyunshuo","followers_url":"https://api.github.com/users/fengyunshuo/followers","following_url":"https://api.github.com/users/fengyunshuo/following{/other_user}","gists_url":"https://api.github.com/users/fengyunshuo/gists{/gist_id}","starred_url":"https://api.github.com/users/fengyunshuo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fengyunshuo/subscriptions","organizations_url":"https://api.github.com/users/fengyunshuo/orgs","repos_url":"https://api.github.com/users/fengyunshuo/repos","events_url":"https://api.github.com/users/fengyunshuo/events{/privacy}","received_events_url":"https://api.github.com/users/fengyunshuo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/363/timeline","performed_via_github_app":null,"state_reason":"completed"}