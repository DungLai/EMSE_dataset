{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616","repository_url":"https://api.github.com/repos/PaddlePaddle/ERNIE","labels_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616/labels{/name}","comments_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616/comments","events_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616/events","html_url":"https://github.com/PaddlePaddle/ERNIE/issues/616","id":789096560,"node_id":"MDU6SXNzdWU3ODkwOTY1NjA=","number":616,"title":"完型填空","user":{"login":"ouhongxu","id":60462613,"node_id":"MDQ6VXNlcjYwNDYyNjEz","avatar_url":"https://avatars.githubusercontent.com/u/60462613?v=4","gravatar_id":"","url":"https://api.github.com/users/ouhongxu","html_url":"https://github.com/ouhongxu","followers_url":"https://api.github.com/users/ouhongxu/followers","following_url":"https://api.github.com/users/ouhongxu/following{/other_user}","gists_url":"https://api.github.com/users/ouhongxu/gists{/gist_id}","starred_url":"https://api.github.com/users/ouhongxu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ouhongxu/subscriptions","organizations_url":"https://api.github.com/users/ouhongxu/orgs","repos_url":"https://api.github.com/users/ouhongxu/repos","events_url":"https://api.github.com/users/ouhongxu/events{/privacy}","received_events_url":"https://api.github.com/users/ouhongxu/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-01-19T14:59:47Z","updated_at":"2021-07-27T02:42:08Z","closed_at":"2021-02-01T15:27:32Z","author_association":"NONE","active_lock_reason":null,"body":"可以提供一个返回前n个适宜词的方法吗？万分感谢~！\r\n下面方法仅返回一个答案，而且没有词检验（如果一个填空中包含两个[MASK]，第一个mask取字典中概率最高的那个字，第二个mask也取字典中概率最高的那个字，有时这两个mask拼接起来不是一个词）。\r\n\r\n\r\n在最新开源的[ERNIE动态图模型](https://github.com/PaddlePaddle/ERNIE/tree/dygraph)当中，做完形填空将会更加简单方便.\r\n\r\n继承`ErnieModelForPretraining`并改写`forward`方法，便可以实现简单的完形填空逻辑(仅限ernie1.0中文模型；enire2.0等英文模型因为没有发布mask_lm任务相关的weight文件所以还无法做到完形填空)；\r\n\r\n请参考：\r\n```python\r\nimport os\r\nimport numpy as np\r\n\r\nimport paddle.fluid as F\r\nimport paddle.fluid.layers as L\r\nimport paddle.fluid.dygraph as D\r\nfrom ernie.modeling_ernie import ErnieModelForPretraining, ErnieModel\r\nfrom ernie.tokenizing_ernie import ErnieTokenizer\r\n\r\nclass ErnieCloset(ErnieModelForPretraining):\r\n    def __init__(self, *args, **kwargs):\r\n        super(ErnieCloset, self).__init__(*args, **kwargs)\r\n        del self.pooler_heads\r\n    def forward(self, src_ids, *args, **kwargs):\r\n        pooled, encoded = ErnieModel.forward(self, src_ids, *args, **kwargs)\r\n        encoded_2d = L.gather_nd(encoded, L.where(src_ids == mask_id))\r\n        encoded_2d = self.mlm(encoded_2d)\r\n        encoded_2d = self.mlm_ln(encoded_2d)\r\n        logits_2d = L.matmul(encoded_2d, self.word_emb.weight, transpose_y=True) + self.mlm_bias\r\n        return logits_2d\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    model_dir = 'ernie-1.0'\r\n\r\n    D.guard().__enter__()\r\n    tokenizer = ErnieTokenizer.from_pretrained(model_dir)\r\n    rev_dict = {v: k for k, v in tokenizer.vocab.items()}\r\n    rev_dict[tokenizer.pad_id] = '' # replace [PAD]\r\n    rev_dict[tokenizer.sep_id] = '' # replace [PAD]\r\n    rev_dict[tokenizer.unk_id] = '' # replace [PAD]\r\n\r\n    @np.vectorize\r\n    def rev_lookup(i):\r\n        return rev_dict[i]\r\n\r\n    ernie = ErnieCloset.from_pretrained(model_dir)\r\n    ernie.eval()\r\n\r\n    ids, _ = tokenizer.encode('戊戌变法，又称百日维新，是 [MASK] [MASK] [MASK] 、梁启超等维新派人士通过光绪帝进行 的一场资产阶级改良。')\r\n    mask_id = tokenizer.mask_id\r\n    print(ids)\r\n    ids = np.expand_dims(ids, 0)\r\n    ids = D.to_variable(ids)\r\n    logits = ernie(ids).numpy()\r\n    output_ids = np.argmax(logits, -1)\r\n    seg_txt = rev_lookup(output_ids)\r\n    print(seg_txt)\r\n```\r\n\r\n_Originally posted by @Meiyim in https://github.com/PaddlePaddle/ERNIE/issues/173#issuecomment-619491262_","closed_by":{"login":"ouhongxu","id":60462613,"node_id":"MDQ6VXNlcjYwNDYyNjEz","avatar_url":"https://avatars.githubusercontent.com/u/60462613?v=4","gravatar_id":"","url":"https://api.github.com/users/ouhongxu","html_url":"https://github.com/ouhongxu","followers_url":"https://api.github.com/users/ouhongxu/followers","following_url":"https://api.github.com/users/ouhongxu/following{/other_user}","gists_url":"https://api.github.com/users/ouhongxu/gists{/gist_id}","starred_url":"https://api.github.com/users/ouhongxu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ouhongxu/subscriptions","organizations_url":"https://api.github.com/users/ouhongxu/orgs","repos_url":"https://api.github.com/users/ouhongxu/repos","events_url":"https://api.github.com/users/ouhongxu/events{/privacy}","received_events_url":"https://api.github.com/users/ouhongxu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/PaddlePaddle/ERNIE/issues/616/timeline","performed_via_github_app":null,"state_reason":"completed"}