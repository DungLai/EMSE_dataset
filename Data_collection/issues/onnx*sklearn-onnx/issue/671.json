{"url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671","repository_url":"https://api.github.com/repos/onnx/sklearn-onnx","labels_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671/labels{/name}","comments_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671/comments","events_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671/events","html_url":"https://github.com/onnx/sklearn-onnx/issues/671","id":932301220,"node_id":"MDU6SXNzdWU5MzIzMDEyMjA=","number":671,"title":"Sklearn LR predictions differ from onnx predictions (example present in current documentation)","user":{"login":"Ewan-Keith","id":11393965,"node_id":"MDQ6VXNlcjExMzkzOTY1","avatar_url":"https://avatars.githubusercontent.com/u/11393965?v=4","gravatar_id":"","url":"https://api.github.com/users/Ewan-Keith","html_url":"https://github.com/Ewan-Keith","followers_url":"https://api.github.com/users/Ewan-Keith/followers","following_url":"https://api.github.com/users/Ewan-Keith/following{/other_user}","gists_url":"https://api.github.com/users/Ewan-Keith/gists{/gist_id}","starred_url":"https://api.github.com/users/Ewan-Keith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ewan-Keith/subscriptions","organizations_url":"https://api.github.com/users/Ewan-Keith/orgs","repos_url":"https://api.github.com/users/Ewan-Keith/repos","events_url":"https://api.github.com/users/Ewan-Keith/events{/privacy}","received_events_url":"https://api.github.com/users/Ewan-Keith/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-06-29T07:17:19Z","updated_at":"2021-11-26T10:14:51Z","closed_at":"2021-11-26T10:14:51Z","author_association":"NONE","active_lock_reason":null,"body":"Since this is present in the documentation it could be that I'm misunderstanding the expected behaviour, but it looks like use of one-hot-encoding results in different predictions between sklearn pipelines and generated onnx models. \r\n\r\nThe example in the documentation is the titanic pipeline example [here](http://onnx.ai/sklearn-onnx/auto_examples/plot_complex_pipeline.html#compare-the-predictions). The predicted outputs shown are:\r\n\r\n**Sklearn predictions:**\r\n```\r\npredict [0 0 1 0 0]\r\npredict_proba [[0.65654207 0.34345793]]\r\n```\r\n\r\n**Onnx predictions:**\r\n```\r\npredict [1 0 1 0 0]\r\npredict_proba [{0: 0.4371914267539978, 1: 0.5628085732460022}]\r\n```\r\n\r\nI can replicate this using the example locally and have also encountered similar behaviour in my own converted pipeline. In both cases if I remove the categorical features and transformer from the pipeline I get identical predictions (within double/float precision) between sklearn and onnx models, which makes me think the root of the difference is in the OHE.\r\n\r\nI see from other issues (https://github.com/onnx/onnxmltools/issues/371) that Sklearn's default use of sparse representations can cause issues with OHE in onnx if not disabled. In this case using Sparse representation or not has no effect on the outcome (identical predictions without OHE, different predictions with it).\r\n\r\nPackage versions I used to replicate this are:\r\n```\r\nnumpy: 1.15.4\r\nscikit-learn: 0.24.2\r\nonnx:  1.8.0\r\nonnxruntime:  1.1.2\r\nskl2onnx:  1.8.0\r\n```\r\n","closed_by":{"login":"xadupre","id":22452781,"node_id":"MDQ6VXNlcjIyNDUyNzgx","avatar_url":"https://avatars.githubusercontent.com/u/22452781?v=4","gravatar_id":"","url":"https://api.github.com/users/xadupre","html_url":"https://github.com/xadupre","followers_url":"https://api.github.com/users/xadupre/followers","following_url":"https://api.github.com/users/xadupre/following{/other_user}","gists_url":"https://api.github.com/users/xadupre/gists{/gist_id}","starred_url":"https://api.github.com/users/xadupre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xadupre/subscriptions","organizations_url":"https://api.github.com/users/xadupre/orgs","repos_url":"https://api.github.com/users/xadupre/repos","events_url":"https://api.github.com/users/xadupre/events{/privacy}","received_events_url":"https://api.github.com/users/xadupre/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/671/timeline","performed_via_github_app":null,"state_reason":"completed"}