{"url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874","repository_url":"https://api.github.com/repos/onnx/sklearn-onnx","labels_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874/labels{/name}","comments_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874/comments","events_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874/events","html_url":"https://github.com/onnx/sklearn-onnx/issues/874","id":1270976434,"node_id":"I_kwDOCa0gS85LwY-y","number":874,"title":"MissingShapeCalculator rises with feature_engine library","user":{"login":"carneche","id":26437368,"node_id":"MDQ6VXNlcjI2NDM3MzY4","avatar_url":"https://avatars.githubusercontent.com/u/26437368?v=4","gravatar_id":"","url":"https://api.github.com/users/carneche","html_url":"https://github.com/carneche","followers_url":"https://api.github.com/users/carneche/followers","following_url":"https://api.github.com/users/carneche/following{/other_user}","gists_url":"https://api.github.com/users/carneche/gists{/gist_id}","starred_url":"https://api.github.com/users/carneche/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/carneche/subscriptions","organizations_url":"https://api.github.com/users/carneche/orgs","repos_url":"https://api.github.com/users/carneche/repos","events_url":"https://api.github.com/users/carneche/events{/privacy}","received_events_url":"https://api.github.com/users/carneche/received_events","type":"User","site_admin":false},"labels":[{"id":2011460598,"node_id":"MDU6TGFiZWwyMDExNDYwNTk4","url":"https://api.github.com/repos/onnx/sklearn-onnx/labels/Custom%20Converter","name":"Custom Converter","color":"f7b3b2","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"xiaowuhu","id":19218188,"node_id":"MDQ6VXNlcjE5MjE4MTg4","avatar_url":"https://avatars.githubusercontent.com/u/19218188?v=4","gravatar_id":"","url":"https://api.github.com/users/xiaowuhu","html_url":"https://github.com/xiaowuhu","followers_url":"https://api.github.com/users/xiaowuhu/followers","following_url":"https://api.github.com/users/xiaowuhu/following{/other_user}","gists_url":"https://api.github.com/users/xiaowuhu/gists{/gist_id}","starred_url":"https://api.github.com/users/xiaowuhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiaowuhu/subscriptions","organizations_url":"https://api.github.com/users/xiaowuhu/orgs","repos_url":"https://api.github.com/users/xiaowuhu/repos","events_url":"https://api.github.com/users/xiaowuhu/events{/privacy}","received_events_url":"https://api.github.com/users/xiaowuhu/received_events","type":"User","site_admin":false},"assignees":[{"login":"xiaowuhu","id":19218188,"node_id":"MDQ6VXNlcjE5MjE4MTg4","avatar_url":"https://avatars.githubusercontent.com/u/19218188?v=4","gravatar_id":"","url":"https://api.github.com/users/xiaowuhu","html_url":"https://github.com/xiaowuhu","followers_url":"https://api.github.com/users/xiaowuhu/followers","following_url":"https://api.github.com/users/xiaowuhu/following{/other_user}","gists_url":"https://api.github.com/users/xiaowuhu/gists{/gist_id}","starred_url":"https://api.github.com/users/xiaowuhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiaowuhu/subscriptions","organizations_url":"https://api.github.com/users/xiaowuhu/orgs","repos_url":"https://api.github.com/users/xiaowuhu/repos","events_url":"https://api.github.com/users/xiaowuhu/events{/privacy}","received_events_url":"https://api.github.com/users/xiaowuhu/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-06-14T15:23:30Z","updated_at":"2022-09-27T05:37:39Z","closed_at":"2022-09-27T05:37:39Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\nI used feature engine library to do feature engineering and selection within a pipeline (sklearn) then I combined it to Random forest classifier with Random grid search. Hence, when I want to save my pipeline into ONNX file, I got error. I understood that the problem is related to that library. I tried the solution proposed on this page: https://onnx.ai/sklearn-onnx/pipeline.html but it dosen't work.\r\nDo you how I can solve this problem?\r\n\r\nHere is my code snippet:\r\n\r\n```\r\npipe = Pipeline([\r\n\r\n    # discretisation + encoding\r\n    ('discretisation', dsc.EqualFrequencyDiscretiser(\r\n        q=5, return_object=True, variables=continues)),\r\n    \r\n    ('encoding', ce.OrdinalEncoder(\r\n        encoding_method='ordered', variables=continues)),\r\n   \r\n    # feature selection\r\n    ('constant', DropConstantFeatures(tol=0.5)),\r\n    ('duplicated', DropDuplicateFeatures()),\r\n    ('correlation', SmartCorrelatedSelection(selection_method='variance')),\r\n    \r\n     # feature Scaling \r\n    ('scaler', StandardScaler()),\r\n])\r\n\r\n# First create the base model to tune\r\nrf = RandomForestClassifier()\r\n\r\nparam_grid = dict(\r\n    n_estimators=stats.randint(10, 1000),\r\n    min_samples_split=stats.uniform(0, 1),\r\n    max_depth=stats.randint(1, 5),\r\n    max_features = ('auto', 'sqrt'),\r\n    bootstrap = (True, False)\r\n    )\r\n# Use the random grid to search for best hyperparameters\r\nrf_random = RandomizedSearchCV(rf, \r\n                               param_grid, \r\n                               n_iter = 60,\r\n                               scoring='roc_auc',\r\n                               cv = 5,\r\n                               random_state=42, \r\n                               n_jobs = -1, \r\n                               refit=True)\r\n\r\nclf = make_pipeline(pipe, rf_random)\r\nclf.fit(X_train, y_train)\r\n\r\n# Save the pipeline into ONNX format file\r\nfrom skl2onnx import convert_sklearn\r\nfrom skl2onnx.common.data_types import FloatTensorType\r\ninitial_type = [('float_input', FloatTensorType([None, 11]))]\r\nonx = convert_sklearn(clf, initial_types=initial_type)\r\nwith open(\"outputs/rf.onnx\", \"wb\") as f:\r\n    f.write(onx.SerializeToString())\r\n\r\n---------------------------------------------------------------------------\r\nMissingShapeCalculator                    Traceback (most recent call last)\r\n<ipython-input-38-09a297488473> in <module>\r\n      3 from skl2onnx.common.data_types import FloatTensorType\r\n      4 initial_type = [('float_input', FloatTensorType([None, 11]))]\r\n----> 5 onx = convert_sklearn(clf, initial_types=initial_type)\r\n      6 with open(\"outputs/rf.onnx\", \"wb\") as f:\r\n      7     f.write(onx.SerializeToString())\r\n\r\n~\\anaconda3\\envs\\Learn_ML\\lib\\site-packages\\skl2onnx\\convert.py in convert_sklearn(model, name, initial_types, doc_string, target_opset, custom_conversion_functions, custom_shape_calculators, custom_parsers, options, intermediate, white_op, black_op, final_types, dtype, naming, verbose)\r\n    184     onnx_model = convert_topology(\r\n    185         topology, name, doc_string, target_opset, options=options,\r\n--> 186         remove_identity=not intermediate, verbose=verbose)\r\n    187     if verbose >= 1:\r\n    188         print(\"[convert_sklearn] end\")\r\n\r\n~\\anaconda3\\envs\\Learn_ML\\lib\\site-packages\\skl2onnx\\common\\_topology.py in convert_topology(topology, model_name, doc_string, target_opset, channel_first_inputs, options, remove_identity, verbose)\r\n   1419     # Traverse the graph from roots to leaves\r\n   1420     # This loop could eventually be parallelized.\r\n-> 1421     topology.convert_operators(container=container, verbose=verbose)\r\n   1422     container.ensure_topological_order()\r\n   1423 \r\n\r\n~\\anaconda3\\envs\\Learn_ML\\lib\\site-packages\\skl2onnx\\common\\_topology.py in convert_operators(self, container, verbose)\r\n   1253                         _check_variable_out_(variable, operator)\r\n   1254 \r\n-> 1255                     self.call_shape_calculator(operator)\r\n   1256                     self.call_converter(operator, container, verbose=verbose)\r\n   1257 \r\n\r\n~\\anaconda3\\envs\\Learn_ML\\lib\\site-packages\\skl2onnx\\common\\_topology.py in call_shape_calculator(self, operator)\r\n   1089         else:\r\n   1090             logger.debug('[Shape2] call infer_types for %r', operator)\r\n-> 1091             operator.infer_types()\r\n   1092 \r\n   1093     def _initialize_graph_status_for_traversing(self):\r\n\r\n~\\anaconda3\\envs\\Learn_ML\\lib\\site-packages\\skl2onnx\\common\\_topology.py in infer_types(self)\r\n    589             raise MissingShapeCalculator(\r\n    590                 \"Unable to find a shape calculator for type '{}'.\".format(\r\n--> 591                     type(self.raw_operator)))\r\n    592         try:\r\n    593             shape_calc = _registration.get_shape_calculator(self.type)\r\n\r\nMissingShapeCalculator: Unable to find a shape calculator for type '<class 'feature_engine.discretisation.equal_frequency.EqualFrequencyDiscretiser'>'.\r\nIt usually means the pipeline being converted contains a\r\ntransformer or a predictor with no corresponding converter\r\nimplemented in sklearn-onnx. If the converted is implemented\r\nin another library, you need to register\r\nthe converted so that it can be used by sklearn-onnx (function\r\nupdate_registered_converter). If the model is not yet covered\r\nby sklearn-onnx, you may raise an issue to\r\nhttps://github.com/onnx/sklearn-onnx/issues\r\nto get the converter implemented or even contribute to the\r\nproject. If the model is a custom model, a new converter must\r\nbe implemented. Examples can be found in the gallery.\r\n```","closed_by":{"login":"xiaowuhu","id":19218188,"node_id":"MDQ6VXNlcjE5MjE4MTg4","avatar_url":"https://avatars.githubusercontent.com/u/19218188?v=4","gravatar_id":"","url":"https://api.github.com/users/xiaowuhu","html_url":"https://github.com/xiaowuhu","followers_url":"https://api.github.com/users/xiaowuhu/followers","following_url":"https://api.github.com/users/xiaowuhu/following{/other_user}","gists_url":"https://api.github.com/users/xiaowuhu/gists{/gist_id}","starred_url":"https://api.github.com/users/xiaowuhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiaowuhu/subscriptions","organizations_url":"https://api.github.com/users/xiaowuhu/orgs","repos_url":"https://api.github.com/users/xiaowuhu/repos","events_url":"https://api.github.com/users/xiaowuhu/events{/privacy}","received_events_url":"https://api.github.com/users/xiaowuhu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onnx/sklearn-onnx/issues/874/timeline","performed_via_github_app":null,"state_reason":"completed"}