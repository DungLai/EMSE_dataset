{"url":"https://api.github.com/repos/netrack/keras-metrics/issues/39","repository_url":"https://api.github.com/repos/netrack/keras-metrics","labels_url":"https://api.github.com/repos/netrack/keras-metrics/issues/39/labels{/name}","comments_url":"https://api.github.com/repos/netrack/keras-metrics/issues/39/comments","events_url":"https://api.github.com/repos/netrack/keras-metrics/issues/39/events","html_url":"https://github.com/netrack/keras-metrics/issues/39","id":439231066,"node_id":"MDU6SXNzdWU0MzkyMzEwNjY=","number":39,"title":"Metrics does not work with tf.keras.estimator.model_to_estimator","user":{"login":"NKUCodingCat","id":8611032,"node_id":"MDQ6VXNlcjg2MTEwMzI=","avatar_url":"https://avatars.githubusercontent.com/u/8611032?v=4","gravatar_id":"","url":"https://api.github.com/users/NKUCodingCat","html_url":"https://github.com/NKUCodingCat","followers_url":"https://api.github.com/users/NKUCodingCat/followers","following_url":"https://api.github.com/users/NKUCodingCat/following{/other_user}","gists_url":"https://api.github.com/users/NKUCodingCat/gists{/gist_id}","starred_url":"https://api.github.com/users/NKUCodingCat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NKUCodingCat/subscriptions","organizations_url":"https://api.github.com/users/NKUCodingCat/orgs","repos_url":"https://api.github.com/users/NKUCodingCat/repos","events_url":"https://api.github.com/users/NKUCodingCat/events{/privacy}","received_events_url":"https://api.github.com/users/NKUCodingCat/received_events","type":"User","site_admin":false},"labels":[{"id":947392021,"node_id":"MDU6TGFiZWw5NDczOTIwMjE=","url":"https://api.github.com/repos/netrack/keras-metrics/labels/kind/bug","name":"kind/bug","color":"FF5252","default":false,"description":""},{"id":1057103512,"node_id":"MDU6TGFiZWwxMDU3MTAzNTEy","url":"https://api.github.com/repos/netrack/keras-metrics/labels/area/metrics","name":"area/metrics","color":"fbca04","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-05-01T16:40:55Z","updated_at":"2020-06-20T02:45:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I am trying to use `tf.keras.estimator.model_to_estimator` to convert tf.keras model to be distributed, however, I found that keras-metrics does not work as desired, Is there any idea or work around for me ? thanks\r\n\r\nTraceback:\r\n```\r\nTraceback (most recent call last):\r\n  File \"1.py\", line 204, in <module>\r\n    tf.app.run()\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 125, in run\r\n    _sys.exit(main(argv))\r\n  File \"1.py\", line 190, in main\r\n    config=Rcfg\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/estimator/__init__.py\", line 73, in model_to_estimator\r\n    config=config)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow_estimator/python/estimator/keras.py\", line 486, in model_to_estimator\r\n    config)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow_estimator/python/estimator/keras.py\", line 354, in _save_first_checkpoint\r\n    custom_objects)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow_estimator/python/estimator/keras.py\", line 201, in _clone_and_build_model\r\n    optimizer_iterations=global_step)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/models.py\", line 511, in clone_and_build_model\r\n    target_tensors=target_tensors)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/checkpointable/base.py\", line 442, in _method_wrapper\r\n    method(self, *args, **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/engine/training.py\", line 499, in compile\r\n    sample_weights=self.sample_weights)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/engine/training.py\", line 1844, in _handle_metrics\r\n    return_stateful_result=return_stateful_result))\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/engine/training.py\", line 1800, in _handle_per_output_metrics\r\n    stateful_metric_result = _call_stateful_fn(stateful_fn)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/engine/training.py\", line 1773, in _call_stateful_fn\r\n    fn, y_true, y_pred, weights=weights, mask=mask)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/engine/training_utils.py\", line 852, in call_metric_function\r\n    return metric_fn(y_true, y_pred, sample_weight=weights)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/metrics.py\", line 438, in __call__\r\n    update_op = self.update_state(*args, **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/metrics.py\", line 160, in inner\r\n    return func.__get__(instance_ref(), cls)(*args, **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/metrics.py\", line 98, in decorated\r\n    update_op = update_state_fn(*args, **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/keras/metrics.py\", line 649, in update_state\r\n    matches = self._fn(y_true, y_pred, **self._fn_kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/keras_metrics/metrics.py\", line 192, in __call__\r\n    tp = self.tp(y_true, y_pred)\r\n  File \"/usr/local/lib/python2.7/dist-packages/keras_metrics/metrics.py\", line 50, in __call__\r\n    tp_update = K.update_add(self.tp, tp)\r\n  File \"/usr/local/lib/python2.7/dist-packages/keras/backend/tensorflow_backend.py\", line 986, in update_add\r\n    return tf.assign_add(x, increment)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/state_ops.py\", line 190, in assign_add\r\n    ref, value, use_locking=use_locking, name=name)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_state_ops.py\", line 107, in assign_add\r\n    \"AssignAdd\", ref=ref, value=value, use_locking=use_locking, name=name)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 350, in _apply_op_helper\r\n    g = ops._get_graph_from_inputs(_Flatten(keywords.values()))\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 5713, in _get_graph_from_inputs\r\n    _assert_same_graph(original_graph_element, graph_element)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 5649, in _assert_same_graph\r\n    original_item))\r\nValueError: Tensor(\"metrics/precision/Sum:0\", shape=(), dtype=int32) must be from the same graph as Tensor(\"Variable:0\", shape=(), dtype=int32_ref).\r\n```\r\n\r\nBuggy code (a little bit messy...)\r\n\r\n[model.py.zip](https://github.com/netrack/keras-metrics/files/3135195/model.py.zip)\r\n\r\nIf I dont add `keras_metrics.sparse_categorical_precision()` into Accuracy part, it DOES work but fail when I add sparse_categorical_precision...\r\n\r\nTested in Py2.7/3.7 TF 1.13.1","closed_by":null,"reactions":{"url":"https://api.github.com/repos/netrack/keras-metrics/issues/39/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netrack/keras-metrics/issues/39/timeline","performed_via_github_app":null,"state_reason":null}