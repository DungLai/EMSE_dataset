{"url":"https://api.github.com/repos/theislab/diffxpy/issues/115","repository_url":"https://api.github.com/repos/theislab/diffxpy","labels_url":"https://api.github.com/repos/theislab/diffxpy/issues/115/labels{/name}","comments_url":"https://api.github.com/repos/theislab/diffxpy/issues/115/comments","events_url":"https://api.github.com/repos/theislab/diffxpy/issues/115/events","html_url":"https://github.com/theislab/diffxpy/issues/115","id":487284380,"node_id":"MDU6SXNzdWU0ODcyODQzODA=","number":115,"title":"`rank_test`, `t_test` fails when X is csc_matrix","user":{"login":"ivirshup","id":8238804,"node_id":"MDQ6VXNlcjgyMzg4MDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8238804?v=4","gravatar_id":"","url":"https://api.github.com/users/ivirshup","html_url":"https://github.com/ivirshup","followers_url":"https://api.github.com/users/ivirshup/followers","following_url":"https://api.github.com/users/ivirshup/following{/other_user}","gists_url":"https://api.github.com/users/ivirshup/gists{/gist_id}","starred_url":"https://api.github.com/users/ivirshup/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivirshup/subscriptions","organizations_url":"https://api.github.com/users/ivirshup/orgs","repos_url":"https://api.github.com/users/ivirshup/repos","events_url":"https://api.github.com/users/ivirshup/events{/privacy}","received_events_url":"https://api.github.com/users/ivirshup/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-08-30T04:50:12Z","updated_at":"2020-05-20T19:41:24Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"Quick example:\r\n\r\n```python\r\nimport diffxpy.api as de\r\nfrom scipy import sparse\r\n\r\nde.test.rank_test(\r\n    sparse.random(4, 4, format=\"csc\"),\r\n    grouping=list(\"aabb\"), gene_names=list(\"abcd\")\r\n)\r\n```\r\n\r\n<details>\r\n<summary>Traceback: </summary>\r\n\r\n```python\r\n---------------------------------------------------------------------------\r\nIndexError                                Traceback (most recent call last)\r\n<ipython-input-23-6ee2d0603d17> in <module>\r\n----> 1 de.test.rank_test(s, grouping=[\"a\", \"a\", \"b\", \"b\"], gene_names=list(\"abcd\"))\r\n\r\n/usr/local/lib/python3.7/site-packages/diffxpy/testing/tests.py in rank_test(data, grouping, gene_names, sample_description, is_logged, is_sig_zerovar)\r\n    722         gene_names=gene_names,\r\n    723         is_logged=is_logged,\r\n--> 724         is_sig_zerovar=is_sig_zerovar\r\n    725     )\r\n    726 \r\n\r\n/usr/local/lib/python3.7/site-packages/diffxpy/testing/det.py in __init__(self, data, sample_description, grouping, gene_names, is_logged, is_sig_zerovar)\r\n   1694             var_x1 = np.asarray(np.mean(x1.power(2), axis=0)).flatten().astype(dtype=np.float) - np.square(mean_x1)\r\n   1695         else:\r\n-> 1696             var_x0 = np.asarray(np.var(x0, axis=0)).flatten().astype(dtype=np.float)\r\n   1697             var_x1 = np.asarray(np.var(x1, axis=0)).flatten().astype(dtype=np.float)\r\n   1698         self._var_geq_zero = np.logical_or(\r\n\r\n<__array_function__ internals> in var(*args, **kwargs)\r\n\r\n/usr/local/lib/python3.7/site-packages/numpy/core/fromnumeric.py in var(a, axis, dtype, out, ddof, keepdims)\r\n   3504 \r\n   3505     return _methods._var(a, axis=axis, dtype=dtype, out=out, ddof=ddof,\r\n-> 3506                          **kwargs)\r\n   3507 \r\n   3508 \r\n\r\n/usr/local/lib/python3.7/site-packages/numpy/core/_methods.py in _var(a, axis, dtype, out, ddof, keepdims)\r\n    168     arr = asanyarray(a)\r\n    169 \r\n--> 170     rcount = _count_reduce_items(arr, axis)\r\n    171     # Make this warning show up on top.\r\n    172     if ddof >= rcount:\r\n\r\n/usr/local/lib/python3.7/site-packages/numpy/core/_methods.py in _count_reduce_items(arr, axis)\r\n     55     items = 1\r\n     56     for ax in axis:\r\n---> 57         items *= arr.shape[ax]\r\n     58     return items\r\n     59 \r\n\r\nIndexError: tuple index out of range\r\n```\r\n\r\n</details>\r\n\r\nThe same thing happens with `de.test.t_test`.\r\n\r\nI came across this while trying to see if using a rank test on a csc sparse matrix would be closer in speed to a dense array (since a lot of time is spent resolving indices when it's called on a csr sparse matrix).\r\n\r\nSince they're both failing on variance calculation, you could use `sklearn.utils.sparsefuncs.mean_variance_axis` since it's pretty fast.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/theislab/diffxpy/issues/115/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/theislab/diffxpy/issues/115/timeline","performed_via_github_app":null,"state_reason":null}