{"url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46","repository_url":"https://api.github.com/repos/ProGamerGov/neural-style-pt","labels_url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46/labels{/name}","comments_url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46/comments","events_url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46/events","html_url":"https://github.com/ProGamerGov/neural-style-pt/issues/46","id":515184848,"node_id":"MDU6SXNzdWU1MTUxODQ4NDg=","number":46,"title":"Fork implementing multi-region spatial control","user":{"login":"genekogan","id":1335251,"node_id":"MDQ6VXNlcjEzMzUyNTE=","avatar_url":"https://avatars.githubusercontent.com/u/1335251?v=4","gravatar_id":"","url":"https://api.github.com/users/genekogan","html_url":"https://github.com/genekogan","followers_url":"https://api.github.com/users/genekogan/followers","following_url":"https://api.github.com/users/genekogan/following{/other_user}","gists_url":"https://api.github.com/users/genekogan/gists{/gist_id}","starred_url":"https://api.github.com/users/genekogan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/genekogan/subscriptions","organizations_url":"https://api.github.com/users/genekogan/orgs","repos_url":"https://api.github.com/users/genekogan/repos","events_url":"https://api.github.com/users/genekogan/events{/privacy}","received_events_url":"https://api.github.com/users/genekogan/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":34,"created_at":"2019-10-31T05:53:03Z","updated_at":"2020-01-07T20:30:27Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"First of all, this is a great repo! It seems a bit faster and more memory efficient than the original lua-based neural-style.\r\n\r\nI've made a [fork of this repo](https://github.com/genekogan/neural-style-pt) trying to add masked style transfer [as described by Gatys](https://arxiv.org/abs/1611.07865), and going off of the [gist you wrote for the lua version](https://gist.github.com/ProGamerGov/bcbd27a3d2e431adb73ef158d9990d93). \r\n\r\nI've almost got it working, but my implementation is suffering from two bugs. The first is that, testing with two style images and segmentations, my implementation seems only to get gradients for the first mask but not the second. \r\n\r\nSo for example, the following command:\r\n\r\n`python neural_style.py -backend cudnn -style_image examples/inputs/cubist.jpg,examples/inputs/starry_night.jpg -style_seg examples/segments/cubist.png,examples/segments/starry_night.png -content_seg examples/segments/monalisa.png -color_codes white,black`\r\n\r\nproduces the following output:\r\n\r\n![out1](https://user-images.githubusercontent.com/1335251/67922012-dbe2c100-fb7f-11e9-8374-9dab98029a97.png)\r\n\r\nwhere the first style (cubist) and corresponding segmentation get good gradients and works in the mask provided, but the second mask (starry night) has little or no gradient signal.\r\n\r\nBy simply swapping the order of the style images, as in:\r\n\r\n`python neural_style.py -backend cudnn -style_image examples/inputs/starry_night.jpg,examples/inputs/cubist.jpg -style_seg examples/segments/starry_night.png,examples/segments/cubist.png -content_seg examples/segments/monalisa.png -color_codes white,black`\r\n\r\nI get the opposite effect where only the starry night style works and the cubist style in its mask is not there.\r\n\r\n![out2](https://user-images.githubusercontent.com/1335251/67922122-2e23e200-fb80-11e9-9d55-3a0473489c97.png)\r\n\r\nI have been trying to debug this, checking the masks, and everything seems right to me, and I can't figure out the problem. This was almost a pytorch mirror of what you made in your gist, which does appear to work fine. I'm not sure if there's some typo I'm missing or something deeper.\r\n\r\nAdditionally, `loss.backward()` without keeping the gradients with `retain_graph=True` produces a runtime error (`RuntimeError: Trying to backward through the graph a second time, but the buffers have already been freed. Specify retain_graph=True when calling backward the first time.`), which makes me think I setup the graph wrong.\r\n\r\nIf you are able to see what I'm doing wrong so that we can fix it, I'd love to see this implemented in PyTorch. I think it would be a really nice addition to the repo.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ProGamerGov/neural-style-pt/issues/46/timeline","performed_via_github_app":null,"state_reason":null}