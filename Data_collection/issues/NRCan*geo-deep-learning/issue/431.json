{"url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431","repository_url":"https://api.github.com/repos/NRCan/geo-deep-learning","labels_url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431/labels{/name}","comments_url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431/comments","events_url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431/events","html_url":"https://github.com/NRCan/geo-deep-learning/issues/431","id":1495138999,"node_id":"I_kwDOCNASdM5ZHgK3","number":431,"title":"[bug] Tiling creates an invalid geometry inside vector patch (.geojson)","user":{"login":"remtav","id":34774759,"node_id":"MDQ6VXNlcjM0Nzc0NzU5","avatar_url":"https://avatars.githubusercontent.com/u/34774759?v=4","gravatar_id":"","url":"https://api.github.com/users/remtav","html_url":"https://github.com/remtav","followers_url":"https://api.github.com/users/remtav/followers","following_url":"https://api.github.com/users/remtav/following{/other_user}","gists_url":"https://api.github.com/users/remtav/gists{/gist_id}","starred_url":"https://api.github.com/users/remtav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/remtav/subscriptions","organizations_url":"https://api.github.com/users/remtav/orgs","repos_url":"https://api.github.com/users/remtav/repos","events_url":"https://api.github.com/users/remtav/events{/privacy}","received_events_url":"https://api.github.com/users/remtav/received_events","type":"User","site_admin":false},"labels":[{"id":1070498720,"node_id":"MDU6TGFiZWwxMDcwNDk4NzIw","url":"https://api.github.com/repos/NRCan/geo-deep-learning/labels/P2","name":"P2","color":"bcbddc","default":false,"description":"Medium priority"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-12-13T20:53:25Z","updated_at":"2022-12-19T15:19:39Z","closed_at":"2022-12-19T15:19:39Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"The attached vector ground truth patch contains an invalid geomatry for building footprint. As it is not empty, the tiling script proceeds to computing its bounds, but this step fails and hinders the entire tiling process (see #430 ):\r\n\r\nStack trace:\r\n```bash\r\nTraceback (most recent call last):\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/GDL.py\", line 83, in <module>\r\n    run_gdl()\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/main.py\", line 90, in decorated_main\r\n    _run_hydra(\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/utils.py\", line 389, in _run_hydra\r\n    _run_app(\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/utils.py\", line 452, in _run_app\r\n    run_and_report(\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/utils.py\", line 296, in run_and_report\r\n    raise ex\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/utils.py\", line 213, in run_and_report\r\n    return func()\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/utils.py\", line 453, in <lambda>\r\n    lambda: hydra.run(\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/_internal/hydra.py\", line 132, in run\r\n    _ = ret.return_value\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/core/utils.py\", line 260, in return_value\r\n    raise self._return_value\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/hydra/core/utils.py\", line 186, in run_job\r\n    ret.return_value = task_function(task_cfg)\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/GDL.py\", line 62, in run_gdl\r\n    task(cfg)\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/tiling_segmentation.py\", line 764, in main\r\n    line_tuple = tiler.filter_and_burn_dataset(aoi,\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/tiling_segmentation.py\", line 514, in filter_and_burn_dataset\r\n    min_annot_success, annot_perc = self.passes_min_annot(\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/tiling_segmentation.py\", line 394, in passes_min_annot\r\n    annot_perc = annot_percent(\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/tiling_segmentation.py\", line 50, in annot_percent\r\n    bounds_iou = AOI.bounds_iou_gdf_riodataset(gdf_patch, img_patch_dataset)\r\n  File \"/fs/vnas_Hnrcan/geobase/ret000/geo-deep-learning/dataset/aoi.py\", line 622, in bounds_iou_gdf_riodataset\r\n    label_bounds_box = box(*label_bounds.tolist())\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/shapely/geometry/geo.py\", line 64, in box\r\n    return Polygon(coords)\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/shapely/geometry/polygon.py\", line 261, in __init__\r\n    ret = geos_polygon_from_py(shell, holes)\r\n  File \"/space/partner/nrcan/geobase/work/opt/miniconda-gdl-ops/envs/geo_deep_env/lib/python3.10/site-packages/shapely/geometry/polygon.py\", line 539, in geos_polygon_from_py\r\n    ret = geos_linearring_from_py(shell)\r\n  File \"shapely/speedups/_speedups.pyx\", line 413, in shapely.speedups._speedups.geos_linearring_from_py\r\nValueError: GEOSGeom_createLinearRing_r returned a NULL pointer\r\n```\r\n\r\nGround truth patch:\r\n[mos_15_21l11_ne_30cm_f07_clipped_251855_4_5167007_999999999.zip](https://github.com/NRCan/geo-deep-learning/files/10221670/mos_15_21l11_ne_30cm_f07_clipped_251855_4_5167007_999999999.zip)\r\n\r\nSource vector data:\r\n[QC27_MTM7_ORTHO30cm_2015.zip](https://github.com/NRCan/geo-deep-learning/files/10221934/QC27_MTM7_ORTHO30cm_2015.zip)\r\n\r\nTo reproduce:\r\n```python\r\nimport numpy as np\r\nfrom shapely.geometry import box\r\n\r\nfrom dataset.aoi import AOI\r\nfrom utils.geoutils import check_gdf_load\r\n\r\nproblem_patch_gt = \"path/to/mos_15_21l11_ne_30cm_f07_clipped_251855_4_5167007_999999999.geojson\"\r\n\r\ngdf = check_gdf_load(problem_patch_gt)\r\nlabel_gdf_filtered = AOI.filter_gdf_by_attribute(\r\n    gdf.copy(deep=True),\r\n    'Quatreclasses',\r\n    [4],\r\n)\r\nlabel_bounds = label_gdf_filtered.total_bounds\r\nvalid_series = label_gdf_filtered.is_valid\r\nvalid_ndarray = valid_series.to_numpy()\r\nassert not gdf.empty  # succeeds\r\n\r\nlabel_bounds_box = box(*label_bounds.tolist())  # Fails\r\nassert np.all(valid_ndarray)  # Also fails\r\n\r\n# Succeeds...\r\ntry:\r\n    label_bounds_box = box(*label_bounds.tolist())\r\nexcept ValueError as e:\r\n    print(e)\r\n```\r\n\r\nStrangely, the source ground truth geopackage from which the tiling was done contains no invalid geometries:\r\n\r\n```python\r\nsource_gt = \"path/to/QC27_MTM7_ORTHO30cm_2015.gpkg\"\r\n\r\ngdf = gpd.read_file(gpkg)\r\ngdf_buildings = AOI.filter_gdf_by_attribute(\r\n    gdf.copy(deep=True),\r\n    'Quatreclasses',\r\n    [4],\r\n)\r\n\r\nvalid_series = gdf_buildings.is_valid\r\nvalid_ndarray = valid_series.to_numpy()\r\nassert np.all(valid_ndarray)   # succeeds\r\n```\r\n\r\nThis means it is our tiling process that creates an invalid geometry. To be investigated.","closed_by":{"login":"ms888ekb","id":54916039,"node_id":"MDQ6VXNlcjU0OTE2MDM5","avatar_url":"https://avatars.githubusercontent.com/u/54916039?v=4","gravatar_id":"","url":"https://api.github.com/users/ms888ekb","html_url":"https://github.com/ms888ekb","followers_url":"https://api.github.com/users/ms888ekb/followers","following_url":"https://api.github.com/users/ms888ekb/following{/other_user}","gists_url":"https://api.github.com/users/ms888ekb/gists{/gist_id}","starred_url":"https://api.github.com/users/ms888ekb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ms888ekb/subscriptions","organizations_url":"https://api.github.com/users/ms888ekb/orgs","repos_url":"https://api.github.com/users/ms888ekb/repos","events_url":"https://api.github.com/users/ms888ekb/events{/privacy}","received_events_url":"https://api.github.com/users/ms888ekb/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/NRCan/geo-deep-learning/issues/431/timeline","performed_via_github_app":null,"state_reason":"completed"}