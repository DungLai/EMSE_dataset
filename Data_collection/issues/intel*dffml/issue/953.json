{"url":"https://api.github.com/repos/intel/dffml/issues/953","repository_url":"https://api.github.com/repos/intel/dffml","labels_url":"https://api.github.com/repos/intel/dffml/issues/953/labels{/name}","comments_url":"https://api.github.com/repos/intel/dffml/issues/953/comments","events_url":"https://api.github.com/repos/intel/dffml/issues/953/events","html_url":"https://github.com/intel/dffml/issues/953","id":782279573,"node_id":"MDU6SXNzdWU3ODIyNzk1NzM=","number":953,"title":"model: transformers: AttributeError: 'OneDeviceStrategy' object has no attribute 'experimental_run_v2'","user":{"login":"pdxjohnny","id":5950433,"node_id":"MDQ6VXNlcjU5NTA0MzM=","avatar_url":"https://avatars.githubusercontent.com/u/5950433?v=4","gravatar_id":"","url":"https://api.github.com/users/pdxjohnny","html_url":"https://github.com/pdxjohnny","followers_url":"https://api.github.com/users/pdxjohnny/followers","following_url":"https://api.github.com/users/pdxjohnny/following{/other_user}","gists_url":"https://api.github.com/users/pdxjohnny/gists{/gist_id}","starred_url":"https://api.github.com/users/pdxjohnny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdxjohnny/subscriptions","organizations_url":"https://api.github.com/users/pdxjohnny/orgs","repos_url":"https://api.github.com/users/pdxjohnny/repos","events_url":"https://api.github.com/users/pdxjohnny/events{/privacy}","received_events_url":"https://api.github.com/users/pdxjohnny/received_events","type":"User","site_admin":false},"labels":[{"id":1062701217,"node_id":"MDU6TGFiZWwxMDYyNzAxMjE3","url":"https://api.github.com/repos/intel/dffml/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1474883282,"node_id":"MDU6TGFiZWwxNDc0ODgzMjgy","url":"https://api.github.com/repos/intel/dffml/labels/kind/ml","name":"kind/ml","color":"0e8a16","default":false,"description":"Issues partaining to machine learning"},{"id":1740392441,"node_id":"MDU6TGFiZWwxNzQwMzkyNDQx","url":"https://api.github.com/repos/intel/dffml/labels/p0","name":"p0","color":"b60205","default":false,"description":"Critical Priority"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/intel/dffml/milestones/12","html_url":"https://github.com/intel/dffml/milestone/12","labels_url":"https://api.github.com/repos/intel/dffml/milestones/12/labels","id":5313485,"node_id":"MDk6TWlsZXN0b25lNTMxMzQ4NQ==","number":12,"title":"0.4.0 Alpha Release","description":"","creator":{"login":"pdxjohnny","id":5950433,"node_id":"MDQ6VXNlcjU5NTA0MzM=","avatar_url":"https://avatars.githubusercontent.com/u/5950433?v=4","gravatar_id":"","url":"https://api.github.com/users/pdxjohnny","html_url":"https://github.com/pdxjohnny","followers_url":"https://api.github.com/users/pdxjohnny/followers","following_url":"https://api.github.com/users/pdxjohnny/following{/other_user}","gists_url":"https://api.github.com/users/pdxjohnny/gists{/gist_id}","starred_url":"https://api.github.com/users/pdxjohnny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdxjohnny/subscriptions","organizations_url":"https://api.github.com/users/pdxjohnny/orgs","repos_url":"https://api.github.com/users/pdxjohnny/repos","events_url":"https://api.github.com/users/pdxjohnny/events{/privacy}","received_events_url":"https://api.github.com/users/pdxjohnny/received_events","type":"User","site_admin":false},"open_issues":0,"closed_issues":119,"state":"closed","created_at":"2020-04-15T22:17:52Z","updated_at":"2021-02-26T21:58:12Z","due_on":"2021-02-18T08:00:00Z","closed_at":"2021-02-18T23:38:00Z"},"comments":1,"created_at":"2021-01-08T17:23:56Z","updated_at":"2021-01-09T01:32:52Z","closed_at":"2021-01-09T01:32:51Z","author_association":"MEMBER","active_lock_reason":null,"body":"This happened after upgrading to tensorflow version 2.4.0\n\n```\n======================================================================\nERROR: test_run (tests.test_classification_integration.TestHFClassifier)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/runner/work/dffml/dffml/dffml/util/asynctestcase.py\", line 69, in run_it\n    result = self.loop.run_until_complete(coro(*args, **kwargs))\n  File \"/usr/share/miniconda/lib/python3.7/asyncio/base_events.py\", line 587, in run_until_complete\n    return future.result()\n  File \"/home/runner/work/dffml/dffml/model/transformers/tests/test_classification_integration.py\", line 114, in test_run\n    data_filename,\n  File \"/home/runner/work/dffml/dffml/dffml/util/cli/cmd.py\", line 224, in cli\n    return await cmd.do_run()\n  File \"/home/runner/work/dffml/dffml/dffml/util/cli/cmd.py\", line 203, in do_run\n    return await self.run()\n  File \"/home/runner/work/dffml/dffml/dffml/cli/ml.py\", line 40, in run\n    return await train(self.model, self.sources)\n  File \"/home/runner/work/dffml/dffml/dffml/high_level.py\", line 388, in train\n    return await mctx.train(sctx)\n  File \"/home/runner/work/dffml/dffml/model/transformers/dffml_model_transformers/classification/classification_model.py\", line 328, in train\n    trainer.train()\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 412, in train\n    for step, training_loss in enumerate(self._training_steps(train_ds, optimizer)):\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 459, in _training_steps\n    for i, loss in enumerate(self._accumulate_next_gradients(ds)):\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 492, in _accumulate_next_gradients\n    yield _accumulate_next()\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 828, in __call__\n    result = self._call(*args, **kwds)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 871, in _call\n    self._initialize(args, kwds, add_initializers_to=initializers)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 726, in _initialize\n    *args, **kwds))\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 2969, in _get_concrete_function_internal_garbage_collected\n    graph_function, _ = self._maybe_define_function(args, kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 3361, in _maybe_define_function\n    graph_function = self._create_graph_function(args, kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 3206, in _create_graph_function\n    capture_by_value=self._capture_by_value),\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py\", line 990, in func_graph_from_py_func\n    func_outputs = python_func(*func_args, **func_kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 634, in wrapped_fn\n    out = weak_wrapped_fn().__wrapped__(*args, **kwds)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py\", line 977, in wrapper\n    raise e.ag_error_metadata.to_exception(e)\nAttributeError: in user code:\n\n    /usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py:488 _accumulate_next  *\n        return self._accumulate_gradients(per_replica_features, per_replica_labels)\n    /usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py:498 _accumulate_gradients  *\n        per_replica_loss = self.args.strategy.experimental_run_v2(\n\n    AttributeError: 'OneDeviceStrategy' object has no attribute 'experimental_run_v2'\n\n\n======================================================================\nERROR: test_00_train (tests.test_ner_model.TestNERModel)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/runner/work/dffml/dffml/dffml/util/asynctestcase.py\", line 69, in run_it\n    result = self.loop.run_until_complete(coro(*args, **kwargs))\n  File \"/usr/share/miniconda/lib/python3.7/asyncio/base_events.py\", line 587, in run_until_complete\n    return future.result()\n  File \"/home/runner/work/dffml/dffml/model/transformers/tests/test_ner_model.py\", line 75, in test_00_train\n    await mctx.train(sctx)\n  File \"/home/runner/work/dffml/dffml/model/transformers/dffml_model_transformers/ner/ner_model.py\", line 389, in train\n    trainer.train()\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 412, in train\n    for step, training_loss in enumerate(self._training_steps(train_ds, optimizer)):\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 459, in _training_steps\n    for i, loss in enumerate(self._accumulate_next_gradients(ds)):\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py\", line 492, in _accumulate_next_gradients\n    yield _accumulate_next()\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 828, in __call__\n    result = self._call(*args, **kwds)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 871, in _call\n    self._initialize(args, kwds, add_initializers_to=initializers)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 726, in _initialize\n    *args, **kwds))\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 2969, in _get_concrete_function_internal_garbage_collected\n    graph_function, _ = self._maybe_define_function(args, kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 3361, in _maybe_define_function\n    graph_function = self._create_graph_function(args, kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 3206, in _create_graph_function\n    capture_by_value=self._capture_by_value),\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py\", line 990, in func_graph_from_py_func\n    func_outputs = python_func(*func_args, **func_kwargs)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 634, in wrapped_fn\n    out = weak_wrapped_fn().__wrapped__(*args, **kwds)\n  File \"/usr/share/miniconda/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py\", line 977, in wrapper\n    raise e.ag_error_metadata.to_exception(e)\nAttributeError: in user code:\n\n    /usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py:488 _accumulate_next  *\n        return self._accumulate_gradients(per_replica_features, per_replica_labels)\n    /usr/share/miniconda/lib/python3.7/site-packages/transformers/trainer_tf.py:498 _accumulate_gradients  *\n        per_replica_loss = self.args.strategy.experimental_run_v2(\n\n    AttributeError: 'OneDeviceStrategy' object has no attribute 'experimental_run_v2'\n```\n","closed_by":{"login":"pdxjohnny","id":5950433,"node_id":"MDQ6VXNlcjU5NTA0MzM=","avatar_url":"https://avatars.githubusercontent.com/u/5950433?v=4","gravatar_id":"","url":"https://api.github.com/users/pdxjohnny","html_url":"https://github.com/pdxjohnny","followers_url":"https://api.github.com/users/pdxjohnny/followers","following_url":"https://api.github.com/users/pdxjohnny/following{/other_user}","gists_url":"https://api.github.com/users/pdxjohnny/gists{/gist_id}","starred_url":"https://api.github.com/users/pdxjohnny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdxjohnny/subscriptions","organizations_url":"https://api.github.com/users/pdxjohnny/orgs","repos_url":"https://api.github.com/users/pdxjohnny/repos","events_url":"https://api.github.com/users/pdxjohnny/events{/privacy}","received_events_url":"https://api.github.com/users/pdxjohnny/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/intel/dffml/issues/953/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/intel/dffml/issues/953/timeline","performed_via_github_app":null,"state_reason":"completed"}