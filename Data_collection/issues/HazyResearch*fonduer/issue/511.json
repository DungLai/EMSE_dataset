{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511","repository_url":"https://api.github.com/repos/HazyResearch/fonduer","labels_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511/labels{/name}","comments_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511/comments","events_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511/events","html_url":"https://github.com/HazyResearch/fonduer/issues/511","id":703459694,"node_id":"MDU6SXNzdWU3MDM0NTk2OTQ=","number":511,"title":"Is this the right way to test the saved emmental models?","user":{"login":"saikalyan9981","id":30959693,"node_id":"MDQ6VXNlcjMwOTU5Njkz","avatar_url":"https://avatars.githubusercontent.com/u/30959693?v=4","gravatar_id":"","url":"https://api.github.com/users/saikalyan9981","html_url":"https://github.com/saikalyan9981","followers_url":"https://api.github.com/users/saikalyan9981/followers","following_url":"https://api.github.com/users/saikalyan9981/following{/other_user}","gists_url":"https://api.github.com/users/saikalyan9981/gists{/gist_id}","starred_url":"https://api.github.com/users/saikalyan9981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saikalyan9981/subscriptions","organizations_url":"https://api.github.com/users/saikalyan9981/orgs","repos_url":"https://api.github.com/users/saikalyan9981/repos","events_url":"https://api.github.com/users/saikalyan9981/events{/privacy}","received_events_url":"https://api.github.com/users/saikalyan9981/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-09-17T10:20:59Z","updated_at":"2020-09-22T20:28:32Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I have gone through the code of packaging in ML Flow. Thank you, It was very useful for me. While testing, I think the code here  [hardware_fonduer_model](https://github.com/HazyResearch/fonduer/blob/master/tests/shared/hardware_fonduer_model.py) classifies one document a time. However I would like to test in multiple documents at once:\r\n\r\nSo Is this code snippet correct, to test the model\r\n```\r\n#Loading Model\r\nmodel_dict = pickle.load(open(os.path.join(model_path, f\"{model_name}.pkl\"), \"rb\"))\r\nkey_names = model_dict[\"feature_keys\"]\r\nword2id = model_dict[\"word2id\"]\r\nemmental_model = _load_emmental_model(model_dict[\"emmental_model\"])\r\n\r\n\r\n## Extracting Test Candidates and getting features\r\nTRUE=1\r\ncandidateExtractor = CandidateExtractor(session, [candidate])\r\ncandidateExtractor.apply(context, split=0, parallelism=PARALLEL)\r\ntest_cands = candidateExtractor.get_candidates(split = 0)\r\nfeaturizer = Featurizer(session, [candidate])\r\n# featurizer.apply(split=0, train=False, parallelism=PARALLEL)\r\n\r\n# featurizer.drop_keys(key_names)\r\nfeaturizer.upsert_keys(key_names)\r\n\r\nF_test = featurizer.get_feature_matrices(test_cands)\r\ntest_dataloader = EmmentalDataLoader(\r\n            task_to_label_dict={candidate_name: \"labels\"},\r\n            dataset=FonduerDataset(candidate_name, test_cands[0], F_test[0], word2id, 2),\r\n            split=\"test\",\r\n            batch_size=100,\r\n            shuffle=False,\r\n        )\r\n\r\n# Setup config\r\nconfig = {\r\n    \"meta_config\": {\"verbose\": True},\r\n    \"model_config\": {\"model_path\": None, \"device\": 0, \"dataparallel\": False},\r\n    \"learner_config\": {\r\n        \"n_epochs\": 50,\r\n        \"optimizer_config\": {\"lr\": 0.001, \"l2\": 0.0},\r\n        \"task_scheduler\": \"round_robin\",\r\n    },\r\n    \"logging_config\": {\r\n        \"evaluation_freq\": 1,\r\n        \"counter_unit\": \"epoch\",\r\n        \"checkpointing\": False,\r\n        \"checkpointer_config\": {\r\n            \"checkpoint_metric\": {f\"{candidate_name}/train/loss\": \"min\"},\r\n            \"checkpoint_freq\": 1,\r\n            \"checkpoint_runway\": 2,\r\n            \"clear_intermediate_checkpoints\": True,\r\n            \"clear_all_checkpoints\": True,\r\n        },\r\n    },\r\n}\r\n\r\nemmental.init(Meta.log_path)\r\nemmental.Meta.update_config(config=config)\r\n\r\n## Get Test Predictions\r\ntest_preds = emmental_model.predict(test_dataloader, return_preds=True)\r\n```\r\n\r\nIs this right way to do it? \r\nI'm not sure, how to use upsert_keys, drop_keys and if I'm extracting features correctly? And should i add torch.no_grad() while predicting? \r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/511/timeline","performed_via_github_app":null,"state_reason":null}