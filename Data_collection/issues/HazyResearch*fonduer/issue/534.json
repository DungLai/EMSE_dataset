{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534","repository_url":"https://api.github.com/repos/HazyResearch/fonduer","labels_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534/labels{/name}","comments_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534/comments","events_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534/events","html_url":"https://github.com/HazyResearch/fonduer/issues/534","id":808933257,"node_id":"MDU6SXNzdWU4MDg5MzMyNTc=","number":534,"title":"HOCRParser fails to multiline Japanese strings","user":{"login":"YasushiMiyata","id":67612201,"node_id":"MDQ6VXNlcjY3NjEyMjAx","avatar_url":"https://avatars.githubusercontent.com/u/67612201?v=4","gravatar_id":"","url":"https://api.github.com/users/YasushiMiyata","html_url":"https://github.com/YasushiMiyata","followers_url":"https://api.github.com/users/YasushiMiyata/followers","following_url":"https://api.github.com/users/YasushiMiyata/following{/other_user}","gists_url":"https://api.github.com/users/YasushiMiyata/gists{/gist_id}","starred_url":"https://api.github.com/users/YasushiMiyata/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YasushiMiyata/subscriptions","organizations_url":"https://api.github.com/users/YasushiMiyata/orgs","repos_url":"https://api.github.com/users/YasushiMiyata/repos","events_url":"https://api.github.com/users/YasushiMiyata/events{/privacy}","received_events_url":"https://api.github.com/users/YasushiMiyata/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-02-16T02:23:27Z","updated_at":"2021-05-11T17:02:41Z","closed_at":"2021-05-11T17:02:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Description of the bug\r\nHocrVisualParser() fails to multiline Japanese strings like \"チェーン店\\n本・支店\".\r\nHocr parser result does not aligne with spacy parse result and throws an error \r\n`\"RuntimeError: ('Tokens are not aligned!', \"hocr tokens: ['チェーン店', '本・支店']\", \"spacy tokens: ['チェーン', '店本', '・', '支店']\")\"`\r\nThis situation same as \"hocr tokens: ['AAAA', 'BBBB']\", \"spacy tokens: ['AAA', 'AB', 'B', 'BB']\".\r\nThis might because spacy recognizes parts of different line words as one word like 'AB'. \r\n\r\n## To Reproduce\r\n1. Add test codes into \"./tests/parser/test_parser.py\"\r\n~~~\r\ndef test_parse_hocr_with_multiline_ja():\r\n    docs_path = \"tests/data/hocr_simple/jtest.hocr\"\r\n    preprocessor = HOCRDocPreprocessor(docs_path, space=False)\r\n    doc = next(iter(preprocessor))\r\n    parser_udf = get_parser_udf(\r\n        structural=True,\r\n        tabular=True,\r\n        lingual=True,\r\n        language=\"ja\",\r\n        visual_parser=HocrVisualParser(),\r\n    )\r\n    doc = parser_udf.apply(doc)\r\n    assert doc.name == \"jtest\"\r\n~~~\r\n2. Run 'pytest ./tests/parser/test_parser.py::test_parse_hocr_with_multiline_ja'\r\n\r\n### jtest.hocr\r\n~~~\r\n<?xml version=\"1.0\" ?>\r\n  <html>\r\n    <head>\r\n      <meta content=\"Generated OCRed text\" name=\"ocr-system\"/>\r\n      <meta content=\"ocr_page ocr_line ocrx_word\" name=\"ocr-capabilities\"/>\r\n    </head>\r\n    <body>\r\n      <div class=\"ocr_page\" id=\"page_1\" title=\"bbox 0 0 595 842\">\r\n          <div class=\"ocr_line\" id=\"line_1_1\" title=\"bbox 70 156 73 157\">\r\n            <span class=\"ocrx_word\" id=\"word_1_1\" title=\"bbox 70 156 73 157\">チェーン店</span>\r\n          </div>\r\n          <div class=\"ocr_line\" id=\"line_1_2\" title=\"bbox 83 171 89 172\">\r\n            <span class=\"ocrx_word\" id=\"word_1_2\" title=\"bbox 83 171 89 172\">本・支店</span>\r\n          </div>\r\n      </div>\r\n    </body>\r\n  </html>\r\n~~~\r\n\r\n## Expected behavior\r\nGet aligned tokens like \"hocr tokens: ['チェーン店', '本・支店']\", \"spacy tokens: ['チェーン', '店', '本', '・', '支店']\"\r\n\r\n\r\n## Error Logs/Screenshots\r\n~~~\r\nDocument jtest not added to database, because of parse error: \r\n('Tokens are not aligned!', \"hocr tokens: ['チェーン店', '本・支店']\", \"spacy tokens: ['チェーン', '店本', '・', '支店']\")\r\nTraceback (most recent call last):\r\n  File \"/home/miyata/work/fonduer/git/fonduer/src/fonduer/parser/parser.py\", line 246, in apply\r\n    document.name, document.sentences\r\n  File \"/home/miyata/work/fonduer/git/fonduer/src/fonduer/parser/parser.py\", line 244, in <listcomp>\r\n    y\r\n  File \"/home/miyata/work/fonduer/git/fonduer/src/fonduer/parser/visual_parser/hocr_visual_parser.py\", line 135, in parse\r\n    f\"spacy tokens: {spacy_tokens}\",\r\nRuntimeError: ('Tokens are not aligned!', \"hocr tokens: ['チェーン店', '本・支店']\", \"spacy tokens: ['チェーン', '店本', '・', '支店']\")\r\n~~~\r\n\r\n## Environment (please complete the following information)\r\n - OS: Ubuntu 18.04\r\n - PostgreSQL Version: 10.15\r\n - Poppler Utils Version: 0.62.0\r\n - Fonduer Version: 0.8.4+dev\r\n - Spacy Version: 2.3.1 \r\n\r\n## Additional context\r\nI have tried some English hocr examples, but I could not find same problems.\r\n","closed_by":{"login":"lukehsiao","id":7573542,"node_id":"MDQ6VXNlcjc1NzM1NDI=","avatar_url":"https://avatars.githubusercontent.com/u/7573542?v=4","gravatar_id":"","url":"https://api.github.com/users/lukehsiao","html_url":"https://github.com/lukehsiao","followers_url":"https://api.github.com/users/lukehsiao/followers","following_url":"https://api.github.com/users/lukehsiao/following{/other_user}","gists_url":"https://api.github.com/users/lukehsiao/gists{/gist_id}","starred_url":"https://api.github.com/users/lukehsiao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukehsiao/subscriptions","organizations_url":"https://api.github.com/users/lukehsiao/orgs","repos_url":"https://api.github.com/users/lukehsiao/repos","events_url":"https://api.github.com/users/lukehsiao/events{/privacy}","received_events_url":"https://api.github.com/users/lukehsiao/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/534/timeline","performed_via_github_app":null,"state_reason":"completed"}