{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213","repository_url":"https://api.github.com/repos/HazyResearch/fonduer","labels_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213/labels{/name}","comments_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213/comments","events_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213/events","html_url":"https://github.com/HazyResearch/fonduer/issues/213","id":407065075,"node_id":"MDU6SXNzdWU0MDcwNjUwNzU=","number":213,"title":"sqlalchemy: ObjectDeletedError","user":{"login":"lukehsiao","id":7573542,"node_id":"MDQ6VXNlcjc1NzM1NDI=","avatar_url":"https://avatars.githubusercontent.com/u/7573542?v=4","gravatar_id":"","url":"https://api.github.com/users/lukehsiao","html_url":"https://github.com/lukehsiao","followers_url":"https://api.github.com/users/lukehsiao/followers","following_url":"https://api.github.com/users/lukehsiao/following{/other_user}","gists_url":"https://api.github.com/users/lukehsiao/gists{/gist_id}","starred_url":"https://api.github.com/users/lukehsiao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukehsiao/subscriptions","organizations_url":"https://api.github.com/users/lukehsiao/orgs","repos_url":"https://api.github.com/users/lukehsiao/repos","events_url":"https://api.github.com/users/lukehsiao/events{/privacy}","received_events_url":"https://api.github.com/users/lukehsiao/received_events","type":"User","site_admin":false},"labels":[{"id":825323858,"node_id":"MDU6TGFiZWw4MjUzMjM4NTg=","url":"https://api.github.com/repos/HazyResearch/fonduer/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":825323861,"node_id":"MDU6TGFiZWw4MjUzMjM4NjE=","url":"https://api.github.com/repos/HazyResearch/fonduer/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is required"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-02-06T03:13:04Z","updated_at":"2019-04-04T23:42:30Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\nDuring some stages of the pipeline (e.g. candidate extraction or featurization), some of the UDFs crash with a `sqlalchemy.orm.exc.ObjectDeletedError`.\r\n\r\n**To Reproduce**\r\nUnfortunately, this requires a large dataset to reproduce. I will update this with a minimal example if I can find one. Otherwise, I've currently seeing it on the full transistor dataset when extracting candidates as follows\r\n\r\n```py\r\nfrom fonduer.candidates import CandidateExtractor\r\n\r\ncandidate_extractor = CandidateExtractor(\r\n    session,\r\n    [PartStgTempMin, PartStgTempMax, PartPolarity, PartCeVMax],\r\n    throttlers=[temp_throttler, temp_throttler, polarity_throttler, ce_v_max_throttler],\r\n)\r\n\r\nfor i, docs in enumerate([train_docs, dev_docs, test_docs]):\r\n        candidate_extractor.apply(docs, split=i, parallelism=PARALLEL)\r\n        logger.info(\r\n            f\"PartStgTempMin in split={i}: \"\r\n            f\"{session.query(PartStgTempMin).filter(PartStgTempMin.split == i).count()}\"\r\n        )\r\n        logger.info(\r\n            f\"PartStgTempMax in split={i}: \"\r\n            f\"{session.query(PartStgTempMax).filter(PartStgTempMax.split == i).count()}\"\r\n        )\r\n        logger.info(\r\n            f\"PartPolarity in split={i}: \"\r\n            f\"{session.query(PartPolarity).filter(PartPolarity.split == i).count()}\"\r\n        )\r\n        logger.info(\r\n            f\"PartCeVMax in split={i}: \"\r\n            f\"{session.query(PartCeVMax).filter(PartCeVMax.split == i).count()}\"\r\n        )\r\n\r\n\r\ntrain_cands = candidate_extractor.get_candidates(split = 0)\r\ndev_cands = candidate_extractor.get_candidates(split = 1)\r\ntest_cands = candidate_extractor.get_candidates(split = 2)\r\n\r\nlogger.info(f\"Total train candidate: {len(train_cands[0])}\")\r\nlogger.info(f\"Total dev candidate: {len(dev_cands[0])}\")\r\nlogger.info(f\"Total test candidate: {len(test_cands[0])}\")\r\n```\r\n\r\n**Expected behavior**\r\nNo errors. No UDFs crashing.\r\n\r\n**Error Logs/Screenshots**\r\n```\r\nProcess CandidateExtractorUDF-46:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.6/multiprocessing/process.py\", line 258, in _bootstrap\r\n    self.run()\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/udf.py\", line 194, in run\r\n    self.session.add_all(y for y in self.apply(doc, **self.apply_kwargs))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py\", line 1940, in add_all\r\n    for instance in instances:\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/udf.py\", line 194, in <genexpr>\r\n    self.session.add_all(y for y in self.apply(doc, **self.apply_kwargs))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/candidates/candidates.py\", line 262, in apply\r\n    tuple(cand[j][1] for j in range(self.arities[i]))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/transistors/transistor_throttlers.py\", line 30, in stg_temp_filter\r\n    if same_table((part, attr)):\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/data_model_utils/tabular.py\", line 47, in same_table\r\n    for i in range(len(c))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/data_model_utils/tabular.py\", line 47, in <genexpr>\r\n    for i in range(len(c))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 275, in __get__\r\n    return self.impl.get(instance_state(instance), dict_)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 674, in get\r\n    value = self.callable_(state, passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 678, in _load_for_state\r\n    session, state, passive\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 723, in _get_ident_for_use_get\r\n    for pk in self.mapper.primary_key\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 723, in <listcomp>\r\n    for pk in self.mapper.primary_key\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/mapper.py\", line 2753, in _get_state_attr_by_column\r\n    return state.manager[prop.key].impl.get(state, dict_, passive=passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 669, in get\r\n    value = state._load_expired(state, passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/state.py\", line 632, in _load_expired\r\n    self.manager.deferred_scalar_loader(self, toload)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/loading.py\", line 985, in load_scalar_attributes\r\n    raise orm_exc.ObjectDeletedError(state)\r\nsqlalchemy.orm.exc.ObjectDeletedError: Instance '<SpanMention at 0x7f9118d76630>' has been deleted, or its row is otherwise not present.\r\n```\r\nThis also happens for `ImplicitSpanMention`s:\r\n```\r\nProcess CandidateExtractorUDF-52:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.6/multiprocessing/process.py\", line 258, in _bootstrap\r\n    self.run()\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/udf.py\", line 194, in run\r\n    self.session.add_all(y for y in self.apply(doc, **self.apply_kwargs))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py\", line 1940, in add_all\r\n    for instance in instances:\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/udf.py\", line 194, in <genexpr>\r\n    self.session.add_all(y for y in self.apply(doc, **self.apply_kwargs))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/candidates/candidates.py\", line 262, in apply\r\n    tuple(cand[j][1] for j in range(self.arities[i]))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/transistors/transistor_throttlers.py\", line 30, in stg_temp_filter\r\n    if same_table((part, attr)):\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/data_model_utils/tabular.py\", line 44, in same_table\r\n    for i in range(len(c))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/fonduer/src/fonduer/utils/data_model_utils/tabular.py\", line 44, in <genexpr>\r\n    for i in range(len(c))\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 275, in __get__\r\n    return self.impl.get(instance_state(instance), dict_)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 674, in get\r\n    value = self.callable_(state, passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 678, in _load_for_state\r\n    session, state, passive\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 723, in _get_ident_for_use_get\r\n    for pk in self.mapper.primary_key\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/strategies.py\", line 723, in <listcomp>\r\n    for pk in self.mapper.primary_key\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/mapper.py\", line 2753, in _get_state_attr_by_column\r\n    return state.manager[prop.key].impl.get(state, dict_, passive=passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py\", line 669, in get\r\n    value = state._load_expired(state, passive)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/state.py\", line 632, in _load_expired\r\n    self.manager.deferred_scalar_loader(self, toload)\r\n  File \"/lfs/raiders10/hdd/lwhsiao/repos/hack/.venv/lib/python3.6/site-packages/sqlalchemy/orm/loading.py\", line 985, in load_scalar_attributes\r\n    raise orm_exc.ObjectDeletedError(state)\r\nsqlalchemy.orm.exc.ObjectDeletedError: Instance '<ImplicitSpanMention at 0x7f5d6bc300b8>' has been deleted, or its row is otherwise not present\r\n```\r\n\r\n\r\n**Environment (please complete the following information):**\r\n - OS: [e.g. Ubuntu 18.04]\r\n - PostgreSQL Version: [e.g. 9.6]\r\n - Poppler Utils Version: [e.g. 0.62.0]\r\n - Fonduer Version: [e.g. 0.5.0]\r\n","closed_by":{"login":"lukehsiao","id":7573542,"node_id":"MDQ6VXNlcjc1NzM1NDI=","avatar_url":"https://avatars.githubusercontent.com/u/7573542?v=4","gravatar_id":"","url":"https://api.github.com/users/lukehsiao","html_url":"https://github.com/lukehsiao","followers_url":"https://api.github.com/users/lukehsiao/followers","following_url":"https://api.github.com/users/lukehsiao/following{/other_user}","gists_url":"https://api.github.com/users/lukehsiao/gists{/gist_id}","starred_url":"https://api.github.com/users/lukehsiao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukehsiao/subscriptions","organizations_url":"https://api.github.com/users/lukehsiao/orgs","repos_url":"https://api.github.com/users/lukehsiao/repos","events_url":"https://api.github.com/users/lukehsiao/events{/privacy}","received_events_url":"https://api.github.com/users/lukehsiao/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/213/timeline","performed_via_github_app":null,"state_reason":null}