{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86","repository_url":"https://api.github.com/repos/HazyResearch/fonduer","labels_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86/labels{/name}","comments_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86/comments","events_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86/events","html_url":"https://github.com/HazyResearch/fonduer/issues/86","id":343875194,"node_id":"MDU6SXNzdWUzNDM4NzUxOTQ=","number":86,"title":"Improving parser performance","user":{"login":"lukehsiao","id":7573542,"node_id":"MDQ6VXNlcjc1NzM1NDI=","avatar_url":"https://avatars.githubusercontent.com/u/7573542?v=4","gravatar_id":"","url":"https://api.github.com/users/lukehsiao","html_url":"https://github.com/lukehsiao","followers_url":"https://api.github.com/users/lukehsiao/followers","following_url":"https://api.github.com/users/lukehsiao/following{/other_user}","gists_url":"https://api.github.com/users/lukehsiao/gists{/gist_id}","starred_url":"https://api.github.com/users/lukehsiao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukehsiao/subscriptions","organizations_url":"https://api.github.com/users/lukehsiao/orgs","repos_url":"https://api.github.com/users/lukehsiao/repos","events_url":"https://api.github.com/users/lukehsiao/events{/privacy}","received_events_url":"https://api.github.com/users/lukehsiao/received_events","type":"User","site_admin":false},"labels":[{"id":825323860,"node_id":"MDU6TGFiZWw4MjUzMjM4NjA=","url":"https://api.github.com/repos/HazyResearch/fonduer/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"},{"id":825323861,"node_id":"MDU6TGFiZWw4MjUzMjM4NjE=","url":"https://api.github.com/repos/HazyResearch/fonduer/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is required"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-07-24T03:53:53Z","updated_at":"2018-08-30T19:59:04Z","closed_at":"2018-08-30T19:58:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The current Parser takes quite a bit of time to process a large corpus of documents (~25min for 100 PDF datasheets on a consumer laptop). It would be nice to see what can be done to improve performance.\r\n\r\n## Profiling Setup\r\nI did some quick profiling using the [e2e hardware tutorial](https://github.com/HazyResearch/fonduer-tutorials/blob/f78ee9df4403d11d1475479a5ba065829de5dd83/hardware/max_storage_temp_tutorial.ipynb) using Fonduer v0.2.3, with two modifications:\r\n\r\n```py\r\nmax_docs = 10\r\n```\r\nand using only a single thread:\r\n```py\r\nimport cProfile\r\n\r\ncorpus_parser = Parser(structural=True, lingual=True, visual=True, pdf_path=pdf_path)\r\ncProfile.runctx('corpus_parser.apply(doc_preprocessor, parallelism=1)', globals(), locals(), 'profile.prof')\r\n```\r\n## Top 50 Cumulative Time \r\n\r\n```\r\n   List reduced from 1834 to 50 due to restriction <50>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n      3/1    0.000    0.000  127.815  127.815 {built-in method builtins.exec}\r\n      2/1    0.001    0.000  127.801  127.801 /home/lwhsiao/repos/fonduer/fonduer/utils/udf.py:31(apply)\r\n      2/1    0.000    0.000  127.781  127.781 /home/lwhsiao/repos/fonduer/fonduer/utils/udf.py:57(apply_st)\r\n        2    0.001    0.000  126.855   63.428 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py:909(commit)\r\n      3/2    0.000    0.000  126.855   63.427 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py:464(commit)\r\n      3/2    0.000    0.000  126.634   63.317 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py:433(_prepare_impl)\r\n        8    0.077    0.010  126.634   15.829 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2220(flush)\r\n        1    0.029    0.029  126.556  126.556 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/session.py:2271(_flush)\r\n        1    0.014    0.014  126.068  126.068 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:369(execute)\r\n        6    0.001    0.000  119.647   19.941 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:658(execute_aggregate)\r\n        6    0.033    0.005  119.642   19.940 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:131(save_obj)\r\n       78    1.160    0.015  119.413    1.531 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:799(_emit_insert_statements)\r\n    16198    0.142    0.000  113.913    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py:882(execute)\r\n    16192    0.102    0.000  113.730    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/sql/elements.py:267(_execute_on_connection)\r\n    16192    0.686    0.000  113.628    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1016(_execute_clauseelement)\r\n    16198    0.908    0.000  112.330    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1111(_execute_context)\r\n21342/18958    0.118    0.000   80.031    0.004 /home/lwhsiao/repos/fonduer/fonduer/parser/parser.py:550(_parse_node)\r\n11230/5902    0.204    0.000   79.332    0.013 /home/lwhsiao/repos/fonduer/fonduer/parser/parser.py:570(parse)\r\n    18958    0.088    0.000   78.291    0.004 /home/lwhsiao/repos/fonduer/fonduer/parser/parser.py:419(_parse_paragraph)\r\n    11227    0.428    0.000   67.047    0.006 /home/lwhsiao/repos/fonduer/fonduer/parser/parser.py:322(_parse_sentence)\r\n        9    0.000    0.000   57.452    6.384 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/dialects/postgresql/psycopg2.py:678(do_executemany)\r\n        9   57.031    6.337   57.452    6.384 {method 'executemany' of 'psycopg2.extensions.cursor' objects}\r\n    10670    0.324    0.000   50.675    0.005 nn_parser.pyx:326(__call__)\r\n    10670    0.088    0.000   47.024    0.004 nn_parser.pyx:727(get_batch_model)\r\n    16193    0.074    0.000   46.940    0.003 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/default.py:508(do_execute)\r\n    16197   46.179    0.003   46.868    0.003 {method 'execute' of 'psycopg2.extensions.cursor' objects}\r\n80025/16005    0.720    0.000   44.993    0.003 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:58(begin_update)\r\n    10670    0.110    0.000   37.959    0.004 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:277(begin_update)\r\n    58685    0.959    0.000   30.840    0.001 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/layernorm.py:50(begin_update)\r\n    11227    0.611    0.000   24.486    0.002 /home/lwhsiao/repos/fonduer/fonduer/parser/spacy_parser.py:121(parse)\r\n    42680    0.229    0.000   23.576    0.001 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/resnet.py:17(begin_update)\r\n5912/5902    0.013    0.000   23.415    0.004 /home/lwhsiao/repos/fonduer/fonduer/parser/parser.py:124(apply)\r\n     5902    0.003    0.000   23.271    0.004 /home/lwhsiao/repos/fonduer/fonduer/parser/visual_linker.py:30(parse_visual)\r\n       10    0.012    0.001   21.981    2.198 /home/lwhsiao/repos/fonduer/fonduer/parser/visual_linker.py:47(extract_pdf_words)\r\n    16005    0.464    0.000   20.554    0.001 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:365(uniqued_fwd)\r\n     5335    0.051    0.000   20.365    0.004 pipeline.pyx:425(__call__)\r\n     5335    0.073    0.000   20.089    0.004 pipeline.pyx:437(predict)\r\n101365/10670    0.224    0.000   20.016    0.002 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/model.py:155(__call__)\r\n    10670    0.106    0.000   19.680    0.002 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:291(predict)\r\n       74    0.005    0.000   19.545    0.264 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/bs4/__init__.py:87(__init__)\r\n    58685    1.543    0.000   19.542    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/maxout.py:66(begin_update)\r\n32010/5335    0.183    0.000   18.830    0.004 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:53(predict)\r\n    85360   17.542    0.000   17.542    0.000 ops.pyx:333(batch_dot)\r\n      128    0.001    0.000   15.675    0.122 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/bs4/builder/_htmlparser.py:192(prepare_markup)\r\n       64    0.003    0.000   15.673    0.245 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/bs4/dammit.py:344(__init__)\r\n      128    0.001    0.000   15.662    0.122 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/bs4/dammit.py:240(encodings)\r\n       64    0.001    0.000   15.656    0.245 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/bs4/dammit.py:33(chardet_dammit)\r\n       64    0.003    0.000   15.654    0.245 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/__init__.py:24(detect)\r\n       64    0.003    0.000   15.635    0.244 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/universaldetector.py:111(feed)\r\n    10670    2.077    0.000   14.986    0.001 nn_parser.pyx:387(parse_batch)\r\n```\r\n\r\n## Top 50 Total Time\r\n\r\n```\r\n   List reduced from 1834 to 50 due to restriction <50>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n        9   57.031    6.337   57.452    6.384 {method 'executemany' of 'psycopg2.extensions.cursor' objects}\r\n    16197   46.179    0.003   46.868    0.003 {method 'execute' of 'psycopg2.extensions.cursor' objects}\r\n    85360   17.542    0.000   17.542    0.000 ops.pyx:333(batch_dot)\r\n   901615    7.821    0.000    7.821    0.000 {method 'reduce' of 'numpy.ufunc' objects}\r\n    10670    6.399    0.001    6.399    0.001 {built-in method numpy.core.multiarray.dot}\r\n  4904371    3.915    0.000    3.915    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/codingstatemachine.py:66(next_state)\r\n   586850    3.229    0.000    8.996    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/numpy/core/fromnumeric.py:2456(prod)\r\n    80025    2.345    0.000    3.893    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/numpy/core/_methods.py:86(_var)\r\n      808    2.241    0.003    2.241    0.003 {method 'findall' of '_sre.SRE_Pattern' objects}\r\n       62    2.096    0.034    4.827    0.078 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/utf8prober.py:57(feed)\r\n    10670    2.077    0.000   14.986    0.001 nn_parser.pyx:387(parse_batch)\r\n    64020    1.875    0.000    6.569    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/hash_embed.py:48(begin_update)\r\n       62    1.820    0.029    2.005    0.032 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/charsetprober.py:103(filter_with_english_letters)\r\n   458810    1.725    0.000    9.098    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/mem.py:28(__getitem__)\r\n    58685    1.543    0.000   19.542    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/maxout.py:66(begin_update)\r\n       50    1.488    0.030    2.805    0.056 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/mbcharsetprober.py:61(feed)\r\n    16192    1.446    0.000    3.478    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/default.py:595(_init_compiled)\r\n    80025    1.425    0.000    1.443    0.000 ops.pyx:419(maxout)\r\n   458810    1.313    0.000   10.790    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/describe.py:35(__get__)\r\n   631016    1.310    0.000    1.310    0.000 {built-in method numpy.core.multiarray.array}\r\n      868    1.206    0.001    3.469    0.004 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/sbcharsetprober.py:77(feed)\r\n   108507    1.205    0.000    2.466    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/sync.py:16(populate)\r\n    80025    1.194    0.000    1.194    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/layernorm.py:102(_forward)\r\n       78    1.160    0.015  119.413    1.531 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:799(_emit_insert_statements)\r\n    80025    1.141    0.000    2.187    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/numpy/core/_methods.py:53(_mean)\r\n   186725    1.087    0.000    1.166    0.000 ops.pyx:168(asarray)\r\n    32440    0.975    0.000    1.746    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:380(_collect_insert_commands)\r\n    58685    0.959    0.000   30.840    0.001 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/layernorm.py:50(begin_update)\r\n       94    0.956    0.010    0.956    0.010 {method 'read' of '_io.BufferedReader' objects}\r\n    16198    0.908    0.000  112.330    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1111(_execute_context)\r\n    64020    0.908    0.000    2.544    0.000 ops.pyx:452(seq2col)\r\n   736230    0.801    0.000    0.801    0.000 {method 'reshape' of 'numpy.ndarray' objects}\r\n   128040    0.775    0.000    2.938    0.000 ops.pyx:158(allocate)\r\n   298389    0.772    0.000    1.465    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/attributes.py:699(set)\r\n       74    0.757    0.010    0.757    0.010 {built-in method posix.read}\r\n    58685    0.756    0.000    3.397    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/layernorm.py:70(_begin_update_scale_shift)\r\n80025/16005    0.720    0.000   44.993    0.003 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/api.py:58(begin_update)\r\n   311497    0.708    0.000    2.042    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py:193(get_attribute_history)\r\n    80025    0.689    0.000    7.659    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/thinc/neural/_classes/layernorm.py:81(_get_moments)\r\n    16192    0.686    0.000  113.628    0.007 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/engine/base.py:1016(_execute_clauseelement)\r\n   101365    0.649    0.000    0.649    0.000 {built-in method numpy.core.multiarray.concatenate}\r\n    32362    0.637    0.000    2.376    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py:1168(_postfetch)\r\n1862054/1861624    0.631    0.000    0.786    0.000 {built-in method builtins.isinstance}\r\n   108741    0.614    0.000    0.614    0.000 {method 'search' of '_sre.SRE_Pattern' objects}\r\n    11227    0.611    0.000   24.486    0.002 /home/lwhsiao/repos/fonduer/fonduer/parser/spacy_parser.py:121(parse)\r\n       74    0.588    0.008    0.588    0.008 {built-in method _posixsubprocess.fork_exec}\r\n    48585    0.577    0.000    0.577    0.000 {built-in method _codecs.utf_8_decode}\r\n519893/519599    0.549    0.000    0.586    0.000 {built-in method builtins.hasattr}\r\n       10    0.534    0.053    1.217    0.122 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/chardet/sjisprober.py:56(feed)\r\n   390715    0.527    0.000    0.579    0.000 /home/lwhsiao/repos/tutorials/.venv/lib/python3.6/site-packages/sqlalchemy/orm/state.py:665(_modified_event)\r\n```\r\n","closed_by":{"login":"lukehsiao","id":7573542,"node_id":"MDQ6VXNlcjc1NzM1NDI=","avatar_url":"https://avatars.githubusercontent.com/u/7573542?v=4","gravatar_id":"","url":"https://api.github.com/users/lukehsiao","html_url":"https://github.com/lukehsiao","followers_url":"https://api.github.com/users/lukehsiao/followers","following_url":"https://api.github.com/users/lukehsiao/following{/other_user}","gists_url":"https://api.github.com/users/lukehsiao/gists{/gist_id}","starred_url":"https://api.github.com/users/lukehsiao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukehsiao/subscriptions","organizations_url":"https://api.github.com/users/lukehsiao/orgs","repos_url":"https://api.github.com/users/lukehsiao/repos","events_url":"https://api.github.com/users/lukehsiao/events{/privacy}","received_events_url":"https://api.github.com/users/lukehsiao/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/86/timeline","performed_via_github_app":null,"state_reason":"completed"}