{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482","repository_url":"https://api.github.com/repos/HazyResearch/fonduer","labels_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482/labels{/name}","comments_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482/comments","events_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482/events","html_url":"https://github.com/HazyResearch/fonduer/issues/482","id":658653692,"node_id":"MDU6SXNzdWU2NTg2NTM2OTI=","number":482,"title":"sqlalchemy.exc.InvalidRequestError during labeler.apply or featurizer.apply","user":{"login":"HiromuHota","id":20668349,"node_id":"MDQ6VXNlcjIwNjY4MzQ5","avatar_url":"https://avatars.githubusercontent.com/u/20668349?v=4","gravatar_id":"","url":"https://api.github.com/users/HiromuHota","html_url":"https://github.com/HiromuHota","followers_url":"https://api.github.com/users/HiromuHota/followers","following_url":"https://api.github.com/users/HiromuHota/following{/other_user}","gists_url":"https://api.github.com/users/HiromuHota/gists{/gist_id}","starred_url":"https://api.github.com/users/HiromuHota/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HiromuHota/subscriptions","organizations_url":"https://api.github.com/users/HiromuHota/orgs","repos_url":"https://api.github.com/users/HiromuHota/repos","events_url":"https://api.github.com/users/HiromuHota/events{/privacy}","received_events_url":"https://api.github.com/users/HiromuHota/received_events","type":"User","site_admin":false},"labels":[{"id":825323858,"node_id":"MDU6TGFiZWw4MjUzMjM4NTg=","url":"https://api.github.com/repos/HazyResearch/fonduer/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-07-16T23:15:07Z","updated_at":"2020-07-21T23:12:25Z","closed_at":"2020-07-21T23:12:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Description of the bug\r\n\r\nWhen executing `labeler.apply` or `featurizer.apply`, sqlalchemy.exc.InvalidRequestError occurs.\r\n\r\n## To Reproduce\r\nSteps to reproduce the behavior:\r\n1. Deploy the fonduer-tutorials using docker\r\n2. Upgrade fonduer to the latest commit on the master branch\r\n3. Run the hardware tutorial up to 2.2 Multimodal Featurization\r\n\r\n## Expected behavior\r\n\r\n`labeler.apply` and `featurizer.apply` run without an error.\r\n\r\n## Error Logs/Screenshots\r\n\r\n```\r\nException in thread Thread-15:\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/threading.py\", line 926, in _bootstrap_inner\r\n    self.run()\r\n  File \"/usr/local/lib/python3.7/threading.py\", line 870, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/fonduer/utils/udf.py\", line 136, in in_thread_func\r\n    self.last_docs.add(doc.name)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/attributes.py\", line 286, in __get__\r\n    return self.impl.get(instance_state(instance), dict_)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/attributes.py\", line 717, in get\r\n    value = state._load_expired(state, passive)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/state.py\", line 652, in _load_expired\r\n    self.manager.deferred_scalar_loader(self, toload)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/loading.py\", line 1012, in load_scalar_attributes\r\n    only_load_props=attribute_names,\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/loading.py\", line 207, in load_on_ident\r\n    identity_token=identity_token,\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/loading.py\", line 287, in load_on_pk_identity\r\n    return q.one()\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3360, in one\r\n    ret = self.one_or_none()\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3329, in one_or_none\r\n    ret = list(self)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3405, in __iter__\r\n    return self._execute_and_instances(context)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3427, in _execute_and_instances\r\n    querycontext, self._connection_from_session, close_with_result=True\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3442, in _get_bind_args\r\n    mapper=self._bind_mapper(), clause=querycontext.statement, **kw\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/query.py\", line 3420, in _connection_from_session\r\n    conn = self.session.connection(**kw)\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 1133, in connection\r\n    execution_options=execution_options,\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 1139, in _connection_for_bind\r\n    engine, execution_options\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 408, in _connection_for_bind\r\n    self._assert_active()\r\n  File \"/home/user/.venv/lib/python3.7/site-packages/sqlalchemy/orm/session.py\", line 276, in _assert_active\r\n    \"This session is in 'committed' state; no further \"\r\nsqlalchemy.exc.InvalidRequestError: This session is in 'committed' state; no further SQL can be emitted within this transaction.\r\n```\r\n\r\nThe last part of the error message could be\r\n\r\n```\r\nsqlalchemy.exc.InvalidRequestError: This session is in 'prepared' state; no further SQL can be emitted within this transaction.\r\n```\r\n\r\n\r\n## Environment (please complete the following information)\r\n - OS: [e.g. Ubuntu 18.04]\r\n - PostgreSQL Version: 12.1\r\n - Poppler Utils Version: N/A\r\n - Fonduer Version: master (a3af3877ef94fd8466b24b7cad7145a13413ac68)\r\n\r\n## Additional context\r\n\r\nI think this is a regression caused by #439 as the error happens during `self.last_docs.add(doc.name)`, which was added by #439.","closed_by":{"login":"senwu","id":5580008,"node_id":"MDQ6VXNlcjU1ODAwMDg=","avatar_url":"https://avatars.githubusercontent.com/u/5580008?v=4","gravatar_id":"","url":"https://api.github.com/users/senwu","html_url":"https://github.com/senwu","followers_url":"https://api.github.com/users/senwu/followers","following_url":"https://api.github.com/users/senwu/following{/other_user}","gists_url":"https://api.github.com/users/senwu/gists{/gist_id}","starred_url":"https://api.github.com/users/senwu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/senwu/subscriptions","organizations_url":"https://api.github.com/users/senwu/orgs","repos_url":"https://api.github.com/users/senwu/repos","events_url":"https://api.github.com/users/senwu/events{/privacy}","received_events_url":"https://api.github.com/users/senwu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/HazyResearch/fonduer/issues/482/timeline","performed_via_github_app":null,"state_reason":"completed"}