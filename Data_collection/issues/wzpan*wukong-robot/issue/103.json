{"url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103","repository_url":"https://api.github.com/repos/wzpan/wukong-robot","labels_url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103/labels{/name}","comments_url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103/comments","events_url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103/events","html_url":"https://github.com/wzpan/wukong-robot/issues/103","id":548674513,"node_id":"MDU6SXNzdWU1NDg2NzQ1MTM=","number":103,"title":"反馈一个有关「使用 UNIT 技能」示例代码的bug（{'error_code': 292003, 'error_msg': 'QPS超限，当前QPS限额[1]'}），已自行解决","user":{"login":"AngelLiang","id":11804072,"node_id":"MDQ6VXNlcjExODA0MDcy","avatar_url":"https://avatars.githubusercontent.com/u/11804072?v=4","gravatar_id":"","url":"https://api.github.com/users/AngelLiang","html_url":"https://github.com/AngelLiang","followers_url":"https://api.github.com/users/AngelLiang/followers","following_url":"https://api.github.com/users/AngelLiang/following{/other_user}","gists_url":"https://api.github.com/users/AngelLiang/gists{/gist_id}","starred_url":"https://api.github.com/users/AngelLiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AngelLiang/subscriptions","organizations_url":"https://api.github.com/users/AngelLiang/orgs","repos_url":"https://api.github.com/users/AngelLiang/repos","events_url":"https://api.github.com/users/AngelLiang/events{/privacy}","received_events_url":"https://api.github.com/users/AngelLiang/received_events","type":"User","site_admin":false},"labels":[{"id":1196019304,"node_id":"MDU6TGFiZWwxMTk2MDE5MzA0","url":"https://api.github.com/repos/wzpan/wukong-robot/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"我的锅"}],"state":"closed","locked":false,"assignee":{"login":"wzpan","id":1631405,"node_id":"MDQ6VXNlcjE2MzE0MDU=","avatar_url":"https://avatars.githubusercontent.com/u/1631405?v=4","gravatar_id":"","url":"https://api.github.com/users/wzpan","html_url":"https://github.com/wzpan","followers_url":"https://api.github.com/users/wzpan/followers","following_url":"https://api.github.com/users/wzpan/following{/other_user}","gists_url":"https://api.github.com/users/wzpan/gists{/gist_id}","starred_url":"https://api.github.com/users/wzpan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wzpan/subscriptions","organizations_url":"https://api.github.com/users/wzpan/orgs","repos_url":"https://api.github.com/users/wzpan/repos","events_url":"https://api.github.com/users/wzpan/events{/privacy}","received_events_url":"https://api.github.com/users/wzpan/received_events","type":"User","site_admin":false},"assignees":[{"login":"wzpan","id":1631405,"node_id":"MDQ6VXNlcjE2MzE0MDU=","avatar_url":"https://avatars.githubusercontent.com/u/1631405?v=4","gravatar_id":"","url":"https://api.github.com/users/wzpan","html_url":"https://github.com/wzpan","followers_url":"https://api.github.com/users/wzpan/followers","following_url":"https://api.github.com/users/wzpan/following{/other_user}","gists_url":"https://api.github.com/users/wzpan/gists{/gist_id}","starred_url":"https://api.github.com/users/wzpan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wzpan/subscriptions","organizations_url":"https://api.github.com/users/wzpan/orgs","repos_url":"https://api.github.com/users/wzpan/repos","events_url":"https://api.github.com/users/wzpan/events{/privacy}","received_events_url":"https://api.github.com/users/wzpan/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2020-01-13T02:48:10Z","updated_at":"2020-01-13T06:10:16Z","closed_at":"2020-01-13T06:10:15Z","author_association":"NONE","active_lock_reason":null,"body":"我根据官方教程做到了「使用 UNIT 技能」小节，遇到了一个bug，并已经自行解决，下面提供反馈。\r\n\r\n示例来源：https://wukong.hahack.com/#/writing-skill-1?id=_2-%e4%bd%bf%e7%94%a8-unit-%e6%8a%80%e8%83%bd\r\n\r\n根据示例代码\r\n\r\n```python\r\n# -*- coding: utf-8-*-\r\nfrom robot.sdk import unit\r\nfrom robot.sdk.AbstractPlugin import AbstractPlugin\r\n\r\n# 调试用，发布时删除\r\nSERVICE_ID='你的技能service_id'\r\nAPI_KEY='你的技能api_key'\r\nSECRET_KEY='你的技能secret_key'\r\n\r\nclass Plugin(AbstractPlugin):\r\n\r\n    def handle(self, text, parsed):\r\n        parsed = unit.getUnit(text, SERVICE_ID, API_KEY, SECRET_KEY) # 调试用，发布时删除\r\n        slots = unit.getSlots(parsed, 'HELLO_WORLD')  # 取出所有词槽\r\n        # 遍历词槽，找出 user_person 对应的值\r\n        for slot in slots:\r\n            if slot['name'] == 'user_person':\r\n                self.say('您好，{}！'.format(slot['normalized_word']))\r\n                return\r\n        # 如果没命中词槽，说 hello world\r\n        self.say('hello world!', cache=True)\r\n\r\n    def isValid(self, text, parsed):\r\n        parsed = unit.getUnit(text, SERVICE_ID, API_KEY, SECRET_KEY) # 调试用，发布时删除\r\n        # 判断是否包含 HELLO_WORLD 意图\r\n        return unit.hasIntent(parsed, 'HELLO_WORLD')\r\n```\r\n\r\n由于百度UNIT的默认并发数（QPS）是1，上面的代码由于调用了两次` unit.getUnit()`函数，所以第一次调用`isValid()`方法会成功，而第二次调用`handle()`方法会失败，打印 `parsed` 会出现如下错误：\r\n\r\n```\r\n{'error_code': 292003, 'error_msg': 'QPS超限，当前QPS限额[1]'}\r\n```\r\n\r\n因此，可以给`parsed`设置个缓存函数，只调用一次`unit.getUnit()`函数即可。\r\n\r\n```python\r\n\r\n...\r\n\r\nclass Plugin(AbstractPlugin):\r\n\r\n    def _get_parsed(self, text):\r\n        \"\"\"缓存parsed\"\"\"\r\n        if getattr(self, '_parsed', None):\r\n            return self._parsed\r\n        self._parsed = unit.getUnit(text, SERVICE_ID, API_KEY, SECRET_KEY)  # 调试用，发布时删除\r\n        return self._parsed\r\n    \r\n    def handle(self, text, parsed):\r\n        parsed = self._get_parsed(text)\r\n        ...\r\n\r\n    def isValid(self, text, parsed):\r\n        parsed = self._get_parsed(text)\r\n        ....\r\n\r\n```\r\n\r\n\r\n","closed_by":{"login":"AngelLiang","id":11804072,"node_id":"MDQ6VXNlcjExODA0MDcy","avatar_url":"https://avatars.githubusercontent.com/u/11804072?v=4","gravatar_id":"","url":"https://api.github.com/users/AngelLiang","html_url":"https://github.com/AngelLiang","followers_url":"https://api.github.com/users/AngelLiang/followers","following_url":"https://api.github.com/users/AngelLiang/following{/other_user}","gists_url":"https://api.github.com/users/AngelLiang/gists{/gist_id}","starred_url":"https://api.github.com/users/AngelLiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AngelLiang/subscriptions","organizations_url":"https://api.github.com/users/AngelLiang/orgs","repos_url":"https://api.github.com/users/AngelLiang/repos","events_url":"https://api.github.com/users/AngelLiang/events{/privacy}","received_events_url":"https://api.github.com/users/AngelLiang/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/wzpan/wukong-robot/issues/103/timeline","performed_via_github_app":null,"state_reason":"completed"}