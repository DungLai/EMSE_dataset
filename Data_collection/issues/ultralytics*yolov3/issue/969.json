{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/969","repository_url":"https://api.github.com/repos/ultralytics/yolov3","labels_url":"https://api.github.com/repos/ultralytics/yolov3/issues/969/labels{/name}","comments_url":"https://api.github.com/repos/ultralytics/yolov3/issues/969/comments","events_url":"https://api.github.com/repos/ultralytics/yolov3/issues/969/events","html_url":"https://github.com/ultralytics/yolov3/issues/969","id":588655433,"node_id":"MDU6SXNzdWU1ODg2NTU0MzM=","number":969,"title":"Darknet-PyTorch reproducibility problems for custom dataset (incompatibility in mAP calculation)","user":{"login":"pedbrgs","id":30960165,"node_id":"MDQ6VXNlcjMwOTYwMTY1","avatar_url":"https://avatars.githubusercontent.com/u/30960165?v=4","gravatar_id":"","url":"https://api.github.com/users/pedbrgs","html_url":"https://github.com/pedbrgs","followers_url":"https://api.github.com/users/pedbrgs/followers","following_url":"https://api.github.com/users/pedbrgs/following{/other_user}","gists_url":"https://api.github.com/users/pedbrgs/gists{/gist_id}","starred_url":"https://api.github.com/users/pedbrgs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pedbrgs/subscriptions","organizations_url":"https://api.github.com/users/pedbrgs/orgs","repos_url":"https://api.github.com/users/pedbrgs/repos","events_url":"https://api.github.com/users/pedbrgs/events{/privacy}","received_events_url":"https://api.github.com/users/pedbrgs/received_events","type":"User","site_admin":false},"labels":[{"id":1035696370,"node_id":"MDU6TGFiZWwxMDM1Njk2Mzcw","url":"https://api.github.com/repos/ultralytics/yolov3/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2020-03-26T18:59:46Z","updated_at":"2020-03-28T02:59:51Z","closed_at":"2020-03-28T02:59:51Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, guys! Hi, Glenn! Firstly, I would like to congratulate you for the incredible work of keeping the repository improving constantly.\r\n\r\n### Problem 1: Reproduce Darknet performance training in Pytorch\r\n\r\nWell, I'm using [AlexeyAB's Darknet repository](https://github.com/AlexeyAB/darknet) in parallel with that repository. I'm using the same hyperparameters and configuration files (`.cfg`, `.data`, `train.txt`, `valid.txt`) in both versions, but I can't reproduce the Darknet results in PyTorch Ultralytics with my own dataset (two classes). Yes, I followed the tutorial for custom data, my repository is up to date and I also tried the `evolve.sh` routine. \r\n\r\nHowever, when I'm training with a initial `lr` 0.001, `SGD`, `momentum` 0.9, `weight_decay` 0.0005, `burn-in` 1000 (darknet default) and `darknet53.conv.74` weights, the mAP stays at 0% for some epochs and grows extremely slowly and oscillating. In addition, Darknet training lasts about 24 hours (8000 iterations) and here in this repository it lasts more than twice and still does not have the same performance. My dataset has about 24,000 images.\r\n\r\n### Problem 2: mAP@0.50 evaluation on Darknet differs from mAP@0.50 on PyTorch for the same weight\r\n\r\nThe main problem I encounter is related to the calculation of the mAP metric, in which there is no correspondence between the two repositories. When I convert a Darknet weight (`.weights`) whose mAP@0.50 (101 points) is **63.39%** for PyTorch (`.pth`) and I evaluate it, I get **46.8%**. The precision and recall also remain different, just the F1-score that seems right to me. \r\n\r\n<p align=\"center\">\r\n<img width=\"358\" height=\"188\" src=\"https://user-images.githubusercontent.com/30960165/77680773-2de31380-6f73-11ea-99ab-a4a67f776081.png\">\r\n</p>\r\n\r\nI know that for custom data the best way is to calculate mAP@0.5 with 0 points, but I tried to use the same amount of points used in this repository for comparison.\r\n\r\n> PascalVOC 2010-2012 and IMAGEnet uses each unique point on Precision-Recall curve -. Ie calculates Area Under Curve without approximation. \r\n[Source: mAP (mean average precision) calculation for different Datasets (MSCOCO, ImageNet, PascalVOC) #2746](https://github.com/AlexeyAB/darknet/issues/2746)\r\n\r\nI thought the problem was the conversion, but when I convert Darknet to PyTorch and then PyTorch to Darknet, I remain with the same mAP, without depreciation.\r\n\r\n**Conversion:**\r\n\r\n`from models import *`\r\n`convert('cfg/yolo.cfg', 'weights/best.pt')`\r\n\r\nI tried to vary the values ​​of all existing thresholds: `conf_thres`, `iou_thres` and `pr_score`, according to the curves below. But I was not successful in finding values ​​that would make me achieve the same performance as Darknet.\r\n\r\n**`pr_score` analysis:**\r\n\r\n<p align=\"center\">\r\n<img width=\"400\" height=\"400\" src=\"https://user-images.githubusercontent.com/30960165/77681564-44d63580-6f74-11ea-90d1-daa239b358ff.jpg\">\r\n</p>\r\n\r\n**`conf_thres` analysis:**\r\n\r\n<p align=\"center\">\r\n<img width=\"380\" height=\"380\" src=\"https://user-images.githubusercontent.com/30960165/77683627-6edd2700-6f77-11ea-9855-78aee2e8f281.jpg\">\r\n</p>\r\n\r\n**`iou_thres` analysis:**\r\n\r\n<p align=\"center\">\r\n<img width=\"400\" height=\"400\" src=\"https://user-images.githubusercontent.com/30960165/77685381-26733880-6f7a-11ea-99c4-f4d2dffceaa7.jpg\">\r\n</p>\r\n\r\n**Can someone help me get at least the match between the mAP calculations from both repositories?**\r\n\r\nI'm sorry if it seems like I don't know YOLO's theory very well, I'm learning it now.\r\nThank you **very much** for any help that comes!","closed_by":{"login":"pedbrgs","id":30960165,"node_id":"MDQ6VXNlcjMwOTYwMTY1","avatar_url":"https://avatars.githubusercontent.com/u/30960165?v=4","gravatar_id":"","url":"https://api.github.com/users/pedbrgs","html_url":"https://github.com/pedbrgs","followers_url":"https://api.github.com/users/pedbrgs/followers","following_url":"https://api.github.com/users/pedbrgs/following{/other_user}","gists_url":"https://api.github.com/users/pedbrgs/gists{/gist_id}","starred_url":"https://api.github.com/users/pedbrgs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pedbrgs/subscriptions","organizations_url":"https://api.github.com/users/pedbrgs/orgs","repos_url":"https://api.github.com/users/pedbrgs/repos","events_url":"https://api.github.com/users/pedbrgs/events{/privacy}","received_events_url":"https://api.github.com/users/pedbrgs/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/969/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ultralytics/yolov3/issues/969/timeline","performed_via_github_app":null,"state_reason":"completed"}