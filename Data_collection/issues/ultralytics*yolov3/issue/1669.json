{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669","repository_url":"https://api.github.com/repos/ultralytics/yolov3","labels_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669/labels{/name}","comments_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669/comments","events_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669/events","html_url":"https://github.com/ultralytics/yolov3/issues/1669","id":788967462,"node_id":"MDU6SXNzdWU3ODg5Njc0NjI=","number":1669,"title":"Resolution of input-images from testloader depend on .yaml describing network architecture","user":{"login":"vaynonym","id":34941454,"node_id":"MDQ6VXNlcjM0OTQxNDU0","avatar_url":"https://avatars.githubusercontent.com/u/34941454?v=4","gravatar_id":"","url":"https://api.github.com/users/vaynonym","html_url":"https://github.com/vaynonym","followers_url":"https://api.github.com/users/vaynonym/followers","following_url":"https://api.github.com/users/vaynonym/following{/other_user}","gists_url":"https://api.github.com/users/vaynonym/gists{/gist_id}","starred_url":"https://api.github.com/users/vaynonym/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vaynonym/subscriptions","organizations_url":"https://api.github.com/users/vaynonym/orgs","repos_url":"https://api.github.com/users/vaynonym/repos","events_url":"https://api.github.com/users/vaynonym/events{/privacy}","received_events_url":"https://api.github.com/users/vaynonym/received_events","type":"User","site_admin":false},"labels":[{"id":1890885613,"node_id":"MDU6TGFiZWwxODkwODg1NjEz","url":"https://api.github.com/repos/ultralytics/yolov3/labels/Stale","name":"Stale","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-01-19T12:05:48Z","updated_at":"2021-02-25T00:30:48Z","closed_at":"2021-02-25T00:30:48Z","author_association":"NONE","active_lock_reason":null,"body":"## üêõ Bug\r\nFor some strange reason, the resolution of the input images loaded from the testloader seem to depend on the .yaml describing network architecture. So far I've only tried this on the VOC dataset and by detecting at different layers. I created a .yaml based on the yolov3-tiny .yaml, only I detect one stride higher. Full .yaml is provided. The result I get is that the concatenation crashes during the first image because during downsampling we get an uneven resolution at some point and the first concatenation crashes when trying to concatenating these mismatching dimensions. I did some investigation using ample print statements, and figured out that the input resolution of the test-images are different depending on the .yaml. With this error-inducing .yaml, I get an input-shape of (24, 3, 208, 416), which seems reasonable at first glance because I use img-size 416 as an argument, but when I run the vanilla yolov3-tiny.yaml with the same arguments, I get an input-shape of (24, 3, 224, 416) which does not crash and is presumably the intended input. Training works fine either way and seems independent from the .yaml.\r\n\r\nI managed to code myself a workaround by making a ForceConcat module that does zero-padding for the rounding-resolution-problem, but that seems like treating the symptom rather than the underlying problem.\r\n\r\n\r\n## To Reproduce\r\n\r\nInput:\r\n```\r\n# parameters\r\nnc: 80  # number of classes\r\ndepth_multiple: 1.0  # model depth multiple\r\nwidth_multiple: 1.0  # layer channel multiple\r\n\r\n# anchors\r\nanchors:\r\n  - [10,14, 23,27, 37,58]  # P4/16\r\n  - [81,82, 135,169, 344,319]  # P5/32\r\n\r\n# YOLOv3-tiny backbone\r\nbackbone:\r\n  # [from, number, module, args]\r\n  [[-1, 1, Conv, [16, 3, 1]],  # 0\r\n   [-1, 1, nn.MaxPool2d, [2, 2, 0]],  # 1-P1/2\r\n   [-1, 1, Conv, [32, 3, 1]],\r\n   [-1, 1, nn.MaxPool2d, [2, 2, 0]],  # 3-P2/4\r\n   [-1, 1, Conv, [64, 3, 1]],\r\n   [-1, 1, nn.MaxPool2d, [2, 2, 0]],  # 5-P3/8\r\n   [-1, 1, Conv, [128, 3, 1]],\r\n   [-1, 1, nn.MaxPool2d, [2, 2, 0]],  # 7-P4/16\r\n   [-1, 1, Conv, [256, 3, 1]],\r\n   [-1, 1, nn.MaxPool2d, [2, 2, 0]],  # 9-P5/32\r\n   [-1, 1, Conv, [512, 3, 1]],\r\n   [-1, 1, nn.ZeroPad2d, [0, 1, 0, 1]],  # 11\r\n   [-1, 1, nn.MaxPool2d, [2, 1, 0]],  # 12\r\n  ]\r\n\r\n# YOLOv3-tiny head\r\nhead:\r\n  [[-1, 1, Conv, [1024, 3, 1]],\r\n   [-1, 1, Conv, [256, 1, 1]],\r\n   [-1, 1, Conv, [512, 3, 1]],  # 15 (P5/32-large)\r\n\r\n   [-2, 1, Conv, [128, 1, 1]],\r\n   [-1, 1, nn.Upsample, [None, 2, 'nearest']],\r\n   [[-1, 8], 1, Concat, [1]],  # cat backbone P4\r\n   [-1, 1, Conv, [256, 3, 1]],  # 19 (P4/16-medium)\r\n   [18, 1, nn.Upsample, [None, 2, 'nearest']], #20 # change to P3 resolution\r\n   [[-1, 6], 1, Concat, [1]], # combine with P3\r\n   [-1, 1, Conv, [256, 1, 1]], # 22\r\n   [-1, 1, Conv, [128, 3, 1]], # 23\r\n   [[23, 19], 1, Detect, [nc, anchors]], #24\r\n  ]\r\n```\r\nInterestingly, when I change the detection-input from [23,19] to [23,15] or [19, 15], for whatever strange reason the bug does not occur and I get the regular input-size, despite still doing the exact same upsampling, downsampling, and concatenations.\r\n\r\nOutput:\r\n```\r\nTraceback (most recent call last):\r\n  File \"train.py\", line 562, in <module>\r\n    train(hyp, opt, device, tb_writer, wandb)\r\n  File \"train.py\", line 383, in train\r\n    results, maps, times = test.test(opt.data,\r\n  File \"/home/vaynonym/programming/python/machine-learning/bachelor-thesis/yolov3-ultralytics/yolov3/test.py\", line 117, in test\r\n    inf_out, train_out = model(img, augment=augment)  # inference and training outputs\r\n  File \"/home/vaynonym/.local/lib/python3.8/site-packages/torch/nn/modules/module.py\", line 727, in _call_impl\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/vaynonym/programming/python/machine-learning/bachelor-thesis/yolov3-ultralytics/yolov3/models/yolo.py\", line 253, in forward\r\n    return self.forward_once(x, profile)  # single-scale inference, train\r\n  File \"/home/vaynonym/programming/python/machine-learning/bachelor-thesis/yolov3-ultralytics/yolov3/models/yolo.py\", line 284, in forward_once\r\n    x = m(x)  # run\r\n  File \"/home/vaynonym/.local/lib/python3.8/site-packages/torch/nn/modules/module.py\", line 727, in _call_impl\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/vaynonym/programming/python/machine-learning/bachelor-thesis/yolov3-ultralytics/yolov3/models/common.py\", line 111, in forward\r\n    return torch.cat(x, self.d)\r\nRuntimeError: Sizes of tensors must match except in dimension 2. Got 13 and 12 (The offending index is 0)\r\n```\r\n\r\nNote: the line numbers will not be accurate since I did some other unrelated changes\r\n\r\n\r\n## Expected behavior\r\nInput resolution at test-time should be independent of what layer I detect on.\r\n\r\n\r\n## Environment\r\n\r\n - OS: Ubuntu WSL\r\n - GPU: 970\r\n\r\n","closed_by":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1669/timeline","performed_via_github_app":null,"state_reason":"completed"}