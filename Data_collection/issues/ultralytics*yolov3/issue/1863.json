{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863","repository_url":"https://api.github.com/repos/ultralytics/yolov3","labels_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863/labels{/name}","comments_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863/comments","events_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863/events","html_url":"https://github.com/ultralytics/yolov3/issues/1863","id":1060725317,"node_id":"I_kwDOCLZQgM4_OWJF","number":1863,"title":"Cuda device selection bug","user":{"login":"chamboin","id":26534871,"node_id":"MDQ6VXNlcjI2NTM0ODcx","avatar_url":"https://avatars.githubusercontent.com/u/26534871?v=4","gravatar_id":"","url":"https://api.github.com/users/chamboin","html_url":"https://github.com/chamboin","followers_url":"https://api.github.com/users/chamboin/followers","following_url":"https://api.github.com/users/chamboin/following{/other_user}","gists_url":"https://api.github.com/users/chamboin/gists{/gist_id}","starred_url":"https://api.github.com/users/chamboin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chamboin/subscriptions","organizations_url":"https://api.github.com/users/chamboin/orgs","repos_url":"https://api.github.com/users/chamboin/repos","events_url":"https://api.github.com/users/chamboin/events{/privacy}","received_events_url":"https://api.github.com/users/chamboin/received_events","type":"User","site_admin":false},"labels":[{"id":1035696370,"node_id":"MDU6TGFiZWwxMDM1Njk2Mzcw","url":"https://api.github.com/repos/ultralytics/yolov3/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1890885613,"node_id":"MDU6TGFiZWwxODkwODg1NjEz","url":"https://api.github.com/repos/ultralytics/yolov3/labels/Stale","name":"Stale","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-11-23T00:39:55Z","updated_at":"2021-12-30T00:08:11Z","closed_at":"2021-12-30T00:08:11Z","author_association":"NONE","active_lock_reason":null,"body":"### Search before asking\n\n- [X] I have searched the YOLOv3 [issues](https://github.com/ultralytics/yolov3/issues) and found no similar bug report.\n\n\n### YOLOv3 Component\n\nDetection\n\n### Bug\n\n## Problems\r\nI have multiple GPUs and spot this issue when using a specific GPU (GPU 2 in my program). I load both the model and data to cuda:2 but got this error message during inference:\r\n```bash\r\n  File \"projectfolder/detect_action.py\", line 297, in get_prediction\r\n    pred = model(img, augment=False)[0]\r\n  File \"projectfolder/lib/python3.9/site-packages/torch/nn/modules/module.py\", line 1051, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"projectfolder/yolov3/models/yolo.py\", line 121, in forward\r\n    return self.forward_once(x, profile)  # single-scale inference, train\r\n  File \"projectfolder/yolov3/models/yolo.py\", line 152, in forward_once\r\n    x = m(x)  # run\r\n  File \"projectfolder/lib/python3.9/site-packages/torch/nn/modules/module.py\", line 1051, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"projectfolder/yolov3/models/common.py\", line 45, in fuseforward\r\n    return self.act(self.conv(x))\r\n  File \"projectfolder/lib/python3.9/site-packages/torch/nn/modules/module.py\", line 1051, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"projectfolder/lib/python3.9/site-packages/torch/nn/modules/conv.py\", line 443, in forward\r\n    return self._conv_forward(input, self.weight, self.bias)\r\n  File \"projectfolder/lib/python3.9/site-packages/torch/nn/modules/conv.py\", line 439, in _conv_forward\r\n    return F.conv2d(input, weight, bias, self.stride,\r\nRuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cuda:2! (when checking arugment for argument weight in method wrapper_cudnn_convolution)\r\n```\r\n## Code caused this problem\r\nI found that the method `select_device()` in `yolov3/utils/torch_utils.py` returns `cudu:0` no matter what the parameter transmits.\r\n\r\n```python\r\ndef select_device(device='', batch_size=None):\r\n    # device = 'cpu' or '0' or '0,1,2,3'\r\n    s = f'YOLOv3 ðŸš€ {git_describe() or date_modified()} torch {torch.__version__} '  # string\r\n    cpu = device.lower() == 'cpu'\r\n    if cpu:\r\n        os.environ['CUDA_VISIBLE_DEVICES'] = '-1'  # force torch.cuda.is_available() = False\r\n    elif device:  # non-cpu device requested\r\n        os.environ['CUDA_VISIBLE_DEVICES'] = device  # set environment variable\r\n        assert torch.cuda.is_available(), f'CUDA unavailable, invalid device {device} requested'  # check availability\r\n\r\n    cuda = not cpu and torch.cuda.is_available()\r\n    if cuda:\r\n        devices = device.split(',') if device else range(torch.cuda.device_count())  # i.e. 0,1,6,7\r\n        n = len(devices)  # device count\r\n        if n > 1 and batch_size:  # check batch_size is divisible by device_count\r\n            assert batch_size % n == 0, f'batch-size {batch_size} not multiple of GPU count {n}'\r\n        space = ' ' * len(s)\r\n        for i, d in enumerate(devices):\r\n            p = torch.cuda.get_device_properties(i)\r\n            s += f\"{'' if i == 0 else space}CUDA:{d} ({p.name}, {p.total_memory / 1024 ** 2}MB)\\n\"  # bytes to MB\r\n    else:\r\n        s += 'CPU\\n'\r\n\r\n    logger.info(s.encode().decode('ascii', 'ignore') if platform.system() == 'Windows' else s)  # emoji-safe\r\n    return torch.device('cuda:0' if cuda else 'cpu')\r\n```\r\nThis will cause the problem mentioned above.\n\n### Environment\n\n- YOLOv3 ðŸš€ v9.5.0-13-g1be3170 torch 1.9.0 CUDA:2 (NVIDIA GeForce RTX 2080 Ti, 11019.4375MB)\r\n- OS: Ubuntu 18.04 LTS\r\n- Python 3.9.6\n\n### Minimal Reproducible Example\n\n_No response_\n\n### Additional\n\n_No response_\n\n### Are you willing to submit a PR?\n\n- [X] Yes I'd like to help by submitting a PR!","closed_by":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1863/timeline","performed_via_github_app":null,"state_reason":"completed"}