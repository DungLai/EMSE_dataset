{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521","repository_url":"https://api.github.com/repos/ultralytics/yolov3","labels_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521/labels{/name}","comments_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521/comments","events_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521/events","html_url":"https://github.com/ultralytics/yolov3/issues/1521","id":722147732,"node_id":"MDU6SXNzdWU3MjIxNDc3MzI=","number":1521,"title":"using focal loss can impove mAP","user":{"login":"WZMIAOMIAO","id":31005897,"node_id":"MDQ6VXNlcjMxMDA1ODk3","avatar_url":"https://avatars.githubusercontent.com/u/31005897?v=4","gravatar_id":"","url":"https://api.github.com/users/WZMIAOMIAO","html_url":"https://github.com/WZMIAOMIAO","followers_url":"https://api.github.com/users/WZMIAOMIAO/followers","following_url":"https://api.github.com/users/WZMIAOMIAO/following{/other_user}","gists_url":"https://api.github.com/users/WZMIAOMIAO/gists{/gist_id}","starred_url":"https://api.github.com/users/WZMIAOMIAO/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WZMIAOMIAO/subscriptions","organizations_url":"https://api.github.com/users/WZMIAOMIAO/orgs","repos_url":"https://api.github.com/users/WZMIAOMIAO/repos","events_url":"https://api.github.com/users/WZMIAOMIAO/events{/privacy}","received_events_url":"https://api.github.com/users/WZMIAOMIAO/received_events","type":"User","site_admin":false},"labels":[{"id":1035696372,"node_id":"MDU6TGFiZWwxMDM1Njk2Mzcy","url":"https://api.github.com/repos/ultralytics/yolov3/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2020-10-15T09:08:45Z","updated_at":"2021-01-13T10:07:40Z","closed_at":"2020-10-19T15:00:50Z","author_association":"NONE","active_lock_reason":null,"body":"## ðŸš€ Feature\r\nFirst of all, thank the author for sharing the quality code.\r\nI found that using focal loss can impove one point mAP(@IOU=0.5)\r\n\r\n## Training datasets\r\ntrain_dataset:  **PASCAL VOC2012 train.txt**\r\nval_dataset:    ** PASCAL VOC2012 val.txt**\r\ntraining epoch:  **20**\r\ntraining initial lr: **0.001**\r\nend lr:  **0.00001**\r\ntraining layer: **only training predictor**\r\n\r\n## Description\r\nWhen I use default setting, I can get the following results.\r\n```\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.582\r\n Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.809\r\n Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.644\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.199\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.464\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.666\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.464\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.693\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.717\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.378\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.621\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.779\r\n```\r\n\r\nWhen I use focal loss fuction, I can get the following results.\r\n```\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.589\r\n Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.819\r\n Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.653\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.217\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.473\r\n Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.672\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.467\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.697\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.725\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.436\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.630\r\n Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.786\r\n```\r\n\r\nDuring using focal_loss, I change following setting:\r\n```\r\n\"cls\": 37.4 * 20,  # default 37.4\r\n\"obj\": 64.3 * 45,  # default 64.3  \r\n\"fl_gamma\": 1.5,  # default 0.0\r\n``` \r\nIn addition, I suggest adding a parameter(max_num) to NMS function.  In some cases, it can speed up the test time.\r\n```python\r\ndef non_max_suppression(prediction, conf_thres=0.1, iou_thres=0.6,\r\n                        multi_label=True, classes=None, agnostic=False, max_num=100):\r\n    ...\r\n    i = torchvision.ops.boxes.nms(boxes, scores, iou_thres)\r\n    i = i[:max_num]  # only save top max_num objects\r\n    ...\r\n```\r\n\r\nI hope it works for you. Thank you.\r\n","closed_by":{"login":"WZMIAOMIAO","id":31005897,"node_id":"MDQ6VXNlcjMxMDA1ODk3","avatar_url":"https://avatars.githubusercontent.com/u/31005897?v=4","gravatar_id":"","url":"https://api.github.com/users/WZMIAOMIAO","html_url":"https://github.com/WZMIAOMIAO","followers_url":"https://api.github.com/users/WZMIAOMIAO/followers","following_url":"https://api.github.com/users/WZMIAOMIAO/following{/other_user}","gists_url":"https://api.github.com/users/WZMIAOMIAO/gists{/gist_id}","starred_url":"https://api.github.com/users/WZMIAOMIAO/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WZMIAOMIAO/subscriptions","organizations_url":"https://api.github.com/users/WZMIAOMIAO/orgs","repos_url":"https://api.github.com/users/WZMIAOMIAO/repos","events_url":"https://api.github.com/users/WZMIAOMIAO/events{/privacy}","received_events_url":"https://api.github.com/users/WZMIAOMIAO/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1521/timeline","performed_via_github_app":null,"state_reason":"completed"}