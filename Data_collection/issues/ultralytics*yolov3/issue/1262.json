{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262","repository_url":"https://api.github.com/repos/ultralytics/yolov3","labels_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262/labels{/name}","comments_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262/comments","events_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262/events","html_url":"https://github.com/ultralytics/yolov3/issues/1262","id":628139831,"node_id":"MDU6SXNzdWU2MjgxMzk4MzE=","number":1262,"title":"change anchor box shape","user":{"login":"Stephanessy","id":36906827,"node_id":"MDQ6VXNlcjM2OTA2ODI3","avatar_url":"https://avatars.githubusercontent.com/u/36906827?v=4","gravatar_id":"","url":"https://api.github.com/users/Stephanessy","html_url":"https://github.com/Stephanessy","followers_url":"https://api.github.com/users/Stephanessy/followers","following_url":"https://api.github.com/users/Stephanessy/following{/other_user}","gists_url":"https://api.github.com/users/Stephanessy/gists{/gist_id}","starred_url":"https://api.github.com/users/Stephanessy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stephanessy/subscriptions","organizations_url":"https://api.github.com/users/Stephanessy/orgs","repos_url":"https://api.github.com/users/Stephanessy/repos","events_url":"https://api.github.com/users/Stephanessy/events{/privacy}","received_events_url":"https://api.github.com/users/Stephanessy/received_events","type":"User","site_admin":false},"labels":[{"id":1890885613,"node_id":"MDU6TGFiZWwxODkwODg1NjEz","url":"https://api.github.com/repos/ultralytics/yolov3/labels/Stale","name":"Stale","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-06-01T04:18:20Z","updated_at":"2020-07-19T00:22:40Z","closed_at":"2020-07-19T00:22:40Z","author_association":"NONE","active_lock_reason":null,"body":"I changed the anchor box shape to ellipse using shapely package. I changed the bbox_iou function to: \r\n```\r\nfrom shapely.geometry.point import Point\r\nfrom shapely import affinity\r\n\r\ndef create_ellipse(center, lengths, angle=0):\r\n    circ = Point(center).buffer(1)\r\n    ell = affinity.scale(circ, lengths[0], lengths[1])\r\n    ellr = affinity.rotate(ell, angle)\r\n    return ellr\r\n\r\n\r\ndef bbox_iou(box1, box2, x1y1x2y2=True):\r\n    # Returns the IoU of box1 to box2. box1 is 4, box2 is nx4\r\n    box2 = box2.t()\r\n    #print(\"box1: \", box1)\r\n    #print(\"box1.device: \", box1.device)\r\n    #print(\"box2: \", box2)\r\n    #print(\"box2.device: \", box2.device)\r\n\r\n    # Get the coordinates of bounding boxes\r\n    if x1y1x2y2:  # x1, y1, x2, y2 = box1\r\n        b1_x1, b1_y1, b1_x2, b1_y2 = box1[0], box1[1], box1[2], box1[3]\r\n        b2_x1, b2_y1, b2_x2, b2_y2 = box2[0], box2[1], box2[2], box2[3]\r\n    else:  # transform from xywh to xyxy\r\n        b1_x1, b1_x2 = box1[0] - box1[2] / 2, box1[0] + box1[2] / 2\r\n        b1_y1, b1_y2 = box1[1] - box1[3] / 2, box1[1] + box1[3] / 2\r\n        b2_x1, b2_x2 = box2[0] - box2[2] / 2, box2[0] + box2[2] / 2\r\n        b2_y1, b2_y2 = box2[1] - box2[3] / 2, box2[1] + box2[3] / 2\r\n\r\n    # center and lengths of the ellipse 1\r\n    c_x1 = (b1_x1 + b1_x2) / 2\r\n    c_y1 = (b1_y1 + b1_y2) / 2\r\n    w1 = b1_x2 - b1_x1\r\n    h1 = b1_y2 - b1_y1\r\n\r\n    # center and lengths of the ellipse 2\r\n    c_x2 = (b2_x1 + b2_x2) / 2\r\n    c_y2 = (b2_y1 + b2_y2) / 2\r\n    w2 = b2_x2 - b2_x1\r\n    h2 = b2_y2 - b2_y1\r\n\r\n    # Intersection area and Union Area\r\n    inter_area = []\r\n    b1_area = []\r\n    b2_area = []\r\n    for c_x1_t, c_y1_t, w1_t, h1_t, c_x2_t, c_y2_t, w2_t, h2_t in zip(c_x1, c_y1, w1, h1, c_x2, c_y2, w2, h2):\r\n        ell1 = create_ellipse((c_x1_t.item(), c_y1_t.item()), (w1_t.item()/2, h1_t.item()/2), 0)\r\n        ell2 = create_ellipse((c_x2_t.item(), c_y2_t.item()), (w2_t.item()/2, h2_t.item()/2), 0)\r\n        try:\r\n            inter_area.append(ell1.intersection(ell2).area)\r\n        except:\r\n            inter_area.append(0)\r\n        b1_area.append(ell1.area)\r\n        b2_area.append(ell2.area)\r\n    inter_area = torch.tensor(inter_area, device='cuda') if torch.cuda.is_available() else torch.tensor(inter_area)\r\n    b1_area = torch.tensor(b1_area, device='cuda') if torch.cuda.is_available() else torch.tensor(b1_area)\r\n    b2_area = torch.tensor(b2_area, device='cuda') if torch.cuda.is_available() else torch.tensor(b2_area)\r\n\r\n    iou = inter_area / (b1_area + b2_area - inter_area + 1e-16)\r\n    return iou\r\n\r\n```\r\nThen start to train, but I find that training time for one epoch is too long:\r\n![image](https://user-images.githubusercontent.com/36906827/83375532-2853e080-a39d-11ea-8d1f-7d654a6bb666.png)\r\nWhen I train the original model, the training time for one epoch is one hour. How to improve my modification so that training time is less?","closed_by":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ultralytics/yolov3/issues/1262/timeline","performed_via_github_app":null,"state_reason":"completed"}