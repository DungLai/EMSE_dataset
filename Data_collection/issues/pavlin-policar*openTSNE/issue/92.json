{"url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92","repository_url":"https://api.github.com/repos/pavlin-policar/openTSNE","labels_url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92/labels{/name}","comments_url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92/comments","events_url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92/events","html_url":"https://github.com/pavlin-policar/openTSNE/issues/92","id":487746322,"node_id":"MDU6SXNzdWU0ODc3NDYzMjI=","number":92,"title":"pynndescent throws error when n_jobs=-1","user":{"login":"jgraving","id":5445636,"node_id":"MDQ6VXNlcjU0NDU2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5445636?v=4","gravatar_id":"","url":"https://api.github.com/users/jgraving","html_url":"https://github.com/jgraving","followers_url":"https://api.github.com/users/jgraving/followers","following_url":"https://api.github.com/users/jgraving/following{/other_user}","gists_url":"https://api.github.com/users/jgraving/gists{/gist_id}","starred_url":"https://api.github.com/users/jgraving/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jgraving/subscriptions","organizations_url":"https://api.github.com/users/jgraving/orgs","repos_url":"https://api.github.com/users/jgraving/repos","events_url":"https://api.github.com/users/jgraving/events{/privacy}","received_events_url":"https://api.github.com/users/jgraving/received_events","type":"User","site_admin":false},"labels":[{"id":959087247,"node_id":"MDU6TGFiZWw5NTkwODcyNDc=","url":"https://api.github.com/repos/pavlin-policar/openTSNE/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-08-31T08:31:55Z","updated_at":"2019-09-08T07:39:01Z","closed_at":"2019-09-08T06:43:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Nice work on this! Unfortunately, I ran into an error. Not sure if it's yours or pynndescent. See below...\r\n\r\n##### Expected behaviour\r\nAccording to your API https://opentsne.readthedocs.io/en/latest/api/index.html you should be able to set `n_jobs=-1`, and I would expect openTSNE trains successfully with `n_jobs=-1`\r\n##### Actual behaviour\r\npynndescent throws an errors:\r\n```python\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-30-6084a3963dd8> in <module>()\r\n----> 1 embedding_train = tsne.fit(np.random.normal(size=(500,10)))\r\n\r\n/home/jake/.local/lib/python3.6/site-packages/openTSNE/tsne.py in fit(self, X)\r\n   1040 \r\n   1041         \"\"\"\r\n-> 1042         embedding = self.prepare_initial(X)\r\n   1043 \r\n   1044         try:\r\n\r\n/home/jake/.local/lib/python3.6/site-packages/openTSNE/tsne.py in prepare_initial(self, X)\r\n   1118             metric_params=self.metric_params,\r\n   1119             n_jobs=self.n_jobs,\r\n-> 1120             random_state=self.random_state,\r\n   1121         )\r\n   1122 \r\n\r\n/home/jake/.local/lib/python3.6/site-packages/openTSNE/affinity.py in __init__(self, data, perplexity, method, metric, metric_params, symmetrize, n_jobs, random_state)\r\n    124         k_neighbors = min(self.n_samples - 1, int(3 * self.perplexity))\r\n    125         self.knn_index, self.__neighbors, self.__distances = build_knn_index(\r\n--> 126             data, method, k_neighbors, metric, metric_params, n_jobs, random_state\r\n    127         )\r\n    128 \r\n\r\n/home/jake/.local/lib/python3.6/site-packages/openTSNE/affinity.py in build_knn_index(data, method, k, metric, metric_params, n_jobs, random_state)\r\n    277         )\r\n    278 \r\n--> 279     neighbors, distances = knn_index.build(data, k=k)\r\n    280 \r\n    281     return knn_index, neighbors, distances\r\n\r\n/home/jake/.local/lib/python3.6/site-packages/openTSNE/nearest_neighbors.py in build(self, data, k)\r\n    207             algorithm=\"standard\",\r\n    208             max_candidates=60,\r\n--> 209             n_jobs=self.n_jobs,\r\n    210         )\r\n    211 \r\n\r\n/home/jake/.local/lib/python3.6/site-packages/pynndescent/pynndescent_.py in __init__(self, data, metric, metric_kwds, n_neighbors, n_trees, leaf_size, pruning_level, tree_init, random_state, algorithm, max_candidates, n_iters, delta, rho, n_jobs, seed_per_row, verbose)\r\n    552                 verbose=verbose,\r\n    553                 n_jobs=n_jobs,\r\n--> 554                 seed_per_row=seed_per_row,\r\n    555             )\r\n    556         elif algorithm == \"standard\" or leaf_array.shape[0] == 1:\r\n\r\n/home/jake/.local/lib/python3.6/site-packages/pynndescent/threaded.py in nn_descent(data, n_neighbors, rng_state, max_candidates, dist, dist_args, n_iters, delta, rho, rp_tree_init, leaf_array, verbose, n_jobs, seed_per_row)\r\n    583             rng_state,\r\n    584             parallel,\r\n--> 585             seed_per_row=seed_per_row,\r\n    586         )\r\n    587 \r\n\r\n/home/jake/.local/lib/python3.6/site-packages/pynndescent/threaded.py in init_current_graph(data, dist, dist_args, n_neighbors, chunk_size, rng_state, parallel, seed_per_row)\r\n    149     # store the updates in an array\r\n    150     max_heap_update_count = chunk_size * n_neighbors * 2\r\n--> 151     heap_updates = np.zeros((n_tasks, max_heap_update_count, 4))\r\n    152     heap_update_counts = np.zeros((n_tasks,), dtype=np.int64)\r\n    153     rng_state_threads = per_thread_rng_state(n_tasks, rng_state)\r\n\r\nValueError: negative dimensions are not allowed\r\n```\r\n##### Steps to reproduce the behavior\r\nHere is a minimal working example (works fine with `n_jobs` set to a positive value):\r\n```python\r\nfrom openTSNE import TSNE\r\nfrom openTSNE.callbacks import ErrorLogger\r\nimport numpy as np\r\n\r\ntsne = TSNE(\r\n    perplexity=30,\r\n    metric='euclidean',\r\n    callbacks=ErrorLogger(),\r\n    n_jobs=-1\r\n)\r\n\r\nembedding_train = tsne.fit(np.random.normal(size=(500,10)))\r\n```","closed_by":{"login":"jgraving","id":5445636,"node_id":"MDQ6VXNlcjU0NDU2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5445636?v=4","gravatar_id":"","url":"https://api.github.com/users/jgraving","html_url":"https://github.com/jgraving","followers_url":"https://api.github.com/users/jgraving/followers","following_url":"https://api.github.com/users/jgraving/following{/other_user}","gists_url":"https://api.github.com/users/jgraving/gists{/gist_id}","starred_url":"https://api.github.com/users/jgraving/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jgraving/subscriptions","organizations_url":"https://api.github.com/users/jgraving/orgs","repos_url":"https://api.github.com/users/jgraving/repos","events_url":"https://api.github.com/users/jgraving/events{/privacy}","received_events_url":"https://api.github.com/users/jgraving/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pavlin-policar/openTSNE/issues/92/timeline","performed_via_github_app":null,"state_reason":"completed"}