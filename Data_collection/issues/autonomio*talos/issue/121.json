{"url":"https://api.github.com/repos/autonomio/talos/issues/121","repository_url":"https://api.github.com/repos/autonomio/talos","labels_url":"https://api.github.com/repos/autonomio/talos/issues/121/labels{/name}","comments_url":"https://api.github.com/repos/autonomio/talos/issues/121/comments","events_url":"https://api.github.com/repos/autonomio/talos/issues/121/events","html_url":"https://github.com/autonomio/talos/issues/121","id":376319579,"node_id":"MDU6SXNzdWUzNzYzMTk1Nzk=","number":121,"title":"custom metric and saved models","user":{"login":"dambuck","id":43039871,"node_id":"MDQ6VXNlcjQzMDM5ODcx","avatar_url":"https://avatars.githubusercontent.com/u/43039871?v=4","gravatar_id":"","url":"https://api.github.com/users/dambuck","html_url":"https://github.com/dambuck","followers_url":"https://api.github.com/users/dambuck/followers","following_url":"https://api.github.com/users/dambuck/following{/other_user}","gists_url":"https://api.github.com/users/dambuck/gists{/gist_id}","starred_url":"https://api.github.com/users/dambuck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dambuck/subscriptions","organizations_url":"https://api.github.com/users/dambuck/orgs","repos_url":"https://api.github.com/users/dambuck/repos","events_url":"https://api.github.com/users/dambuck/events{/privacy}","received_events_url":"https://api.github.com/users/dambuck/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-11-01T09:39:25Z","updated_at":"2018-11-21T14:17:03Z","closed_at":"2018-11-21T14:17:03Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nso working with version 0.4.4 now.\r\n\r\nThere are a few things which are still unclear to me when using custom metrics and trying to load the saved_models. \r\n\r\n\r\n    def GRU_test(x_train,y_train,x_val,y_val, params):\r\n        neuron=73\r\n        latent_rep_size=73\r\n        def vae_loss(true, pred):\r\n            true = K.flatten(true)\r\n            pred = K.flatten(pred)\r\n            poisson = 1*objectives.poisson(true, pred)\r\n        return poisson \r\n    \r\n    def R2_metric(y_true, y_pred):\r\n        SS_res =  K.sum(K.square(y_true-y_pred)) \r\n        SS_tot = K.sum(K.square(y_true - K.mean(y_true))) \r\n        return (1 - SS_res/(SS_tot + K.epsilon()))\r\n    \r\n    inp = Input(shape=(time_steps, neuron)) \r\n    encode = Bidirectional(GRU(neuron, return_sequences=True, dropout=0.0, name='lstm_1'), merge_mode='concat')(inp)\r\n    encode = Bidirectional(GRU(neuron, activation='linear', dropout=0.0, name='lstm_2'), merge_mode='concat')(encode)\r\n\r\n\r\n    z_mean = Dense(neuron, name='z_mean', activation='linear')(encode)\r\n    z_log_var = Dense(neuron, name='z_log_var', activation='linear')(encode)\r\n    encode=Lambda(sampling, output_shape=(neuron,), name='lambda')([z_mean, z_log_var])\r\n    \r\n\r\n    repeated_context = RepeatVector(time_steps)(encode)\r\n\r\n    decode = GRU(neuron, return_sequences=True,dropout=0.05, name='dec_lstm_12',activation='linear')(repeated_context)\r\n   \r\n\r\n    decode=TimeDistributed(Dense(params['size'], activation='linear'), name='get_factors')(decode)\r\n    decode=TimeDistributed(Dense(neuron, activation='linear'), name= 'pre_rates')(decode)\r\n    decode=TimeDistributed(Dense(neuron, activation= K.exp ),name= 'exp_layer')(decode)\r\n\r\n    nan=TerminateOnNaN()\r\n    callbacklist=[nan]\r\n\r\n\r\n    adam = optimizers.adam(clipvalue=200)\r\n    Vae=Model(inputs=inp, outputs=decode)\r\n    Vae.compile(optimizer='adam',loss= vae_loss, metrics=[R2_metric])\r\n    out=Vae.fit(x_train, y_train,validation_data=[x_val,y_val],epochs=400, callbacks=callbacklist)\r\n    \r\n\r\n    return out, Vae\r\n\r\n    Gru = ta.Scan(ofc_binned, ofc_binned, params=latent_size,dataset_name='GRU_log', model=GRU_test,experiment_no='1')\r\n\r\nOne thing is the load_model function which is listed as part of the Predict() command in the talos manual. I just couldnt manage to pick a specific model to load and to test. It gives me the error:\r\n     \r\n    <ipython-input-36-26b8b8f6ad51> in <module>()\r\n      1 p = ta.Predict(Gru)\r\n      2 # p.predict(ofc_binned,0)\r\n    ----> 3 p.load_model(0)\r\n\r\n    AttributeError: 'Predict' object has no attribute 'load_model'\r\n\r\nWhen just using the p.predict(data,1) line, I get an error for unknown function exp. How do I add a custom object dict at this point?\r\n\r\n\r\nWhen trying something like saving the model first and loading it:\r\n\r\n    settings_dict={'exp': K.exp, 'latent_rep_size':73,'epsilon_std':1 }\r\n    one=model_from_json(saved_models[0],custom_objects=settings_dict)\r\n    one.save(os.getcwd()+ '/trained/GRU_test/model.hdf5' )\r\n    one = load_model(os.getcwd()+'/trained/GRU_test/model.hdf5' ,custom_objects=settings_dict)\r\n\r\nWhen predicting with that model I clearly get the results of an untrained model. Does talos actually save all the models that are tested? If so could you show me a quick way how to load them?\r\n\r\nThanks a lot\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/autonomio/talos/issues/121/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/autonomio/talos/issues/121/timeline","performed_via_github_app":null,"state_reason":"completed"}