{"url":"https://api.github.com/repos/autonomio/talos/issues/441","repository_url":"https://api.github.com/repos/autonomio/talos","labels_url":"https://api.github.com/repos/autonomio/talos/issues/441/labels{/name}","comments_url":"https://api.github.com/repos/autonomio/talos/issues/441/comments","events_url":"https://api.github.com/repos/autonomio/talos/issues/441/events","html_url":"https://github.com/autonomio/talos/issues/441","id":541334386,"node_id":"MDU6SXNzdWU1NDEzMzQzODY=","number":441,"title":"RuntimeError: You must compile your model before training/testing when retraining model","user":{"login":"SamBelkacem","id":33413333,"node_id":"MDQ6VXNlcjMzNDEzMzMz","avatar_url":"https://avatars.githubusercontent.com/u/33413333?v=4","gravatar_id":"","url":"https://api.github.com/users/SamBelkacem","html_url":"https://github.com/SamBelkacem","followers_url":"https://api.github.com/users/SamBelkacem/followers","following_url":"https://api.github.com/users/SamBelkacem/following{/other_user}","gists_url":"https://api.github.com/users/SamBelkacem/gists{/gist_id}","starred_url":"https://api.github.com/users/SamBelkacem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SamBelkacem/subscriptions","organizations_url":"https://api.github.com/users/SamBelkacem/orgs","repos_url":"https://api.github.com/users/SamBelkacem/repos","events_url":"https://api.github.com/users/SamBelkacem/events{/privacy}","received_events_url":"https://api.github.com/users/SamBelkacem/received_events","type":"User","site_admin":false},"labels":[{"id":1004957685,"node_id":"MDU6TGFiZWwxMDA0OTU3Njg1","url":"https://api.github.com/repos/autonomio/talos/labels/topic:%20keras","name":"topic: keras","color":"ffffff","default":false,"description":"relates with keras backend"},{"id":1040763409,"node_id":"MDU6TGFiZWwxMDQwNzYzNDA5","url":"https://api.github.com/repos/autonomio/talos/labels/user%20support","name":"user support","color":"59db8b","default":false,"description":"nothing is wrong with Talos"}],"state":"closed","locked":false,"assignee":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"assignees":[{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false}],"milestone":null,"comments":18,"created_at":"2019-12-21T14:47:25Z","updated_at":"2020-02-12T08:36:35Z","closed_at":"2020-02-12T08:36:12Z","author_association":"NONE","active_lock_reason":null,"body":"ta.__version__  : 0.6.3\r\n\r\nI'm using **Talos** and Google colab **TPU** to run hyperparameter tuning of a **Keras** model.\r\n\r\n# Function to create and compile the **Keras** model\r\n\r\n```\r\ndef create_model(x_train, y_train, x_val, y_val, params):\r\n    # Specify a distributed strategy to use TPU\r\n    resolver = tf.contrib.cluster_resolver.TPUClusterResolver(tpu='grpc://' + os.environ['COLAB_TPU_ADDR'])\r\n    tf.contrib.distribute.initialize_tpu_system(resolver)\r\n    strategy = tf.contrib.distribute.TPUStrategy(resolver)\r\n\r\n    # Use the distributed strategy to create and compile a Keras model\r\n    with strategy.scope():\r\n      deep_model = Sequential()\r\n      deep_model.add(Dense(16, input_shape=(16,), activation=tf.nn.relu, name=\"relu\"))\r\n      deep_model.add(Dense(1, activation=tf.nn.sigmoid, name=\"sigmoid\"))\r\n      optimizer = SGD(lr=params['learn_rate'], momentum=params['momentum'])\r\n      deep_model.compile(loss='categorical_crossentropy', optimizer=optimizer, metrics=['accuracy'])\r\n  \r\n    # Convert data type to use TPU  \r\n    x_train = x_train.astype('float32')\r\n    x_val = x_val.astype('float32')\r\n    y_train = y_train.astype('int32')\r\n    y_val = y_val.astype('int32')\r\n\r\n    # Fit the Keras model on the dataset\r\n    steps_per_epoch = int(np.ceil(x_train.shape[0] / params['batch_size'])) - 1\r\n    out = deep_model.fit(x_train, y_train, batch_size=params['batch_size'], epochs=params['epochs'], validation_data=[x_val, y_val], verbose=0, steps_per_epoch=steps_per_epoch)\r\n\r\n    # Return the history output and the Keras model\r\n    return out, deep_model\r\n```\r\n\r\n# Create a parameter distributions:\r\n\r\n```\r\np = {'batch_size': [512, 1024],\r\n        'epochs': [10],\r\n        'learn_rate': [0.1, 0.2, 0.3],\r\n        'momentum': [0.2, 0.4, 0.6]}    \r\n```\r\n\r\n# Scan the best hyperparameters of the Keras model\r\n\r\n`scan_results = ta.Scan(x_train, y_train, params=p, model=create_model, experiment_name='exp', x_val=x_val, y_val=y_val)`\r\n\r\n# Best model  with the highest categorical accuracy\r\n\r\n```\r\nR = ta.Reporting(max(glob.glob('exp/*.csv'), key=os.path.getctime))\r\nprint(R.best_params(metric='val_acc', exclude=[]))\r\nmodel_id = scan_results.data['val_acc'].astype('float').argmax() - 1\r\nmodel = model_from_json(scan_results.saved_models[model_id])\r\nmodel.set_weights(scan_results.saved_weights[model_id])\r\n```\r\n\r\n# Everything works till here. However, I get this error when I retrain the model\r\n\r\n`model.fit(x_train, y_train)`\r\n\r\n**RuntimeError:** You must compile your model before training/testing\r\n","closed_by":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/autonomio/talos/issues/441/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/autonomio/talos/issues/441/timeline","performed_via_github_app":null,"state_reason":"completed"}