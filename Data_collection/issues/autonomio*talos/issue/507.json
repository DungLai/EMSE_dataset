{"url":"https://api.github.com/repos/autonomio/talos/issues/507","repository_url":"https://api.github.com/repos/autonomio/talos","labels_url":"https://api.github.com/repos/autonomio/talos/issues/507/labels{/name}","comments_url":"https://api.github.com/repos/autonomio/talos/issues/507/comments","events_url":"https://api.github.com/repos/autonomio/talos/issues/507/events","html_url":"https://github.com/autonomio/talos/issues/507","id":710900212,"node_id":"MDU6SXNzdWU3MTA5MDAyMTI=","number":507,"title":"Talos Scan() gives InvalidArgumentError at 64% with Function call stack: test_function","user":{"login":"lmvanpoppel","id":64014642,"node_id":"MDQ6VXNlcjY0MDE0NjQy","avatar_url":"https://avatars.githubusercontent.com/u/64014642?v=4","gravatar_id":"","url":"https://api.github.com/users/lmvanpoppel","html_url":"https://github.com/lmvanpoppel","followers_url":"https://api.github.com/users/lmvanpoppel/followers","following_url":"https://api.github.com/users/lmvanpoppel/following{/other_user}","gists_url":"https://api.github.com/users/lmvanpoppel/gists{/gist_id}","starred_url":"https://api.github.com/users/lmvanpoppel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmvanpoppel/subscriptions","organizations_url":"https://api.github.com/users/lmvanpoppel/orgs","repos_url":"https://api.github.com/users/lmvanpoppel/repos","events_url":"https://api.github.com/users/lmvanpoppel/events{/privacy}","received_events_url":"https://api.github.com/users/lmvanpoppel/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-09-29T08:47:58Z","updated_at":"2020-11-15T11:18:07Z","closed_at":"2020-11-15T11:18:07Z","author_association":"NONE","active_lock_reason":null,"body":"First of all, thanks very much for developing this tool, it is very intuitive and easy to use for people to whom machine learning is new (like me). I hope you can help me with the following. I don't understand why the error occurs at 64% of the scan? \r\n\r\n**#### 1) Confirm the below - Confirmed; Python 3.7.6**\r\n**#### 2) Include the output of:**\r\n\r\n`talos.__version__`\r\n1.0.0\r\n\r\n**#### 3) Explain clearly what you are trying to achieve**\r\n\r\nI am using Talos to determine certain hyperparameters for my LSTM model. My input are subject matrices of [features x timesteps] and my output per subject is binary '1' or '0'. \r\n\r\nI want to have my model optimized to not predict false positives (the subject is either sick (1) or not sick(0), it is crucial that the model doesn't falsely predict sickness)\r\n\r\nIn the Scan I therefor use the reduction_metric 'val_precision' \r\n\r\n\r\n**#### 4) Explain what you have already tried**\r\n\r\nI used the Talos examples to create a search, I ran the Scan function. This all went well until the scan was at 64% and I got this error: \r\n\r\n```\r\nUsing TensorFlow backend.\r\n  0%|          | 0/614 [00:00<?, ?it/s]2020-09-28 16:26:18.733017: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN)to use the following CPU instructions in performance-critical operations:  AVX2 FMA\r\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\r\n2020-09-28 16:26:18.747796: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x7fcd7fe417c0 initialized for platform Host (this does not guarantee that XLA will be used). Devices:\r\n2020-09-28 16:26:18.747809: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version\r\n 64%|██████▎   | 390/614 [1:49:42<1:14:59, 20.09s/it]Traceback (most recent call last):\r\n\r\n  File \"/Users/.../Talos_search01\", line 142, in <module>\r\n    reduction_metric='val_precision')\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/talos/scan/Scan.py\", line 196, in __init__\r\n    scan_run(self)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/talos/scan/scan_run.py\", line 26, in scan_run\r\n    self = scan_round(self)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/talos/scan/scan_round.py\", line 19, in scan_round\r\n    self.model_history, self.round_model = ingest_model(self)\r\n\r\n  File \"/Users/...l/opt/anaconda3/lib/python3.7/site-packages/talos/model/ingest_model.py\", line 10, in ingest_model\r\n    self.round_params)\r\n\r\n  File \"/Users/.../Talos_search01\", line 109, in LSTM_model\r\n    verbose=0)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 108, in _method_wrapper\r\n    return method(self, *args, **kwargs)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 1133, in fit\r\n    return_dict=True)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 108, in _method_wrapper\r\n    return method(self, *args, **kwargs)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 1379, in evaluate\r\n    tmp_logs = test_function(iterator)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 780, in __call__\r\n    result = self._call(*args, **kwds)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 814, in _call\r\n    results = self._stateful_fn(*args, **kwds)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 2829, in __call__\r\n    return graph_function._filtered_call(args, kwargs)  # pylint: disable=protected-access\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 1848, in _filtered_call\r\n    cancellation_manager=cancellation_manager)\r\n\r\n  File \"/Users/.../opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 1924, in _call_flat\r\n    ctx, args, cancellation_manager=cancellation_manager))\r\n\r\n  File \"/Users/...l/opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 550, in call\r\n    ctx=ctx)\r\n\r\n  File \"/Users/...l/opt/anaconda3/lib/python3.7/site-packages/tensorflow/python/eager/execute.py\", line 60, in quick_execute\r\n    inputs, attrs, num_outputs)\r\n\r\nInvalidArgumentError:  assertion failed: [predictions must be >= 0] [Condition x >= y did not hold element-wise:] [x (sequential/activation/Sigmoid:0) = ] [[nan][nan][nan]...] [y (Cast_6/x:0) = ] [0]\r\n\t [[{{node assert_greater_equal/Assert/AssertGuard/else/_49/assert_greater_equal/Assert/AssertGuard/Assert}}]] [Op:__inference_test_function_5700163]\r\n\r\nFunction call stack:\r\ntest_function\r\n\r\n\r\n```\r\n#### 5) Provide a code-complete reference\r\n\r\n```\r\n\r\nimport tensorflow \r\nfrom tensorflow.keras.models import Sequential\r\nfrom tensorflow.keras.layers import Dense, Dropout, LSTM, BatchNormalization, Activation\r\nfrom tensorflow.keras.regularizers import l1_l2\r\nfrom tensorflow.keras.optimizers import Adam, Nadam, SGD  \r\nfrom tensorflow.keras.metrics import Accuracy, AUC, FalsePositives, SensitivityAtSpecificity, Precision\r\n\r\nimport pandas as pd\r\nimport numpy as np \r\nimport matplotlib\r\nfrom matplotlib import pyplot\r\nfrom scipy.io import loadmat\r\nfrom sklearn.model_selection import train_test_split\r\n\r\nimport talos\r\nfrom talos.utils import lr_normalizer\r\n\r\n\r\n################\r\n# Prepare Data #\r\n################\r\n\r\n# import 2D structure \r\ndataMatlab = loadmat('LSTM_poorpos.mat');\r\ndataML = dataMatlab.get('LSTM_poorpos');\r\n\r\n# define features and targets \r\nfeatures = dataML[:,:13];\r\noutcomes = dataML[:,13]; # 1 is poor outcome \r\n\r\n# reshape to input matrices and outcome vector\r\ntimesteps = 30;\r\npredictors = 13; \r\nsubjects = int(features.shape[0]/timesteps);\r\n\r\nx = features.reshape(subjects,timesteps,predictors);\r\ny = outcomes.reshape(subjects,timesteps);\r\ny = y[:,0];\r\n    \r\n\r\n# divide data into train and test sets\r\nx_train,x_test,y_train,y_test=train_test_split(x,y,test_size=0.1,stratify=y);\r\n# divide training data into train and validation sets\r\nx_tr,x_val,y_tr,y_val=train_test_split(x_train,y_train,test_size=0.2,stratify=y_train);\r\n\r\n\r\n\r\ndef LSTM_model(x_tr, y_tr, x_val, y_val, params):\r\n    \r\n    ##############################\r\n    # Define constant parameters #\r\n    ##############################\r\n    # first LSTM layer \r\n    input_LSTM = (x_tr.shape[1:])\r\n    # fully connected layer \r\n    activation_function_FC = 'sigmoid'\r\n    hidden_units_FC = 1\r\n    # compile\r\n    loss_function = 'binary_crossentropy'\r\n    metric1 = 'accuracy'\r\n    metric2 = AUC(name='auc')\r\n    metric3 = Precision(name='precision')\r\n    metric4 = SensitivityAtSpecificity(1, name='sensitivity_at_specificity')\r\n    \r\n\r\n    ###############\r\n    # Build model # \r\n    ###############   \r\n    model = Sequential()\r\n    \r\n    model.add(LSTM(params['hidden_units_LSTM1'], \r\n                   input_shape=input_LSTM, \r\n                   activation=params['activation1'],\r\n                   dropout=params['dropout1'], \r\n                   recurrent_dropout=params['recurrent_dropout1'], \r\n                   return_sequences=False))\r\n   \r\n    model.add(BatchNormalization())\r\n    model.add(Dense(hidden_units_FC))\r\n    model.add(Activation(activation_function_FC))\r\n   \r\n    \r\n    #################\r\n    # Compile model #\r\n    #################\r\n    \r\n    model.compile(\r\n        loss=loss_function,\r\n        optimizer=params['optimizer'](lr=lr_normalizer(params['lr'], params['optimizer'])),\r\n        metrics=[metric1, metric2, metric3, metric4])\r\n    \r\n\r\n    #############\r\n    # Fit model #\r\n    #############\r\n    history = model.fit(x_tr,\r\n                        y_tr,\r\n                        validation_data=(x_val,y_val),\r\n                        batch_size=params['batch_size'],\r\n                        epochs=params['epochs'],\r\n                        verbose=0)\r\n    \r\n   # history object and model are returned\r\n    return history, model\r\n\r\n\r\n##############\r\n# Parameters # \r\n##############\r\n\r\np = {'hidden_units_LSTM1':[5,10,15,20,35,50,75,100],\r\n     'activation1':['relu', 'tanh'],      \r\n     'dropout1': (0, 0.8, 4),\r\n     'recurrent_dropout1':(0, 0.8, 4),\r\n     \r\n     'optimizer': [SGD, Adam, Nadam],\r\n     'lr': (0.1, 10, 5),\r\n\r\n     'batch_size': [16,32,64,128],\r\n     'epochs': [50,100,150,200],\r\n     }\r\n   \r\n########\r\n# Scan #\r\n########\r\nscan_object = talos.Scan(x=x_tr,\r\n                         y=y_tr,\r\n                         x_val=x_val,\r\n                         y_val=y_val,\r\n                         model=LSTM_model,\r\n                         params=p,\r\n                         experiment_name='Outcome Prediction',\r\n                         fraction_limit=0.01,\r\n                         reduction_metric='val_precision')\r\n\r\n```\r\n\r\nx = (254,30,13) array of float64 (254 subjects, 30 timesteps, 13 features)\r\ny = (254,) array of float64 (254 binary outcomes for subjects)\r\n\r\nexample of a subject matrix (30x13)\r\n<img width=\"1440\" alt=\"image\" src=\"https://user-images.githubusercontent.com/64014642/94534235-6f18f080-0240-11eb-9306-a0d978156c96.png\">\r\n\r\n---\r\n","closed_by":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/autonomio/talos/issues/507/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/autonomio/talos/issues/507/timeline","performed_via_github_app":null,"state_reason":"completed"}