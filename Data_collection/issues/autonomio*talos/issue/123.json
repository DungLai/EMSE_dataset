{"url":"https://api.github.com/repos/autonomio/talos/issues/123","repository_url":"https://api.github.com/repos/autonomio/talos","labels_url":"https://api.github.com/repos/autonomio/talos/issues/123/labels{/name}","comments_url":"https://api.github.com/repos/autonomio/talos/issues/123/comments","events_url":"https://api.github.com/repos/autonomio/talos/issues/123/events","html_url":"https://github.com/autonomio/talos/issues/123","id":377686828,"node_id":"MDU6SXNzdWUzNzc2ODY4Mjg=","number":123,"title":"How can I handle the inputs of seq2seq structure","user":{"login":"chjq201410695","id":29965893,"node_id":"MDQ6VXNlcjI5OTY1ODkz","avatar_url":"https://avatars.githubusercontent.com/u/29965893?v=4","gravatar_id":"","url":"https://api.github.com/users/chjq201410695","html_url":"https://github.com/chjq201410695","followers_url":"https://api.github.com/users/chjq201410695/followers","following_url":"https://api.github.com/users/chjq201410695/following{/other_user}","gists_url":"https://api.github.com/users/chjq201410695/gists{/gist_id}","starred_url":"https://api.github.com/users/chjq201410695/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chjq201410695/subscriptions","organizations_url":"https://api.github.com/users/chjq201410695/orgs","repos_url":"https://api.github.com/users/chjq201410695/repos","events_url":"https://api.github.com/users/chjq201410695/events{/privacy}","received_events_url":"https://api.github.com/users/chjq201410695/received_events","type":"User","site_admin":false},"labels":[{"id":994489876,"node_id":"MDU6TGFiZWw5OTQ0ODk4NzY=","url":"https://api.github.com/repos/autonomio/talos/labels/investigation","name":"investigation","color":"d3d3d3","default":false,"description":"gathering information"},{"id":1004957685,"node_id":"MDU6TGFiZWwxMDA0OTU3Njg1","url":"https://api.github.com/repos/autonomio/talos/labels/topic:%20keras","name":"topic: keras","color":"ffffff","default":false,"description":"relates with keras backend"},{"id":1167739181,"node_id":"MDU6TGFiZWwxMTY3NzM5MTgx","url":"https://api.github.com/repos/autonomio/talos/labels/topic:%20data","name":"topic: data","color":"ffffff","default":false,"description":"Has to do with input or output data"}],"state":"closed","locked":false,"assignee":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"assignees":[{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2018-11-06T04:20:56Z","updated_at":"2019-09-16T16:42:20Z","closed_at":"2019-09-16T16:42:19Z","author_association":"NONE","active_lock_reason":null,"body":"Since a 'teacher forcing' stype seq2seq has two inputs (encoder_input and decoder_input), so theh shape of my input seems like \r\n                                          ( [encoder_input, decoder_input], decoder_output ), \r\nbut the ta.scan(x=x, y=y) just could be feeded ONE input how could I handle this issue.\r\nMoreover, my input shape is 3-D.  like (None, 1, 27) .   the second-dimention -- 1, means one time step.\r\n\r\n-----------------------------------------------------------------------------------------\r\nHere is my error:\r\n\r\n  0%|          | 0/1 [00:00<?, ?it/s]\r\n\r\nTrain on 2454936 samples, validate on 433224 samples\r\nEpoch 1/200\r\n\r\n\r\n - 56s - loss: 521.4868 - val_loss: 280.2057\r\nEpoch 2/200\r\n - 54s - loss: 167.9164 - val_loss: 128.9195\r\nEpoch 3/200\r\n - 54s - loss: 68.5409 - val_loss: 108.7375\r\nEpoch 4/200\r\n - 54s - loss: 45.1891 - val_loss: 105.2479\r\nEpoch 5/200\r\n - 54s - loss: 39.3365 - val_loss: 103.3062\r\nEpoch 6/200\r\n - 54s - loss: 37.2608 - val_loss: 106.7455\r\nEpoch 7/200\r\n - 54s - loss: 36.0576 - val_loss: 103.5695\r\n\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-52-af111a56260c> in <module>()\r\n     23             grid_downsample=0.0001,\r\n     24             seed= 2018,\r\n---> 25             functional_model=True\r\n     26            )\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/scan/Scan.py in __init__(self, x, y, params, model, dataset_name, experiment_no, x_val, y_val, val_split, shuffle, round_limit, grid_downsample, random_method, seed, search_method, reduction_method, reduction_interval, reduction_window, reduction_threshold, reduction_metric, reduce_loss, last_epoch_value, talos_log_name, clear_tf_session, functional_model, disable_progress_bar, print_params, debug)\r\n    164         # input parameters section ends\r\n    165 \r\n--> 166         self._null = self.runtime()\r\n    167 \r\n    168     def runtime(self):\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/scan/Scan.py in runtime(self)\r\n    169 \r\n    170         self = scan_prepare(self)\r\n--> 171         self = scan_run(self)\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/scan/scan_run.py in scan_run(self)\r\n     19                      disable=self.disable_progress_bar)\r\n     20     while len(self.param_log) != 0:\r\n---> 21         self = scan_round(self)\r\n     22         self.pbar.update(1)\r\n     23     self.pbar.close()\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/scan/scan_round.py in scan_round(self)\r\n     45 \r\n     46     _hr_out = run_round_results(self, _hr_out)\r\n---> 47     self._val_score = get_score(self)\r\n     48     write_log(self)\r\n     49     self.result.append(_hr_out)\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/metrics/score_model.py in get_score(self)\r\n     33         # for functional model experimental support\r\n     34         if self.functional_model:\r\n---> 35             y_pred = _functional_predict(self.keras_model, self.x_val)\r\n     36         # all other cases\r\n     37         else:\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/talos/metrics/score_model.py in _functional_predict(model, x, batch_size, verbose)\r\n      9     proba = model.predict(x,\r\n     10                           batch_size=batch_size,\r\n---> 11                           verbose=verbose)\r\n     12 \r\n     13     if proba.shape[-1] > 1:\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/keras/engine/training.py in predict(self, x, batch_size, verbose, steps)\r\n   1815         x = _standardize_input_data(x, self._feed_input_names,\r\n   1816                                     self._feed_input_shapes,\r\n-> 1817                                     check_batch_axis=False)\r\n   1818         if self.stateful:\r\n   1819             if x[0].shape[0] > batch_size and x[0].shape[0] % batch_size != 0:\r\n\r\n~/.conda/envs/ML_DNN/lib/python3.6/site-packages/keras/engine/training.py in _standardize_input_data(data, names, shapes, check_batch_axis, exception_prefix)\r\n     84                 'Expected to see ' + str(len(names)) + ' array(s), '\r\n     85                 'but instead got the following list of ' +\r\n---> 86                 str(len(data)) + ' arrays: ' + str(data)[:200] + '...')\r\n     87         elif len(names) > 1:\r\n     88             raise ValueError(\r\n\r\nValueError: Error when checking model : the list of Numpy arrays that you are passing to your model is not the size the model expected. Expected to see 2 array(s), but instead got the following list of 1 arrays: [array([[[15.7583  ,  0.      ,  0.      , ...,  0.      ,  0.      ,\r\n          0.      ],\r\n        [ 9.34305 ,  0.      ,  0.      , ...,  0.      ,  0.      ,\r\n          0.      ]],\r\n\r\n       [[19.6959 ...\r\n\r\n--------------------------------------------------------------------------------------\r\nHere are my talos params and ta.Scan() :\r\n\r\np = {\r\n    'first_neuron': [32, 64, 96],\r\n    'second_neuron': [32, 64, 96],\r\n    'fourth_neuron': [16, 32, 64],\r\n    'lr': [0.001,0.01,0.1,1,10],\r\n    'activation': [relu, elu, linear],\r\n    'optimizer':[Adam, Nadam],\r\n    'dropout':[0.2,0.3,0.4,0.5,0.6],\r\n    'batch_size': [128, 256, 512]\r\n    }\r\nt = ta.Scan(x = train,\r\n            y = train[:,1:,[0]],\r\n            model= model_experiment,\r\n            params=p,\r\n            random_method='quantum',\r\n            dataset_name=\"Xi'an_taxi\",\r\n            experiment_no='1',\r\n            x_val = test,\r\n            y_val = test[:,1:,[0]],\r\n            seed= 2018,\r\n            functional_model=True\r\n            )\r\n\r\n---------------------------------------------------------------------------- \r\nHere is my keras model:\r\n\r\ndef model_experiment(x_train, y_train, x_test, y_test, params):\r\n    global EPOHS\r\n    n_input_dim = 27\r\n    x_train_encoder, x_train_decoder = train[: , : , :], train[: , 0, :].reshape(len(train), 1, 27)\r\n    x_test_encoder, x_test_decoder = test[ : , : , :], test[: , 0, :].reshape(len(test), 1, 27)\r\n\r\n    #Encoder\r\n    encoder_inputs = Input(shape=(None,n_input_dim),name='encoder_inputs')\r\n    dropout1 = Dropout(params['dropout'])(encoder_inputs)\r\n    encoder_lstm1 = CuDNNLSTM(params['first_neuron'],kernel_initializer='orthogonal',return_sequences=True,name='encoder_lstm1')\r\n    encoder_lstm1_output = encoder_lstm1(dropout1)\r\n    dropout2 = Dropout(params['dropout'])(encoder_lstm1_output)\r\n    encoder_lstm2 = CuDNNLSTM(params['second_neuron'],kernel_initializer='orthogonal',return_sequences=False,return_state=True,name='encoder_lstm2')\r\n    encoder_outputs, state_h, state_c = encoder_lstm2(dropout2)\r\n    encoder_states = [state_h, state_c]\r\n    \r\n    #Decoder\r\n    decoder_inputs = Input(shape=(None,n_input_dim),name='decoder_inputs')\r\n\r\n    decoder_lstm1 = CuDNNLSTM(params['second_neuron'],return_sequences=True,return_state=False,name='decoder_lstm1')\r\n    decoder_lstm1_output = decoder_lstm1(decoder_inputs,initial_state=encoder_states)\r\n\r\n    dropout3 = Dropout(params['dropout'])(decoder_lstm1_output)\r\n\r\n    decoder_lstm2 = CuDNNLSTM(params['fourth_neuron'],return_sequences=True,return_state=False,name='decoder_lstm2')\r\n    decoder_output = decoder_lstm2(dropout3)\r\n\r\n    dropout4 = Dropout(params['dropout'])(decoder_output)\r\n\r\n    decoder_dense = Dense(1, activation= params['activation'],name='last_layer_dense')\r\n\r\n    decoder_outputs= decoder_dense(dropout4)\r\n\r\n    model = Model( [encoder_inputs,decoder_inputs], decoder_outputs, 'model')\r\n\r\n    model.compile(optimizer=params['optimizer'](lr_normalizer(params['lr'], params['optimizer'])), \r\n                                                loss='rmse')\r\n\r\n    reduce_LROnPlateau = ReduceLROnPlateau(monitor='val_loss', factor=0.5, patience=3, verbose=2, mode='auto',min_delta=0, min_lr=0.000001)\r\n\r\n    earlyStopping = EarlyStopping(monitor='val_loss', min_delta=0, patience=20, verbose=2, mode='auto')\r\n\r\n    out = model.fit([x_train_encoder,x_train_decoder], y_train, \r\n                        batch_size = params['batch_size'],\r\n                        epochs = EPOCHS,\r\n                        verbose = 2,\r\n                        callbacks = [reduce_LROnPlateau, earlyStopping],\r\n                        validation_data=([x_test_encoder,x_test_decoder], y_test)\r\n                        )\r\n    return out, model\r\n\r\n-------------------------------------------------------------------------\r\nIt seems like my input shape is not suitable for talos' requirement ? Is there any advise? Thanks.","closed_by":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/autonomio/talos/issues/123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/autonomio/talos/issues/123/timeline","performed_via_github_app":null,"state_reason":"completed"}