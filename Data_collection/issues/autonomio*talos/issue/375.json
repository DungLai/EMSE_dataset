{"url":"https://api.github.com/repos/autonomio/talos/issues/375","repository_url":"https://api.github.com/repos/autonomio/talos","labels_url":"https://api.github.com/repos/autonomio/talos/issues/375/labels{/name}","comments_url":"https://api.github.com/repos/autonomio/talos/issues/375/comments","events_url":"https://api.github.com/repos/autonomio/talos/issues/375/events","html_url":"https://github.com/autonomio/talos/issues/375","id":480652192,"node_id":"MDU6SXNzdWU0ODA2NTIxOTI=","number":375,"title":"Error when using variable loss weights which are adjusted using a callback","user":{"login":"patebel","id":25665820,"node_id":"MDQ6VXNlcjI1NjY1ODIw","avatar_url":"https://avatars.githubusercontent.com/u/25665820?v=4","gravatar_id":"","url":"https://api.github.com/users/patebel","html_url":"https://github.com/patebel","followers_url":"https://api.github.com/users/patebel/followers","following_url":"https://api.github.com/users/patebel/following{/other_user}","gists_url":"https://api.github.com/users/patebel/gists{/gist_id}","starred_url":"https://api.github.com/users/patebel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/patebel/subscriptions","organizations_url":"https://api.github.com/users/patebel/orgs","repos_url":"https://api.github.com/users/patebel/repos","events_url":"https://api.github.com/users/patebel/events{/privacy}","received_events_url":"https://api.github.com/users/patebel/received_events","type":"User","site_admin":false},"labels":[{"id":994489876,"node_id":"MDU6TGFiZWw5OTQ0ODk4NzY=","url":"https://api.github.com/repos/autonomio/talos/labels/investigation","name":"investigation","color":"d3d3d3","default":false,"description":"gathering information"},{"id":1004957408,"node_id":"MDU6TGFiZWwxMDA0OTU3NDA4","url":"https://api.github.com/repos/autonomio/talos/labels/topic:%20tensorflow","name":"topic: tensorflow","color":"ffffff","default":false,"description":"relates with tensorflow backend"}],"state":"closed","locked":false,"assignee":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"assignees":[{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2019-08-14T12:30:50Z","updated_at":"2019-09-04T17:21:22Z","closed_at":"2019-09-04T17:21:22Z","author_association":"NONE","active_lock_reason":null,"body":"- [x] I'm up-to-date with the latest release:\r\n\r\n- [x] I've confirmed that my Keras model works outside of Talos.\r\n\r\nI am running a model where I initalize weight parameters for my custom loss function in a static_params dict as follows:\r\n\r\n```\r\n    static_params = {'label_coordinates': label_coordinates,\r\n                     'max_lat': 41.285,\r\n                     'max_lon': -8.5,\r\n                     'min_lat': 41.0,\r\n                     'min_lon': -8.73,\r\n                     'lat_range': 0.285,\r\n                     'lon_range': 0.23,\r\n                     'alpha': K.variable(1),\r\n                     'beta': K.variable(0)\r\n                     }\r\n```\r\nIn order to get this dict to the model using talos i wrote a wrapper which looks like this:\r\n```\r\n\r\ndef dest_pred_model_talos(static_params):\r\n    def dest_pred_model(x_train: np.ndarray, y_train1: np.ndarray, x_val: np.ndarray,\r\n                        y_val1: np.ndarray, params: dict):\r\n        model = build_model(params, static_params)\r\n        model = compile_model(model, params, static_params)\r\n        history = fit_model(model, params, x_train, y_train1, x_val, y_val1)\r\n\r\n        return history, model\r\n\r\n    return dest_pred_model\r\n```\r\n\r\nThe weigths are changed using a callback after the first epoch of training. My paramter looks like this: \r\n```\r\n       hyperparameters = {'max_sequence_length': [50],\r\n                           'embed_length_trip': [2, 4, 8],\r\n                           'depth_lstm': [2, 4, 8],\r\n                           'num_regions': [2048],\r\n                           'num_epochs': [5],\r\n                           'batch_size': [1024],  # only choose multiples of each other\r\n                           'lr': [0.001, 0.0001, 0.1],\r\n                           'optimizer': [optimizers.Adam],\r\n                           'clipvalue': [0.5]\r\n                           }`\r\n\r\n```\r\n\r\nI call the Scan method as follows:\r\n\r\n```\r\n     h = ta.Scan(np.vstack(train['INPUT_POLYLINE'].tolist()), np.vstack(train['DESTINATION'].tolist()),\r\n                    params=hyperparameters,\r\n                    x_val=np.vstack(validation['INPUT_POLYLINE'].tolist()),\r\n                    y_val=np.vstack(validation['DESTINATION'].tolist()),\r\n                    # model=multi_gpu(dest_pred_model, gpus=2),\r\n                    model=dest_pred_model_talos(static_params),\r\n                    experiment_name='SingleInputLSTM2L',\r\n                    reduction_interval=5,\r\n                    reduction_method='correlation',\r\n                    reduction_metric='val_loss',\r\n                    minimize_loss=True,\r\n                    round_limit=11)\r\n```\r\n\r\nStarting Talos the first model is trained as assumed, but after building the second model an Error (see Trace arises). Any Ideas where the Bug might be?\r\n\r\nTrace: \r\n`Traceback (most recent call last):\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\IPython\\core\\interactiveshell.py\", line 3296, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-2-fdcb63e6b932>\", line 1, in <module>\r\n    runfile('C:/Projects/destination-prediction-thesis/src/models/LSTM_reg_min_2_losses.py', wdir='C:/Projects/destination-prediction-thesis/src/models')\r\n  File \"C:\\Program Files\\JetBrains\\PyCharm 2019.1.1\\helpers\\pydev\\_pydev_bundle\\pydev_umd.py\", line 197, in runfile\r\n    pydev_imports.execfile(filename, global_vars, local_vars)  # execute the script\r\n  File \"C:\\Program Files\\JetBrains\\PyCharm 2019.1.1\\helpers\\pydev\\_pydev_imps\\_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"C:/Projects/destination-prediction-thesis/src/models/LSTM_reg_min_2_losses.py\", line 254, in <module>\r\n    round_limit=11)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\talos\\scan\\Scan.py\", line 196, in __init__\r\n    self._runtime()\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\talos\\scan\\Scan.py\", line 201, in _runtime\r\n    self = scan_run(self)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\talos\\scan\\scan_run.py\", line 26, in scan_run\r\n    self = scan_round(self)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\talos\\scan\\scan_round.py\", line 19, in scan_round\r\n    self.model_history, self.keras_model = ingest_model(self)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\talos\\model\\ingest_model.py\", line 10, in ingest_model\r\n    self.round_params)\r\n  File \"C:/Projects/destination-prediction-thesis/src/models/LSTM_reg_min_2_losses.py\", line 195, in dest_pred_model\r\n    model = compile_model(model, params, static_params)\r\n  File \"C:/Projects/destination-prediction-thesis/src/models/LSTM_reg_min_2_losses.py\", line 102, in compile_model\r\n    loss_weights={'pred_weighted': static_params['alpha'], 'auxiliary_output': static_params['beta']})\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\keras\\engine\\training.py\", line 347, in compile\r\n    total_loss = loss_weight * output_loss\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\tensorflow\\python\\ops\\variables.py\", line 935, in _run_op\r\n    return tensor_oper(a.value(), *args, **kwargs)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\tensorflow\\python\\ops\\math_ops.py\", line 810, in binary_op_wrapper\r\n    with ops.name_scope(None, op_name, [x, y]) as name:\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 6083, in __enter__\r\n    g = _get_graph_from_inputs(self._values)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 5713, in _get_graph_from_inputs\r\n    _assert_same_graph(original_graph_element, graph_element)\r\n  File \"C:\\Projects\\destination-prediction-thesis\\venv\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 5649, in _assert_same_graph\r\n    original_item))\r\nValueError: Tensor(\"loss/pred_weighted_loss/Mean_2:0\", shape=(), dtype=float32) must be from the same graph as Tensor(\"Variable/read:0\", shape=(), dtype=float32).`\r\n","closed_by":{"login":"mikkokotila","id":7943188,"node_id":"MDQ6VXNlcjc5NDMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7943188?v=4","gravatar_id":"","url":"https://api.github.com/users/mikkokotila","html_url":"https://github.com/mikkokotila","followers_url":"https://api.github.com/users/mikkokotila/followers","following_url":"https://api.github.com/users/mikkokotila/following{/other_user}","gists_url":"https://api.github.com/users/mikkokotila/gists{/gist_id}","starred_url":"https://api.github.com/users/mikkokotila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikkokotila/subscriptions","organizations_url":"https://api.github.com/users/mikkokotila/orgs","repos_url":"https://api.github.com/users/mikkokotila/repos","events_url":"https://api.github.com/users/mikkokotila/events{/privacy}","received_events_url":"https://api.github.com/users/mikkokotila/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/autonomio/talos/issues/375/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/autonomio/talos/issues/375/timeline","performed_via_github_app":null,"state_reason":"completed"}