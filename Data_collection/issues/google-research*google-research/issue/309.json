{"url":"https://api.github.com/repos/google-research/google-research/issues/309","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/309/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/309/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/309/events","html_url":"https://github.com/google-research/google-research/issues/309","id":644209836,"node_id":"MDU6SXNzdWU2NDQyMDk4MzY=","number":309,"title":"[Astronet] ValueError: could not broadcast input array from shape (4,43) into shape (4,39)","user":{"login":"stefanofisc","id":47246021,"node_id":"MDQ6VXNlcjQ3MjQ2MDIx","avatar_url":"https://avatars.githubusercontent.com/u/47246021?v=4","gravatar_id":"","url":"https://api.github.com/users/stefanofisc","html_url":"https://github.com/stefanofisc","followers_url":"https://api.github.com/users/stefanofisc/followers","following_url":"https://api.github.com/users/stefanofisc/following{/other_user}","gists_url":"https://api.github.com/users/stefanofisc/gists{/gist_id}","starred_url":"https://api.github.com/users/stefanofisc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stefanofisc/subscriptions","organizations_url":"https://api.github.com/users/stefanofisc/orgs","repos_url":"https://api.github.com/users/stefanofisc/repos","events_url":"https://api.github.com/users/stefanofisc/events{/privacy}","received_events_url":"https://api.github.com/users/stefanofisc/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-06-23T23:24:49Z","updated_at":"2020-10-09T17:30:06Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### 1. The entire URL of the file you are using\r\n\r\nhttps://github.com/google-research/exoplanet-ml/tree/master/exoplanet-ml/astronet\r\n\r\n### 2. Describe the bug\r\n\r\nI'm trying to create training, validation and test set files in \"Process Kepler Data\" section.\r\n\r\n```\r\n# Preprocess light curves into sharded TFRecord files using 5 worker processes.\r\nbazel-bin/astronet/data/generate_input_records \\\r\n  --input_tce_csv_file=${TCE_CSV_FILE} \\\r\n  --kepler_data_dir=${KEPLER_DATA_DIR} \\\r\n  --output_dir=${TFRECORD_DIR} \\\r\n  --num_worker_processes=5\r\n```\r\n\r\nThe process seems to start without any issues and it starts to create tfrecords, but after a while I get this error:\r\n**\"ValueError: could not broadcast input array from shape (4,43) into shape (4,39)\"**\r\n\r\n### 3. Steps to reproduce\r\n\r\n**1. Setup the environment**\r\nThe following libraries are required:\r\ntensorflow==1.15\r\ntensorflow-probability==0.8\r\npandas\r\nnumpy\r\nscipy\r\nastropy\r\npydl\r\nabsl-py\r\n\r\nEnsure that test and build pass\r\n\r\n```\r\ncd exoplanet-ml  # Bazel must run from a directory with a WORKSPACE file\r\nbazel test astronet/... astrowavenet/... light_curve/... tf_util/... third_party/...\r\n```\r\n\r\n`bazel build astronet/...`\r\n\r\n**2. Download Kepler data**\r\n\r\nFirst, download the DR24 TCE Table in CSV format from the [NASA Exoplanet Archive](https://exoplanetarchive.ipac.caltech.edu/cgi-bin/TblView/nph-tblView?app=ExoTbls&config=q1_q17_dr24_tce) and ensure the following columns are selected:\r\n\r\n-    rowid: Integer ID of the row in the TCE table.\r\n-    kepid: Kepler ID of the target star.\r\n-   tce_plnt_num: TCE number within the target star.\r\n-   tce_period: Period of the detected event, in days.\r\n-   tce_time0bk: The time corresponding to the center of the first detected event in Barycentric Julian Day (BJD) minus a constant offset of 2,454,833.0 days.\r\n-  tce_duration: Duration of the detected event, in hours.\r\n-  av_training_set: Autovetter training set label; one of PC (planet candidate), AFP (astrophysical false positive), NTP (non-transiting phenomenon), UNK (unknown).\r\n\r\n```\r\n# Filename containing the CSV file of TCEs in the training set.\r\nTCE_CSV_FILE=\"${HOME}/astronet/dr24_tce.csv\"\r\n\r\n# Directory to download Kepler light curves into.\r\nKEPLER_DATA_DIR=\"${HOME}/astronet/kepler/\"\r\n\r\n# Generate a bash script that downloads the Kepler light curves in the training set.\r\npython astronet/data/generate_download_script.py \\\r\n  --kepler_csv_file=${TCE_CSV_FILE} \\\r\n  --download_dir=${KEPLER_DATA_DIR}\r\n\r\n# Run the download script to download Kepler light curves.\r\n./get_kepler.sh\r\n```\r\n### NOTE: the following script take up about 90 GB.\r\n\r\n**3. Process Kepler data**\r\n\r\n```\r\n# Directory to save output TFRecord files into.\r\nTFRECORD_DIR=\"${HOME}/astronet/tfrecord\"\r\n\r\n# Preprocess light curves into sharded TFRecord files using 5 worker processes.\r\nbazel-bin/astronet/data/generate_input_records \\\r\n  --input_tce_csv_file=${TCE_CSV_FILE} \\\r\n  --kepler_data_dir=${KEPLER_DATA_DIR} \\\r\n  --output_dir=${TFRECORD_DIR} \\\r\n  --num_worker_processes=5\r\n```\r\n\r\n### 4. Expected behavior\r\n\r\nWhen the script finishes you will find 8 training files, 1 validation file and 1 test file in TFRECORD_DIR. The files will match the patterns train-0000?-of-00008, val-00000-of-00001 and test-00000-of-00001 respectively.\r\n\r\n### 5. Additional context\r\n\r\n**Traceback (most recent call last):**\r\n\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\r\nresult = (True, func(*args, **kwds))\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/astronet/data/generate_input_records.py\", line 164, in _process_file_shard\r\nexample = _process_tce(tce)\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/astronet/data/generate_input_records.py\", line 144, in _process_tce\r\ntime, flux = preprocess.process_light_curve(all_time, all_flux)\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/astronet/data/preprocess.py\", line 72, in process_light_curve\r\nspline = kepler_spline.fit_kepler_spline(all_time, all_flux, verbose=False)[0]\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/third_party/kepler_spline/kepler_spline.py\", line 321, in fit_kepler_spline\r\nverbose=verbose)\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/third_party/kepler_spline/kepler_spline.py\", line 216, in choose_kepler_spline\r\ntime, flux, bkspace=bkspace, maxiter=maxiter)\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/third_party/kepler_spline/kepler_spline.py\", line 104, in kepler_spline\r\ncurve = bspline.iterfit(time[mask], flux[mask], bkspace=bkspace)[0]\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/pydl/pydlutils/bspline.py\", line 639, in iterfit\r\nx2=x2work)\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/pydl/pydlutils/bspline.py\", line 189, in fit\r\nerrb = cholesky_band(alpha, mininf=min_influence)\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/pydl/pydlutils/bspline.py\", line 491, in cholesky_band\r\nL[:, 0:n] = lower\r\nValueError: could not broadcast input array from shape (4,43) into shape (4,39)\r\n\"\"\"\r\n\r\n**The above exception was the direct cause of the following exception:**\r\n\r\nTraceback (most recent call last):\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/astronet/data/generate_input_records.py\", line 256, in\r\ntf.app.run(main=main, argv=[sys.argv[0]] + unparsed)\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/tensorflow_core/python/platform/app.py\", line 40, in run\r\n_run(main=main, argv=argv, flags_parser=_parse_flags_tolerate_undef)\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/absl/app.py\", line 299, in run\r\n_run_main(main, args)\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/site-packages/absl/app.py\", line 250, in _run_main\r\nsys.exit(main(argv))\r\nFile \"/home/s.fiscale/conda/exoplanet-ml/exoplanet-ml/bazel-bin/astronet/data/generate_input_records.runfiles/main/astronet/data/generate_input_records.py\", line 248, in main\r\nasync_result.get()\r\nFile \"/home/s.fiscale/anaconda3/envs/astronet_env/lib/python3.7/multiprocessing/pool.py\", line 657, in get\r\nraise self._value\r\n**ValueError: could not broadcast input array from shape (4,43) into shape (4,39)**\r\n\r\n### 6. System information\r\n\r\nI'm testing the model in conda environment\r\n\r\n-    OS Platform and Distribution: ('CentOS Linux', '7.6.1810', 'Core')\r\n-    TensorFlow installed from : source (https://anaconda.org/conda-forge/tensorflow)\r\n-   TensorFlow version : 1.15.0\r\n-    Python version: 3.7.7\r\n-    Bazel version : 2.1.0\r\n\r\nThanks.\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/309/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/309/timeline","performed_via_github_app":null,"state_reason":null}