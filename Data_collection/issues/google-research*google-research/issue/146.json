{"url":"https://api.github.com/repos/google-research/google-research/issues/146","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/146/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/146/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/146/events","html_url":"https://github.com/google-research/google-research/issues/146","id":527699491,"node_id":"MDU6SXNzdWU1Mjc2OTk0OTE=","number":146,"title":"Albert xLarge pretraining idles on single v3-8 tpu","user":{"login":"dhruvsakalley","id":3661965,"node_id":"MDQ6VXNlcjM2NjE5NjU=","avatar_url":"https://avatars.githubusercontent.com/u/3661965?v=4","gravatar_id":"","url":"https://api.github.com/users/dhruvsakalley","html_url":"https://github.com/dhruvsakalley","followers_url":"https://api.github.com/users/dhruvsakalley/followers","following_url":"https://api.github.com/users/dhruvsakalley/following{/other_user}","gists_url":"https://api.github.com/users/dhruvsakalley/gists{/gist_id}","starred_url":"https://api.github.com/users/dhruvsakalley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhruvsakalley/subscriptions","organizations_url":"https://api.github.com/users/dhruvsakalley/orgs","repos_url":"https://api.github.com/users/dhruvsakalley/repos","events_url":"https://api.github.com/users/dhruvsakalley/events{/privacy}","received_events_url":"https://api.github.com/users/dhruvsakalley/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-11-24T13:41:18Z","updated_at":"2020-03-24T16:07:51Z","closed_at":"2019-12-02T22:24:47Z","author_association":"NONE","active_lock_reason":null,"body":"I'm trying to train with ~ 568 tfrecord files totaling upto 1.9 TB, created from ~30GB of text and generated using 128 max_seq_length and custom vocab comparable to the original vocab size.\r\n\r\nHere are my training flasgs:\r\nnohup python3 run_pretraining.py \\\r\n  --input_file=gs://databucket-* \\\r\n  --output_dir=gs://output bucket \\\r\n  --export_dir==gs://export bucket \\\r\n  --do_train=True \\\r\n  --do_eval=True \\\r\n  --albert_config_file=gs://<config bucket>\\albert_config.json \\\r\n  --train_batch_size=512 \\\r\n  --eval_batch_size=64 \\\r\n  --max_seq_length=128 \\\r\n  --max_predictions_per_seq=20 \\\r\n  --num_train_steps=2000000 \\\r\n  --num_warmup_steps=10000 \\\r\n  --learning_rate=1e-4 \\\r\n  --use_tpu=True \\\r\n  --tpu_name=gorilla-alb-tpu \\\r\n  --save_checkpoints_steps=10000 \\\r\n  --max_eval_steps=100 \\\r\n  --num_tpu_cores=8 \\\r\n  --user_tpu=True \\\r\n  --keep_checkpoint_max=500 \\\r\n  \\> iter001.log &\r\n\r\nI tried this on the preemptible tpu first and did not even get one checkpoint, but later on the second iteration, I used a dedicated TPU, but after the global step 19000 its started idling and did not produce any checkpoints, as can be seen in the logs below. \r\nQ1: Any idea what am I missing here? \r\nQ2: Also, why is the train time so slow compared to BERT, which stepped through 10K/20 mins, here it seems 10K/1.15 hr or more?\r\nQ3: What is the recommended batch size for single TPU instance and how does it impact the train steps and the learning rate?\r\n\r\n\r\nExtract of the logs showing idling here : \r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:04:59.069434 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:loss = 6.453083, step = 19000 (1816.160 sec)\r\nI1124 07:05:04.021676 139980433229568 basic_session_run_hooks.py:260] loss = 6.453083, step = 19000 (1816.160 sec)\r\nINFO:tensorflow:global_step/sec: 0.550612\r\nI1124 07:05:04.024546 139980433229568 tpu_estimator.py:2307] global_step/sec: 0.550612\r\nINFO:tensorflow:examples/sec: 281.913\r\nI1124 07:05:04.024918 139980433229568 tpu_estimator.py:2308] examples/sec: 281.913\r\nINFO:tensorflow:Enqueue next (1000) batch(es) of data to infeed.\r\nI1124 07:05:04.025995 139980433229568 tpu_estimator.py:600] Enqueue next (1000) batch(es) of data to infeed.\r\nINFO:tensorflow:Dequeue next (1000) batch(es) of data from outfeed.\r\nI1124 07:05:04.026226 139980433229568 tpu_estimator.py:604] Dequeue next (1000) batch(es) of data from outfeed.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 12)\r\nI1124 07:05:28.020126 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 12)\r\nI1124 07:05:29.137331 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:05:29.192949 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:05:59.262590 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:05:59.311209 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:06:29.373492 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:06:29.447152 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 46)\r\nI1124 07:06:29.709674 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 46)\r\nI1124 07:06:59.522179 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:06:59.572463 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:07:29.611606 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:07:29.668322 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 80)\r\nI1124 07:07:31.398825 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 80)\r\nI1124 07:07:59.732999 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:07:59.793257 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:08:29.856629 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:08:29.919902 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 114)\r\nI1124 07:08:33.089343 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 114)\r\nI1124 07:08:59.989946 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:09:00.072418 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:09:30.138386 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:09:30.192759 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 148)\r\nI1124 07:09:34.782029 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 148)\r\nI1124 07:10:00.262878 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:10:00.322918 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:10:30.385881 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:10:30.438601 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 182)\r\nI1124 07:10:36.469368 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 182)\r\nI1124 07:11:00.488457 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:11:00.554763 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:11:30.607665 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:11:30.657622 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 216)\r\nI1124 07:11:38.161521 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 216)\r\nI1124 07:12:00.723495 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:12:00.779349 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:12:30.844133 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:12:30.897756 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 250)\r\nI1124 07:12:39.851271 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 250)\r\nI1124 07:13:00.941801 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:13:00.998180 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:13:31.063151 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:13:31.136875 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 284)\r\nI1124 07:13:41.539725 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 284)\r\nI1124 07:14:01.204144 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:14:01.270991 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:14:31.314057 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:14:31.368036 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 318)\r\nI1124 07:14:43.230399 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 318)\r\nI1124 07:15:01.408405 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:15:01.466477 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:15:31.531250 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:15:31.588218 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 352)\r\nI1124 07:15:44.920365 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 352)\r\nI1124 07:16:01.650633 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:16:01.709294 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:16:31.747833 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:16:31.803840 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 386)\r\nI1124 07:16:46.611431 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 386)\r\nI1124 07:17:01.843595 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:17:01.905045 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:17:31.969744 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:17:32.024375 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nINFO:tensorflow:Outfeed finished for iteration (19, 420)\r\nI1124 07:17:48.304604 139978655139584 tpu_estimator.py:279] Outfeed finished for iteration (19, 420)\r\nI1124 07:18:02.091745 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:18:02.247168 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:18:32.311644 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:18:32.362884 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:19:02.426864 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:19:02.486614 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:19:32.542831 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:19:32.602440 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nI1124 07:20:02.665383 139978646746880 transport.py:157] Attempting refresh to obtain initial access_token\r\nWARNING:tensorflow:TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\nW1124 07:20:02.727149 139978646746880 preempted_hook.py:91] TPUPollingThread found TPU b'gorilla-alb-tpu' in state READY, and health HEALTHY.\r\n\r\n[iter001.log](https://github.com/google-research/google-research/files/3883630/iter001.log)\r\n\r\n","closed_by":{"login":"dhruvsakalley","id":3661965,"node_id":"MDQ6VXNlcjM2NjE5NjU=","avatar_url":"https://avatars.githubusercontent.com/u/3661965?v=4","gravatar_id":"","url":"https://api.github.com/users/dhruvsakalley","html_url":"https://github.com/dhruvsakalley","followers_url":"https://api.github.com/users/dhruvsakalley/followers","following_url":"https://api.github.com/users/dhruvsakalley/following{/other_user}","gists_url":"https://api.github.com/users/dhruvsakalley/gists{/gist_id}","starred_url":"https://api.github.com/users/dhruvsakalley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhruvsakalley/subscriptions","organizations_url":"https://api.github.com/users/dhruvsakalley/orgs","repos_url":"https://api.github.com/users/dhruvsakalley/repos","events_url":"https://api.github.com/users/dhruvsakalley/events{/privacy}","received_events_url":"https://api.github.com/users/dhruvsakalley/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/146/reactions","total_count":3,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/146/timeline","performed_via_github_app":null,"state_reason":"completed"}