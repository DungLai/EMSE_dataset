{"url":"https://api.github.com/repos/google-research/google-research/issues/1278","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/1278/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/1278/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/1278/events","html_url":"https://github.com/google-research/google-research/issues/1278","id":1372057527,"node_id":"I_kwDOCQmIhc5Rx--3","number":1278,"title":"[diffusion_distillation] How to reproduce the results in paper ","user":{"login":"devzhk","id":22064516,"node_id":"MDQ6VXNlcjIyMDY0NTE2","avatar_url":"https://avatars.githubusercontent.com/u/22064516?v=4","gravatar_id":"","url":"https://api.github.com/users/devzhk","html_url":"https://github.com/devzhk","followers_url":"https://api.github.com/users/devzhk/followers","following_url":"https://api.github.com/users/devzhk/following{/other_user}","gists_url":"https://api.github.com/users/devzhk/gists{/gist_id}","starred_url":"https://api.github.com/users/devzhk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devzhk/subscriptions","organizations_url":"https://api.github.com/users/devzhk/orgs","repos_url":"https://api.github.com/users/devzhk/repos","events_url":"https://api.github.com/users/devzhk/events{/privacy}","received_events_url":"https://api.github.com/users/devzhk/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-13T22:10:40Z","updated_at":"2022-09-27T17:50:21Z","closed_at":"2022-09-27T17:50:21Z","author_association":"NONE","active_lock_reason":null,"body":"I tried to sample images using the code and checkpoint from [diffusion_distillation](https://github.com/google-research/google-research/blob/3b61da1d73543c374fc0564943e237db151af452/diffusion_distillation/README.md) to reproduce their results in this paper [PROGRESSIVE DISTILLATION FOR FAST SAMPLING OF DIFFUSION MODELS](https://arxiv.org/abs/2202.00512). However, the FID I got is much worse than the reported numbers. For example, sampling from cifar_original checkpoint with 1024 DDIM steps only got a FID of 18. I also tried the distilled model (cifar_8) that gave me a FID of 19.8. Anyone knows how to reproduce paper's results? \r\n\r\nThe code I used to sample is from the official [notebook demo](https://github.com/google-research/google-research/blob/3b61da1d73543c374fc0564943e237db151af452/diffusion_distillation/diffusion_distillation.ipynb). I use cleanfid to compute FID score. See my code below. \r\n```python\r\nimport jax\r\nimport flax\r\nimport numpy as onp\r\nimport diffusion_distillation\r\nfrom PIL import Image\r\nloaded_params = diffusion_distillation.checkpoints.restore_from_path('ckpts/cifar_8', target=None)['ema_params']\r\n\r\nconfig = diffusion_distillation.config.cifar_distill.get_config()\r\nmodel = diffusion_distillation.model.Model(config)\r\nema_params = jax.device_get(model.make_init_state()).ema_params\r\nloaded_params = flax.core.unfreeze(loaded_params)\r\nloaded_params = jax.tree_map(\r\n    lambda x, y: onp.reshape(x, y.shape) if hasattr(y, 'shape') else x,\r\n    loaded_params,\r\n    flax.core.unfreeze(ema_params))\r\nloaded_params = flax.core.freeze(loaded_params)\r\ndel ema_params\r\n\r\nbatch = {'image': jax.random.normal(jax.random.PRNGKey(10), shape=(250, 32, 32, 3))}\r\noutdir = 'exp/cifar_8'\r\nos.makedirs(outdir, exist_ok=True)\r\n\r\nfor i in range(200):\r\n    samples = model.samples_fn(rng=jax.random.PRNGKey(i), params=loaded_params, batch=batch, num_samples=250, num_steps=8)\r\n    samples = jax.device_get(samples).astype(onp.uint8)\r\n    num_imgs = samples.shape[0]\r\n    for j in range(num_imgs):\r\n        im = Image.fromarray(samples[j])\r\n        img_path = os.path.join(outdir, f'{i}-{j}.jpg')\r\n        im.save(img_path)\r\n\r\nfrom cleanfid import fid\r\n\r\nscore = fid.compute_fid(outdir, dataset_name='cifar10', dataset_res=32, dataset_split='train', mode='legacy_tensorflow')\r\nprint(score)\r\n```","closed_by":{"login":"devzhk","id":22064516,"node_id":"MDQ6VXNlcjIyMDY0NTE2","avatar_url":"https://avatars.githubusercontent.com/u/22064516?v=4","gravatar_id":"","url":"https://api.github.com/users/devzhk","html_url":"https://github.com/devzhk","followers_url":"https://api.github.com/users/devzhk/followers","following_url":"https://api.github.com/users/devzhk/following{/other_user}","gists_url":"https://api.github.com/users/devzhk/gists{/gist_id}","starred_url":"https://api.github.com/users/devzhk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devzhk/subscriptions","organizations_url":"https://api.github.com/users/devzhk/orgs","repos_url":"https://api.github.com/users/devzhk/repos","events_url":"https://api.github.com/users/devzhk/events{/privacy}","received_events_url":"https://api.github.com/users/devzhk/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/1278/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/1278/timeline","performed_via_github_app":null,"state_reason":"completed"}