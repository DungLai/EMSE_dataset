{"url":"https://api.github.com/repos/google-research/google-research/issues/849","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/849/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/849/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/849/events","html_url":"https://github.com/google-research/google-research/issues/849","id":1029868015,"node_id":"I_kwDOCQmIhc49Yonv","number":849,"title":"Does hitnet require a lot of GPU memory?","user":{"login":"jahad9819jjj","id":40851882,"node_id":"MDQ6VXNlcjQwODUxODgy","avatar_url":"https://avatars.githubusercontent.com/u/40851882?v=4","gravatar_id":"","url":"https://api.github.com/users/jahad9819jjj","html_url":"https://github.com/jahad9819jjj","followers_url":"https://api.github.com/users/jahad9819jjj/followers","following_url":"https://api.github.com/users/jahad9819jjj/following{/other_user}","gists_url":"https://api.github.com/users/jahad9819jjj/gists{/gist_id}","starred_url":"https://api.github.com/users/jahad9819jjj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jahad9819jjj/subscriptions","organizations_url":"https://api.github.com/users/jahad9819jjj/orgs","repos_url":"https://api.github.com/users/jahad9819jjj/repos","events_url":"https://api.github.com/users/jahad9819jjj/events{/privacy}","received_events_url":"https://api.github.com/users/jahad9819jjj/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2021-10-19T05:11:18Z","updated_at":"2022-03-03T07:38:35Z","closed_at":"2021-10-22T14:29:38Z","author_association":"NONE","active_lock_reason":null,"body":"I try to use [HITNET](https://github.com/google-research/google-research/tree/master/hitnet).\r\n\r\nGPU : Nvidia GeForce RTX 2060 SUPER\r\nMemory Size : 7981MiB\r\n\r\n```\r\nroot@2c4b59e82551:/workspace/hitnet# cat /etc/lsb-release\r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=18.04\r\nDISTRIB_CODENAME=bionic\r\nDISTRIB_DESCRIPTION=\"Ubuntu 18.04.5 LTS\"\r\n```\r\n\r\nI attempted stereo matching for MiddleBury as follows:\r\n```\r\nbash predict_middlebury.sh\r\n```\r\nThen It will omit an error like the following:\r\n```:bash\r\n(ellipsis)\r\n\r\n2021-10-19 05:19:40.789846: I tensorflow/core/common_runtime/bfc_allocator.cc:917] 2 Chunks of size 482344960 totalling 920.00MiB\r\n2021-10-19 05:19:40.789866: I tensorflow/core/common_runtime/bfc_allocator.cc:917] 2 Chunks of size 1543503872 totalling 2.88GiB\r\n2021-10-19 05:19:40.789886: I tensorflow/core/common_runtime/bfc_allocator.cc:921] Sum Total of in-use chunks: 4.37GiB\r\n2021-10-19 05:19:40.789905: I tensorflow/core/common_runtime/bfc_allocator.cc:923] total_region_allocated_bytes_: 6694947840 memory_limit_: 6694948044 available bytes: 204 curr_region_allocation_bytes_: 8589934592\r\n2021-10-19 05:19:40.789937: I tensorflow/core/common_runtime/bfc_allocator.cc:929] Stats:\r\nLimit:                  6694948044\r\nInUse:                  4697149440\r\nMaxInUse:               5784235008\r\nNumAllocs:                    1400\r\nMaxAllocSize:           1946157056\r\n\r\n2021-10-19 05:19:40.790006: W tensorflow/core/common_runtime/bfc_allocator.cc:424] *************************_*****************__*****_________************************____________*****\r\n2021-10-19 05:19:40.790060: W tensorflow/core/framework/op_kernel.cc:1651] OP_REQUIRES failed at conv_grad_input_ops.cc:1063 : Resource exhausted: OOM when allocating tensor with shape[2,32,2048,2944] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1365, in _do_call\r\n    return fn(*args)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1350, in _run_fn\r\n    target_list, run_metadata)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1443, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: 2 root error(s) found.\r\n  (0) Resource exhausted: OOM when allocating tensor with shape[2,32,2048,2944] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n\t [[{{node graph/fe_shared/conv_upsample_0/conv2d_transpose}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\t [[graph/reference_output_disparity/_155]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n  (1) Resource exhausted: OOM when allocating tensor with shape[2,32,2048,2944] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n\t [[{{node graph/fe_shared/conv_upsample_0/conv2d_transpose}}]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"predict_test.py\", line 301, in <module>\r\n    app.run(main)\r\n  File \"/usr/local/lib/python3.6/dist-packages/absl/app.py\", line 300, in run\r\n    _run_main(main, args)\r\n  File \"/usr/local/lib/python3.6/dist-packages/absl/app.py\", line 251, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"predict_test.py\", line 255, in main\r\n    reference_disparity = sess.run(reference, feed_dict=feed_dict)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 956, in run\r\n    run_metadata_ptr)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1180, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1359, in _do_run\r\n    run_metadata)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/client/session.py\", line 1384, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: 2 root error(s) found.\r\n  (0) Resource exhausted: OOM when allocating tensor with shape[2,32,2048,2944] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n\t [[node graph/fe_shared/conv_upsample_0/conv2d_transpose (defined at /usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py:1748) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n\t [[graph/reference_output_disparity/_155]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n  (1) Resource exhausted: OOM when allocating tensor with shape[2,32,2048,2944] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc\r\n\t [[node graph/fe_shared/conv_upsample_0/conv2d_transpose (defined at /usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py:1748) ]]\r\nHint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.\r\n\r\n0 successful operations.\r\n0 derived errors ignored.\r\n\r\nOriginal stack trace for 'graph/fe_shared/conv_upsample_0/conv2d_transpose':\r\n  File \"predict_test.py\", line 301, in <module>\r\n    app.run(main)\r\n  File \"/usr/local/lib/python3.6/dist-packages/absl/app.py\", line 300, in run\r\n    _run_main(main, args)\r\n  File \"/usr/local/lib/python3.6/dist-packages/absl/app.py\", line 251, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"predict_test.py\", line 238, in main\r\n    tf.import_graph_def(graph_def, name='graph')\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/util/deprecation.py\", line 513, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/importer.py\", line 405, in import_graph_def\r\n    producer_op_list=producer_op_list)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/importer.py\", line 517, in _import_graph_def_internal\r\n    _ProcessNewOps(graph)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/importer.py\", line 243, in _ProcessNewOps\r\n    for new_op in graph._add_new_tf_operations(compute_devices=False):  # pylint: disable=protected-access\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py\", line 3561, in _add_new_tf_operations\r\n    for c_op in c_api_util.new_tf_operations(self)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py\", line 3561, in <listcomp>\r\n    for c_op in c_api_util.new_tf_operations(self)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py\", line 3451, in _create_op_from_tf_operation\r\n    ret = Operation(c_op, self)\r\n  File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/framework/ops.py\", line 1748, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n```\r\n\r\nSo I changed the code as follows and tried again, but I still get the same error.\r\n\r\n```:bash\r\n# on predict_middlebury.sh\r\n- MODEL_NAME=\"middlebury_d400.pb\"\r\n+ MODEL_NAME=\"middlebury_d160.pb\"\r\n```\r\nand \r\n```:python\r\n# on predict.py\r\nconfig = tf.ConfigProto(\r\n          gpu_options=tf.GPUOptions(\r\n              per_process_gpu_memory_fraction=0.8,\r\n              allow_growth=True\r\n              )\r\n          )\r\n```\r\n\r\nI think it is generally known that the `Resource exhausted` problem can be solved by lowering the batch size, but I assume that Hitnet does not have a batch size. Is this assumption correct?\r\n\r\nI think the reason Hitnet can't run is because it's not avoiding `Resource exhausted`, does anyone know how to work around this problem?\r\n","closed_by":{"login":"jahad9819jjj","id":40851882,"node_id":"MDQ6VXNlcjQwODUxODgy","avatar_url":"https://avatars.githubusercontent.com/u/40851882?v=4","gravatar_id":"","url":"https://api.github.com/users/jahad9819jjj","html_url":"https://github.com/jahad9819jjj","followers_url":"https://api.github.com/users/jahad9819jjj/followers","following_url":"https://api.github.com/users/jahad9819jjj/following{/other_user}","gists_url":"https://api.github.com/users/jahad9819jjj/gists{/gist_id}","starred_url":"https://api.github.com/users/jahad9819jjj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jahad9819jjj/subscriptions","organizations_url":"https://api.github.com/users/jahad9819jjj/orgs","repos_url":"https://api.github.com/users/jahad9819jjj/repos","events_url":"https://api.github.com/users/jahad9819jjj/events{/privacy}","received_events_url":"https://api.github.com/users/jahad9819jjj/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/849/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/849/timeline","performed_via_github_app":null,"state_reason":"completed"}