{"url":"https://api.github.com/repos/google-research/google-research/issues/1317","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/1317/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/1317/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/1317/events","html_url":"https://github.com/google-research/google-research/issues/1317","id":1402544788,"node_id":"I_kwDOCQmIhc5TmSKU","number":1317,"title":"[Felix] ValueError: Unexpected result of `train_function` (Empty logs). ","user":{"login":"Vimos","id":2136700,"node_id":"MDQ6VXNlcjIxMzY3MDA=","avatar_url":"https://avatars.githubusercontent.com/u/2136700?v=4","gravatar_id":"","url":"https://api.github.com/users/Vimos","html_url":"https://github.com/Vimos","followers_url":"https://api.github.com/users/Vimos/followers","following_url":"https://api.github.com/users/Vimos/following{/other_user}","gists_url":"https://api.github.com/users/Vimos/gists{/gist_id}","starred_url":"https://api.github.com/users/Vimos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vimos/subscriptions","organizations_url":"https://api.github.com/users/Vimos/orgs","repos_url":"https://api.github.com/users/Vimos/repos","events_url":"https://api.github.com/users/Vimos/events{/privacy}","received_events_url":"https://api.github.com/users/Vimos/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-10-10T03:34:49Z","updated_at":"2022-10-20T14:32:25Z","closed_at":"2022-10-20T14:32:24Z","author_association":"NONE","active_lock_reason":null,"body":"I have to patch the code to resolve some warnings and errors using `tensorflow==2.9.2`. \r\n\r\n```shell\r\ndiff --git a/felix/felix_models.py b/felix/felix_models.py\r\nindex 71412d51..cea1d2b2 100644\r\n--- a/felix/felix_models.py\r\n+++ b/felix/felix_models.py\r\n@@ -18,7 +18,9 @@ from typing import Union\r\n \r\n import numpy as np\r\n from official.modeling import activations\r\n-from official.nlp.legacy import configs\r\n+# from official.nlp.legacy import configs\r\n+from official.legacy.bert import configs\r\n+# from official.nlp import configs\r\n from official.nlp.modeling import losses\r\n from official.nlp.modeling import models\r\n from official.nlp.modeling import networks\r\n@@ -90,7 +92,8 @@ class BertPretrainLossAndMetricLayer(tf.keras.layers.Layer):\r\n     return mask_label_loss\r\n\r\n   def get_config(self):\r\n-    return self._config\r\n+    config = super().get_config()\r\n+    return config\r\n\r\n\r\n def get_insertion_model(bert_config,\r\n@@ -129,7 +132,7 @@ def get_insertion_model(bert_config,\r\n       activation=activations.gelu,\r\n       dropout_rate=bert_config.hidden_dropout_prob,\r\n       attention_dropout_rate=bert_config.attention_probs_dropout_prob,\r\n-      sequence_length=seq_length,\r\n+      # sequence_length=seq_length,\r\n       max_sequence_length=bert_config.max_position_embeddings,\r\n       type_vocab_size=bert_config.type_vocab_size,\r\n       initializer=tf.keras.initializers.TruncatedNormal(\r\n@@ -301,8 +304,8 @@ class FelixTagLoss(tf.keras.layers.Layer):\r\n     return total_loss\r\n\r\n   def get_config(self):\r\n-    return self._config\r\n-\r\n+    config = super().get_config()\r\n+    return config\r\n\r\n def get_tagging_model(bert_config,\r\n                       seq_length,\r\n@@ -339,7 +342,7 @@ def get_tagging_model(bert_config,\r\n       activation=activations.gelu,\r\n       dropout_rate=bert_config.hidden_dropout_prob,\r\n       attention_dropout_rate=bert_config.attention_probs_dropout_prob,\r\n-      sequence_length=seq_length,\r\n+      # sequence_length=seq_length,\r\n       max_sequence_length=bert_config.max_position_embeddings,\r\n       type_vocab_size=bert_config.type_vocab_size,\r\n       initializer=tf.keras.initializers.TruncatedNormal(\r\ndiff --git a/felix/felix_tagger.py b/felix/felix_tagger.py\r\nindex a3a912f1..54b5b092 100644\r\n--- a/felix/felix_tagger.py\r\n+++ b/felix/felix_tagger.py\r\n@@ -86,7 +86,7 @@ class FelixTagger(tf.keras.Model):\r\n           inner_activation=activations.gelu,\r\n           output_dropout=self._bert_config.hidden_dropout_prob,\r\n           attention_dropout=self._bert_config.hidden_dropout_prob,\r\n-          output_range=seq_length,\r\n+          # output_range=seq_length,\r\n       )\r\n\r\n     self._query_embeddings_layer = tf.keras.layers.Dense(\r\n@@ -140,6 +140,7 @@ class FelixTagger(tf.keras.Model):\r\n       The logits of the edit tags and optionally the logits of the pointer\r\n         network.\r\n     \"\"\"\r\n+    tf.print(inputs)\r\n     if self._is_training:\r\n       input_word_ids, input_mask, input_type_ids, edit_tags = inputs\r\n     else:\r\n\r\ndiff --git a/felix/run_felix.py b/felix/run_felix.py\r\nindex 95569938..f3488905 100644\r\n--- a/felix/run_felix.py\r\n+++ b/felix/run_felix.py\r\n@@ -126,10 +126,13 @@ def run_train(bert_config,\r\n       num_train_steps=steps_per_mini_epoch * mini_epochs_per_epoch * epochs,\r\n       num_warmup_steps=warmup_steps)\r\n\r\n+  tf.config.run_functions_eagerly(True)\r\n+  tf.data.experimental.enable_debug_mode()\r\n+\r\n   pretrain_model.compile(\r\n       optimizer=optimizer,\r\n       loss=loss_fn,\r\n-      experimental_steps_per_execution=FLAGS.steps_per_loop)\r\n+      steps_per_execution=FLAGS.steps_per_loop)\r\n   train_dataset = _get_input_data_fn(\r\n       train_file,\r\n       seq_length,\r\n@@ -183,7 +186,6 @@ def run_train(bert_config,\r\n   logging.info('Starting training from iteration: %s.', checkpoint_iteration)\r\n   summary_dir = os.path.join(model_dir, 'summaries')\r\n   summary_cb = tf.keras.callbacks.TensorBoard(summary_dir, update_freq=1000)\r\n-\r\n   manager = tf.train.CheckpointManager(\r\n       checkpoint, directory=model_dir, max_to_keep=FLAGS.keep_checkpoint_max,\r\n       checkpoint_name=_CHECKPOINT_FILE_NAME)\r\n```\r\n\r\nHowever, I still get the error below, is there any hint on how to solve this?\r\n\r\n```\r\nI1009 17:18:30.512812 140272607400896 optimization.py:90] using Adamw optimizer\r\nI1009 17:18:30.512971 140272607400896 legacy_adamw.py:56] AdamWeightDecay gradient_clip_norm=1.000000\r\nI1009 17:18:30.710452 140272607400896 run_felix.py:169] Initializing from a BERT checkpoint...\r\nI1009 17:18:30.976909 140272607400896 run_felix.py:186] Starting training from iteration: 0.\r\nEpoch 1/500\r\nTraceback (most recent call last):\r\n  File \"/home/vimos/Data/Text/chn_nlp/TextEditing/felix/run_felix.py\", line 239, in <module>\r\n    app.run(main)\r\n  File \"/home/vimos/anaconda3/lib/python3.9/site-packages/absl/app.py\", line 312, in run\r\n    _run_main(main, args)\r\n  File \"/home/vimos/anaconda3/lib/python3.9/site-packages/absl/app.py\", line 258, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"/home/vimos/Data/Text/chn_nlp/TextEditing/felix/run_felix.py\", line 228, in main\r\n    return run_train(bert_config, FLAGS.max_seq_length,\r\n  File \"/home/vimos/Data/Text/chn_nlp/TextEditing/felix/run_felix.py\", line 196, in run_train\r\n    pretrain_model.fit(\r\n  File \"/home/vimos/anaconda3/lib/python3.9/site-packages/keras/utils/traceback_utils.py\", line 70, in error_handler\r\n    raise e.with_traceback(filtered_tb) from None\r\n  File \"/home/vimos/anaconda3/lib/python3.9/site-packages/keras/engine/training.py\", line 1576, in fit\r\n    raise ValueError(\r\nValueError: Unexpected result of `train_function` (Empty logs). Please use `Model.compile(..., run_eagerly=True)`, or `tf.config.run_functions_eagerly(True)` for more information of where went wrong, or file a issue/bug to `tf.keras`.\r\n```","closed_by":{"login":"Vimos","id":2136700,"node_id":"MDQ6VXNlcjIxMzY3MDA=","avatar_url":"https://avatars.githubusercontent.com/u/2136700?v=4","gravatar_id":"","url":"https://api.github.com/users/Vimos","html_url":"https://github.com/Vimos","followers_url":"https://api.github.com/users/Vimos/followers","following_url":"https://api.github.com/users/Vimos/following{/other_user}","gists_url":"https://api.github.com/users/Vimos/gists{/gist_id}","starred_url":"https://api.github.com/users/Vimos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vimos/subscriptions","organizations_url":"https://api.github.com/users/Vimos/orgs","repos_url":"https://api.github.com/users/Vimos/repos","events_url":"https://api.github.com/users/Vimos/events{/privacy}","received_events_url":"https://api.github.com/users/Vimos/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/1317/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/1317/timeline","performed_via_github_app":null,"state_reason":"completed"}