{"url":"https://api.github.com/repos/google-research/google-research/issues/1206","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/1206/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/1206/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/1206/events","html_url":"https://github.com/google-research/google-research/issues/1206","id":1308350788,"node_id":"I_kwDOCQmIhc5N-9lE","number":1206,"title":"[MUSIQ] Error in Image Dimensionality","user":{"login":"TimHunt12","id":2401628,"node_id":"MDQ6VXNlcjI0MDE2Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/2401628?v=4","gravatar_id":"","url":"https://api.github.com/users/TimHunt12","html_url":"https://github.com/TimHunt12","followers_url":"https://api.github.com/users/TimHunt12/followers","following_url":"https://api.github.com/users/TimHunt12/following{/other_user}","gists_url":"https://api.github.com/users/TimHunt12/gists{/gist_id}","starred_url":"https://api.github.com/users/TimHunt12/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimHunt12/subscriptions","organizations_url":"https://api.github.com/users/TimHunt12/orgs","repos_url":"https://api.github.com/users/TimHunt12/repos","events_url":"https://api.github.com/users/TimHunt12/events{/privacy}","received_events_url":"https://api.github.com/users/TimHunt12/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-07-18T18:23:29Z","updated_at":"2022-07-18T22:54:07Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"@junjiek \r\n\r\nI get the following error when I run inference with only some images.  Some images are fine.  My guess is that the image dimensions are somehow not compatible.  I noticed that the issue comes on images that are tall and narrow but not always.\r\n\r\nDoes the images have to be a specific dimension to have them do inference correctly?.\r\n\r\n`\r\nImage size: 728x2048\r\nImage ratio: 0.35546875\r\n\r\nTraceback (most recent call last):\r\n\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 267, in <module>\r\n    main()\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 251, in main\r\n    pred = run_model_single_image(model_config, num_classes, pp_config, params, image_data)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 160, in run_model_single_image\r\n    image = prepare_image(image_path, pp_config)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 137, in prepare_image\r\n    data = pp_fn(data)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 301, in _preprocess_fn\r\n    image = get_multiscale_patches(image, **preprocessing_kwargs)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 210, in get_multiscale_patches\r\n    out = _extract_patches_and_positions_from_image(resized_image, patch_size, patch_stride, hse_grid_size,\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 164, in _extract_patches_and_positions_from_image\r\n    out = tf.concat([p, spatial_p, scale_p, mask_p], axis=2)\r\n  File \"/Users/timothyhunt/opt/anaconda3/lib/python3.9/site-packages/tensorflow/python/util/traceback_utils.py\", line 153, in error_handler\r\n    raise e.with_traceback(filtered_tb) from None\r\n  File \"/Users/timothyhunt/opt/anaconda3/lib/python3.9/site-packages/tensorflow/python/framework/ops.py\", line 7164, in raise_from_not_ok_status\r\n    raise core._status_to_exception(e) from None  # pylint: disable=protected-access\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: ConcatOp : Dimension 1 in both shapes must be equal: shape[0] = [1,28,3072] vs. shape[1] = [1,21,1] [Op:ConcatV2] name: concat\r\n`\r\n\r\nI get another error with a different image shape.\r\n`\r\nImage size: 2480x3509\r\nImage ratio: 0.7067540609860359\r\n\r\nTraceback (most recent call last):\r\n\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 267, in <module>\r\n    main()\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 243, in main\r\n    pred_mos = run_model_single_image(model_config, num_classes, pp_config, params, image_path)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 160, in run_model_single_image\r\n    image = prepare_image(image_path, pp_config)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/run_predict_image.py\", line 137, in prepare_image\r\n    data = pp_fn(data)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 301, in _preprocess_fn\r\n    image = get_multiscale_patches(image, **preprocessing_kwargs)\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 210, in get_multiscale_patches\r\n    out = _extract_patches_and_positions_from_image(resized_image, patch_size, patch_stride, hse_grid_size,\r\n  File \"/Users/timothyhunt/PycharmProjects/image_quality/model/preprocessing.py\", line 144, in _extract_patches_and_positions_from_image\r\n    p = tf.reshape(p, [n_crops, -1, patch_size * patch_size * c])\r\n  File \"/Users/timothyhunt/opt/anaconda3/lib/python3.9/site-packages/tensorflow/python/util/traceback_utils.py\", line 153, in error_handler\r\n    raise e.with_traceback(filtered_tb) from None\r\n  File \"/Users/timothyhunt/opt/anaconda3/lib/python3.9/site-packages/tensorflow/python/eager/execute.py\", line 54, in quick_execute\r\n    tensors = pywrap_tfe.TFE_Py_Execute(ctx._handle, device_name, op_name,\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 35840 values, but the requested shape requires a multiple of 3072 [Op:Reshape]\r\n`\r\n\r\nThese image dimensions I get a successful inference.\r\n\r\n`\r\nImage size: 2550x3301\r\nImage ratio: 0.7724931838836716\r\n\r\n36.122936 36.12_2de0e5a9-67b8-4011-bb1e-163a85863314-page-1.jpeg\r\n`\r\n\r\nHere is another one that processed successfully.\r\n`\r\nImage size: 2550x3301\r\nImage ratio: 0.7724931838836716\r\n\r\n35.829983 35.83_2550590.jpeg\r\n`\r\n\r\nCan you help?\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/1206/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/1206/timeline","performed_via_github_app":null,"state_reason":null}