{"url":"https://api.github.com/repos/google-research/google-research/issues/864","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/864/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/864/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/864/events","html_url":"https://github.com/google-research/google-research/issues/864","id":1036441019,"node_id":"I_kwDOCQmIhc49xtW7","number":864,"title":"realformer tf checkpoint convert to torch model","user":{"login":"yysirs","id":43271630,"node_id":"MDQ6VXNlcjQzMjcxNjMw","avatar_url":"https://avatars.githubusercontent.com/u/43271630?v=4","gravatar_id":"","url":"https://api.github.com/users/yysirs","html_url":"https://github.com/yysirs","followers_url":"https://api.github.com/users/yysirs/followers","following_url":"https://api.github.com/users/yysirs/following{/other_user}","gists_url":"https://api.github.com/users/yysirs/gists{/gist_id}","starred_url":"https://api.github.com/users/yysirs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yysirs/subscriptions","organizations_url":"https://api.github.com/users/yysirs/orgs","repos_url":"https://api.github.com/users/yysirs/repos","events_url":"https://api.github.com/users/yysirs/events{/privacy}","received_events_url":"https://api.github.com/users/yysirs/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2021-10-26T15:21:45Z","updated_at":"2022-01-05T11:25:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"hi, i want  convert realformer tf checkpoint to torch model, but get a error \r\n```\r\ntorch.nn.modules.module.ModuleAttributeError: 'LayerNorm' object has no attribute 'beta'\r\n```\r\nI think this is caused by changing the bert structure. \r\ni change convert code，but got a another error\r\n```\r\nAssertionError:\r\n(torch.Size([21128, 768]), (30522, 768))\r\n```\r\n\r\nconvert code:\r\n```\r\nfor name, array in zip(names, arrays):\r\n        name = name.split('/')\r\n        # adam_v and adam_m are variables used in AdamWeightDecayOptimizer to calculated m and v\r\n        # which are not required for using pretrained model\r\n        if name[-1] in [\"adam_v\", \"adam_m\"]:\r\n            print(\"Skipping {}\".format(\"/\".join(name)))\r\n            continue\r\n        pointer = model\r\n        for m_name in name:\r\n            if re.fullmatch(r'[A-Za-z]+_\\d+', m_name):\r\n                l = re.split(r'_(\\d+)', m_name)\r\n            else:\r\n                l = [m_name]\r\n            if l[0] == 'kernel':\r\n                pointer = getattr(pointer, 'weight')\r\n            elif l[0] == 'output_bias' or l[0] == 'beta':\r\n                pointer = getattr(pointer, 'bias')\r\n            elif l[0] == 'output_weights' or l[0] == 'gamma':\r\n                pointer = getattr(pointer, 'weight')\r\n            else:\r\n                pointer = getattr(pointer, l[0])\r\n            if len(l) >= 2:\r\n                num = int(l[1])\r\n                pointer = pointer[num]\r\n        if m_name[-11:] == '_embeddings':\r\n            pointer = getattr(pointer, 'weight')\r\n        elif m_name == 'kernel':\r\n            array = np.transpose(array)\r\n        try:\r\n            assert pointer.shape == array.shape # error\r\n        except AssertionError as e:\r\n            e.args += (pointer.shape, array.shape)\r\n            raise\r\n        print(\"Initialize PyTorch weight {}\".format(name))\r\n        pointer.data = torch.from_numpy(array)\r\n```\r\nWhether the vocabulary size is inconsistent？\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/864/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/864/timeline","performed_via_github_app":null,"state_reason":null}