[{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611256534","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611256534","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611256534,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTI1NjUzNA==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T00:09:14Z","updated_at":"2020-04-09T00:09:57Z","author_association":"CONTRIBUTOR","body":"Hi Abhipray,\r\n\r\nPlease let me know how do you test GRU model and configure GRU testing parameters?\r\n\r\nTo validate GRU model I run below scripts with env:\r\nPython 3.6.9\r\ntf.__version__ '2.1.0-rc1'\r\n\r\n// path where kws_streaming lib is located\r\nKWS_PATH=/tmp/kws_streaming\r\n\r\n// path where data2 are unpacked\r\nDATA_PATH=$KWS_PATH/data2\r\n\r\n// path where models2 are unpacked\r\nMODELS_PATH=$KWS_PATH/models2\r\n\r\npython -m kws_streaming.train.model_train_eval \\\r\n--data_url '' \\\r\n--data_dir $DATA_PATH/ \\\r\n--train_dir $MODELS_PATH/gru/ \\\r\n--mel_upper_edge_hertz 7000 \\\r\n--how_many_training_steps 10000,10000,10000 \\\r\n--learning_rate 0.0005,0.0001,0.00002 \\\r\n--window_size_ms 40.0 \\\r\n--window_stride_ms 20.0 \\\r\n--mel_num_bins 40 \\\r\n--dct_num_features 20 \\\r\n--resample 0.15 \\\r\n--alsologtostderr \\\r\n--train 0 \\\r\ngru \\\r\n--gru_units 400 \\\r\n--return_sequences 0 \\\r\n--dropout1 0.1 \\\r\n--units1 128,256 \\\r\n--act1 \"'linear','relu'\"\r\n\r\nIt should start prinitng something like:\r\n tflite test accuracy, non stream model = 94.53% 200 out of 4890\r\n tflite test accuracy, non stream model = 96.51% 400 out of 4890\r\n tflite test accuracy, non stream model = 95.67% 600 out of 4890\r\netc..\r\n\r\nAfter you run above script, please let me know if you see an error again?\r\nBefore running above script, I would also try\r\nexport CUDA_VISIBLE_DEVICES=-1\r\nto validate that issue is related to running TFLite on CPU or GPU\r\n\r\nThanks,\r\nOleg.\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611256534/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611272267","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611272267","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611272267,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTI3MjI2Nw==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T01:08:54Z","updated_at":"2020-04-09T01:08:54Z","author_association":"NONE","body":"Hi Oleg,\r\n\r\nI ran `python -m kws_streaming.models.utils_test` as it is and it fails with the error message I shared.  The default script tests dnn model. I got the test to pass by disabling eager execution:\r\n```\r\nif __name__ == '__main__':\r\n    # tf.compat.v1.enable_resource_variables()\r\n    disable_eager_execution()\r\n    tf.test.main()\r\n```\r\nI am using tf2.1 and python 3.7.1 and have no GPUs. \r\n\r\nI ran the same script you shared and see no errors output from running kws_streaming.train.model_train_eval. \r\n\r\nMy ultimate goal is to build a streaming GRU model with external state from this library and convert it to tflite, however these errors in convert_to_tflite() show up. \r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611272267/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611312897","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611312897","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611312897,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTMxMjg5Nw==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T03:50:41Z","updated_at":"2020-04-09T03:50:41Z","author_association":"CONTRIBUTOR","body":"I see, in my tests tfv2 was running with disabled eager mode by default, that is why I did not see this error. Goog catch! Tomorrow a patch (with disabled eager execution) will be submitted for all unit tests.\r\n\r\nIf you are building a key words detector or sounds detector with GRU model then you can try:\r\n\r\npython -m kws_streaming.train.model_train_eval\r\n--data_url ''\r\n--data_dir $DATA_PATH/\r\n--train_dir $MODELS_PATH/gru/\r\n--mel_upper_edge_hertz 7000\r\n--how_many_training_steps 400,400,400\r\n--learning_rate 0.0005,0.0001,0.00002\r\n--window_size_ms 40.0\r\n--window_stride_ms 20.0\r\n--mel_num_bins 40\r\n--dct_num_features 20\r\n--resample 0.15\r\n--alsologtostderr\r\n--train 1\r\ngru\r\n--gru_units 400\r\n--return_sequences 0\r\n--dropout1 0.1\r\n--units1 128,256\r\n--act1 \"'linear','relu'\"\r\n\r\nI reduced number of training iterations to 400,400,400 just for test purpose.\r\nThis script will:\r\n1. train GRU model and store it to /tf\r\n2. Convert TF non streaming model to TFLite and store it to /tflite_non_stream\r\n3. Convert TF non streaming model to TF streaming one (with external states) then convert it to TFLite and store it to tflite_stream_state_external\r\n4 It can also can do a TFLite model quantization (if you need to reduce model size and make it faster)\r\n\r\nThe third step is what you are interested.\r\n\r\n/Oleg.","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611312897/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611747469","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611747469","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611747469,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTc0NzQ2OQ==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T20:54:12Z","updated_at":"2020-04-09T20:54:12Z","author_association":"CONTRIBUTOR","body":"Hi Abhipray,\r\n\r\nAll unit tests are working.\r\nAlso I added more tests to demonstrate how gru model is converted to streaming with TFlite at [testToStreamInferenceModeTFandTFLite(self, model_name='gru'):](https://github.com/google-research/google-research/blob/master/kws_streaming/models/utils_test.py#L263). You can try any other models by changing model_name (some models can not be streamed: 'ds_cnn_stride', 'cnn_stride', 'att_rnn', 'att_mh_rnn').\r\nPlease confirm and close the issue.\r\n\r\nBest,\r\nOleg.","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611747469/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611801943","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611801943","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611801943,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTgwMTk0Mw==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T23:32:10Z","updated_at":"2020-04-09T23:32:10Z","author_association":"NONE","body":"Hi Oleg,\r\n\r\nThank you for taking a look at the unittests. They all pass for me now. Unfortunately, I still get errors when I work with the functions in kws_streaming outside the context of model_train_eval.py. \r\n\r\nHere is a colab showing the error from utils.model_to_tflite(). https://colab.research.google.com/drive/1tIreYkJ5mw1xDbmd7MHMtyRbH26GC4-H\r\n\r\nI had some other questions:\r\n- Why not use the tf2.0 tf.lite converter from_keras() method? https://www.tensorflow.org/api_docs/python/tf/lite/TFLiteConverter?version=nightly#from_keras_model\r\n- Why does your tf lite streaming implementation only support external states? Is there something inherently problematic with internal states and tf lite? I made a simple attempt at converting a keras model with internal state and ran into other converter issues like this one https://github.com/tensorflow/tensorflow/issues/37659. ","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611801943/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611824372","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611824372","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611824372,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTgyNDM3Mg==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T01:03:27Z","updated_at":"2020-04-10T01:03:27Z","author_association":"CONTRIBUTOR","body":"Please find comments below:\r\n\r\n_Why not use the tf2.0 tf.lite converter from_keras() method?_ \r\nIt will limit converter to Keras models only. I tried to keep it as generic as possible, so that you can build your model in pure TF or TF.Keras and converter still will work in both cases.\r\n\r\n_Why does your tf lite streaming implementation only support external states? Is there something inherently problematic with internal states and tf lite?_\r\nI implemented kws_streaming in a way that you can convert TF to TF streaming with internal states or to TF streaming with internal states. So both streaming modes are supported in this lib.\r\nBut TFlite does not support stateful layers now, that is why I test only streaming TFlite with external states (you can build special custom ops with states for TFlite, but I would avoid this path because you will have to customize every stateful layer - it does not scale). TFlite team is working on supporting internal states as general solution and as soon it is enabled, stateful streaming will work out of of the box with this lib.\r\n\r\nI tried your colab and it did not work for me (I do not cotroll all env there so it is hard to say why it does not work - it looks like there are some issues with installed TF version).\r\n\r\nPlease try attached jupyter notebok - it works ok (here all env set up is controlled by yourself):\r\n\r\ncd /tmp/kws_streaming\r\nvirtualenv --system-site-packages -p python3 ./venv3\r\nsource ./venv3/bin/activate\r\npip install tensorflow==2.1.0-rc1\r\njupyter notebook\r\n\r\n[Untitled.zip](https://github.com/google-research/google-research/files/4459308/Untitled.zip)\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611824372/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611843845","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611843845","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611843845,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTg0Mzg0NQ==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T02:20:00Z","updated_at":"2020-04-10T02:20:00Z","author_association":"NONE","body":"Hi Oleg,\r\n\r\nI suspect there might be some other setting on your machine that is different from mine and google colab (https://colab.research.google.com/drive/1tIreYkJ5mw1xDbmd7MHMtyRbH26GC4-H). I followed your steps with virtualenv on my local machine and google colab and get the same error:\r\n \r\n```WARNING:absl:There is no need to use Stream on time dim with size 1\r\nWARNING:root:FAILED to convert to mode NON_STREAM_INFERENCE, tflite: Fetch argument <tf.Variable 'gru/cell/kernel:0' shape=(20, 96) dtype=float32> cannot be interpreted as a Tensor. (Tensor Tensor(\"gru/cell/kernel/Read/ReadVariableOp:0\", shape=(20, 96), dtype=float32) is not an element of this graph.)```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611843845/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611849716","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611849716","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611849716,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTg0OTcxNg==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T02:43:57Z","updated_at":"2020-04-10T02:43:57Z","author_association":"NONE","body":"Ah I found the issue: the model needs to be instantiated after resetting the graph. Thanks for your help, Oleg!","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611849716/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"id":3220598986,"node_id":"MDExOkNsb3NlZEV2ZW50MzIyMDU5ODk4Ng==","url":"https://api.github.com/repos/google-research/google-research/issues/events/3220598986","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-04-10T02:44:09Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611851623","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611851623","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611851623,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTg1MTYyMw==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T02:51:46Z","updated_at":"2020-04-10T02:51:46Z","author_association":"CONTRIBUTOR","body":"Good point :)\r\nJust in case here is a working [colab](https://colab.research.google.com/drive/1withkJedDAZtcgTvulVeyLUPnzxpJLnf)","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611851623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"id":3220737322,"node_id":"MDEzOlJlb3BlbmVkRXZlbnQzMjIwNzM3MzIy","url":"https://api.github.com/repos/google-research/google-research/issues/events/3220737322","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"event":"reopened","commit_id":null,"commit_url":null,"created_at":"2020-04-10T04:28:29Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611873551","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611873551","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611873551,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTg3MzU1MQ==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T04:35:20Z","updated_at":"2020-04-10T04:35:20Z","author_association":"NONE","body":"I found another issue, possible memory-related with the tflite conversion. Here is an example GRU model I am working with:\r\n![image](https://user-images.githubusercontent.com/1261472/78962535-38d89080-7aa9-11ea-8c67-105c7f70a1cf.png)\r\nIf input shape is [1,1,20] and the model has three GRU layers with 2 units, the keras model.predict() and tf.lite interpreter outputs are the same. If however, I change the input shape to [1,1,40], I get NaN output from tflite interpreter. If I leave the input shape as [1,1,40] but use 2 layers with 2 nodes, I get an incorrect output (sometimes 0, 1 or NaN) with the tflite interpreter. \r\n\r\nHere is a colab showing the issue: https://colab.research.google.com/drive/1QC73kZgx6yG7af10-RtWIjrWWLFjOcXc","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611873551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611891387","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611891387","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611891387,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTg5MTM4Nw==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T05:58:14Z","updated_at":"2020-04-10T06:18:49Z","author_association":"CONTRIBUTOR","body":"I am not sure about what are you trying to achieve in your colab.\r\nYou do not run keras model in streaming mode, so it is not correct to compare tf non streaming with TFLite streaming models - the way you compare them.\r\n\r\nIf you just need to convert your model to TFLite then you should specify \r\nmode=Modes.NON_STREAM_INFERENCE\r\nas it is done in this [colab](https://colab.research.google.com/drive/1zbnQjkOYfyLfGVal618t0GjlbCXtYuDL#scrollTo=IYeAWXP8incN) - the output should be correct on any feature size and model depth.\r\n\r\nAlso there is no need to use TimeDistributed wrapper - Dense layer is applied on last dimension in time any way, as it is show in [dense_test](https://github.com/google-research/google-research/blob/master/kws_streaming/layers/dense_test.py)\r\n\r\n**Please close this issue and create another one**, because the last one is not related to kws_streaming.models.utils_test failure and can be confusing for other people (it is a good practice not to mix different issues in one ticket).\r\nIn the new issue, I will add another colab which explain the difference between non streaming and streaming models in TF and TFLite with gru example.\r\nThank you for exploring this lib, I appreciate your feedbacks!","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611891387/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611902685","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611902685","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611902685,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTkwMjY4NQ==","user":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T06:40:48Z","updated_at":"2020-04-10T06:40:48Z","author_association":"NONE","body":"Thanks for the pointers! My problem was that I was not initializing the state inputs to zero before running invoke.","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611902685/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false}},{"id":3220940094,"node_id":"MDExOkNsb3NlZEV2ZW50MzIyMDk0MDA5NA==","url":"https://api.github.com/repos/google-research/google-research/issues/events/3220940094","actor":{"login":"Abhipray","id":1261472,"node_id":"MDQ6VXNlcjEyNjE0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1261472?v=4","gravatar_id":"","url":"https://api.github.com/users/Abhipray","html_url":"https://github.com/Abhipray","followers_url":"https://api.github.com/users/Abhipray/followers","following_url":"https://api.github.com/users/Abhipray/following{/other_user}","gists_url":"https://api.github.com/users/Abhipray/gists{/gist_id}","starred_url":"https://api.github.com/users/Abhipray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Abhipray/subscriptions","organizations_url":"https://api.github.com/users/Abhipray/orgs","repos_url":"https://api.github.com/users/Abhipray/repos","events_url":"https://api.github.com/users/Abhipray/events{/privacy}","received_events_url":"https://api.github.com/users/Abhipray/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-04-10T06:40:48Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611906828","html_url":"https://github.com/google-research/google-research/issues/241#issuecomment-611906828","issue_url":"https://api.github.com/repos/google-research/google-research/issues/241","id":611906828,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTkwNjgyOA==","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T06:55:36Z","updated_at":"2020-04-10T07:00:56Z","author_association":"CONTRIBUTOR","body":"Here is a [colab](https://colab.research.google.com/drive/1wASJnQxpu2bEVOIo4FpgF778edo0wOG8#scrollTo=NcIzzCADklYm) with example of running: \r\nTF in non streaming\r\nTFlite non streaming\r\nTF streaming with internal state\r\nTF streaming with external state\r\nTFLite streaming with external state\r\n\r\nPlease have a look at graphs of streaming vs non streaming models in above colab.\r\nIt demonstrates a difference between them: streaming with external state has additional inputs for states which you have to intialize \r\n[inference.zip](https://github.com/google-research/google-research/files/4460251/inference.zip)\r\nand control during inference.\r\nYou already figured out your issue :), so hope above colab will be helpful for the next step: running TFLite model in streaming mode.\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/611906828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}}]