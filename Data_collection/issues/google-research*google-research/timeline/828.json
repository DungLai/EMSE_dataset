[{"id":5354509136,"node_id":"RTE_lADOCQmIhc47-L6yzwAAAAE_J1NQ","url":"https://api.github.com/repos/google-research/google-research/issues/events/5354509136","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2021-09-24T08:12:46Z","rename":{"from":"Error about converting stream_state_internal KWS model to tflite","to":"Error about converting stream_state_internal KWS model to tflite with micro preprocess"},"performed_via_github_app":null},{"id":5354686033,"node_id":"RTE_lADOCQmIhc47-L6yzwAAAAE_KgZR","url":"https://api.github.com/repos/google-research/google-research/issues/events/5354686033","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2021-09-24T08:46:26Z","rename":{"from":"Error about converting stream_state_internal KWS model to tflite with micro preprocess","to":"[kws_streaming] Error about converting stream_state_internal KWS model to tflite with micro preprocess"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/926544874","html_url":"https://github.com/google-research/google-research/issues/828#issuecomment-926544874","issue_url":"https://api.github.com/repos/google-research/google-research/issues/828","id":926544874,"node_id":"IC_kwDOCQmIhc43OfPq","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-24T11:14:24Z","updated_at":"2021-09-24T11:14:24Z","author_association":"NONE","body":"One more comments. I also tried 'raw' preprocess, the tflite can be generated successfully. ","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/926544874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/926856250","html_url":"https://github.com/google-research/google-research/issues/828#issuecomment-926856250","issue_url":"https://api.github.com/repos/google-research/google-research/issues/828","id":926856250,"node_id":"IC_kwDOCQmIhc43PrQ6","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-09-24T19:02:36Z","updated_at":"2021-09-24T22:39:06Z","author_association":"CONTRIBUTOR","body":"Here is a [test](https://github.com/google-research/google-research/blob/master/kws_streaming/models/utils_test.py#L136) validating that conversion works with any frontend: it shows that [model with external state](https://github.com/google-research/google-research/blob/master/kws_streaming/models/utils_test.py#L177) can be converted. Frontend type should not matter.\r\n\r\nStreaming with internal state is still in dev mode in tflite, but streaming with external state works ok. If you are interested in converting your model to streaming tflite with internal state, then you should use this [example](https://github.com/google-research/google-research/blob/master/kws_streaming/models/ds_tc_resnet_eager_test.py#L29). This feature was added recently, it works only in **eager mode**. You can use above example for conversion to streaming tflite with internal state, but it has to be executed separately from kws_streaming (kws_streaming runs in session mode for backward compatibility with tf v1 and streaming with external state). Streaming with internal state also has some issues with quantization and we are working on it. Please confirm that you use tf-nightly, so that all latest features are supported.\r\n\r\n[ds_cnn_stream.zip](https://github.com/google-research/google-research/files/7223822/ds_cnn_stream.zip) is not enought to reproduce your issues, I also need to see how you convert the model in \"run_convert.py\".\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/926856250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/927241466","html_url":"https://github.com/google-research/google-research/issues/828#issuecomment-927241466","issue_url":"https://api.github.com/repos/google-research/google-research/issues/828","id":927241466,"node_id":"IC_kwDOCQmIhc43RJT6","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-26T06:14:43Z","updated_at":"2021-09-26T07:17:34Z","author_association":"NONE","body":"@rybakov . Thanks for your help. The run_convert.py is below. \r\n\r\n\r\nimport tensorflow as tf\r\nfrom kws_streaming.layers import stream\r\nconverter = tf.lite.TFLiteConverter.from_saved_model( 'models1/ds_cnn_stream1/stream_state_internal')\r\nconverter.experimental_enable_resource_variables = True\r\nconverter.target_spec.supported_ops = [\r\n      tf.lite.OpsSet.TFLITE_BUILTINS, tf.lite.OpsSet.SELECT_TF_OPS\r\n  ]\r\nconverter.allow_custom_ops = True\r\nconverter.optimizations = [tf.lite.Optimize.DEFAULT]\r\n\r\ntfmodel = converter.convert()\r\nopen (\"model.tflite\" , \"wb\") .write(tfmodel)\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/927241466/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"id":5360764709,"node_id":"MEE_lADOCQmIhc47-L6yzwAAAAE_hscl","url":"https://api.github.com/repos/google-research/google-research/issues/events/5360764709","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-26T06:14:43Z","performed_via_github_app":null},{"id":5360764710,"node_id":"SE_lADOCQmIhc47-L6yzwAAAAE_hscm","url":"https://api.github.com/repos/google-research/google-research/issues/events/5360764710","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-26T06:14:44Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/927245372","html_url":"https://github.com/google-research/google-research/issues/828#issuecomment-927245372","issue_url":"https://api.github.com/repos/google-research/google-research/issues/828","id":927245372,"node_id":"IC_kwDOCQmIhc43RKQ8","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-26T06:50:36Z","updated_at":"2021-09-26T06:50:36Z","author_association":"NONE","body":"Hi,  @rybakov \r\nThanks again. The problem is solved with tf-night(2.7.0.dev20210824). The version tensorflow2.3 had this issue. ","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/927245372/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"id":5360804861,"node_id":"MEE_lADOCQmIhc47-L6yzwAAAAE_h2P9","url":"https://api.github.com/repos/google-research/google-research/issues/events/5360804861","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-26T06:50:36Z","performed_via_github_app":null},{"id":5360804863,"node_id":"SE_lADOCQmIhc47-L6yzwAAAAE_h2P_","url":"https://api.github.com/repos/google-research/google-research/issues/events/5360804863","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-26T06:50:36Z","performed_via_github_app":null},{"id":5483447287,"node_id":"CE_lADOCQmIhc47-L6yzwAAAAFG1sP3","url":"https://api.github.com/repos/google-research/google-research/issues/events/5483447287","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-10-19T08:10:22Z","state_reason":null,"performed_via_github_app":null}]