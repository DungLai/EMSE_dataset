[{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929049722","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-929049722","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":929049722,"node_id":"IC_kwDOCQmIhc43YCx6","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-28T10:11:44Z","updated_at":"2021-09-28T10:11:44Z","author_association":"NONE","body":"I used latest tf-nightly. ","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929049722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929509679","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-929509679","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":929509679,"node_id":"IC_kwDOCQmIhc43ZzEv","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-09-28T18:19:40Z","updated_at":"2021-09-28T19:07:06Z","author_association":"CONTRIBUTOR","body":"@wenjingyang I do not know what are you going to achieve with your coversion parameters\r\nIf you follow [example](https://github.com/google-research/google-research/blob/master/kws_streaming/models/cnn_test.py#L68) and set converter parameters:\r\n```\r\n  converter.inference_type = tf.int8\r\n  converter.experimental_new_quantizer = True\r\n  converter.experimental_enable_resource_variables = True\r\n  converter.representative_dataset = representative_dataset\r\n\r\n  # this will enable audio_spectrogram and mfcc in TFLite\r\n  converter.target_spec.supported_ops = [\r\n      tf.lite.OpsSet.TFLITE_BUILTINS, tf.lite.OpsSet.SELECT_TF_OPS\r\n  ]\r\n  converter.allow_custom_ops = True\r\n  converter.inference_input_type = tf.int8\r\n  converter.inference_output_type = tf.int8\r\n  converter.optimizations = [tf.lite.Optimize.DEFAULT]\r\n```\r\nthen you will get a fully quantized model with quantized inputs and outputs. All conv ops will use quantized version.\r\n\r\nIf you set parameters:\r\n```\r\n  converter.inference_type = tf.int8\r\n  converter.experimental_new_quantizer = True\r\n  converter.experimental_enable_resource_variables = True\r\n  converter.representative_dataset = representative_dataset\r\n\r\n  # this will enable audio_spectrogram and mfcc in TFLite\r\n  converter.target_spec.supported_ops = [\r\n      tf.lite.OpsSet.TFLITE_BUILTINS, tf.lite.OpsSet.SELECT_TF_OPS\r\n  ]\r\n  converter.allow_custom_ops = True\r\n  converter.optimizations = [tf.lite.Optimize.DEFAULT]\r\n```\r\nthen your model will be partially quantized: all inputs and outputs will be float including input/output states. All inputs/outputs will be quantized and de-quantized inside of the model. All conv ops will use quantized version.\r\n\r\nPlease let me know what way do you plan to quantize your model. \r\nI would suggest to use the second option, as the easy one (it also works well out of the box).\r\n\r\nIf you create an issue at google-research without mentioning the owner of the project, then the owner will not be notified and there is no guarantee that the issue will be addressed. I would encourage you to mention the project owner in an issue, for example in case of kws_streaming you can use @rybakov, this way I will get notification and will not miss it.\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929509679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"id":5375773798,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFAa8xm","url":"https://api.github.com/repos/google-research/google-research/issues/events/5375773798","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-28T18:19:40Z","performed_via_github_app":null},{"id":5375773804,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFAa8xs","url":"https://api.github.com/repos/google-research/google-research/issues/events/5375773804","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-28T18:19:40Z","performed_via_github_app":null},{"id":5375773808,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFAa8xw","url":"https://api.github.com/repos/google-research/google-research/issues/events/5375773808","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-28T18:19:40Z","performed_via_github_app":null},{"id":5375773811,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFAa8xz","url":"https://api.github.com/repos/google-research/google-research/issues/events/5375773811","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-28T18:19:40Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929779497","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-929779497","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":929779497,"node_id":"IC_kwDOCQmIhc43a08p","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-29T02:47:57Z","updated_at":"2021-09-29T02:47:57Z","author_association":"NONE","body":"@rybakov Thanks for your help. \r\nMy target is to get a fully quantized model. \r\nI have tried the [example ](https://github.com/google-research/google-research/blob/master/kws_streaming/models/cnn_test.py) and it works fine. But I can't get any quantization on my [ds-cnn model](https://github.com/google-research/google-research/files/7242640/stream_state_external.zip). \r\n I checked the code and found the layer should be quantized  when [cnn model](https://github.com/google-research/google-research/blob/master/kws_streaming/models/cnn.py) is built. So my understanding is that I should use quantized layer when build ds-cnn model. Right?   \r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929779497/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"id":5377673579,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFAiMlr","url":"https://api.github.com/repos/google-research/google-research/issues/events/5377673579","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-29T02:47:57Z","performed_via_github_app":null},{"id":5377673582,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFAiMlu","url":"https://api.github.com/repos/google-research/google-research/issues/events/5377673582","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-29T02:47:57Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929798029","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-929798029","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":929798029,"node_id":"IC_kwDOCQmIhc43a5eN","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-09-29T03:28:47Z","updated_at":"2021-09-29T03:28:47Z","author_association":"CONTRIBUTOR","body":"@wenjingyang quantize.quantize_layer is used for quantization aware training and then it will be used by post-training quantization in tflite.\r\nSo, if you are interested in post-training quantization only, then you do not need quantize.quantize_layer with quantization aware training.\r\nPlease let me know what error you observe and how to reproduce it.\r\n\r\nI would also suggest to try [ds_tc_resnet model](https://github.com/google-research/google-research/blob/master/kws_streaming/models/ds_tc_resnet.py), with training [example](https://github.com/google-research/google-research/blob/624e3196b6fbfa429480027606387ae682b2a207/kws_streaming/experiments/kws_experiments_12_labels.md#ds_tc_resnet---based-on-matchboxnet). It can be faster and more accurate than ds-cnn.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929798029/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"id":5377788931,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFAiowD","url":"https://api.github.com/repos/google-research/google-research/issues/events/5377788931","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-29T03:28:47Z","performed_via_github_app":null},{"id":5377788933,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFAiowF","url":"https://api.github.com/repos/google-research/google-research/issues/events/5377788933","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-29T03:28:48Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929842404","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-929842404","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":929842404,"node_id":"IC_kwDOCQmIhc43bETk","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-09-29T05:13:53Z","updated_at":"2021-09-29T05:30:11Z","author_association":"NONE","body":"@rybakov  Thanks. I'd like to use post-quantization now. \r\nI generated ds_tc_resnet with your example (--preprocess micro). \r\nMy ds_tc_resnet folder:  [ds_tc_resnet](https://github.com/google-research/google-research/files/7248950/ds_tc_resnet.zip)\r\nrepresentative_dataset: [feature.npz](https://github.com/google-research/google-research/files/7242587/feature.zip)\r\n\r\nI changed the [train/test.py](https://github.com/google-research/google-research/blob/master/kws_streaming/train/test.py) with adding \"representative_dataset\".  Updated the fully quantized parameters in [models/utils.py](https://github.com/google-research/google-research/blob/master/kws_streaming/models/utils.py).   I uploaded my test.py and untils.py as [test.txt](https://github.com/google-research/google-research/files/7248973/test.txt) and [utils.txt](https://github.com/google-research/google-research/files/7249031/utils.txt)\r\n\r\nThe issue is: stream_state_external.tflite in quantize_opt_for_size_tflite_stream_state_external isn't be quantized at all. \r\n\r\nYou can reproduce this issue when you run the script below. I have highlighted the difference with your script. \r\n\r\n$CMD_TRAIN \\\r\n--data_url '' \\\r\n--data_dir $DATA_PATH/ \\\r\n--train_dir $MODELS_PATH/ds_tc_resnet/ \\\r\n--mel_upper_edge_hertz 7600 \\\r\n--how_many_training_steps 4,4,2,2 \\\r\n--learning_rate 0.001,0.0005,0.0002,0.0001 \\\r\n--window_size_ms 30.0 \\\r\n--window_stride_ms 10.0 \\\r\n--mel_num_bins 80 \\\r\n--dct_num_features 40 \\\r\n--resample 0.15 \\\r\n--alsologtostderr \\\r\n**--train 0** \\\r\n--use_spec_augment 1 \\\r\n--time_masks_number 2 \\\r\n--time_mask_max_size 25 \\\r\n--frequency_masks_number 2 \\\r\n--frequency_mask_max_size 7 \\\r\n--pick_deterministically 1 \\\r\n**--preprocess micro** \\\r\nds_tc_resnet \r\n--activation 'relu' \\\r\n--dropout 0.0 \\\r\n--ds_filters '128, 64, 64, 64, 128, 128' \\\r\n--ds_repeat '1, 1, 1, 1, 1, 1' \\\r\n--ds_residual '0, 1, 1, 1, 0, 0' \\\r\n--ds_kernel_size '11, 13, 15, 17, 29, 1' \\\r\n--ds_stride '1, 1, 1, 1, 1, 1' \\\r\n--ds_dilation '1, 1, 1, 1, 2, 1'\r\n\r\n\r\nThe text.py difference.  \r\n![image](https://user-images.githubusercontent.com/4407779/135206401-4ac1101f-eece-417b-bfb7-c29b5caab81d.png)\r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/929842404/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"id":5378076249,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFAju5Z","url":"https://api.github.com/repos/google-research/google-research/issues/events/5378076249","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-29T05:13:53Z","performed_via_github_app":null},{"id":5378076252,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFAju5c","url":"https://api.github.com/repos/google-research/google-research/issues/events/5378076252","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-29T05:13:53Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/945274694","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-945274694","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":945274694,"node_id":"IC_kwDOCQmIhc44V79G","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-10-18T01:36:16Z","updated_at":"2021-10-18T01:36:16Z","author_association":"CONTRIBUTOR","body":"@wenjingyang you are using the same format of representative data as in [cnn_test](https://github.com/google-research/google-research/blob/master/kws_streaming/models/cnn_test.py), but your ds_tc_resnet model has different number of input parameters, so you need to create calibration data for all inputs of your model. \r\nI am working with TFLite team on enabling quantization of the models with internal states, but it can take some time.","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/945274694/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"id":5475099521,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFGV2OB","url":"https://api.github.com/repos/google-research/google-research/issues/events/5475099521","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-10-18T01:36:16Z","performed_via_github_app":null},{"id":5475099523,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFGV2OD","url":"https://api.github.com/repos/google-research/google-research/issues/events/5475099523","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-10-18T01:36:16Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/946467249","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-946467249","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":946467249,"node_id":"IC_kwDOCQmIhc44afGx","user":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"created_at":"2021-10-19T08:10:00Z","updated_at":"2021-10-19T08:10:00Z","author_association":"NONE","body":"@rybakov Thanks a lot. This problem is solved. \r\nBTW I found the tflite model with  post-quantization can't match the h5 model output  if only one feature is used for calibration.  Quantize-aware training is better to get a more accuracy quantized model.\r\n\r\n **tflite model with  post-quantization vs h5 model** \r\nNot equal to tolerance rtol=1e-06, atol=0.001\r\nMismatched value: a is different from b.\r\nnot close where = (array([0, 0]), array([0, 1]))\r\nnot close lhs = [0.39453125 0.60546875]\r\nnot close rhs = [0.21052642 0.78947353]\r\nnot close dif = [0.18400483 0.18400478]\r\nnot close tol = [0.00100021 0.00100079]\r\ndtype = float32, shape = (1, 2)\r\nMismatched elements: 2 / 2 (100%)\r\nMax absolute difference: 0.18400483\r\nMax relative difference: 0.8740225\r\nx: array([[0.394531, 0.605469]], dtype=float32)\r\ny: array([[0.210526, 0.789474]], dtype=float32)","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/946467249/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false}},{"id":5483444809,"node_id":"MEE_lADOCQmIhc48K8KnzwAAAAFG1rpJ","url":"https://api.github.com/repos/google-research/google-research/issues/events/5483444809","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-10-19T08:10:01Z","performed_via_github_app":null},{"id":5483444813,"node_id":"SE_lADOCQmIhc48K8KnzwAAAAFG1rpN","url":"https://api.github.com/repos/google-research/google-research/issues/events/5483444813","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-10-19T08:10:01Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/946956561","html_url":"https://github.com/google-research/google-research/issues/836#issuecomment-946956561","issue_url":"https://api.github.com/repos/google-research/google-research/issues/836","id":946956561,"node_id":"IC_kwDOCQmIhc44cWkR","user":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-10-19T17:45:57Z","updated_at":"2021-10-19T17:45:57Z","author_association":"CONTRIBUTOR","body":"I agree that quantize-aware training should be a better option. You can do quantization aware training with current version too, an example is shown in [cnn](https://github.com/google-research/google-research/blob/master/kws_streaming/models/cnn.py).","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/comments/946956561/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false}},{"id":5488867608,"node_id":"CE_lADOCQmIhc48K8KnzwAAAAFHKXkY","url":"https://api.github.com/repos/google-research/google-research/issues/events/5488867608","actor":{"login":"wenjingyang","id":4407779,"node_id":"MDQ6VXNlcjQ0MDc3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/4407779?v=4","gravatar_id":"","url":"https://api.github.com/users/wenjingyang","html_url":"https://github.com/wenjingyang","followers_url":"https://api.github.com/users/wenjingyang/followers","following_url":"https://api.github.com/users/wenjingyang/following{/other_user}","gists_url":"https://api.github.com/users/wenjingyang/gists{/gist_id}","starred_url":"https://api.github.com/users/wenjingyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wenjingyang/subscriptions","organizations_url":"https://api.github.com/users/wenjingyang/orgs","repos_url":"https://api.github.com/users/wenjingyang/repos","events_url":"https://api.github.com/users/wenjingyang/events{/privacy}","received_events_url":"https://api.github.com/users/wenjingyang/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-10-20T02:17:44Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"rybakov","id":6813603,"node_id":"MDQ6VXNlcjY4MTM2MDM=","avatar_url":"https://avatars.githubusercontent.com/u/6813603?v=4","gravatar_id":"","url":"https://api.github.com/users/rybakov","html_url":"https://github.com/rybakov","followers_url":"https://api.github.com/users/rybakov/followers","following_url":"https://api.github.com/users/rybakov/following{/other_user}","gists_url":"https://api.github.com/users/rybakov/gists{/gist_id}","starred_url":"https://api.github.com/users/rybakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rybakov/subscriptions","organizations_url":"https://api.github.com/users/rybakov/orgs","repos_url":"https://api.github.com/users/rybakov/repos","events_url":"https://api.github.com/users/rybakov/events{/privacy}","received_events_url":"https://api.github.com/users/rybakov/received_events","type":"User","site_admin":false},"created_at":"2021-12-01T02:49:20Z","updated_at":"2021-12-01T02:49:20Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/google-research/google-research/issues/809","repository_url":"https://api.github.com/repos/google-research/google-research","labels_url":"https://api.github.com/repos/google-research/google-research/issues/809/labels{/name}","comments_url":"https://api.github.com/repos/google-research/google-research/issues/809/comments","events_url":"https://api.github.com/repos/google-research/google-research/issues/809/events","html_url":"https://github.com/google-research/google-research/issues/809","id":987923534,"node_id":"MDU6SXNzdWU5ODc5MjM1MzQ=","number":809,"title":"error training svdf_resnet on custom data","user":{"login":"srewai","id":32038717,"node_id":"MDQ6VXNlcjMyMDM4NzE3","avatar_url":"https://avatars.githubusercontent.com/u/32038717?v=4","gravatar_id":"","url":"https://api.github.com/users/srewai","html_url":"https://github.com/srewai","followers_url":"https://api.github.com/users/srewai/followers","following_url":"https://api.github.com/users/srewai/following{/other_user}","gists_url":"https://api.github.com/users/srewai/gists{/gist_id}","starred_url":"https://api.github.com/users/srewai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srewai/subscriptions","organizations_url":"https://api.github.com/users/srewai/orgs","repos_url":"https://api.github.com/users/srewai/repos","events_url":"https://api.github.com/users/srewai/events{/privacy}","received_events_url":"https://api.github.com/users/srewai/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":31,"created_at":"2021-09-03T16:13:09Z","updated_at":"2022-01-06T09:59:00Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"repository":{"id":151619717,"node_id":"MDEwOlJlcG9zaXRvcnkxNTE2MTk3MTc=","name":"google-research","full_name":"google-research/google-research","private":false,"owner":{"login":"google-research","id":43830688,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQzODMwNjg4","avatar_url":"https://avatars.githubusercontent.com/u/43830688?v=4","gravatar_id":"","url":"https://api.github.com/users/google-research","html_url":"https://github.com/google-research","followers_url":"https://api.github.com/users/google-research/followers","following_url":"https://api.github.com/users/google-research/following{/other_user}","gists_url":"https://api.github.com/users/google-research/gists{/gist_id}","starred_url":"https://api.github.com/users/google-research/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/google-research/subscriptions","organizations_url":"https://api.github.com/users/google-research/orgs","repos_url":"https://api.github.com/users/google-research/repos","events_url":"https://api.github.com/users/google-research/events{/privacy}","received_events_url":"https://api.github.com/users/google-research/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/google-research/google-research","description":"Google Research","fork":false,"url":"https://api.github.com/repos/google-research/google-research","forks_url":"https://api.github.com/repos/google-research/google-research/forks","keys_url":"https://api.github.com/repos/google-research/google-research/keys{/key_id}","collaborators_url":"https://api.github.com/repos/google-research/google-research/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/google-research/google-research/teams","hooks_url":"https://api.github.com/repos/google-research/google-research/hooks","issue_events_url":"https://api.github.com/repos/google-research/google-research/issues/events{/number}","events_url":"https://api.github.com/repos/google-research/google-research/events","assignees_url":"https://api.github.com/repos/google-research/google-research/assignees{/user}","branches_url":"https://api.github.com/repos/google-research/google-research/branches{/branch}","tags_url":"https://api.github.com/repos/google-research/google-research/tags","blobs_url":"https://api.github.com/repos/google-research/google-research/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/google-research/google-research/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/google-research/google-research/git/refs{/sha}","trees_url":"https://api.github.com/repos/google-research/google-research/git/trees{/sha}","statuses_url":"https://api.github.com/repos/google-research/google-research/statuses/{sha}","languages_url":"https://api.github.com/repos/google-research/google-research/languages","stargazers_url":"https://api.github.com/repos/google-research/google-research/stargazers","contributors_url":"https://api.github.com/repos/google-research/google-research/contributors","subscribers_url":"https://api.github.com/repos/google-research/google-research/subscribers","subscription_url":"https://api.github.com/repos/google-research/google-research/subscription","commits_url":"https://api.github.com/repos/google-research/google-research/commits{/sha}","git_commits_url":"https://api.github.com/repos/google-research/google-research/git/commits{/sha}","comments_url":"https://api.github.com/repos/google-research/google-research/comments{/number}","issue_comment_url":"https://api.github.com/repos/google-research/google-research/issues/comments{/number}","contents_url":"https://api.github.com/repos/google-research/google-research/contents/{+path}","compare_url":"https://api.github.com/repos/google-research/google-research/compare/{base}...{head}","merges_url":"https://api.github.com/repos/google-research/google-research/merges","archive_url":"https://api.github.com/repos/google-research/google-research/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/google-research/google-research/downloads","issues_url":"https://api.github.com/repos/google-research/google-research/issues{/number}","pulls_url":"https://api.github.com/repos/google-research/google-research/pulls{/number}","milestones_url":"https://api.github.com/repos/google-research/google-research/milestones{/number}","notifications_url":"https://api.github.com/repos/google-research/google-research/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/google-research/google-research/labels{/name}","releases_url":"https://api.github.com/repos/google-research/google-research/releases{/id}","deployments_url":"https://api.github.com/repos/google-research/google-research/deployments","created_at":"2018-10-04T18:42:48Z","updated_at":"2023-01-20T00:41:48Z","pushed_at":"2023-01-19T23:45:46Z","git_url":"git://github.com/google-research/google-research.git","ssh_url":"git@github.com:google-research/google-research.git","clone_url":"https://github.com/google-research/google-research.git","svn_url":"https://github.com/google-research/google-research","homepage":"https://research.google","size":371210,"stargazers_count":26828,"watchers_count":26828,"language":"Jupyter Notebook","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":6663,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":904,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["ai","machine-learning","research"],"visibility":"public","forks":6663,"open_issues":904,"watchers":26828,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Hi @rybakov , \r\n\r\nI am trying to follow the steps for svdf_resnet [here for quantization](https://github.com/google-research/google-research/blob/master/kws_streaming/experiments/kws_experiments_30k_12_labels.md) with the below command on custom data. \r\n\r\nBelow is the command used:\r\n```\r\n$CMD_TRAIN \\\r\n--wanted_words 'srewai' \\\r\n--data_url '' \\\r\n--data_dir $DATA_PATH/ \\\r\n--train_dir $MODELS_PATH/svdf_resnet/ \\\r\n--mel_upper_edge_hertz 7600 \\\r\n--how_many_training_steps 20000,20000,20000,20000 \\\r\n--learning_rate 0.001,0.0005,0.0001,0.00002 \\\r\n--window_size_ms 40.0 \\\r\n--window_stride_ms 20.0 \\\r\n--mel_num_bins 80 \\\r\n--dct_num_features 40 \\\r\n--resample 0.15 \\\r\n--time_shift_ms 100 \\\r\n--feature_type 'mfcc_op' \\\r\n--fft_magnitude_squared 1 \\\r\n--preprocess 'raw' \\\r\n--train 1 \\\r\n--lr_schedule 'exp' \\\r\nsvdf_resnet \\\r\n--block1_memory_size '7' \\\r\n--block2_memory_size '7' \\\r\n--block3_memory_size '11,11' \\\r\n--block1_units1 '32' \\\r\n--block2_units1 '50' \\\r\n--block3_units1 '50,128' \\\r\n--blocks_pool '2,2,1' \\\r\n--use_batch_norm 1 \\\r\n--bn_scale 1 \\\r\n--activation 'relu' \\\r\n--svdf_dropout 0.0 \\\r\n--svdf_pad 1 \\\r\n--svdf_use_bias 0 \\\r\n--dropout1 0.0 \\\r\n--units2 '64' \\\r\n--flatten 0\r\n```\r\nThe model summary looks like this.\r\n```\r\nInstructions for updating:\r\nColocations handled automatically by placer.\r\nW0903 18:00:45.072718 140373190989632 deprecation.py:347] From /srewai-venv/lib/python3.6/site-packages/keras/layers/normalization/batch_normalization.py:532: _colocate_with (from tensorflow.python.framework.ops) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nColocations handled automatically by placer.\r\nModel: \"model\"\r\n__________________________________________________________________________________________________\r\nLayer (type)                    Output Shape         Param #     Connected to                     \r\n==================================================================================================\r\ninput_1 (InputLayer)            [(100, 16000)]       0           []                               \r\n__________________________________________________________________________________________________\r\nspeech_features (SpeechFeature  (100, 49, 40)        0           ['input_1[0][0]']                \r\ns)                                                                                                \r\n__________________________________________________________________________________________________\r\ndense_1 (Dense)                 (100, 49, 32)        1280        ['speech_features[0][0]']        \r\n__________________________________________________________________________________________________\r\nsvdf_1_0 (Svdf)                 (100, 49, 32)        1632        ['speech_features[0][0]']        \r\n__________________________________________________________________________________________________\r\nbatch_normalization_1 (BatchNo  (100, 49, 32)        128         ['dense_1[0][0]']                \r\nrmalization)                                                                                      \r\n__________________________________________________________________________________________________\r\nadd (Add)                       (100, 49, 32)        0           ['svdf_1_0[0][0]',               \r\n                                                                  'batch_normalization_1[0][0]']  \r\n__________________________________________________________________________________________________\r\nactivation (Activation)         (100, 49, 32)        0           ['add[0][0]']                    \r\n__________________________________________________________________________________________________\r\nmax_pooling1d (MaxPooling1D)    (100, 24, 32)        0           ['activation[0][0]']             \r\n__________________________________________________________________________________________________\r\ndense_3 (Dense)                 (100, 24, 50)        1600        ['max_pooling1d[0][0]']          \r\n__________________________________________________________________________________________________\r\nsvdf_2_0 (Svdf)                 (100, 24, 50)        2150        ['max_pooling1d[0][0]']          \r\n__________________________________________________________________________________________________\r\nbatch_normalization_3 (BatchNo  (100, 24, 50)        200         ['dense_3[0][0]']                \r\nrmalization)                                                                                      \r\n__________________________________________________________________________________________________\r\nadd_1 (Add)                     (100, 24, 50)        0           ['svdf_2_0[0][0]',               \r\n                                                                  'batch_normalization_3[0][0]']  \r\n__________________________________________________________________________________________________\r\nactivation_1 (Activation)       (100, 24, 50)        0           ['add_1[0][0]']                  \r\n__________________________________________________________________________________________________\r\nmax_pooling1d_1 (MaxPooling1D)  (100, 11, 50)        0           ['activation_1[0][0]']           \r\n__________________________________________________________________________________________________\r\nsvdf_3_0 (Svdf)                 (100, 11, 50)        3250        ['max_pooling1d_1[0][0]']        \r\n__________________________________________________________________________________________________\r\ndense_6 (Dense)                 (100, 11, 128)       6400        ['max_pooling1d_1[0][0]']        \r\n__________________________________________________________________________________________________\r\nsvdf_3_1 (Svdf)                 (100, 11, 128)       8320        ['svdf_3_0[0][0]']               \r\n__________________________________________________________________________________________________\r\nbatch_normalization_6 (BatchNo  (100, 11, 128)       512         ['dense_6[0][0]']                \r\nrmalization)                                                                                      \r\n__________________________________________________________________________________________________\r\nadd_2 (Add)                     (100, 11, 128)       0           ['svdf_3_1[0][0]',               \r\n                                                                  'batch_normalization_6[0][0]']  \r\n__________________________________________________________________________________________________\r\nactivation_2 (Activation)       (100, 11, 128)       0           ['add_2[0][0]']                  \r\n__________________________________________________________________________________________________\r\nmax_pooling1d_2 (MaxPooling1D)  (100, 9, 128)        0           ['activation_2[0][0]']           \r\n__________________________________________________________________________________________________\r\nglobal_average_pooling1d (Glob  (100, 128)           0           ['max_pooling1d_2[0][0]']        \r\nalAveragePooling1D)                                                                               \r\n__________________________________________________________________________________________________\r\ndropout (Dropout)               (100, 128)           0           ['global_average_pooling1d[0][0]'\r\n                                                                 ]                                \r\n__________________________________________________________________________________________________\r\ndense_7 (Dense)                 (100, 64)            8256        ['dropout[0][0]']                \r\n__________________________________________________________________________________________________\r\ndense_8 (Dense)                 (100, 3)             195         ['dense_7[0][0]']                \r\n==================================================================================================\r\nTotal params: 33,923\r\nTrainable params: 32,983\r\nNon-trainable params: 940\r\n__________________________________________________________________________________________________\r\nI0903 18:00:45.455425 140373190989632 train.py:71] None\r\n```\r\n\r\nBut it fails at the time of converting into tflite stream. Here is the error:\r\n\r\n```\r\n2021-09-03 18:22:54.631382: I tensorflow/core/grappler/clusters/single_machine.cc:357] Starting new session\r\n2021-09-03 18:22:54.634525: E tensorflow/core/grappler/grappler_item_builder.cc:669] Init node svdf_1_0/dense/kernel/Assign doesn't exist in graph\r\nI0903 18:22:54.659212 140426826090304 lite.py:1723] Using experimental converter: If you encountered a problem please file a bug. You can opt-out by setting experimental_new_converter=False\r\n2021-09-03 18:22:54.663914: W tensorflow/compiler/mlir/lite/python/tf_tfl_flatbuffer_helpers.cc:351] Ignored output_format.\r\n2021-09-03 18:22:54.663933: W tensorflow/compiler/mlir/lite/python/tf_tfl_flatbuffer_helpers.cc:354] Ignored drop_control_dependency.\r\n2021-09-03 18:22:54.698313: W tensorflow/compiler/mlir/lite/flatbuffer_export.cc:1855] TFLite interpreter needs to link Flex delegate in order to run the model since it contains the following flex op(s):\r\nFlex ops: FlexAudioSpectrogram, FlexMfcc\r\nDetails:\r\n\ttf.AudioSpectrogram(tensor<16000x1xf32>) -> (tensor<1x49x513xf32>) : {device = \"\", magnitude_squared = true, stride = 320 : i64, window_size = 640 : i64}\r\n\ttf.Mfcc(tensor<1x49x513xf32>, tensor<i32>) -> (tensor<1x49x40xf32>) : {dct_coefficient_count = 40 : i64, device = \"\", filterbank_channel_count = 80 : i64, lower_frequency_limit = 2.000000e+01 : f32, upper_frequency_limit = 7.600000e+03 : f32}\r\n\r\n******snipped****\r\n\r\nI0903 18:01:06.509099 140373190989632 test.py:510] tflite test accuracy, non stream model = 74.63% 200 out of 221\r\nI0903 18:01:06.552580 140373190989632 test.py:514] tflite Final test accuracy, non stream model = 75.11% (N=221)\r\nI0903 18:01:06.553761 140373190989632 model_train_eval.py:257] run TFlite streaming model accuracy evaluation\r\nW0903 18:01:07.091468 140373190989632 test.py:560] FAILED to convert to mode STREAM_EXTERNAL_STATE_INFERENCE, tflite: Negative dimension size caused by subtracting 3 from 1 for '{{node streaming/max_pooling1d/MaxPool}} = MaxPool[T=DT_FLOAT, data_format=\"NHWC\", explicit_paddings=[], ksize=[1, 3, 1, 1], padding=\"VALID\", strides=[1, 2, 1, 1]](streaming/max_pooling1d/ExpandDims)' with input shapes: [1,1,1,32].\r\nI0903 18:01:07.091856 140373190989632 test.py:364] tflite stream model state external with reset_state 1\r\nI0903 18:01:07.342433 140373190989632 model_train_eval.py:282] FAILED to run TFLite streaming: Mmap of '7' at offset '0' failed with error '22'.\r\n\r\n```\r\nBelow is my environment :\r\n\r\n```\r\nPackage                       Version\r\n----------------------------- -------------------\r\nabsl-py                       0.13.0\r\nargon2-cffi                   21.1.0\r\nastunparse                    1.6.3\r\nasync-generator               1.10\r\nattrs                         21.2.0\r\nbackcall                      0.2.0\r\nbleach                        4.1.0\r\ncached-property               1.5.2\r\ncachetools                    4.2.2\r\ncertifi                       2021.5.30\r\ncffi                          1.14.6\r\ncharset-normalizer            2.0.4\r\ncycler                        0.10.0\r\ndataclasses                   0.8\r\ndecorator                     5.0.9\r\ndefusedxml                    0.7.1\r\ndm-tree                       0.1.6\r\nentrypoints                   0.3\r\nflatbuffers                   1.12\r\ngast                          0.4.0\r\ngoogle-auth                   1.35.0\r\ngoogle-auth-oauthlib          0.4.5\r\ngoogle-pasta                  0.2.0\r\ngraphviz                      0.17\r\ngrpcio                        1.39.0\r\nh5py                          3.1.0\r\nidna                          3.2\r\nimportlib-metadata            4.8.1\r\nipykernel                     5.5.5\r\nipython                       7.16.1\r\nipython-genutils              0.2.0\r\nipywidgets                    7.6.4\r\njedi                          0.18.0\r\nJinja2                        3.0.1\r\njsonschema                    3.2.0\r\njupyter                       1.0.0\r\njupyter-client                7.0.2\r\njupyter-console               6.4.0\r\njupyter-core                  4.7.1\r\njupyterlab-pygments           0.1.2\r\njupyterlab-widgets            1.0.1\r\nkeras-nightly                 2.7.0.dev2021083107\r\nKeras-Preprocessing           1.1.2\r\nkiwisolver                    1.3.1\r\nlibclang                      11.1.0\r\nMarkdown                      3.3.4\r\nMarkupSafe                    2.0.1\r\nmatplotlib                    3.3.4\r\nmistune                       0.8.4\r\nnbclient                      0.5.4\r\nnbconvert                     6.0.7\r\nnbformat                      5.1.3\r\nnest-asyncio                  1.5.1\r\nnotebook                      6.4.3\r\nnumpy                         1.19.5\r\noauthlib                      3.1.1\r\nopt-einsum                    3.3.0\r\npackaging                     21.0\r\npandocfilters                 1.4.3\r\nparso                         0.8.2\r\npexpect                       4.8.0\r\npickleshare                   0.7.5\r\nPillow                        8.3.1\r\npip                           21.2.4\r\nprometheus-client             0.11.0\r\nprompt-toolkit                3.0.20\r\nprotobuf                      3.17.3\r\nptyprocess                    0.7.0\r\npyasn1                        0.4.8\r\npyasn1-modules                0.2.8\r\npycparser                     2.20\r\npydot                         1.4.2\r\nPygments                      2.10.0\r\npyparsing                     2.4.7\r\npyrsistent                    0.18.0\r\npython-dateutil               2.8.2\r\npyzmq                         22.2.1\r\nqtconsole                     5.1.1\r\nQtPy                          1.10.0\r\nrequests                      2.26.0\r\nrequests-oauthlib             1.3.0\r\nrsa                           4.7.2\r\nscipy                         1.5.4\r\nSend2Trash                    1.8.0\r\nsetuptools                    57.4.0\r\nsix                           1.15.0\r\ntb-nightly                    2.6.0a20210806\r\ntensorboard-data-server       0.6.1\r\ntensorboard-plugin-wit        1.8.0\r\ntensorflow-addons             0.14.0\r\ntensorflow-model-optimization 0.6.0\r\ntermcolor                     1.1.0\r\nterminado                     0.11.1\r\ntestpath                      0.5.0\r\ntf-estimator-nightly          2.7.0.dev2021083108\r\ntf-nightly                    2.7.0.dev20210806\r\ntornado                       6.1\r\ntraitlets                     4.3.3\r\ntypeguard                     2.12.1\r\ntyping-extensions             3.7.4.3\r\nurllib3                       1.26.6\r\nwcwidth                       0.2.5\r\nwebencodings                  0.5.1\r\nWerkzeug                      2.0.1\r\nwheel                         0.37.0\r\nwidgetsnbextension            3.5.1\r\nwrapt                         1.12.1\r\nzipp                          3.5.0\r\n```\r\nThe data folder has 1-sec recordings as below:\r\n\r\n```\r\ndata folder:\r\n_background_noise_  bed  bird  cat  dog  happy  srewai  house  marvin   sheila  tree  wow\r\n ```\r\n\r\nPlease note that svdf works fine for me.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/google-research/google-research/issues/809/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/google-research/issues/809/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"}]