{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2229","id":1292058463,"node_id":"I_kwDOCbx2hs5NAz9f","number":2229,"title":"OSError: [Errno 18] Invalid cross-device link during model training","user":{"login":"jimthompson5802","id":1425269,"node_id":"MDQ6VXNlcjE0MjUyNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1425269?v=4","gravatar_id":"","url":"https://api.github.com/users/jimthompson5802","html_url":"https://github.com/jimthompson5802","followers_url":"https://api.github.com/users/jimthompson5802/followers","following_url":"https://api.github.com/users/jimthompson5802/following{/other_user}","gists_url":"https://api.github.com/users/jimthompson5802/gists{/gist_id}","starred_url":"https://api.github.com/users/jimthompson5802/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimthompson5802/subscriptions","organizations_url":"https://api.github.com/users/jimthompson5802/orgs","repos_url":"https://api.github.com/users/jimthompson5802/repos","events_url":"https://api.github.com/users/jimthompson5802/events{/privacy}","received_events_url":"https://api.github.com/users/jimthompson5802/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-02T13:39:48Z","updated_at":"2022-07-06T00:58:44Z","closed_at":"2022-07-06T00:58:44Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"**Describe the bug**\r\nWhen training a model this error appears:\r\n```\r\n  File \"/opt/project/ludwig/utils/checkpoint_utils.py\", line 137, in save\r\n    os.replace(tmp_path, save_path)\r\nOSError: [Errno 18] Invalid cross-device link: '/tmp/tmpr8axnqsy/temp.ckpt' -> '/opt/project/sandbox/custom_stuff/results/experiment_run/model/training_checkpoints/latest.ckpt'\r\n\r\n```\r\n\r\nTo work-around this issue, place files created during training on the same file system as `/tmp`.  E.g., set ludwig training parameter `output_directory=\"/tmp/results\"`\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\nRun docker container with ludwig installed that maps a local disk volume into the container, e.g., ` -v ${PWD}:/opt/project \\`, such as\r\n```\r\ndocker run -it --rm \\\r\n  --name ludwig_torch \\\r\n  --user root:root \\\r\n  -p 8265:8265 \\\r\n  -p 6006:6006 \\\r\n  -p 6064:6064 \\\r\n  -e PYTHONPATH=/opt/project \\\r\n  --entrypoint /bin/bash \\\r\n  -v ${PWD}:/opt/project \\\r\n  -v ${PWD}/../ludwig-docs:/opt/project-docs \\\r\n  -w /opt/project/sandbox/pytest_area \\\r\n  ludwig_torch:<tag>\r\n```\r\n\r\nSample Ludwig api code `my_code.py`\r\n```\r\nimport logging\r\n\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\nfrom sklearn.datasets import make_regression\r\nfrom ludwig.api import LudwigModel\r\n\r\nif __name__ == \"__main__\":\r\n    config = {\r\n        \"input_features\": [\r\n            {\"type\": \"number\", \"name\": \"x00\"},\r\n            {\"type\": \"number\", \"name\": \"x01\"},\r\n            {\"type\": \"number\", \"name\": \"x02\"},\r\n            {\"type\": \"number\", \"name\": \"x03\"},\r\n            {\"type\": \"number\", \"name\": \"x00\"},\r\n        ],\r\n        \"output_features\": [\r\n            {\r\n                \"name\": \"y\", \"input_size\": 5,\r\n                \"type\": \"number\",\r\n            },\r\n        ],\r\n        \"trainer\":{\r\n            \"epochs\": 5,\r\n        },\r\n    }\r\n\r\n    X, y = make_regression(n_samples=2000, n_features=5)\r\n    df = pd.DataFrame(\r\n        np.hstack([X, y.reshape(-1,1)]),\r\n        columns = [f\"x{i:02d}\" for i in range(5)] + [\"y\"]\r\n    )\r\n    print(df.head())\r\n\r\n    model = LudwigModel(\r\n        config=config,\r\n        logging_level=logging.INFO\r\n    )\r\n\r\n    model.experiment(dataset=df)\r\n\r\n```\r\n\r\nRun the above python program: `python my_code.py`\r\n\r\nThis is provide full set of error messages\r\n```\r\nStarting with step 0, epoch: 0\r\nTraining:  11%|█         | 6/55 [00:00<00:00, 53.31it/s]Traceback (most recent call last):\r\n  File \"/opt/project/ludwig/models/trainer.py\", line 851, in train\r\n    should_break = self._train_loop(\r\n  File \"/opt/project/ludwig/models/trainer.py\", line 1016, in _train_loop\r\n    checkpoint_manager.save(progress_tracker.steps)\r\n  File \"/opt/project/ludwig/utils/checkpoint_utils.py\", line 199, in save\r\n    self.checkpoint.save(save_path, global_step)\r\n  File \"/opt/project/ludwig/utils/checkpoint_utils.py\", line 137, in save\r\n    os.replace(tmp_path, save_path)\r\nOSError: [Errno 18] Invalid cross-device link: '/tmp/tmpr8axnqsy/temp.ckpt' -> '/opt/project/sandbox/custom_stuff/results/experiment_run/model/training_checkpoints/latest.ckpt'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/opt/project/sandbox/custom_stuff/custom_loss_and_metric.py\", line 370, in <module>\r\n    model.experiment(dataset=df) #, output_directory=\"/tmp/results\")\r\n  File \"/opt/project/ludwig/api.py\", line 1103, in experiment\r\n    (train_stats, preprocessed_data, output_directory) = self.train(\r\n  File \"/opt/project/ludwig/api.py\", line 546, in train\r\n    train_stats = trainer.train(\r\n  File \"/opt/project/ludwig/models/trainer.py\", line 908, in train\r\n    self.model.load_state_dict(torch.load(model_weights_path))\r\n  File \"/usr/local/lib/python3.8/site-packages/torch/serialization.py\", line 699, in load\r\n    with _open_file_like(f, 'rb') as opened_file:\r\n  File \"/usr/local/lib/python3.8/site-packages/torch/serialization.py\", line 231, in _open_file_like\r\n    return _open_file(name_or_buffer, mode)\r\n  File \"/usr/local/lib/python3.8/site-packages/torch/serialization.py\", line 212, in __init__\r\n    super(_open_file, self).__init__(open(name, mode))\r\nFileNotFoundError: [Errno 2] No such file or directory: '/opt/project/sandbox/custom_stuff/results/experiment_run/model/model_weights'\r\nTraining:  20%|██        | 11/55 [00:00<00:01, 34.49it/s]\r\n```\r\n\r\n**Expected behavior**\r\nSuccessful model experiment run\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- OS: MacOS 12.4, with Docker Desktop for Mac 4.6.0 (75818)\r\n- Python version: 3.8.13\r\n- Ludwig version: 0.5.1 and 0.5.3\r\n\r\n**Additional context**\r\nThis error appears to be connected to a recent change that affected this section of code:\r\nhttps://github.com/ludwig-ai/ludwig/blob/9d7da5f68ad879f6c7296d8df25a4c6b83937354/ludwig/utils/checkpoint_utils.py#L125-L132\r\n\r\nThis change requires the temporary checkpoint dataset and location of the `output_directory` to be on the same file system.  \r\n\r\nIn the container setup that encountered the error, the two are on different filesystems within the container:\r\n```\r\nroot@c3fda044d5d6:/opt/project/sandbox/pytest_area# df -h\r\nFilesystem      Size  Used Avail Use% Mounted on\r\noverlay         133G   48G   79G  38% /              #<=location of /tmp\r\ntmpfs            64M     0   64M   0% /dev\r\nshm              64M     0   64M   0% /dev/shm\r\ngrpcfuse        932G  465G  468G  50% /opt/project    #<=the default location for output_directory\r\n/dev/vda1       133G   48G   79G  38% /etc/hosts\r\ntmpfs           6.4G     0  6.4G   0% /proc/acpi\r\ntmpfs           6.4G     0  6.4G   0% /sys/firmware\r\n```\r\n\r\nNot sure if there is a code fix for this.  May require updated documentation indicating the requirement for the location `output_directory` to be on the same filesystem as `/tmp`.\r\n","closed_by":{"login":"dantreiman","id":687280,"node_id":"MDQ6VXNlcjY4NzI4MA==","avatar_url":"https://avatars.githubusercontent.com/u/687280?v=4","gravatar_id":"","url":"https://api.github.com/users/dantreiman","html_url":"https://github.com/dantreiman","followers_url":"https://api.github.com/users/dantreiman/followers","following_url":"https://api.github.com/users/dantreiman/following{/other_user}","gists_url":"https://api.github.com/users/dantreiman/gists{/gist_id}","starred_url":"https://api.github.com/users/dantreiman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dantreiman/subscriptions","organizations_url":"https://api.github.com/users/dantreiman/orgs","repos_url":"https://api.github.com/users/dantreiman/repos","events_url":"https://api.github.com/users/dantreiman/events{/privacy}","received_events_url":"https://api.github.com/users/dantreiman/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2229/timeline","performed_via_github_app":null,"state_reason":"completed"}