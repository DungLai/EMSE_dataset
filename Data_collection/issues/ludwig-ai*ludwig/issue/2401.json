{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2401","id":1344774744,"node_id":"I_kwDOCbx2hs5QJ6JY","number":2401,"title":"hyperopt can not successfully run in driver using a remote Ray Cluster","user":{"login":"Jeffwan","id":4739316,"node_id":"MDQ6VXNlcjQ3MzkzMTY=","avatar_url":"https://avatars.githubusercontent.com/u/4739316?v=4","gravatar_id":"","url":"https://api.github.com/users/Jeffwan","html_url":"https://github.com/Jeffwan","followers_url":"https://api.github.com/users/Jeffwan/followers","following_url":"https://api.github.com/users/Jeffwan/following{/other_user}","gists_url":"https://api.github.com/users/Jeffwan/gists{/gist_id}","starred_url":"https://api.github.com/users/Jeffwan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jeffwan/subscriptions","organizations_url":"https://api.github.com/users/Jeffwan/orgs","repos_url":"https://api.github.com/users/Jeffwan/repos","events_url":"https://api.github.com/users/Jeffwan/events{/privacy}","received_events_url":"https://api.github.com/users/Jeffwan/received_events","type":"User","site_admin":false},"labels":[{"id":4538290346,"node_id":"LA_kwDOCbx2hs8AAAABDoDQqg","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/hyperopt","name":"hyperopt","color":"0052cc","default":false,"description":"Issues that are caused while running hyperopt or automl."}],"state":"closed","locked":false,"assignee":{"login":"ShreyaR","id":5787923,"node_id":"MDQ6VXNlcjU3ODc5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/5787923?v=4","gravatar_id":"","url":"https://api.github.com/users/ShreyaR","html_url":"https://github.com/ShreyaR","followers_url":"https://api.github.com/users/ShreyaR/followers","following_url":"https://api.github.com/users/ShreyaR/following{/other_user}","gists_url":"https://api.github.com/users/ShreyaR/gists{/gist_id}","starred_url":"https://api.github.com/users/ShreyaR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShreyaR/subscriptions","organizations_url":"https://api.github.com/users/ShreyaR/orgs","repos_url":"https://api.github.com/users/ShreyaR/repos","events_url":"https://api.github.com/users/ShreyaR/events{/privacy}","received_events_url":"https://api.github.com/users/ShreyaR/received_events","type":"User","site_admin":false},"assignees":[{"login":"ShreyaR","id":5787923,"node_id":"MDQ6VXNlcjU3ODc5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/5787923?v=4","gravatar_id":"","url":"https://api.github.com/users/ShreyaR","html_url":"https://github.com/ShreyaR","followers_url":"https://api.github.com/users/ShreyaR/followers","following_url":"https://api.github.com/users/ShreyaR/following{/other_user}","gists_url":"https://api.github.com/users/ShreyaR/gists{/gist_id}","starred_url":"https://api.github.com/users/ShreyaR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShreyaR/subscriptions","organizations_url":"https://api.github.com/users/ShreyaR/orgs","repos_url":"https://api.github.com/users/ShreyaR/repos","events_url":"https://api.github.com/users/ShreyaR/events{/privacy}","received_events_url":"https://api.github.com/users/ShreyaR/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-08-19T18:25:36Z","updated_at":"2022-09-15T19:50:58Z","closed_at":"2022-09-15T19:50:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\n\r\nI am playing the Ludwig in distributed environment and meet some issues. I can not run hyperopt successfully in a remote Ray Cluster. Seems that's a ray tune issue and not sure if Ludwig community can help on that. \r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\n1. Create a ray cluster on kubernetes. I expose nodePort for external clients to connect to RAY HEAD.\r\n2. Create a driver pod like below and it will talk to the remote Ray cluster using address I specified. \r\n\r\n```\r\napiVersion: batch/v1\r\nkind: Job\r\nmetadata:\r\n  name: x-automl-driver\r\n  namespace: ray-system\r\nspec:\r\n  template:\r\n    spec:\r\n      containers:\r\n      - name: ludwig\r\n        image: seedjeffwan/automl:v0.3.3\r\n        command: [\"sleep\", \"3600\"]\r\n        env:\r\n        - name: RAY_ADDRESS\r\n          value: ray://35.80.xxx.xxx:30348\r\n        - name: AWS_ACCESS_KEY_ID\r\n          value: xxxx\r\n        - name: AWS_SECRET_ACCESS_KEY\r\n          value: xxxx\r\n      restartPolicy: Never\r\n```\r\n\r\nI enter the pod to run \r\n\r\n```\r\nludwig hyperopt --config s3://ludwig-automl/rotten_tomatoes.yaml --dataset s3://ludwig-automl/rotten_tomatoes.csv\r\n```\r\n\r\n\r\n\r\n```\r\nludwig hyperopt --config s3://ludwig-automl/rotten_tomatoes.yaml --dataset s3://ludwig-automl/rotten_tomatoes.csv\r\nNumExpr defaulting to 4 threads.\r\n/usr/local/lib/python3.8/site-packages/sklearn/experimental/enable_hist_gradient_boosting.py:16: UserWarning: Since version 1.0, it is not needed to import enable_hist_gradient_boosting anymore. HistGradientBoostingClassifier and HistGradientBoostingRegressor are now stable and can be normally imported from sklearn.ensemble.\r\n  warnings.warn(\r\nFound credentials in environment variables.\r\nUsing address ray://35.80.xxx.xxx:30348 set in the environment variable RAY_ADDRESS\r\nPassing the following kwargs to ray.init() on the server: ignore_reinit_error\r\nRay processor params: None\r\n███████████████████████\r\n█ █ █ █  ▜█ █ █ █ █   █\r\n█ █ █ █ █ █ █ █ █ █ ███\r\n█ █   █ █ █ █ █ █ █ ▌ █\r\n█ █████ █ █ █ █ █ █ █ █\r\n█     █  ▟█     █ █   █\r\n███████████████████████\r\nludwig v0.6.dev - Hyperopt\r\n\r\nHyperopt config\r\n{   'executor': {   'cpu_resources_per_trial': 1,\r\n                    'num_samples': 10,\r\n                    'scheduler': {   'grace_period': 72,\r\n                                     'max_t': 300,\r\n                                     'reduction_factor': 5,\r\n                                     'time_attr': 'time_total_s',\r\n                                     'type': 'async_hyperband'},\r\n                    'time_budget_s': 300,\r\n                    'type': 'ray'},\r\n    'goal': 'maximize',\r\n    'metric': 'roc_auc',\r\n    'output_feature': 'recommended',\r\n    'parameters': {   'combiner.bn_momentum': {   'categories': [   0.4,\r\n                                                                    0.3,\r\n                                                                    0.2,\r\n                                                                    0.1,\r\n                                                                    0.05,\r\n                                                                    0.02],\r\n                                                  'space': 'choice'},\r\n                      'combiner.bn_virtual_bs': {   'categories': [   256,\r\n                                                                      512,\r\n                                                                      1024,\r\n                                                                      2048,\r\n                                                                      4096],\r\n                                                    'space': 'choice'},\r\n                      'combiner.num_steps': {   'categories': [   3,\r\n                                                                  4,\r\n                                                                  5,\r\n                                                                  6,\r\n                                                                  7,\r\n                                                                  8,\r\n                                                                  9,\r\n                                                                  10],\r\n                                                'space': 'choice'},\r\n                      'combiner.output_size': {   'categories': [   8,\r\n                                                                    16,\r\n                                                                    24,\r\n                                                                    32,\r\n                                                                    64,\r\n                                                                    128],\r\n                                                  'space': 'choice'},\r\n                      'combiner.relaxation_factor': {   'categories': [   1.0,\r\n                                                                          1.2,\r\n                                                                          1.5,\r\n                                                                          4.0],\r\n                                                        'space': 'choice'},\r\n                      'combiner.size': {   'categories': [8, 16, 24, 32, 64],\r\n                                           'space': 'choice'},\r\n                      'combiner.sparsity': {   'categories': [   0.0,\r\n                                                                 1e-06,\r\n                                                                 0.0001,\r\n                                                                 0.001,\r\n                                                                 0.01,\r\n                                                                 0.1],\r\n                                               'space': 'choice'},\r\n                      'trainer.decay_rate': {   'categories': [0.8, 0.9, 0.95],\r\n                                                'space': 'choice'},\r\n                      'trainer.decay_steps': {   'categories': [   500,\r\n                                                                   2000,\r\n                                                                   8000,\r\n                                                                   10000,\r\n                                                                   20000],\r\n                                                 'space': 'choice'},\r\n                      'trainer.learning_rate': {   'categories': [   0.005,\r\n                                                                     0.01,\r\n                                                                     0.02,\r\n                                                                     0.025],\r\n                                                   'space': 'choice'}},\r\n    'search_alg': {'random_state_seed': None, 'type': 'hyperopt'},\r\n    'split': 'validation'}\r\n\r\n\r\nFeatures that may be updated in hyperopt trials if default parameters are specified in the search space\r\n{   'input_features': defaultdict(<class 'set'>,\r\n                                  {   'binary': {'top_critic'},\r\n                                      'category': {   'content_rating',\r\n                                                      'genres',\r\n                                                      'movie_title'},\r\n                                      'number': {'runtime'}}),\r\n    'output_features': defaultdict(<class 'set'>, {'binary': {'recommended'}})}\r\n\r\n\r\nUsing full raw dataset, no hdf5 and json file with the same name have been found\r\nBuilding dataset (it may take a while)\r\n[########################################] | 100% Completed |  0.2s\r\n(dask:('to-parquet-d14fd399da13c4a97e815626d621126a', 0) pid=728) Found credentials in environment variables.\r\nBuilding dataset: DONE\r\n[########################################] | 100% Completed |  0.1s\r\n[########################################] | 100% Completed |  0.1s\r\n[########################################] | 100% Completed |  0.1s\r\n2022-08-19 18:18:04,624\tWARNING read_api.py:252 -- The number of blocks in this dataset (1) limits its parallelism to 1 concurrent tasks. This is much less than the number of available CPU slots in the cluster. Use `.repartition(n)` to increase the number of dataset blocks.\r\nCaught schedule exception\r\n2022-08-19 18:18:04,760\tWARNING read_api.py:252 -- The number of blocks in this dataset (1) limits its parallelism to 1 concurrent tasks. This is much less than the number of available CPU slots in the cluster. Use `.repartition(n)` to increase the number of dataset blocks.\r\n2022-08-19 18:18:04,847\tWARNING read_api.py:252 -- The number of blocks in this dataset (1) limits its parallelism to 1 concurrent tasks. This is much less than the number of available CPU slots in the cluster. Use `.repartition(n)` to increase the number of dataset blocks.\r\n2022-08-19 18:18:04,858\tINFO common.py:219 -- Exception from actor creation is ignored in destructor. To receive this exception in application code, call a method on the actor reference before its destructor is run.\r\n(run pid=820) /usr/local/lib/python3.8/site-packages/sklearn/experimental/enable_hist_gradient_boosting.py:16: UserWarning: Since version 1.0, it is not needed to import enable_hist_gradient_boosting anymore. HistGradientBoostingClassifier and HistGradientBoostingRegressor are now stable and can be normally imported from sklearn.ensemble.\r\n(run pid=820)   warnings.warn(\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/hyperopt/execution.py\", line 794, in execute\r\n    analysis = tune.run(\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/tune.py\", line 413, in run\r\n    return ray.get(remote_future)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/_private/client_mode_hook.py\", line 104, in wrapper\r\n    return getattr(ray, func.__name__)(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/api.py\", line 44, in get\r\n    return self.worker.get(vals, timeout=timeout)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/worker.py\", line 438, in get\r\n    res = self._get(to_get, op_timeout)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/worker.py\", line 466, in _get\r\n    raise err\r\ntypes.RayTaskError(AttributeError): ray::run() (pid=820, ip=192.168.37.141)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/tune.py\", line 479, in run\r\n    is_function_trainable(trainable)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 60, in is_function_trainable\r\n    trainable = get_trainable_cls(trainable)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 44, in get_trainable_cls\r\n    return _global_registry.get(TRAINABLE_CLASS, trainable_name)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 196, in get\r\n    return pickle.loads(value)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/common.py\", line 100, in __init__\r\n    self._set_id(id)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/common.py\", line 191, in _set_id\r\n    self._worker.call_retain(id)\r\nAttributeError: 'NoneType' object has no attribute 'call_retain'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/bin/ludwig\", line 8, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/cli.py\", line 166, in main\r\n    CLI()\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/cli.py\", line 66, in __init__\r\n    getattr(self, args.command)()\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/cli.py\", line 91, in hyperopt\r\n    hyperopt_cli.cli(sys.argv[2:])\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/hyperopt_cli.py\", line 409, in cli\r\n    hyperopt_cli(**vars(args))\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/hyperopt_cli.py\", line 161, in hyperopt_cli\r\n    return hyperopt(\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/hyperopt/run.py\", line 338, in hyperopt\r\n    hyperopt_results = hyperopt_executor.execute(\r\n  File \"/usr/local/lib/python3.8/site-packages/ludwig/hyperopt/execution.py\", line 823, in execute\r\n    raise RuntimeError(f\"Encountered Ray Tune error: {e}\")\r\nRuntimeError: Encountered Ray Tune error: ray::run() (pid=820, ip=192.168.37.141)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/tune.py\", line 479, in run\r\n    is_function_trainable(trainable)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 60, in is_function_trainable\r\n    trainable = get_trainable_cls(trainable)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 44, in get_trainable_cls\r\n    return _global_registry.get(TRAINABLE_CLASS, trainable_name)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/tune/registry.py\", line 196, in get\r\n    return pickle.loads(value)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/common.py\", line 100, in __init__\r\n    self._set_id(id)\r\n  File \"/usr/local/lib/python3.8/site-packages/ray/util/client/common.py\", line 191, in _set_id\r\n    self._worker.call_retain(id)\r\nAttributeError: 'NoneType' object has no attribute 'call_retain'\r\n```\r\n\r\n\r\n\r\n**Expected behavior**\r\nA clear and concise description of what you expected to happen.\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- Python version 3.8\r\n- Ludwig version - 0.6.0-dev nightly image\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n","closed_by":{"login":"ShreyaR","id":5787923,"node_id":"MDQ6VXNlcjU3ODc5MjM=","avatar_url":"https://avatars.githubusercontent.com/u/5787923?v=4","gravatar_id":"","url":"https://api.github.com/users/ShreyaR","html_url":"https://github.com/ShreyaR","followers_url":"https://api.github.com/users/ShreyaR/followers","following_url":"https://api.github.com/users/ShreyaR/following{/other_user}","gists_url":"https://api.github.com/users/ShreyaR/gists{/gist_id}","starred_url":"https://api.github.com/users/ShreyaR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShreyaR/subscriptions","organizations_url":"https://api.github.com/users/ShreyaR/orgs","repos_url":"https://api.github.com/users/ShreyaR/repos","events_url":"https://api.github.com/users/ShreyaR/events{/privacy}","received_events_url":"https://api.github.com/users/ShreyaR/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2401/timeline","performed_via_github_app":null,"state_reason":"completed"}