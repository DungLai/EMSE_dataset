{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/620","id":555800518,"node_id":"MDU6SXNzdWU1NTU4MDA1MTg=","number":620,"title":"bug: test_visualization.py::test_visualization_calibration_1_vs_all_output_saved fails with IndexError in seaborn regplot() function","user":{"login":"jimthompson5802","id":1425269,"node_id":"MDQ6VXNlcjE0MjUyNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1425269?v=4","gravatar_id":"","url":"https://api.github.com/users/jimthompson5802","html_url":"https://github.com/jimthompson5802","followers_url":"https://api.github.com/users/jimthompson5802/followers","following_url":"https://api.github.com/users/jimthompson5802/following{/other_user}","gists_url":"https://api.github.com/users/jimthompson5802/gists{/gist_id}","starred_url":"https://api.github.com/users/jimthompson5802/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimthompson5802/subscriptions","organizations_url":"https://api.github.com/users/jimthompson5802/orgs","repos_url":"https://api.github.com/users/jimthompson5802/repos","events_url":"https://api.github.com/users/jimthompson5802/events{/privacy}","received_events_url":"https://api.github.com/users/jimthompson5802/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2020-01-27T20:01:48Z","updated_at":"2020-02-04T03:59:30Z","closed_at":"2020-02-01T22:08:02Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"**Describe the bug**\r\nUnit test \r\n```\r\ntests/\r\n  integration_tests/\r\n    test_visualization.py::test_visualization_calibration_1_vs_all_output_saved\r\n``` \r\nfails with `IndexError` exception in the travis ci run and locally for me in a docker container:\r\n```\r\n   for command, viz_pattern in zip(commands, vis_patterns):\r\n            result = subprocess.run(command)\r\n            figure_cnt = glob.glob(viz_pattern)\r\n    \r\n>           assert 0 == result.returncode\r\nE           AssertionError: assert 0 == 1\r\nE            +  where 1 = CompletedProcess(args=['python', '-m', 'ludwig.visualize', '--visualization', 'calibration_1_vs_all', '--metrics', 'ac...robabilities.npy', '--model_names', 'Model1', 'Model2', '--top_k', '6', '-od', 'results/experiment_run'], returncode=1).returncode\r\ntests/integration_tests/test_visualization.py:1581: AssertionError\r\n----------------------------- Captured stderr call -----------------------------\r\nTraceback (most recent call last):\r\n  File \"/opt/python/3.6.7/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"/opt/python/3.6.7/lib/python3.6/runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"/home/travis/build/uber/ludwig/ludwig/visualize.py\", line 3265, in <module>\r\n    cli(sys.argv[1:])\r\n  File \"/home/travis/build/uber/ludwig/ludwig/visualize.py\", line 3260, in cli\r\n    vis_func(**vars(args))\r\n  File \"/home/travis/build/uber/ludwig/ludwig/visualize.py\", line 623, in calibration_1_vs_all_cli\r\n    calibration_1_vs_all(probabilities_per_model, gt, **kwargs)\r\n  File \"/home/travis/build/uber/ludwig/ludwig/visualize.py\", line 2654, in calibration_1_vs_all\r\n    filename=filename\r\n  File \"/home/travis/build/uber/ludwig/ludwig/utils/visualization_utils.py\", line 856, in calibration_plot\r\n    algorithm_names) else '')\r\n  File \"/home/travis/virtualenv/python3.6.7/lib/python3.6/site-packages/seaborn/regression.py\", line 810, in regplot\r\n    x_jitter, y_jitter, color, label)\r\n  File \"/home/travis/virtualenv/python3.6.7/lib/python3.6/site-packages/seaborn/regression.py\", line 114, in __init__\r\n    self.dropna(\"x\", \"y\", \"units\", \"x_partial\", \"y_partial\")\r\n  File \"/home/travis/virtualenv/python3.6.7/lib/python3.6/site-packages/seaborn/regression.py\", line 66, in dropna\r\n    setattr(self, var, val[not_na])\r\nIndexError: too many indices for array\r\n```\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\nAny PR submitted after 24Jan2020 should exhibit the problem\r\n\r\n**Expected behavior**\r\nUnit test should not fail\r\n\r\n**Screenshots**\r\nSee above\r\n\r\n**Environment (please complete the following information):**\r\nFailure occurs in two environments.  It fails in my local development environment.\r\n - OS: MacOS 10.15.2\r\n - Docker Desktop for Mac 2.2.0.0\r\n- Python version: 3.6.8\r\n- Ludwig version: 2.1\r\n\r\nFailure also occurs in the [travis-ci environment](https://travis-ci.org/uber/ludwig/builds/642189471?utm_source=github_status&utm_medium=notification)\r\n\r\n**Additional context**\r\nAfter staring at this issue for a few days, it appears the error may be related to the version of the `seaborn` package.  When the unit test is run using `seaborn 0.9.0`, the test completes successfully.  However, when `seaborn 0.10.0` is installed, the test fails with the cited error message.  I've confirmed this observation through local testing, i.e.,\r\n* `seaborn 0.9.0` => unit test completes successfully\r\n* `seaborn 0.10.0` => unit test fails\r\n\r\nNote:  unit test also fails with `seaborn 0.9.1`\r\n\r\n`seaborn 0.10.0` was released on PyPi on 2020-01-24. `seaborn 0.9.0` was released 2018-07-16.  Prior to mid-January 2020, I did not encounter any issues in running the `pytest` suite of tests.\r\n\r\n`seaborn 0.10.0` [release notes](https://seaborn.pydata.org/whatsnew.html) indicate changes were made to the `regplot()` function, which is the one failing in ludwig's unit test.  I can't tell if the issue we are seeing is due to a breaking api in the `seaborn` 0.10.0 api or a bug in 0.10.0 code base.  More analysis is required.\r\n\r\nSince the requirements file used to build the travis-ci environment specifies `seaborn>=0.7`, this means `pip install` will use the most recent version of seaborn greater than 0.7.  This results in installing `seaborn 0.10.0`.   The implication is that any PR submitted from this point on will fail in the cited unit test.\r\n\r\nA possible short-term work-around for the travis-ci run failures is to update `requirements_viz.txt` to replace the current `seaborn` specification from `seaborn>=0.7` with `seaborn>=0.7,<=0.9.0`.  If this is acceptable, I'll submit a PR to effect the change.\r\n","closed_by":{"login":"w4nderlust","id":349256,"node_id":"MDQ6VXNlcjM0OTI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/349256?v=4","gravatar_id":"","url":"https://api.github.com/users/w4nderlust","html_url":"https://github.com/w4nderlust","followers_url":"https://api.github.com/users/w4nderlust/followers","following_url":"https://api.github.com/users/w4nderlust/following{/other_user}","gists_url":"https://api.github.com/users/w4nderlust/gists{/gist_id}","starred_url":"https://api.github.com/users/w4nderlust/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/w4nderlust/subscriptions","organizations_url":"https://api.github.com/users/w4nderlust/orgs","repos_url":"https://api.github.com/users/w4nderlust/repos","events_url":"https://api.github.com/users/w4nderlust/events{/privacy}","received_events_url":"https://api.github.com/users/w4nderlust/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/620/timeline","performed_via_github_app":null,"state_reason":"completed"}