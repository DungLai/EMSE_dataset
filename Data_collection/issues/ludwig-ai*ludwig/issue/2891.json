{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2891","id":1514673069,"node_id":"I_kwDOCbx2hs5aSBOt","number":2891,"title":"Don't close MLflow run context when training model","user":{"login":"Peetee06","id":17020705,"node_id":"MDQ6VXNlcjE3MDIwNzA1","avatar_url":"https://avatars.githubusercontent.com/u/17020705?v=4","gravatar_id":"","url":"https://api.github.com/users/Peetee06","html_url":"https://github.com/Peetee06","followers_url":"https://api.github.com/users/Peetee06/followers","following_url":"https://api.github.com/users/Peetee06/following{/other_user}","gists_url":"https://api.github.com/users/Peetee06/gists{/gist_id}","starred_url":"https://api.github.com/users/Peetee06/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Peetee06/subscriptions","organizations_url":"https://api.github.com/users/Peetee06/orgs","repos_url":"https://api.github.com/users/Peetee06/repos","events_url":"https://api.github.com/users/Peetee06/events{/privacy}","received_events_url":"https://api.github.com/users/Peetee06/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"tgaddair","id":1742912,"node_id":"MDQ6VXNlcjE3NDI5MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1742912?v=4","gravatar_id":"","url":"https://api.github.com/users/tgaddair","html_url":"https://github.com/tgaddair","followers_url":"https://api.github.com/users/tgaddair/followers","following_url":"https://api.github.com/users/tgaddair/following{/other_user}","gists_url":"https://api.github.com/users/tgaddair/gists{/gist_id}","starred_url":"https://api.github.com/users/tgaddair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tgaddair/subscriptions","organizations_url":"https://api.github.com/users/tgaddair/orgs","repos_url":"https://api.github.com/users/tgaddair/repos","events_url":"https://api.github.com/users/tgaddair/events{/privacy}","received_events_url":"https://api.github.com/users/tgaddair/received_events","type":"User","site_admin":false},"assignees":[{"login":"tgaddair","id":1742912,"node_id":"MDQ6VXNlcjE3NDI5MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1742912?v=4","gravatar_id":"","url":"https://api.github.com/users/tgaddair","html_url":"https://github.com/tgaddair","followers_url":"https://api.github.com/users/tgaddair/followers","following_url":"https://api.github.com/users/tgaddair/following{/other_user}","gists_url":"https://api.github.com/users/tgaddair/gists{/gist_id}","starred_url":"https://api.github.com/users/tgaddair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tgaddair/subscriptions","organizations_url":"https://api.github.com/users/tgaddair/orgs","repos_url":"https://api.github.com/users/tgaddair/repos","events_url":"https://api.github.com/users/tgaddair/events{/privacy}","received_events_url":"https://api.github.com/users/tgaddair/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-12-30T17:35:46Z","updated_at":"2022-12-30T20:55:02Z","closed_at":"2022-12-30T20:55:02Z","author_association":"NONE","active_lock_reason":null,"body":"**Is your feature request related to a problem? Please describe.**\r\nCurrently I am using MLflow projects to run a python script that trains a model using ludwig. I would like to set the experiment name and model name to the one I pass via CLI parameters. At the same time the model name should also be the run's name in mlflow and the experiment names should match as well. The MlflowCallback seems to currently end mlflow runs if not called through hyperopt. Therefore it is not possible to let ludwig log to a run started before calling the train method. \r\n\r\nThis is the current version of `train.py`:\r\n```python\r\nimport mlflow\r\nfrom ludwig.api import LudwigModel\r\nfrom ludwig.contribs.mlflow import MlflowCallback\r\nimport pandas as pd\r\nimport pathlib\r\nimport click\r\n\r\n\r\n@click.command()\r\n@click.option(\"--data_path\", help=\"Path to data\", type=click.Path(exists=True))\r\n@click.option(\r\n    \"--model_config_path\",\r\n    help=\"Path to model config\",\r\n    type=click.Path(exists=True),\r\n)\r\n@click.option(\r\n    \"--output_path\", help=\"Path to save trained model\", type=click.Path()\r\n)\r\n@click.option(\r\n    \"--model_name\",\r\n    help=\"Name of the model\",\r\n    type=click.STRING,\r\n)\r\n@click.option(\r\n    \"--experiment_name\",\r\n    help=\"Name of the experiment\",\r\n    type=click.STRING,\r\n)\r\ndef train(\r\n    data_path, model_config_path, output_path, model_name, experiment_name\r\n):\r\n    \"\"\"Train model\"\"\"\r\n\r\n    data_path = pathlib.Path(data_path)\r\n    output_path = pathlib.Path(output_path)\r\n\r\n    # load data\r\n    df = pd.read_csv(data_path)\r\n\r\n    # create model with mlflow callback\r\n    # will log metrics, artifacts, and model\r\n    model = LudwigModel(\r\n        config=model_config_path,\r\n        logging_level=30,\r\n        callbacks=[MlflowCallback()],\r\n    )\r\n    # train model\r\n    _, _, output_dir = model.train(\r\n        dataset=df,\r\n        experiment_name=experiment_name,\r\n        model_name=model_name,\r\n        output_directory=output_path,\r\n    )\r\n\r\nif __name__ == \"__main__\":\r\n    train()\r\n```\r\n\r\nAnd the call I want to make is:\r\n`mlflow run -e train -P data_path=data/train.csv -P model_config_path=config/model_config.yaml -P model_name=test -P experiment_name=titanic .`\r\n\r\nThe result should be a run with name \"test\" under experiment with name \"titanic\" containing the logs by the MlflowCallback.\r\n\r\n**Describe the use case**\r\nA user wants to define custom experiment and run names when using the MlflowCallback.\r\n\r\n**Describe the solution you'd like**\r\nA way to make it possible for the user to start a run and let the MlflowCallback log to that run. Might be enough to remove the `mlflow.end_run()` call when no experiment_id is set yet.\r\n\r\n**Describe alternatives you've considered**\r\nI could define experiment name and model/run name as CLI parameters to the entrypoint as well as to mlflow. That's a little ugly because it would mean writing both two times. \r\nE.g. `mlflow run -e train -P model_name=titanic -P experiment_name=test --run-name titanic --experiment-name test`.\r\nI also tried a partial workaround where I set the mlflow.runName tag after using LudwigModel.train() of the last active run (`mlflow.last_active_run()`). This does not work for the experiment_name, though.\r\n","closed_by":{"login":"tgaddair","id":1742912,"node_id":"MDQ6VXNlcjE3NDI5MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1742912?v=4","gravatar_id":"","url":"https://api.github.com/users/tgaddair","html_url":"https://github.com/tgaddair","followers_url":"https://api.github.com/users/tgaddair/followers","following_url":"https://api.github.com/users/tgaddair/following{/other_user}","gists_url":"https://api.github.com/users/tgaddair/gists{/gist_id}","starred_url":"https://api.github.com/users/tgaddair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tgaddair/subscriptions","organizations_url":"https://api.github.com/users/tgaddair/orgs","repos_url":"https://api.github.com/users/tgaddair/repos","events_url":"https://api.github.com/users/tgaddair/events{/privacy}","received_events_url":"https://api.github.com/users/tgaddair/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2891/timeline","performed_via_github_app":null,"state_reason":"completed"}