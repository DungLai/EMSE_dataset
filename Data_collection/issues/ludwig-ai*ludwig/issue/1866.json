{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/1866","id":1190073140,"node_id":"I_kwDOCbx2hs5G7xM0","number":1866,"title":"Ludwig hyperparameter search cannot find best model for final evaluation [blocker]","user":{"login":"amholler","id":86269492,"node_id":"MDQ6VXNlcjg2MjY5NDky","avatar_url":"https://avatars.githubusercontent.com/u/86269492?v=4","gravatar_id":"","url":"https://api.github.com/users/amholler","html_url":"https://github.com/amholler","followers_url":"https://api.github.com/users/amholler/followers","following_url":"https://api.github.com/users/amholler/following{/other_user}","gists_url":"https://api.github.com/users/amholler/gists{/gist_id}","starred_url":"https://api.github.com/users/amholler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amholler/subscriptions","organizations_url":"https://api.github.com/users/amholler/orgs","repos_url":"https://api.github.com/users/amholler/repos","events_url":"https://api.github.com/users/amholler/events{/privacy}","received_events_url":"https://api.github.com/users/amholler/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-01T17:14:16Z","updated_at":"2022-04-03T18:52:27Z","closed_at":"2022-04-03T18:52:27Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"Okay, I see why hyperopt search has started reporting that it can't find the expected trial checkpoints when\r\ntrying to compute the evaluation of the best models for each trial after the RayTune job is complete.\r\nDetails below.  This is a blocker for getting correct hyparameter model evaluation (falls back to last train time evaluation)\r\n\r\nWhen the Ray Tune job finishes, Ludwig needs to evaluate the best model for each training trial that was\r\nterminated w/o executing its post-train evaluation step (which for async hyperband is virtually all trials).\r\nTo do this, Ludwig first calls Ray to get the path to the best model:\r\n https://github.com/ludwig-ai/ludwig/blob/master/ludwig/hyperopt/execution.py#L374\r\n\r\nRay fetches the trial checkpoint paths and parses the checkpoint dir name to get the \"training_iteration\" number,\r\nand it looks at the scores it got for training iterations to decide which path is to the best model.  The problem\r\nis that we've changed our naming convention for checkpoints to reflect the steps rather than the number of times\r\nwe called Ray to record training values, so there is a mismatch, and ray reports that it can't find the best model.\r\n\r\nIn a simple example, Ray tune.report was called twice, so Ray thinks that there were 2 training iterations,\r\nbut our checkpoint directory was named\r\n /home/ray/experiments/automl_nlp/heuristics/sst2/trainable_func_frw4i_Y/trial_c5c6135a/checkpoint_000866/\r\nRay tried to find the checkpoint corresponding to the better of training iteration 1 or 2 but it failed,\r\nsince its code thought there was only a checkpoint corresponding to training iteration 866.\r\n","closed_by":{"login":"amholler","id":86269492,"node_id":"MDQ6VXNlcjg2MjY5NDky","avatar_url":"https://avatars.githubusercontent.com/u/86269492?v=4","gravatar_id":"","url":"https://api.github.com/users/amholler","html_url":"https://github.com/amholler","followers_url":"https://api.github.com/users/amholler/followers","following_url":"https://api.github.com/users/amholler/following{/other_user}","gists_url":"https://api.github.com/users/amholler/gists{/gist_id}","starred_url":"https://api.github.com/users/amholler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amholler/subscriptions","organizations_url":"https://api.github.com/users/amholler/orgs","repos_url":"https://api.github.com/users/amholler/repos","events_url":"https://api.github.com/users/amholler/events{/privacy}","received_events_url":"https://api.github.com/users/amholler/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1866/timeline","performed_via_github_app":null,"state_reason":"completed"}