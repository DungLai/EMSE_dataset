{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2199","id":1286787071,"node_id":"I_kwDOCbx2hs5Mss__","number":2199,"title":"model.predict() fails on goemotions v0.5.3","user":{"login":"abidwael","id":103003638,"node_id":"U_kgDOBiO19g","avatar_url":"https://avatars.githubusercontent.com/u/103003638?v=4","gravatar_id":"","url":"https://api.github.com/users/abidwael","html_url":"https://github.com/abidwael","followers_url":"https://api.github.com/users/abidwael/followers","following_url":"https://api.github.com/users/abidwael/following{/other_user}","gists_url":"https://api.github.com/users/abidwael/gists{/gist_id}","starred_url":"https://api.github.com/users/abidwael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abidwael/subscriptions","organizations_url":"https://api.github.com/users/abidwael/orgs","repos_url":"https://api.github.com/users/abidwael/repos","events_url":"https://api.github.com/users/abidwael/events{/privacy}","received_events_url":"https://api.github.com/users/abidwael/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"geoffreyangus","id":29719151,"node_id":"MDQ6VXNlcjI5NzE5MTUx","avatar_url":"https://avatars.githubusercontent.com/u/29719151?v=4","gravatar_id":"","url":"https://api.github.com/users/geoffreyangus","html_url":"https://github.com/geoffreyangus","followers_url":"https://api.github.com/users/geoffreyangus/followers","following_url":"https://api.github.com/users/geoffreyangus/following{/other_user}","gists_url":"https://api.github.com/users/geoffreyangus/gists{/gist_id}","starred_url":"https://api.github.com/users/geoffreyangus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geoffreyangus/subscriptions","organizations_url":"https://api.github.com/users/geoffreyangus/orgs","repos_url":"https://api.github.com/users/geoffreyangus/repos","events_url":"https://api.github.com/users/geoffreyangus/events{/privacy}","received_events_url":"https://api.github.com/users/geoffreyangus/received_events","type":"User","site_admin":false},"assignees":[{"login":"geoffreyangus","id":29719151,"node_id":"MDQ6VXNlcjI5NzE5MTUx","avatar_url":"https://avatars.githubusercontent.com/u/29719151?v=4","gravatar_id":"","url":"https://api.github.com/users/geoffreyangus","html_url":"https://github.com/geoffreyangus","followers_url":"https://api.github.com/users/geoffreyangus/followers","following_url":"https://api.github.com/users/geoffreyangus/following{/other_user}","gists_url":"https://api.github.com/users/geoffreyangus/gists{/gist_id}","starred_url":"https://api.github.com/users/geoffreyangus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geoffreyangus/subscriptions","organizations_url":"https://api.github.com/users/geoffreyangus/orgs","repos_url":"https://api.github.com/users/geoffreyangus/repos","events_url":"https://api.github.com/users/geoffreyangus/events{/privacy}","received_events_url":"https://api.github.com/users/geoffreyangus/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-06-28T05:19:30Z","updated_at":"2022-07-06T02:40:04Z","closed_at":"2022-07-06T02:40:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Edit**: commit that led to the bug: https://github.com/ludwig-ai/ludwig/commit/fe77793288869a651f3b845aa7626fb5a0552ba7\r\n\r\n**Describe the bug**\r\nmodel.predict() fails on goemotions. Generates the following error:\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\nCode to execute\r\n```\r\nimport logging\r\nfrom ludwig.api import LudwigModel\r\nfrom ludwig.datasets import goemotions\r\nfrom ludwig.utils.data_utils import load_yaml\r\n\r\ntraining_set, test_set, val_set = goemotions.load(split=True)\r\nmodel_config = load_yaml(\"goemotions.yaml\") # copied below\r\nmodel_config['backend'] = {}\r\nmodel_config['backend']['type'] = 'local'\r\nmodel = LudwigModel(config=model_config, logging_level=logging.INFO)\r\ntrain_stats, preprocessed_data, output_directory = model.train(dataset=training_set, experiment_name=\"simple_experiment\", model_name=\"simple_model\")\r\nmodel.predict(test_set, skip_save_predictions=False)\r\n```\r\n`goemotions.yaml`\r\n```\r\noutput_features:\r\n  - name: emotion_ids\r\n    type: set\r\ninput_features:\r\n  - name: text\r\n    type: text\r\n    encoder: bert\r\npreprocessing:\r\n  text:\r\n    max_sequence_length: 40\r\ntrainer:\r\n  batch_size: 64\r\n  learning_rate: 0.00002\r\n  epochs: 5\r\n  learning_rate_warmup_epochs: 0\r\n  optimizer:\r\n    type: adamw\r\n  validation_field: emotion_ids\r\n  validation_metric: jaccard\r\n```\r\nError message\r\n```\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/opt/conda/lib/python3.7/site-packages/ludwig/api.py\", line 810, in predict\r\n    postproc_predictions, self.model.output_features, output_directory, self.backend\r\n  File \"/opt/conda/lib/python3.7/site-packages/ludwig/models/predictor.py\", line 320, in save_prediction_outputs\r\n    postprocessed_output.to_parquet(os.path.join(output_directory, PREDICTIONS_PARQUET_FILE_NAME))\r\n  File \"/opt/conda/lib/python3.7/site-packages/pandas/util/_decorators.py\", line 207, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/opt/conda/lib/python3.7/site-packages/pandas/core/frame.py\", line 2685, in to_parquet\r\n    **kwargs,\r\n  File \"/opt/conda/lib/python3.7/site-packages/pandas/io/parquet.py\", line 423, in to_parquet\r\n    **kwargs,\r\n  File \"/opt/conda/lib/python3.7/site-packages/pandas/io/parquet.py\", line 173, in write\r\n    table = self.api.Table.from_pandas(df, **from_pandas_kwargs)\r\n  File \"pyarrow/table.pxi\", line 1650, in pyarrow.lib.Table.from_pandas\r\n  File \"/opt/conda/lib/python3.7/site-packages/pyarrow/pandas_compat.py\", line 595, in dataframe_to_arrays\r\n    for c, f in zip(columns_to_convert, convert_fields)]\r\n  File \"/opt/conda/lib/python3.7/site-packages/pyarrow/pandas_compat.py\", line 595, in <listcomp>\r\n    for c, f in zip(columns_to_convert, convert_fields)]\r\n  File \"/opt/conda/lib/python3.7/site-packages/pyarrow/pandas_compat.py\", line 581, in convert_column\r\n    raise e\r\n  File \"/opt/conda/lib/python3.7/site-packages/pyarrow/pandas_compat.py\", line 575, in convert_column\r\n    result = pa.array(col, type=type_, from_pandas=True, safe=safe)\r\n  File \"pyarrow/array.pxi\", line 311, in pyarrow.lib.array\r\n  File \"pyarrow/array.pxi\", line 83, in pyarrow.lib._ndarray_to_array\r\n  File \"pyarrow/error.pxi\", line 99, in pyarrow.lib.check_status\r\npyarrow.lib.ArrowInvalid: ('Cannot mix NumPy dtypes float64 and float32', 'Conversion failed for column emotion_ids_probabilities with type object')\r\n```\r\n\r\n**Expected behavior**\r\nModel evaluates successfully.\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n**Environment (please complete the following information):**\r\n\r\nSetup ray cluster with the `ludwigai/ludwig-gpu:0.5.3` image from [Ludwig dockerhub](https://hub.docker.com/layers/ludwig-gpu/ludwigai/ludwig-gpu/0.5.3/images/sha256-48193e67d816699caca778faa6be0ef2152be230fa1d78de03766923c141a50f?context=explore). The following is part of the output of `kubectl describe pod <my_pod>`\r\n```\r\nLabels:       groupName=headgroup\r\n              ray.io/cluster=waelabid-benchmark-cluster\r\n              ray.io/group=headgroup\r\n              ray.io/identifier=waelabid-benchmark-cluster-head\r\n              ray.io/is-ray-node=yes\r\n              ray.io/node-type=head\r\n              rayCluster=waelabid-benchmark-cluster\r\n              rayNodeType=head\r\nAnnotations:  key: value\r\n              kubernetes.io/psp: eks.privileged\r\nStatus:       Running\r\n...\r\nControlled By:  RayCluster/waelabid-benchmark-cluster\r\nContainers:\r\n  ray-head:\r\n    Container ID:  docker://820f8e57c6f9785a63d53c0c7c39d7433d098a29639de64fdca9ee61484854b6\r\n    Image:         ludwigai/ludwig-gpu:0.5.3\r\n    Image ID:      docker-pullable://ludwigai/ludwig-gpu@sha256:48193e67d816699caca778faa6be0ef2152be230fa1d78de03766923c141a50f\r\n...\r\n```\r\n","closed_by":{"login":"justinxzhao","id":3459541,"node_id":"MDQ6VXNlcjM0NTk1NDE=","avatar_url":"https://avatars.githubusercontent.com/u/3459541?v=4","gravatar_id":"","url":"https://api.github.com/users/justinxzhao","html_url":"https://github.com/justinxzhao","followers_url":"https://api.github.com/users/justinxzhao/followers","following_url":"https://api.github.com/users/justinxzhao/following{/other_user}","gists_url":"https://api.github.com/users/justinxzhao/gists{/gist_id}","starred_url":"https://api.github.com/users/justinxzhao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinxzhao/subscriptions","organizations_url":"https://api.github.com/users/justinxzhao/orgs","repos_url":"https://api.github.com/users/justinxzhao/repos","events_url":"https://api.github.com/users/justinxzhao/events{/privacy}","received_events_url":"https://api.github.com/users/justinxzhao/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2199/timeline","performed_via_github_app":null,"state_reason":"completed"}