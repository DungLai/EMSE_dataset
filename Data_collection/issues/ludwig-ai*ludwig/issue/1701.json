{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/1701","id":1111494256,"node_id":"I_kwDOCbx2hs5CQA5w","number":1701,"title":"Shape mismatch when introducing multiple levels of dependencies","user":{"login":"jppgks","id":11156808,"node_id":"MDQ6VXNlcjExMTU2ODA4","avatar_url":"https://avatars.githubusercontent.com/u/11156808?v=4","gravatar_id":"","url":"https://api.github.com/users/jppgks","html_url":"https://github.com/jppgks","followers_url":"https://api.github.com/users/jppgks/followers","following_url":"https://api.github.com/users/jppgks/following{/other_user}","gists_url":"https://api.github.com/users/jppgks/gists{/gist_id}","starred_url":"https://api.github.com/users/jppgks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jppgks/subscriptions","organizations_url":"https://api.github.com/users/jppgks/orgs","repos_url":"https://api.github.com/users/jppgks/repos","events_url":"https://api.github.com/users/jppgks/events{/privacy}","received_events_url":"https://api.github.com/users/jppgks/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-01-22T11:51:40Z","updated_at":"2022-01-23T21:56:46Z","closed_at":"2022-01-23T21:56:46Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\n\r\nWhen introducing multiple levels of dependencies, the shape of the _concatenated hidden states_ does not match the _input size for the dense layer of the output feature_.\r\n\r\nIn my case, the text output feature `qty_frac` depends on text output feature `summary`, and numerical output feature `qty` in turn depends on `qty_frac`.\r\n\r\nI get the following error when running `ludwig train`:\r\n```python-traceback\r\nRuntimeError: mat1 and mat2 shapes cannot be multiplied (6x768 and 512x1)\r\n```\r\n\r\n\r\n\r\n**To Reproduce**\r\n\r\nMinimal, reproducible example using bash and docker as only dependencies:\r\n```bash\r\n#!/usr/bin/env bash\r\nFEATURE_LIST=$(\r\n    docker run -i mikefarah/yq -o json -I 0 e '.' - <<EOF\r\n- name: document\r\n  type: text\r\n- name: summary\r\n  type: text\r\n- name: qty_frac\r\n  type: text\r\n- name: qty\r\n  type: numerical\r\nEOF\r\n)\r\n\r\nmkdir /tmp/ludwig-debug\r\ndocker run \\\r\n    -it \\\r\n    -v /tmp/ludwig-debug/:/workdir \\\r\n    ludwigai/ludwig:nightly \\\r\n    synthesize_dataset \\\r\n    --features $FEATURE_LIST \\\r\n    --dataset_size 10 \\\r\n    --output_path /workdir/synthetic_data.csv\r\n\r\ncat <<EOF >/tmp/ludwig-debug/config.yml\r\ninput_features:\r\n  - name: document\r\n    type: text\r\n    level: word\r\noutput_features:\r\n  - name: summary\r\n    type: text\r\n    level: word\r\n    decoder: generator\r\n  - name: qty_frac\r\n    type: text\r\n    level: word\r\n    decoder: generator\r\n    dependencies:\r\n      - summary\r\n  - name: qty\r\n    type: numerical\r\n    dependencies:\r\n      - qty_frac\r\nEOF\r\n\r\ndocker run \\\r\n    -it \\\r\n    -v /tmp/ludwig-debug/:/workdir \\\r\n    ludwigai/ludwig:nightly \\\r\n    train \\\r\n    --dataset /workdir/synthetic_data.csv \\\r\n    --config_file /workdir/config.yml \\\r\n    --output_directory /workdir/results\r\n```\r\n\r\n**Expected behavior**\r\n\r\nTraining starts without error.\r\n\r\n**Screenshots**\r\n\r\nExcerpt from the traceback:\r\n```python-traceback\r\n  File \"/usr/local/lib/python3.7/site-packages/ludwig/features/numerical_feature.py\", line 269, in logits\r\n    return self.decoder_obj(hidden)\r\n  File \"/usr/local/lib/python3.7/site-packages/torch/nn/modules/module.py\", line 1102, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/ludwig/decoders/generic_decoders.py\", line 58, in forward\r\n    return self.dense(inputs)\r\n  File \"/usr/local/lib/python3.7/site-packages/torch/nn/modules/module.py\", line 1102, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/ludwig/utils/torch_utils.py\", line 212, in forward\r\n    output = torch.squeeze(self.dense(input), dim=-1)\r\n  File \"/usr/local/lib/python3.7/site-packages/torch/nn/modules/module.py\", line 1102, in _call_impl\r\n    return forward_call(*input, **kwargs)\r\n  File \"/usr/local/lib/python3.7/site-packages/torch/nn/modules/linear.py\", line 103, in forward\r\n    return F.linear(input, self.weight, self.bias)\r\n  File \"/usr/local/lib/python3.7/site-packages/torch/nn/functional.py\", line 1848, in linear\r\n    return torch._C._nn.linear(input, weight, bias)\r\nRuntimeError: mat1 and mat2 shapes cannot be multiplied (6x768 and 512x1)\r\n```\r\n\r\n**Environment:**\r\n\r\nSee reproducible example, run in environment with:\r\n- bash: `GNU bash, version 5.0.17(1)-release (x86_64-pc-linux-gnu)`\r\n- docker: `Docker version 20.10.11+azure-3, build dea9396e184290f638ea873c76db7c80efd5a1d2`\r\n\r\nThe `ludwigai/ludwig:nightly` Docker image was built from main at 89d18365c41c4ded68edd2095349ce4a6caf5d18.\r\n","closed_by":{"login":"justinxzhao","id":3459541,"node_id":"MDQ6VXNlcjM0NTk1NDE=","avatar_url":"https://avatars.githubusercontent.com/u/3459541?v=4","gravatar_id":"","url":"https://api.github.com/users/justinxzhao","html_url":"https://github.com/justinxzhao","followers_url":"https://api.github.com/users/justinxzhao/followers","following_url":"https://api.github.com/users/justinxzhao/following{/other_user}","gists_url":"https://api.github.com/users/justinxzhao/gists{/gist_id}","starred_url":"https://api.github.com/users/justinxzhao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinxzhao/subscriptions","organizations_url":"https://api.github.com/users/justinxzhao/orgs","repos_url":"https://api.github.com/users/justinxzhao/repos","events_url":"https://api.github.com/users/justinxzhao/events{/privacy}","received_events_url":"https://api.github.com/users/justinxzhao/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1701/timeline","performed_via_github_app":null,"state_reason":"completed"}