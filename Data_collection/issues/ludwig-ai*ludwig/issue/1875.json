{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/1875","id":1192994824,"node_id":"I_kwDOCbx2hs5HG6gI","number":1875,"title":"learning_curves plot fails with KeyError with training only statistics generated","user":{"login":"jimthompson5802","id":1425269,"node_id":"MDQ6VXNlcjE0MjUyNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1425269?v=4","gravatar_id":"","url":"https://api.github.com/users/jimthompson5802","html_url":"https://github.com/jimthompson5802","followers_url":"https://api.github.com/users/jimthompson5802/followers","following_url":"https://api.github.com/users/jimthompson5802/following{/other_user}","gists_url":"https://api.github.com/users/jimthompson5802/gists{/gist_id}","starred_url":"https://api.github.com/users/jimthompson5802/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimthompson5802/subscriptions","organizations_url":"https://api.github.com/users/jimthompson5802/orgs","repos_url":"https://api.github.com/users/jimthompson5802/repos","events_url":"https://api.github.com/users/jimthompson5802/events{/privacy}","received_events_url":"https://api.github.com/users/jimthompson5802/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-05T11:08:01Z","updated_at":"2022-04-06T19:53:24Z","closed_at":"2022-04-06T19:53:24Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"**Describe the bug**\r\nif `training_statistics.json` contains only training results and no validation results and is used to as input to the `learning_curves` plot, the plot fails with `KeyError` exception.   Here is stack trace:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/IPython/core/interactiveshell.py\", line 3369, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-2-a90fbbbbb49e>\", line 1, in <cell line: 1>\r\n    runfile('/opt/project/sandbox/mwe_learning_curve_viz_failure.py', wdir='/opt/project/sandbox')\r\n  File \"/opt/.pycharm_helpers/pydev/_pydev_bundle/pydev_umd.py\", line 198, in runfile\r\n    pydev_imports.execfile(filename, global_vars, local_vars)  # execute the script\r\n  File \"/opt/.pycharm_helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"/opt/project/sandbox/mwe_learning_curve_viz_failure.py\", line 54, in <module>\r\n    learning_curves([training_stats2],\r\n  File \"/opt/project/ludwig/visualize.py\", line 1245, in learning_curves\r\n    validation_stats.append(learning_stats[VALIDATION][output_feature_name][metric])\r\nKeyError: 'combined'\r\n```\r\n\r\nI'll submit a PR to address this issue later tonight.\r\n\r\n\r\n**To Reproduce**\r\nThis is a minimal working example demonstrating the issue:\r\n```\r\nimport logging\r\nimport os\r\nimport tempfile\r\nimport shutil\r\nimport json\r\n\r\nfrom ludwig.api import LudwigModel\r\nfrom tests.integration_tests.utils import generate_data, number_feature\r\nfrom ludwig.visualize import learning_curves\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    input_features = [number_feature()]\r\n    output_features = [number_feature()]\r\n    config = {\r\n        \"input_features\": input_features,\r\n        \"output_features\": output_features,\r\n        \"trainer\": {\"epochs\": 5}\r\n    }\r\n\r\n    with tempfile.TemporaryDirectory() as tmpdir:\r\n        data_fp = generate_data(input_features, output_features, os.path.join(tmpdir, \"raw.csv\"))\r\n\r\n        model = LudwigModel(config=config)\r\n\r\n        # using dataset=data_fp the both calls to generate learning_curves work\r\n        #    which generates training and validation statistics\r\n        # using training_set=data_fp will cause the second learning_curves plot to fail\r\n        #    which generates training only statistics\r\n        training_stats1, _, results = model.train(\r\n           # dataset=data_fp,   # this works in all cases\r\n            training_set=data_fp, # this will cause a failure\r\n            output_directory=os.path.join(tmpdir, 'results')\r\n        )\r\n\r\n        with open(os.path.join(results, \"training_statistics.json\")) as f:\r\n            training_stats2 = json.load(f)\r\n\r\n        print(training_stats2)\r\n\r\n        # training statistics data structure created by train() works for two situations:\r\n        #    training only statistics captured\r\n        #    training and validation statistics generated\r\n        shutil.rmtree('./viz1', ignore_errors=True)\r\n        learning_curves([training_stats1],\r\n                        model_names=['Model1'],\r\n                        output_directory=\"./viz1\", file_format='png')\r\n        print(\"generated plots for training_stats1\", os.listdir(\"./viz1\"))\r\n\r\n        # using training stats dictionary loaded from training_statistics.json fails in one situation:\r\n        #     training only statistics fails\r\n        #     training and validation statistics works\r\n        shutil.rmtree('./viz2', ignore_errors=True)\r\n        learning_curves([training_stats2],\r\n                        model_names=['Model1'],\r\n                        output_directory=\"./viz2\", file_format='png')\r\n        print(\"generated plots for training_stat2\", os.listdir(\"./viz2\"))\r\n\r\n    print(\"all done\")\r\n```\r\n\r\n**Expected behavior**\r\nGenerate the learning curve plot with training only statistics\r\n\r\n**Screenshots**\r\nFull output from the example code:\r\n```\r\nNumExpr defaulting to 5 threads.\r\ngenerated new fontManager\r\nray.init() failed: Could not find any running Ray instance. Please specify the one to connect to by setting `address`.\r\nNote: steps_per_checkpoint (was 1) is now set to the number of steps per epoch: 1.\r\n{'test': {}, 'training': {'combined': {'loss': [0.7418510913848877, 0.7391425967216492, 0.7364398241043091, 0.7337425351142883, 0.7310507893562317]}, 'num_BD40A': {'loss': [0.7418510913848877, 0.7391425967216492, 0.7364398241043091, 0.7337425351142883, 0.7310507893562317], 'mean_absolute_error': [0.8156701922416687, 0.8140162825584412, 0.8123624324798584, 0.8107086420059204, 0.8090547919273376], 'mean_squared_error': [0.7418510913848877, 0.7391425967216492, 0.7364398241043091, 0.7337425351142883, 0.7310507893562317], 'r2': [-8.04835319519043, -8.0153169631958, -7.982351303100586, -7.9494524002075195, -7.916621208190918], 'root_mean_squared_error': [0.8613077998161316, 0.8597339987754822, 0.8581607341766357, 0.8565877079963684, 0.8550150990486145], 'root_mean_squared_percentage_error': [3.0594561100006104, 3.045417070388794, 3.031384229660034, 3.0173561573028564, 3.003333806991577]}}, 'validation': {}}\r\ngenerated plots for training_stats1 ['learning_curves_combined_loss.png', 'learning_curves_num_BD40A_loss.png']\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.8/site-packages/IPython/core/interactiveshell.py\", line 3369, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-2-a90fbbbbb49e>\", line 1, in <cell line: 1>\r\n    runfile('/opt/project/sandbox/mwe_learning_curve_viz_failure.py', wdir='/opt/project/sandbox')\r\n  File \"/opt/.pycharm_helpers/pydev/_pydev_bundle/pydev_umd.py\", line 198, in runfile\r\n    pydev_imports.execfile(filename, global_vars, local_vars)  # execute the script\r\n  File \"/opt/.pycharm_helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"/opt/project/sandbox/mwe_learning_curve_viz_failure.py\", line 54, in <module>\r\n    learning_curves([training_stats2],\r\n  File \"/opt/project/ludwig/visualize.py\", line 1245, in learning_curves\r\n    validation_stats.append(learning_stats[VALIDATION][output_feature_name][metric])\r\nKeyError: 'combined'\r\nProcess finished with exit code 0\r\n```\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- OS: MacOS running Docker Desktop\r\n- Version: MacOS 12.2.1 , Docker Desktop 4.6.0\r\n- Python version: 3.8\r\n- Ludwig version: 0.5rc2\r\n\r\n**Additional context**\r\nThe failure only occurs using the python dictionary created from reading in `training_statistics.json` from disk. \r\n\r\nThe error **does not occur** if using the trainining statistics data structure created by `LudwigModel.train()`\r\n","closed_by":{"login":"w4nderlust","id":349256,"node_id":"MDQ6VXNlcjM0OTI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/349256?v=4","gravatar_id":"","url":"https://api.github.com/users/w4nderlust","html_url":"https://github.com/w4nderlust","followers_url":"https://api.github.com/users/w4nderlust/followers","following_url":"https://api.github.com/users/w4nderlust/following{/other_user}","gists_url":"https://api.github.com/users/w4nderlust/gists{/gist_id}","starred_url":"https://api.github.com/users/w4nderlust/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/w4nderlust/subscriptions","organizations_url":"https://api.github.com/users/w4nderlust/orgs","repos_url":"https://api.github.com/users/w4nderlust/repos","events_url":"https://api.github.com/users/w4nderlust/events{/privacy}","received_events_url":"https://api.github.com/users/w4nderlust/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1875/timeline","performed_via_github_app":null,"state_reason":"completed"}