{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/1664","id":1097885980,"node_id":"I_kwDOCbx2hs5BcGkc","number":1664,"title":"Ludwig serve reserves gpu memory but doesn't utilize gpu (tf-inference pip install Ludwig 0.4)","user":{"login":"smiraldr","id":42693530,"node_id":"MDQ6VXNlcjQyNjkzNTMw","avatar_url":"https://avatars.githubusercontent.com/u/42693530?v=4","gravatar_id":"","url":"https://api.github.com/users/smiraldr","html_url":"https://github.com/smiraldr","followers_url":"https://api.github.com/users/smiraldr/followers","following_url":"https://api.github.com/users/smiraldr/following{/other_user}","gists_url":"https://api.github.com/users/smiraldr/gists{/gist_id}","starred_url":"https://api.github.com/users/smiraldr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smiraldr/subscriptions","organizations_url":"https://api.github.com/users/smiraldr/orgs","repos_url":"https://api.github.com/users/smiraldr/repos","events_url":"https://api.github.com/users/smiraldr/events{/privacy}","received_events_url":"https://api.github.com/users/smiraldr/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1434966350,"node_id":"MDU6TGFiZWwxNDM0OTY2MzUw","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/looking%20into%20it","name":"looking into it","color":"ffa54f","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2022-01-10T13:12:40Z","updated_at":"2022-06-25T20:03:51Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nUsing ludwig serve from the cmd , Model reserves gpu memory but does not utilize gpu at all. Although unlike https://github.com/ludwig-ai/ludwig/issues/73 , training works well on gpu (speed difference for training on gpu and cpu is significantly different) on the same instance and same environment.\r\nInference speed remains equal on gpu or cpu and even batch size (single inference or batch of 50) seems to have no effect for inference.\r\nAlso I feel the overhead for tf and ludwig is still considerable as mentioned in #73 , have we made any new optimizations for that?\r\n\r\n**Logs**\r\n\r\n2021-12-27 08:25:23.778011: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA\r\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\r\n2021-12-27 08:25:24.398823: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 13793 MB memory:  -> device: 0, name: Tesla T4, pci bus id: 0000:00:1e.0, compute capability: 7.5\r\n/opt/conda/lib/python3.8/site-packages/cryptography/hazmat/backends/openssl/x509.py:15: CryptographyDeprecationWarning: This version of cryptography contains a temporary pyOpenSSL fallback path. Upgrade pyOpenSSL now.\r\n  warnings.warn(\r\nDownloading: 100%|██████████| 570/570 [00:00<00:00, 595kB/s]\r\nDownloading: 100%|██████████| 511M/511M [00:09<00:00, 55.4MB/s]2021-12-27 08:25:38.408429: W tensorflow/core/framework/cpu_allocator_impl.cc:82] Allocation of 93763584 exceeds 10% of free system memory.\r\nSome layers from the model checkpoint at bert-base-uncased were not used when initializing TFBertModel: ['mlm___cls', 'nsp___cls']\r\n- This IS expected if you are initializing TFBertModel from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).\r\n- This IS NOT expected if you are initializing TFBertModel from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).\r\nAll the layers of TFBertModel were initialized from the model checkpoint at bert-base-uncased.\r\nIf your task is similar to the task the model of the checkpoint was trained on, you can already use TFBertModel for predictions without further training.\r\n2021-12-27 08:25:39.003222: W tensorflow/core/framework/cpu_allocator_impl.cc:82] Allocation of 93763584 exceeds 10% of free system memory.\r\nDownloading: 100%|██████████| 28.0/28.0 [00:00<00:00, 21.7kB/s]\r\nDownloading: 100%|██████████| 226k/226k [00:00<00:00, 315kB/s]\r\nDownloading: 100%|██████████| 455k/455k [00:00<00:00, 506kB/s]\r\nPrediction: 100%|██████████| 1/1 [00:06<00:00,  6.26s/it]\r\n\r\n**Expected behavior**\r\nFaster inference and gpu utilization.\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- OS: Ubuntu 18.04\r\n Version \r\n- Python version - 3.8.10\r\n- Ludwig version - 0.4 tf inference (installed using pip install ludwig)\r\n","closed_by":{"login":"smiraldr","id":42693530,"node_id":"MDQ6VXNlcjQyNjkzNTMw","avatar_url":"https://avatars.githubusercontent.com/u/42693530?v=4","gravatar_id":"","url":"https://api.github.com/users/smiraldr","html_url":"https://github.com/smiraldr","followers_url":"https://api.github.com/users/smiraldr/followers","following_url":"https://api.github.com/users/smiraldr/following{/other_user}","gists_url":"https://api.github.com/users/smiraldr/gists{/gist_id}","starred_url":"https://api.github.com/users/smiraldr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smiraldr/subscriptions","organizations_url":"https://api.github.com/users/smiraldr/orgs","repos_url":"https://api.github.com/users/smiraldr/repos","events_url":"https://api.github.com/users/smiraldr/events{/privacy}","received_events_url":"https://api.github.com/users/smiraldr/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1664/timeline","performed_via_github_app":null,"state_reason":"reopened"}