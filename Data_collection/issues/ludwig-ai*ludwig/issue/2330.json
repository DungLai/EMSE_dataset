{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2330","id":1322666843,"node_id":"I_kwDOCbx2hs5O1ktb","number":2330,"title":"Unpinning Dask causes issue when saving image features to parquet","user":{"login":"geoffreyangus","id":29719151,"node_id":"MDQ6VXNlcjI5NzE5MTUx","avatar_url":"https://avatars.githubusercontent.com/u/29719151?v=4","gravatar_id":"","url":"https://api.github.com/users/geoffreyangus","html_url":"https://github.com/geoffreyangus","followers_url":"https://api.github.com/users/geoffreyangus/followers","following_url":"https://api.github.com/users/geoffreyangus/following{/other_user}","gists_url":"https://api.github.com/users/geoffreyangus/gists{/gist_id}","starred_url":"https://api.github.com/users/geoffreyangus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geoffreyangus/subscriptions","organizations_url":"https://api.github.com/users/geoffreyangus/orgs","repos_url":"https://api.github.com/users/geoffreyangus/repos","events_url":"https://api.github.com/users/geoffreyangus/events{/privacy}","received_events_url":"https://api.github.com/users/geoffreyangus/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-29T20:51:32Z","updated_at":"2022-07-29T20:51:32Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\nWhen I unpin Dask (at time of writing installing `dask==2022.7.1`), we get the following error when running `pytest tests/integration_tests/test_ray.py::test_ray_image\r\n\r\n```\r\nE                       ray.exceptions.RayTaskError(ValueError): ray::dask:('store-to-parquet-3342a5973f9b624adbc7ab7b6c59c3c3', 0) (pid=93553, ip=127.0.0.1)\r\nE                         At least one of the input arguments for this task could not be computed:\r\nE                       ray.exceptions.RayTaskError: ray::dask:('to-parquet-3342a5973f9b624adbc7ab7b6c59c3c3', 25) (pid=93553, ip=127.0.0.1)\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/ray/util/dask/scheduler.py\", line 432, in dask_task_wrapper\r\nE                           result = func(*actual_args)\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/optimization.py\", line 990, in __call__\r\nE                           return core.get(self.dsk, self.outkey, dict(zip(self.inkeys, args)))\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/core.py\", line 149, in get\r\nE                           result = _execute_task(task, cache)\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/core.py\", line 119, in _execute_task\r\nE                           return func(*(_execute_task(a, cache) for a in args))\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/dataframe/io/parquet/core.py\", line 163, in __call__\r\nE                           return self.engine.write_partition(\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/dataframe/io/parquet/arrow.py\", line 686, in write_partition\r\nE                           t = cls._pandas_to_arrow_table(df, preserve_index=preserve_index, schema=schema)\r\nE                         File \"/Users/geoffreyangus/repositories/predibase/ludwig/venv39_fresh/lib/python3.9/site-packages/dask/dataframe/io/parquet/arrow.py\", line 647, in _pandas_to_arrow_table\r\nE                           raise ValueError(\r\nE                       ValueError: Failed to convert partition to expected pyarrow schema:\r\nE                           `ArrowTypeError(\"Expected bytes, got a 'numpy.ndarray' object\", 'Conversion failed for column image_AA50B_vXMs1R with type object')`\r\nE                       \r\nE                       Expected partition schema:\r\nE                           binary_B525D_mZFLky: bool\r\nE                           image_AA50B_vXMs1R: string\r\nE                       \r\nE                       Received partition schema:\r\nE                           binary_B525D_mZFLky: bool\r\nE                           image_AA50B_vXMs1R: list<item: uint8>\r\nE                             child 0, item: uint8\r\nE                       \r\nE                       This error *may* be resolved by passing in schema information for\r\nE                       the mismatched column(s) using the `schema` keyword in `to_parquet`.\r\n```\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\n1. upgrade `dask`\r\n2. run `pytest tests/integration_tests/test_ray.py::test_ray_image`\r\n\r\n**Expected behavior**\r\nI expected to be able to save out parquet files with numpy array objects.\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- OS: MacOS 12.3.1\r\n- Python version: 3.9\r\n- Ludwig version: 0.6.dev0\r\n\r\n**Additional context**\r\nIt seems likely that this has to do with us reading images in as numpy arrays and storing them in the Dask DataFrame. We will likely need to figure out how to pass a PyArrow schema into the `dask.DataFrame.to_parquet` file that tells it to save a numpy array instead of a raw bytes object.\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2330/timeline","performed_via_github_app":null,"state_reason":null}