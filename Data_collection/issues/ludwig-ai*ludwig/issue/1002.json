{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/1002","id":739715332,"node_id":"MDU6SXNzdWU3Mzk3MTUzMzI=","number":1002,"title":"BERT-Encoder: Icorrect Jaccard calculation and differences from v0.2.1 to v0.3","user":{"login":"donfour10","id":55831555,"node_id":"MDQ6VXNlcjU1ODMxNTU1","avatar_url":"https://avatars.githubusercontent.com/u/55831555?v=4","gravatar_id":"","url":"https://api.github.com/users/donfour10","html_url":"https://github.com/donfour10","followers_url":"https://api.github.com/users/donfour10/followers","following_url":"https://api.github.com/users/donfour10/following{/other_user}","gists_url":"https://api.github.com/users/donfour10/gists{/gist_id}","starred_url":"https://api.github.com/users/donfour10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/donfour10/subscriptions","organizations_url":"https://api.github.com/users/donfour10/orgs","repos_url":"https://api.github.com/users/donfour10/repos","events_url":"https://api.github.com/users/donfour10/events{/privacy}","received_events_url":"https://api.github.com/users/donfour10/received_events","type":"User","site_admin":false},"labels":[{"id":1174068775,"node_id":"MDU6TGFiZWwxMTc0MDY4Nzc1","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/waiting%20for%20answer","name":"waiting for answer","color":"fff36b","default":false,"description":"Further information is requested"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2020-11-10T08:53:55Z","updated_at":"2020-11-25T00:25:13Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nAfter the update to Ludwig version 0.3 I'm struggeling to define a similar model as is version 0.2.1. I am trying to do a multi-label classification on text with the bert encoder.\r\n\r\nAdditionally I think that the jaccard calculation of ludwig is incorrect. When I calculate it manually I get a completely smaller numbers than the numbers calculated by ludwig. (We rebuild from github after seeing https://github.com/uber/ludwig/issues/973 hoping the issue would resolve but it seemingly did not)\r\n\r\n**To Reproduce**\r\nFirst I want to show the model definition I described in version 0.2.1:\r\n`model_definition = {\r\n    'input_features': [\r\n        {'name': 'translated_text',\r\n        'type': 'text',\r\n        'encoder': 'bert',\r\n        'config_path': '/analyst/ludwig_experiments/uncased_L-12_H-768_A-12 (1)/bert_config.json',\r\n        'checkpoint_path': '/analyst/ludwig_experiments/uncased_L-12_H-768_A-12 (1)/bert_model.ckpt',\r\n        'preprocessing': {'word_tokenizer': 'bert', 'word_vocab_file': '/analyst/ludwig_experiments/uncased_L-12_H-768_A-12 (1)/vocab.txt', 'padding_symbol': '[PAD]', 'unknown_symbol': '[UNK]'}\r\n        }\r\n    ],\r\n    'output_features': [\r\n        {'name': 'target_category',\r\n        'type': 'set',\r\n        'threshold': 0.30}\r\n    ],\r\n    'training': {'batch_size': 8, 'learning_rate': 0.00002}\r\n}`\r\n\r\nI tried several different things to reproduce this model in version 0.3. The big problems I have are, that I don't know how to use the checkpoint_path. Even the config-path throws an error when I use it as `'pretrained_model_name_or_path'` (To fix that I added `\"model_type\": \"bert\"` in the config.json of the downloaded pretrained-model).\r\n\r\nModel definition in version 0.3:\r\nI commented some code-lines becasue i tried it with them and without them. But nothing really changed.\r\n`model_definition = {\r\n    'input_features': [\r\n        {'name': 'translated_text',\r\n        'type': 'text',\r\n        'encoder': 'bert',\r\n        'pretrained_model_name_or_path': 'bert-large-uncased',\r\n         # 'trainable': True,\r\n        'preprocessing': {\r\n            # 'word_vocab_file': '/analyst/ludwig_experiments/uncased_L-12_H-768_A-12 (1)/vocab.txt',\r\n            'word_tokenizer': 'bert',\r\n            'padding_symbol': '[PAD]',\r\n            'unknown_symbol': '[UNK]'\r\n        }\r\n        }\r\n    ],\r\n    'output_features': [\r\n        {'name': 'target_category',\r\n        'type': 'set',\r\n        'threshold': 0.30}\r\n    ],\r\n    'training': {'batch_size': 8, 'learning_rate': 0.00002}\r\n}`\r\n\r\n\r\n**Expected behavior**\r\nA result which is similiar to the result wich produced in v0.2.1. F1-Score has fallen from 48 to 11. Jaccard-Similarity incresed from 32 to 52 but thats wrong. I manually calculated the jaccard and it was 8 instead of 52!\r\n\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Ubuntu\r\n - Version 19.10\r\n- Python version 3.7.5\r\n- Ludwig version 0.3 (before 0.2.1)\r\n\r\n**Additional context**\r\nSo I have several questions or assumptions:\r\nMaybe the model validate on the incorrect jaccard numbers? (I don't think so but it would explain why the actual result can't get similar my result with v0.2.1)\r\nHow can I assign my downloaded model from https://github.com/google-research/bert without using the huggingface path and model? (Even when it should be the same. I can assign the config.json (but only when i add something) and the vocab.txt but not the .ckpt-file) Is it even possible?\r\n\r\nI would be very thankful for some hints how I can ensure a similar configuration from v0.2.1 (tf1) to v0.3 (tf2). I am definitely a little lost here and don't want to downgrade ludwig and work with old version in the future.\r\n\r\nExample from training_statistics.json v0.3:\r\n![image](https://user-images.githubusercontent.com/55831555/98650912-d9da4300-2339-11eb-8878-429e42ca6c21.png)\r\nThe jaccard value is stuck directly after the first epoch. Even though the number is not correcrt.\r\n\r\nOld traning_statistics.json v0.2.1:\r\n![image](https://user-images.githubusercontent.com/55831555/98651170-33427200-233a-11eb-9200-4fa8386be879.png)\r\nHere the Jaccard values were correct and the training went through properly. ","closed_by":null,"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/1002/timeline","performed_via_github_app":null,"state_reason":null}