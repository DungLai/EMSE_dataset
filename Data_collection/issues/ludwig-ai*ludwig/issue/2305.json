{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305","repository_url":"https://api.github.com/repos/ludwig-ai/ludwig","labels_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305/labels{/name}","comments_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305/comments","events_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305/events","html_url":"https://github.com/ludwig-ai/ludwig/issues/2305","id":1315509047,"node_id":"I_kwDOCbx2hs5OaRM3","number":2305,"title":"Issue during training large image datasets related to RaySystemError failing followed by OOM","user":{"login":"arnavgarg1","id":106701836,"node_id":"U_kgDOBlwkDA","avatar_url":"https://avatars.githubusercontent.com/u/106701836?v=4","gravatar_id":"","url":"https://api.github.com/users/arnavgarg1","html_url":"https://github.com/arnavgarg1","followers_url":"https://api.github.com/users/arnavgarg1/followers","following_url":"https://api.github.com/users/arnavgarg1/following{/other_user}","gists_url":"https://api.github.com/users/arnavgarg1/gists{/gist_id}","starred_url":"https://api.github.com/users/arnavgarg1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnavgarg1/subscriptions","organizations_url":"https://api.github.com/users/arnavgarg1/orgs","repos_url":"https://api.github.com/users/arnavgarg1/repos","events_url":"https://api.github.com/users/arnavgarg1/events{/privacy}","received_events_url":"https://api.github.com/users/arnavgarg1/received_events","type":"User","site_admin":false},"labels":[{"id":1174068769,"node_id":"MDU6TGFiZWwxMTc0MDY4NzY5","url":"https://api.github.com/repos/ludwig-ai/ludwig/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":{"login":"arnavgarg1","id":106701836,"node_id":"U_kgDOBlwkDA","avatar_url":"https://avatars.githubusercontent.com/u/106701836?v=4","gravatar_id":"","url":"https://api.github.com/users/arnavgarg1","html_url":"https://github.com/arnavgarg1","followers_url":"https://api.github.com/users/arnavgarg1/followers","following_url":"https://api.github.com/users/arnavgarg1/following{/other_user}","gists_url":"https://api.github.com/users/arnavgarg1/gists{/gist_id}","starred_url":"https://api.github.com/users/arnavgarg1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnavgarg1/subscriptions","organizations_url":"https://api.github.com/users/arnavgarg1/orgs","repos_url":"https://api.github.com/users/arnavgarg1/repos","events_url":"https://api.github.com/users/arnavgarg1/events{/privacy}","received_events_url":"https://api.github.com/users/arnavgarg1/received_events","type":"User","site_admin":false},"assignees":[{"login":"arnavgarg1","id":106701836,"node_id":"U_kgDOBlwkDA","avatar_url":"https://avatars.githubusercontent.com/u/106701836?v=4","gravatar_id":"","url":"https://api.github.com/users/arnavgarg1","html_url":"https://github.com/arnavgarg1","followers_url":"https://api.github.com/users/arnavgarg1/followers","following_url":"https://api.github.com/users/arnavgarg1/following{/other_user}","gists_url":"https://api.github.com/users/arnavgarg1/gists{/gist_id}","starred_url":"https://api.github.com/users/arnavgarg1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnavgarg1/subscriptions","organizations_url":"https://api.github.com/users/arnavgarg1/orgs","repos_url":"https://api.github.com/users/arnavgarg1/repos","events_url":"https://api.github.com/users/arnavgarg1/events{/privacy}","received_events_url":"https://api.github.com/users/arnavgarg1/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-07-23T00:33:42Z","updated_at":"2022-07-25T22:20:18Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Here's the stack trace:\r\n\r\n(_shuffle_map pid=954) Traceback (most recent call last):\r\n(_shuffle_map pid=954)   File \"python/ray/_raylet.pyx\", line 726, in ray._raylet.execute_task\r\n(_shuffle_map pid=954)   File \"python/ray/_raylet.pyx\", line 727, in ray._raylet.execute_task\r\n(_shuffle_map pid=954)   File \"python/ray/_raylet.pyx\", line 2030, in ray._raylet.CoreWorker.store_task_outputs\r\n(_shuffle_map pid=954)   File \"python/ray/_raylet.pyx\", line 1968, in ray._raylet.CoreWorker.store_task_output\r\n(_shuffle_map pid=954)   File \"python/ray/_raylet.pyx\", line 173, in ray._raylet.check_status\r\n(_shuffle_map pid=954) ray.exceptions.RaySystemError: System error: Connection reset by peer\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/ray/train_ispy2.py\", line 145, in <module>\r\n    app()\r\n  File \"/home/ray/train_ispy2.py\", line 127, in app\r\n    eval_stats, train_stats, _, _ = model.experiment(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/api.py\", line 1105, in experiment\r\n    (train_stats, preprocessed_data, output_directory) = self.train(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/api.py\", line 552, in train\r\n    train_stats = trainer.train(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/backend/ray.py\", line 386, in train\r\n    results, self._validation_field, self._validation_metric = runner.run(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/trainer.py\", line 334, in run\r\n    for intermediate_result in iterator:\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/trainer.py\", line 719, in __next__\r\n    self._final_results = self._run_with_error_handling(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/trainer.py\", line 687, in _run_with_error_handling\r\n    return func()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/trainer.py\", line 791, in _finish_training\r\n    return self._backend_executor.finish_training()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/utils.py\", line 173, in <lambda>\r\n    return lambda *args, **kwargs: ray.get(actor_method.remote(*args, **kwargs))\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/_private/client_mode_hook.py\", line 105, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/worker.py\", line 1809, in get\r\n    raise value.as_instanceof_cause()\r\nray.exceptions.RayTaskError: ray::BackendExecutor.finish_training() (pid=104, ip=192.168.50.101, repr=<ray.train.backend.BackendExecutor object at 0x7f1dadfbc550>)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/backend.py\", line 544, in finish_training\r\n    results = self.get_with_failure_handling(futures)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/backend.py\", line 563, in get_with_failure_handling\r\n    success, failed_worker_indexes = check_for_failure(remote_values)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/utils.py\", line 53, in check_for_failure\r\n    ray.get(object_ref)\r\nray.exceptions.RayTaskError: ray::BaseWorkerMixin._BaseWorkerMixin__execute() (pid=191, ip=192.168.50.101, repr=<ray.train.worker_group.BaseWorkerMixin object at 0x7ef83155b340>)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/worker_group.py\", line 26, in __execute\r\n    return func(*args, **kwargs)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/backend.py\", line 535, in end_training\r\n    output = session.finish()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/session.py\", line 117, in finish\r\n    func_output = self.training_thread.join()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/utils.py\", line 101, in join\r\n    raise self.exc\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/utils.py\", line 94, in run\r\n    self.ret = self._target(*self._args, **self._kwargs)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/train/utils.py\", line 143, in <lambda>\r\n    return lambda: train_func(config)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/backend/ray.py\", line 387, in <lambda>\r\n    lambda config: train_fn(**config),\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/backend/ray.py\", line 177, in train_fn\r\n    train_shard = RayDatasetShard(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ludwig/data/dataset/ray.py\", line 161, in __init__\r\n    self.epoch_iter = dataset_shard.iter_epochs()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset_pipeline.py\", line 653, in iter_epochs\r\n    return EpochDelimitedIterator(self)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset_pipeline.py\", line 628, in __init__\r\n    self._iter = Peekable(pipe.iter_datasets())\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset_pipeline.py\", line 666, in iter_datasets\r\n    self._peek()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset_pipeline.py\", line 763, in _peek\r\n    self._dataset_iter = PipelineExecutor(self)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 36, in __init__\r\n    lambda n: pipeline_stage(n), next(self._iter)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset_pipeline.py\", line 299, in __next__\r\n    ds = ray.get(\r\nray.exceptions.RayTaskError: ray::PipelineSplitExecutorCoordinator.next_dataset_if_ready() (pid=316, ip=192.168.50.101, repr=<ray.data.impl.pipeline_executor.PipelineSplitExecutorCoordinator object at 0x7f88e014d100>)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 154, in next_dataset_if_ready\r\n    ds = next(self.executor)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 105, in __next__\r\n    result = self._stages[i].result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 432, in result\r\n    return self.__get_result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 388, in __get_result\r\n    raise self._exception\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 154, in next_dataset_if_ready\r\n    ds = next(self.executor)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 105, in __next__\r\n    result = self._stages[i].result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 432, in result\r\n    return self.__get_result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 388, in __get_result\r\n    raise self._exception\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 154, in next_dataset_if_ready\r\n    ds = next(self.executor)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 105, in __next__\r\n    result = self._stages[i].result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 432, in result\r\n    return self.__get_result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 388, in __get_result\r\n    raise self._exception\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 154, in next_dataset_if_ready\r\n    ds = next(self.executor)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 105, in __next__\r\n    result = self._stages[i].result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 432, in result\r\n    return self.__get_result()\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/_base.py\", line 388, in __get_result\r\n    raise self._exception\r\n  File \"/home/ray/anaconda3/lib/python3.8/concurrent/futures/thread.py\", line 57, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 113, in <lambda>\r\n    lambda r, fn: pipeline_stage(lambda: fn(r)),\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/pipeline_executor.py\", line 22, in pipeline_stage\r\n    return fn().fully_executed()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset.py\", line 2684, in fully_executed\r\n    blocks = self.get_internal_block_refs()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset.py\", line 2715, in get_internal_block_refs\r\n    return self._plan.execute().get_blocks()\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/plan.py\", line 127, in execute\r\n    blocks, stage_info = stage(blocks, clear_input_blocks)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/plan.py\", line 337, in __call__\r\n    blocks, stage_info = self.fn(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/dataset.py\", line 545, in do_shuffle\r\n    new_blocks, stage_info = simple_shuffle(\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/shuffle.py\", line 58, in simple_shuffle\r\n    shuffle_map_metadata = map_bar.fetch_until_complete(shuffle_map_metadata)\r\n  File \"/home/ray/anaconda3/lib/python3.8/site-packages/ray/data/impl/progress_bar.py\", line 75, in fetch_until_complete\r\n    for ref, result in zip(done, ray.get(done)):\r\nray.exceptions.RayTaskError: ray::_shuffle_map() (pid=844, ip=192.168.40.207)\r\nray.exceptions.RaySystemError: System error: Connection reset by peer\r\n(_shuffle_map pid=1170) [2022-07-25 14:35:50,169 C 1170 1170] core_worker.cc:2420: Failed to seal object 1f275a1e4928fbf1ffffffffffffffffffffffff0100000035000000 in store: Connection reset by peer\r\n(_shuffle_map pid=1170) *** StackTrace Information ***\r\n(_shuffle_map pid=1170)     ray::SpdLogMessage::Flush()\r\n(_shuffle_map pid=1170)     ray::RayLog::~RayLog()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorker::SealReturnObject()\r\n(_shuffle_map pid=1170)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_output()\r\n(_shuffle_map pid=1170)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_outputs()\r\n(_shuffle_map pid=1170)     __pyx_f_3ray_7_raylet_task_execution_handler()\r\n(_shuffle_map pid=1170)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorker::ExecuteTask()\r\n(_shuffle_map pid=1170)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorkerDirectTaskReceiver::HandleTask()::{lambda()#1}::operator()()\r\n(_shuffle_map pid=1170)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1170)     ray::core::InboundRequest::Accept()\r\n(_shuffle_map pid=1170)     ray::core::NormalSchedulingQueue::ScheduleRequests()\r\n(_shuffle_map pid=1170)     EventTracker::RecordExecution()\r\n(_shuffle_map pid=1170)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1170)     boost::asio::detail::completion_handler<>::do_complete()\r\n(_shuffle_map pid=1170)     boost::asio::detail::scheduler::do_run_one()\r\n(_shuffle_map pid=1170)     boost::asio::detail::scheduler::run()\r\n(_shuffle_map pid=1170)     boost::asio::io_context::run()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorker::RunTaskExecutionLoop()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorkerProcessImpl::RunWorkerTaskExecutionLoop()\r\n(_shuffle_map pid=1170)     ray::core::CoreWorkerProcess::RunTaskExecutionLoop()\r\n(_shuffle_map pid=1170)     __pyx_pw_3ray_7_raylet_10CoreWorker_7run_task_loop()\r\n(_shuffle_map pid=1170)     method_vectorcall_NOARGS\r\n(_shuffle_map pid=1170) \r\n(_shuffle_map pid=991) [2022-07-25 14:35:50,181 C 991 991] core_worker.cc:2420: Failed to seal object a2536ebe5df740e7ffffffffffffffffffffffff010000001c000000 in store: Connection reset by peer\r\n(_shuffle_map pid=991) *** StackTrace Information ***\r\n(_shuffle_map pid=991)     ray::SpdLogMessage::Flush()\r\n(_shuffle_map pid=991)     ray::RayLog::~RayLog()\r\n(_shuffle_map pid=991)     ray::core::CoreWorker::SealReturnObject()\r\n(_shuffle_map pid=991)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_output()\r\n(_shuffle_map pid=991)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_outputs()\r\n(_shuffle_map pid=991)     __pyx_f_3ray_7_raylet_task_execution_handler()\r\n(_shuffle_map pid=991)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=991)     ray::core::CoreWorker::ExecuteTask()\r\n(_shuffle_map pid=991)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=991)     ray::core::CoreWorkerDirectTaskReceiver::HandleTask()::{lambda()#1}::operator()()\r\n(_shuffle_map pid=991)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=991)     ray::core::InboundRequest::Accept()\r\n(_shuffle_map pid=991)     ray::core::NormalSchedulingQueue::ScheduleRequests()\r\n(_shuffle_map pid=991)     EventTracker::RecordExecution()\r\n(_shuffle_map pid=991)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=991)     boost::asio::detail::completion_handler<>::do_complete()\r\n(_shuffle_map pid=991)     boost::asio::detail::scheduler::do_run_one()\r\n(_shuffle_map pid=991)     boost::asio::detail::scheduler::run()\r\n(_shuffle_map pid=991)     boost::asio::io_context::run()\r\n(_shuffle_map pid=991)     ray::core::CoreWorker::RunTaskExecutionLoop()\r\n(_shuffle_map pid=991)     ray::core::CoreWorkerProcessImpl::RunWorkerTaskExecutionLoop()\r\n(_shuffle_map pid=991)     ray::core::CoreWorkerProcess::RunTaskExecutionLoop()\r\n(_shuffle_map pid=991)     __pyx_pw_3ray_7_raylet_10CoreWorker_7run_task_loop()\r\n(_shuffle_map pid=991)     method_vectorcall_NOARGS\r\n(_shuffle_map pid=991) \r\n(_shuffle_map pid=1139) [2022-07-25 14:35:50,185 C 1139 1139] core_worker.cc:2420: Failed to seal object 4b74334c4671a21affffffffffffffffffffffff0100000040000000 in store: Connection reset by peer\r\n(_shuffle_map pid=1139) *** StackTrace Information ***\r\n(_shuffle_map pid=1139)     ray::SpdLogMessage::Flush()\r\n(_shuffle_map pid=1139)     ray::RayLog::~RayLog()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorker::SealReturnObject()\r\n(_shuffle_map pid=1139)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_output()\r\n(_shuffle_map pid=1139)     __pyx_f_3ray_7_raylet_10CoreWorker_store_task_outputs()\r\n(_shuffle_map pid=1139)     __pyx_f_3ray_7_raylet_task_execution_handler()\r\n(_shuffle_map pid=1139)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorker::ExecuteTask()\r\n(_shuffle_map pid=1139)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorkerDirectTaskReceiver::HandleTask()::{lambda()#1}::operator()()\r\n(_shuffle_map pid=1139)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1139)     ray::core::InboundRequest::Accept()\r\n(_shuffle_map pid=1139)     ray::core::NormalSchedulingQueue::ScheduleRequests()\r\n(_shuffle_map pid=1139)     EventTracker::RecordExecution()\r\n(_shuffle_map pid=1139)     std::_Function_handler<>::_M_invoke()\r\n(_shuffle_map pid=1139)     boost::asio::detail::completion_handler<>::do_complete()\r\n(_shuffle_map pid=1139)     boost::asio::detail::scheduler::do_run_one()\r\n(_shuffle_map pid=1139)     boost::asio::detail::scheduler::run()\r\n(_shuffle_map pid=1139)     boost::asio::io_context::run()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorker::RunTaskExecutionLoop()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorkerProcessImpl::RunWorkerTaskExecutionLoop()\r\n(_shuffle_map pid=1139)     ray::core::CoreWorkerProcess::RunTaskExecutionLoop()\r\n(_shuffle_map pid=1139)     __pyx_pw_3ray_7_raylet_10CoreWorker_7run_task_loop()\r\n(_shuffle_map pid=1139)     method_vectorcall_NOARGS\r\n(_shuffle_map pid=1139) \r\ncommand terminated with exit code 137","closed_by":null,"reactions":{"url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ludwig-ai/ludwig/issues/2305/timeline","performed_via_github_app":null,"state_reason":null}