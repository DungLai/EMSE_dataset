{"url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51","repository_url":"https://api.github.com/repos/richzhang/PerceptualSimilarity","labels_url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51/labels{/name}","comments_url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51/comments","events_url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51/events","html_url":"https://github.com/richzhang/PerceptualSimilarity/issues/51","id":713893202,"node_id":"MDU6SXNzdWU3MTM4OTMyMDI=","number":51,"title":"upsample function leads to tensor size mismatch for certain input image sizes when spatial=True","user":{"login":"DanAndersen","id":2023351,"node_id":"MDQ6VXNlcjIwMjMzNTE=","avatar_url":"https://avatars.githubusercontent.com/u/2023351?v=4","gravatar_id":"","url":"https://api.github.com/users/DanAndersen","html_url":"https://github.com/DanAndersen","followers_url":"https://api.github.com/users/DanAndersen/followers","following_url":"https://api.github.com/users/DanAndersen/following{/other_user}","gists_url":"https://api.github.com/users/DanAndersen/gists{/gist_id}","starred_url":"https://api.github.com/users/DanAndersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DanAndersen/subscriptions","organizations_url":"https://api.github.com/users/DanAndersen/orgs","repos_url":"https://api.github.com/users/DanAndersen/repos","events_url":"https://api.github.com/users/DanAndersen/events{/privacy}","received_events_url":"https://api.github.com/users/DanAndersen/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-10-02T20:46:54Z","updated_at":"2021-08-26T18:23:39Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Currently, the `upsample` function is as follows:\r\n```\r\ndef upsample(in_tens, out_HW=(64,64)): # assumes scale factor is same for H and W\r\n    in_H, in_W = in_tens.shape[2], in_tens.shape[3]\r\n    scale_factor_H, scale_factor_W = 1.*out_HW[0]/in_H, 1.*out_HW[1]/in_W\r\n\r\n    return nn.Upsample(scale_factor=(scale_factor_H, scale_factor_W), mode='bilinear', align_corners=False)(in_tens)\r\n```\r\n\r\nThis ends up failing in the case where the input images being compared are of resolution 800x600. When this is the case, one of the layers passed in as `in_tens` has shape (1, 1, 149, 199). As a result, `in_H * scale_factor_H` = 600.0000000000001 and `in_W * scale_factor_W` = 799.9999999999999. The result of the `Upsample` is an output tensor of size (1,1,600,799), which leads to an exception when it is added to other tensors of size (1,1,600,800).\r\n\r\nInstead of computing the `scale_factor`, a more robust solution is to just [set the `size` parameter directly](https://pytorch.org/docs/stable/generated/torch.nn.Upsample.html):\r\n\r\n```\r\n    return nn.Upsample(size=out_HW, mode='bilinear', align_corners=False)(in_tens)\r\n```\r\n\r\nThis might also be the cause of this specific comment: https://github.com/richzhang/PerceptualSimilarity/issues/45#issuecomment-666929172","closed_by":{"login":"DanAndersen","id":2023351,"node_id":"MDQ6VXNlcjIwMjMzNTE=","avatar_url":"https://avatars.githubusercontent.com/u/2023351?v=4","gravatar_id":"","url":"https://api.github.com/users/DanAndersen","html_url":"https://github.com/DanAndersen","followers_url":"https://api.github.com/users/DanAndersen/followers","following_url":"https://api.github.com/users/DanAndersen/following{/other_user}","gists_url":"https://api.github.com/users/DanAndersen/gists{/gist_id}","starred_url":"https://api.github.com/users/DanAndersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DanAndersen/subscriptions","organizations_url":"https://api.github.com/users/DanAndersen/orgs","repos_url":"https://api.github.com/users/DanAndersen/repos","events_url":"https://api.github.com/users/DanAndersen/events{/privacy}","received_events_url":"https://api.github.com/users/DanAndersen/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/richzhang/PerceptualSimilarity/issues/51/timeline","performed_via_github_app":null,"state_reason":null}