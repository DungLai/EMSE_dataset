[{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/896878783","html_url":"https://github.com/perslev/MultiPlanarUNet/issues/24#issuecomment-896878783","issue_url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/24","id":896878783,"node_id":"IC_kwDOBvhiqc41dUi_","user":{"login":"dyollb","id":12702862,"node_id":"MDQ6VXNlcjEyNzAyODYy","avatar_url":"https://avatars.githubusercontent.com/u/12702862?v=4","gravatar_id":"","url":"https://api.github.com/users/dyollb","html_url":"https://github.com/dyollb","followers_url":"https://api.github.com/users/dyollb/followers","following_url":"https://api.github.com/users/dyollb/following{/other_user}","gists_url":"https://api.github.com/users/dyollb/gists{/gist_id}","starred_url":"https://api.github.com/users/dyollb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dyollb/subscriptions","organizations_url":"https://api.github.com/users/dyollb/orgs","repos_url":"https://api.github.com/users/dyollb/repos","events_url":"https://api.github.com/users/dyollb/events{/privacy}","received_events_url":"https://api.github.com/users/dyollb/received_events","type":"User","site_admin":false},"created_at":"2021-08-11T14:31:36Z","updated_at":"2021-08-11T14:31:36Z","author_association":"NONE","body":"The full log looks more like this:\r\n\r\n```\r\nAudit for 16 images\r\n-------------------\r\nTotal memory GiB:  1.776\r\nNumber of classes: 17\r\n\r\n2D:\r\nReal space span:   263.500\r\nSample dim:        304.000\r\n\r\n3D:\r\nSample dim:        64\r\nReal space span:   263.500\r\nBox span:          54.400\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'set_value' in 'hparams.py'\r\nSetting value '263.50000739097595' (type <class 'numpy.float64'>) in subdir 'fit' with name 'real_space_span'\r\nSetting value '304' (type <class 'numpy.int64'>) in subdir 'build' with name 'dim'\r\nSetting value '1' (type <class 'int'>) in subdir 'build' with name 'n_channels'\r\nEntry of name 'n_classes' already set in subdir 'build' with value '17'. Skipping (overwrite=False).\r\n\r\n>>> Logged by: 'save_current' in 'hparams.py'\r\nSaving current YAML configuration to file:\r\n /home/jovyan/work/results/drcmr_16/train_hparams.yaml\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: '_base_loader_func' in 'data_preparation_funcs.py'\r\nPreparing dataset ImagePairLoader(id=train, images=10, data_dir=/home/jovyan/work/data_dir/train)\r\nX10679\r\n--- loaded:     False\r\n--- shape:      [310 310 310   1]\r\n--- bg class    0\r\n--- bg value    ['1pct']\r\n--- scaler      RobustScaler\r\n--- real shape: [263.5 263.5 263.5]\r\n--- pixdim:     [0.85 0.85 0.85]\r\nX14109\r\n--- loaded:     False\r\n--- shape:      [310 310 310   1]\r\n--- bg class    0\r\n--- bg value    ['1pct']\r\n--- scaler      RobustScaler\r\n--- real shape: [263.5 263.5 263.5]\r\n--- pixdim:     [0.85 0.85 0.85]\r\n...\r\n>>> Logged by: '__init__' in 'eager_queue.py'\r\n'Eager' queue created:\r\n  Dataset:      ImagePairLoader(id=train, images=10, data_dir=/home/jovyan/work/data_dir/train)\r\nPreloading all 10 images now... (eager)\r\n'Eager' queue created:\r\n  Dataset:      ImagePairLoader(id=val, images=6, data_dir=/home/jovyan/work/data_dir/val)\r\nPreloading all 6 images now... (eager)\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'sample_random_views_with_angle_restriction' in 'sample_grid.py'\r\nGenerating 6 random views...\r\n[OBS] Weighting random views by median res: [0.85 0.85 0.85]\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'load_or_create_views' in 'data_preparation_funcs.py'\r\nView SD:     0.1\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'prepare_for_multi_view_unet' in 'data_preparation_funcs.py'\r\nViews:       N=6\r\n             [ 0.89081436 -0.42408026  0.16311258]\r\n             [ 0.43957442 -0.12374472  0.88964126]\r\n             [-0.54803847  0.1605022   0.82090979]\r\n             [ 0.03570166 -0.69000704  0.72292163]\r\n             [-0.12735015  0.93440077  0.33268173]\r\n             [-0.95791583 -0.14147684  0.24976303]\r\n\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'get_sequencers' in 'data_preparation_funcs.py'\r\nPreparing sequence objects...\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'get_sequence' in 'utils.py'\r\nUsing on-the-fly augmenters:\r\nElastic2D(alpha=[0, 450], sigma=[20, 30], apply_prob=0.333)\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'log' in 'isotrophic_live_view_sequence_2d.py'\r\n\r\nIs validation:               False\r\nUsing real space span:       263.50000739097595\r\nUsing sample dim:            304\r\nUsing real space sample res: 0.8667763401018945\r\nN fg slices:                 8\r\nBatch size:                  16\r\nForce all FG:                False\r\nNoise SD:                    0.1\r\nAugmenters:                  [Elastic2D(alpha=[0, 450], sigma=[20, 30], apply_prob=0.333)]\r\n\r\nIs validation:               True\r\nUsing real space span:       263.50000739097595\r\nUsing sample dim:            304\r\nUsing real space sample res: 0.8667763401018945\r\nN fg slices:                 8\r\nBatch size:                  16\r\nForce all FG:                False\r\nNoise SD:                    0.0\r\nAugmenters:                  None\r\nWaiting for free GPU.\r\nFound free GPU: 0\r\n2021-08-11 14:20:16.064686: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library libcuda.so.1\r\n2021-08-11 14:20:17.031107: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1716] Found device 0 with properties: \r\npciBusID: 0000:17:00.0 name: GeForce GTX 1080 Ti computeCapability: 6.\r\n\r\n...\r\n\r\n>>> Logged by: 'init_model' in 'model_init.py'\r\nCreating new model of type 'UNet'\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'log' in 'unet.py'\r\nUNet Model Summary\r\n------------------\r\nImage rows:        304\r\nImage cols:        304\r\nImage channels:    1\r\nN classes:         17\r\nCF factor:         2.000\r\nDepth:             4\r\nl2 reg:            False\r\nPadding:           same\r\nConv activation:   relu\r\nOut activation:    softmax\r\nReceptive field:   [155 155]\r\nN params:          62062642\r\nOutput:            Tensor(\"flatten_output/Reshape:0\", shape=(None, 92416, 17), dtype=float32)\r\nCrop:              None\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'set_bias_weights' in 'utils.py'\r\nOBS: Estimating class counts from 10 images\r\n/opt/conda/lib/python3.7/site-packages/mpunet/utils/utils.py:237: RuntimeWarning: divide by zero encountered in log\r\n  bias = np.log(freq * np.sum(np.exp(freq)))\r\n/opt/conda/lib/python3.7/site-packages/mpunet/utils/utils.py:238: RuntimeWarning: invalid value encountered in true_divide\r\n  bias /= np.linalg.norm(bias)\r\nSetting bias weights on output layer to:\r\n[ 0. -0. -0. -0. -0. -0. -0. -0. -0. -0.  0. -0. nan -0. -0. -0. -0.]\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'compile_model' in 'trainer.py'\r\nOptimizer:   <tensorflow.python.keras.optimizer_v2.adam.Adam object at 0x7f138c320590>\r\nLoss funcs:  [<tensorflow.python.keras.losses.SparseCategoricalCrossentropy object at 0x7f138c326950>]\r\nMetrics:     <function init_metrics at 0x7f138c172ef0>\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'save_images' in 'plotting.py'\r\nSaving 64 sample images in '<project_dir>/images' folder\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: '_fit' in 'trainer.py'\r\nUsing 157 steps per train epoch (total batches=1000000000000)\r\nUsing 219 steps per val epoch (total batches=1000000000000)\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'init_callback_objects' in 'funcs.py'\r\n[1] Using callback: Validation(params=?)\r\n[2] Using callback: MeanReduceLogArrays(params=?)\r\n[3] Using callback: ReduceLROnPlateau(patience=2, factor=0.9, verbose=1, monitor=val_dice, mode=max)\r\n[4] Using callback: TensorBoard(log_dir=./tensorboard, profile_batch=0)\r\n[5] Using callback: ModelCheckPointClean(filepath=./model/@epoch_{epoch:02d}_val_dice_{val_dice:.5f}.h5, monitor=val_dice, save_best_only=True, save_weights_only=True, verbose=1, mode=max)\r\n[6] Using callback: EarlyStopping(monitor=val_dice, min_delta=0, patience=15, verbose=1, mode=max)\r\n[7] Using callback: TrainTimer(verbose=True, logger=Logger(base_path=/home/jovyan/work/results/drcmr_16, print_to_screen=True, overwrite_existing=False, append_existing=False))\r\n[8] Using callback: CSVLogger(filename=logs/training.csv, separator=,, append=True)\r\n[9] Using callback: FGBatchBalancer(params=?)\r\n[10] Using callback: SavePredictionImages(params=?)\r\n[11] Using callback: LearningCurve(params=?)\r\n[12] Using callback: DividerLine(params=?)\r\nEpoch 1/500\r\n  1/157 [..............................] - ETA: 0s - loss: nan - sparse_categorical_accuracy: 0.7300\r\n...\r\n```","reactions":{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/896878783/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dyollb","id":12702862,"node_id":"MDQ6VXNlcjEyNzAyODYy","avatar_url":"https://avatars.githubusercontent.com/u/12702862?v=4","gravatar_id":"","url":"https://api.github.com/users/dyollb","html_url":"https://github.com/dyollb","followers_url":"https://api.github.com/users/dyollb/followers","following_url":"https://api.github.com/users/dyollb/following{/other_user}","gists_url":"https://api.github.com/users/dyollb/gists{/gist_id}","starred_url":"https://api.github.com/users/dyollb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dyollb/subscriptions","organizations_url":"https://api.github.com/users/dyollb/orgs","repos_url":"https://api.github.com/users/dyollb/repos","events_url":"https://api.github.com/users/dyollb/events{/privacy}","received_events_url":"https://api.github.com/users/dyollb/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/898262361","html_url":"https://github.com/perslev/MultiPlanarUNet/issues/24#issuecomment-898262361","issue_url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/24","id":898262361,"node_id":"IC_kwDOBvhiqc41imVZ","user":{"login":"perslev","id":12041524,"node_id":"MDQ6VXNlcjEyMDQxNTI0","avatar_url":"https://avatars.githubusercontent.com/u/12041524?v=4","gravatar_id":"","url":"https://api.github.com/users/perslev","html_url":"https://github.com/perslev","followers_url":"https://api.github.com/users/perslev/followers","following_url":"https://api.github.com/users/perslev/following{/other_user}","gists_url":"https://api.github.com/users/perslev/gists{/gist_id}","starred_url":"https://api.github.com/users/perslev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/perslev/subscriptions","organizations_url":"https://api.github.com/users/perslev/orgs","repos_url":"https://api.github.com/users/perslev/repos","events_url":"https://api.github.com/users/perslev/events{/privacy}","received_events_url":"https://api.github.com/users/perslev/received_events","type":"User","site_admin":false},"created_at":"2021-08-13T07:52:15Z","updated_at":"2021-08-13T07:52:15Z","author_association":"OWNER","body":"Hi,\r\n\r\nThanks for reporting this. Based on the log it seems that the issue is caused by a given class not being present across a sample of images used to estimate class frequencies, ultimately leading to the setting of a NaN model weight during initialisation. Specifically, I am referring to the following section of the log:\r\n\r\n```\r\n--------------------------------------------------------------------------------\r\n>>> Logged by: 'set_bias_weights' in 'utils.py'\r\nOBS: Estimating class counts from 10 images\r\n/opt/conda/lib/python3.7/site-packages/mpunet/utils/utils.py:237: RuntimeWarning: divide by zero encountered in log\r\n  bias = np.log(freq * np.sum(np.exp(freq)))\r\n/opt/conda/lib/python3.7/site-packages/mpunet/utils/utils.py:238: RuntimeWarning: invalid value encountered in true_divide\r\n  bias /= np.linalg.norm(bias)\r\nSetting bias weights on output layer to:\r\n[ 0. -0. -0. -0. -0. -0. -0. -0. -0. -0.  0. -0. nan -0. -0. -0. -0.]\r\n--------------------------------------------------------------------------------\r\n```\r\n\r\nI will fix this issue in 1 or 2 weeks when I am back from other activities. Until then, could you please try and set the `biased_output_layer` variable to `False` in the `train_hparams.yaml` parameter file and re-run training to verify that this is indeed the issue? See:\r\n\r\nhttps://github.com/perslev/MultiPlanarUNet/blob/master/mpunet/bin/defaults/MultiPlanar/train_hparams.yaml#L86\r\n\r\nCheers,\r\nMathias","reactions":{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/898262361/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"perslev","id":12041524,"node_id":"MDQ6VXNlcjEyMDQxNTI0","avatar_url":"https://avatars.githubusercontent.com/u/12041524?v=4","gravatar_id":"","url":"https://api.github.com/users/perslev","html_url":"https://github.com/perslev","followers_url":"https://api.github.com/users/perslev/followers","following_url":"https://api.github.com/users/perslev/following{/other_user}","gists_url":"https://api.github.com/users/perslev/gists{/gist_id}","starred_url":"https://api.github.com/users/perslev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/perslev/subscriptions","organizations_url":"https://api.github.com/users/perslev/orgs","repos_url":"https://api.github.com/users/perslev/repos","events_url":"https://api.github.com/users/perslev/events{/privacy}","received_events_url":"https://api.github.com/users/perslev/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/900311821","html_url":"https://github.com/perslev/MultiPlanarUNet/issues/24#issuecomment-900311821","issue_url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/24","id":900311821,"node_id":"IC_kwDOBvhiqc41qasN","user":{"login":"dyollb","id":12702862,"node_id":"MDQ6VXNlcjEyNzAyODYy","avatar_url":"https://avatars.githubusercontent.com/u/12702862?v=4","gravatar_id":"","url":"https://api.github.com/users/dyollb","html_url":"https://github.com/dyollb","followers_url":"https://api.github.com/users/dyollb/followers","following_url":"https://api.github.com/users/dyollb/following{/other_user}","gists_url":"https://api.github.com/users/dyollb/gists{/gist_id}","starred_url":"https://api.github.com/users/dyollb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dyollb/subscriptions","organizations_url":"https://api.github.com/users/dyollb/orgs","repos_url":"https://api.github.com/users/dyollb/repos","events_url":"https://api.github.com/users/dyollb/events{/privacy}","received_events_url":"https://api.github.com/users/dyollb/received_events","type":"User","site_admin":false},"created_at":"2021-08-17T13:45:00Z","updated_at":"2021-08-17T19:32:38Z","author_association":"NONE","body":"At some point I realized that my dataset has no label 12, i.e. label=12 never is used.\r\nAfter fixing it in the data the model is now learning...\r\n\r\nSo the reason for the nan (at position 12 of the weights) was this missing label.","reactions":{"url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/comments/900311821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dyollb","id":12702862,"node_id":"MDQ6VXNlcjEyNzAyODYy","avatar_url":"https://avatars.githubusercontent.com/u/12702862?v=4","gravatar_id":"","url":"https://api.github.com/users/dyollb","html_url":"https://github.com/dyollb","followers_url":"https://api.github.com/users/dyollb/followers","following_url":"https://api.github.com/users/dyollb/following{/other_user}","gists_url":"https://api.github.com/users/dyollb/gists{/gist_id}","starred_url":"https://api.github.com/users/dyollb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dyollb/subscriptions","organizations_url":"https://api.github.com/users/dyollb/orgs","repos_url":"https://api.github.com/users/dyollb/repos","events_url":"https://api.github.com/users/dyollb/events{/privacy}","received_events_url":"https://api.github.com/users/dyollb/received_events","type":"User","site_admin":false}},{"id":5169068079,"node_id":"MDExOkNsb3NlZEV2ZW50NTE2OTA2ODA3OQ==","url":"https://api.github.com/repos/perslev/MultiPlanarUNet/issues/events/5169068079","actor":{"login":"dyollb","id":12702862,"node_id":"MDQ6VXNlcjEyNzAyODYy","avatar_url":"https://avatars.githubusercontent.com/u/12702862?v=4","gravatar_id":"","url":"https://api.github.com/users/dyollb","html_url":"https://github.com/dyollb","followers_url":"https://api.github.com/users/dyollb/followers","following_url":"https://api.github.com/users/dyollb/following{/other_user}","gists_url":"https://api.github.com/users/dyollb/gists{/gist_id}","starred_url":"https://api.github.com/users/dyollb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dyollb/subscriptions","organizations_url":"https://api.github.com/users/dyollb/orgs","repos_url":"https://api.github.com/users/dyollb/repos","events_url":"https://api.github.com/users/dyollb/events{/privacy}","received_events_url":"https://api.github.com/users/dyollb/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-08-17T13:45:00Z","state_reason":null,"performed_via_github_app":null}]