{"url":"https://api.github.com/repos/roclark/sportsipy/issues/609","repository_url":"https://api.github.com/repos/roclark/sportsipy","labels_url":"https://api.github.com/repos/roclark/sportsipy/issues/609/labels{/name}","comments_url":"https://api.github.com/repos/roclark/sportsipy/issues/609/comments","events_url":"https://api.github.com/repos/roclark/sportsipy/issues/609/events","html_url":"https://github.com/roclark/sportsipy/issues/609","id":857532932,"node_id":"MDU6SXNzdWU4NTc1MzI5MzI=","number":609,"title":"Utilize a persistent requests.Session when calling PyQuery so you reuse the same TCP connection for every request.","user":{"login":"dephekt","id":7564683,"node_id":"MDQ6VXNlcjc1NjQ2ODM=","avatar_url":"https://avatars.githubusercontent.com/u/7564683?v=4","gravatar_id":"","url":"https://api.github.com/users/dephekt","html_url":"https://github.com/dephekt","followers_url":"https://api.github.com/users/dephekt/followers","following_url":"https://api.github.com/users/dephekt/following{/other_user}","gists_url":"https://api.github.com/users/dephekt/gists{/gist_id}","starred_url":"https://api.github.com/users/dephekt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dephekt/subscriptions","organizations_url":"https://api.github.com/users/dephekt/orgs","repos_url":"https://api.github.com/users/dephekt/repos","events_url":"https://api.github.com/users/dephekt/events{/privacy}","received_events_url":"https://api.github.com/users/dephekt/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-04-14T05:26:14Z","updated_at":"2021-04-14T05:28:08Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"**Is your feature request related to a problem? Please describe.**\r\nYou are not creating and reusing a persistent `requests.Session()` and passing that to PyQuery, so e.g. every box score retrieval is renegotiating a fresh TCP connection for every request which is impacting performance in a non-trivial way. Using sessions is generally accepted as the proper way to leverage the requests library in production when you're making many requests, but PyQuery also doesn't do a good job of telling you that it can handle sessions (I had to look at its source to check if it even supported it), so I imagine this was just a design oversight when this library was first created.\r\n\r\n**Describe the solution you'd like**\r\nPyQuery [supports](https://github.com/gawel/pyquery/blob/1.4.3/pyquery/openers.py#L47-L49) passing a `requests.Session()` object as a kwarg `session=<Session>` when instantiating a PyQuery object. If you do this, PyQuery will pull the `get()` method from that Session object to make its request so that TCP session is reused for subsequent requests.\r\n\r\nIdeally, you'd create a `self.session = requests.Session()` attribute at the very beginning of the Schedule init method and then pass that as an argument anytime you're calling PyQuery and in any other classes used by Schedule and any helper functions (e.g. in the utils package) where you ultimately end up calling PyQuery, e.g. `schedule.Game`, `boxscore.Boxscore`, `utils._get_stats_table`, etc.\r\n\r\nThis would take some non-trivial refactoring to allow those other classes and functions where you call `pq()` to be able to accept a `session` argument, but you'd get significant performance gains particularly for folks that are iterating on all the teams in the given sport.\r\n\r\n**Describe alternatives you've considered**\r\nThe alternative is doing nothing and making hundreds of unnecessary TCP connections and limiting performance unnecessarily.\r\n\r\n**Additional Context**\r\nhttps://docs.python-requests.org/en/master/user/advanced/#session-objects\r\nhttps://pyquery.readthedocs.io/en/latest/scrap.html#session","closed_by":null,"reactions":{"url":"https://api.github.com/repos/roclark/sportsipy/issues/609/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/roclark/sportsipy/issues/609/timeline","performed_via_github_app":null,"state_reason":null}