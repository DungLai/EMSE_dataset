{"url":"https://api.github.com/repos/JayYip/m3tl/issues/44","repository_url":"https://api.github.com/repos/JayYip/m3tl","labels_url":"https://api.github.com/repos/JayYip/m3tl/issues/44/labels{/name}","comments_url":"https://api.github.com/repos/JayYip/m3tl/issues/44/comments","events_url":"https://api.github.com/repos/JayYip/m3tl/issues/44/events","html_url":"https://github.com/JayYip/m3tl/issues/44","id":630840359,"node_id":"MDU6SXNzdWU2MzA4NDAzNTk=","number":44,"title":"ValueError: The two structures don't have the same nested structure","user":{"login":"nefujiangping","id":16358182,"node_id":"MDQ6VXNlcjE2MzU4MTgy","avatar_url":"https://avatars.githubusercontent.com/u/16358182?v=4","gravatar_id":"","url":"https://api.github.com/users/nefujiangping","html_url":"https://github.com/nefujiangping","followers_url":"https://api.github.com/users/nefujiangping/followers","following_url":"https://api.github.com/users/nefujiangping/following{/other_user}","gists_url":"https://api.github.com/users/nefujiangping/gists{/gist_id}","starred_url":"https://api.github.com/users/nefujiangping/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nefujiangping/subscriptions","organizations_url":"https://api.github.com/users/nefujiangping/orgs","repos_url":"https://api.github.com/users/nefujiangping/repos","events_url":"https://api.github.com/users/nefujiangping/events{/privacy}","received_events_url":"https://api.github.com/users/nefujiangping/received_events","type":"User","site_admin":false},"labels":[{"id":1144081006,"node_id":"MDU6TGFiZWwxMTQ0MDgxMDA2","url":"https://api.github.com/repos/JayYip/m3tl/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"JayYip","id":15050572,"node_id":"MDQ6VXNlcjE1MDUwNTcy","avatar_url":"https://avatars.githubusercontent.com/u/15050572?v=4","gravatar_id":"","url":"https://api.github.com/users/JayYip","html_url":"https://github.com/JayYip","followers_url":"https://api.github.com/users/JayYip/followers","following_url":"https://api.github.com/users/JayYip/following{/other_user}","gists_url":"https://api.github.com/users/JayYip/gists{/gist_id}","starred_url":"https://api.github.com/users/JayYip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JayYip/subscriptions","organizations_url":"https://api.github.com/users/JayYip/orgs","repos_url":"https://api.github.com/users/JayYip/repos","events_url":"https://api.github.com/users/JayYip/events{/privacy}","received_events_url":"https://api.github.com/users/JayYip/received_events","type":"User","site_admin":false},"assignees":[{"login":"JayYip","id":15050572,"node_id":"MDQ6VXNlcjE1MDUwNTcy","avatar_url":"https://avatars.githubusercontent.com/u/15050572?v=4","gravatar_id":"","url":"https://api.github.com/users/JayYip","html_url":"https://github.com/JayYip","followers_url":"https://api.github.com/users/JayYip/followers","following_url":"https://api.github.com/users/JayYip/following{/other_user}","gists_url":"https://api.github.com/users/JayYip/gists{/gist_id}","starred_url":"https://api.github.com/users/JayYip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JayYip/subscriptions","organizations_url":"https://api.github.com/users/JayYip/orgs","repos_url":"https://api.github.com/users/JayYip/repos","events_url":"https://api.github.com/users/JayYip/events{/privacy}","received_events_url":"https://api.github.com/users/JayYip/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2020-06-04T13:46:50Z","updated_at":"2020-06-07T06:18:32Z","closed_at":"2020-06-07T06:11:40Z","author_association":"NONE","active_lock_reason":null,"body":"抱歉又来打扰您。训练**多个任务，freeze_step设置为>0时**，会报一个如题所述的异常；自己尝试调试，但最终未能解决，希望能得到你的建议。\r\n\r\n环境：\r\n\r\n- python 3.6\r\n- tensorflow-gpu 1.15.0 (pip install bert-multitask-learning 之后，运行示例，提示需要tensorflow版本>=1.14，故升级为1.15了)\r\n\r\n何时遇到 ValueError：\r\n\r\n- 训练单个problem，freeze_step设置为0 或者>0，均没有报异常\r\n- 训练两个problem ('cls|seq_tag')，freeze_step设置为0没有报异常，但是设置为>0，就报ValueError异常\r\n- 异常显示是IndexedSlicesSpec不匹配，具体Traceback如下\r\n\r\n\r\nTraceback (most recent call last):\r\n  File \"debug_freeze.py\", line 161, in <module>\r\n    model_dir=model_dir)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/bert_multitask_learning/**run_bert_multitask.py**\", line 126, in **train_bert_multitask**\r\n    train_and_evaluate(estimator, train_spec, eval_spec)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/training.py\", line 473, in train_and_evaluate\r\n    return executor.run()\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/training.py\", line 613, in run\r\n    return self.run_local()\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/training.py\", line 714, in run_local\r\n    saving_listeners=saving_listeners)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 370, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1159, in _train_model\r\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1222, in _train_model_distributed\r\n    self._config._train_distribute, input_fn, hooks, saving_listeners)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1302, in _actual_train_model_distributed\r\n    self.config))\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/distribute/distribute_lib.py\", line 1810, in call_for_each_replica\r\n    return self._call_for_each_replica(fn, args, kwargs)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/distribute/mirrored_strategy.py\", line 662, in _call_for_each_replica\r\n    fn, args, kwargs)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/distribute/mirrored_strategy.py\", line 196, in _call_for_each_replica\r\n    coord.join(threads)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/training/coordinator.py\", line 389, in join\r\n    six.reraise(*self._exc_info_to_raise)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/six.py\", line 703, in reraise\r\n    raise value\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/training/coordinator.py\", line 297, in stop_on_exception\r\n    yield\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/distribute/mirrored_strategy.py\", line 880, in run\r\n    self.main_result = self.main_fn(*self.main_args, **self.main_kwargs)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1149, in _call_model_fn\r\n    model_fn_results = self._model_fn(features=features, **kwargs)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/bert_multitask_learning/**model_fn.py**\", line 496, in model_fn\r\n    features, hidden_feature, loss_eval_pred, mode, warm_start)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/bert_multitask_learning/model_fn.py\", line 457, in create_spec\r\n    train_scaffold)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/bert_multitask_learning/model_fn.py\", line 384, in **create_train_spec\r\n    aggregation_method=tf.AggregationMethod.EXPERIMENTAL_TREE)**\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/gradients_impl.py\", line 158, in gradients\r\n    unconnected_gradients)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/gradients_util.py\", line 679, in _GradientsHelper\r\n    lambda: grad_fn(op, *out_grads))\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/gradients_util.py\", line 350, in _MaybeCompile\r\n    return grad_fn()  # Exit early\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/gradients_util.py\", line 679, in <lambda>\r\n    lambda: grad_fn(op, *out_grads))\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/control_flow_grad.py\", line 84, in _SwitchGrad\r\n    return merge(grad, name=\"cond_grad\")[0], None\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/ops/control_flow_ops.py\", line 413, in merge\r\n    nest.assert_same_structure(inputs[0], v, expand_composites=True)\r\n  File \"/home/jp/anaconda3/envs/jp_test/lib/python3.6/site-packages/tensorflow_core/python/util/nest.py\", line 326, in assert_same_structure\r\n    % (str(e), str1, str2))\r\nValueError: The two structures don't have the same nested structure.\r\n\r\nFirst structure: type=IndexedSlices str=IndexedSlices(indices=Tensor(\"gradients/cond/Merge_grad/cond_grad/Switch_1:0\", shape=(?,), dtype=int64, device=/replica:0/task:0/device:GPU:0), values=Tensor(\"gradients/cond/Merge_grad/cond_grad/Switch:0\", shape=(?, ?, 768), dtype=float32, device=/replica:0/task:0/device:GPU:0), dense_shape=Tensor(\"gradients/cond/Merge_grad/cond_grad/Switch_2:0\", shape=(3,), dtype=int64, device=/replica:0/task:0/device:GPU:0))\r\n\r\nSecond structure: type=IndexedSlices str=IndexedSlices(indices=Tensor(\"gradients/cond/Switch_1_grad/cond_grad/Cast:0\", shape=(?,), dtype=int64, device=/replica:0/task:0/device:GPU:0), values=Tensor(\"gradients/zeros:0\", shape=(?, ?, 768), dtype=float32, device=/replica:0/task:0/device:GPU:0), dense_shape=Tensor(\"gradients/cond/Switch_1_grad/cond_grad/Shape:0\", shape=(3,), dtype=int32, device=/replica:0/task:0/device:GPU:0))\r\n\r\nMore specifically: Incompatible CompositeTensor TypeSpecs: type=IndexedSlicesSpec str=IndexedSlicesSpec(TensorShape([Dimension(None), Dimension(None), Dimension(768)]), tf.float32, tf.int64, **tf.int64**, TensorShape([Dimension(None)])) vs. type=IndexedSlicesSpec str=IndexedSlicesSpec(TensorShape([Dimension(None), Dimension(None), Dimension(768)]), tf.float32, tf.int64, **tf.int32**, TensorShape([Dimension(None)]))\r\nEntire first structure:\r\n.\r\nEntire second structure:\r\n.\r\n\r\n","closed_by":{"login":"JayYip","id":15050572,"node_id":"MDQ6VXNlcjE1MDUwNTcy","avatar_url":"https://avatars.githubusercontent.com/u/15050572?v=4","gravatar_id":"","url":"https://api.github.com/users/JayYip","html_url":"https://github.com/JayYip","followers_url":"https://api.github.com/users/JayYip/followers","following_url":"https://api.github.com/users/JayYip/following{/other_user}","gists_url":"https://api.github.com/users/JayYip/gists{/gist_id}","starred_url":"https://api.github.com/users/JayYip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JayYip/subscriptions","organizations_url":"https://api.github.com/users/JayYip/orgs","repos_url":"https://api.github.com/users/JayYip/repos","events_url":"https://api.github.com/users/JayYip/events{/privacy}","received_events_url":"https://api.github.com/users/JayYip/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/JayYip/m3tl/issues/44/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/JayYip/m3tl/issues/44/timeline","performed_via_github_app":null,"state_reason":"completed"}