{"url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45","repository_url":"https://api.github.com/repos/GantMan/nsfw_model","labels_url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45/labels{/name}","comments_url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45/comments","events_url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45/events","html_url":"https://github.com/GantMan/nsfw_model/issues/45","id":537625577,"node_id":"MDU6SXNzdWU1Mzc2MjU1Nzc=","number":45,"title":"Generate tagged saved_model.pd incl variables for Go (Mobilenet v2 224)","user":{"login":"lastzero","id":301686,"node_id":"MDQ6VXNlcjMwMTY4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/301686?v=4","gravatar_id":"","url":"https://api.github.com/users/lastzero","html_url":"https://github.com/lastzero","followers_url":"https://api.github.com/users/lastzero/followers","following_url":"https://api.github.com/users/lastzero/following{/other_user}","gists_url":"https://api.github.com/users/lastzero/gists{/gist_id}","starred_url":"https://api.github.com/users/lastzero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lastzero/subscriptions","organizations_url":"https://api.github.com/users/lastzero/orgs","repos_url":"https://api.github.com/users/lastzero/repos","events_url":"https://api.github.com/users/lastzero/events{/privacy}","received_events_url":"https://api.github.com/users/lastzero/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-12-13T15:55:35Z","updated_at":"2019-12-30T12:48:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"We're working on a private cloud solution for personal photo management, see https://github.com/photoprism/photoprism\r\n\r\nIn order to enable uploading in our [demo](https://demo.photoprism.org/) again, I would like to add a NSFW filter based on TensorFlow. Your model looks promising, however I spent the whole day converting it to the right format and failed... either the output directory does not contain \"variables.index\" or the .pb can not be created because of too many / not enough layers, input parameters or output values. TF for Go strictly requires a tagged .pb file, we can not use the one that is offered for download.\r\n\r\nThis script worked for us to export Nasnet:\r\n\r\n```\r\nimport keras\r\nfrom keras.applications.nasnet import NASNetMobile\r\nfrom keras.preprocessing import image\r\nfrom keras.applications.xception import preprocess_input, decode_predictions\r\nimport numpy as np\r\nimport tensorflow as tf\r\nfrom keras import backend as K\r\nimport json\r\nimport os\r\nimport sys\r\n\r\nif not os.path.isfile(\"NASNet-mobile.h5\"):\r\n    os.system(\"curl -L -o NASNet-mobile.h5 http://modeldepot.io/assets/uploads/models/models/09a9e3fd-ebf0-46d4-bd5d-8be69d80cf44_NASNet-mobile.h5\")\r\n\r\nif len(sys.argv[1:]) > 0:\r\n    modelName = sys.argv[1]\r\nelse:\r\n    modelName = \"nasnet-mobile\"\r\n\r\nsess = tf.Session()\r\nK.set_session(sess)\r\n\r\nmodel = NASNetMobile(weights=\"NASNet-mobile.h5\")\r\nimg = image.load_img('gorge.jpg', target_size=(224,224)) #note the input size\r\nimg_arr = np.expand_dims(image.img_to_array(img), axis=0)\r\nx = preprocess_input(img_arr)\r\n\r\npreds = model.predict(x)\r\nprint('Predicted:', decode_predictions(preds, top=3)[0])\r\n\r\nprint('input: ', model.input)\r\nprint('output: ', model.output)\r\n\r\n# Use TF to save the graph model instead of Keras save model to load it in Golang\r\nbuilder = tf.saved_model.builder.SavedModelBuilder(modelName)\r\n# Tag the model, required for Go\r\nbuilder.add_meta_graph_and_variables(sess, [\"photoprism\"])\r\nbuilder.save()\r\nsess.close()\r\n```\r\n\r\nSimply replacing `NASNetMobile` with `MobileNetV2` +  `nsfw_mobilenet2.224x224.h5` didn't work (layer mismatch, I think this has ~107 and MobileNetV2 has about 105).\r\n\r\nWhen using your code (here in this repository) to load the model, the error when saving is:\r\n\r\n\"FailedPreconditionError (see above for traceback): Attempting to use uninitialized value SGD_1/decay\"\r\n\r\nDocker is used as runtime environment - maybe we need other versions of TF or Keras?\r\n\r\n```\r\n#!/usr/bin/env sh\r\n\r\ndocker run -ti \\\r\n       -v ${PWD}:/nsfw \\\r\n       -w /nsfw \\\r\n       -u $(id -u):$(id -g) \\\r\n       gildasch/tensorflow-keras \\\r\n       python save.py\r\n```\r\n\r\nOur code for running inference (once we have a working model):\r\nhttps://github.com/photoprism/photoprism/blob/develop/internal/photoprism/tensorflow.go\r\n\r\nWould be amazing if somebody can give us a hint! üëç \r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/GantMan/nsfw_model/issues/45/timeline","performed_via_github_app":null,"state_reason":null}