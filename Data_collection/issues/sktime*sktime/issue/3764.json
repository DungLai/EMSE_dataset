{"url":"https://api.github.com/repos/sktime/sktime/issues/3764","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/3764/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/3764/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/3764/events","html_url":"https://github.com/sktime/sktime/issues/3764","id":1445363479,"node_id":"I_kwDOCVKAsc5WJn8X","number":3764,"title":"[BUG] `ColumnEnsembleForecaster` fails with hierarchical exogenous data","user":{"login":"RikStarmans","id":109525630,"node_id":"U_kgDOBoc6fg","avatar_url":"https://avatars.githubusercontent.com/u/109525630?v=4","gravatar_id":"","url":"https://api.github.com/users/RikStarmans","html_url":"https://github.com/RikStarmans","followers_url":"https://api.github.com/users/RikStarmans/followers","following_url":"https://api.github.com/users/RikStarmans/following{/other_user}","gists_url":"https://api.github.com/users/RikStarmans/gists{/gist_id}","starred_url":"https://api.github.com/users/RikStarmans/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RikStarmans/subscriptions","organizations_url":"https://api.github.com/users/RikStarmans/orgs","repos_url":"https://api.github.com/users/RikStarmans/repos","events_url":"https://api.github.com/users/RikStarmans/events{/privacy}","received_events_url":"https://api.github.com/users/RikStarmans/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3105906374,"node_id":"MDU6TGFiZWwzMTA1OTA2Mzc0","url":"https://api.github.com/repos/sktime/sktime/labels/module:forecasting","name":"module:forecasting","color":"35FCCE","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-11-11T11:50:41Z","updated_at":"2022-11-12T20:12:49Z","closed_at":"2022-11-12T20:12:49Z","author_association":"NONE","active_lock_reason":null,"body":"ColumnEnsembleForecaster fails with Aggregator based forecaster and exogenous data.\r\n\r\n**To Reproduce**\r\n\r\n```python\r\nfrom sktime.datatypes import get_examples\r\nfrom sktime.datatypes._utilities import get_window\r\nfrom sktime.forecasting.sarimax import SARIMAX\r\nfrom sktime.transformations.hierarchical.aggregate import Aggregator\r\nfrom sktime.transformations.hierarchical.reconcile import Reconciler\r\nfrom sktime.forecasting.compose import ColumnEnsembleForecaster\r\n\r\nX = get_examples(\"pd_multiindex_hier\")[0]\r\ny = get_examples(\"pd_multiindex_hier\")[1]\r\n\r\nX_train = get_window(X, lag=1)\r\ny_train = get_window(y, lag=1)\r\nX_test = get_window(X, window_length=1)\r\n\r\nf = Aggregator() * (Aggregator() ** SARIMAX()) * Reconciler()\r\n\r\nf.fit(y=y_train, X=X_train, fh=1)\r\nprint('this works')\r\n\r\nf_hat = ColumnEnsembleForecaster(f)\r\nf_hat.fit(y=y_train, fh=1)\r\nprint(\"still working\")\r\nf_hat.fit(y=y_train, X=X_train, fh=1)\r\nprint(\"never reached, crash\")\r\n```\r\n**Proposed Solution**\r\nAdd the following tag to ColumnEnsembleForecaster\r\n```python\r\n   X_inner_mtype: [\r\n            \"pd.Series\",\r\n            \"pd.DataFrame\",\r\n            \"pd-multiindex\",\r\n            \"pd_multiindex_hier\",\r\n        ],\r\n```\r\n**Additional context**\r\nColumnEnsembleForecaster inherits from _HeterogenousEnsembleForecaster which inherits from\r\nBaseForecaster.\r\nIf fit is called with exogenous data, the BaseForecaster changes the type of both X and Y to vector.\r\nThe problem is triggered here https://github.com/sktime/sktime/blob/18b502e969d9c8d8dafce5cea78eb0c43fe23d91/sktime/forecasting/base/_base.py#L288\r\nAnd can be resolved by replacing this line with\r\n```python\r\n#X_inner, y_inner = self._check_X_y(X=X, y=y)\r\nX_inner, y_inner = X, y\r\n```\r\nCheck_X_y seems to run into issues at this line\r\nhttps://github.com/sktime/sktime/blob/18b502e969d9c8d8dafce5cea78eb0c43fe23d91/sktime/forecasting/base/_base.py#L1331\r\nIf an X is passed, vectorization is triggered for both X and y.\r\nIn specific, in line \r\nhttps://github.com/sktime/sktime/blob/18b502e969d9c8d8dafce5cea78eb0c43fe23d91/sktime/forecasting/base/_base.py#L1249\r\nWe have for y and X.\r\n1249 ['pd.DataFrame', 'pd-multiindex', 'pd_multiindex_hier']\r\n1250 ['pd.DataFrame']\r\n1251 ['Series', 'Hierarchical', 'Panel']\r\n1252 ['Series']\r\nHierachical exists for y but not for X which triggers vectorization.\r\n\r\n**Versions**\r\nsktime.__version__ = '0.14.0'\r\n\r\n","closed_by":{"login":"fkiraly","id":7985502,"node_id":"MDQ6VXNlcjc5ODU1MDI=","avatar_url":"https://avatars.githubusercontent.com/u/7985502?v=4","gravatar_id":"","url":"https://api.github.com/users/fkiraly","html_url":"https://github.com/fkiraly","followers_url":"https://api.github.com/users/fkiraly/followers","following_url":"https://api.github.com/users/fkiraly/following{/other_user}","gists_url":"https://api.github.com/users/fkiraly/gists{/gist_id}","starred_url":"https://api.github.com/users/fkiraly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkiraly/subscriptions","organizations_url":"https://api.github.com/users/fkiraly/orgs","repos_url":"https://api.github.com/users/fkiraly/repos","events_url":"https://api.github.com/users/fkiraly/events{/privacy}","received_events_url":"https://api.github.com/users/fkiraly/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/3764/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/3764/timeline","performed_via_github_app":null,"state_reason":"completed"}