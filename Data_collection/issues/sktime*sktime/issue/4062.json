{"url":"https://api.github.com/repos/sktime/sktime/issues/4062","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/4062/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/4062/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/4062/events","html_url":"https://github.com/sktime/sktime/issues/4062","id":1519465357,"node_id":"I_kwDOCVKAsc5akTON","number":4062,"title":"[ENH] Improve the handling of `CategoricalIndex` type when handling panel and hierarchical data.","user":{"login":"KishManani","id":30973056,"node_id":"MDQ6VXNlcjMwOTczMDU2","avatar_url":"https://avatars.githubusercontent.com/u/30973056?v=4","gravatar_id":"","url":"https://api.github.com/users/KishManani","html_url":"https://github.com/KishManani","followers_url":"https://api.github.com/users/KishManani/followers","following_url":"https://api.github.com/users/KishManani/following{/other_user}","gists_url":"https://api.github.com/users/KishManani/gists{/gist_id}","starred_url":"https://api.github.com/users/KishManani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KishManani/subscriptions","organizations_url":"https://api.github.com/users/KishManani/orgs","repos_url":"https://api.github.com/users/KishManani/repos","events_url":"https://api.github.com/users/KishManani/events{/privacy}","received_events_url":"https://api.github.com/users/KishManani/received_events","type":"User","site_admin":false},"labels":[{"id":3105907331,"node_id":"MDU6TGFiZWwzMTA1OTA3MzMx","url":"https://api.github.com/repos/sktime/sktime/labels/module:transformations","name":"module:transformations","color":"0865AF","default":false,"description":""},{"id":3796180314,"node_id":"LA_kwDOCVKAsc7iRR1a","url":"https://api.github.com/repos/sktime/sktime/labels/enhancement","name":"enhancement","color":"fef2c0","default":true,"description":"Adding new functionality"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-01-04T19:23:32Z","updated_at":"2023-01-12T15:12:08Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Related to: https://github.com/sktime/sktime/pull/4061 & https://github.com/sktime/sktime/pull/3935.  In these checks we are doing operations such as: `time_grp = time_obj.groupby(level=0, group_keys=True, as_index=True)`. I've encountered an edge case when the outer index is of type `CategoricalIndex`, doing a `groupby` operation will return a result for all categories, even those categories which are not present in the dataframe. I noticed a slowdown when using `WindowSummarizer` on a panel dataframe where I had a `CategoricalIndex` despite sampling to a few time series instances, I believe that this is caused by the fact that there was a very large number of categories (i.e., time series instances). The latency disappeared when I converted the `CategoricalIndex`'s categories to just an integer index. This means that any `groupby` operations in the checks and also in `transform` (in the case of `WindowSummarizer`) are actually returning a much larger number of rows than expected (`WindowSummarizer` filters these rows out because it does `Xt_return = Xt_return.loc[idx]`, so the user doesn't know that a lot of unneccesary rows were computed). It is common to use the `categorical` type in `pandas` to be more memory efficient. \r\n\r\nPotential fixes are:\r\n1) Do nothing. Users should introduce a pre-processing step where they remove unused categories in the `CategoricalIndex` before using any `sktime` transformers. \r\n2) Use the `observed=True` argument in `groupby`, so that the `groupby` does not return values for categories that are not in the dataframe.\r\n3) Perform some checks on the index and warn the user. \r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/4062/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/4062/timeline","performed_via_github_app":null,"state_reason":null}