{"url":"https://api.github.com/repos/sktime/sktime/issues/1426","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/1426/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/1426/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/1426/events","html_url":"https://github.com/sktime/sktime/issues/1426","id":999332150,"node_id":"I_kwDOCVKAsc47kJk2","number":1426,"title":"[BUG] BATS/TBATS multiprocessing crashing when n_jobs!=1","user":{"login":"IlyasMoutawwakil","id":57442720,"node_id":"MDQ6VXNlcjU3NDQyNzIw","avatar_url":"https://avatars.githubusercontent.com/u/57442720?v=4","gravatar_id":"","url":"https://api.github.com/users/IlyasMoutawwakil","html_url":"https://github.com/IlyasMoutawwakil","followers_url":"https://api.github.com/users/IlyasMoutawwakil/followers","following_url":"https://api.github.com/users/IlyasMoutawwakil/following{/other_user}","gists_url":"https://api.github.com/users/IlyasMoutawwakil/gists{/gist_id}","starred_url":"https://api.github.com/users/IlyasMoutawwakil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/IlyasMoutawwakil/subscriptions","organizations_url":"https://api.github.com/users/IlyasMoutawwakil/orgs","repos_url":"https://api.github.com/users/IlyasMoutawwakil/repos","events_url":"https://api.github.com/users/IlyasMoutawwakil/events{/privacy}","received_events_url":"https://api.github.com/users/IlyasMoutawwakil/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-09-17T13:04:13Z","updated_at":"2021-09-21T13:28:10Z","closed_at":"2021-09-21T13:23:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"> **Describe the bug**\r\n\r\nThe problem started when I put a BATS forecaster in an AutoEnsembleForecaster and ended up with an infinite loop of errors.\r\nBut apparently it comes from BATS/TBATS when given n_jobs other than None (default) or 1.\r\n\r\n> **To Reproduce**`\r\n\r\n```python\r\nimport numpy as np\r\nfrom sktime.datasets import load_airline\r\nfrom sktime.forecasting.bats import BATS\r\n\r\ny = load_airline()\r\nfh = np.arange(1, 10)\r\n\r\nbats_forecaster = BATS(sp=[12],\r\n                  use_trend=None,\r\n                  n_jobs=2,\r\n                  use_box_cox=None,\r\n                  use_arma_errors=True,\r\n                  use_damped_trend=None,\r\n                  show_warnings=False)\r\n\r\nbats_forecaster.fit(y)\r\nprint(bats_forecaster.predict(fh))\r\n```\r\nYou should get this long error that keeps on repeating itself infinitely:\r\n\r\n```\r\n  Traceback (most recent call last):\r\n    File \"<string>\", line 1, in <module>\r\n    File \"<string>\", line 1, in <module>\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 116, in spawn_main\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 116, in spawn_main\r\n      exitcode = _main(fd, parent_sentinel)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 125, in _main\r\n      exitcode = _main(fd, parent_sentinel)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 125, in _main\r\n      prepare(preparation_data)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 236, in prepare\r\n      prepare(preparation_data)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 236, in prepare\r\n      _fixup_main_from_path(data['init_main_from_path'])\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 287, in _fixup_main_from_path\r\n      _fixup_main_from_path(data['init_main_from_path'])\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 287, in _fixup_main_from_path\r\n      main_content = runpy.run_path(main_path,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 265, in run_path\r\n      main_content = runpy.run_path(main_path,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 265, in run_path\r\n      return _run_module_code(code, init_globals, run_name,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 97, in _run_module_code\r\n      return _run_module_code(code, init_globals, run_name,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 97, in _run_module_code\r\n      _run_code(code, mod_globals, init_globals,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 87, in _run_code\r\n      _run_code(code, mod_globals, init_globals,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\runpy.py\", line 87, in _run_code\r\n      exec(code, run_globals)\r\n    File \"c:\\Users\\IlyasMoutawwakil\\Documents\\test.py\", line 23, in <module>\r\n      exec(code, run_globals)\r\n    File \"c:\\Users\\IlyasMoutawwakil\\Documents\\test.py\", line 23, in <module>\r\n      bats_forecaster.fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\sktime\\forecasting\\base\\_base.py\", line 178, in fit\r\n      bats_forecaster.fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\sktime\\forecasting\\base\\_base.py\", line 178, in fit\r\n      self._fit(y=y_inner, X=X_inner, fh=fh)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\sktime\\forecasting\\base\\adapters\\_tbats.py\", line 91, in _fit\r\n      self._fit(y=y_inner, X=X_inner, fh=fh)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\sktime\\forecasting\\base\\adapters\\_tbats.py\", line 91, in _fit\r\n      self._forecaster = self._forecaster.fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\abstract\\Estimator.py\", line 98, in fit\r\n      self._forecaster = self._forecaster.fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\abstract\\Estimator.py\", line 98, in fit\r\n      best_model = self._do_fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\bats\\BATS.py\", line 75, in _do_fit\r\n      best_model = self._do_fit(y)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\bats\\BATS.py\", line 75, in _do_fit\r\n      return self._choose_model_from_possible_component_settings(y, components_grid)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\abstract\\Estimator.py\", line 143, in _choose_model_from_possible_component_settings\r\n      return self._choose_model_from_possible_component_settings(y, components_grid)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\site-packages\\tbats\\abstract\\Estimator.py\", line 143, in _choose_model_from_possible_component_settings\r\n      with self.context.multiprocessing().Pool(processes=self.n_jobs) as pool:\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\context.py\", line 119, in Pool\r\n      with self.context.multiprocessing().Pool(processes=self.n_jobs) as pool:\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\context.py\", line 119, in Pool\r\n      return Pool(processes, initializer, initargs, maxtasksperchild,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 212, in __init__\r\n      return Pool(processes, initializer, initargs, maxtasksperchild,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 212, in __init__\r\n      self._repopulate_pool()\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 303, in _repopulate_pool\r\n      self._repopulate_pool()\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 303, in _repopulate_pool\r\n      return self._repopulate_pool_static(self._ctx, self.Process,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 326, in _repopulate_pool_static\r\n      return self._repopulate_pool_static(self._ctx, self.Process,\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\pool.py\", line 326, in _repopulate_pool_static\r\n      w.start()\r\n      w.start()\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\process.py\", line 121, in start\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\process.py\", line 121, in start\r\n      self._popen = self._Popen(self)\r\n      self._popen = self._Popen(self)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\context.py\", line 327, in _Popen\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\context.py\", line 327, in _Popen\r\n      return Popen(process_obj)\r\n      return Popen(process_obj)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\popen_spawn_win32.py\", line 45, in __init__\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\popen_spawn_win32.py\", line 45, in __init__\r\n      prep_data = spawn.get_preparation_data(process_obj._name)\r\n      prep_data = spawn.get_preparation_data(process_obj._name)\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 154, in get_preparation_data\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 154, in get_preparation_data\r\n      _check_not_importing_main()\r\n      _check_not_importing_main()\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 134, in _check_not_importing_main\r\n    File \"C:\\Users\\IlyasMoutawwakil\\anaconda3\\lib\\multiprocessing\\spawn.py\", line 134, in _check_not_importing_main\r\n      raise RuntimeError('''\r\n      raise RuntimeError('''\r\n  RuntimeError:\r\n          An attempt has been made to start a new process before the\r\n          current process has finished its bootstrapping phase.\r\n  \r\n          This probably means that you are not using fork to start your\r\n          in the main module:\r\n  \r\n              if __name__ == '__main__':\r\n                  freeze_support()\r\n                  ...\r\n  \r\n          The \"freeze_support()\" line can be omitted if the program\r\n          is not going to be frozen to produce an executable.RuntimeError:\r\n          An attempt has been made to start a new process before the\r\n          current process has finished its bootstrapping phase.\r\n  \r\n          This probably means that you are not using fork to start your\r\n          child processes and you have forgotten to use the proper idiom\r\n          in the main module:\r\n  \r\n              if __name__ == '__main__':\r\n                  freeze_support()\r\n                  ...\r\n  \r\n          The \"freeze_support()\" line can be omitted if the program\r\n          is not going to be frozen to produce an executable.\r\n```\r\n\r\n\r\n> **Expected behavior**\r\n\r\n\r\nRunning the forecaster on multiple processes for faster convergence.\r\n\r\n> **Additional context**\r\n\r\n**Versions**\r\n<details>\r\nSystem:\r\n    python: 3.8.11 (default, Aug  3 2021, 06:49:12) [MSC v.1916 64 bit (AMD64)]\r\nexecutable: C:\\Users\\sysnav\\anaconda3\\python.exe\r\n   machine: Windows-10-10.0.19042-SP0\r\n\r\nPython dependencies:\r\n          pip: 21.2.2\r\n   setuptools: 52.0.0.post20210125\r\n      sklearn: 0.24.2\r\n       sktime: 0.7.0\r\n  statsmodels: 0.12.2\r\n        numpy: 1.20.3\r\n        scipy: 1.7.1\r\n       Cython: 0.29.24\r\n       pandas: 1.2.4\r\n   matplotlib: 3.4.2\r\n       joblib: 1.0.1\r\n        numba: 0.54.0\r\n     pmdarima: 1.8.2\r\n      tsfresh: None\r\n</details>","closed_by":{"login":"IlyasMoutawwakil","id":57442720,"node_id":"MDQ6VXNlcjU3NDQyNzIw","avatar_url":"https://avatars.githubusercontent.com/u/57442720?v=4","gravatar_id":"","url":"https://api.github.com/users/IlyasMoutawwakil","html_url":"https://github.com/IlyasMoutawwakil","followers_url":"https://api.github.com/users/IlyasMoutawwakil/followers","following_url":"https://api.github.com/users/IlyasMoutawwakil/following{/other_user}","gists_url":"https://api.github.com/users/IlyasMoutawwakil/gists{/gist_id}","starred_url":"https://api.github.com/users/IlyasMoutawwakil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/IlyasMoutawwakil/subscriptions","organizations_url":"https://api.github.com/users/IlyasMoutawwakil/orgs","repos_url":"https://api.github.com/users/IlyasMoutawwakil/repos","events_url":"https://api.github.com/users/IlyasMoutawwakil/events{/privacy}","received_events_url":"https://api.github.com/users/IlyasMoutawwakil/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/1426/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/1426/timeline","performed_via_github_app":null,"state_reason":"completed"}