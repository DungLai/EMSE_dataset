{"url":"https://api.github.com/repos/sktime/sktime/issues/1057","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/1057/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/1057/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/1057/events","html_url":"https://github.com/sktime/sktime/issues/1057","id":930323781,"node_id":"MDU6SXNzdWU5MzAzMjM3ODE=","number":1057,"title":"[BUG] Cross validation has no effect on KNeighborsTimeSeriesClassifier distance measure parameters","user":{"login":"AidenRushbrooke","id":72034940,"node_id":"MDQ6VXNlcjcyMDM0OTQw","avatar_url":"https://avatars.githubusercontent.com/u/72034940?v=4","gravatar_id":"","url":"https://api.github.com/users/AidenRushbrooke","html_url":"https://github.com/AidenRushbrooke","followers_url":"https://api.github.com/users/AidenRushbrooke/followers","following_url":"https://api.github.com/users/AidenRushbrooke/following{/other_user}","gists_url":"https://api.github.com/users/AidenRushbrooke/gists{/gist_id}","starred_url":"https://api.github.com/users/AidenRushbrooke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AidenRushbrooke/subscriptions","organizations_url":"https://api.github.com/users/AidenRushbrooke/orgs","repos_url":"https://api.github.com/users/AidenRushbrooke/repos","events_url":"https://api.github.com/users/AidenRushbrooke/events{/privacy}","received_events_url":"https://api.github.com/users/AidenRushbrooke/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3102418261,"node_id":"MDU6TGFiZWwzMTAyNDE4MjYx","url":"https://api.github.com/repos/sktime/sktime/labels/module:classification","name":"module:classification","color":"BEB114","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"TonyBagnall","id":9594042,"node_id":"MDQ6VXNlcjk1OTQwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/9594042?v=4","gravatar_id":"","url":"https://api.github.com/users/TonyBagnall","html_url":"https://github.com/TonyBagnall","followers_url":"https://api.github.com/users/TonyBagnall/followers","following_url":"https://api.github.com/users/TonyBagnall/following{/other_user}","gists_url":"https://api.github.com/users/TonyBagnall/gists{/gist_id}","starred_url":"https://api.github.com/users/TonyBagnall/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TonyBagnall/subscriptions","organizations_url":"https://api.github.com/users/TonyBagnall/orgs","repos_url":"https://api.github.com/users/TonyBagnall/repos","events_url":"https://api.github.com/users/TonyBagnall/events{/privacy}","received_events_url":"https://api.github.com/users/TonyBagnall/received_events","type":"User","site_admin":false},"assignees":[{"login":"TonyBagnall","id":9594042,"node_id":"MDQ6VXNlcjk1OTQwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/9594042?v=4","gravatar_id":"","url":"https://api.github.com/users/TonyBagnall","html_url":"https://github.com/TonyBagnall","followers_url":"https://api.github.com/users/TonyBagnall/followers","following_url":"https://api.github.com/users/TonyBagnall/following{/other_user}","gists_url":"https://api.github.com/users/TonyBagnall/gists{/gist_id}","starred_url":"https://api.github.com/users/TonyBagnall/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TonyBagnall/subscriptions","organizations_url":"https://api.github.com/users/TonyBagnall/orgs","repos_url":"https://api.github.com/users/TonyBagnall/repos","events_url":"https://api.github.com/users/TonyBagnall/events{/privacy}","received_events_url":"https://api.github.com/users/TonyBagnall/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2021-06-25T16:23:53Z","updated_at":"2021-06-30T15:21:04Z","closed_at":"2021-06-30T15:21:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\n\r\nUsing scikit-learn cross validation functions on sktime's KNN classifier to set the distance measure hyperparameters always produces the same score.\r\n\r\n\r\n**To Reproduce**\r\n<!--\r\nAdd a Minimal, Complete, and Verifiable example (for more details, see e.g. https://stackoverflow.com/help/mcve\r\n\r\nIf the code is too long, feel free to put it in a public gist and link it in the issue: https://gist.github.com\r\n-->\r\n\r\n```python\r\nfrom sktime.classification.distance_based import KNeighborsTimeSeriesClassifier\r\nfrom sktime.datasets import load_basic_motions\r\n\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.model_selection import GridSearchCV\r\n\r\nimport pandas as pd\r\n\r\nX, y = load_basic_motions(return_X_y = True)\r\nx_train, x_test, y_train, y_test = train_test_split(X.iloc[:, [0]], y)\r\n\r\nparam_matrix = {\r\n                \"distance_params\": [{\"w\": x / 100} for x in range(0, 100)]\r\n            }\r\ngrid = GridSearchCV(\r\n                estimator=KNeighborsTimeSeriesClassifier(\r\n                    distance=\"dtw\", n_neighbors=1\r\n                ),\r\n                param_grid=param_matrix,\r\n                cv=10,\r\n                scoring=\"accuracy\",\r\n            )\r\n\r\ngrid.fit(x_train, y_train)\r\n\r\nprint(pd.DataFrame(grid.cv_results_))\r\n\r\n    mean_fit_time  std_fit_time  mean_score_time  std_score_time param_distance_params  ... split8_test_score  split9_test_score  mean_test_score  std_test_score  rank_test_score\r\n0        0.003862      0.000397         0.033888        0.001333            {'w': 0.0}  ...               1.0                1.0              1.0             0.0                1\r\n1        0.003609      0.000302         0.033037        0.000653           {'w': 0.01}  ...               1.0                1.0              1.0             0.0                1\r\n2        0.003663      0.000329         0.033945        0.002118           {'w': 0.02}  ...               1.0                1.0              1.0             0.0                1\r\n3        0.003961      0.000472         0.034648        0.001769           {'w': 0.03}  ...               1.0                1.0              1.0             0.0                1\r\n4        0.003810      0.000332         0.033339        0.000514           {'w': 0.04}  ...               1.0                1.0              1.0             0.0                1\r\n..            ...           ...              ...             ...                   ...  ...               ...                ...              ...             ...              ...\r\n95       0.003410      0.000301         0.033238        0.001309           {'w': 0.95}  ...               1.0                1.0              1.0             0.0                1\r\n96       0.003910      0.000375         0.033840        0.001541           {'w': 0.96}  ...               1.0                1.0              1.0             0.0                1\r\n97       0.003459      0.000270         0.032236        0.000451           {'w': 0.97}  ...               1.0                1.0              1.0             0.0                1\r\n98       0.003660      0.000230         0.032135        0.000351           {'w': 0.98}  ...               1.0                1.0              1.0             0.0                1\r\n99       0.003659      0.000230         0.032436        0.000898           {'w': 0.99}  ...               1.0                1.0              1.0             0.0                1\r\n\r\n[100 rows x 19 columns]\r\n```\r\n\r\n**Expected behavior**\r\n\r\nUsing different parameters should produce different scores.\r\n\r\n\r\n**Additional context**\r\n\r\nI've tested this bug using multiple different datasets and distance measures, and all produced the same issue. I believe this issue is caused by the use of both \"distance_params\" and \"metric_params\" to store the distance measure parameters. Only the value in metric_params is actually passed to the distance measures, but when using cross validation, this is never set as the constuctor is not called, but rather the inital classifier is cloned, so the default value is always used. \r\n\r\nThis could be fixed by removing \"distance_params\" entirely and replacing with \"metric_params\", which does lead to different scores for different hyperparameters, as shown in the results below.\r\n```python\r\n    mean_fit_time  std_fit_time  mean_score_time  std_score_time param_metric_params  ... split8_test_score  split9_test_score  mean_test_score  std_test_score  rank_test_score\r\n0        0.003861      0.000395         0.017496        0.000875          {'w': 0.0}  ...          0.333333           0.833333         0.600000        0.213437              100\r\n1        0.004018      0.000502         0.018389        0.000853         {'w': 0.01}  ...          1.000000           0.833333         0.933333        0.110554               99\r\n2        0.003804      0.000402         0.018915        0.000394         {'w': 0.02}  ...          1.000000           0.833333         0.950000        0.076376               98\r\n3        0.004018      0.000325         0.021227        0.003138         {'w': 0.03}  ...          1.000000           0.833333         0.966667        0.066667               97\r\n4        0.004812      0.001080         0.022917        0.002269         {'w': 0.04}  ...          1.000000           0.833333         0.983333        0.050000               94\r\n..            ...           ...              ...             ...                 ...  ...               ...                ...              ...             ...              ...\r\n95       0.003760      0.000336         0.033539        0.000612         {'w': 0.95}  ...          1.000000           1.000000         1.000000        0.000000                1\r\n96       0.003957      0.000815         0.035548        0.002654         {'w': 0.96}  ...          1.000000           1.000000         1.000000        0.000000                1\r\n97       0.003910      0.000301         0.033188        0.000201         {'w': 0.97}  ...          1.000000           1.000000         1.000000        0.000000                1\r\n98       0.003609      0.000201         0.033138        0.000351         {'w': 0.98}  ...          1.000000           1.000000         1.000000        0.000000                1\r\n99       0.003762      0.000248         0.033348        0.000860         {'w': 0.99}  ...          1.000000           1.000000         1.000000        0.000000                1\r\n\r\n[100 rows x 19 columns]\r\n```\r\n\r\nI am raising this as an issue as there may be better solutions whilst keeping the variable names clear.\r\n**Versions**\r\n<details>\r\n\r\n<!--\r\nPlease run the following code snippet and paste the output here:\r\n \r\nfrom sktime import show_versions; show_versions()\r\n-->\r\n\r\nSystem:\r\n    python: 3.7.9 (tags/v3.7.9:13c94747c7, Aug 17 2020, 18:58:18) [MSC v.1900 64 bit (AMD64)]\r\nexecutable: C:\\Users\\XXX\\AppData\\Local\\Programs\\Python\\Python37\\python.exe\r\n   machine: Windows-10-10.0.16299-SP0\r\n\r\nPython dependencies:\r\n          pip: 20.2.3\r\n   setuptools: 56.2.0\r\n      sklearn: 0.24.2\r\n       sktime: 0.6.1\r\n  statsmodels: 0.12.2\r\n        numpy: 1.20.3\r\n        scipy: 1.5.3\r\n       Cython: 0.29.14\r\n       pandas: 1.1.3\r\n   matplotlib: 3.3.2\r\n       joblib: 0.17.0\r\n        numba: 0.52.0rc3\r\n     pmdarima: 1.7.1\r\n      tsfresh: 0.17.0\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":{"login":"TonyBagnall","id":9594042,"node_id":"MDQ6VXNlcjk1OTQwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/9594042?v=4","gravatar_id":"","url":"https://api.github.com/users/TonyBagnall","html_url":"https://github.com/TonyBagnall","followers_url":"https://api.github.com/users/TonyBagnall/followers","following_url":"https://api.github.com/users/TonyBagnall/following{/other_user}","gists_url":"https://api.github.com/users/TonyBagnall/gists{/gist_id}","starred_url":"https://api.github.com/users/TonyBagnall/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TonyBagnall/subscriptions","organizations_url":"https://api.github.com/users/TonyBagnall/orgs","repos_url":"https://api.github.com/users/TonyBagnall/repos","events_url":"https://api.github.com/users/TonyBagnall/events{/privacy}","received_events_url":"https://api.github.com/users/TonyBagnall/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/1057/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/1057/timeline","performed_via_github_app":null,"state_reason":"completed"}