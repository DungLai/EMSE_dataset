{"url":"https://api.github.com/repos/sktime/sktime/issues/1651","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/1651/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/1651/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/1651/events","html_url":"https://github.com/sktime/sktime/issues/1651","id":1064433637,"node_id":"I_kwDOCVKAsc4_cffl","number":1651,"title":"[BUG] benchmarking.tests.test_evaluator.test_wilcoxon passes/fails with different versions of pandas","user":{"login":"TonyBagnall","id":9594042,"node_id":"MDQ6VXNlcjk1OTQwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/9594042?v=4","gravatar_id":"","url":"https://api.github.com/users/TonyBagnall","html_url":"https://github.com/TonyBagnall","followers_url":"https://api.github.com/users/TonyBagnall/followers","following_url":"https://api.github.com/users/TonyBagnall/following{/other_user}","gists_url":"https://api.github.com/users/TonyBagnall/gists{/gist_id}","starred_url":"https://api.github.com/users/TonyBagnall/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TonyBagnall/subscriptions","organizations_url":"https://api.github.com/users/TonyBagnall/orgs","repos_url":"https://api.github.com/users/TonyBagnall/repos","events_url":"https://api.github.com/users/TonyBagnall/events{/privacy}","received_events_url":"https://api.github.com/users/TonyBagnall/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3137622230,"node_id":"MDU6TGFiZWwzMTM3NjIyMjMw","url":"https://api.github.com/repos/sktime/sktime/labels/module:tests","name":"module:tests","color":"43421D","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-11-26T12:42:23Z","updated_at":"2021-11-26T21:26:38Z","closed_at":"2021-11-26T21:26:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\n\r\nthanks to @immentel for identifying this issue previously identified here \r\nhttps://github.com/alan-turing-institute/sktime/pull/1198\r\n\r\nthe problem is caused by changes in pandas between versions 1.1.5 (used for the automatic repo tests) and versions >=1.2.0 (specifically tested with 1.3.4) that results in inconsistency in the ordering of the underlying data structure when directly converted to numpy. Related to https://github.com/alan-turing-institute/sktime/pull/1644 and https://github.com/alan-turing-institute/sktime/pull/1646.\r\n\r\n```python\r\ndef test_wilcoxon():\r\n    evaluator, metrics_by_strategy = evaluator_setup(score_function=accuracy_score)\r\n    results = evaluator.wilcoxon_test().iloc[:, 2:].values\r\n    # Fails pandas 1.3.4 passes 1.1.5\r\n    expected = np.array([[0.5, 0], [0.5, 0], [0.5, 0]])\r\n    # Works pandas 1.3.4 fails 1.1.5\r\n    expected = np.array([[0, 0.5], [0, 0.5], [0, 0.5]])\r\n    assert np.array_equal(results, expected)\r\n```\r\n\r\n*To Reproduce**\r\npip install pandas==1.1.5\r\nset\r\nexpected = np.array([[0, 0.5], [0, 0.5], [0, 0.5]])\r\nor \r\npip install pandas==1.3.4\r\nset\r\nexpected = np.array([[0.5, 0], [0.5, 0], [0.5, 0]])\r\n\r\n**Expected behavior**\r\nthe ordering of the expected values need to be consistent. Based on conversations with @fkiraly, says \r\n\r\nthe actual function still fulfills its contract, since the column names are correctly attributing the things that are compared, it's just that the data frame that is returned has permuted columns (with permuted correct index!) between versions. But if you convert to values, the information about the column index is removed, which results in a change in the numpy array, so as data frame, the two would be equal (if column names would be kept), but after converting to numpy  they no longer are. It's my suspicion\"\r\n\r\nI think he is correct, but have not tested it. @fkiraly suggests two possible solutions\r\n\r\nresults_df = evaluator.wilcoxon_test()\r\nresults_df_cols = evaluator.wilcoxon_test().columns\r\nresults = results_df[sort(results_df_cols)][:, 2:].values\r\n\r\nor\r\n\r\nresults_df = evaluator.wilcoxon_test()\r\nexpected = pd.DataFrame(put the right thing here)\r\nassert results_df.equals(expected)\r\n\r\n\r\n**Additional context**\r\n<!--\r\nAdd any other context about the problem here.\r\n-->\r\n\r\n**Versions**\r\n<details>\r\n\r\n<!--\r\nPlease run the following code snippet and paste the output here:\r\n \r\nfrom sktime import show_versions; show_versions()\r\n-->\r\n\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":{"login":"fkiraly","id":7985502,"node_id":"MDQ6VXNlcjc5ODU1MDI=","avatar_url":"https://avatars.githubusercontent.com/u/7985502?v=4","gravatar_id":"","url":"https://api.github.com/users/fkiraly","html_url":"https://github.com/fkiraly","followers_url":"https://api.github.com/users/fkiraly/followers","following_url":"https://api.github.com/users/fkiraly/following{/other_user}","gists_url":"https://api.github.com/users/fkiraly/gists{/gist_id}","starred_url":"https://api.github.com/users/fkiraly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkiraly/subscriptions","organizations_url":"https://api.github.com/users/fkiraly/orgs","repos_url":"https://api.github.com/users/fkiraly/repos","events_url":"https://api.github.com/users/fkiraly/events{/privacy}","received_events_url":"https://api.github.com/users/fkiraly/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/1651/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/1651/timeline","performed_via_github_app":null,"state_reason":"completed"}