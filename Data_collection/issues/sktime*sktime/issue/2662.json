{"url":"https://api.github.com/repos/sktime/sktime/issues/2662","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/2662/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/2662/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/2662/events","html_url":"https://github.com/sktime/sktime/issues/2662","id":1240535747,"node_id":"I_kwDOCVKAsc5J8RLD","number":2662,"title":"[BUG] Error with n_jobs when MiniRocket is used with calibration","user":{"login":"k-olsen","id":15016483,"node_id":"MDQ6VXNlcjE1MDE2NDgz","avatar_url":"https://avatars.githubusercontent.com/u/15016483?v=4","gravatar_id":"","url":"https://api.github.com/users/k-olsen","html_url":"https://github.com/k-olsen","followers_url":"https://api.github.com/users/k-olsen/followers","following_url":"https://api.github.com/users/k-olsen/following{/other_user}","gists_url":"https://api.github.com/users/k-olsen/gists{/gist_id}","starred_url":"https://api.github.com/users/k-olsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/k-olsen/subscriptions","organizations_url":"https://api.github.com/users/k-olsen/orgs","repos_url":"https://api.github.com/users/k-olsen/repos","events_url":"https://api.github.com/users/k-olsen/events{/privacy}","received_events_url":"https://api.github.com/users/k-olsen/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3102418261,"node_id":"MDU6TGFiZWwzMTAyNDE4MjYx","url":"https://api.github.com/repos/sktime/sktime/labels/module:classification","name":"module:classification","color":"BEB114","default":false,"description":""},{"id":3105907331,"node_id":"MDU6TGFiZWwzMTA1OTA3MzMx","url":"https://api.github.com/repos/sktime/sktime/labels/module:transformations","name":"module:transformations","color":"0865AF","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-05-18T21:11:21Z","updated_at":"2022-10-20T13:47:03Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\n<!--\r\nA clear and concise description of what the bug is.\r\n-->\r\nAn error is produced when the `MiniRocket` transform is used with `sklearn`'s `CalibratedClassifierCV` and `n_jobs` is set to any integer _except_ 1 or 2. If `n_jobs=1` or `n_jobs=2` the error is not produced.\r\n\r\nIf `n_jobs = -1` is used in `MiniRocket` _without_ wrapping the model with `sklearn.calibration.CalibratedClassifierCV` the error does not occur.\r\n\r\n\r\n**To Reproduce**\r\n<!--\r\nAdd a Minimal, Complete, and Verifiable example (for more details, see e.g. https://stackoverflow.com/help/mcve\r\n\r\nIf the code is too long, feel free to put it in a public gist and link it in the issue: https://gist.github.com\r\n-->\r\n\r\n```python\r\nfrom sktime.transformations.panel import rocket\r\nfrom sktime.datasets import load_arrow_head\r\nimport sklearn.pipeline\r\nimport sklearn.calibration\r\n\r\nX, y = load_arrow_head(return_X_y=True)\r\nn_jobs = -1\r\n\r\n\r\nfeaturizer_rocket = rocket.MiniRocket(n_jobs=n_jobs)\r\nclassifier = sklearn.ensemble.HistGradientBoostingClassifier(loss='categorical_crossentropy')\r\n\r\nbase_estimator = sklearn.pipeline.Pipeline(\r\n    [\r\n        (\"featurizer_rocket\", featurizer_rocket),\r\n        (\"classifier\", classifier),\r\n    ],\r\n)\r\n\r\ncalibrated_model = sklearn.calibration.CalibratedClassifierCV(\r\n    base_estimator, cv=2, n_jobs=n_jobs,\r\n)\r\n\r\ncalibrated_model.fit(X, y)\r\n```\r\nError:\r\n```\r\n\"\"\"\r\nTraceback (most recent call last):\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/externals/loky/process_executor.py\", line 436, in _process_worker\r\n    r = call_item()\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/externals/loky/process_executor.py\", line 288, in __call__\r\n    return self.fn(*self.args, **self.kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/_parallel_backends.py\", line 595, in __call__\r\n    return self.func(*args, **kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/parallel.py\", line 262, in __call__\r\n    return [func(*args, **kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/parallel.py\", line 262, in <listcomp>\r\n    return [func(*args, **kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/utils/fixes.py\", line 216, in __call__\r\n    return self.function(*args, **kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/calibration.py\", line 511, in _fit_classifier_calibrator_pair\r\n    estimator.fit(X_train, y_train)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/pipeline.py\", line 390, in fit\r\n    Xt = self._fit(X, y, **fit_params_steps)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/pipeline.py\", line 348, in _fit\r\n    X, fitted_transformer = fit_transform_one_cached(\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/memory.py\", line 349, in __call__\r\n    return self.func(*args, **kwargs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/pipeline.py\", line 893, in _fit_transform_one\r\n    res = transformer.fit_transform(X, y, **fit_params)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sktime/transformations/base.py\", line 434, in fit_transform\r\n    return self.fit(X, y).transform(X, y)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sktime/transformations/base.py\", line 369, in transform\r\n    Xt = self._transform(X=X_inner, y=y_inner)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sktime/transformations/panel/rocket/_minirocket.py\", line 122, in _transform\r\n    set_num_threads(n_jobs)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/numba/np/ufunc/parallel.py\", line 587, in set_num_threads\r\n    snt_check(n)\r\n  File \"/Users/kira/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/numba/np/ufunc/parallel.py\", line 549, in snt_check\r\n    raise ValueError(msg)\r\nValueError: The number of threads must be between 1 and 1\r\n\"\"\"\r\n\r\nThe above exception was the direct cause of the following exception:\r\nValueError                                Traceback (most recent call last)\r\n     [13] base_estimator = sklearn.pipeline.Pipeline(\r\n     [14]     [\r\n     [15]         (\"featurizer_rocket\", featurizer_rocket),\r\n     [16]         (\"classifier\", classifier),\r\n     [17]     ],\r\n     [18] )\r\n     [20] calibrated_model = sklearn.calibration.CalibratedClassifierCV(\r\n     [21]     base_estimator, cv=2, n_jobs=n_jobs,\r\n     [22] )\r\n---> [24] calibrated_model.fit(X, y)\r\n\r\nFile ~/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/sklearn/calibration.py:341, in CalibratedClassifierCV.fit(self, X, y, sample_weight)\r\n    [338] if self.ensemble:\r\n    [339]     parallel = Parallel(n_jobs=self.n_jobs)\r\n--> [341]     self.calibrated_classifiers_ = parallel(\r\n    [342]         delayed(_fit_classifier_calibrator_pair)(\r\n    [343]             clone(base_estimator),\r\n    [344]             X,\r\n    [345]             y,\r\n    [346]            train=train,\r\n    [347]             test=test,\r\n    [348]             method=self.method,\r\n    [349]             classes=self.classes_,\r\n    [350]             supports_sw=supports_sw,\r\n    [351]             sample_weight=sample_weight,\r\n    [352]         )\r\n    [353]         for train, test in cv.split(X, y)\r\n    [354]     )\r\n    [355] else:\r\n    [356]     this_estimator = clone(base_estimator)\r\n\r\nFile ~/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/parallel.py:1056, in Parallel.__call__(self, iterable)\r\n   [1053]    self._iterating = False\r\n   [1055] with self._backend.retrieval_context():\r\n-> [1056]     self.retrieve()\r\n   [1057] # Make sure that we get a last message telling us we are done\r\n   [1058] elapsed_time = time.time() - self._start_time\r\n\r\nFile ~/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/parallel.py:935, in Parallel.retrieve(self)\r\n    [933] try:\r\n    [934]     if getattr(self._backend, 'supports_timeout', False):\r\n--> [935]         self._output.extend(job.get(timeout=self.timeout))\r\n    [936]     else:\r\n    [937]         self._output.extend(job.get())\r\n\r\nFile ~/.pyenv/versions/3.8.10/envs/venv/lib/python3.8/site-packages/joblib/_parallel_backends.py:542, in LokyBackend.wrap_future_result(future, timeout)\r\n    [539] \"\"\"Wrapper for Future.result to implement the same behaviour as\r\n    [540] AsyncResults.get from multiprocessing.\"\"\"\r\n    [541] try:\r\n--> [542]     return future.result(timeout=timeout)\r\n    [543] except CfTimeoutError as e:\r\n    [544]     raise TimeoutError from e\r\n\r\nFile ~/.pyenv/versions/3.8.10/lib/python3.8/concurrent/futures/_base.py:444, in Future.result(self, timeout)\r\n    [442]     raise CancelledError()\r\n    [443] elif self._state == FINISHED:\r\n--> [444]     return self.__get_result()\r\n    [445] else:\r\n    [446]     raise TimeoutError()\r\n\r\nFile ~/.pyenv/versions/3.8.10/lib/python3.8/concurrent/futures/_base.py:389, in Future.__get_result(self)\r\n    [387] if self._exception:\r\n    [388]     try:\r\n--> [389]         raise self._exception\r\n    [390]     finally:\r\n    [391]        # Break a reference cycle with the exception in self._exception\r\n    [392]         self = None\r\n\r\nValueError: The number of threads must be between 1 and 1\r\n```\r\n\r\n**Expected behavior**\r\n<!--\r\nA clear and concise description of what you expected to happen.\r\n-->\r\nExpected `n_jobs = -1` to work without an error.\r\n**Additional context**\r\n<!--\r\nAdd any other context about the problem here.\r\n-->\r\n\r\n**Versions**\r\n<details>\r\n\r\n<!--\r\nPlease run the following code snippet and paste the output here:\r\n \r\nfrom sktime import show_versions; show_versions()\r\n-->\r\n\r\nSystem:\r\n    python: 3.8.10 (default, Jan 10 2022, 10:11:20)  [Clang 13.0.0 (clang-1300.0.29.3)]\r\nexecutable: /Users/kira/.pyenv/versions/3.8.10/envs/venv/bin/python\r\n   machine: macOS-12.3.1-arm64-arm-64bit\r\n\r\nPython dependencies:\r\n          pip: 22.1\r\n   setuptools: 62.2.0\r\n      sklearn: 1.0.2\r\n       sktime: 0.11.4\r\n  statsmodels: 0.13.2\r\n        numpy: 1.21.5\r\n        scipy: 1.7.3\r\n       pandas: 1.4.2\r\n   matplotlib: 3.5.1\r\n       joblib: 1.1.0\r\n        numba: 0.56.0dev0+418.g637a75023\r\n     pmdarima: None\r\n      tsfresh: None\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/2662/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/2662/timeline","performed_via_github_app":null,"state_reason":null}