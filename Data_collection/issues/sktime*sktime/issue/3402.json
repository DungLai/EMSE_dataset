{"url":"https://api.github.com/repos/sktime/sktime/issues/3402","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/3402/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/3402/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/3402/events","html_url":"https://github.com/sktime/sktime/issues/3402","id":1368374697,"node_id":"I_kwDOCVKAsc5Rj72p","number":3402,"title":"[BUG] make_reduction causes misleading Exception on NaN values: `ValueError: Input X contains NaN.`","user":{"login":"tobb10001","id":30701667,"node_id":"MDQ6VXNlcjMwNzAxNjY3","avatar_url":"https://avatars.githubusercontent.com/u/30701667?v=4","gravatar_id":"","url":"https://api.github.com/users/tobb10001","html_url":"https://github.com/tobb10001","followers_url":"https://api.github.com/users/tobb10001/followers","following_url":"https://api.github.com/users/tobb10001/following{/other_user}","gists_url":"https://api.github.com/users/tobb10001/gists{/gist_id}","starred_url":"https://api.github.com/users/tobb10001/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tobb10001/subscriptions","organizations_url":"https://api.github.com/users/tobb10001/orgs","repos_url":"https://api.github.com/users/tobb10001/repos","events_url":"https://api.github.com/users/tobb10001/events{/privacy}","received_events_url":"https://api.github.com/users/tobb10001/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3105906374,"node_id":"MDU6TGFiZWwzMTA1OTA2Mzc0","url":"https://api.github.com/repos/sktime/sktime/labels/module:forecasting","name":"module:forecasting","color":"35FCCE","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-09-09T22:14:30Z","updated_at":"2022-09-21T20:57:10Z","closed_at":"2022-09-21T20:57:10Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\n<!--\r\nA clear and concise description of what the bug is.\r\n-->\r\nWhen using an sklearn model, that does not support NaN values with `make_reduction` and a `y` series with NaN values, the resulting exception is misleading:\r\n`ValueError: Input X contains NaN.`\r\n\r\n**To Reproduce**\r\n<!--\r\nAdd a Minimal, Complete, and Verifiable example (for more details, see e.g. https://stackoverflow.com/help/mcve\r\n\r\nIf the code is too long, feel free to put it in a public gist and link it in the issue: https://gist.github.com\r\n-->\r\n\r\n```python\r\nimport numpy as np\r\n\r\nfrom sklearn.linear_model import LinearRegression\r\n\r\nfrom sktime.datasets import load_longley\r\nfrom sktime.forecasting.compose import make_reduction\r\n\r\ny, X = load_longley()\r\n\r\nassert not X.isna().any().any() # X doesn't contain NaN\r\n\r\ny_w_nan = y.copy()\r\nX_w_nan = X.copy()\r\n\r\ny_w_nan.iloc[0] = np.nan\r\nX_w_nan.iloc[0] = np.nan\r\n\r\nmodel = make_reduction(LinearRegression())\r\n\r\nmodel.fit(y, X)\r\n# works normal\r\n\r\n#model.fit(y, X_w_nan)\r\n# throws `ValueError: Input X contains NaN.`, as one would expect.\r\n\r\nmodel.fit(y_w_nan, X)\r\n# also throws `ValueError: Input X contains NaN.`, although X doesn't contain NaN.\r\n```\r\n\r\n**Expected behavior**\r\n<!--\r\nA clear and concise description of what you expected to happen.\r\n-->\r\nAn exception, that tells the user that the y array contains NaNs.\r\n\r\n**Additional context**\r\n<!--\r\nAdd any other context about the problem here.\r\n-->\r\nThis problem does not appear in sklearn:\r\n```py\r\nimport numpy as np\r\n\r\nfrom sklearn.linear_model import LinearRegression\r\n\r\nfrom sktime.datasets import load_longley\r\n\r\ny, X = load_longley()\r\n\r\nassert not X.isna().any().any() # X doesn't contain NaN\r\n\r\ny_w_nan = y.copy()\r\nX_w_nan = X.copy()\r\n\r\ny_w_nan.iloc[0] = np.nan\r\nX_w_nan.iloc[0] = np.nan\r\n\r\nlinreg = LinearRegression()\r\n\r\nlinreg.fit(X, y) # works normal\r\n\r\n#linreg.fit(X_w_nan, y)\r\n# throws `ValueError: Input X contains NaN.`\r\n#linreg.fit(X, y_w_nan)\r\n# throws `ValueError: Input y contains NaN.`\r\n```\r\n@aiwalter When we discussed this, we missed that `LinearRegressioin.fit()` takes arguments in `X, y` order, instead of the `y, X` order used in `sktime`.  <https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html#sklearn.linear_model.LinearRegression.fit>\r\n\r\nThis problem also appears with other sklearn models. I've tried Ridge and SGDRegressor.\r\n\r\nMy stacktrace:\r\n<details>\r\n\r\n```plainTraceback (most recent call last):\r\n  File \"/home/.../t.py\", line 27, in <module>\r\n    model.fit(y_w_nan, X)\r\n  File \"/home/.../sktime/forecasting/base/_base.py\", line 303, in fit\r\n    self._fit(y=y_inner, X=X_inner, fh=fh)\r\n  File \"/home/.../sktime/forecasting/compose/_reduce.py\", line 513, in _fit\r\n    self.estimator_.fit(Xt, yt)\r\n  File \"/home/.../venv/lib/python3.10/site-packages/sklearn/linear_model/_base.py\", line 684, in fit\r\n    X, y = self._validate_data(\r\n  File \"/home/.../venv/lib/python3.10/site-packages/sklearn/base.py\", line 596, in _validate_data\r\n    X, y = check_X_y(X, y, **check_params)\r\n  File \"/home/.../venv/lib/python3.10/site-packages/sklearn/utils/validation.py\", line 1074, in check_X_y\r\n    X = check_array(\r\n  File \"/home/.../venv/lib/python3.10/site-packages/sklearn/utils/validation.py\", line 899, in check_array\r\n    _assert_all_finite(\r\n  File \"/home/.../venv/lib/python3.10/site-packages/sklearn/utils/validation.py\", line 146, in _assert_all_finite\r\n    raise ValueError(msg_err)\r\nValueError: Input X contains NaN.\r\nLinearRegression does not accept missing values encoded as NaN natively. For supervised learning, you might want to consider sklearn.ensemble.HistGradientBoostingClassifier and Regressor which accept missing values encoded as NaNs natively. Alternatively, it is possible to preprocess the data, for instance by using an imputer transformer in a pipeline or drop samples with missing values. See https://scikit-learn.org/stable/modules/impute.html You can find a list of all estimators that handle NaN values at the following page: https://scikit-learn.org/stable/modules/impute.html#estimators-that-handle-nan-values\r\n\r\n```\r\n\r\n</details>\r\n\r\n**Versions**\r\n<details>\r\n\r\n<!--\r\nPlease run the following code snippet and paste the output here:\r\n \r\nfrom sktime import show_versions; show_versions()\r\n-->\r\n```plain\r\nPython 3.10.4 (main, Jun 29 2022, 12:14:53) [GCC 11.2.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> from sktime import show_versions; show_versions()\r\n\r\nSystem:\r\n    python: 3.10.4 (main, Jun 29 2022, 12:14:53) [GCC 11.2.0]\r\nexecutable: /home/.../venv/bin/python3\r\n   machine: Linux-5.19.0-76051900-generic-x86_64-with-glibc2.35\r\n\r\nPython dependencies:\r\n          pip: 22.2.2\r\n   setuptools: 59.8.0\r\n      sklearn: 1.1.2\r\n       sktime: 0.13.2\r\n  statsmodels: 0.13.2\r\n        numpy: 1.22.4\r\n        scipy: 1.8.1\r\n       pandas: 1.4.4\r\n   matplotlib: None\r\n       joblib: 1.1.0\r\n        numba: 0.56.2\r\n     pmdarima: None\r\n      tsfresh: None\r\n```\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":{"login":"fkiraly","id":7985502,"node_id":"MDQ6VXNlcjc5ODU1MDI=","avatar_url":"https://avatars.githubusercontent.com/u/7985502?v=4","gravatar_id":"","url":"https://api.github.com/users/fkiraly","html_url":"https://github.com/fkiraly","followers_url":"https://api.github.com/users/fkiraly/followers","following_url":"https://api.github.com/users/fkiraly/following{/other_user}","gists_url":"https://api.github.com/users/fkiraly/gists{/gist_id}","starred_url":"https://api.github.com/users/fkiraly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkiraly/subscriptions","organizations_url":"https://api.github.com/users/fkiraly/orgs","repos_url":"https://api.github.com/users/fkiraly/repos","events_url":"https://api.github.com/users/fkiraly/events{/privacy}","received_events_url":"https://api.github.com/users/fkiraly/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/3402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/3402/timeline","performed_via_github_app":null,"state_reason":"completed"}