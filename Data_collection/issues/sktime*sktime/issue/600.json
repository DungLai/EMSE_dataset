{"url":"https://api.github.com/repos/sktime/sktime/issues/600","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/600/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/600/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/600/events","html_url":"https://github.com/sktime/sktime/issues/600","id":782655103,"node_id":"MDU6SXNzdWU3ODI2NTUxMDM=","number":600,"title":"[BUG] Cannot dump proximity forest model using joblib or pickle","user":{"login":"isma3ilsamir","id":45247141,"node_id":"MDQ6VXNlcjQ1MjQ3MTQx","avatar_url":"https://avatars.githubusercontent.com/u/45247141?v=4","gravatar_id":"","url":"https://api.github.com/users/isma3ilsamir","html_url":"https://github.com/isma3ilsamir","followers_url":"https://api.github.com/users/isma3ilsamir/followers","following_url":"https://api.github.com/users/isma3ilsamir/following{/other_user}","gists_url":"https://api.github.com/users/isma3ilsamir/gists{/gist_id}","starred_url":"https://api.github.com/users/isma3ilsamir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/isma3ilsamir/subscriptions","organizations_url":"https://api.github.com/users/isma3ilsamir/orgs","repos_url":"https://api.github.com/users/isma3ilsamir/repos","events_url":"https://api.github.com/users/isma3ilsamir/events{/privacy}","received_events_url":"https://api.github.com/users/isma3ilsamir/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-01-09T17:54:00Z","updated_at":"2021-02-20T20:44:33Z","closed_at":"2021-02-20T20:44:32Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nCannot export trained proximity forest model locally, to be used later on with other datasets.\r\nI tried doing so using picke and joblib but both failed.\r\n\r\n**To Reproduce**\r\n```python\r\nimport joblib\r\nimport pickle\r\nfrom sktime.classification.distance_based import ProximityForest\r\n\r\nclf = ProximityForest(get_distance_measure= None, verbosity= 0)\r\nclf.fit(X_train, y_train)\r\n\r\n#### Using Pickle ####\r\n######################\r\npkl_filename = \"pickle_model.pkl\"\r\nwith open(pkl_filename, 'wb') as file:\r\n    pickle.dump(clf, file)\r\n\r\nAttributeError                            Traceback (most recent call last)\r\n~\\Code\\run.py in <module>\r\n      1 pkl_filename = \"pickle_model.pkl\"\r\n      2 with open(pkl_filename, 'wb') as file:\r\n----> 3     pickle.dump(models['pforest'].clf, file)\r\n      4\r\n\r\nAttributeError: Can't pickle local object 'setup_all_distance_measure_getter.<locals>.pick_rand_distance_measure'\r\n\r\n\r\n#### Using Joblib####\r\n#####################\r\njoblib_file = \"joblib_model.pkl\"\r\njoblib.dump(clf, joblib_file)\r\n\r\nCan't pickle <function setup_all_distance_measure_getter.<locals>.pick_rand_distance_measure at 0x000001AC07AC3EE8>: it's not found as sktime.classification.distance_based._proximity_forest.setup_all_distance_measure_getter.<locals>.pick_rand_distance_measure\r\nTraceback (most recent call last):\r\n  File \"run.py\", line 269, in <module>\r\n    export_model(models, args)\r\n  File \"run.py\", line 221, in export_model\r\n    m.export_model(exp)\r\n  File \"~\\Code\\models.py\", line 178, in export_model\r\n    joblib.dump(self.clf, fname)\r\n  File \"~\\.virtualenvs\\Code-h9r8g-fJ\\lib\\site-packages\\joblib\\numpy_pickle.py\", line 480, in dump\r\n    NumpyPickler(f, protocol=protocol).dump(value)\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 437, in dump\r\n    self.save(obj)\r\n  File \"~\\.virtualenvs\\Code-h9r8g-fJ\\lib\\site-packages\\joblib\\numpy_pickle.py\", line 282, in save\r\n    return Pickler.save(self, obj)\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 549, in save\r\n    self.save_reduce(obj=obj, *rv)\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 662, in save_reduce\r\n    save(state)\r\n  File \"~\\.virtualenvs\\Code-h9r8g-fJ\\lib\\site-packages\\joblib\\numpy_pickle.py\", line 282, in save\r\n    return Pickler.save(self, obj)\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 504, in save\r\n    f(self, obj) # Call unbound method with explicit self\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 859, in save_dict\r\n    self._batch_setitems(obj.items())\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 885, in _batch_setitems\r\n    save(v)\r\n  File \"~\\.virtualenvs\\Code-h9r8g-fJ\\lib\\site-packages\\joblib\\numpy_pickle.py\", line 282, in save\r\n    return Pickler.save(self, obj)\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 504, in save\r\n    f(self, obj) # Call unbound method with explicit self\r\n  File \"~\\Python37\\Lib\\pickle.py\", line 960, in save_global\r\n    (obj, module_name, name)) from None\r\n_pickle.PicklingError: Can't pickle <function setup_all_distance_measure_getter.<locals>.pick_rand_distance_measure at 0x000001AC07AC3EE8>: it's not found as sktime.classification.distance_based._proximity_forest.setup_all_distance_measure_getter.<locals>.pick_rand_distance_measure\r\n```\r\n\r\n**Expected behavior**\r\nTo be able to dump Proximity Forest models.\r\n\r\n**Versions**\r\n<details>\r\n\r\nSystem:\r\npython: 3.7.4 (tags/v3.7.4:e09359112e, Jul 8 2019, 20:34:20) [MSC v.1916 64 bit (AMD64)]\r\nexecutable:~.virtualenvs\\Code-h9r8g-fJ\\Scripts\\python.exe\r\nmachine: Windows-10-10.0.18362-SP0\r\n\r\nPython dependencies:\r\npip: 20.3.3\r\nsetuptools: 51.1.1\r\nsklearn: 0.24.0\r\nsktime: 0.5.0\r\nstatsmodels: 0.12.1\r\nnumpy: 1.19.4\r\nscipy: 1.5.4\r\nCython: 0.29.21\r\npandas: 1.2.0\r\nmatplotlib: 3.3.3\r\njoblib: 1.0.0\r\nnumba: 0.52.0\r\npmdarima: None\r\ntsfresh: 0.17.0\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":{"login":"TonyBagnall","id":9594042,"node_id":"MDQ6VXNlcjk1OTQwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/9594042?v=4","gravatar_id":"","url":"https://api.github.com/users/TonyBagnall","html_url":"https://github.com/TonyBagnall","followers_url":"https://api.github.com/users/TonyBagnall/followers","following_url":"https://api.github.com/users/TonyBagnall/following{/other_user}","gists_url":"https://api.github.com/users/TonyBagnall/gists{/gist_id}","starred_url":"https://api.github.com/users/TonyBagnall/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TonyBagnall/subscriptions","organizations_url":"https://api.github.com/users/TonyBagnall/orgs","repos_url":"https://api.github.com/users/TonyBagnall/repos","events_url":"https://api.github.com/users/TonyBagnall/events{/privacy}","received_events_url":"https://api.github.com/users/TonyBagnall/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/600/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/600/timeline","performed_via_github_app":null,"state_reason":"completed"}