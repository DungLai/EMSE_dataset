{"url":"https://api.github.com/repos/sktime/sktime/issues/3693","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/3693/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/3693/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/3693/events","html_url":"https://github.com/sktime/sktime/issues/3693","id":1434355118,"node_id":"I_kwDOCVKAsc5VfoWu","number":3693,"title":"[BUG] `ConformalIntervals` `conformal_bonferroni` method doesn't work as expected when alpha = 0.5","user":{"login":"bethrice44","id":11226988,"node_id":"MDQ6VXNlcjExMjI2OTg4","avatar_url":"https://avatars.githubusercontent.com/u/11226988?v=4","gravatar_id":"","url":"https://api.github.com/users/bethrice44","html_url":"https://github.com/bethrice44","followers_url":"https://api.github.com/users/bethrice44/followers","following_url":"https://api.github.com/users/bethrice44/following{/other_user}","gists_url":"https://api.github.com/users/bethrice44/gists{/gist_id}","starred_url":"https://api.github.com/users/bethrice44/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bethrice44/subscriptions","organizations_url":"https://api.github.com/users/bethrice44/orgs","repos_url":"https://api.github.com/users/bethrice44/repos","events_url":"https://api.github.com/users/bethrice44/events{/privacy}","received_events_url":"https://api.github.com/users/bethrice44/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3105906374,"node_id":"MDU6TGFiZWwzMTA1OTA2Mzc0","url":"https://api.github.com/repos/sktime/sktime/labels/module:forecasting","name":"module:forecasting","color":"35FCCE","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-11-03T09:32:03Z","updated_at":"2022-11-11T11:42:47Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the bug**\r\nWhen using `predict_quantiles` with `ConformalIntervals`, you would expect `alpha=0.5` to correspond to the output of `predict` (or very close to it). However, when the Bonferroni correction is applied, it doesn't at all and the error becomes large vs just using `predict`.\r\n\r\nI think this is due to the way `_predict_quantiles` is converted to `_predict_interval` and how zero coverage is interpreted in the logic.\r\n\r\n**To Reproduce**\r\nToy example using the logic from `conformal_bonferroni` correction [code](https://github.com/sktime/sktime/blob/ad2619ba76675c9b8a9bc9174e5e442ca4730284/sktime/forecasting/conformal.py#L243):\r\n\r\n```python\r\n# Set alpha to 0.5 and a toy forecasting horizon and abs_residuals\r\nalpha = 0.5\r\nfh = [1,2,3,4,5]\r\nabs_resids = [0.1, 0.2, 0.3, 0.25, 0.1, 0.0001]\r\n\r\n# alpha is converted to coverage in `_predict_quantiles` base forecaster \r\ncoverage = np.abs(1 - 2 * alpha)\r\n# coverage = 0 \r\n\r\ncoverage2 = np.repeat(coverage, 2)\r\n# coverage2 = [0, 0]\r\n\r\nalphas = 1 - coverage2\r\n# alphas = [1, 1]\r\n\r\nquantiles = 1 - alphas / len(fh)\r\n# quantiles = [0.8, 0.8]\r\n\r\npred_int_row = np.quantile(abs_resids, quantiles)\r\n# pred_int_row = [0.3, 0.3]\r\n```\r\nI think even in the `conformal` logic this is (less) incorrect because you take the 0th quantile which is the smallest residual and I'm not sure if this is what you want to do. \r\n\r\nIn the toy example:\r\n```\r\nquantiles = coverage2\r\npred_int_row = np.quantile(abs_resids, quantiles)\r\n# pred_int_row = [0.0001, 0.0001]\r\n```\r\n\r\n**Expected behavior**\r\n`_predict_interval` with alpha = 0.5 and therefore coverage = 0 should return `y_pred + 0`\r\n\r\n\r\n**Versions**\r\n0.13.4\r\nSystem:\r\n    python: 3.8.13 (default, May  8 2022, 17:48:02)  [Clang 13.1.6 (clang-1316.0.21.2)]\r\nexecutable: /Users/bethrice/Documents/Code/uk-ds-day-ahead-prices-forecast/.venv/bin/python\r\n   machine: macOS-12.1-arm64-i386-64bit\r\n\r\nPython dependencies:\r\n          pip: 22.1.2\r\n   setuptools: 63.1.0\r\n      sklearn: 1.1.2\r\n       sktime: 0.13.4\r\n  statsmodels: 0.13.2\r\n        numpy: 1.22.0\r\n        scipy: 1.8.1\r\n       pandas: 1.4.1\r\n   matplotlib: 3.6.0\r\n       joblib: 1.2.0\r\n        numba: 0.56.2\r\n     pmdarima: None\r\n      tsfresh: None\r\n\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/3693/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/3693/timeline","performed_via_github_app":null,"state_reason":null}