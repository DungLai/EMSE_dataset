{"url":"https://api.github.com/repos/sktime/sktime/issues/670","repository_url":"https://api.github.com/repos/sktime/sktime","labels_url":"https://api.github.com/repos/sktime/sktime/issues/670/labels{/name}","comments_url":"https://api.github.com/repos/sktime/sktime/issues/670/comments","events_url":"https://api.github.com/repos/sktime/sktime/issues/670/events","html_url":"https://github.com/sktime/sktime/issues/670","id":806266268,"node_id":"MDU6SXNzdWU4MDYyNjYyNjg=","number":670,"title":"[BUG] Wrong Forecast calculation on freq values not 1","user":{"login":"mpindado","id":19164478,"node_id":"MDQ6VXNlcjE5MTY0NDc4","avatar_url":"https://avatars.githubusercontent.com/u/19164478?v=4","gravatar_id":"","url":"https://api.github.com/users/mpindado","html_url":"https://github.com/mpindado","followers_url":"https://api.github.com/users/mpindado/followers","following_url":"https://api.github.com/users/mpindado/following{/other_user}","gists_url":"https://api.github.com/users/mpindado/gists{/gist_id}","starred_url":"https://api.github.com/users/mpindado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpindado/subscriptions","organizations_url":"https://api.github.com/users/mpindado/orgs","repos_url":"https://api.github.com/users/mpindado/repos","events_url":"https://api.github.com/users/mpindado/events{/privacy}","received_events_url":"https://api.github.com/users/mpindado/received_events","type":"User","site_admin":false},"labels":[{"id":1118163262,"node_id":"MDU6TGFiZWwxMTE4MTYzMjYy","url":"https://api.github.com/repos/sktime/sktime/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3105906374,"node_id":"MDU6TGFiZWwzMTA1OTA2Mzc0","url":"https://api.github.com/repos/sktime/sktime/labels/module:forecasting","name":"module:forecasting","color":"35FCCE","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2021-02-11T10:38:14Z","updated_at":"2022-02-23T22:42:33Z","closed_at":"2022-02-23T22:42:32Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nHi! I have just come upon sktime and performing a quick test on ExponentialSmoothing with 15 minute data (freq=\"15T\") the prediction raises an exception, however, when using 1-frequencies (1T, 1H) etc the program seems to work.\r\n\r\nI think this is somehow related to issue #534.\r\n\r\n**To Reproduce**\r\n```python\r\nidx = pd.period_range(\"2021-01-01\", \"2021-01-02\", freq=\"15T\")\r\nvalues = np.random.randint(1, 10, len(idx))\r\nts = pd.Series(values, index=idx)\r\ny_train, y_test = temporal_train_test_split(ts, test_size=1/3)\r\nfh = np.arange(len(y_test)) + 1\r\nforecaster = ExponentialSmoothing(trend=\"add\")\r\nforecaster.fit(y_train)\r\ny_pred = forecaster.predict(fh)\r\n\r\nKeyError: \"None of [PeriodIndex(['2021-01-01 16:00', '2021-01-01 16:15', '2021-01-01 16:30',\\n             '2021-01-01 16:45', '2021-01-01 17:00', '2021-01-01 17:15',\\n             '2021-01-01 17:30', '2021-01-01 17:45', '2021-01-01 18:00',\\n             '2021-01-01 18:15', '2021-01-01 18:30', '2021-01-01 18:45',\\n             '2021-01-01 19:00', '2021-01-01 19:15', '2021-01-01 19:30',\\n             '2021-01-01 19:45', '2021-01-01 20:00', '2021-01-01 20:15',\\n             '2021-01-01 20:30', '2021-01-01 20:45', '2021-01-01 21:00',\\n             '2021-01-01 21:15', '2021-01-01 21:30', '2021-01-01 21:45',\\n             '2021-01-01 22:00', '2021-01-01 22:15', '2021-01-01 22:30',\\n             '2021-01-01 22:45', '2021-01-01 23:00', '2021-01-01 23:15',\\n             '2021-01-01 23:30', '2021-01-01 23:45', '2021-01-02 00:00'],\\n            dtype='period[15T]', freq='15T')] are in the [index]\"\r\n\r\n```\r\n\r\n**Expected behavior**\r\nPrediction should work.\r\n\r\n**Additional context**\r\nSo debugging, the problem seems to be over here in _fh.py\r\n\r\n```python\r\n        # Note: We should here also coerce to periods for more reliable arithmetic\r\n        # operations as in `to_relative` but currently doesn't work with\r\n        # `update_predict` and incomplete time indices where the `freq` information\r\n        # is lost, see comment on issue #534\r\n        integers = absolute - start\r\n\r\n        if isinstance(absolute, (pd.PeriodIndex, pd.DatetimeIndex)):\r\n            integers = _coerce_duration_to_int(integers, freq=_get_freq(cutoff))\r\n```\r\nThe function coerce_duration_to_int does not take into account the cutoff frequency on a PeriodIndex, as it does with TimeDeltas:\r\n```python\r\n    elif isinstance(duration, pd.Index) and isinstance(\r\n        duration[0], pd.tseries.offsets.BaseOffset\r\n    ):\r\n        return pd.Int64Index([d.n for d in duration])\r\n    elif isinstance(duration, (pd.Timedelta, pd.TimedeltaIndex)):\r\n        if freq is None:\r\n            raise ValueError(\"`unit` missing\")\r\n```\r\nAs a result, ``integers`` value is multiplied by 15 (in the example, for freq ```15T```), and PeriodIndex \"indexes\" generated are far bigger and so the exception.\r\n\r\n**Versions**\r\n<details>\r\n\r\nSystem:\r\n    python: 3.7.5 (tags/v3.7.5:5c02a39a0b, Oct 15 2019, 00:11:34) [MSC v.1916 64 bit (AMD64)]\r\nexecutable: C:\\Users\\XXX\\AppData\\Local\\Programs\\Python\\Python37\\python.exe\r\n   machine: Windows-10-10.0.19041-SP0\r\nPython dependencies:\r\n          pip: 20.1.1\r\n   setuptools: 41.2.0\r\n      sklearn: 0.24.1\r\n       sktime: 0.5.3\r\n  statsmodels: 0.12.2\r\n        numpy: 1.20.1\r\n        scipy: 1.3.3\r\n       Cython: 0.29.17\r\n       pandas: 1.2.2\r\n   matplotlib: 3.1.3\r\n       joblib: 0.14.0\r\n        numba: 0.52.0\r\n     pmdarima: 1.8.0\r\n      tsfresh: None\r\n\r\n</details>\r\n\r\n<!-- Thanks for contributing! -->\r\n","closed_by":{"login":"fkiraly","id":7985502,"node_id":"MDQ6VXNlcjc5ODU1MDI=","avatar_url":"https://avatars.githubusercontent.com/u/7985502?v=4","gravatar_id":"","url":"https://api.github.com/users/fkiraly","html_url":"https://github.com/fkiraly","followers_url":"https://api.github.com/users/fkiraly/followers","following_url":"https://api.github.com/users/fkiraly/following{/other_user}","gists_url":"https://api.github.com/users/fkiraly/gists{/gist_id}","starred_url":"https://api.github.com/users/fkiraly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkiraly/subscriptions","organizations_url":"https://api.github.com/users/fkiraly/orgs","repos_url":"https://api.github.com/users/fkiraly/repos","events_url":"https://api.github.com/users/fkiraly/events{/privacy}","received_events_url":"https://api.github.com/users/fkiraly/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sktime/sktime/issues/670/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sktime/sktime/issues/670/timeline","performed_via_github_app":null,"state_reason":"completed"}