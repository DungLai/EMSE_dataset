{"url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244","repository_url":"https://api.github.com/repos/dirty-cat/dirty_cat","labels_url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244/labels{/name}","comments_url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244/comments","events_url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244/events","html_url":"https://github.com/dirty-cat/dirty_cat/issues/244","id":1180973135,"node_id":"I_kwDOB3LOgs5GZDhP","number":244,"title":"Super Vectorizer transforms data to sparse matrices","user":{"login":"jovan-stojanovic","id":62058944,"node_id":"MDQ6VXNlcjYyMDU4OTQ0","avatar_url":"https://avatars.githubusercontent.com/u/62058944?v=4","gravatar_id":"","url":"https://api.github.com/users/jovan-stojanovic","html_url":"https://github.com/jovan-stojanovic","followers_url":"https://api.github.com/users/jovan-stojanovic/followers","following_url":"https://api.github.com/users/jovan-stojanovic/following{/other_user}","gists_url":"https://api.github.com/users/jovan-stojanovic/gists{/gist_id}","starred_url":"https://api.github.com/users/jovan-stojanovic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jovan-stojanovic/subscriptions","organizations_url":"https://api.github.com/users/jovan-stojanovic/orgs","repos_url":"https://api.github.com/users/jovan-stojanovic/repos","events_url":"https://api.github.com/users/jovan-stojanovic/events{/privacy}","received_events_url":"https://api.github.com/users/jovan-stojanovic/received_events","type":"User","site_admin":false},"labels":[{"id":865002870,"node_id":"MDU6TGFiZWw4NjUwMDI4NzA=","url":"https://api.github.com/repos/dirty-cat/dirty_cat/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-03-25T16:04:26Z","updated_at":"2022-10-11T07:52:59Z","closed_at":"2022-04-20T15:05:33Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Actual behavior\r\nThe [Super Vectorizer transform and fit_transform](https://dirty-cat.github.io/stable/_modules/dirty_cat/super_vectorizer.html#SuperVectorizer.fit_transform) methods have the following rule: \r\n\"If any result is a sparse matrix, everything will be converted to sparse matrices.\" This is the scipy.sparse.csr.csr_matrix type.\r\n\r\nHowever, this type is not commonly accepted for further analysis. \r\nFor instance, when applying a [cross_val_score()](https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_val_score.html) we need to first make the result an array to be able to apply the method.\r\nThis makes also the direct introduction of pipelines in [cross_val_score()](https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_val_score.html) impossible, as an error will appear.\r\n\r\n### Expected behavior\r\nSparse matrices happen when the encoded variable has a lot of categories. Maybe introduce a sparse=True parameter, just like [for the sklearn OHE](https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OneHotEncoder.html), that will return sparse matrix if set True and array if False.\r\n\r\n\r\n### Easy code to reproduce bug\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\nfrom sklearn.model_selection import cross_val_score\r\nfrom sklearn.pipeline import make_pipeline\r\nfrom sklearn.experimental import enable_hist_gradient_boosting\r\n# now you can import the HGBR from ensemble\r\nfrom sklearn.ensemble import HistGradientBoostingRegressor\r\nfrom dirty_cat import SuperVectorizer\r\n\r\nnp.random.seed(444) \r\ncol1 = np.random.choice(  \r\n     a=[0, 1, 2, 3],  \r\n     size=50,  \r\n     p=[0.4, 0.3, 0.2, 0.1])\r\n\r\ncol2 = np.random.choice(  \r\n     a=['a', 'b', 'c'],  \r\n     size=50,  \r\n     p=[0.4, 0.4, 0.2])\r\n\r\nresults = np.random.uniform( \r\n     size=50)\r\n\r\ndf = pd.DataFrame(np.array([col1, col2, results])).transpose()\r\n\r\nX = df.drop(columns=[2])\r\ny = df[2]\r\n\r\nsup_vec = SuperVectorizer()\r\n\r\npipeline = make_pipeline(\r\n    SuperVectorizer(auto_cast=True, sparse_threshold=0.3),\r\n    HistGradientBoostingRegressor()\r\n)\r\n\r\ncross_val_score(pipeline, X, y)\r\n```\r\n","closed_by":{"login":"LilianBoulard","id":33222654,"node_id":"MDQ6VXNlcjMzMjIyNjU0","avatar_url":"https://avatars.githubusercontent.com/u/33222654?v=4","gravatar_id":"","url":"https://api.github.com/users/LilianBoulard","html_url":"https://github.com/LilianBoulard","followers_url":"https://api.github.com/users/LilianBoulard/followers","following_url":"https://api.github.com/users/LilianBoulard/following{/other_user}","gists_url":"https://api.github.com/users/LilianBoulard/gists{/gist_id}","starred_url":"https://api.github.com/users/LilianBoulard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LilianBoulard/subscriptions","organizations_url":"https://api.github.com/users/LilianBoulard/orgs","repos_url":"https://api.github.com/users/LilianBoulard/repos","events_url":"https://api.github.com/users/LilianBoulard/events{/privacy}","received_events_url":"https://api.github.com/users/LilianBoulard/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dirty-cat/dirty_cat/issues/244/timeline","performed_via_github_app":null,"state_reason":"completed"}