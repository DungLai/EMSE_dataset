{"url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4","repository_url":"https://api.github.com/repos/guillaumegenthial/tf_metrics","labels_url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4/labels{/name}","comments_url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4/comments","events_url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4/events","html_url":"https://github.com/guillaumegenthial/tf_metrics/issues/4","id":390936008,"node_id":"MDU6SXNzdWUzOTA5MzYwMDg=","number":4,"title":"f1 scores are unstable with different evaluation batch size","user":{"login":"dsindex","id":8259057,"node_id":"MDQ6VXNlcjgyNTkwNTc=","avatar_url":"https://avatars.githubusercontent.com/u/8259057?v=4","gravatar_id":"","url":"https://api.github.com/users/dsindex","html_url":"https://github.com/dsindex","followers_url":"https://api.github.com/users/dsindex/followers","following_url":"https://api.github.com/users/dsindex/following{/other_user}","gists_url":"https://api.github.com/users/dsindex/gists{/gist_id}","starred_url":"https://api.github.com/users/dsindex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dsindex/subscriptions","organizations_url":"https://api.github.com/users/dsindex/orgs","repos_url":"https://api.github.com/users/dsindex/repos","events_url":"https://api.github.com/users/dsindex/events{/privacy}","received_events_url":"https://api.github.com/users/dsindex/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-12-14T02:05:17Z","updated_at":"2018-12-14T05:38:35Z","closed_at":"2018-12-14T05:38:35Z","author_association":"NONE","active_lock_reason":null,"body":"Hello~\r\n\r\ni used `tf_metrics` in https://github.com/dsindex/BERT-BiLSTM-CRF-NER/blob/master/bert_lstm_ner.py\r\n\r\n```\r\n    estimator = tf.contrib.tpu.TPUEstimator(\r\n        use_tpu=FLAGS.use_tpu,\r\n        model_fn=model_fn,\r\n        config=run_config,\r\n        train_batch_size=FLAGS.train_batch_size,\r\n        eval_batch_size=FLAGS.eval_batch_size,\r\n        predict_batch_size=FLAGS.predict_batch_size)\r\n\r\n...\r\n\r\n        def metric_fn(label_ids, pred_ids, per_example_loss, input_mask):\r\n                    # ['<pad>'] + [\"O\", \"B-PER\", \"I-PER\", \"B-ORG\", \"I-ORG\", \"B-LOC\", \"I-LOC\", \"B-MISC\", \"I-MISC\", \"X\"]\r\n                    indices = [2, 3, 4, 5, 6, 7, 8, 9]\r\n                    precision = tf_metrics.precision(label_ids, pred_ids, num_labels, indices, input_mask)\r\n                    recall = tf_metrics.recall(label_ids, pred_ids, num_labels, indices, input_mask)\r\n                    f = tf_metrics.f1(label_ids, pred_ids, num_labels, indices, input_mask)\r\n                    accuracy = tf.metrics.accuracy(label_ids, pred_ids, input_mask)\r\n                    loss = tf.metrics.mean(per_example_loss)\r\n                    return {\r\n                        'eval_precision': precision,\r\n                        'eval_recall': recall,\r\n                        'eval_f': f,\r\n                        'eval_accuracy': accuracy,\r\n                        'eval_loss': loss,\r\n                    }\r\n                eval_metrics = (metric_fn, [label_ids, pred_ids, per_example_loss, input_mask])\r\n                output_spec = tf.contrib.tpu.TPUEstimatorSpec(\r\n                    mode=mode,\r\n                    loss=total_loss,\r\n                    eval_metrics=eval_metrics,\r\n                    scaffold_fn=scaffold_fn)\r\n\r\n...\r\n```\r\n\r\nand the training script https://github.com/dsindex/BERT-BiLSTM-CRF-NER/blob/master/train.sh\r\n\r\n```\r\npython bert_lstm_ner.py   \\\r\n        --task_name=\"NER\"  \\\r\n        --do_train=True   \\\r\n        --use_feature_based=False \\\r\n        --do_predict=True \\\r\n        --use_crf=True \\\r\n        --data_dir=${CDIR}/NERdata  \\\r\n        --vocab_file=${bert_model_dir}/vocab.txt  \\\r\n        --do_lower_case=${lowercase} \\\r\n        --bert_config_file=${bert_model_dir}/bert_config.json \\\r\n        --init_checkpoint=${bert_model_dir}/bert_model.ckpt   \\\r\n        --max_seq_length=150   \\\r\n        --lstm_size=256 \\\r\n        --train_batch_size=32   \\\r\n        --eval_batch_size=128   \\\r\n        --predict_batch_size=128   \\\r\n        --bert_dropout_rate=0.1 \\\r\n        --bilstm_dropout_rate=0.1 \\\r\n        --learning_rate=2e-5   \\\r\n        --num_train_epochs=100   \\\r\n        --data_config_path=${CDIR}/data.conf \\\r\n        --output_dir=${CDIR}/output/result_dir/\r\n```\r\n\r\nthe situation is, \r\n\r\nwhen i set the `train_batch_size` 32 -> 6 and `eval_batch_size` 128 to 6, `eval_f` scores are not same.\r\nexactly speaking, the lower batch_size the higher `eval_f` score we have.\r\nis it normal?","closed_by":{"login":"dsindex","id":8259057,"node_id":"MDQ6VXNlcjgyNTkwNTc=","avatar_url":"https://avatars.githubusercontent.com/u/8259057?v=4","gravatar_id":"","url":"https://api.github.com/users/dsindex","html_url":"https://github.com/dsindex","followers_url":"https://api.github.com/users/dsindex/followers","following_url":"https://api.github.com/users/dsindex/following{/other_user}","gists_url":"https://api.github.com/users/dsindex/gists{/gist_id}","starred_url":"https://api.github.com/users/dsindex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dsindex/subscriptions","organizations_url":"https://api.github.com/users/dsindex/orgs","repos_url":"https://api.github.com/users/dsindex/repos","events_url":"https://api.github.com/users/dsindex/events{/privacy}","received_events_url":"https://api.github.com/users/dsindex/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/guillaumegenthial/tf_metrics/issues/4/timeline","performed_via_github_app":null,"state_reason":"completed"}