[{"id":3717394120,"node_id":"MDEyOkxhYmVsZWRFdmVudDM3MTczOTQxMjA=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3717394120","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-09-02T01:02:13Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"id":3717394133,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcxNzM5NDEzMw==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3717394133","actor":{"login":"gpu","id":513379,"node_id":"MDQ6VXNlcjUxMzM3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/513379?v=4","gravatar_id":"","url":"https://api.github.com/users/gpu","html_url":"https://github.com/gpu","followers_url":"https://api.github.com/users/gpu/followers","following_url":"https://api.github.com/users/gpu/following{/other_user}","gists_url":"https://api.github.com/users/gpu/gists{/gist_id}","starred_url":"https://api.github.com/users/gpu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpu/subscriptions","organizations_url":"https://api.github.com/users/gpu/orgs","repos_url":"https://api.github.com/users/gpu/repos","events_url":"https://api.github.com/users/gpu/events{/privacy}","received_events_url":"https://api.github.com/users/gpu/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-02T01:02:13Z","performed_via_github_app":null},{"id":3717394136,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MTczOTQxMzY=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3717394136","actor":{"login":"gpu","id":513379,"node_id":"MDQ6VXNlcjUxMzM3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/513379?v=4","gravatar_id":"","url":"https://api.github.com/users/gpu","html_url":"https://github.com/gpu","followers_url":"https://api.github.com/users/gpu/followers","following_url":"https://api.github.com/users/gpu/following{/other_user}","gists_url":"https://api.github.com/users/gpu/gists{/gist_id}","starred_url":"https://api.github.com/users/gpu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpu/subscriptions","organizations_url":"https://api.github.com/users/gpu/orgs","repos_url":"https://api.github.com/users/gpu/repos","events_url":"https://api.github.com/users/gpu/events{/privacy}","received_events_url":"https://api.github.com/users/gpu/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-02T01:02:13Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685896035","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-685896035","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":685896035,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTg5NjAzNQ==","user":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T17:47:45Z","updated_at":"2020-09-02T17:50:06Z","author_association":"MEMBER","body":"I can reproduce the problem and I can make sure that if we use \"fp32\", the precision is higher. One possibility is that by changing the batchsize, CUBLAS is picking different internal GEMM implementations.","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685896035/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685898872","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-685898872","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":685898872,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTg5ODg3Mg==","user":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T17:53:29Z","updated_at":"2020-09-02T17:53:29Z","author_association":"MEMBER","body":"@davisliang I think it might be related to the internal implementation of CUBLAS. For example, batch_size=200 and batch_size=300 have the same results:\r\n\r\n```python\r\nimport mxnet\r\nfrom mxnet import nd\r\nfrom gluonnlp.model import bert\r\nimport gluonnlp as nlp; import mxnet as mx;\r\n\r\n# load model\r\nmodel, vocab = nlp.model.get_model('bert_12_768_12', ctx=mx.gpu(0), dataset_name='book_corpus_wiki_en_uncased', use_pooler=True, use_classifier=False, use_decoder=False);\r\ntokenizer = nlp.data.BERTTokenizer(vocab, lower=True);\r\ntransform = nlp.data.BERTSentenceTransform(tokenizer, max_seq_length=512, pair=False, pad=False);\r\nmodel.cast('float16')\r\n\r\n# construct examples with batch size of 300 and first 27 out of 300.\r\nmini_length=200\r\ninput_batch = nd.random.uniform(-10,10,(300,100), dtype='float16').as_in_context(mx.gpu(0))\r\ninput_batch_mini = input_batch[:mini_length] \r\n\r\nvalid_len = nd.array([100]*300, dtype='float16').as_in_context(mx.gpu(0))\r\nsegments = nd.zeros((300,100), dtype='float16').as_in_context(mx.gpu(0))\r\nout = model(input_batch, segments, valid_len)\r\nprint(\"Batch Size 300: \", out[0][1])\r\n\r\nvalid_len_mini = nd.array([100]*mini_length, dtype='float16').as_in_context(mx.gpu(0))\r\nsegments_mini = nd.zeros((mini_length,100), dtype='float16').as_in_context(mx.gpu(0))\r\nout_mini = model(input_batch_mini, segments_mini, valid_len_mini)\r\nprint(\"Batch Size 200: \", out_mini[0][1])\r\n```\r\nOutput:\r\n\r\n```\r\nBatch Size 300:  \r\n[[ 0.04575   0.1301    0.2268   ... -0.08203  -0.02853  -0.01185 ]\r\n [ 0.1333    0.253     0.4124   ...  0.0467    0.2424    0.006683]\r\n [ 0.249     0.3232    0.3547   ... -0.2207    0.1804    0.004776]\r\n ...\r\n [ 0.3464    0.55      0.4507   ... -0.1503    0.0838    0.1586  ]\r\n [ 0.3286    0.619     0.521    ... -0.1721    0.02725   0.1776  ]\r\n [ 0.2197    0.6885    0.658    ... -0.246    -0.00241   0.2101  ]]\r\n<NDArray 100x768 @gpu(0)>\r\nBatch Size 27:  \r\n[[ 0.04575   0.1301    0.2268   ... -0.08203  -0.02853  -0.01185 ]\r\n [ 0.1333    0.253     0.4124   ...  0.0467    0.2424    0.006683]\r\n [ 0.249     0.3232    0.3547   ... -0.2207    0.1804    0.004776]\r\n ...\r\n [ 0.3464    0.55      0.4507   ... -0.1503    0.0838    0.1586  ]\r\n [ 0.3286    0.619     0.521    ... -0.1721    0.02725   0.1776  ]\r\n [ 0.2197    0.6885    0.658    ... -0.246    -0.00241   0.2101  ]]\r\n<NDArray 100x768 @gpu(0)>\r\n```\r\n\r\nI think that CUBLAS is doing something special when the shape of the matrix is small. @MoisesHer would you think that it's attributed to CUBLAS?","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685898872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false}},{"id":3721068980,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyMTA2ODk4MA==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3721068980","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-02T17:53:29Z","performed_via_github_app":null},{"id":3721068985,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjEwNjg5ODU=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3721068985","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-02T17:53:29Z","performed_via_github_app":null},{"id":3721068988,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyMTA2ODk4OA==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3721068988","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-02T17:53:29Z","performed_via_github_app":null},{"id":3721068993,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjEwNjg5OTM=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3721068993","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-02T17:53:29Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685900486","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-685900486","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":685900486,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTkwMDQ4Ng==","user":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T17:56:44Z","updated_at":"2020-09-02T17:56:44Z","author_association":"NONE","body":"That's what we initially thought too. However, the difference (for fp16 in the 3rd significant digit) is quite large (which I didn't expect from just choosing a different GEMM implementation) and could significantly impact the final outputs. ","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685900486/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685909194","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-685909194","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":685909194,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTkwOTE5NA==","user":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T18:12:57Z","updated_at":"2020-09-02T18:12:57Z","author_association":"MEMBER","body":"I agree. Looks like something else is wrong:\r\n\r\n```python\r\n\r\nimport mxnet\r\nimport os\r\nfrom mxnet import nd\r\nfrom gluonnlp.model import bert\r\nimport numpy.testing as npt\r\nimport gluonnlp as nlp; import mxnet as mx;\r\n\r\nos.environ['MXNET_USE_FUSION'] = '0'\r\nos.environ['MXNET_SAFE_ACCUMULATION'] = '1'\r\n\r\ndata_type = 'float16'\r\n\r\n# load model\r\nmodel, vocab = nlp.model.get_model('bert_12_768_12', ctx=mx.gpu(0), dataset_name='book_corpus_wiki_en_uncased', use_pooler=True, use_classifier=False, use_decoder=False);\r\nmodel.cast(data_type)\r\n\r\n# construct examples with batch size of 300 and first 27 out of 300.\r\nmini_length=2\r\ninput_batch = nd.random.uniform(-10,10,(300,100), dtype=data_type).as_in_context(mx.gpu(0))\r\ninput_batch_mini = input_batch[:mini_length] \r\n\r\nvalid_len = nd.array([100]*300, dtype=data_type).as_in_context(mx.gpu(0))\r\nsegments = nd.zeros((300,100), dtype=data_type).as_in_context(mx.gpu(0))\r\nout = model(input_batch, segments, valid_len)\r\nprint(\"Batch Size 300: \", out[0][1])\r\n\r\nvalid_len_mini = nd.array([100]*mini_length, dtype=data_type).as_in_context(mx.gpu(0))\r\nsegments_mini = nd.zeros((mini_length,100), dtype=data_type).as_in_context(mx.gpu(0))\r\nout_mini = model(input_batch_mini, segments_mini, valid_len_mini)\r\nprint(\"Batch Size 2: \", out_mini[0][1])\r\n\r\nnpt.assert_allclose(out[0][1].asnumpy(), out_mini[0][1].asnumpy(), 1E-4, 1E-4)\r\n```\r\n\r\nOutput:\r\n```\r\nAssertionError: \r\nNot equal to tolerance rtol=0.0001, atol=0.0001\r\n\r\nMismatched elements: 62389 / 76800 (81.2%)\r\nMax absolute difference: 0.01758\r\nMax relative difference: 56.\r\n x: array([[-0.2172  ,  0.2144  , -0.05106 , ...,  0.07526 ,  0.772   ,\r\n        -0.1335  ],\r\n       [-0.2283  , -0.001389,  0.172   , ..., -0.1278  ,  0.6006  ,...\r\n y: array([[-0.2181  ,  0.2146  , -0.05167 , ...,  0.0749  ,  0.7734  ,\r\n        -0.1337  ],\r\n       [-0.2291  , -0.001083,  0.1732  , ..., -0.128   ,  0.5996  ,...\r\n```","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/685909194/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false}},{"id":3721559721,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQzNzIxNTU5NzIx","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3721559721","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2020-09-02T20:05:16Z","assignee":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686651019","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-686651019","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":686651019,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjY1MTAxOQ==","user":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T17:49:15Z","updated_at":"2020-09-03T17:49:15Z","author_association":"CONTRIBUTOR","body":"Hi, I was able to reproduce the issue on a G4 instance.\r\nI also checked and the issue does not happen on P3 instances (V100).\r\nMy opinion is that different accumulation strategies across K dim is causing this behavior.\r\n\r\nI looked at the cuBLAS kernels being called on G4:\r\n**BS300** (BatchSize 300)\r\n- 24 x turing_fp16_s1688gemm_fp16_128x256_ldg8_f2f_tn  (outProjection & FFN2)\r\n- 12 x turing_fp16_s1688gemm_fp16_256x128_ldg8_f2f_tn (FFN1)\r\n- 12 x turing_fp16_s1688gemm_fp16_128x128_ldg8_f2f_tn (q/k/v projection)\r\n- 12 x volta_fp16_sgemm_fp16_128x64_nn (Soft x Value)\r\n- 12 x volta_fp16_sgemm_fp16_128x64_tn (QxK)\r\n\r\n**BS27** (BatchSize 27)\r\n- 24 x turing_fp16_s1688gemm_fp16_128x128_ldg8_f2f_tn (q/k/v projection & FFN2)\r\n- 12  turing_fp16_s1688gemm_fp16_256x128_ldg8_f2f_tn (FFN1)\r\n- 12  turing_fp16_s1688gemm_fp16_128x256_ldg8_f2f_tn (outProjection)\r\n- 12  volta_fp16_sgemm_fp16_128x64_nn (Soft x Value)\r\n- 12  volta_fp16_sgemm_fp16_128x64_tn (QxK)\r\n\r\nThe only difference is computing the second GEMM in FeedForward (FFN2).\r\nBS300 uses different tile size (MxN subdivisions) compared to BS27 case.\r\nNormally, accumulation across K dimension is computed by a single thread, for any tile size in principle.\r\nSo that should not cause the different results here.\r\n\r\nHowever, when K dim is large compared to M and N, the algorithm splits it into several chunks to improve performance \r\n(documented in [https://docs.nvidia.com/cuda/cublas/index.html#gemm-algorithms](https://docs.nvidia.com/cuda/cublas/index.html#gemm-algorithms)).\r\n\r\nIn this case, FFN2 dimensions are:\r\nM: 128*BatchSize,\r\nN: 768\r\n**K: 3072**\r\nAnd with BS27, K is considered large compare to M and N. Therefor K is split. \r\nIf for the GEMMs you use FP32 accumulation (default mode) and FP16 inputs, each intermediate output is cast to FP16, and finally all the intermediates are summed up in a determinism way.\r\nHere, several cast ops may lead to a different output compared to a single cast (when K is not split). \r\n\r\nThose cast can be avoided if you use the same accumulation data-type as input data-type, i.e. FP16, by doing:\r\n`export MXNET_FC_TRUE_FP16=1`.\r\n","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686651019/reactions","total_count":5,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":5,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686758896","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-686758896","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":686758896,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Njc1ODg5Ng==","user":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T20:52:33Z","updated_at":"2020-09-03T20:52:33Z","author_association":"NONE","body":"Thank you, @MoisesHer,  for the quick response, deep analysis, and effective solution! \r\n\r\nOne minor point: I ran into the same problem running the above code on a p3.24dn.xlarge on **Driver Version**: 440.33.01, **CUDA Version**: 10.2. However, using export MXNET_FC_TRUE_FP16 fixed the issue there as well.\r\n\r\nThanks again. Resolving this ticket as solved.","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686758896/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false}},{"id":3726660251,"node_id":"MDExOkNsb3NlZEV2ZW50MzcyNjY2MDI1MQ==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3726660251","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-09-03T20:52:33Z","state_reason":null,"performed_via_github_app":null},{"id":3726660266,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyNjY2MDI2Ng==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3726660266","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-03T20:52:33Z","performed_via_github_app":null},{"id":3726660270,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjY2NjAyNzA=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3726660270","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-03T20:52:33Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686830389","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-686830389","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":686830389,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgzMDM4OQ==","user":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"created_at":"2020-09-04T00:24:50Z","updated_at":"2020-09-04T00:53:47Z","author_association":"NONE","body":"@MoisesHer, I found that this issue still persists if even smaller batch sizes (e.g. 5) is used. Are you able to reproduce this? I'm guessing it's another GEMM that's causing the issue. Would there be an easy way to prevent  this chunking behavior or would this be very detrimental to performance?","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686830389/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false}},{"id":3727304634,"node_id":"MDEzOlJlb3BlbmVkRXZlbnQzNzI3MzA0NjM0","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3727304634","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"reopened","commit_id":null,"commit_url":null,"created_at":"2020-09-04T00:24:50Z","state_reason":null,"performed_via_github_app":null},{"id":3727304641,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyNzMwNDY0MQ==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3727304641","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-04T00:24:50Z","performed_via_github_app":null},{"id":3727304645,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjczMDQ2NDU=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3727304645","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-04T00:24:50Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686838955","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-686838955","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":686838955,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgzODk1NQ==","user":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"created_at":"2020-09-04T01:00:13Z","updated_at":"2020-09-04T01:04:41Z","author_association":"CONTRIBUTOR","body":"Hi Davis,\r\nI just tested on G4, but comparing BS300 vs BS5 I get same results:\r\n\r\n```\r\nBatch Size 300:  \r\n[[-0.2183   0.2122  -0.0538  ...  0.07495  0.77    -0.1342 ]\r\n [-0.2307  -0.00264  0.1754  ... -0.1316   0.5967  -0.2522 ]\r\n [-0.4597   0.1744   0.619   ... -0.2089   0.2754  -0.5156 ]\r\n ...\r\n [-0.1115   0.2285   0.8613  ... -0.3718   0.3672  -0.4097 ]\r\n [-0.1188   0.2896   0.89    ... -0.294    0.4006  -0.4697 ]\r\n [-0.2388   0.3208   0.9727  ... -0.3904   0.3638  -0.543  ]]\r\n<NDArray 100x768 @gpu(0)>\r\nBatch Size 5:  \r\n[[-0.2183   0.2122  -0.0538  ...  0.07495  0.77    -0.1342 ]\r\n [-0.2307  -0.00264  0.1754  ... -0.1316   0.5967  -0.2522 ]\r\n [-0.4597   0.1744   0.619   ... -0.2089   0.2754  -0.5156 ]\r\n ...\r\n [-0.1115   0.2285   0.8613  ... -0.3718   0.3672  -0.4097 ]\r\n [-0.1188   0.2896   0.89    ... -0.294    0.4006  -0.4697 ]\r\n [-0.2388   0.3208   0.9727  ... -0.3904   0.3638  -0.543  ]]\r\n<NDArray 100x768 @gpu(0)>\r\n\r\n```\r\nBut in any case, I think that even if there are not fp32- fp16 casts, since accumulation strategy is different, what you are observing may happens.\r\nA single thread accumulating(1...N), may end with different results than\r\naccumulation(1...N/2) + accumulation(N/2+1 ....  N), specially with lower precision types.","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686838955/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686891228","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-686891228","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":686891228,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Njg5MTIyOA==","user":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"created_at":"2020-09-04T04:07:08Z","updated_at":"2020-09-04T04:07:08Z","author_association":"MEMBER","body":"@davisliang How many points have you lost due to this error?","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/686891228/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false}},{"id":3727779348,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyNzc3OTM0OA==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3727779348","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-04T04:07:09Z","performed_via_github_app":null},{"id":3727779349,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3Mjc3NzkzNDk=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3727779349","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-04T04:07:09Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/687799294","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-687799294","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":687799294,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Nzc5OTI5NA==","user":{"login":"gpu","id":513379,"node_id":"MDQ6VXNlcjUxMzM3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/513379?v=4","gravatar_id":"","url":"https://api.github.com/users/gpu","html_url":"https://github.com/gpu","followers_url":"https://api.github.com/users/gpu/followers","following_url":"https://api.github.com/users/gpu/following{/other_user}","gists_url":"https://api.github.com/users/gpu/gists{/gist_id}","starred_url":"https://api.github.com/users/gpu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpu/subscriptions","organizations_url":"https://api.github.com/users/gpu/orgs","repos_url":"https://api.github.com/users/gpu/repos","events_url":"https://api.github.com/users/gpu/events{/privacy}","received_events_url":"https://api.github.com/users/gpu/received_events","type":"User","site_admin":false},"created_at":"2020-09-06T14:08:08Z","updated_at":"2020-09-08T16:26:06Z","author_association":"NONE","body":"Some usernames may cause you to receive potentially interesting notifications :-) \r\n\r\nThe discussion here is on a *very* high technical level, and I cannot contribute anything, except for, maybe, leaving a pointer to the \"batched\" functions at https://docs.nvidia.com/cuda/cublas/index.html#cublas-lt-t-gt-gemmbatched that (to my limited understanding) have been introduced exactly for the use case of doing a particularly efficient GEMM for many (\"small\") matrices - not sure whether this is relevant for you, though...\r\n","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/687799294/reactions","total_count":1,"+1":0,"-1":0,"laugh":1,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"gpu","id":513379,"node_id":"MDQ6VXNlcjUxMzM3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/513379?v=4","gravatar_id":"","url":"https://api.github.com/users/gpu","html_url":"https://github.com/gpu","followers_url":"https://api.github.com/users/gpu/followers","following_url":"https://api.github.com/users/gpu/following{/other_user}","gists_url":"https://api.github.com/users/gpu/gists{/gist_id}","starred_url":"https://api.github.com/users/gpu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpu/subscriptions","organizations_url":"https://api.github.com/users/gpu/orgs","repos_url":"https://api.github.com/users/gpu/repos","events_url":"https://api.github.com/users/gpu/events{/privacy}","received_events_url":"https://api.github.com/users/gpu/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/702860796","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344#issuecomment-702860796","issue_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","id":702860796,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMjg2MDc5Ng==","user":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"created_at":"2020-10-02T17:28:07Z","updated_at":"2020-10-02T17:28:07Z","author_association":"NONE","body":"> @davisliang How many points have you lost due to this error?\r\n\r\nHi @sxjscience, we find that the difference is quite small. Marking as resolved, thanks all!","reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/comments/702860796/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false}},{"id":3834950081,"node_id":"MDExOkNsb3NlZEV2ZW50MzgzNDk1MDA4MQ==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3834950081","actor":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-10-02T17:28:07Z","state_reason":null,"performed_via_github_app":null},{"id":3834950092,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzgzNDk1MDA5Mg==","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3834950092","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-02T17:28:08Z","performed_via_github_app":null},{"id":3834950098,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM4MzQ5NTAwOTg=","url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/events/3834950098","actor":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-02T17:28:08Z","performed_via_github_app":null}]