{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/861","id":476452392,"node_id":"MDU6SXNzdWU0NzY0NTIzOTI=","number":861,"title":"Bert backward propagation order isn't correct ??","user":{"login":"YouhuiBai","id":27176645,"node_id":"MDQ6VXNlcjI3MTc2NjQ1","avatar_url":"https://avatars.githubusercontent.com/u/27176645?v=4","gravatar_id":"","url":"https://api.github.com/users/YouhuiBai","html_url":"https://github.com/YouhuiBai","followers_url":"https://api.github.com/users/YouhuiBai/followers","following_url":"https://api.github.com/users/YouhuiBai/following{/other_user}","gists_url":"https://api.github.com/users/YouhuiBai/gists{/gist_id}","starred_url":"https://api.github.com/users/YouhuiBai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YouhuiBai/subscriptions","organizations_url":"https://api.github.com/users/YouhuiBai/orgs","repos_url":"https://api.github.com/users/YouhuiBai/repos","events_url":"https://api.github.com/users/YouhuiBai/events{/privacy}","received_events_url":"https://api.github.com/users/YouhuiBai/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"eric-haibin-lin","id":5545640,"node_id":"MDQ6VXNlcjU1NDU2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/5545640?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-haibin-lin","html_url":"https://github.com/eric-haibin-lin","followers_url":"https://api.github.com/users/eric-haibin-lin/followers","following_url":"https://api.github.com/users/eric-haibin-lin/following{/other_user}","gists_url":"https://api.github.com/users/eric-haibin-lin/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-haibin-lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-haibin-lin/subscriptions","organizations_url":"https://api.github.com/users/eric-haibin-lin/orgs","repos_url":"https://api.github.com/users/eric-haibin-lin/repos","events_url":"https://api.github.com/users/eric-haibin-lin/events{/privacy}","received_events_url":"https://api.github.com/users/eric-haibin-lin/received_events","type":"User","site_admin":false},"assignees":[{"login":"eric-haibin-lin","id":5545640,"node_id":"MDQ6VXNlcjU1NDU2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/5545640?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-haibin-lin","html_url":"https://github.com/eric-haibin-lin","followers_url":"https://api.github.com/users/eric-haibin-lin/followers","following_url":"https://api.github.com/users/eric-haibin-lin/following{/other_user}","gists_url":"https://api.github.com/users/eric-haibin-lin/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-haibin-lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-haibin-lin/subscriptions","organizations_url":"https://api.github.com/users/eric-haibin-lin/orgs","repos_url":"https://api.github.com/users/eric-haibin-lin/repos","events_url":"https://api.github.com/users/eric-haibin-lin/events{/privacy}","received_events_url":"https://api.github.com/users/eric-haibin-lin/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2019-08-03T13:36:05Z","updated_at":"2019-12-13T05:37:00Z","closed_at":"2019-12-13T05:37:00Z","author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nHi, I downloaded Bert source code from [Bert](https://gluon-nlp.mxnet.io/model_zoo/bert/index.html), and ran successfully at a single machine with one GPU. Then I expanded the code and made it be with the support of Horovod, modified source code [here](https://gitee.com/YouhuiBai/Bert), only changed the `finetune_classifier.py`, then I ran it with 2 servers with one GPU per machine, and profiled the process with [Horovod timeline](https://github.com/horovod/horovod/blob/master/docs/timeline.rst), found that there was no overlap between backward computation and communication, namely, it begins to transfer after the completion of backward, cause the order of transfer is exactly the same with forward computation order.\r\n\r\nThe earliest operators completed from mxnet engine will be transferred first by Horovod, but the transfer order is the same with forward's order, so I think the backward completion order from mxnet engine is not correct. Can anyone give some suggestions? \r\n\r\nThanks.\r\n\r\n## To Reproduce\r\nI used the latest code from [Bert](https://gluon-nlp.mxnet.io/model_zoo/bert/index.html) and made it be with the support of horovod too, the same result I can get.\r\n\r\n## What have you tried to solve it?\r\n\r\n1. I changed the Bert computation graph from static to dynamic, but it didn't matter.\r\n2. I tracked to mxnet imperative computation graph, the node ids indicate that the backward order is the reverse of forward, then the operators are sent to mxnet engine to execute with dependency.\r\n\r\n\r\nBut the Bert from google-research with tensorflow and horovod does have overlap between backward and communication. And the image-classification models from [here](https://github.com/horovod/horovod/blob/master/examples/mxnet_imagenet_resnet50.py) also have overlap with mxnet and horovod.\r\n\r\n## Environment\r\n\r\ngluonnlp 0.7.1, mxnet 1.5.0, horovod 0.16.1, openmpi 3.1.2\r\n\r\n# paste outputs here\r\nFor example, you can see that the transformer1 is transferred after transformer0, but the transformer1 is computed and completed first in backward propagation in theory.\r\n![image](https://user-images.githubusercontent.com/27176645/62412480-886ede80-b635-11e9-8583-6ab603bb55d3.png)\r\n","closed_by":{"login":"eric-haibin-lin","id":5545640,"node_id":"MDQ6VXNlcjU1NDU2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/5545640?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-haibin-lin","html_url":"https://github.com/eric-haibin-lin","followers_url":"https://api.github.com/users/eric-haibin-lin/followers","following_url":"https://api.github.com/users/eric-haibin-lin/following{/other_user}","gists_url":"https://api.github.com/users/eric-haibin-lin/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-haibin-lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-haibin-lin/subscriptions","organizations_url":"https://api.github.com/users/eric-haibin-lin/orgs","repos_url":"https://api.github.com/users/eric-haibin-lin/repos","events_url":"https://api.github.com/users/eric-haibin-lin/events{/privacy}","received_events_url":"https://api.github.com/users/eric-haibin-lin/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/861/timeline","performed_via_github_app":null,"state_reason":"completed"}