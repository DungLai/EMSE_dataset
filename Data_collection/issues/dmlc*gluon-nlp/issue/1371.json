{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1371","id":706120265,"node_id":"MDU6SXNzdWU3MDYxMjAyNjU=","number":1371,"title":"BERT multi-node pretraining hangs when using Horovod with HOROVOD_GPU_OPERATION=MPI","user":{"login":"rondogency","id":6558914,"node_id":"MDQ6VXNlcjY1NTg5MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6558914?v=4","gravatar_id":"","url":"https://api.github.com/users/rondogency","html_url":"https://github.com/rondogency","followers_url":"https://api.github.com/users/rondogency/followers","following_url":"https://api.github.com/users/rondogency/following{/other_user}","gists_url":"https://api.github.com/users/rondogency/gists{/gist_id}","starred_url":"https://api.github.com/users/rondogency/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rondogency/subscriptions","organizations_url":"https://api.github.com/users/rondogency/orgs","repos_url":"https://api.github.com/users/rondogency/repos","events_url":"https://api.github.com/users/rondogency/events{/privacy}","received_events_url":"https://api.github.com/users/rondogency/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-09-22T06:41:25Z","updated_at":"2020-10-06T17:53:08Z","closed_at":"2020-10-06T17:53:08Z","author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nBERT Pretraining with Horovod hangs intermittently in the middle of the training, this happens around 1 out of 4 runs and hangs at mostly around 4400 steps\r\n\r\nCurrently I can only reproduce it with Horovod CPU mode built with HOROVOD_GPU_OPERATION=MPI, but cannot reproduce with HOROVOD_GPU_OPERATION=NCCL\r\n\r\nMore inspection shows that the hangs happens in one of the rank process the datasetloader creating a lot of threads, causing that process to hang, and other process will wait for that process causing the whole training to hang\r\n\r\n### Error Message\r\nFrom mpirun output error message regarding the hanging process \r\n```\r\n[1,56]<stderr>:Exception in thread Thread-1:\r\n[1,56]<stderr>:Traceback (most recent call last):\r\n[1,56]<stderr>:  File \"/shared/mx_env/lib/python3.8/threading.py\", line 932, in _bootstrap_inner\r\n[1,56]<stderr>:    self.run()\r\n[1,56]<stderr>:  File \"/shared/mx_env/lib/python3.8/threading.py\", line 870, in run\r\n[1,56]<stderr>:    self._target(*self._args, **self._kwargs)\r\n[1,56]<stderr>:  File \"/shared/mx_env/lib/python3.8/multiprocessing/managers.py\", line 192, in accepter\r\n[1,56]<stderr>:    t.start()\r\n[1,56]<stderr>:  File \"/shared/mx_env/lib/python3.8/threading.py\", line 852, in start\r\n[1,56]<stderr>:    _start_new_thread(self._bootstrap, ())\r\n[1,56]<stderr>:RuntimeError: can't start new thread\r\n```\r\nIf putting error logs, at the time of hanging the batchify worker pool function won't be run https://github.com/dmlc/gluon-nlp/blob/v0.10.x/src/gluonnlp/data/datasetloader.py#L55\r\n\r\n## To Reproduce\r\n(If you developed your own code, please provide a short script that reproduces the error. For existing examples, please provide link.)\r\n\r\n### Steps to reproduce\r\n(Paste the commands you ran that produced the error.)\r\n\r\n1. Have 8 p3dn.24xlarge machines and form a cluster that can run mpi, write all hostname into a host file\r\n2. Mount a shared fsx drive and have a conda env with installation of latest Horovod and gluonnlp\r\n3. Download BERT data to shared folder and run pretraining using 0.10.0 scripts\r\n```\r\n/opt/amazon/openmpi/bin/mpirun --hostfile /shared/hostfile -N 8 --allow-run-as-root --mca plm_rsh_no_tree_spawn 1 \\\r\n--tag-output -mca btl_tcp_if_include ens5 -x RDMAV_FORK_SAFE=1 -x LD_LIBRARY_PATH -x PATH -x \\\r\nNCCL_SOCKET_IFNAME=ens5 --oversubscribe -x MXNET_SAFE_ACCUMULATION=1 -x FI_PROVIDER=\"efa\" \\\r\n/shared/mx_env/bin/python /shared/gluon-nlp/scripts/bert/run_pretraining.py --data='/shared/bert_data/*.train' \\\r\n--data_eval='/shared/bert_eval/*.dev' --num_steps 125000 --lr 1e-4 --total_batch_size 2048 --total_batch_size_eval 2048 \\\r\n--accumulate 1 --raw --comm_backend horovod --max_seq_length 128 --max_predictions_per_seq 20 \\\r\n--num_dataset_workers 4 --num_batch_workers 2 --circle_length 2 --verbose --log_interval 1\r\n```\r\n4. Can comment out backward and train.step to make reproducing faster\r\n\r\n## What have you tried to solve it?\r\n\r\n1. Try reproducing with NCCL to narrow down the issue\r\n\r\n## Environment\r\n\r\nHorovod=0.20.0 with HOROVOD_GPU_OPERATION=MPI\r\ngluonnlp==0.10.0\r\nmxnet_cu101==1.6.0","closed_by":{"login":"leezu","id":946903,"node_id":"MDQ6VXNlcjk0NjkwMw==","avatar_url":"https://avatars.githubusercontent.com/u/946903?v=4","gravatar_id":"","url":"https://api.github.com/users/leezu","html_url":"https://github.com/leezu","followers_url":"https://api.github.com/users/leezu/followers","following_url":"https://api.github.com/users/leezu/following{/other_user}","gists_url":"https://api.github.com/users/leezu/gists{/gist_id}","starred_url":"https://api.github.com/users/leezu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leezu/subscriptions","organizations_url":"https://api.github.com/users/leezu/orgs","repos_url":"https://api.github.com/users/leezu/repos","events_url":"https://api.github.com/users/leezu/events{/privacy}","received_events_url":"https://api.github.com/users/leezu/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":2},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1371/timeline","performed_via_github_app":null,"state_reason":"completed"}