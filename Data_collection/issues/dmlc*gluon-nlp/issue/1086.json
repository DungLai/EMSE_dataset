{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1086","id":544896415,"node_id":"MDU6SXNzdWU1NDQ4OTY0MTU=","number":1086,"title":"Conflict between weight tied and weight sharing","user":{"login":"liuzh47","id":12567586,"node_id":"MDQ6VXNlcjEyNTY3NTg2","avatar_url":"https://avatars.githubusercontent.com/u/12567586?v=4","gravatar_id":"","url":"https://api.github.com/users/liuzh47","html_url":"https://github.com/liuzh47","followers_url":"https://api.github.com/users/liuzh47/followers","following_url":"https://api.github.com/users/liuzh47/following{/other_user}","gists_url":"https://api.github.com/users/liuzh47/gists{/gist_id}","starred_url":"https://api.github.com/users/liuzh47/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuzh47/subscriptions","organizations_url":"https://api.github.com/users/liuzh47/orgs","repos_url":"https://api.github.com/users/liuzh47/repos","events_url":"https://api.github.com/users/liuzh47/events{/privacy}","received_events_url":"https://api.github.com/users/liuzh47/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-01-03T08:23:43Z","updated_at":"2020-01-10T02:46:26Z","closed_at":"2020-01-10T02:46:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Description\r\nThis bug is the same as https://github.com/apache/incubator-mxnet/issues/17184 It is an error introduced in gluonnlp models instead of mxnet side, so I move the issue here.\r\n\r\nWe experience some weight initialization error when we use weight sharing and weight tied simultaneously. We share weights between `model` and `model_eval`. The code is shown below:\r\n\r\n```python\r\nmodel = nlp.model.train.AWDRNN(args.model, len(vocab), args.emsize, args.nhid, args.nlayers,\r\n                               args.tied, args.dropout, args.weight_dropout,\r\n                               args.dropout_h, args.dropout_i, args.dropout_e)\r\nmodel_eval = nlp.model.AWDRNN(args.model, len(vocab), args.emsize, args.nhid, args.nlayers,\r\n                              args.tied, args.dropout, args.weight_dropout,\r\n                              args.dropout_h, args.dropout_i, args.dropout_e,\r\n                              params=model.collect_params())\r\n\r\nmodel.initialize(mx.init.Xavier(), ctx=context)\r\n\r\nmodel.hybridize(static_alloc=True)\r\n\r\nprint(model)\r\n\r\ndef check_initialized(net):\r\n    params = net.collect_params()\r\n    for param in params:\r\n        try:\r\n            params[param].list_ctx()\r\n        except RuntimeError:\r\n            return False\r\n    return True\r\n\r\nprint(check_initialized(model))\r\nprint(check_initialized(model_eval))\r\n```\r\n\r\n### Log Message\r\nIf `args.tied` is set `True`, we get the following log message:\r\n```python\r\nTrue\r\nFalse\r\n```\r\nIf we turn off `args.tied`, the initialization works correctly.\r\n\r\n### To Reproduce\r\n(If you developed your own code, please provide a short script that reproduces the error. For existing examples, please provide link.)\r\nThe file can be found in (https://github.com/dmlc/gluon-nlp/blob/v0.8.x/scripts/language_model/word_language_model.py). To reproduce the above message, you may need to replace line 153 onward  with the above code snippet. Run the following command:\r\n\r\n```\r\npython -m pdb word_language_model.py --tied --dropout_e=0\r\n```\r\nYou will encounter the above error.\r\n\r\n## What have you tried to solve it?\r\n\r\nThe parameter that not initialized properly is the parameter `awdrnn0_hybridsequential0_embedding0_bias`. It is the weight used in the decoder of AWDRNN.  After some investigation, we found it is the tied weights introducing this error:\r\n\r\n```python\r\n    if self._tie_weights:\r\n         output.add(nn.Dense(self._vocab_size, flatten=False,\r\n                             params=self.embedding[0].params))\r\n```\r\n\r\nI print some debug information which may be helpful here:\r\n```\r\n(Pdb) model_eval.decoder[0]._params['awdrnn0_hybridsequential0_embedding0_bias'].list_ctx()\r\n*** RuntimeError: Parameter 'awdrnn0_hybridsequential0_embedding0_bias' has not been initialized\r\n```\r\n\r\n## Environment\r\n\r\nWe recommend using our script for collecting the diagnositc information. Run the following command and paste the outputs below:\r\n```\r\ncurl --retry 10 -s https://raw.githubusercontent.com/dmlc/gluon-nlp/master/tools/diagnose.py | python\r\n\r\n# paste outputs here\r\n```\r\n","closed_by":{"login":"liuzh47","id":12567586,"node_id":"MDQ6VXNlcjEyNTY3NTg2","avatar_url":"https://avatars.githubusercontent.com/u/12567586?v=4","gravatar_id":"","url":"https://api.github.com/users/liuzh47","html_url":"https://github.com/liuzh47","followers_url":"https://api.github.com/users/liuzh47/followers","following_url":"https://api.github.com/users/liuzh47/following{/other_user}","gists_url":"https://api.github.com/users/liuzh47/gists{/gist_id}","starred_url":"https://api.github.com/users/liuzh47/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuzh47/subscriptions","organizations_url":"https://api.github.com/users/liuzh47/orgs","repos_url":"https://api.github.com/users/liuzh47/repos","events_url":"https://api.github.com/users/liuzh47/events{/privacy}","received_events_url":"https://api.github.com/users/liuzh47/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1086/timeline","performed_via_github_app":null,"state_reason":"completed"}