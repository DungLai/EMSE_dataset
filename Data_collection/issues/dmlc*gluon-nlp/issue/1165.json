{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1165","id":568034710,"node_id":"MDU6SXNzdWU1NjgwMzQ3MTA=","number":1165,"title":"GPT2 HybridBlock","user":{"login":"carter54","id":26741594,"node_id":"MDQ6VXNlcjI2NzQxNTk0","avatar_url":"https://avatars.githubusercontent.com/u/26741594?v=4","gravatar_id":"","url":"https://api.github.com/users/carter54","html_url":"https://github.com/carter54","followers_url":"https://api.github.com/users/carter54/followers","following_url":"https://api.github.com/users/carter54/following{/other_user}","gists_url":"https://api.github.com/users/carter54/gists{/gist_id}","starred_url":"https://api.github.com/users/carter54/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/carter54/subscriptions","organizations_url":"https://api.github.com/users/carter54/orgs","repos_url":"https://api.github.com/users/carter54/repos","events_url":"https://api.github.com/users/carter54/events{/privacy}","received_events_url":"https://api.github.com/users/carter54/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-02-20T03:59:58Z","updated_at":"2020-03-14T09:01:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nIt seems hybridized gpt2 in V0.9.0 generate different results with previous versions (not as a hybridblock).\r\nI compared the result between the sequence_sampling.py script in v0.9.0\r\n(https://github.com/dmlc/gluon-nlp/blob/v0.9.0/scripts/text_generation/sequence_sampling.py)\r\nand https://github.com/sxjscience/gluonnlp-gpt2/blob/master/sampling_demo.py from @sxjscience (which I originally used)\r\n\r\n### Error Message\r\nNone\r\n\r\n## To Reproduce\r\nin https://github.com/dmlc/gluon-nlp/blob/v0.9.0/scripts/text_generation/sequence_sampling.py\r\nI used following parameters:\r\n```\r\n--random-sample \r\n--lm-model gpt2_117m\r\n--max-length 10\r\n--print-num 5\r\n--beam-size 5\r\n--bos I think this works\r\n--temperature 0.7\r\n--use-top-k 40\r\n```\r\n\r\nin https://github.com/sxjscience/gluonnlp-gpt2/blob/master/sampling_demo.py\r\nI used following parameters:\r\n```\r\n--model 117M\r\n--num 5\r\n--temperature 0.7\r\n--context I think this works  *(this is input after showing 'Type in the start of the sentence >>> ')\r\n```\r\n\r\nboth these two scripts used model, vocab and bpe files downloaded from gluonnlp model lib.\r\n(gpt2_117m_openai_webtext-26416f2e.params,  openai_webtext-f917dc78.vocab, openai_webtext_bpe_ranks-396d4d8e.json)\r\n\r\nin addition, to reproduce the result, I set random seed by\r\n```\r\nmx.random.seed(123)\r\nnp.random.seed(123)\r\n```\r\nin both scriptes.\r\n\r\n\r\nin gluonnlp v0.9.0, I got following results:\r\n```\r\nGeneration Result:\r\n[\"I think this works for Went'G to hang<|endoftext|>\", -6.5630407]\r\n['I think this works for conne in general,<|endoftext|>', -3.8045387]\r\n['I think this works for Ö IcA<|endoftext|>', -12.143288]\r\n['I think this works for savings! After various drops<|endoftext|>', -6.411801]\r\n[\"I think this works for ö�'s<|endoftext|>\", -8.568734]\r\n```\r\n\r\nin @sxjscience script, I got following results:\r\n```\r\nI think this works pretty well.\r\n\r\nWhat little<|endoftext|>\r\n I think this works, but it's a bit too<|endoftext|>\r\n I think this works for a few reasons.\r\n\r\n<|endoftext|>\r\n I think this works for almost every game of Hearthstone.<|endoftext|>\r\n I think this works, but I think I'm going<|endoftext|>\r\n```\r\n\r\nI believe the result from @sxjscience script make more sense. \r\n\r\nI simply printed out the state result from these two lines respectively:\r\nhttps://github.com/dmlc/gluon-nlp/blob/ef57ca08ee507902a9b2fbb4dbcc4ca110d84cd3/scripts/text_generation/sequence_sampling.py#L172\r\nhttps://github.com/sxjscience/gluonnlp-gpt2/blob/5393325d10b449cf7b263336e5dc2a5b647ad346/sampling_demo.py#L134\r\n\r\nthese are the initial model state after inputing the words ('I think this work' in this case), and there is no random factors during the state generation. However, I get slightly different outputs from these two scripts.\r\n\r\nin gluonnlp v0.9.0, I got following results:\r\n```\r\nbos_ids: [314, 892, 428, 2499]\r\neos_id: 50256\r\ninitial_state:\r\n[\r\n[[[[-1.5114625   2.022678    1.1816475  ... -1.272368   -0.77062\r\n     1.5050724 ]\r\n   [-2.2167938   2.2953174   1.8480954  ... -1.087445   -1.4295176\r\n     1.7449284 ]\r\n   [-2.0344348   2.347716    1.873954   ... -1.2934592  -1.8628635\r\n     2.1281338 ]\r\n   [-2.8145096   2.7656934   2.7020633  ... -3.3035498  -1.870746\r\n     1.4930353 ]]\r\n\r\n  [[-0.25974002 -0.7255037  -1.6046232  ... -0.4246013   1.4355485\r\n    -0.09753075]\r\n   [ 0.27772164 -1.0720729  -1.461111   ... -1.9736105   4.003873\r\n     1.0251817 ]\r\n   [-0.35341865 -0.9198358  -2.3204646  ... -0.28003415  4.191904\r\n    -0.43986958]\r\n   [ 1.0401388  -2.4093304  -1.9443365  ... -3.2719274   3.750334\r\n     1.5413616 ]]\r\n   \r\n   ...\r\n   \r\n   [[-1.7475876e-01 -5.8656417e-02  5.7071950e-02 ... -5.0089438e-02    \r\n\t3.8783681e-02 -9.8688319e-02]\r\n   [-1.3505528e+00  2.2637476e-01  1.0895698e-01 ... -3.6589733e-01\r\n     5.2980721e-01  2.0042861e-01]\r\n   [-2.1730498e-03 -1.5134688e-01 -4.7372755e-01 ... -4.3929526e-01\r\n     1.3135010e+00 -1.5517814e-01]\r\n   [-1.9702104e-01 -6.0879529e-01 -8.5921329e-01 ...  1.1960924e+00\r\n     7.3815721e-01 -3.5597485e-02]]\r\n\r\n  [[ 9.2752598e-02 -1.1831909e-01  1.4589602e-01 ... -1.3848458e-01\r\n    -9.4607342e-03 -1.6617517e-01]\r\n   [-5.6394035e-01 -1.7828876e-01  9.7797394e-02 ... -5.7982695e-01\r\n    -6.9218093e-01 -5.7731813e-01]\r\n   [-2.2833836e-01 -2.0200127e-01 -2.4465438e-02 ... -1.3059924e+00\r\n    -6.9617134e-01 -2.5296259e-01]\r\n   [ 8.5663158e-01  4.6872348e-01 -1.7862669e-01 ... -1.1065848e+00\r\n     1.8462117e+00  4.7560549e-01]]]]\r\n```\r\n\r\nin @sxjscience script, I got following results:\r\n```\r\nbos_ids: [314, 892, 428, 2499]\r\neos_id: 50256\r\ninitial_state:\r\n[\r\n[[[[-1.5114625   2.022678    1.1816475  ... -1.272368   -0.77062\r\n     1.5050724 ]\r\n   [-2.2167938   2.2953174   1.8480954  ... -1.087445   -1.4295176\r\n     1.7449284 ]\r\n   [-2.0344348   2.347716    1.873954   ... -1.2934592  -1.8628635\r\n     2.1281338 ]\r\n   [-2.8145096   2.7656934   2.7020633  ... -3.3035498  -1.870746\r\n     1.4930353 ]]\r\n\r\n  [[-0.25974002 -0.7255037  -1.6046232  ... -0.4246013   1.4355485\r\n    -0.09753075]\r\n   [ 0.27772164 -1.0720729  -1.461111   ... -1.9736105   4.003873\r\n     1.0251817 ]\r\n   [-0.35341865 -0.9198358  -2.3204646  ... -0.28003415  4.191904\r\n    -0.43986958]\r\n   [ 1.0401388  -2.4093304  -1.9443365  ... -3.2719274   3.750334\r\n     1.5413616 ]]\r\n\t \r\n\t...\r\n\t \r\n   [[-1.74661696e-01 -5.87162003e-02  5.70323840e-02 ... -5.00452407e-02\r\n     3.88349257e-02 -9.85485613e-02]\r\n   [-1.35118222e+00  2.26310208e-01  1.08217351e-01 ... -3.66161257e-01\r\n     5.30540764e-01  2.01224759e-01]\r\n   [-1.97911495e-03 -1.51461348e-01 -4.74250615e-01 ... -4.38878387e-01\r\n     1.31352234e+00 -1.54606119e-01]\r\n   [-1.97200328e-01 -6.08567238e-01 -8.60525846e-01 ...  1.19605160e+00\r\n     7.36668587e-01 -3.49551775e-02]]\r\n\r\n  [[ 9.26816314e-02 -1.18253030e-01  1.45903692e-01 ... -1.38523147e-01\r\n    -9.41133685e-03 -1.66166440e-01]\r\n   [-5.63177526e-01 -1.77708015e-01  9.64018106e-02 ... -5.80199003e-01\r\n    -6.92616522e-01 -5.75809360e-01]\r\n   [-2.29232520e-01 -2.01344401e-01 -2.51663439e-02 ... -1.30508542e+00\r\n    -6.96419179e-01 -2.53013432e-01]\r\n   [ 8.56036127e-01  4.69387531e-01 -1.79144084e-01 ... -1.10490561e+00\r\n     1.84545624e+00  4.75354373e-01]]]]\r\n```\r\n\r\nIt can be noticed that the first two list items in the initial state list are the same between two results, while the last two are diverse.\r\n\r\nAny reason to cause this?\r\n\r\n\r\n## Environment\r\n----------pip list----------\r\ncertifi    2019.11.28\r\nchardet    3.0.4\r\nCython     0.29.15\r\ngluonnlp   0.9.0\r\ngraphviz   0.8.4\r\nidna       2.8\r\nmxnet      1.6.0b20200128\r\nnumpy      1.18.1\r\npackaging  20.1\r\npip        19.0.3\r\npyparsing  2.4.6\r\nregex      2020.2.18\r\nrequests   2.22.0\r\nsetuptools 40.8.0\r\nsix        1.14.0\r\nurllib3    1.25.8\r\n\r\n----------Python Info----------\r\nVersion      : 3.7.3\r\nCompiler     : GCC 7.3.0\r\nBuild        : ('default', 'Mar 27 2019 22:11:17')\r\nArch         : ('64bit', '')\r\n------------Pip Info-----------\r\nVersion      : 19.0.3\r\nDirectory    : /extend_disk1/gluonnlp/lib/python3.7/site-packages/pip\r\n----------MXNet Info-----------\r\nVersion      : 1.6.0\r\nDirectory    : /extend_disk1/gluonnlp/lib/python3.7/site-packages/mxnet\r\nNum GPUs     : 0\r\nCommit Hash   : a15e1b900f3f6e1fbdce62176ab3d8c806a1c2bf\r\n----------System Info----------\r\nPlatform     : Linux-4.15.0-65-generic-x86_64-with-debian-buster-sid\r\nsystem       : Linux\r\nnode         : test3\r\nrelease      : 4.15.0-65-generic\r\nversion      : #74-Ubuntu SMP Tue Sep 17 17:06:04 UTC 2019\r\n----------Hardware Info----------\r\nmachine      : x86_64\r\nprocessor    : x86_64\r\nArchitecture:        x86_64\r\nCPU op-mode(s):      32-bit, 64-bit\r\nByte Order:          Little Endian\r\nCPU(s):              64\r\nOn-line CPU(s) list: 0-63\r\nThread(s) per core:  2\r\nCore(s) per socket:  16\r\nSocket(s):           2\r\nNUMA node(s):        2\r\nVendor ID:           GenuineIntel\r\nCPU family:          6\r\nModel:               85\r\nModel name:          Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz\r\nStepping:            7\r\nCPU MHz:             3000.000\r\nBogoMIPS:            6000.00\r\nHypervisor vendor:   KVM\r\nVirtualization type: full\r\nL1d cache:           32K\r\nL1i cache:           32K\r\nL2 cache:            1024K\r\nL3 cache:            30976K\r\nNUMA node0 CPU(s):   0-31\r\nNUMA node1 CPU(s):   32-63\r\nFlags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology nonstop_tsc cpuid tsc_known_freq pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f avx512dq rdseed adx smap clflushopt clwb avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 arat avx512_vnni md_clear flush_l1d arch_capabilities\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1165/timeline","performed_via_github_app":null,"state_reason":null}