{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/938","id":497332862,"node_id":"MDU6SXNzdWU0OTczMzI4NjI=","number":938,"title":"Embedding input contains data out of bound when sparse_grad=True","user":{"login":"mohammedkhalilia","id":6099774,"node_id":"MDQ6VXNlcjYwOTk3NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/6099774?v=4","gravatar_id":"","url":"https://api.github.com/users/mohammedkhalilia","html_url":"https://github.com/mohammedkhalilia","followers_url":"https://api.github.com/users/mohammedkhalilia/followers","following_url":"https://api.github.com/users/mohammedkhalilia/following{/other_user}","gists_url":"https://api.github.com/users/mohammedkhalilia/gists{/gist_id}","starred_url":"https://api.github.com/users/mohammedkhalilia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mohammedkhalilia/subscriptions","organizations_url":"https://api.github.com/users/mohammedkhalilia/orgs","repos_url":"https://api.github.com/users/mohammedkhalilia/repos","events_url":"https://api.github.com/users/mohammedkhalilia/events{/privacy}","received_events_url":"https://api.github.com/users/mohammedkhalilia/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-09-23T21:16:04Z","updated_at":"2019-09-24T06:34:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nWhen setting sparse_grad=True in mxnet.gluon.nn.Embedding() I get an error. \r\n\r\n### Error Message\r\nThe error is:\r\nCheck failed: is_valid: Embedding input contains data out of bound\r\n\r\nFull traceback is below:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/ubuntu/workspace/src/models/train.py\", line 73, in <module>\r\n    main()\r\n  File \"/home/ubuntu/workspace/src/models/train.py\", line 63, in main\r\n    model.train(train_dataloader, val_dataloader, test_dataloader, ctx)\r\n  File \"BaseModel.py\", line 53, in train\r\n    epoch_loss = self.epoch()\r\n  File \"/home/ubuntu/workspace/src/models/BaseModel.py\", line 120, in epoch\r\n    return epoch_loss.asscalar()\r\n  File \"/env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/ndarray/ndarray.py\", line 2014, in asscalar\r\n    return self.asnumpy()[0]\r\n  File \"/env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/ndarray/ndarray.py\", line 1996, in asnumpy\r\n    ctypes.c_size_t(data.size)))\r\n  File \"/env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/base.py\", line 253, in check_call\r\n    raise MXNetError(py_str(_LIB.MXGetLastError()))\r\nmxnet.base.MXNetError: [19:41:00] src/operator/tensor/indexing_op.cu:284: Check failed: is_valid: Embedding input contains data out of bound\r\n\r\n[bt] (0) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(+0x4b04cb) [0x7fbdc45f84cb]\r\n  [bt] (1) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(void mxnet::op::SparseEmbeddingDeterministicKernelLaunch<int, float, long>(mxnet::OpContext const&, mxnet::TBlob const&, mxnet::TBlob const&, mxnet::OpReqType, mxnet::NDArray const&)+0x246) [0x7fbdc8a613d6]\r\n  [bt] (2) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(mxnet::op::SparseEmbeddingOpBackwardDeterministicRspImpl(mxnet::OpContext const&, mxnet::TBlob const&, mxnet::TBlob const&, mxnet::OpReqType, mxnet::NDArray const&)+0x1b4b) [0x7fbdc8ab434b]\r\n  [bt] (3) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(void mxnet::op::SparseEmbeddingOpBackwardRspImpl<mshadow::gpu>(bool, mxnet::OpContext const&, mxnet::TBlob const&, mxnet::TBlob const&, mxnet::OpReqType, mxnet::NDArray const&)+0x2f4) [0x7fbdc8ab5084]\r\n  [bt] (4) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(void mxnet::op::EmbeddingOpBackwardEx<mshadow::gpu>(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)+0x6dc) [0x7fbdc8abaa1c]\r\n  [bt] (5) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(std::_Function_handler<void (mxnet::RunContext), mxnet::imperative::PushFComputeEx(std::function<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)> const&, nnvm::Op const*, nnvm::NodeAttrs const&, mxnet::Context const&, std::vector<mxnet::engine::Var*, std::allocator<mxnet::engine::Var*> > const&, std::vector<mxnet::engine::Var*, std::allocator<mxnet::engine::Var*> > const&, std::vector<mxnet::Resource, std::allocator<mxnet::Resource> > const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&)::{lambda(mxnet::RunContext)#1}>::_M_invoke(std::_Any_data const&, mxnet::RunContext)+0x9f) [0x7fbdc67a2f2f]\r\n  [bt] (6) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(+0x25b5459) [0x7fbdc66fd459]\r\n  [bt] (7) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(+0x25c1ce1) [0x7fbdc6709ce1]\r\n  [bt] (8) /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet/libmxnet.so(+0x25c51f0) [0x7fbdc670d1f0]\r\n## To Reproduce\r\n(If you developed your own code, please provide a short script that reproduces the error. For existing examples, please provide link.)\r\n\r\n### Steps to reproduce\r\n1. Set sparse_grad=True in the embedding as follows:\r\n```\r\nchar_embedding = mxnet.gluon.nn.Embedding(\r\n                    config.char_size,\r\n                    config.char_emb_dim,\r\n                    sparse_grad=True,\r\n                    prefix='char_embed_')\r\n```\r\n2. Model is initialized using mxnet.init.Xavier()\r\n3. Embedding are initialized using glove.6B.50d.txt\r\n4. hybridize(active=False)\r\n\r\nI can provide a simple end-to-end script if needed.\r\n\r\n## Environment\r\n```\r\n----------Python Info----------\r\nVersion      : 3.5.2\r\nCompiler     : GCC 5.4.0 20160609\r\nBuild        : ('default', 'Nov 12 2018 13:43:14')\r\nArch         : ('64bit', 'ELF')\r\n------------Pip Info-----------\r\nVersion      : 19.2.2\r\nDirectory    : /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/pip\r\n----------MXNet Info-----------\r\nVersion      : 1.5.0\r\nDirectory    : /env/mx_1.5_gnlp_0.8/local/lib/python3.5/site-packages/mxnet\r\nNum GPUs     : 8\r\nCommit Hash   : 75a9e187d00a8b7ebc71412a02ed0e3ae489d91f\r\n----------System Info----------\r\nPlatform     : Linux-4.4.0-1090-aws-x86_64-with-Ubuntu-16.04-xenial\r\nsystem       : Linux\r\nnode         : ip-172-31-30-122\r\nrelease      : 4.4.0-1090-aws\r\nversion      : #101-Ubuntu SMP Fri Aug 2 15:21:01 UTC 2019\r\n----------Hardware Info----------\r\nmachine      : x86_64\r\nprocessor    : x86_64\r\nArchitecture:          x86_64\r\nCPU op-mode(s):        32-bit, 64-bit\r\nByte Order:            Little Endian\r\nCPU(s):                64\r\nOn-line CPU(s) list:   0-63\r\nThread(s) per core:    2\r\nCore(s) per socket:    16\r\nSocket(s):             2\r\nNUMA node(s):          2\r\nVendor ID:             GenuineIntel\r\nCPU family:            6\r\nModel:                 79\r\nModel name:            Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz\r\nStepping:              1\r\nCPU MHz:               1202.109\r\nCPU max MHz:           3000.0000\r\nCPU min MHz:           1200.0000\r\nBogoMIPS:              4600.15\r\nHypervisor vendor:     Xen\r\nVirtualization type:   full\r\nL1d cache:             32K\r\nL1i cache:             32K\r\nL2 cache:              256K\r\nL3 cache:              46080K\r\nNUMA node0 CPU(s):     0-15,32-47\r\nNUMA node1 CPU(s):     16-31,48-63\r\nFlags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology nonstop_tsc aperfmperf pni pclm$lqdq monitor est ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single pti fsgsbase bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx x$aveopt ida\r\n\r\n----------Network Test----------\r\nSetting timeout: 10\r\nTiming for MXNet: https://github.com/apache/incubator-mxnet, DNS: 0.0025 sec, LOAD: 0.6521 sec.\r\nTiming for GluonNLP GitHub: https://github.com/dmlc/gluon-nlp, DNS: 0.0004 sec, LOAD: 0.4032 sec.\r\nTiming for FashionMNIST: https://repo.mxnet.io/gluon/dataset/fashion-mnist/train-labels-idx1-ubyte.gz, DNS: 0.0004 sec, LOAD: 0.0453 sec.\r\nTiming for D2L (zh-cn): http://zh.d2l.ai, DNS: 0.0004 sec, LOAD: 0.0216 sec.\r\nTiming for D2L: http://d2l.ai, DNS: 0.0003 sec, LOAD: 0.0177 sec.\r\nTiming for Conda: https://repo.continuum.io/pkgs/free/, DNS: 0.0005 sec, LOAD: 0.0575 sec.\r\nTiming for PYPI: https://pypi.python.org/pypi/pip, DNS: 0.0013 sec, LOAD: 0.1462 sec.\r\nTiming for GluonNLP: http://gluon-nlp.mxnet.io, DNS: 0.0004 sec, LOAD: 0.1874 sec.\r\n```\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/938/timeline","performed_via_github_app":null,"state_reason":null}