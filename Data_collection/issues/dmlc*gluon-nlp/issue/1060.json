{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1060","id":539488772,"node_id":"MDU6SXNzdWU1Mzk0ODg3NzI=","number":1060,"title":"Cannot apply parameter sharing on WeightDropParameter","user":{"login":"liuzh47","id":12567586,"node_id":"MDQ6VXNlcjEyNTY3NTg2","avatar_url":"https://avatars.githubusercontent.com/u/12567586?v=4","gravatar_id":"","url":"https://api.github.com/users/liuzh47","html_url":"https://github.com/liuzh47","followers_url":"https://api.github.com/users/liuzh47/followers","following_url":"https://api.github.com/users/liuzh47/following{/other_user}","gists_url":"https://api.github.com/users/liuzh47/gists{/gist_id}","starred_url":"https://api.github.com/users/liuzh47/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuzh47/subscriptions","organizations_url":"https://api.github.com/users/liuzh47/orgs","repos_url":"https://api.github.com/users/liuzh47/repos","events_url":"https://api.github.com/users/liuzh47/events{/privacy}","received_events_url":"https://api.github.com/users/liuzh47/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":997120945,"node_id":"MDU6TGFiZWw5OTcxMjA5NDU=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/release%20focus","name":"release focus","color":"fbca04","default":false,"description":"Progress focus for release"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2019-12-18T06:53:18Z","updated_at":"2020-01-03T08:19:03Z","closed_at":"2020-01-03T08:19:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Description\r\nParameter sharing of `WeightDropParameter` is broken. I apply weight sharing between `AWDRNN` and `train.AWDRNN` as followed:\r\n\r\n```python\r\nmodel = nlp.model.train.AWDRNN(args.model, len(vocab), args.emsize, args.nhid, args.nlayers,\r\n                               args.tied, args.dropout, args.weight_dropout,\r\n                               args.dropout_h, args.dropout_i, args.dropout_e)\r\nmodel_eval = nlp.model.AWDRNN(args.model, len(vocab), args.emsize, args.nhid, args.nlayers,\r\n                              args.tied, args.dropout, args.weight_dropout,\r\n                              args.dropout_h, args.dropout_i, args.dropout_e,\r\n                              params=model.collect_params())\r\n\r\nmodel.initialize(mx.init.Xavier(), ctx=context)\r\n\r\nmodel.hybridize(static_alloc=True)\r\n\r\nprint(model)\r\n\r\ndef check_initialized(net):\r\n    params = net.collect_params()\r\n    for param in params:\r\n        try:\r\n            params[param].list_ctx()\r\n        except RuntimeError:\r\n            return False\r\n    return True\r\n\r\nprint(check_initialized(model))\r\nprint(check_initialized(model_eval))\r\n```\r\n\r\n### Log Message\r\nAfter I ran the above code, I got the following message:\r\n```python\r\nTrue\r\nFalse\r\n```\r\nIt appeared that `model_eval` is not properly initialized. After an inspection, we found it is the `WeightDropParameter` that not initialized.\r\n```\r\n(Pdb) model_eval.collect_params()[\"awdrnn0_hybridsequential0_embedding0_weight\"].data()\r\n*** RuntimeError: Parameter 'awdrnn0_hybridsequential0_embedding0_weight' has not been initialized. Note that you should initialize parameters and create Trainer with Block.collect_params() instead of Block.params because the later does not include Parameters of nested child Blocks\r\n(Pdb) model_eval.collect_params()[\"awdrnn0_hybridsequential0_embedding0_weight\"]\r\nWeightDropParameter awdrnn0_hybridsequential0_embedding0_weight (shape=(33278, 400), dtype=float32, rate=0.1, mode=training)\r\n```\r\n\r\n## Environment\r\nMy environment specs:\r\n```\r\ncurl --retry 10 -s https://raw.githubusercontent.com/dmlc/gluon-nlp/master/tools/diagnose.py | python\r\n\r\n---------Python Info----------\r\nVersion      : 3.6.6\r\nCompiler     : GCC 7.2.0\r\nBuild        : ('default', 'Jun 28 2018 17:14:51')\r\nArch         : ('64bit', '')\r\n------------Pip Info-----------\r\nVersion      : 19.2.3\r\nDirectory    : /home/ubuntu/anaconda3/lib/python3.6/site-packages/pip\r\n----------MXNet Info-----------\r\nVersion      : 1.6.0\r\nDirectory    : /home/ubuntu/anaconda3/lib/python3.6/site-packages/mxnet\r\nNum GPUs     : 1\r\nHashtag not found. Not installed from pre-built package.\r\n----------System Info----------\r\nPlatform     : Linux-4.15.0-1056-aws-x86_64-with-debian-buster-sid\r\nsystem       : Linux\r\nnode         : ip-172-31-23-26\r\nrelease      : 4.15.0-1056-aws\r\nversion      : #58-Ubuntu SMP Tue Nov 26 15:14:34 UTC 2019\r\n----------Hardware Info----------\r\nmachine      : x86_64\r\nprocessor    : x86_64\r\nArchitecture:        x86_64\r\nCPU op-mode(s):      32-bit, 64-bit\r\nByte Order:          Little Endian\r\nCPU(s):              8\r\nOn-line CPU(s) list: 0-7\r\nThread(s) per core:  2\r\nCore(s) per socket:  4\r\nSocket(s):           1\r\nNUMA node(s):        1\r\nVendor ID:           GenuineIntel\r\nCPU family:          6\r\nModel:               79\r\nModel name:          Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz\r\nStepping:            1\r\nCPU MHz:             2704.026\r\nCPU max MHz:         3000.0000\r\nCPU min MHz:         1200.0000\r\nBogoMIPS:            4600.12\r\nHypervisor vendor:   Xen\r\nVirtualization type: full\r\nL1d cache:           32K\r\nL1i cache:           32K\r\nL2 cache:            256K\r\nL3 cache:            46080K\r\nNUMA node0 CPU(s):   0-7\r\nFlags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch cpuid_fault invpcid_single pti fsgsbase bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx xsaveopt\r\n----------Network Test----------\r\nSetting timeout: 10\r\n```\r\n","closed_by":{"login":"liuzh47","id":12567586,"node_id":"MDQ6VXNlcjEyNTY3NTg2","avatar_url":"https://avatars.githubusercontent.com/u/12567586?v=4","gravatar_id":"","url":"https://api.github.com/users/liuzh47","html_url":"https://github.com/liuzh47","followers_url":"https://api.github.com/users/liuzh47/followers","following_url":"https://api.github.com/users/liuzh47/following{/other_user}","gists_url":"https://api.github.com/users/liuzh47/gists{/gist_id}","starred_url":"https://api.github.com/users/liuzh47/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuzh47/subscriptions","organizations_url":"https://api.github.com/users/liuzh47/orgs","repos_url":"https://api.github.com/users/liuzh47/repos","events_url":"https://api.github.com/users/liuzh47/events{/privacy}","received_events_url":"https://api.github.com/users/liuzh47/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1060/timeline","performed_via_github_app":null,"state_reason":"completed"}