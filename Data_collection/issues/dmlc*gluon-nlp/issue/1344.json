{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1344","id":690611475,"node_id":"MDU6SXNzdWU2OTA2MTE0NzU=","number":1344,"title":"BERT produces slightly different values for different batch sizes.","user":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false},"assignees":[{"login":"MoisesHer","id":50716238,"node_id":"MDQ6VXNlcjUwNzE2MjM4","avatar_url":"https://avatars.githubusercontent.com/u/50716238?v=4","gravatar_id":"","url":"https://api.github.com/users/MoisesHer","html_url":"https://github.com/MoisesHer","followers_url":"https://api.github.com/users/MoisesHer/followers","following_url":"https://api.github.com/users/MoisesHer/following{/other_user}","gists_url":"https://api.github.com/users/MoisesHer/gists{/gist_id}","starred_url":"https://api.github.com/users/MoisesHer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoisesHer/subscriptions","organizations_url":"https://api.github.com/users/MoisesHer/orgs","repos_url":"https://api.github.com/users/MoisesHer/repos","events_url":"https://api.github.com/users/MoisesHer/events{/privacy}","received_events_url":"https://api.github.com/users/MoisesHer/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2020-09-02T01:02:13Z","updated_at":"2020-10-02T17:28:08Z","closed_at":"2020-10-02T17:28:07Z","author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nFor two inputs, the first a batch size of 300, and the second a 27 batch slice of the first, we get _slightly different_ results from BERT.\r\n\r\n### Error Message\r\nHere are the outputs from the first item of the batch for batch size 300 and 27, respectively.\r\n\r\n**BATCH SIZE 300:**\r\n[[-0.2168    0.2137   -0.05142  ...  0.07556   0.774    -0.1343  ]\r\n [-0.23     -0.001999  0.1725   ... -0.1262    0.6      -0.2517  ]\r\n [-0.4565    0.1788    0.6187   ... -0.2104    0.2776   -0.5166  ]\r\n ...\r\n [-0.10944   0.2292    0.858    ... -0.3677    0.3657   -0.4097  ]\r\n [-0.1173    0.29      0.888    ... -0.2922    0.4011   -0.4702  ]\r\n [-0.2341    0.3228    0.9746   ... -0.3906    0.3662   -0.5415  ]]\r\n<NDArray 100x768 @gpu(0)>\r\n\r\n**BATCH SIZE 27:**\r\n[[-0.2178    0.2146   -0.0519   ...  0.075     0.7734   -0.1339  ]\r\n [-0.2301   -0.002167  0.1725   ... -0.1265    0.5986   -0.2512  ]\r\n [-0.4558    0.178     0.619    ... -0.2117    0.2761   -0.517   ]\r\n ...\r\n [-0.10913   0.2301    0.857    ... -0.3677    0.3647   -0.41    ]\r\n [-0.1176    0.289     0.887    ... -0.2927    0.401    -0.471   ]\r\n [-0.2358    0.3223    0.973    ... -0.392     0.3662   -0.5415  ]]\r\n<NDArray 100x768 @gpu(0)>\r\n\r\n## To Reproduce\r\n```python\r\n!pip install mxnet-cu102==1.7.0\r\n!pip install gluonnlp==0.10.0\r\n\r\n%env MXNET_SAFE_ACCUMULATION=1\r\nimport mxnet\r\nfrom mxnet import nd\r\nfrom gluonnlp.model import bert\r\nimport gluonnlp as nlp; import mxnet as mx;\r\n\r\n# load model\r\nmodel, vocab = nlp.model.get_model('bert_12_768_12', ctx=mx.gpu(0), dataset_name='book_corpus_wiki_en_uncased', use_pooler=True, use_classifier=False, use_decoder=False);\r\ntokenizer = nlp.data.BERTTokenizer(vocab, lower=True);\r\ntransform = nlp.data.BERTSentenceTransform(tokenizer, max_seq_length=512, pair=False, pad=False);\r\nmodel.cast('float16')\r\n\r\n# construct examples with batch size of 300 and first 27 out of 300.\r\nmini_length=27\r\ninput_batch = nd.random.uniform(-10,10,(300,100), dtype='float16').as_in_context(mx.gpu(0))\r\ninput_batch_mini = input_batch[:mini_length] \r\n\r\nvalid_len = nd.array([100]*300, dtype='float16').as_in_context(mx.gpu(0))\r\nsegments = nd.zeros((300,100), dtype='float16').as_in_context(mx.gpu(0))\r\nout = model(input_batch, segments, valid_len)\r\nprint(\"Batch Size 300: \", out[0][1])\r\n\r\nvalid_len_mini = nd.array([100]*mini_length, dtype='float16').as_in_context(mx.gpu(0))\r\nsegments_mini = nd.zeros((mini_length,100), dtype='float16').as_in_context(mx.gpu(0))\r\nout_mini = model(input_batch_mini, segments_mini, valid_len_mini)\r\nprint(\"Batch Size 27: \", out_mini[0][1])\r\n```\r\n\r\n### Steps to reproduce\r\n(Paste the commands you ran that produced the error.)\r\n\r\n1. See above. This can be run directly in a Jupyter Notebook.\r\n\r\n## What have you tried to solve it?\r\n\r\n1. Tested it on MxNet1.7 + GluonNLP0.10.0, also tried MxNet1.6 and GluonNLP 0.9\r\n2. The issue also persists for fp32, but it is not as significant as for fp16.\r\n## Environment\r\nClean EC2 instance with latest Deep Learning AMI.\r\n\r\nWe recommend using our script for collecting the diagnositc information. Run the following command and paste the outputs below:\r\n```\r\ncurl --retry 10 -s https://raw.githubusercontent.com/dmlc/gluon-nlp/master/tools/diagnose.py | python\r\n\r\n# paste outputs here\r\n```\r\n","closed_by":{"login":"davisliang","id":12505988,"node_id":"MDQ6VXNlcjEyNTA1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/12505988?v=4","gravatar_id":"","url":"https://api.github.com/users/davisliang","html_url":"https://github.com/davisliang","followers_url":"https://api.github.com/users/davisliang/followers","following_url":"https://api.github.com/users/davisliang/following{/other_user}","gists_url":"https://api.github.com/users/davisliang/gists{/gist_id}","starred_url":"https://api.github.com/users/davisliang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisliang/subscriptions","organizations_url":"https://api.github.com/users/davisliang/orgs","repos_url":"https://api.github.com/users/davisliang/repos","events_url":"https://api.github.com/users/davisliang/events{/privacy}","received_events_url":"https://api.github.com/users/davisliang/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1344/timeline","performed_via_github_app":null,"state_reason":"completed"}