{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/683","id":438336145,"node_id":"MDU6SXNzdWU0MzgzMzYxNDU=","number":683,"title":"FixedBucketSampler may return batch with varied length (setting ratio=0)","user":{"login":"khui","id":5355226,"node_id":"MDQ6VXNlcjUzNTUyMjY=","avatar_url":"https://avatars.githubusercontent.com/u/5355226?v=4","gravatar_id":"","url":"https://api.github.com/users/khui","html_url":"https://github.com/khui","followers_url":"https://api.github.com/users/khui/followers","following_url":"https://api.github.com/users/khui/following{/other_user}","gists_url":"https://api.github.com/users/khui/gists{/gist_id}","starred_url":"https://api.github.com/users/khui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/khui/subscriptions","organizations_url":"https://api.github.com/users/khui/orgs","repos_url":"https://api.github.com/users/khui/repos","events_url":"https://api.github.com/users/khui/events{/privacy}","received_events_url":"https://api.github.com/users/khui/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2019-04-29T14:11:31Z","updated_at":"2020-03-03T23:43:41Z","closed_at":"2019-05-06T10:21:53Z","author_association":"NONE","active_lock_reason":null,"body":"When using `FixedBucketSampler`, it seems if a bucket includes fewer than `batch_size` data points, the sampler may return a batch with less data (than the configured `batch_size`).  This might be an unexpected behavior for the users since the `ratio=0` and `batch_size=N` are configured to get exactly `N` data points per batch. \r\n\r\nI observed this when using the `FixedBucketSampler` together with the `DataLoader` as in the following, therein making a guess about the reason at this [line](https://github.com/dmlc/gluon-nlp/blob/1821ff95cc12b7ede4928485e9ebfa9ba79cc80b/src/gluonnlp/data/sampler.py#L415). Please correct me if there exist configuration to get batches including the same amount of data.\r\n\r\nTo repeat the errors, one may simply configure a large enough `num_buckets` (e.g., 20).\r\n\r\n```\r\nbatchify_fn = mxex.gluonnlp.data.batchify.Dictionary({constants.QUESTION:\r\n                                Pad(axis=0,\r\n                                    pad_val=vocab[constants.PADDING_TOKEN],\r\n                                    ret_length=False,\r\n                                    dtype='int32'),\r\n                            constants.ANSWERS:\r\n                                Pad(axis=0,\r\n                                    pad_val=vocab[constants.PADDING_TOKEN],\r\n                                    ret_length=False,\r\n                                    dtype='int32'),\r\n                            constants.CONTEXTS:\r\n                                Pad(axis=0,\r\n                                    pad_val=vocab[constants.PADDING_TOKEN],\r\n                                    ret_length=False,\r\n                                    dtype='int32')})\r\n\r\nbatch_sampler = gluonnlp.data.FixedBucketSampler(lengths=txt_lengths,\r\n                                                         batch_size=batch_size,\r\n                                                         num_buckets=num_buckets_in_sampler,\r\n                                                         shuffle=True)\r\ndata_loader = gluon.data.DataLoader(encoded_seqs,\r\n                                        batch_sampler=batch_sampler,\r\n                                        batchify_fn=batchify_fn,\r\n                                        num_workers=num_workers)\r\n```\r\n\r\n","closed_by":{"login":"khui","id":5355226,"node_id":"MDQ6VXNlcjUzNTUyMjY=","avatar_url":"https://avatars.githubusercontent.com/u/5355226?v=4","gravatar_id":"","url":"https://api.github.com/users/khui","html_url":"https://github.com/khui","followers_url":"https://api.github.com/users/khui/followers","following_url":"https://api.github.com/users/khui/following{/other_user}","gists_url":"https://api.github.com/users/khui/gists{/gist_id}","starred_url":"https://api.github.com/users/khui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/khui/subscriptions","organizations_url":"https://api.github.com/users/khui/orgs","repos_url":"https://api.github.com/users/khui/repos","events_url":"https://api.github.com/users/khui/events{/privacy}","received_events_url":"https://api.github.com/users/khui/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/683/timeline","performed_via_github_app":null,"state_reason":"completed"}