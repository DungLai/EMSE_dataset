{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/730","id":448645322,"node_id":"MDU6SXNzdWU0NDg2NDUzMjI=","number":730,"title":"BERT example crashes when using MXNet naive engine","user":{"login":"TaoLv","id":22437510,"node_id":"MDQ6VXNlcjIyNDM3NTEw","avatar_url":"https://avatars.githubusercontent.com/u/22437510?v=4","gravatar_id":"","url":"https://api.github.com/users/TaoLv","html_url":"https://github.com/TaoLv","followers_url":"https://api.github.com/users/TaoLv/followers","following_url":"https://api.github.com/users/TaoLv/following{/other_user}","gists_url":"https://api.github.com/users/TaoLv/gists{/gist_id}","starred_url":"https://api.github.com/users/TaoLv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TaoLv/subscriptions","organizations_url":"https://api.github.com/users/TaoLv/orgs","repos_url":"https://api.github.com/users/TaoLv/repos","events_url":"https://api.github.com/users/TaoLv/events{/privacy}","received_events_url":"https://api.github.com/users/TaoLv/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-05-27T03:01:12Z","updated_at":"2019-05-27T05:10:33Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"It works well when `MXNET_ENGINE_TYPE` is unset.\r\nEnvironment:\r\n```shell\r\n(gluonnlp-py3) [lvtao1@mlt-gpu207 bert]$ pip list\r\nPackage    Version        Location\r\n---------- -------------- --------------------------------------\r\ncertifi    2019.3.9\r\nchardet    3.0.4\r\ngluonnlp   0.6.0          /home/lvtao1/Workspace/gluon-nlp-3/src\r\ngraphviz   0.8.4\r\nidna       2.8\r\nmxnet      1.5.0b20190525\r\nnumpy      1.14.6\r\npip        19.0.3\r\nrequests   2.21.0\r\nsetuptools 41.0.0\r\nsix        1.12.0\r\nurllib3    1.24.2\r\nwheel      0.33.1\r\n\r\n```\r\nError log:\r\n```shell\r\n(gluonnlp-py3) [lvtao1@mlt-gpu207 bert]$ python finetune_classifier.py --task_name MRPC --batch_size 32 --optimizer bertadam --epochs 1 --lr 2e-5 --max_len 128 --only_inference --model_parameter ./output_dir/model_bert_MRPC_2.params --pad --dev_batch_size 1\r\n[10:52:25] src/engine/engine.cc:55: MXNet start using engine: NaiveEngine\r\nINFO:root:Namespace(accumulate=None, batch_size=32, bert_dataset='book_corpus_wiki_en_uncased', bert_model='bert_12_768_12', dev_batch_size=1, epochs=1, epsilon=1e-06, gpu=None, log_interval=10, lr=2e-05, max_len=128, model_parameters='./output_dir/model_bert_MRPC_2.params', only_inference=True, optimizer='bertadam', output_dir='./output_dir', pad=True, pretrained_bert_parameters=None, seed=2, task_name='MRPC', warmup_ratio=0.1)\r\nINFO:root:loading model params from ./output_dir/model_bert_MRPC_2.params\r\n<model architecture>\r\nINFO:root:processing dataset...\r\nINFO:root:Now we are doing evaluation on dev with cpu(0).\r\nINFO:root:[Batch 10/408] loss=0.4793, metrics:f1:0.6000,accuracy:0.9000\r\nINFO:root:[Batch 20/408] loss=0.3724, metrics:f1:0.5500,accuracy:0.8500\r\nINFO:root:[Batch 30/408] loss=0.3786, metrics:f1:0.5667,accuracy:0.8333\r\nINFO:root:[Batch 40/408] loss=0.5535, metrics:f1:0.5750,accuracy:0.8500\r\nINFO:root:[Batch 50/408] loss=0.0884, metrics:f1:0.5600,accuracy:0.8600\r\nINFO:root:[Batch 60/408] loss=0.2810, metrics:f1:0.6167,accuracy:0.8667\r\nINFO:root:[Batch 70/408] loss=0.0490, metrics:f1:0.6286,accuracy:0.8857\r\nINFO:root:[Batch 80/408] loss=0.3837, metrics:f1:0.6625,accuracy:0.8875\r\nINFO:root:[Batch 90/408] loss=0.4702, metrics:f1:0.6556,accuracy:0.8778\r\nINFO:root:[Batch 100/408] loss=0.6682, metrics:f1:0.6600,accuracy:0.8700\r\nINFO:root:[Batch 110/408] loss=0.0228, metrics:f1:0.6636,accuracy:0.8818\r\nINFO:root:[Batch 120/408] loss=0.4268, metrics:f1:0.6750,accuracy:0.8833\r\nINFO:root:[Batch 130/408] loss=0.0172, metrics:f1:0.6846,accuracy:0.8923\r\nINFO:root:[Batch 140/408] loss=0.5646, metrics:f1:0.6714,accuracy:0.8929\r\nINFO:root:[Batch 150/408] loss=0.8041, metrics:f1:0.6600,accuracy:0.8800\r\nINFO:root:[Batch 160/408] loss=0.3771, metrics:f1:0.6625,accuracy:0.8812\r\nINFO:root:[Batch 170/408] loss=0.0108, metrics:f1:0.6706,accuracy:0.8882\r\nTraceback (most recent call last):\r\n  File \"finetune_classifier.py\", line 539, in <module>\r\n    train(task.metrics)\r\n  File \"finetune_classifier.py\", line 471, in train\r\n    metric_nm, metric_val = evaluate(dev_data, metric, segment)\r\n  File \"finetune_classifier.py\", line 511, in evaluate\r\n    for batch_id, seqs in enumerate(loader_dev):\r\n  File \"/home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/gluon/data/dataloader.py\", line 450, in __next__\r\n    batch = pickle.loads(ret.get()) if self._dataset is None else ret.get()\r\n  File \"/home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/gluon/data/dataloader.py\", line 57, in rebuild_ndarray\r\n    fd = fd.detach()\r\n  File \"/home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/multiprocessing/resource_sharer.py\", line 58, in detach\r\n    return reduction.recv_handle(conn)\r\n  File \"/home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/multiprocessing/reduction.py\", line 182, in recv_handle\r\n    return recvfds(s, 1)[0]\r\n  File \"/home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/multiprocessing/reduction.py\", line 161, in recvfds\r\n    len(ancdata))\r\nRuntimeError: received 0 items of ancdata\r\n\r\nSegmentation fault: 11\r\n\r\nStack trace:\r\n  [bt] (0) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2b3d7b0) [0x7f2016bcf7b0]\r\n  [bt] (1) /usr/lib64/libc.so.6(+0x35270) [0x7f2067a02270]\r\n  [bt] (2) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x233ba47) [0x7f20163cda47]\r\n  [bt] (3) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x233beea) [0x7f20163cdeea]\r\n  [bt] (4) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x233c095) [0x7f20163ce095]\r\n  [bt] (5) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x233a175) [0x7f20163cc175]\r\n  [bt] (6) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x233a99b) [0x7f20163cc99b]\r\n  [bt] (7) /home/lvtao1/miniconda3/envs/gluonnlp-py3/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2b431f0) [0x7f2016bd51f0]\r\n  [bt] (8) /home/lvtao1/miniconda3/envs/gluonnlp-py3/bin/../lib/libstdc++.so.6(+0x9b64a) [0x7f205d3ef64a]\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/730/timeline","performed_via_github_app":null,"state_reason":null}