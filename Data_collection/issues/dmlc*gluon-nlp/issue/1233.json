{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/1233","id":620449662,"node_id":"MDU6SXNzdWU2MjA0NDk2NjI=","number":1233,"title":"TypeError: can't pickle SwigPyObject objects when pickling SentencepieceTokenizer","user":{"login":"DushyantaDhyani","id":2116331,"node_id":"MDQ6VXNlcjIxMTYzMzE=","avatar_url":"https://avatars.githubusercontent.com/u/2116331?v=4","gravatar_id":"","url":"https://api.github.com/users/DushyantaDhyani","html_url":"https://github.com/DushyantaDhyani","followers_url":"https://api.github.com/users/DushyantaDhyani/followers","following_url":"https://api.github.com/users/DushyantaDhyani/following{/other_user}","gists_url":"https://api.github.com/users/DushyantaDhyani/gists{/gist_id}","starred_url":"https://api.github.com/users/DushyantaDhyani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DushyantaDhyani/subscriptions","organizations_url":"https://api.github.com/users/DushyantaDhyani/orgs","repos_url":"https://api.github.com/users/DushyantaDhyani/repos","events_url":"https://api.github.com/users/DushyantaDhyani/events{/privacy}","received_events_url":"https://api.github.com/users/DushyantaDhyani/received_events","type":"User","site_admin":false},"labels":[{"id":890393501,"node_id":"MDU6TGFiZWw4OTAzOTM1MDE=","url":"https://api.github.com/repos/dmlc/gluon-nlp/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-05-18T19:24:42Z","updated_at":"2020-07-30T08:01:31Z","closed_at":"2020-07-30T08:01:31Z","author_association":"NONE","active_lock_reason":null,"body":"## Description\r\nAs stated [here](https://github.com/google/sentencepiece/issues/387) , pickling sentencepiece tokenizer returns an error.\r\n\r\n### Error Message\r\n`Traceback (most recent call last):\r\n  File \"tokenizer_repro.py\", line 10, in <module>\r\n    pickle.dump(tokenizer, writer)\r\nTypeError: can't pickle SwigPyObject objects`\r\n\r\n## To Reproduce\r\n```\r\nfrom gluonnlp.data import SentencepieceTokenizer\r\nfrom mxnet import gluon\r\nimport pickle\r\nurl = \"http://repo.mxnet.io/gluon/dataset/vocab/test-0690baed.bpe\"\r\nf = gluon.utils.download(url, overwrite=True)\r\ntokenizer = SentencepieceTokenizer(f)\r\nwith open(\"sptokenizer.pickle\", \"wb\") as writer:\r\n    pickle.dump(tokenizer, writer)\r\n```\r\n\r\n\r\n## What have you tried to solve it?\r\nAs mentioned in the issue above, changing `_SentencepieceProcessor` as below fixes the issue\r\n\r\n```\r\nclass _SentencepieceProcessor:\r\n    def __init__(self, path):\r\n        try:\r\n            import sentencepiece\r\n        except ImportError:\r\n            raise ImportError(\r\n                'sentencepiece is not installed. You must install sentencepiece '\r\n                'in order to use the Sentencepiece tokenizer and detokenizer. '\r\n                'You can refer to the official installation guide '\r\n                'in https://github.com/google/sentencepiece#installation')\r\n        self._vocab_file = path\r\n        self._processor = sentencepiece.SentencePieceProcessor()\r\n        self._processor.Load(path)\r\n\r\n    def __len__(self):\r\n        return len(self._processor)\r\n\r\n    @property\r\n    def tokens(self):\r\n        return [self._processor.id_to_piece(i) for i in range(len(self))]\r\n\r\n    def __getstate__(self):\r\n        state = self.__dict__.copy()\r\n        state[\"_processor\"] = None\r\n        state[\"_vocab_file\"] = None\r\n        return state, self._vocab_file\r\n\r\n    def __setstate__(self, d):\r\n        self.__dict__, self.vocab_file = d\r\n        self._processor = sentencepiece.SentencePieceProcessor()\r\n        self._processor.Load(self.vocab_file)\r\n```\r\n","closed_by":{"login":"sxjscience","id":5178350,"node_id":"MDQ6VXNlcjUxNzgzNTA=","avatar_url":"https://avatars.githubusercontent.com/u/5178350?v=4","gravatar_id":"","url":"https://api.github.com/users/sxjscience","html_url":"https://github.com/sxjscience","followers_url":"https://api.github.com/users/sxjscience/followers","following_url":"https://api.github.com/users/sxjscience/following{/other_user}","gists_url":"https://api.github.com/users/sxjscience/gists{/gist_id}","starred_url":"https://api.github.com/users/sxjscience/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sxjscience/subscriptions","organizations_url":"https://api.github.com/users/sxjscience/orgs","repos_url":"https://api.github.com/users/sxjscience/repos","events_url":"https://api.github.com/users/sxjscience/events{/privacy}","received_events_url":"https://api.github.com/users/sxjscience/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/1233/timeline","performed_via_github_app":null,"state_reason":"completed"}