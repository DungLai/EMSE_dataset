{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520","repository_url":"https://api.github.com/repos/dmlc/gluon-nlp","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520/labels{/name}","comments_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520/comments","events_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520/events","html_url":"https://github.com/dmlc/gluon-nlp/issues/520","id":396034201,"node_id":"MDU6SXNzdWUzOTYwMzQyMDE=","number":520,"title":"[BERT] Multi-GPU Training with Tree reduce","user":{"login":"eric-haibin-lin","id":5545640,"node_id":"MDQ6VXNlcjU1NDU2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/5545640?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-haibin-lin","html_url":"https://github.com/eric-haibin-lin","followers_url":"https://api.github.com/users/eric-haibin-lin/followers","following_url":"https://api.github.com/users/eric-haibin-lin/following{/other_user}","gists_url":"https://api.github.com/users/eric-haibin-lin/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-haibin-lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-haibin-lin/subscriptions","organizations_url":"https://api.github.com/users/eric-haibin-lin/orgs","repos_url":"https://api.github.com/users/eric-haibin-lin/repos","events_url":"https://api.github.com/users/eric-haibin-lin/events{/privacy}","received_events_url":"https://api.github.com/users/eric-haibin-lin/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/milestones/3","html_url":"https://github.com/dmlc/gluon-nlp/milestone/3","labels_url":"https://api.github.com/repos/dmlc/gluon-nlp/milestones/3/labels","id":3942502,"node_id":"MDk6TWlsZXN0b25lMzk0MjUwMg==","number":3,"title":"BERT Single-machine Pre-training","description":"","creator":{"login":"eric-haibin-lin","id":5545640,"node_id":"MDQ6VXNlcjU1NDU2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/5545640?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-haibin-lin","html_url":"https://github.com/eric-haibin-lin","followers_url":"https://api.github.com/users/eric-haibin-lin/followers","following_url":"https://api.github.com/users/eric-haibin-lin/following{/other_user}","gists_url":"https://api.github.com/users/eric-haibin-lin/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-haibin-lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-haibin-lin/subscriptions","organizations_url":"https://api.github.com/users/eric-haibin-lin/orgs","repos_url":"https://api.github.com/users/eric-haibin-lin/repos","events_url":"https://api.github.com/users/eric-haibin-lin/events{/privacy}","received_events_url":"https://api.github.com/users/eric-haibin-lin/received_events","type":"User","site_admin":false},"open_issues":1,"closed_issues":2,"state":"closed","created_at":"2019-01-04T18:30:44Z","updated_at":"2019-05-06T04:44:48Z","due_on":"2019-01-21T08:00:00Z","closed_at":"2019-05-06T04:44:48Z"},"comments":4,"created_at":"2019-01-04T19:09:08Z","updated_at":"2019-03-15T23:56:07Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"BERT_BASE and BERT_LARGE contains 110M and 340M parameters respectively. Currently multi-GPU scaling is poor for this model and the result shows large overhead for cross-GPU ndarray copies. \r\n\r\nThe default kvstore push/pull do not leverage the communication pattern on the machine (e.g. AWS p3 instance). It would be great to use the experimental tree reduce push/pull introduced by @ctcyang.\r\n\r\nHowever, the following error occurs for `MXNET_KVSTORE_LOGTREE=1 MXNET_KVSTORE_USETREE=1`\r\n\r\n```\r\n[07:02:29] src/kvstore/./././gpu_topology.h:60: Weight:\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 2 2 0 0 0 0 0\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 2 0 0 2 0 0 0 0\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 2 0 0 0 0 0 2 0\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 2 0 0 0 0 0 2\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 0 0 0 0 2 2 0\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 0 0 0 2 0 0 2\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 0 2 0 2 0 0 0\r\n[07:02:29] src/kvstore/./././gpu_topology.h:67: 0 0 0 2 0 2 0 0\r\n\r\n[06:50:46] src/kvstore/././comm_tree.h:381: Using Kernighan-Lin to generate trees\r\n[06:50:46] src/kvstore/./././gpu_topology.h:1030: No valid binary tree found from root 0, try backtracking\r\nTraceback (most recent call last):\r\n  File \"run_pretraining.py\", line 257, in <module>\r\n    train()\r\n  File \"run_pretraining.py\", line 228, in train\r\n    trainer.step(1)\r\n  File \"/home/ubuntu/mxnet/python/mxnet/gluon/trainer.py\", line 290, in step\r\n    self._allreduce_grads()\r\n  File \"/home/ubuntu/mxnet/python/mxnet/gluon/trainer.py\", line 320, in _allreduce_grads\r\n    self._kvstore.push(i, param.list_grad(), priority=-i)\r\n  File \"/home/ubuntu/mxnet/python/mxnet/kvstore.py\", line 237, in push\r\n    self.handle, mx_uint(len(ckeys)), ckeys, cvals, ctypes.c_int(priority)))\r\n  File \"/home/ubuntu/mxnet/python/mxnet/base.py\", line 252, in check_call\r\n    raise MXNetError(py_str(_LIB.MXGetLastError()))\r\nmxnet.base.MXNetError: [06:50:46] src/kvstore/./././gpu_topology.h:1040: No valid binary tree found from root 0 using backtracking\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dmlc/gluon-nlp/issues/520/timeline","performed_via_github_app":null,"state_reason":null}