{"url":"https://api.github.com/repos/mozilla/TTS/issues/619","repository_url":"https://api.github.com/repos/mozilla/TTS","labels_url":"https://api.github.com/repos/mozilla/TTS/issues/619/labels{/name}","comments_url":"https://api.github.com/repos/mozilla/TTS/issues/619/comments","events_url":"https://api.github.com/repos/mozilla/TTS/issues/619/events","html_url":"https://github.com/mozilla/TTS/issues/619","id":787447707,"node_id":"MDU6SXNzdWU3ODc0NDc3MDc=","number":619,"title":"torch.stft fails with \"Expected all tensors to be on the same device\"","user":{"login":"gerazov","id":15214418,"node_id":"MDQ6VXNlcjE1MjE0NDE4","avatar_url":"https://avatars.githubusercontent.com/u/15214418?v=4","gravatar_id":"","url":"https://api.github.com/users/gerazov","html_url":"https://github.com/gerazov","followers_url":"https://api.github.com/users/gerazov/followers","following_url":"https://api.github.com/users/gerazov/following{/other_user}","gists_url":"https://api.github.com/users/gerazov/gists{/gist_id}","starred_url":"https://api.github.com/users/gerazov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gerazov/subscriptions","organizations_url":"https://api.github.com/users/gerazov/orgs","repos_url":"https://api.github.com/users/gerazov/repos","events_url":"https://api.github.com/users/gerazov/events{/privacy}","received_events_url":"https://api.github.com/users/gerazov/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-01-16T11:35:28Z","updated_at":"2022-07-25T05:57:36Z","closed_at":"2021-02-17T13:09:42Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When running vocoder training it fails with (whole Traceback at the end):\r\n\r\n```python\r\nFile \".../lib/python3.6/site-packages/torch/functional.py\", line 516, in stft\r\n    normalized, onesided, return_complex)\r\nRuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu!\r\n```\r\nI've located the problem in the `TorchSTFT` class in `TTS/vocoder/losses.py` line 7:\r\n\r\n```python\r\nclass TorchSTFT():\r\n    def __init__(self, n_fft, hop_length, win_length, window='hann_window'):\r\n        \"\"\" Torch based STFT operation \"\"\"\r\n        self.n_fft = n_fft\r\n        self.hop_length = hop_length\r\n        self.win_length = win_length\r\n        self.window = getattr(torch, window)(win_length)\r\n```\r\nThe problem is with `self.window` which doesn't get transferred to CUDA when the loss function gets transferred via `criterion_gen.cuda()` in the `TTS/bin/train_vocoder_gan.py` line 536.\r\n\r\nI've managed to solve this by subclassing `torch.nn.Module` and listing `self.window` as a paramter. This way the `.cuda()` will transfer the window to cuda and `stft` will work:\r\n\r\n```python\r\nclass TorchSTFT(nn.Module): \r\n     def __init__(self, n_fft, hop_length, win_length, window='hann_window'):\r\n         \"\"\" Torch based STFT operation \"\"\"\r\n         super(TorchSTFT, self).__init__() \r\n         self.n_fft = n_fft\r\n         self.hop_length = hop_length\r\n         self.win_length = win_length\r\n         self.window = nn.Parameter(getattr(torch, window)(win_length), requires_grad=False)\r\n```\r\nHere's the PR #620 \r\n\r\nIn it I've also added the parameter `return_complex=False` in  `torch.stft`  because of the reported future change in the default behaviour.\r\n\r\nI'm wandering if `torch` just didn't report this in the previous version, and it just went ahead transffering to and from the cpu/gpu. In that sense this could speed up vocoder model training :thinking: \r\n\r\nThis is my environment:\r\n```python\r\n# Name                    Version                   Build  Channel\r\n_libgcc_mutex             0.1                        main              \r\nabsl-py                   0.11.0                   pypi_0    pypi      \r\nastroid                   2.4.2                    pypi_0    pypi        \r\nastunparse                1.6.3                    pypi_0    pypi    \r\nattrdict                  2.0.1                    pypi_0    pypi         \r\nattrs                     20.3.0                   pypi_0    pypi         \r\naudioread                 2.1.9                    pypi_0    pypi     \r\nblas                      1.0                         mkl                       \r\nbokeh                     1.4.0                    pypi_0    pypi       \r\nca-certificates           2020.12.8            h06a4308_0      \r\ncachetools                4.2.0                    pypi_0    pypi     \r\ncardboardlint             1.3.0                    pypi_0    pypi    \r\ncertifi                   2020.12.5        py36h06a4308_0       \r\ncffi                      1.14.4                   pypi_0    pypi          \r\nchardet                   4.0.0                    pypi_0    pypi       \r\nclick                     7.1.2                    pypi_0    pypi          \r\nclldutils                 3.6.0                    pypi_0    pypi         \r\ncolorlog                  4.6.2                    pypi_0    pypi\r\ncsvw                      1.9.0                    pypi_0    pypi \r\ncycler                    0.10.0                   pypi_0    pypi \r\ncython                    0.29.21          py36h2531618_0\r\ndataclasses               0.8                      pypi_0    pypi \r\ndecorator                 4.4.2                    pypi_0    pypi  \r\nfilelock                  3.0.12                   pypi_0    pypi    \r\nflask                     1.1.2                    pypi_0    pypi      \r\ngast                      0.3.3                    pypi_0    pypi      \r\ngoogle-auth               1.24.0                   pypi_0    pypi\r\ngoogle-auth-oauthlib      0.4.2                    pypi_0    pypi \r\ngoogle-pasta              0.2.0                    pypi_0    pypi     \r\ngrpcio                    1.34.0                   pypi_0    pypi         \r\nh5py                      2.10.0                   pypi_0    pypi         \r\nidna                      2.10                     pypi_0    pypi           \r\nimportlib-metadata        3.3.0                    pypi_0    pypi  \r\ninflect                   5.0.2                    pypi_0    pypi           \r\nintel-openmp              2020.2                      254               \r\nisodate                   0.6.0                    pypi_0    pypi         \r\nisort                     4.3.21                   pypi_0    pypi           \r\nitsdangerous              1.1.0                    pypi_0    pypi     \r\njinja2                    2.11.2                   pypi_0    pypi          \r\njoblib                    1.0.0                    pypi_0    pypi           \r\nkeras-preprocessing       1.1.2                    pypi_0    pypi\r\nkiwisolver                1.3.1                    pypi_0    pypi        \r\nlazy-object-proxy         1.4.3                    pypi_0    pypi   \r\nld_impl_linux-64          2.33.1               h53a641e_7       \r\nlibedit                   3.1.20191231         h14c3975_1         \r\nlibffi                    3.3                  he6710b0_2                   \r\nlibgcc-ng                 9.1.0                hdf63c60_0              \r\nlibrosa                   0.7.2                    pypi_0    pypi          \r\nlibstdcxx-ng              9.1.0                hdf63c60_0             \r\nllvmlite                  0.31.0                   pypi_0    pypi          \r\nmarkdown                  3.3.3                    pypi_0    pypi     \r\nmarkupsafe                1.1.1                    pypi_0    pypi     \r\nmatplotlib                3.3.3                    pypi_0    pypi        \r\nmccabe                    0.6.1                    pypi_0    pypi       \r\nmkl                       2020.2                      256                     \r\nmkl-service               2.3.0            py36he8ac12f_0         \r\nmkl_fft                   1.2.0            py36h23d657b_0           \r\nmkl_random                1.1.1            py36h0573a6f_0      \r\nncurses                   6.2                  he6710b0_1  \r\nnose                      1.3.7                    pypi_0    pypi \r\nnumba                     0.48.0                   pypi_0    pypi\r\nnumpy                     1.18.5                   pypi_0    pypi\r\noauthlib                  3.1.0                    pypi_0    pypi\r\nopenssl                   1.1.1i               h27cfd23_0  \r\nopt-einsum                3.3.0                    pypi_0    pypi\r\npackaging                 20.8                     pypi_0    pypi\r\nphonemizer                2.2.2                    pypi_0    pypi\r\npillow                    8.1.0                    pypi_0    pypi\r\npip                       20.3.3           py36h06a4308_0  \r\nprotobuf                  3.14.0                   pypi_0    pypi\r\npyasn1                    0.4.8                    pypi_0    pypi\r\npyasn1-modules            0.2.8                    pypi_0    pypi\r\npycparser                 2.20                     pypi_0    pypi\r\npylint                    2.5.3                    pypi_0    pypi\r\npyparsing                 2.4.7                    pypi_0    pypi\r\npysbd                     0.3.3                    pypi_0    pypi\r\npysocks                   1.7.1                    pypi_0    pypi\r\npython                    3.6.12               hcff3b4d_2  \r\npython-dateutil           2.8.1                    pypi_0    pypi\r\npyworld                   0.2.12                   pypi_0    pypi\r\npyyaml                    5.3.1                    pypi_0    pypi\r\nreadline                  8.0                  h7b6447c_0  \r\nregex                     2020.11.13               pypi_0    pypi\r\nrequests                  2.25.1                   pypi_0    pypi\r\nrequests-oauthlib         1.3.0                    pypi_0    pypi\r\nresampy                   0.2.2                    pypi_0    pypi\r\nrfc3986                   1.4.0                    pypi_0    pypi\r\nrsa                       4.6                      pypi_0    pypi\r\nscikit-learn              0.24.0                   pypi_0    pypi\r\nscipy                     1.5.4                    pypi_0    pypi\r\nsegments                  2.2.0                    pypi_0    pypi\r\nsetuptools                51.0.0           py36h06a4308_2  \r\nsix                       1.15.0           py36h06a4308_0  \r\nsoundfile                 0.10.3.post1             pypi_0    pypi\r\nsqlite                    3.33.0               h62c20be_0  \r\ntabulate                  0.8.7                    pypi_0    pypi\r\ntensorboard               2.4.0                    pypi_0    pypi\r\ntensorboard-plugin-wit    1.7.0                    pypi_0    pypi\r\ntensorboardx              2.1                      pypi_0    pypi\r\ntensorflow                2.3.1                    pypi_0    pypi\r\ntensorflow-estimator      2.3.0                    pypi_0    pypi\r\ntermcolor                 1.1.0                    pypi_0    pypi\r\nthreadpoolctl             2.1.0                    pypi_0    pypi\r\ntk                        8.6.10               hbc83047_0  \r\ntoml                      0.10.2                   pypi_0    pypi\r\ntorch                     1.7.1                    pypi_0    pypi\r\ntornado                   6.1                      pypi_0    pypi\r\ntqdm                      4.55.1                   pypi_0    pypi\r\ntts                       0.0.6+9cf474a            pypi_0    pypi\r\ntyped-ast                 1.4.2                    pypi_0    pypi\r\ntyping-extensions         3.7.4.3                  pypi_0    pypi\r\numap-learn                0.4.6                    pypi_0    pypi\r\nunidecode                 0.04.20                  pypi_0    pypi\r\nuritemplate               3.0.1                    pypi_0    pypi\r\nurllib3                   1.26.2                   pypi_0    pypi\r\nwerkzeug                  1.0.1                    pypi_0    pypi\r\nwheel                     0.36.2             pyhd3eb1b0_0  \r\nwrapt                     1.12.1                   pypi_0    pypi\r\nxz                        5.2.5                h7b6447c_0  \r\nzipp                      3.4.0                    pypi_0    pypi\r\nzlib                      1.2.11               h7b6447c_3 \r\n```\r\n\r\nAnd here's the whole Traceback:\r\n\r\n```python\r\n$ python TTS/bin/train_vocoder_gan.py --config_path TTS/vocoder/configs/my_parallel_wavegan_config.json                                                                                                                                                    \r\n\r\n > Using CUDA:  True                                                                                                                                                                                                                                         \r\n > Number of GPUs:  1                                                                                                                                                                                                                                        \r\n > Git Hash: 7beaacc                                                                                                                                                                                                                                         \r\n > Experiment folder: /home/vibe/tts/mozilla/Models/LJSpeech/pwgan-January-16-2021_11+48AM-7beaacc                                                                                                                                                           \r\n > Loading wavs from: /home/vibe/tts/databases/LJSpeech-1.1/wavs/                                                                                                                                                                                            \r\n > Setting up Audio Processor...\r\n | > sample_rate:22050\r\n | > resample:False\r\n | > num_mels:80\r\n | > min_level_db:-100\r\n | > frame_shift_ms:None\r\n | > frame_length_ms:None\r\n | > ref_level_db:0\r\n | > fft_size:1024\r\n | > power:None\r\n | > preemphasis:0.0\r\n | > griffin_lim_iters:None\r\n | > signal_norm:True\r\n | > symmetric_norm:True\r\n | > mel_fmin:50.0\r\n | > mel_fmax:7600.0\r\n | > spec_gain:1.0\r\n | > stft_pad_mode:reflect\r\n | > max_norm:4.0\r\n | > clip_norm:True\r\n | > do_trim_silence:True\r\n | > trim_db:60\r\n | > do_sound_norm:False\r\n | > stats_path:/home/vibe/tts/databases/LJSpeech-1.1/scale_stats.npy\r\n | > hop_length:256\r\n | > win_length:1024\r\n > Generator Model: parallel_wavegan_generator\r\n > Discriminator Model: parallel_wavegan_discriminator\r\n > Generator has 1320442 parameters\r\n > Discriminator has 99842 parameters\r\n\r\n > EPOCH: 0/10000\r\n\r\n > TRAINING (2021-01-16 11:48:49) \r\n/home/vibe/miniconda3/envs/tts/lib/python3.6/site-packages/torch/functional.py:516: UserWarning: stft will require the return_complex parameter be explicitly  specified in a future PyTorch release. Use return_complex=False  to preserve the current behavior or return_complex=True to return  a complex output. (Triggered internally at  /pytorch/aten/src/ATen/native/SpectralOps.cpp:653.)\r\n  normalized, onesided, return_complex)\r\n ! Run is removed from /home/vibe/tts/mozilla/Models/LJSpeech/pwgan-January-16-2021_11+48AM-7beaacc\r\nTraceback (most recent call last):\r\n  File \"TTS/bin/train_vocoder_gan.py\", line 654, in <module>\r\n    main(args)\r\n  File \"TTS/bin/train_vocoder_gan.py\", line 559, in main\r\n    epoch)\r\n  File \"TTS/bin/train_vocoder_gan.py\", line 152, in train\r\n    feats_real, y_hat_sub, y_G_sub)\r\n  File \"/home/vibe/miniconda3/envs/tts/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 727, in _call_impl\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/vibe/tts/mozilla/TTS_gerazov/TTS/vocoder/layers/losses.py\", line 233, in forward\r\n    stft_loss_mg, stft_loss_sc = self.stft_loss(y_hat.squeeze(1), y.squeeze(1))\r\n  File \"/home/vibe/miniconda3/envs/tts/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 727, in _call_impl\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/vibe/tts/mozilla/TTS_gerazov/TTS/vocoder/layers/losses.py\", line 70, in forward\r\n    lm, lsc = f(y_hat, y)\r\n  File \"/home/vibe/miniconda3/envs/tts/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 727, in _call_impl\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/vibe/tts/mozilla/TTS_gerazov/TTS/vocoder/layers/losses.py\", line 46, in forward\r\n    y_hat_M = self.stft(y_hat)\r\n  File \"/home/vibe/tts/mozilla/TTS_gerazov/TTS/vocoder/layers/losses.py\", line 25, in __call__\r\n    onesided=True)\r\n  File \"/home/vibe/miniconda3/envs/tts/lib/python3.6/site-packages/torch/functional.py\", line 516, in stft\r\n    normalized, onesided, return_complex)\r\nRuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu!\r\n```","closed_by":{"login":"erogol","id":1402048,"node_id":"MDQ6VXNlcjE0MDIwNDg=","avatar_url":"https://avatars.githubusercontent.com/u/1402048?v=4","gravatar_id":"","url":"https://api.github.com/users/erogol","html_url":"https://github.com/erogol","followers_url":"https://api.github.com/users/erogol/followers","following_url":"https://api.github.com/users/erogol/following{/other_user}","gists_url":"https://api.github.com/users/erogol/gists{/gist_id}","starred_url":"https://api.github.com/users/erogol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erogol/subscriptions","organizations_url":"https://api.github.com/users/erogol/orgs","repos_url":"https://api.github.com/users/erogol/repos","events_url":"https://api.github.com/users/erogol/events{/privacy}","received_events_url":"https://api.github.com/users/erogol/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mozilla/TTS/issues/619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mozilla/TTS/issues/619/timeline","performed_via_github_app":null,"state_reason":"completed"}