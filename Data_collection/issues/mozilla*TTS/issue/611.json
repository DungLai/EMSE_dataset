{"url":"https://api.github.com/repos/mozilla/TTS/issues/611","repository_url":"https://api.github.com/repos/mozilla/TTS","labels_url":"https://api.github.com/repos/mozilla/TTS/issues/611/labels{/name}","comments_url":"https://api.github.com/repos/mozilla/TTS/issues/611/comments","events_url":"https://api.github.com/repos/mozilla/TTS/issues/611/events","html_url":"https://github.com/mozilla/TTS/issues/611","id":776060131,"node_id":"MDU6SXNzdWU3NzYwNjAxMzE=","number":611,"title":"Melgan training with use_cache: true and num_loader_workers > 0 errors on Windows","user":{"login":"lasa01","id":3680681,"node_id":"MDQ6VXNlcjM2ODA2ODE=","avatar_url":"https://avatars.githubusercontent.com/u/3680681?v=4","gravatar_id":"","url":"https://api.github.com/users/lasa01","html_url":"https://github.com/lasa01","followers_url":"https://api.github.com/users/lasa01/followers","following_url":"https://api.github.com/users/lasa01/following{/other_user}","gists_url":"https://api.github.com/users/lasa01/gists{/gist_id}","starred_url":"https://api.github.com/users/lasa01/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lasa01/subscriptions","organizations_url":"https://api.github.com/users/lasa01/orgs","repos_url":"https://api.github.com/users/lasa01/repos","events_url":"https://api.github.com/users/lasa01/events{/privacy}","received_events_url":"https://api.github.com/users/lasa01/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-12-29T19:53:20Z","updated_at":"2021-01-03T14:50:27Z","closed_at":"2021-01-03T14:50:27Z","author_association":"NONE","active_lock_reason":null,"body":"Trying to train melgan on Windows with `\"use_cache\": true` in config results in the following error:\r\n```\r\n> Using CUDA:  True\r\n > Number of GPUs:  1\r\n > Git Hash: 7cf2052\r\n > Experiment folder: ...\r\n > Loading wavs from: ...\r\n > Setting up Audio Processor...\r\n | > sample_rate:22050\r\n | > num_mels:80\r\n | > min_level_db:-100\r\n | > frame_shift_ms:None\r\n | > frame_length_ms:None\r\n | > ref_level_db:0\r\n | > fft_size:1024\r\n | > power:None\r\n | > preemphasis:0.0\r\n | > griffin_lim_iters:None\r\n | > signal_norm:True\r\n | > symmetric_norm:True\r\n | > mel_fmin:50.0\r\n | > mel_fmax:7600.0\r\n | > spec_gain:1.0\r\n | > stft_pad_mode:reflect\r\n | > max_norm:4.0\r\n | > clip_norm:True\r\n | > do_trim_silence:True\r\n | > trim_db:60\r\n | > do_sound_norm:False\r\n | > stats_path: ...\r\n | > hop_length:256\r\n | > win_length:1024\r\n > Generator Model: multiband_melgan_generator\r\n > Discriminator Model: melgan_multiscale_discriminator\r\n > Generator has 2539448 parameters\r\n > Discriminator has 4354998 parameters\r\n\r\n > EPOCH: 0/10000\r\n > Using CUDA:  True\r\n > Number of GPUs:  1\r\n\r\n > TRAINING (2020-12-29 21:26:49)\r\n > Using CUDA:  True\r\n > Number of GPUs:  1\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\spawn.py\", line 105, in spawn_main\r\n    exitcode = _main(fd)\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\spawn.py\", line 115, in _main\r\n    self = reduction.pickle.load(from_parent)\r\nEOFError: Ran out of input\r\n ! Run is removed from ...\r\nTraceback (most recent call last):\r\n  File \"TTS\\bin\\train_vocoder_gan.py\", line 654, in <module>\r\n    main(args)\r\n  File \"TTS\\bin\\train_vocoder_gan.py\", line 559, in main\r\n    epoch)\r\n  File \"TTS\\bin\\train_vocoder_gan.py\", line 100, in train\r\n    for num_iter, data in enumerate(data_loader):\r\n  File \"d:\\lasa\\Code\\tts_venv\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 279, in __iter__\r\n    return _MultiProcessingDataLoaderIter(self)\r\n  File \"d:\\lasa\\Code\\tts_venv\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 719, in __init__\r\n    w.start()\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\process.py\", line 105, in start\r\n    self._popen = self._Popen(self)\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\context.py\", line 223, in _Popen\r\n    return _default_context.get_context().Process._Popen(process_obj)\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\context.py\", line 322, in _Popen\r\n    return Popen(process_obj)\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\popen_spawn_win32.py\", line 65, in __init__\r\n    reduction.dump(process_obj, to_child)\r\n  File \"C:\\Program Files\\Python36\\lib\\multiprocessing\\reduction.py\", line 60, in dump\r\n    ForkingPickler(file, protocol).dump(obj)\r\nTypeError: can't pickle weakref objects\r\n```\r\n\r\nThe problem can be worked around by either setting `num_loader_workers` and `num_val_loader_workers` to 0, or by disabling `use_cache`.\r\n\r\nThe error seems to be related to pickling `self.manager` defined in `TTS\\vocoder\\datasets\\gan_dataset.py` line 54.\r\nLooks like the manager is not picklable.\r\n\r\nLooks like the manager is not used anywhere else other than the next line though, so this change:\r\n```diff\r\ndiff --git a/TTS/vocoder/datasets/gan_dataset.py b/TTS/vocoder/datasets/gan_dataset.py\r\nindex af23fbf..3cc0183 100644\r\n--- a/TTS/vocoder/datasets/gan_dataset.py\r\n+++ b/TTS/vocoder/datasets/gan_dataset.py\r\n@@ -51,8 +51,7 @@ class GANDataset(Dataset):\r\n             self.create_feature_cache()\r\n\r\n     def create_feature_cache(self):\r\n-        self.manager = Manager()\r\n-        self.cache = self.manager.list()\r\n+        self.cache = Manager().list()\r\n         self.cache += [None for _ in range(len(self.item_list))]\r\n\r\n     @staticmethod\r\n```\r\nfixes the issue.","closed_by":{"login":"erogol","id":1402048,"node_id":"MDQ6VXNlcjE0MDIwNDg=","avatar_url":"https://avatars.githubusercontent.com/u/1402048?v=4","gravatar_id":"","url":"https://api.github.com/users/erogol","html_url":"https://github.com/erogol","followers_url":"https://api.github.com/users/erogol/followers","following_url":"https://api.github.com/users/erogol/following{/other_user}","gists_url":"https://api.github.com/users/erogol/gists{/gist_id}","starred_url":"https://api.github.com/users/erogol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erogol/subscriptions","organizations_url":"https://api.github.com/users/erogol/orgs","repos_url":"https://api.github.com/users/erogol/repos","events_url":"https://api.github.com/users/erogol/events{/privacy}","received_events_url":"https://api.github.com/users/erogol/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mozilla/TTS/issues/611/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mozilla/TTS/issues/611/timeline","performed_via_github_app":null,"state_reason":"completed"}