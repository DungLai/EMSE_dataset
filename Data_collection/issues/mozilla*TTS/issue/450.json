{"url":"https://api.github.com/repos/mozilla/TTS/issues/450","repository_url":"https://api.github.com/repos/mozilla/TTS","labels_url":"https://api.github.com/repos/mozilla/TTS/issues/450/labels{/name}","comments_url":"https://api.github.com/repos/mozilla/TTS/issues/450/comments","events_url":"https://api.github.com/repos/mozilla/TTS/issues/450/events","html_url":"https://github.com/mozilla/TTS/issues/450","id":654384313,"node_id":"MDU6SXNzdWU2NTQzODQzMTM=","number":450,"title":"Vocoder data loading difficulties with short wav files","user":{"login":"nmstoker","id":3694484,"node_id":"MDQ6VXNlcjM2OTQ0ODQ=","avatar_url":"https://avatars.githubusercontent.com/u/3694484?v=4","gravatar_id":"","url":"https://api.github.com/users/nmstoker","html_url":"https://github.com/nmstoker","followers_url":"https://api.github.com/users/nmstoker/followers","following_url":"https://api.github.com/users/nmstoker/following{/other_user}","gists_url":"https://api.github.com/users/nmstoker/gists{/gist_id}","starred_url":"https://api.github.com/users/nmstoker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nmstoker/subscriptions","organizations_url":"https://api.github.com/users/nmstoker/orgs","repos_url":"https://api.github.com/users/nmstoker/repos","events_url":"https://api.github.com/users/nmstoker/events{/privacy}","received_events_url":"https://api.github.com/users/nmstoker/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-07-09T22:23:51Z","updated_at":"2020-07-12T12:29:47Z","closed_at":"2020-07-12T12:29:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I am trying to use the new vocoder in dev, but seem to be running into problems with short wav files.  I see the code makes an attempt to pad the files ([here](https://github.com/mozilla/TTS/blob/c7296b342368c2672b4de12a69e372d2935531d4/vocoder/datasets/gan_dataset.py#L103)) but it seems like it fails with files of short length, such as a few that I have with a single word (example file below is 32kb)\r\n\r\nIn the script output below, showing training crashing as it attempts the first epoch, I have added some print statements to vocoder/datasets/gan_datasets.py, but this was merely to let me zero in on the specific problem wav files and i made no other code changes.\r\n \r\n```\r\n(tts_ddc1) [neil@ramandu TTS]$ CUDA_VISIBLE_DEVICES='1' python vocoder/train.py --config_path ../models/neil17/config_vocoder_neil17_A.json \r\n > Using CUDA:  False\r\n > Number of GPUs:  0\r\n > Git Hash: b1935c9\r\n > Experiment folder: /home/neil/main/Projects/TTSJul2020/models/neil17/multiband-melgan-July-09-2020_10+41PM-b1935c9\r\n > Loading wavs from: /home/neil/data/Projects/NeilTTS/neil16/wavs/\r\n > Setting up Audio Processor...\r\n | > sample_rate:22050\r\n | > num_mels:80\r\n | > min_level_db:-90\r\n | > frame_shift_ms:None\r\n | > frame_length_ms:None\r\n | > ref_level_db:25\r\n | > fft_size:1024\r\n | > power:None\r\n | > preemphasis:0.0\r\n | > griffin_lim_iters:None\r\n | > signal_norm:True\r\n | > symmetric_norm:True\r\n | > mel_fmin:40.0\r\n | > mel_fmax:8000.0\r\n | > spec_gain:1.0\r\n | > stft_pad_mode:reflect\r\n | > max_norm:4.0\r\n | > clip_norm:True\r\n | > do_trim_silence:True\r\n | > trim_db:60\r\n | > do_sound_norm:False\r\n | > stats_path:/home/neil/main/Projects/TTSJul2020/models/neil17/scale_stats.npy\r\n | > hop_length:256\r\n | > win_length:1024\r\n > Generator Model: multiband_melgan_generator\r\n > Discriminator Model: melgan_multiscale_discriminator\r\n > Generator has 2539448 parameters\r\n > Discriminator has 4354998 parameters\r\n\r\n > EPOCH: 0/10000\r\n\r\n > TRAINING (2020-07-09 22:41:15) \r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_25113.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_30350.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_28075.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_12633.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_19891.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_9142.wav\r\nPadding short wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_29241.wav\r\n ! Run is removed from /home/neil/main/Projects/TTSJul2020/models/neil17/multiband-melgan-July-09-2020_10+41PM-b1935c9\r\nTraceback (most recent call last):\r\n  File \"vocoder/train.py\", line 648, in <module>\r\n    main(args)\r\n  File \"vocoder/train.py\", line 552, in main\r\n    epoch)\r\n  File \"vocoder/train.py\", line 101, in train\r\n    for num_iter, data in enumerate(data_loader):\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 345, in __next__\r\n    data = self._next_data()\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 856, in _next_data\r\n    return self._process_data(data)\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 881, in _process_data\r\n    data.reraise()\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/_utils.py\", line 395, in reraise\r\n    raise self.exc_type(msg)\r\nValueError: Caught ValueError in DataLoader worker process 0.\r\nOriginal Traceback (most recent call last):\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/_utils/worker.py\", line 178, in _worker_loop\r\n    data = fetcher.fetch(index)\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/_utils/fetch.py\", line 44, in fetch\r\n    data = [self.dataset[idx] for idx in possibly_batched_index]\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/site-packages/torch/utils/data/_utils/fetch.py\", line 44, in <listcomp>\r\n    data = [self.dataset[idx] for idx in possibly_batched_index]\r\n  File \"/home/neil/main/Projects/TTSJul2020/TTS/tts_namespace/TTS/vocoder/datasets/gan_dataset.py\", line 72, in __getitem__\r\n    item2 = self.load_item(idx2)\r\n  File \"/home/neil/main/Projects/TTSJul2020/TTS/tts_namespace/TTS/vocoder/datasets/gan_dataset.py\", line 119, in load_item\r\n    mel_start = random.randint(0, max_mel_start)\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/random.py\", line 221, in randint\r\n    return self.randrange(a, b+1)\r\n  File \"/home/neil/.conda/envs/tts_ddc1/lib/python3.6/random.py\", line 199, in randrange\r\n    raise ValueError(\"empty range for randrange() (%d,%d, %d)\" % (istart, istop, width))\r\nValueError: empty range for randrange() (0,-5, -5)\r\n\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_3113.wav\r\ncomputing features from wav\r\n/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_14619.wav\r\nPadding short wav\r\n(tts_ddc1) [neil@ramandu TTS]$ aplay /home/neil/data/Projects/NeilTTS/neil16/wavs/p225_9142.wav \r\nPlaying WAVE '/home/neil/data/Projects/NeilTTS/neil16/wavs/p225_9142.wav' : Signed 16 bit Little Endian, Rate 22050 Hz, Mono\r\n(tts_ddc1) [neil@ramandu TTS]$ ls -lah /home/neil/data/Projects/NeilTTS/neil16/wavs/p225_9142.wav \r\n-rw-r--r-- 1 neil users 34K Apr 23 00:39 /home/neil/data/Projects/NeilTTS/neil16/wavs/p225_9142.wav\r\n\r\n```\r\nI'll keep looking and see what I can figure out to resolve it but wanted to flag it in case others ran into this.\r\nMy config is attached too (merely with .txt suffix to get it uploaded here) - I hope i've chosen sensible values and no obvious mistakes - it's very close to the version in the vocoders folder anyway.\r\n\r\n[config_vocoder_neil17_A_json.txt](https://github.com/mozilla/TTS/files/4899727/config_vocoder_neil17_A_json.txt)\r\n\r\n\r\nI am running training with just the audio files and that seems to be what the README recommends.  I did see the file **compute_tts_features.py** which seems like it would let me preprocess the audio into features but it's currently a blank file, so I've stuck to just the audio files.\r\n\r\nThe errors appear slightly out of order due to the multiprocessing but it seems to be the file right before the \"Padding short wav\" comment is printed, in this case p225_9142.wav in my dataset, which after the crash I then play to determine it is indeed short and then I list the size.  The file from my dataset that triggers this varies as the dataloader order is randomised and I have a selection of fairly short(ish) files.\r\n\r\nMy suspicion is I may need to try something with **seq_len** or **pad_short**, I'm just hesitant to give it a go, only to find it was a mistake after a four day run! :slightly_smiling_face: \r\n\r\nOn a related note, I haven't yet done it, but I am assuming that I could dump both my validation wav and training wavs together into the folder I use for the vocoder since it is not asking for a split and I believe it just tries to learn to reproduce the input snippets (so it measures against the input, right?)","closed_by":{"login":"nmstoker","id":3694484,"node_id":"MDQ6VXNlcjM2OTQ0ODQ=","avatar_url":"https://avatars.githubusercontent.com/u/3694484?v=4","gravatar_id":"","url":"https://api.github.com/users/nmstoker","html_url":"https://github.com/nmstoker","followers_url":"https://api.github.com/users/nmstoker/followers","following_url":"https://api.github.com/users/nmstoker/following{/other_user}","gists_url":"https://api.github.com/users/nmstoker/gists{/gist_id}","starred_url":"https://api.github.com/users/nmstoker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nmstoker/subscriptions","organizations_url":"https://api.github.com/users/nmstoker/orgs","repos_url":"https://api.github.com/users/nmstoker/repos","events_url":"https://api.github.com/users/nmstoker/events{/privacy}","received_events_url":"https://api.github.com/users/nmstoker/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mozilla/TTS/issues/450/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mozilla/TTS/issues/450/timeline","performed_via_github_app":null,"state_reason":"completed"}