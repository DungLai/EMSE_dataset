{"url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13","repository_url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras","labels_url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13/labels{/name}","comments_url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13/comments","events_url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13/events","html_url":"https://github.com/umbertogriffo/focal-loss-keras/issues/13","id":653267848,"node_id":"MDU6SXNzdWU2NTMyNjc4NDg=","number":13,"title":"Is the categorical one implemented right?","user":{"login":"ysyyork","id":6693605,"node_id":"MDQ6VXNlcjY2OTM2MDU=","avatar_url":"https://avatars.githubusercontent.com/u/6693605?v=4","gravatar_id":"","url":"https://api.github.com/users/ysyyork","html_url":"https://github.com/ysyyork","followers_url":"https://api.github.com/users/ysyyork/followers","following_url":"https://api.github.com/users/ysyyork/following{/other_user}","gists_url":"https://api.github.com/users/ysyyork/gists{/gist_id}","starred_url":"https://api.github.com/users/ysyyork/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ysyyork/subscriptions","organizations_url":"https://api.github.com/users/ysyyork/orgs","repos_url":"https://api.github.com/users/ysyyork/repos","events_url":"https://api.github.com/users/ysyyork/events{/privacy}","received_events_url":"https://api.github.com/users/ysyyork/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-07-08T12:45:19Z","updated_at":"2020-07-09T09:59:52Z","closed_at":"2020-07-09T09:59:52Z","author_association":"NONE","active_lock_reason":null,"body":"I think the cross entropy part is wrong. \r\n```\r\ndef categorical_focal_loss_fixed(y_true, y_pred):\r\n        \"\"\"\r\n        :param y_true: A tensor of the same shape as `y_pred`\r\n        :param y_pred: A tensor resulting from a softmax\r\n        :return: Output tensor.\r\n        \"\"\"\r\n\r\n        # Scale predictions so that the class probas of each sample sum to 1\r\n        y_pred /= K.sum(y_pred, axis=-1, keepdims=True)\r\n\r\n        # Clip the prediction value to prevent NaN's and Inf's\r\n        epsilon = K.epsilon()\r\n        y_pred = K.clip(y_pred, epsilon, 1. - epsilon)\r\n\r\n        # Calculate Cross Entropy\r\n        cross_entropy = -y_true * K.log(y_pred)\r\n\r\n        # Calculate Focal Loss\r\n        loss = alpha * K.pow(1 - y_pred, gamma) * cross_entropy\r\n\r\n        # Compute mean loss in mini_batch\r\n        return K.mean(K.sum(loss, axis=-1))\r\n\r\n    return categorical_focal_loss_fixed\r\n```\r\nSo currently  `cross_entropy = -y_true * K.log(y_pred)`. This already ignored all the true negative cases. I think the right implementation should be below:\r\n```\r\n...\r\nloss = - y_true * K.log(y_pred) * K.pow(1 - y_pred, gamma) * alpha \\\r\n                        - (1 - y_true) * K.log(1 - y_pred) * K.pow(y_pred, gamma) * (1 - alpha)\r\n...\r\n```\r\nThe loss should be implemented like this. Let me know if this makes sense. When I'm testing using this loss on my model. this new one works much better than the old one. ","closed_by":{"login":"umbertogriffo","id":1609440,"node_id":"MDQ6VXNlcjE2MDk0NDA=","avatar_url":"https://avatars.githubusercontent.com/u/1609440?v=4","gravatar_id":"","url":"https://api.github.com/users/umbertogriffo","html_url":"https://github.com/umbertogriffo","followers_url":"https://api.github.com/users/umbertogriffo/followers","following_url":"https://api.github.com/users/umbertogriffo/following{/other_user}","gists_url":"https://api.github.com/users/umbertogriffo/gists{/gist_id}","starred_url":"https://api.github.com/users/umbertogriffo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/umbertogriffo/subscriptions","organizations_url":"https://api.github.com/users/umbertogriffo/orgs","repos_url":"https://api.github.com/users/umbertogriffo/repos","events_url":"https://api.github.com/users/umbertogriffo/events{/privacy}","received_events_url":"https://api.github.com/users/umbertogriffo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/umbertogriffo/focal-loss-keras/issues/13/timeline","performed_via_github_app":null,"state_reason":"completed"}