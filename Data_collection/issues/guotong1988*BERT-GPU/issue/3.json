{"url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3","repository_url":"https://api.github.com/repos/guotong1988/BERT-GPU","labels_url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3/labels{/name}","comments_url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3/comments","events_url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3/events","html_url":"https://github.com/guotong1988/BERT-GPU/issues/3","id":421859509,"node_id":"MDU6SXNzdWU0MjE4NTk1MDk=","number":3,"title":"Slower than single GPU","user":{"login":"hankcs","id":5326890,"node_id":"MDQ6VXNlcjUzMjY4OTA=","avatar_url":"https://avatars.githubusercontent.com/u/5326890?v=4","gravatar_id":"","url":"https://api.github.com/users/hankcs","html_url":"https://github.com/hankcs","followers_url":"https://api.github.com/users/hankcs/followers","following_url":"https://api.github.com/users/hankcs/following{/other_user}","gists_url":"https://api.github.com/users/hankcs/gists{/gist_id}","starred_url":"https://api.github.com/users/hankcs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankcs/subscriptions","organizations_url":"https://api.github.com/users/hankcs/orgs","repos_url":"https://api.github.com/users/hankcs/repos","events_url":"https://api.github.com/users/hankcs/events{/privacy}","received_events_url":"https://api.github.com/users/hankcs/received_events","type":"User","site_admin":false},"labels":[{"id":1171766087,"node_id":"MDU6TGFiZWwxMTcxNzY2MDg3","url":"https://api.github.com/repos/guotong1988/BERT-GPU/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1171766089,"node_id":"MDU6TGFiZWwxMTcxNzY2MDg5","url":"https://api.github.com/repos/guotong1988/BERT-GPU/labels/enhancement","name":"enhancement","color":"a2eeef","default":true,"description":"New feature or request"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2019-03-16T22:32:39Z","updated_at":"2021-03-25T08:24:06Z","closed_at":"2020-05-21T08:40:55Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, thanks for your work. I'd say that there is an error when measuring time. The unit of `time.time()` is second, not ms.\r\n\r\nhttps://github.com/guotong1988/BERT-multi-gpu/blob/14c3ca9aaafe71e1bc816677ca36a12c81530b1d/run_pretraining_gpu.py#L726\r\n\r\nThen, I would say that this naive `MirroredStrategy` is slower than single GPU. According to my experiments on `4`  Tesla V100 GPUs, this implementation takes around `88` seconds per 100 steps.\r\n\r\n```\r\n88.0555248260498  s\r\nloss  22828.4058984375\r\n------------\r\n88.03012156486511  s\r\nloss  17133.7074609375\r\n------------\r\n88.0766191482544  s\r\nloss  13693.772515625\r\n------------\r\n88.04167246818542  s\r\nloss  11408.907552083334\r\n```\r\n\r\nWhile the official BERT single-gpu version reports `2.9` steps per second, which means it takes around `34` seconds for `100` steps. Part of the log is as follows.\r\n\r\n```\r\nINFO:tensorflow:global_step/sec: 2.90046\r\nINFO:tensorflow:examples/sec: 46.4073\r\n```\r\n\r\nYou can insert a hook to record performance:\r\n\r\n```\r\nhook = tf.train.ProfilerHook(save_steps=100,\r\n                                     output_dir=FLAGS.output_dir,\r\n                                     show_memory=True)\r\nestimator.train(input_fn=train_input_fn, max_steps=FLAGS.num_train_steps, hooks=[hook])\r\n```\r\n\r\nMy experiment configuration is:\r\n\r\n```\r\npython3 run_pretraining_gpu.py \\\r\n  --input_file=data/tfrecord/sample.tfrecord \\\r\n  --output_dir=data/wiki_uncased_L-12_H-768_A-12 \\\r\n  --do_train=True \\\r\n  --do_eval=True \\\r\n  --bert_config_file=${BERT_BASE_DIR}/bert_config.json \\\r\n  --init_checkpoint=${BERT_BASE_DIR}/bert_model.ckpt \\\r\n  --train_batch_size=16 \\\r\n  --max_seq_length=256 \\\r\n  --max_predictions_per_seq=38 \\\r\n  --num_train_steps=1000 \\\r\n  --num_warmup_steps=10 \\\r\n  --learning_rate=2e-5\r\n```","closed_by":{"login":"guotong1988","id":4702353,"node_id":"MDQ6VXNlcjQ3MDIzNTM=","avatar_url":"https://avatars.githubusercontent.com/u/4702353?v=4","gravatar_id":"","url":"https://api.github.com/users/guotong1988","html_url":"https://github.com/guotong1988","followers_url":"https://api.github.com/users/guotong1988/followers","following_url":"https://api.github.com/users/guotong1988/following{/other_user}","gists_url":"https://api.github.com/users/guotong1988/gists{/gist_id}","starred_url":"https://api.github.com/users/guotong1988/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guotong1988/subscriptions","organizations_url":"https://api.github.com/users/guotong1988/orgs","repos_url":"https://api.github.com/users/guotong1988/repos","events_url":"https://api.github.com/users/guotong1988/events{/privacy}","received_events_url":"https://api.github.com/users/guotong1988/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/guotong1988/BERT-GPU/issues/3/timeline","performed_via_github_app":null,"state_reason":"completed"}