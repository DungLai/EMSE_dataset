{"url":"https://api.github.com/repos/google-research/language/issues/105","repository_url":"https://api.github.com/repos/google-research/language","labels_url":"https://api.github.com/repos/google-research/language/issues/105/labels{/name}","comments_url":"https://api.github.com/repos/google-research/language/issues/105/comments","events_url":"https://api.github.com/repos/google-research/language/issues/105/events","html_url":"https://github.com/google-research/language/issues/105","id":929094343,"node_id":"MDU6SXNzdWU5MjkwOTQzNDM=","number":105,"title":"REALM pre-training in multi-GPU setup","user":{"login":"jivatneet","id":39404029,"node_id":"MDQ6VXNlcjM5NDA0MDI5","avatar_url":"https://avatars.githubusercontent.com/u/39404029?v=4","gravatar_id":"","url":"https://api.github.com/users/jivatneet","html_url":"https://github.com/jivatneet","followers_url":"https://api.github.com/users/jivatneet/followers","following_url":"https://api.github.com/users/jivatneet/following{/other_user}","gists_url":"https://api.github.com/users/jivatneet/gists{/gist_id}","starred_url":"https://api.github.com/users/jivatneet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jivatneet/subscriptions","organizations_url":"https://api.github.com/users/jivatneet/orgs","repos_url":"https://api.github.com/users/jivatneet/repos","events_url":"https://api.github.com/users/jivatneet/events{/privacy}","received_events_url":"https://api.github.com/users/jivatneet/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-06-24T10:43:10Z","updated_at":"2021-06-24T11:02:16Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi, thankyou for releasing the code and data. \r\nI am trying to run the original REALM code. I see the default setting is disabled for TPUs. I have a machine with 8 GPUs of 16GB each. I am not able to understand why your scaled down code (with 16 as batch size, which I tried reducing down to 4) is also producing an OOM error on my machine. Do I need to explicitly need to define a train and eval distribute strategy here? https://github.com/google-research/language/blob/d9bdad8d007c53c4cb6c0be3edabcce0393d226c/language/common/utils/experiment_utils.py#L142\r\n\r\nPlease find the log:\r\n```\r\n2021-06-24 09:37:39.818921: W tensorflow/core/common_runtime/bfc_allocator.cc:419] Allocator (GPU_0_bfc) ran out of memory trying to allocate 64.0KiB (rounded to 65536).  Current allocation summary follows.*\r\n2021-06-24 09:37:39.819832: I tensorflow/core/common_runtime/bfc_allocator.cc:921] Sum Total of in-use chunks: 34.25MiB\r\n2021-06-24 09:37:39.819837: I tensorflow/core/common_runtime/bfc_allocator.cc:923] total_region_allocated_bytes_: 35913728 memory_limit_: 35913728 available bytes: 0 curr_region_allocation_bytes_: 71827456\r\n2021-06-24 09:37:39.819846: I tensorflow/core/common_runtime/bfc_allocator.cc:929] Stats: \r\nLimit:                    35913728\r\nInUse:                    35913728\r\nMaxInUse:                 35913728\r\nNumAllocs:                     114\r\nMaxAllocSize:             19636736\r\n\r\n2021-06-24 09:37:39.819855: W tensorflow/core/common_runtime/bfc_allocator.cc:424] *****************************************************************************************xxxxxxxxxxx\r\n2021-06-24 09:37:39.819883: W tensorflow/core/framework/op_kernel.cc:1628] OP_REQUIRES failed at constant_op.cc:77 : Resource exhausted: OOM when allocating tensor of shape [128,128] and type float\r\n2021-06-24 09:37:39.819929: E tensorflow/core/common_runtime/executor.cc:642] Executor failed to create kernel. Resource exhausted: OOM when allocating tensor of shape [128,128] and type float\r\n\t [[{{node embedder/module/bert/encoder/layer_1/attention/output/dense/kernel/adam_v/Initializer/zeros}}]]\r\nTraceback (most recent call last):\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1365, in _do_call\r\n    return fn(*args)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1350, in _run_fn\r\n    target_list, run_metadata)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1443, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: OOM when allocating tensor of shape [128,128] and type float\r\n\t [[{{node embedder/module/bert/encoder/layer_1/attention/output/dense/kernel/adam_v/Initializer/zeros}}]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/opt/conda/envs/try/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"/opt/conda/envs/try/lib/python3.7/runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"/home/jikaur/language/language/realm/train_realm.py\", line 112, in <module>\r\n    app.run(main)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/absl/app.py\", line 312, in run\r\n    _run_main(main, args)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/absl/app.py\", line 258, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"/home/jikaur/language/language/realm/train_realm.py\", line 94, in main\r\n    exporters=model.get_exporters(params))\r\n  File \"/home/jikaur/language/language/common/utils/experiment_utils.py\", line 169, in run_experiment\r\n    eval_spec=eval_spec)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 473, in train_and_evaluate\r\n    return executor.run()\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 613, in run\r\n    return self.run_local()\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 714, in run_local\r\n    saving_listeners=saving_listeners)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 370, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1161, in _train_model\r\n    return self._train_model_default(input_fn, hooks, saving_listeners)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1195, in _train_model_default\r\n    saving_listeners)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1490, in _train_with_estimator_spec\r\n    log_step_count_steps=log_step_count_steps) as mon_sess:\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 584, in MonitoredTrainingSession\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 1014, in __init__\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 725, in __init__\r\n    self._sess = _RecoverableSession(self._coordinated_creator)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 1207, in __init__\r\n    _WrappedSession.__init__(self, self._create_session())\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 1212, in _create_session\r\n    return self._sess_creator.create_session()\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 878, in create_session\r\n    self.tf_sess = self._session_creator.create_session()\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/monitored_session.py\", line 647, in create_session\r\n    init_fn=self._scaffold.init_fn)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/training/session_manager.py\", line 296, in prepare_session\r\n    sess.run(init_op, feed_dict=init_feed_dict)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 956, in run\r\n    run_metadata_ptr)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1180, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1359, in _do_run\r\n    run_metadata)\r\n  File \"/opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/client/session.py\", line 1384, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.ResourceExhaustedError: OOM when allocating tensor of shape [128,128] and type float\r\n\t [[node embedder/module/bert/encoder/layer_1/attention/output/dense/kernel/adam_v/Initializer/zeros (defined at opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/framework/ops.py:1748) ]]\r\n\r\nOriginal stack trace for 'embedder/module/bert/encoder/layer_1/attention/output/dense/kernel/adam_v/Initializer/zeros':\r\n  File \"opt/conda/envs/try/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"opt/conda/envs/try/lib/python3.7/runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"home/jikaur/language/language/realm/train_realm.py\", line 112, in <module>\r\n    app.run(main)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/absl/app.py\", line 312, in run\r\n    _run_main(main, args)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/absl/app.py\", line 258, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"home/jikaur/language/language/realm/train_realm.py\", line 94, in main\r\n    exporters=model.get_exporters(params))\r\n  File \"home/jikaur/language/language/common/utils/experiment_utils.py\", line 169, in run_experiment\r\n    eval_spec=eval_spec)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 473, in train_and_evaluate\r\n    return executor.run()\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 613, in run\r\n    return self.run_local()\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/training.py\", line 714, in run_local\r\n    saving_listeners=saving_listeners)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 370, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1161, in _train_model\r\n    return self._train_model_default(input_fn, hooks, saving_listeners)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1191, in _train_model_default\r\n    features, labels, ModeKeys.TRAIN, self.config)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_estimator/python/estimator/estimator.py\", line 1149, in _call_model_fn\r\n    model_fn_results = self._model_fn(features=features, **kwargs)\r\n  File \"home/jikaur/language/language/realm/model.py\", line 186, in model_fn\r\n    use_tpu=params[\"use_tpu\"])\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/bert/optimization.py\", line 77, in create_optimizer\r\n    zip(grads, tvars), global_step=global_step)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/bert/optimization.py\", line 128, in apply_gradients\r\n    initializer=tf.zeros_initializer())\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 1500, in get_variable\r\n    aggregation=aggregation)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 1243, in get_variable\r\n    aggregation=aggregation)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 567, in get_variable\r\n    aggregation=aggregation)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 519, in _true_getter\r\n    aggregation=aggregation)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 933, in _get_single_variable\r\n    aggregation=aggregation)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 258, in __call__\r\n    return cls._variable_v1_call(*args, **kwargs)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 219, in _variable_v1_call\r\n    shape=shape)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 197, in <lambda>\r\n    previous_getter = lambda **kwargs: default_variable_creator(None, **kwargs)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 2519, in default_variable_creator\r\n    shape=shape)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 262, in __call__\r\n    return super(VariableMetaclass, cls).__call__(*args, **kwargs)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 1688, in __init__\r\n    shape=shape)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variables.py\", line 1818, in _init_from_args\r\n    initial_value(), name=\"initial_value\", dtype=dtype)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/variable_scope.py\", line 905, in <lambda>\r\n    partition_info=partition_info)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/init_ops.py\", line 114, in __call__\r\n    return array_ops.zeros(shape, dtype)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/array_ops.py\", line 2350, in zeros\r\n    output = fill(shape, constant(zero, dtype=dtype), name=name)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/array_ops.py\", line 171, in fill\r\n    result = gen_array_ops.fill(dims, value, name=name)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/ops/gen_array_ops.py\", line 3602, in fill\r\n    \"Fill\", dims=dims, value=value, name=name)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/framework/op_def_library.py\", line 794, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/util/deprecation.py\", line 507, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/framework/ops.py\", line 3357, in create_op\r\n    attrs, op_def, compute_device)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/framework/ops.py\", line 3426, in _create_op_internal\r\n    op_def=op_def)\r\n  File \"opt/conda/envs/try/lib/python3.7/site-packages/tensorflow_core/python/framework/ops.py\", line 1748, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n   ```\r\n    \r\n \r\n    *Not added the summary, can add if required.\r\n    Thanks a lot.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/google-research/language/issues/105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google-research/language/issues/105/timeline","performed_via_github_app":null,"state_reason":null}