{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/961","repository_url":"https://api.github.com/repos/blue-oil/blueoil","labels_url":"https://api.github.com/repos/blue-oil/blueoil/issues/961/labels{/name}","comments_url":"https://api.github.com/repos/blue-oil/blueoil/issues/961/comments","events_url":"https://api.github.com/repos/blue-oil/blueoil/issues/961/events","html_url":"https://github.com/blue-oil/blueoil/issues/961","id":591617360,"node_id":"MDU6SXNzdWU1OTE2MTczNjA=","number":961,"title":"Refactor network class interface","user":{"login":"tfujiwar","id":7463306,"node_id":"MDQ6VXNlcjc0NjMzMDY=","avatar_url":"https://avatars.githubusercontent.com/u/7463306?v=4","gravatar_id":"","url":"https://api.github.com/users/tfujiwar","html_url":"https://github.com/tfujiwar","followers_url":"https://api.github.com/users/tfujiwar/followers","following_url":"https://api.github.com/users/tfujiwar/following{/other_user}","gists_url":"https://api.github.com/users/tfujiwar/gists{/gist_id}","starred_url":"https://api.github.com/users/tfujiwar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tfujiwar/subscriptions","organizations_url":"https://api.github.com/users/tfujiwar/orgs","repos_url":"https://api.github.com/users/tfujiwar/repos","events_url":"https://api.github.com/users/tfujiwar/events{/privacy}","received_events_url":"https://api.github.com/users/tfujiwar/received_events","type":"User","site_admin":false},"labels":[{"id":1095590124,"node_id":"MDU6TGFiZWwxMDk1NTkwMTI0","url":"https://api.github.com/repos/blue-oil/blueoil/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-04-01T04:40:15Z","updated_at":"2020-10-07T07:50:47Z","closed_at":"2020-10-07T07:50:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This issue was proposed before but there is no progress.\r\nhttps://github.com/blue-oil/blueoil/pull/548#issuecomment-545253771\r\n\r\n## Problem\r\nCurrently, network class methods (e.g. `placeholders`, `inference`, `loss`, etc.) creates new operators when we call them. When we train networks, we need to construct a graph in training scripts by using those methods like this. But ideally, network classes should be responsible to construct a graph.\r\n```py\r\n# Create placeholders\r\nis_training_placeholder = tf.compat.v1.placeholder(tf.bool, name=\"is_training_placeholder\")\r\nimages_placeholder, labels_placeholder = model.placeholders()\r\n\r\n# Create train op\r\noutput = model.inference(images_placeholder, is_training_placeholder)\r\nloss = model.loss(output, labels_placeholder)\r\nopt = model.optimizer(global_step)\r\ntrain_op = model.train(loss, opt, global_step)\r\n\r\n# Create metrics op\r\nmetrics_ops_dict, metrics_update_op = model.metrics(output, labels_placeholder)\r\nmodel.summary(output, labels_placeholder)\r\nsummary_op = tf.compat.v1.summary.merge_all()\r\nmetrics_summary_op = executor.metrics_summary_op(metrics_ops_dict)\r\n```\r\n\r\nBecause of this, we need many local variables in a training script and it makes our training loop unnecessarily complicated.\r\n\r\n## Solution\r\nInitialize those operators (placeholders, train_op, summary_op) on constructing a network class instance and store them as properties of the instance.\r\n\r\nnetworks/base.py\r\n```py\r\nclass BaseNetwork(object):\r\n    def __init__(...):\r\n        ...\r\n        self.images, self.labels = self.placeholder()\r\n        self.is_training = tf.compat.v1.placeholder(tf.bool, name=\"is_training_placeholder\")\r\n        self.global_step = tf.Variable(0, trainable=False)\r\n\r\n        output = self.inference(self.images, self.is_training)\r\n        loss = self.loss(output, self.labels)\r\n        optimizer = self.optimizer(global_step)\r\n\r\n        self.train_op = self.train(loss, optimizer, global_step)\r\n```\r\n\r\n## TODO\r\n- [x] Move global_step to network classes\r\n- [ ] Move is_training_placeholder to network classes\r\n- [ ] Store placeholders as properties\r\n- [ ] Store train_op as a property\r\n- [ ] Store summary_op as a property\r\n- [ ] Store metrics_op as a property","closed_by":{"login":"tfujiwar","id":7463306,"node_id":"MDQ6VXNlcjc0NjMzMDY=","avatar_url":"https://avatars.githubusercontent.com/u/7463306?v=4","gravatar_id":"","url":"https://api.github.com/users/tfujiwar","html_url":"https://github.com/tfujiwar","followers_url":"https://api.github.com/users/tfujiwar/followers","following_url":"https://api.github.com/users/tfujiwar/following{/other_user}","gists_url":"https://api.github.com/users/tfujiwar/gists{/gist_id}","starred_url":"https://api.github.com/users/tfujiwar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tfujiwar/subscriptions","organizations_url":"https://api.github.com/users/tfujiwar/orgs","repos_url":"https://api.github.com/users/tfujiwar/repos","events_url":"https://api.github.com/users/tfujiwar/events{/privacy}","received_events_url":"https://api.github.com/users/tfujiwar/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/961/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blue-oil/blueoil/issues/961/timeline","performed_via_github_app":null,"state_reason":"completed"}