{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/909","repository_url":"https://api.github.com/repos/blue-oil/blueoil","labels_url":"https://api.github.com/repos/blue-oil/blueoil/issues/909/labels{/name}","comments_url":"https://api.github.com/repos/blue-oil/blueoil/issues/909/comments","events_url":"https://api.github.com/repos/blue-oil/blueoil/issues/909/events","html_url":"https://github.com/blue-oil/blueoil/issues/909","id":578564547,"node_id":"MDU6SXNzdWU1Nzg1NjQ1NDc=","number":909,"title":"lm_fpga.elf sometimes fails with classification","user":{"login":"tk26eng","id":35796618,"node_id":"MDQ6VXNlcjM1Nzk2NjE4","avatar_url":"https://avatars.githubusercontent.com/u/35796618?v=4","gravatar_id":"","url":"https://api.github.com/users/tk26eng","html_url":"https://github.com/tk26eng","followers_url":"https://api.github.com/users/tk26eng/followers","following_url":"https://api.github.com/users/tk26eng/following{/other_user}","gists_url":"https://api.github.com/users/tk26eng/gists{/gist_id}","starred_url":"https://api.github.com/users/tk26eng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tk26eng/subscriptions","organizations_url":"https://api.github.com/users/tk26eng/orgs","repos_url":"https://api.github.com/users/tk26eng/repos","events_url":"https://api.github.com/users/tk26eng/events{/privacy}","received_events_url":"https://api.github.com/users/tk26eng/received_events","type":"User","site_admin":false},"labels":[{"id":1095590109,"node_id":"MDU6TGFiZWwxMDk1NTkwMTA5","url":"https://api.github.com/repos/blue-oil/blueoil/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2020-03-10T13:05:04Z","updated_at":"2020-04-16T01:27:35Z","closed_at":"2020-04-16T01:27:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"An error occurs when we run lm_fpga.elf many times.\r\nThe probability that the problem occurs is around 1/10000.\r\n\r\nIn training, I almost followed the blueoil tutorial and modified some parameters.\r\nThe actual config is below.\r\n\r\n```\r\n# -*- coding: utf-8 -*-\r\n# Copyright 2018 The Blueoil Authors. All Rights Reserved.\r\n#\r\n# Licensed under the Apache License, Version 2.0 (the \"License\");\r\n# you may not use this file except in compliance with the License.\r\n# You may obtain a copy of the License at\r\n#\r\n#     http://www.apache.org/licenses/LICENSE-2.0\r\n#\r\n# Unless required by applicable law or agreed to in writing, software\r\n# distributed under the License is distributed on an \"AS IS\" BASIS,\r\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n# See the License for the specific language governing permissions and\r\n# limitations under the License.\r\n# =============================================================================\r\nfrom easydict import EasyDict\r\nimport tensorflow as tf\r\n\r\nfrom blueoil.common import Tasks\r\nfrom blueoil.networks.classification.lmnet_v1 import LmnetV1Quantize\r\nfrom blueoil.datasets.image_folder import ImageFolderBase\r\n\r\nfrom blueoil.data_processor import Sequence\r\nfrom blueoil.pre_processor import (\r\n    Resize,\r\n    DivideBy255,\r\n    PerImageStandardization\r\n)\r\nfrom blueoil.quantizations import (\r\n    binary_mean_scaling_quantizer,\r\n    linear_mid_tread_half_quantizer,\r\n)\r\n\r\nIS_DEBUG = False\r\n\r\nNETWORK_CLASS = LmnetV1Quantize\r\n\r\n# TODO(wakisaka): should be hidden. generate dataset class on the fly.\r\nDATASET_CLASS = type('DATASET_CLASS', (ImageFolderBase,), {'extend_dir': '/home/blueoil/cifar/train/', 'validation_extend_dir': '/home/blueoil/cifar/test/'})\r\n\r\nIMAGE_SIZE = [32, 32]\r\nBATCH_SIZE = 64\r\nDATA_FORMAT = \"NHWC\"\r\nTASK = Tasks.CLASSIFICATION\r\nCLASSES = ['airplane', 'automobile', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck']\r\n\r\nMAX_EPOCHS = 10\r\nSAVE_CHECKPOINT_STEPS = 1000\r\nKEEP_CHECKPOINT_MAX = 5\r\nTEST_STEPS = 1000\r\nSUMMARISE_STEPS = 100\r\n\r\n\r\n# pretrain\r\nIS_PRETRAIN = False\r\nPRETRAIN_VARS = []\r\nPRETRAIN_DIR = \"\"\r\nPRETRAIN_FILE = \"\"\r\n\r\nPRE_PROCESSOR = Sequence([\r\n    Resize(size=IMAGE_SIZE),\r\n    PerImageStandardization()\r\n])\r\nPOST_PROCESSOR = None\r\n\r\nNETWORK = EasyDict()\r\n\r\nNETWORK.OPTIMIZER_CLASS = tf.train.MomentumOptimizer\r\nNETWORK.OPTIMIZER_KWARGS = {'momentum': 0.9, 'learning_rate': 0.001}\r\nNETWORK.LEARNING_RATE_FUNC = None\r\nNETWORK.LEARNING_RATE_KWARGS = None\r\n\r\nNETWORK.IMAGE_SIZE = IMAGE_SIZE\r\nNETWORK.BATCH_SIZE = BATCH_SIZE\r\nNETWORK.DATA_FORMAT = DATA_FORMAT\r\nNETWORK.WEIGHT_DECAY_RATE = 0.0005\r\n\r\n# quantize\r\nNETWORK.ACTIVATION_QUANTIZER = linear_mid_tread_half_quantizer\r\nNETWORK.ACTIVATION_QUANTIZER_KWARGS = {\r\n    'bit': 2,\r\n    'max_value': 2\r\n}\r\nNETWORK.WEIGHT_QUANTIZER = binary_mean_scaling_quantizer\r\nNETWORK.WEIGHT_QUANTIZER_KWARGS = {}\r\n\r\n# dataset\r\nDATASET = EasyDict()\r\nDATASET.BATCH_SIZE = BATCH_SIZE\r\nDATASET.DATA_FORMAT = DATA_FORMAT\r\nDATASET.PRE_PROCESSOR = PRE_PROCESSOR\r\nDATASET.AUGMENTOR = Sequence([])\r\nDATASET.ENABLE_PREFETCH = True\r\n```\r\n\r\nThe probability of the problem was 19/100000.\r\nThere're several patterns of error.\r\nI show the 1 succeeded and 3 failed patterns below.\r\n\r\n```\r\n-------------------------------------------------------------\r\nComparison: Default network test  succeeded!!!\r\n-------------------------------------------------------------\r\nTotalInitTime 8094,  sum:8.094ms\r\nTotalRunTime 7283,  sum:7.283ms\r\n..Convolution 3750,72,  sum:3.822ms\r\n....kn2row 3656,  sum:3.656ms\r\n......kn2row-buf 6,  sum:0.006ms\r\n......matrix_multiplication 464,429,423,417,  sum:1.733ms\r\n........matrix_transpose (row_major) 26,25,21,18,  sum:0.09ms\r\n......matrix_shift_add_f 580,434,425,420,  sum:1.859ms\r\n....kn2row-1x1 63,  sum:0.063ms\r\n......matrix_multiplication 50,  sum:0.05ms\r\n..BatchNorm 367,17,  sum:0.384ms\r\n..QTZ_linear_mid_tread_half 220,  sum:0.22ms\r\n....pack_input 50,  sum:0.05ms\r\n..QuantizedConv2D 552,922,319,389,124,  sum:2.306ms\r\n....Convert Tensor 26,24,15,11,14,  sum:0.09ms\r\n....Sync UDMABuf Input 100,77,43,29,28,  sum:0.277ms\r\n....Conv2D TCA 337,768,215,300,42,  sum:1.662ms\r\n....Sync UDMABuf Output 58,31,23,26,20,  sum:0.158ms\r\n..Memcpy 76,24,18,17,  sum:0.135ms\r\n..ExtractImagePatches 69,13,13,  sum:0.095ms\r\n..QuantizedConv2D_ApplyScalingFactor 38,  sum:0.038ms\r\n..ReLu 18,  sum:0.018ms\r\n..Add 11,  sum:0.011ms\r\n..AveragePool 23,  sum:0.023ms\r\n..SoftMax 120,  sum:0.12ms\r\n```\r\n \r\n```\r\n-------------------------------------------------------------\r\nComparison: Default network test  failed...\r\nFailed count: 5\r\nFirst failed report\r\nindex: 2 / 10\r\ninput: 0.00456843, expected: 0.00425674\r\n\r\n-------------------------------------------------------------\r\nTotalInitTime 8027,  sum:8.027ms\r\nTotalRunTime 7512,  sum:7.512ms\r\n..Convolution 3978,72,  sum:4.05ms\r\n....kn2row 3877,  sum:3.877ms\r\n......kn2row-buf 6,  sum:0.006ms\r\n......matrix_multiplication 462,431,428,424,  sum:1.745ms\r\n........matrix_transpose (row_major) 24,27,26,24,  sum:0.101ms\r\n......matrix_shift_add_f 627,484,487,468,  sum:2.066ms\r\n....kn2row-1x1 63,  sum:0.063ms\r\n......matrix_multiplication 50,  sum:0.05ms\r\n..BatchNorm 354,17,  sum:0.371ms\r\n..QTZ_linear_mid_tread_half 233,  sum:0.233ms\r\n....pack_input 50,  sum:0.05ms\r\n..QuantizedConv2D 635,922,320,331,119,  sum:2.327ms\r\n....Convert Tensor 24,24,16,12,13,  sum:0.089ms\r\n....Sync UDMABuf Input 194,77,44,29,24,  sum:0.368ms\r\n....Conv2D TCA 331,768,215,254,41,  sum:1.609ms\r\n....Sync UDMABuf Output 58,31,23,18,20,  sum:0.15ms\r\n..Memcpy 67,24,18,12,  sum:0.121ms\r\n..ExtractImagePatches 69,13,12,  sum:0.094ms\r\n..QuantizedConv2D_ApplyScalingFactor 35,  sum:0.035ms\r\n..ReLu 17,  sum:0.017ms\r\n..Add 10,  sum:0.01ms\r\n..AveragePool 22,  sum:0.022ms\r\n..SoftMax 118,  sum:0.118ms\r\n```\r\n\r\n```\r\n-------------------------------------------------------------\r\nComparison: Default network test  failed...\r\nFailed count: 6\r\nFirst failed report\r\nindex: 1 / 10\r\ninput: 8.70602e-05, expected: 7.18778e-05\r\n\r\n-------------------------------------------------------------\r\nTotalInitTime 8064,  sum:8.064ms\r\nTotalRunTime 7685,  sum:7.685ms\r\n..Convolution 4225,71,  sum:4.296ms\r\n....kn2row 4124,  sum:4.124ms\r\n......kn2row-buf 6,  sum:0.006ms\r\n......matrix_multiplication 464,430,547,423,  sum:1.864ms\r\n........matrix_transpose (row_major) 25,26,21,20,  sum:0.092ms\r\n......matrix_shift_add_f 645,514,549,486,  sum:2.194ms\r\n....kn2row-1x1 62,  sum:0.062ms\r\n......matrix_multiplication 49,  sum:0.049ms\r\n..BatchNorm 382,17,  sum:0.399ms\r\n..QTZ_linear_mid_tread_half 230,  sum:0.23ms\r\n....pack_input 48,  sum:0.048ms\r\n..QuantizedConv2D 538,921,319,331,118,  sum:2.227ms\r\n....Convert Tensor 24,24,15,11,12,  sum:0.086ms\r\n....Sync UDMABuf Input 98,75,43,28,24,  sum:0.268ms\r\n....Conv2D TCA 330,769,215,254,41,  sum:1.609ms\r\n....Sync UDMABuf Output 57,31,24,18,19,  sum:0.149ms\r\n..Memcpy 73,25,18,12,  sum:0.128ms\r\n..ExtractImagePatches 67,14,12,  sum:0.093ms\r\n..QuantizedConv2D_ApplyScalingFactor 37,  sum:0.037ms\r\n..ReLu 17,  sum:0.017ms\r\n..Add 10,  sum:0.01ms\r\n..AveragePool 22,  sum:0.022ms\r\n..SoftMax 114,  sum:0.114ms\r\n```\r\n\r\n```\r\n-------------------------------------------------------------\r\nComparison: Default network test  failed...\r\nFailed count: 6\r\nFirst failed report\r\nindex: 0 / 10\r\ninput: 5.93729e-05, expected: 4.80257e-05\r\n\r\n-------------------------------------------------------------\r\nTotalInitTime 8064,  sum:8.064ms\r\nTotalRunTime 7506,  sum:7.506ms\r\n..Convolution 4082,72,  sum:4.154ms\r\n....kn2row 3983,  sum:3.983ms\r\n......kn2row-buf 6,  sum:0.006ms\r\n......matrix_multiplication 463,428,422,593,  sum:1.906ms\r\n........matrix_transpose (row_major) 25,24,19,19,  sum:0.087ms\r\n......matrix_shift_add_f 612,457,441,498,  sum:2.008ms\r\n....kn2row-1x1 63,  sum:0.063ms\r\n......matrix_multiplication 50,  sum:0.05ms\r\n..BatchNorm 384,17,  sum:0.401ms\r\n..QTZ_linear_mid_tread_half 233,  sum:0.233ms\r\n....pack_input 47,  sum:0.047ms\r\n..QuantizedConv2D 539,922,317,330,117,  sum:2.225ms\r\n....Convert Tensor 24,24,15,11,12,  sum:0.086ms\r\n....Sync UDMABuf Input 99,77,43,29,24,  sum:0.272ms\r\n....Conv2D TCA 330,768,215,254,41,  sum:1.608ms\r\n....Sync UDMABuf Output 58,31,23,17,19,  sum:0.148ms\r\n..Memcpy 70,24,18,12,  sum:0.124ms\r\n..ExtractImagePatches 67,13,12,  sum:0.092ms\r\n..QuantizedConv2D_ApplyScalingFactor 36,  sum:0.036ms\r\n..ReLu 17,  sum:0.017ms\r\n..Add 10,  sum:0.01ms\r\n..AveragePool 22,  sum:0.022ms\r\n..SoftMax 78,  sum:0.078ms\r\n```\r\n\r\nOf course these results should be same because I just repeated `lm_fpga.elf` with same condition.\r\n\r\nWhat is the problem ?","closed_by":{"login":"tk26eng","id":35796618,"node_id":"MDQ6VXNlcjM1Nzk2NjE4","avatar_url":"https://avatars.githubusercontent.com/u/35796618?v=4","gravatar_id":"","url":"https://api.github.com/users/tk26eng","html_url":"https://github.com/tk26eng","followers_url":"https://api.github.com/users/tk26eng/followers","following_url":"https://api.github.com/users/tk26eng/following{/other_user}","gists_url":"https://api.github.com/users/tk26eng/gists{/gist_id}","starred_url":"https://api.github.com/users/tk26eng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tk26eng/subscriptions","organizations_url":"https://api.github.com/users/tk26eng/orgs","repos_url":"https://api.github.com/users/tk26eng/repos","events_url":"https://api.github.com/users/tk26eng/events{/privacy}","received_events_url":"https://api.github.com/users/tk26eng/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/909/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blue-oil/blueoil/issues/909/timeline","performed_via_github_app":null,"state_reason":"completed"}