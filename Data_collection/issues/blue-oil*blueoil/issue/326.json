{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/326","repository_url":"https://api.github.com/repos/blue-oil/blueoil","labels_url":"https://api.github.com/repos/blue-oil/blueoil/issues/326/labels{/name}","comments_url":"https://api.github.com/repos/blue-oil/blueoil/issues/326/comments","events_url":"https://api.github.com/repos/blue-oil/blueoil/issues/326/events","html_url":"https://github.com/blue-oil/blueoil/issues/326","id":456753890,"node_id":"MDU6SXNzdWU0NTY3NTM4OTA=","number":326,"title":"Data Augmentation gives negative coordinates : data_augmentor.py/_flip_left_right_boundingbox","user":{"login":"ananno","id":3903030,"node_id":"MDQ6VXNlcjM5MDMwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3903030?v=4","gravatar_id":"","url":"https://api.github.com/users/ananno","html_url":"https://github.com/ananno","followers_url":"https://api.github.com/users/ananno/followers","following_url":"https://api.github.com/users/ananno/following{/other_user}","gists_url":"https://api.github.com/users/ananno/gists{/gist_id}","starred_url":"https://api.github.com/users/ananno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ananno/subscriptions","organizations_url":"https://api.github.com/users/ananno/orgs","repos_url":"https://api.github.com/users/ananno/repos","events_url":"https://api.github.com/users/ananno/events{/privacy}","received_events_url":"https://api.github.com/users/ananno/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-06-17T05:50:06Z","updated_at":"2020-11-02T02:31:22Z","closed_at":"2020-11-02T02:31:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The problem arises when I got certain error below during training using latest `blueoil` code with this (commit)[6ce940b481e91bff1ade4de0fc1b8359bb8b7202]\r\n\r\n<details>\r\n<summary>Full Error StackTrace</summary>\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1334, in _do_call\r\n    return fn(*args)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1319, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1407, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.UnknownError: IndexError: index -19 is out of bounds for axis 2 with size 10\r\nTraceback (most recent call last):\r\n\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/script_ops.py\", line 207, in __call__\r\n    ret = func(*args)\r\n\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 1313, in __calculate_truth_and_maskes\r\n    predict_box = predict_boxes[batch_index, cell_y_index, cell_x_index, best_anchor_index, :]\r\n\r\nIndexError: index -19 is out of bounds for axis 2 with size 10\r\n\r\n\r\n\t [[{{node loss/PyFunc_1}}]]\r\n\t [[{{node loss/PyFunc_1}}]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1758, in <module>\r\n    main()\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1752, in main\r\n    globals = debugger.run(setup['file'], None, None, is_module)\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1147, in run\r\n    pydev_imports.execfile(file, globals, locals)  # execute the script\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 416, in <module>\r\n    main()\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 697, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 412, in main\r\n    run(network, dataset, config_file, experiment_id, recreate)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 377, in run\r\n    start_training(config)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 259, in start_training\r\n    sess.run([train_op], feed_dict=feed_dict)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 929, in run\r\n    run_metadata_ptr)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1152, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1328, in _do_run\r\n    run_metadata)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1348, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.UnknownError: IndexError: index -19 is out of bounds for axis 2 with size 10\r\nTraceback (most recent call last):\r\n\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/script_ops.py\", line 207, in __call__\r\n    ret = func(*args)\r\n\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 1313, in __calculate_truth_and_maskes\r\n    predict_box = predict_boxes[batch_index, cell_y_index, cell_x_index, best_anchor_index, :]\r\n\r\nIndexError: index -19 is out of bounds for axis 2 with size 10\r\n\r\n\r\n\t [[node loss/PyFunc_1 (defined at /home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py:1390) ]]\r\n\t [[node loss/PyFunc_1 (defined at /home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py:1390) ]]\r\n\r\nCaused by op 'loss/PyFunc_1', defined at:\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1758, in <module>\r\n    main()\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1752, in main\r\n    globals = debugger.run(setup['file'], None, None, is_module)\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/pydevd.py\", line 1147, in run\r\n    pydev_imports.execfile(file, globals, locals)  # execute the script\r\n  File \"/home/hasibur/csp_phase1/.pycharm_helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 416, in <module>\r\n    main()\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 697, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 412, in main\r\n    run(network, dataset, config_file, experiment_id, recreate)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 377, in run\r\n    start_training(config)\r\n  File \"/home/hasibur/csp_phase1/lmnet/executor/train.py\", line 111, in start_training\r\n    loss = model.loss(output, labels_placeholder, is_training_placeholder)\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 662, in loss\r\n    return self.loss_function(predict_classes, predict_confidence, predict_boxes, gt_boxes, is_training)\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 1457, in __call__\r\n    predict_classes, predict_confidence)\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 1390, in _calculate_truth_and_maskes\r\n    [tf.float32, tf.float32, tf.int64, tf.int64]\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 324, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/script_ops.py\", line 468, in py_func\r\n    func=func, inp=inp, Tout=Tout, stateful=stateful, eager=False, name=name)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/script_ops.py\", line 282, in _internal_py_func\r\n    input=inp, token=token, Tout=Tout, name=name)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/gen_script_ops.py\", line 151, in py_func\r\n    \"PyFunc\", input=input, token=token, Tout=Tout, name=name)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 788, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 507, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3300, in create_op\r\n    op_def=op_def)\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1801, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nUnknownError (see above for traceback): IndexError: index -19 is out of bounds for axis 2 with size 10\r\nTraceback (most recent call last):\r\n\r\n  File \"/home/hasibur/env/csp_p36/lib/python3.6/site-packages/tensorflow/python/ops/script_ops.py\", line 207, in __call__\r\n    ret = func(*args)\r\n\r\n  File \"/home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py\", line 1313, in __calculate_truth_and_maskes\r\n    predict_box = predict_boxes[batch_index, cell_y_index, cell_x_index, best_anchor_index, :]\r\n\r\nIndexError: index -19 is out of bounds for axis 2 with size 10\r\n\r\n\r\n\t [[node loss/PyFunc_1 (defined at /home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py:1390) ]]\r\n\t [[node loss/PyFunc_1 (defined at /home/hasibur/csp_phase1/lmnet/lmnet/networks/object_detection/yolo_v2.py:1390) ]]\r\n```\r\n</details>\r\n\r\nI tried to pin point the error location and found to be :\r\n```\r\nlmnet/data_augmentor.py : _flip_left_right_boundingbox(...)\r\n```\r\n\r\nI've added few print statement at various places to find out the issue and I found this:\r\n> <strong>Note</strong> \r\n> Original Image Shape : [259, 194, 3]\r\n> Resized Image Shape : [320, 320, 3]\r\n* Before Flip\r\n```\r\n[[730 290  28  48   0]\r\n [ 36  39 180 147   0]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]\r\n [  0   0   0   0  -1]]\r\n```\r\n\r\n* After Flip\r\n```\r\n[[-499  290   28   48    0]\r\n [  43   39  180  147    0]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]\r\n [ 259    0    0    0   -1]]\r\n```\r\nClearly the values for the `x-axis` is wrong in the first bbox data.\r\n\r\nWhich ultimately gives me the error mentioned above. \r\n\r\nI've investigated a bit more. By adding some debug code I found out because of the negative co-ordinate causes the `index out of bound` error in  `predict_boxes` function call in `yolo_v2.py : __calculate_truth_and_maskes(...)` function as suggested in the stack trace abode.\r\n\r\nBy adding this piece of code:\r\n![Screenshot from 2019-06-17 15-03-20_0](https://user-images.githubusercontent.com/3903030/59581876-52bb7800-9111-11e9-96bc-b44033d99ada.png)\r\n\r\nI've god this:\r\n```\r\nbatch_index, cell_y_index, cell_x_index, best_anchor_index, center_x, center_y, image_size, num_cell_x, num_cell_y \r\n==\r\n0, 8, -19, 0, -599.0, 280.5, [320 320], 10, 10\r\n```\r\nClearly the cell_x_index is wrong (negative int).\r\n\r\n","closed_by":{"login":"ananno","id":3903030,"node_id":"MDQ6VXNlcjM5MDMwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3903030?v=4","gravatar_id":"","url":"https://api.github.com/users/ananno","html_url":"https://github.com/ananno","followers_url":"https://api.github.com/users/ananno/followers","following_url":"https://api.github.com/users/ananno/following{/other_user}","gists_url":"https://api.github.com/users/ananno/gists{/gist_id}","starred_url":"https://api.github.com/users/ananno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ananno/subscriptions","organizations_url":"https://api.github.com/users/ananno/orgs","repos_url":"https://api.github.com/users/ananno/repos","events_url":"https://api.github.com/users/ananno/events{/privacy}","received_events_url":"https://api.github.com/users/ananno/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/326/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blue-oil/blueoil/issues/326/timeline","performed_via_github_app":null,"state_reason":"completed"}