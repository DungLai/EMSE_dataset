{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227","repository_url":"https://api.github.com/repos/blue-oil/blueoil","labels_url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227/labels{/name}","comments_url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227/comments","events_url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227/events","html_url":"https://github.com/blue-oil/blueoil/issues/1227","id":726246375,"node_id":"MDU6SXNzdWU3MjYyNDYzNzU=","number":1227,"title":"Randomly resource not released after training sometimes","user":{"login":"joelN123","id":32167300,"node_id":"MDQ6VXNlcjMyMTY3MzAw","avatar_url":"https://avatars.githubusercontent.com/u/32167300?v=4","gravatar_id":"","url":"https://api.github.com/users/joelN123","html_url":"https://github.com/joelN123","followers_url":"https://api.github.com/users/joelN123/followers","following_url":"https://api.github.com/users/joelN123/following{/other_user}","gists_url":"https://api.github.com/users/joelN123/gists{/gist_id}","starred_url":"https://api.github.com/users/joelN123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joelN123/subscriptions","organizations_url":"https://api.github.com/users/joelN123/orgs","repos_url":"https://api.github.com/users/joelN123/repos","events_url":"https://api.github.com/users/joelN123/events{/privacy}","received_events_url":"https://api.github.com/users/joelN123/received_events","type":"User","site_admin":false},"labels":[{"id":1095590109,"node_id":"MDU6TGFiZWwxMDk1NTkwMTA5","url":"https://api.github.com/repos/blue-oil/blueoil/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-10-21T08:10:55Z","updated_at":"2020-10-21T08:11:22Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The usual, expected behaviour is that when the training has finished, all the resource (GPU) is freed up and the docker container doesn't run anymore. And this does happen in most cases.\r\n\r\nHowever, sometimes (randomly?) the resource is not freed up. I guess the frequency of unexpected behaviour is maybe 1 in 5. I'm not sure though. This is a potential problem for anyone using \"pay-as-you-go\" computing resource to train their model.\r\n\r\nA recent example is that I was running training on a modified [lm_resnet_quantize_cifar10.py](https://github.com/blue-oil/blueoil/blob/master/blueoil/configs/core/classification/lm_resnet_quantize_cifar10.py) config file for [ilsvrc_2012 dataset](https://github.com/blue-oil/blueoil/blob/master/blueoil/datasets/ilsvrc_2012.py), using the [dataset_iterator](https://github.com/blue-oil/blueoil/blob/master/blueoil/datasets/dataset_iterator.py) with multigpu and prefetch (I'm not sure if any of these things are relevant to the issue).\r\n\r\nAn example of the output of a training run that failed to free resource is:\r\n```\r\n[1,1]<stderr>:  warnings.warn(str(msg))\r\n[1,0]<stdout>:1600000/1600000 [==============================] - 122832s 77ms/steput>::::>:\r\n[1,3]<stdout>:break\r\n[1,2]<stdout>:break\r\n[1,1]<stdout>:break\r\n[1,3]<stdout>:Done\r\n[1,2]<stdout>:Done\r\n[1,2]<stdout>:Next step: blueoil convert -e my_model -p save.ckpt-1600000\r\n[1,3]<stdout>:Next step: blueoil convert -e my_model -p save.ckpt-1600000\r\n[1,1]<stdout>:Done\r\n[1,1]<stdout>:Next step: blueoil convert -e my_model -p save.ckpt-1600000\r\n```\r\n\r\nand an example of the output of a training run that did free resource successfully is:\r\n```\r\n[1,3]<stderr>:  warnings.warn(str(msg))\r\n[1,0]<stdout>:1599999/1600000 [============================>.] - ETA: 0s[1,2]<stdout>:break\r\n[1,0]<stdout>:1600000/1600000 [==============================] - 131360s 82ms/step\r\n[1,2]<stdout>:Done\r\n[1,0]<stdout>:break\r\n[1,2]<stdout>:Next step: blueoil convert -e another_model -p save.ckpt-1600000\r\n[1,0]<stdout>:Done\r\n[1,0]<stdout>:Next step: blueoil convert -e another_model -p save.ckpt-1600000\r\n[1,3]<stdout>:break\r\n[1,1]<stdout>:break\r\n[1,3]<stdout>:Done\r\n[1,1]<stdout>:Done\r\n[1,3]<stdout>:Next step: blueoil convert -e another_model -p save.ckpt-1600000\r\n[1,1]<stdout>:Next step: blueoil convert -e another_model -p save.ckpt-1600000\r\n```\r\n\r\nComparing between them, the first only has three `Done` printout, while the second has four. This line of code is at https://github.com/blue-oil/blueoil/blob/002f5408d11fd2a93457c5e7bc8dc876ace13ce0/blueoil/cmd/train.py#L283\r\nwhich is after the final progbar update. So it seems likely that the problem was that one of the DatasetIterators did not close.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blue-oil/blueoil/issues/1227/timeline","performed_via_github_app":null,"state_reason":null}