[{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/619589846","html_url":"https://github.com/voxelmorph/voxelmorph/issues/177#issuecomment-619589846","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/177","id":619589846,"node_id":"MDEyOklzc3VlQ29tbWVudDYxOTU4OTg0Ng==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2020-04-26T17:25:24Z","updated_at":"2020-04-26T17:25:43Z","author_association":"COLLABORATOR","body":"I think this is a matter of definition, we (as  a field) have gotten accustomed to defining the LNCC cross correlation function with the square in it (see Avants 2008 and the CC papers it cites), mostly because the focus was on having a robust measure for within-modality registration (but robust to noise, bias field, etc).  \r\n\r\nAlthough I have to think about this more carefully, I think the non-square version could still be cleanly and easily implemented with convolutions with slight modifications on our code, if you wanted, but I guess you should ask in which cases you would like to use that in?","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/619589846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"id":3273168924,"node_id":"MDEyOkxhYmVsZWRFdmVudDMyNzMxNjg5MjQ=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3273168924","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-04-26T17:25:30Z","label":{"name":"voxelmorph","color":"1d76db"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/619605062","html_url":"https://github.com/voxelmorph/voxelmorph/issues/177#issuecomment-619605062","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/177","id":619605062,"node_id":"MDEyOklzc3VlQ29tbWVudDYxOTYwNTA2Mg==","user":{"login":"vincentme","id":11166542,"node_id":"MDQ6VXNlcjExMTY2NTQy","avatar_url":"https://avatars.githubusercontent.com/u/11166542?v=4","gravatar_id":"","url":"https://api.github.com/users/vincentme","html_url":"https://github.com/vincentme","followers_url":"https://api.github.com/users/vincentme/followers","following_url":"https://api.github.com/users/vincentme/following{/other_user}","gists_url":"https://api.github.com/users/vincentme/gists{/gist_id}","starred_url":"https://api.github.com/users/vincentme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vincentme/subscriptions","organizations_url":"https://api.github.com/users/vincentme/orgs","repos_url":"https://api.github.com/users/vincentme/repos","events_url":"https://api.github.com/users/vincentme/events{/privacy}","received_events_url":"https://api.github.com/users/vincentme/received_events","type":"User","site_admin":false},"created_at":"2020-04-26T18:52:57Z","updated_at":"2020-04-26T18:52:57Z","author_association":"NONE","body":"Thank you. Yes, I just realize that the computation to calculate the non-square version is not more expensive than the squared one. \r\n\r\nI thought of one case that the non-square version is more appropriate: in the image with periodic structures/patterns, the squared cc could lead the deformation field of a windowed image pattern into the middle of two patterns that the calculated NCC is still 1. \r\n\r\nActually I don't see any disadvantage of using the non-squaared NCC. It does not introduce the ambiguity and the computation is similar. Right?","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/619605062/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"vincentme","id":11166542,"node_id":"MDQ6VXNlcjExMTY2NTQy","avatar_url":"https://avatars.githubusercontent.com/u/11166542?v=4","gravatar_id":"","url":"https://api.github.com/users/vincentme","html_url":"https://github.com/vincentme","followers_url":"https://api.github.com/users/vincentme/followers","following_url":"https://api.github.com/users/vincentme/following{/other_user}","gists_url":"https://api.github.com/users/vincentme/gists{/gist_id}","starred_url":"https://api.github.com/users/vincentme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vincentme/subscriptions","organizations_url":"https://api.github.com/users/vincentme/orgs","repos_url":"https://api.github.com/users/vincentme/repos","events_url":"https://api.github.com/users/vincentme/events{/privacy}","received_events_url":"https://api.github.com/users/vincentme/received_events","type":"User","site_admin":false}},{"actor":{"login":"vincentme","id":11166542,"node_id":"MDQ6VXNlcjExMTY2NTQy","avatar_url":"https://avatars.githubusercontent.com/u/11166542?v=4","gravatar_id":"","url":"https://api.github.com/users/vincentme","html_url":"https://github.com/vincentme","followers_url":"https://api.github.com/users/vincentme/followers","following_url":"https://api.github.com/users/vincentme/following{/other_user}","gists_url":"https://api.github.com/users/vincentme/gists{/gist_id}","starred_url":"https://api.github.com/users/vincentme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vincentme/subscriptions","organizations_url":"https://api.github.com/users/vincentme/orgs","repos_url":"https://api.github.com/users/vincentme/repos","events_url":"https://api.github.com/users/vincentme/events{/privacy}","received_events_url":"https://api.github.com/users/vincentme/received_events","type":"User","site_admin":false},"created_at":"2020-04-27T19:41:03Z","updated_at":"2020-04-27T19:41:03Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178","repository_url":"https://api.github.com/repos/voxelmorph/voxelmorph","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178/labels{/name}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178/comments","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178/events","html_url":"https://github.com/voxelmorph/voxelmorph/issues/178","id":607419147,"node_id":"MDU6SXNzdWU2MDc0MTkxNDc=","number":178,"title":"Matrix not invertible and -INF in NCC","user":{"login":"HansLeonardVanBrueggemann","id":445665,"node_id":"MDQ6VXNlcjQ0NTY2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/445665?v=4","gravatar_id":"","url":"https://api.github.com/users/HansLeonardVanBrueggemann","html_url":"https://github.com/HansLeonardVanBrueggemann","followers_url":"https://api.github.com/users/HansLeonardVanBrueggemann/followers","following_url":"https://api.github.com/users/HansLeonardVanBrueggemann/following{/other_user}","gists_url":"https://api.github.com/users/HansLeonardVanBrueggemann/gists{/gist_id}","starred_url":"https://api.github.com/users/HansLeonardVanBrueggemann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HansLeonardVanBrueggemann/subscriptions","organizations_url":"https://api.github.com/users/HansLeonardVanBrueggemann/orgs","repos_url":"https://api.github.com/users/HansLeonardVanBrueggemann/repos","events_url":"https://api.github.com/users/HansLeonardVanBrueggemann/events{/privacy}","received_events_url":"https://api.github.com/users/HansLeonardVanBrueggemann/received_events","type":"User","site_admin":false},"labels":[{"id":1347467145,"node_id":"MDU6TGFiZWwxMzQ3NDY3MTQ1","url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels/voxelmorph","name":"voxelmorph","color":"1d76db","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2020-04-27T10:12:07Z","updated_at":"2020-08-21T21:40:37Z","closed_at":"2020-08-21T21:40:37Z","author_association":"NONE","active_lock_reason":null,"repository":{"id":133389787,"node_id":"MDEwOlJlcG9zaXRvcnkxMzMzODk3ODc=","name":"voxelmorph","full_name":"voxelmorph/voxelmorph","private":false,"owner":{"login":"voxelmorph","id":38796681,"node_id":"MDQ6VXNlcjM4Nzk2Njgx","avatar_url":"https://avatars.githubusercontent.com/u/38796681?v=4","gravatar_id":"","url":"https://api.github.com/users/voxelmorph","html_url":"https://github.com/voxelmorph","followers_url":"https://api.github.com/users/voxelmorph/followers","following_url":"https://api.github.com/users/voxelmorph/following{/other_user}","gists_url":"https://api.github.com/users/voxelmorph/gists{/gist_id}","starred_url":"https://api.github.com/users/voxelmorph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/voxelmorph/subscriptions","organizations_url":"https://api.github.com/users/voxelmorph/orgs","repos_url":"https://api.github.com/users/voxelmorph/repos","events_url":"https://api.github.com/users/voxelmorph/events{/privacy}","received_events_url":"https://api.github.com/users/voxelmorph/received_events","type":"User","site_admin":false},"html_url":"https://github.com/voxelmorph/voxelmorph","description":"Unsupervised Learning for Image Registration","fork":false,"url":"https://api.github.com/repos/voxelmorph/voxelmorph","forks_url":"https://api.github.com/repos/voxelmorph/voxelmorph/forks","keys_url":"https://api.github.com/repos/voxelmorph/voxelmorph/keys{/key_id}","collaborators_url":"https://api.github.com/repos/voxelmorph/voxelmorph/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/voxelmorph/voxelmorph/teams","hooks_url":"https://api.github.com/repos/voxelmorph/voxelmorph/hooks","issue_events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events{/number}","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/events","assignees_url":"https://api.github.com/repos/voxelmorph/voxelmorph/assignees{/user}","branches_url":"https://api.github.com/repos/voxelmorph/voxelmorph/branches{/branch}","tags_url":"https://api.github.com/repos/voxelmorph/voxelmorph/tags","blobs_url":"https://api.github.com/repos/voxelmorph/voxelmorph/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/voxelmorph/voxelmorph/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/voxelmorph/voxelmorph/git/refs{/sha}","trees_url":"https://api.github.com/repos/voxelmorph/voxelmorph/git/trees{/sha}","statuses_url":"https://api.github.com/repos/voxelmorph/voxelmorph/statuses/{sha}","languages_url":"https://api.github.com/repos/voxelmorph/voxelmorph/languages","stargazers_url":"https://api.github.com/repos/voxelmorph/voxelmorph/stargazers","contributors_url":"https://api.github.com/repos/voxelmorph/voxelmorph/contributors","subscribers_url":"https://api.github.com/repos/voxelmorph/voxelmorph/subscribers","subscription_url":"https://api.github.com/repos/voxelmorph/voxelmorph/subscription","commits_url":"https://api.github.com/repos/voxelmorph/voxelmorph/commits{/sha}","git_commits_url":"https://api.github.com/repos/voxelmorph/voxelmorph/git/commits{/sha}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/comments{/number}","issue_comment_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments{/number}","contents_url":"https://api.github.com/repos/voxelmorph/voxelmorph/contents/{+path}","compare_url":"https://api.github.com/repos/voxelmorph/voxelmorph/compare/{base}...{head}","merges_url":"https://api.github.com/repos/voxelmorph/voxelmorph/merges","archive_url":"https://api.github.com/repos/voxelmorph/voxelmorph/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/voxelmorph/voxelmorph/downloads","issues_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues{/number}","pulls_url":"https://api.github.com/repos/voxelmorph/voxelmorph/pulls{/number}","milestones_url":"https://api.github.com/repos/voxelmorph/voxelmorph/milestones{/number}","notifications_url":"https://api.github.com/repos/voxelmorph/voxelmorph/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels{/name}","releases_url":"https://api.github.com/repos/voxelmorph/voxelmorph/releases{/id}","deployments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/deployments","created_at":"2018-05-14T16:19:41Z","updated_at":"2023-01-18T17:59:57Z","pushed_at":"2023-01-17T12:51:17Z","git_url":"git://github.com/voxelmorph/voxelmorph.git","ssh_url":"git@github.com:voxelmorph/voxelmorph.git","clone_url":"https://github.com/voxelmorph/voxelmorph.git","svn_url":"https://github.com/voxelmorph/voxelmorph","homepage":"","size":132194,"stargazers_count":1715,"watchers_count":1715,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":511,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":93,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["deep-learning","diffeomorphism","image-alignment","image-registration","machine-learning","optical-flow","probabilistic","unsupervised-learning"],"visibility":"public","forks":511,"open_issues":93,"watchers":1715,"default_branch":"dev","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Hi there, \r\n\r\nI'm experimenting with training the network. I tried the NCC loss function, with default hyperparams (window of 9, eps of 1e-5). \r\n\r\nRandomly during training, the loss goes to -inf, and the execution stops with InvalidInputArgument and saying that the matrix is not invertible. \r\n\r\nIt does happen randomly, so it is difficult for me to reproduce the code. I tried a couple of things, like checking the input data, just running train_on_batch with that specific batch where it fails, try to check the output after the error was thrown as so on. \r\n\r\nThe problem is that I cannot really figure out there in the code an inf is generated. \r\n`cc = cross * cross / (I_var * J_var + self.eps)`\r\nThere is a eps on the denominator of the loss function, so it cannot be a division by zero. It must be from the numerator, but then that has to be inf. Given that cross is computed via \r\n`cross = IJ_sum - u_J*I_sum - u_I*J_sum + u_I*u_J*win_size`\r\none of the term has to be inf. There is where I got stuck cuz, given that these terms are either convs activation maps or hyperparams, there is no way these can generate inf. \r\n\r\nAnyone with the same problem? any clue why?","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/178/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":3732997639,"node_id":"MDExOkNsb3NlZEV2ZW50MzczMjk5NzYzOQ==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3732997639","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-09-05T14:30:36Z","state_reason":null,"performed_via_github_app":null}]