[{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686811557","html_url":"https://github.com/voxelmorph/voxelmorph/issues/214#issuecomment-686811557","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/214","id":686811557,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgxMTU1Nw==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T23:17:42Z","updated_at":"2020-09-03T23:17:42Z","author_association":"COLLABORATOR","body":"Hi @neel-dey ,\r\n\r\nThanks! Very interesting, we hadn't noticed this. To be clear, what is the change other than the `trainable=False` for `cap` ? I'm not great at spotting the differences :)\r\n\r\nand yup, feel free to do a PR to `neurite` master! Thanks again.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686811557/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"id":3727156396,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyNzE1NjM5Ng==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727156396","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:17:42Z","performed_via_github_app":null},{"id":3727156398,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjcxNTYzOTg=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727156398","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:17:42Z","performed_via_github_app":null},{"id":3727158278,"node_id":"MDEyOkxhYmVsZWRFdmVudDM3MjcxNTgyNzg=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727158278","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:18:31Z","label":{"name":"neuron","color":"84cde0"},"performed_via_github_app":null},{"id":3727158281,"node_id":"MDEyOkxhYmVsZWRFdmVudDM3MjcxNTgyODE=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727158281","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:18:31Z","label":{"name":"voxelmorph","color":"1d76db"},"performed_via_github_app":null},{"id":3727161682,"node_id":"MDEzOkFzc2lnbmVkRXZlbnQzNzI3MTYxNjgy","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727161682","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:19:55Z","assignee":{"login":"ahoopes","id":24280487,"node_id":"MDQ6VXNlcjI0MjgwNDg3","avatar_url":"https://avatars.githubusercontent.com/u/24280487?v=4","gravatar_id":"","url":"https://api.github.com/users/ahoopes","html_url":"https://github.com/ahoopes","followers_url":"https://api.github.com/users/ahoopes/followers","following_url":"https://api.github.com/users/ahoopes/following{/other_user}","gists_url":"https://api.github.com/users/ahoopes/gists{/gist_id}","starred_url":"https://api.github.com/users/ahoopes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahoopes/subscriptions","organizations_url":"https://api.github.com/users/ahoopes/orgs","repos_url":"https://api.github.com/users/ahoopes/repos","events_url":"https://api.github.com/users/ahoopes/events{/privacy}","received_events_url":"https://api.github.com/users/ahoopes/received_events","type":"User","site_admin":false},"performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686815230","html_url":"https://github.com/voxelmorph/voxelmorph/issues/214#issuecomment-686815230","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/214","id":686815230,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgxNTIzMA==","user":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T23:30:24Z","updated_at":"2020-09-03T23:30:24Z","author_association":"CONTRIBUTOR","body":"Hi @adalca,\r\n\r\nAh yes, I should have highlighted the differences, my bad. \r\n\r\nIn addition to the change for `cap`, the updates for `self.mean` and `self.count` [in these lines](https://github.com/adalca/neurite/blob/legacy/neuron/layers.py#L1718-L1719) of `MeanStream.call()` have to change to:\r\n\r\n```python\r\nself.count.assign(new_count)\r\nself.mean.assign(new_mean)\r\n```\r\n\r\nI'll do the `neurite` PR either later tonight or sometime tomorrow. Thanks for the great atlas building framework!","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686815230/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false}},{"id":3727188068,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzcyNzE4ODA2OA==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727188068","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:30:24Z","performed_via_github_app":null},{"id":3727188072,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM3MjcxODgwNzI=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3727188072","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-09-03T23:30:24Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686817530","html_url":"https://github.com/voxelmorph/voxelmorph/issues/214#issuecomment-686817530","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/214","id":686817530,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgxNzUzMA==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T23:38:24Z","updated_at":"2020-09-03T23:38:24Z","author_association":"COLLABORATOR","body":"Interesting. Do you know what happened in 2.0+? Did `add_update` stop being used? I ask because we have other implementations (like the `CovStream` layer) that use the mechanism to update parameters.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686817530/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686829199","html_url":"https://github.com/voxelmorph/voxelmorph/issues/214#issuecomment-686829199","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/214","id":686829199,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjgyOTE5OQ==","user":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"created_at":"2020-09-04T00:20:54Z","updated_at":"2020-09-04T00:20:54Z","author_association":"CONTRIBUTOR","body":"I'm not too sure of what happened, unfortunately. Going off of [#13941 in `keras`](https://github.com/keras-team/keras/issues/13941) and the [docstring for `add_update`](https://github.com/tensorflow/tensorflow/blob/v2.3.0/tensorflow/python/keras/engine/base_layer.py#L1720) it appears that `add_update` expects an op (or a list of ops) and not a list of (before, after) tuples. When I ran the old keras voxelmorph code back in Feb, `self.mean` and `self.count` updated as expected, so this issue is TF2/tf.keras-specific.\r\n\r\nIn the context of `MeanStream`, I suppose you could also use `add_update(K.moving_average_update(...))` as in the linked `keras` issue, but there's already an application-specific mechanism for moving averages in the `neurite` layers so I went with the minimal explicit change by using `assign`.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/686829199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false}},{"actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"created_at":"2020-09-06T20:06:41Z","updated_at":"2020-09-06T20:06:41Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/adalca/neurite/issues/20","repository_url":"https://api.github.com/repos/adalca/neurite","labels_url":"https://api.github.com/repos/adalca/neurite/issues/20/labels{/name}","comments_url":"https://api.github.com/repos/adalca/neurite/issues/20/comments","events_url":"https://api.github.com/repos/adalca/neurite/issues/20/events","html_url":"https://github.com/adalca/neurite/pull/20","id":694510432,"node_id":"MDExOlB1bGxSZXF1ZXN0NDgwODc4MDg0","number":20,"title":"Fix MeanStream and CovStream","user":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"ahoopes","id":24280487,"node_id":"MDQ6VXNlcjI0MjgwNDg3","avatar_url":"https://avatars.githubusercontent.com/u/24280487?v=4","gravatar_id":"","url":"https://api.github.com/users/ahoopes","html_url":"https://github.com/ahoopes","followers_url":"https://api.github.com/users/ahoopes/followers","following_url":"https://api.github.com/users/ahoopes/following{/other_user}","gists_url":"https://api.github.com/users/ahoopes/gists{/gist_id}","starred_url":"https://api.github.com/users/ahoopes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahoopes/subscriptions","organizations_url":"https://api.github.com/users/ahoopes/orgs","repos_url":"https://api.github.com/users/ahoopes/repos","events_url":"https://api.github.com/users/ahoopes/events{/privacy}","received_events_url":"https://api.github.com/users/ahoopes/received_events","type":"User","site_admin":false},"assignees":[{"login":"ahoopes","id":24280487,"node_id":"MDQ6VXNlcjI0MjgwNDg3","avatar_url":"https://avatars.githubusercontent.com/u/24280487?v=4","gravatar_id":"","url":"https://api.github.com/users/ahoopes","html_url":"https://github.com/ahoopes","followers_url":"https://api.github.com/users/ahoopes/followers","following_url":"https://api.github.com/users/ahoopes/following{/other_user}","gists_url":"https://api.github.com/users/ahoopes/gists{/gist_id}","starred_url":"https://api.github.com/users/ahoopes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahoopes/subscriptions","organizations_url":"https://api.github.com/users/ahoopes/orgs","repos_url":"https://api.github.com/users/ahoopes/repos","events_url":"https://api.github.com/users/ahoopes/events{/privacy}","received_events_url":"https://api.github.com/users/ahoopes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-09-06T20:06:41Z","updated_at":"2020-09-12T04:17:15Z","closed_at":"2020-09-12T04:17:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"draft":false,"repository":{"id":84505424,"node_id":"MDEwOlJlcG9zaXRvcnk4NDUwNTQyNA==","name":"neurite","full_name":"adalca/neurite","private":false,"owner":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"html_url":"https://github.com/adalca/neurite","description":"Neural networks toolbox focused on medical image analysis","fork":false,"url":"https://api.github.com/repos/adalca/neurite","forks_url":"https://api.github.com/repos/adalca/neurite/forks","keys_url":"https://api.github.com/repos/adalca/neurite/keys{/key_id}","collaborators_url":"https://api.github.com/repos/adalca/neurite/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/adalca/neurite/teams","hooks_url":"https://api.github.com/repos/adalca/neurite/hooks","issue_events_url":"https://api.github.com/repos/adalca/neurite/issues/events{/number}","events_url":"https://api.github.com/repos/adalca/neurite/events","assignees_url":"https://api.github.com/repos/adalca/neurite/assignees{/user}","branches_url":"https://api.github.com/repos/adalca/neurite/branches{/branch}","tags_url":"https://api.github.com/repos/adalca/neurite/tags","blobs_url":"https://api.github.com/repos/adalca/neurite/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/adalca/neurite/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/adalca/neurite/git/refs{/sha}","trees_url":"https://api.github.com/repos/adalca/neurite/git/trees{/sha}","statuses_url":"https://api.github.com/repos/adalca/neurite/statuses/{sha}","languages_url":"https://api.github.com/repos/adalca/neurite/languages","stargazers_url":"https://api.github.com/repos/adalca/neurite/stargazers","contributors_url":"https://api.github.com/repos/adalca/neurite/contributors","subscribers_url":"https://api.github.com/repos/adalca/neurite/subscribers","subscription_url":"https://api.github.com/repos/adalca/neurite/subscription","commits_url":"https://api.github.com/repos/adalca/neurite/commits{/sha}","git_commits_url":"https://api.github.com/repos/adalca/neurite/git/commits{/sha}","comments_url":"https://api.github.com/repos/adalca/neurite/comments{/number}","issue_comment_url":"https://api.github.com/repos/adalca/neurite/issues/comments{/number}","contents_url":"https://api.github.com/repos/adalca/neurite/contents/{+path}","compare_url":"https://api.github.com/repos/adalca/neurite/compare/{base}...{head}","merges_url":"https://api.github.com/repos/adalca/neurite/merges","archive_url":"https://api.github.com/repos/adalca/neurite/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/adalca/neurite/downloads","issues_url":"https://api.github.com/repos/adalca/neurite/issues{/number}","pulls_url":"https://api.github.com/repos/adalca/neurite/pulls{/number}","milestones_url":"https://api.github.com/repos/adalca/neurite/milestones{/number}","notifications_url":"https://api.github.com/repos/adalca/neurite/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/adalca/neurite/labels{/name}","releases_url":"https://api.github.com/repos/adalca/neurite/releases{/id}","deployments_url":"https://api.github.com/repos/adalca/neurite/deployments","created_at":"2017-03-10T01:25:06Z","updated_at":"2022-12-20T04:39:27Z","pushed_at":"2022-12-16T05:52:22Z","git_url":"git://github.com/adalca/neurite.git","ssh_url":"git@github.com:adalca/neurite.git","clone_url":"https://github.com/adalca/neurite.git","svn_url":"https://github.com/adalca/neurite","homepage":"","size":751,"stargazers_count":268,"watchers_count":268,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":56,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":13,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["brain","convolutional-neural-networks","keras","medical-image-computing","medical-imaging","python","tensorflow"],"visibility":"public","forks":56,"open_issues":13,"watchers":268,"default_branch":"dev","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/adalca/neurite/pulls/20","html_url":"https://github.com/adalca/neurite/pull/20","diff_url":"https://github.com/adalca/neurite/pull/20.diff","patch_url":"https://github.com/adalca/neurite/pull/20.patch","merged_at":"2020-09-12T04:17:14Z"},"body":"Hi @adalca,\r\n\r\nHere are the fixes corresponding to [#214 in voxelmorph](https://github.com/voxelmorph/voxelmorph/issues/214). In the process, I noticed two extra bugs not mentioned in the original vxm issue:\r\n- `CovStream` has a broadcasting error due to a few lines out of order (stack pasted below).\r\n-  Both `MeanStream` and `CovStream` should have different behaviors in train/test mode. The original code would update `self.mean`, `self.count`, and `self.cov` every time the layer is called. I.e., instead of using frozen moving moments for test batches it would update them for every test batch. Fixed by explicitly checking for training status with the `_get_training_value()` function, and modifying `call` accordingly.\r\n\r\nStack for `CovStream` broadcasting error:\r\n\r\n```bash\r\nEpoch 1/2\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-6-d9fac15cce89> in <module>\r\n----> 1 net.fit(\r\n      2     [dummy_moving, dummy_fixed],\r\n      3     [dummy_fixed, zero_phi],\r\n      4     epochs=2,\r\n      5     batch_size=4,\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/keras/engine/training.py in _method_wrapper(self, *args, **kwargs)\r\n     64   def _method_wrapper(self, *args, **kwargs):\r\n     65     if not self._in_multi_worker_mode():  # pylint: disable=protected-access\r\n---> 66       return method(self, *args, **kwargs)\r\n     67 \r\n     68     # Running inside `run_distribute_coordinator` already.\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/keras/engine/training.py in fit(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_batch_size, validation_freq, max_queue_size, workers, use_multiprocessing)\r\n    846                 batch_size=batch_size):\r\n    847               callbacks.on_train_batch_begin(step)\r\n--> 848               tmp_logs = train_function(iterator)\r\n    849               # Catch OutOfRangeError for Datasets of unknown size.\r\n    850               # This blocks until the batch has finished executing.\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/def_function.py in __call__(self, *args, **kwds)\r\n    578         xla_context.Exit()\r\n    579     else:\r\n--> 580       result = self._call(*args, **kwds)\r\n    581 \r\n    582     if tracing_count == self._get_tracing_count():\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/def_function.py in _call(self, *args, **kwds)\r\n    625       # This is the first call of __call__, so we have to initialize.\r\n    626       initializers = []\r\n--> 627       self._initialize(args, kwds, add_initializers_to=initializers)\r\n    628     finally:\r\n    629       # At this point we know that the initialization is complete (or less\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/def_function.py in _initialize(self, args, kwds, add_initializers_to)\r\n    503     self._graph_deleter = FunctionDeleter(self._lifted_initializer_graph)\r\n    504     self._concrete_stateful_fn = (\r\n--> 505         self._stateful_fn._get_concrete_function_internal_garbage_collected(  # pylint: disable=protected-access\r\n    506             *args, **kwds))\r\n    507 \r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/function.py in _get_concrete_function_internal_garbage_collected(self, *args, **kwargs)\r\n   2444       args, kwargs = None, None\r\n   2445     with self._lock:\r\n-> 2446       graph_function, _, _ = self._maybe_define_function(args, kwargs)\r\n   2447     return graph_function\r\n   2448 \r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/function.py in _maybe_define_function(self, args, kwargs)\r\n   2775 \r\n   2776       self._function_cache.missed.add(call_context_key)\r\n-> 2777       graph_function = self._create_graph_function(args, kwargs)\r\n   2778       self._function_cache.primary[cache_key] = graph_function\r\n   2779       return graph_function, args, kwargs\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/function.py in _create_graph_function(self, args, kwargs, override_flat_arg_shapes)\r\n   2655     arg_names = base_arg_names + missing_arg_names\r\n   2656     graph_function = ConcreteFunction(\r\n-> 2657         func_graph_module.func_graph_from_py_func(\r\n   2658             self._name,\r\n   2659             self._python_function,\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/func_graph.py in func_graph_from_py_func(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes)\r\n    979         _, original_func = tf_decorator.unwrap(python_func)\r\n    980 \r\n--> 981       func_outputs = python_func(*func_args, **func_kwargs)\r\n    982 \r\n    983       # invariant: `func_outputs` contains only Tensors, CompositeTensors,\r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/eager/def_function.py in wrapped_fn(*args, **kwds)\r\n    439         # __wrapped__ allows AutoGraph to swap in a converted function. We give\r\n    440         # the function a weak reference to itself to avoid a reference cycle.\r\n--> 441         return weak_wrapped_fn().__wrapped__(*args, **kwds)\r\n    442     weak_wrapped_fn = weakref.ref(wrapped_fn)\r\n    443 \r\n\r\n~/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/func_graph.py in wrapper(*args, **kwargs)\r\n    966           except Exception as e:  # pylint:disable=broad-except\r\n    967             if hasattr(e, \"ag_error_metadata\"):\r\n--> 968               raise e.ag_error_metadata.to_exception(e)\r\n    969             else:\r\n    970               raise\r\n\r\nValueError: in user code:\r\n\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/keras/engine/training.py:571 train_function  *\r\n        outputs = self.distribute_strategy.run(\r\n    ./ext/neurite-master/neurite/tf/layers.py:1711 call  *\r\n        new_mean, new_count = _mean_update(self.mean, self.count, x, self.cap)\r\n    ./ext/neurite-master/neurite/tf/layers.py:1823 _mean_update  *\r\n        new_mean = pre_mean * (1-alpha) + (this_sum/this_bs) * alpha\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/ops/math_ops.py:984 binary_op_wrapper\r\n        return func(x, y, name=name)\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/ops/math_ops.py:1276 _add_dispatch\r\n        return gen_math_ops.add_v2(x, y, name=name)\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/ops/gen_math_ops.py:482 add_v2\r\n        _, _, _op, _outputs = _op_def_library._apply_op_helper(\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/op_def_library.py:742 _apply_op_helper\r\n        op = g._create_op_internal(op_type_name, inputs, dtypes=None,\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/func_graph.py:593 _create_op_internal\r\n        return super(FuncGraph, self)._create_op_internal(  # pylint: disable=protected-access\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/ops.py:3319 _create_op_internal\r\n        ret = Operation(\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/ops.py:1816 __init__\r\n        self._c_op = _create_c_op(self._graph, node_def, inputs,\r\n    /home/ubuntu/anaconda3/envs/tf2/lib/python3.8/site-packages/tensorflow/python/framework/ops.py:1657 _create_c_op\r\n        raise ValueError(str(e))\r\n\r\n    ValueError: Dimensions must be equal, but are 2 and 128 for '{{node model/cov_stream/add_1}} = AddV2[T=DT_FLOAT](model/cov_stream/mul, model/cov_stream/mul_1)' with input shapes: [8,8,2], [128].\r\n```\r\n\r\nLet me know if you would like any changes. :)","reactions":{"url":"https://api.github.com/repos/adalca/neurite/issues/20/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/adalca/neurite/issues/20/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/687891821","html_url":"https://github.com/voxelmorph/voxelmorph/issues/214#issuecomment-687891821","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/214","id":687891821,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Nzg5MTgyMQ==","user":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"created_at":"2020-09-06T20:23:37Z","updated_at":"2020-09-06T20:23:37Z","author_association":"CONTRIBUTOR","body":"Closing as addressed by [adalca/neurite#20](https://github.com/adalca/neurite/pull/20). Two additional fixes for `MeanStream` and `CovStream` are made there.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/687891821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false}},{"id":3734461533,"node_id":"MDExOkNsb3NlZEV2ZW50MzczNDQ2MTUzMw==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3734461533","actor":{"login":"neel-dey","id":46202852,"node_id":"MDQ6VXNlcjQ2MjAyODUy","avatar_url":"https://avatars.githubusercontent.com/u/46202852?v=4","gravatar_id":"","url":"https://api.github.com/users/neel-dey","html_url":"https://github.com/neel-dey","followers_url":"https://api.github.com/users/neel-dey/followers","following_url":"https://api.github.com/users/neel-dey/following{/other_user}","gists_url":"https://api.github.com/users/neel-dey/gists{/gist_id}","starred_url":"https://api.github.com/users/neel-dey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neel-dey/subscriptions","organizations_url":"https://api.github.com/users/neel-dey/orgs","repos_url":"https://api.github.com/users/neel-dey/repos","events_url":"https://api.github.com/users/neel-dey/events{/privacy}","received_events_url":"https://api.github.com/users/neel-dey/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-09-06T20:23:37Z","state_reason":null,"performed_via_github_app":null}]