[{"id":4772743027,"node_id":"MDEyOkxhYmVsZWRFdmVudDQ3NzI3NDMwMjc=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/4772743027","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-05-20T11:52:14Z","label":{"name":"voxelmorph","color":"1d76db"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845025424","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-845025424","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":845025424,"node_id":"MDEyOklzc3VlQ29tbWVudDg0NTAyNTQyNA==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-20T11:52:22Z","updated_at":"2021-05-20T11:52:33Z","author_association":"COLLABORATOR","body":"Hi Hamidreza, \r\n\r\nYou can use the `tf.map_fn` for this. You can see how we do it [here](https://github.com/adalca/neurite/blob/f0695a1a43f636a130e1b9fb4b22631489eaeab2/neuron/layers.py#L341). Essentially map_fn will run some function on every row of your matrix and re-gather the results!","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845025424/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845478662","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-845478662","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":845478662,"node_id":"MDEyOklzc3VlQ29tbWVudDg0NTQ3ODY2Mg==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-20T21:09:24Z","updated_at":"2021-05-20T21:09:24Z","author_association":"NONE","body":"Hi Adrian,\r\n\r\nVery nice! Thank you for your timely response. Fortunately, the previous problem was resolved, yet there is another error! Nevertheless, I think and hope it will be the last error:\r\n\r\nMy affine Model has 2 inputs and 2 outputs as following:\r\n\r\n```\r\ninputs = [moving_input_tensor, fixed_input_tensor]\r\noutputs = [moved_image_tensor, affine]\r\n```\r\n\r\nwhere the affine is in (?,6) produced by the Sequential network. I used the following to convert the affine parameters to its corresponding Displacement Field:\r\n\r\n```\r\nfun = lambda x: neuron.utils.affine_to_shift(x, vol_shape, shift_center=True)\r\naffinefield = tf.map_fn(fun, affine, dtype=tf.float32)\r\n```\r\nInstead of the `affine`, I pass the `affinefield` to the `SpatialTransfoemer()` layer to produce the `moved_image_tensor` that is one of our Model's outputs i.e.\r\n\r\n`moved_image_tensor = neuron.layers.SpatialTransformer()([moving_input_tensor, affinefield])`\r\n\r\nUnfortunately, we constantly get the following error:\r\n\r\n```\r\nAffine Transformation Shape: Tensor(\"sequential_1/dense_1/BiasAdd:0\", shape=(?, 6), dtype=float32)\r\nAffinefield Transformation Shape: Tensor(\"map/TensorArrayStack/TensorArrayGatherV3:0\", shape=(?, 256, 256, 2), dtype=float32)\r\nTraceback (most recent call last):\r\n  File \"D:/Python/Reg/my_CT-MRI_AffineV2.py\", line 118, in <module>\r\n    final_model = keras.models.Model(inputs, outputs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\legacy\\interfaces.py\", line 91, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 93, in __init__\r\n    self._init_graph_network(*args, **kwargs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 231, in _init_graph_network\r\n    self.inputs, self.outputs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 1366, in _map_graph_network\r\n    tensor_index=tensor_index)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 1353, in build_map\r\n    node_index, tensor_index)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 1325, in build_map\r\n    node = layer._inbound_nodes[node_index]\r\nAttributeError: 'NoneType' object has no attribute '_inbound_nodes'\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\nAnd, if we change the Model output to the `outputs = [moved_image_tensor, affinefield]`, we constantly get the following error:\r\n\r\n```\r\nAffine Transformation Shape: Tensor(\"sequential_1/dense_1/BiasAdd:0\", shape=(?, 6), dtype=float32)\r\nAffinefield Transformation Shape: Tensor(\"map/TensorArrayStack/TensorArrayGatherV3:0\", shape=(?, 256, 256, 2), dtype=float32)\r\nTraceback (most recent call last):\r\n  File \"D:/Python/Reg/my_CT-MRI_AffineV2.py\", line 118, in <module>\r\n    final_model = keras.models.Model(inputs, outputs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\legacy\\interfaces.py\", line 91, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 93, in __init__\r\n    self._init_graph_network(*args, **kwargs)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\network.py\", line 188, in _init_graph_network\r\n    'Found: ' + str(x))\r\nValueError: Output tensors to a Model must be the output of a Keras `Layer` (thus holding past layer metadata). Found: Tensor(\"map/TensorArrayStack/TensorArrayGatherV3:0\", shape=(?, 256, 256, 2), dtype=float32)\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\nActually, I have no idea if these errors are related to the implementation of `affine_to_shift()` function or not. It is very appreciated if you could help to resolve the error. If it can be resolved, my novelty in affine voxelmorph can be fully implemented, so your help is very appreciated. \r\n\r\nRegards,","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845478662/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845560882","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-845560882","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":845560882,"node_id":"MDEyOklzc3VlQ29tbWVudDg0NTU2MDg4Mg==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-21T00:06:49Z","updated_at":"2021-05-21T00:06:49Z","author_association":"COLLABORATOR","body":"are these lines in a layer? \r\n```\r\nfun = lambda x: neuron.utils.affine_to_shift(x, vol_shape, shift_center=True)\r\naffinefield = tf.map_fn(fun, affine, dtype=tf.float32)\r\n```\r\nThey need to be in a layers, either a Lambda or a short Keras layer. I think the errors might have something to do with this.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/845560882/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/846459999","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-846459999","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":846459999,"node_id":"MDEyOklzc3VlQ29tbWVudDg0NjQ1OTk5OQ==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-22T20:31:39Z","updated_at":"2021-05-22T20:33:23Z","author_association":"NONE","body":"Thank you for your information, and please forgive me for such simple problems. I packed the code to a Keras Layer sub-class named `affine2_field()`, and it works, but we faced another error this time from the `SpatialTransformer()` class. The below is the error, and I also printed the tensor shapes to help making any conclusions:\r\n\r\n```\r\nAffine Transformation Shape: Tensor(\"sequential_1/dense_1/BiasAdd:0\", shape=(?, 6), dtype=float32)\r\nfieldAff Transformation Shape: Tensor(\"affine2_field_1/map/TensorArrayStack/TensorArrayGatherV3:0\", shape=(?, 256, 256, 2), dtype=float32)\r\nmoving_input_tensor Transformation Shape: Tensor(\"input_1:0\", shape=(?, 256, 256, 1), dtype=float32)\r\n\r\nnb_dims: 1\r\nvol.shape: (256, 256, 1)\r\n\r\nTraceback (most recent call last):\r\n  File \"D:/Python/Reg/my_CT-MRI_AffineV2.py\", line 116, in <module>\r\n    moved_image_tensor = neuron.layers.SpatialTransformer()([moving_input_tensor, fieldAff])\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\keras\\engine\\base_layer.py\", line 457, in __call__\r\n    output = self.call(inputs, **kwargs)\r\n  File \"D:\\Python\\Reg\\voxelmorph-lib\\voxelmorph\\ext\\neuron-lib\\neuron\\layers.py\", line 154, in call\r\n    return tf.map_fn(self._single_transform, [vol, trf], dtype=tf.float32)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\functional_ops.py\", line 494, in map_fn\r\n    maximum_iterations=n)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\control_flow_ops.py\", line 3291, in while_loop\r\n    return_same_structure)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\control_flow_ops.py\", line 3004, in BuildLoop\r\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\control_flow_ops.py\", line 2939, in _BuildLoop\r\n    body_result = body(*packed_vars_for_body)\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\control_flow_ops.py\", line 3260, in <lambda>\r\n    body = lambda i, lv: (i + 1, orig_body(*lv))\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\tensorflow\\python\\ops\\functional_ops.py\", line 483, in compute\r\n    packed_fn_values = fn(packed_values)\r\n  File \"D:\\Python\\Reg\\voxelmorph-lib\\voxelmorph\\ext\\neuron-lib\\neuron\\layers.py\", line 165, in _single_transform\r\n    return transform(inputs[0], inputs[1], interp_method=self.interp_method)\r\n  File \"D:\\Python\\Reg\\voxelmorph-lib\\voxelmorph\\ext\\neuron-lib\\neuron\\utils.py\", line 333, in transform\r\n    return interpn(vol, loc, interp_method=interp_method)\r\n  File \"D:\\Python\\Reg\\voxelmorph-lib\\voxelmorph\\ext\\neuron-lib\\neuron\\utils.py\", line 107, in interpn\r\n    % (nb_dims, len(vol.shape[:-1])))\r\nException: Number of loc Tensors 1 does not match volume dimension 2\r\n```\r\n\r\nThe source of error is in the utilization of SpatialTransformr class:\r\n\r\n`moved_image_tensor = neuron.layers.SpatialTransformer()([moving_input_tensor, fieldAff])`\r\n\r\nwhere `moving_input_tensor` is in the shape of (?, 256, 256, 1) and `fieldAff` is in the shape of (?, 256, 256, 2). Everything looks OK, and I cannot find why `nb_dims` equals 1 while `vol.shape` is (256, 256, 1).\r\n\r\nYour help is so appreciated.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/846459999/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/846476131","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-846476131","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":846476131,"node_id":"MDEyOklzc3VlQ29tbWVudDg0NjQ3NjEzMQ==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-22T23:31:41Z","updated_at":"2021-05-22T23:31:41Z","author_association":"COLLABORATOR","body":"hmm, I am not sure either. It seems like nb_dims is being set to 1. Depending on the version you have, this is likely taken from loc.shape[-1], so somehow `fieldAff` has shape 1 by the time it gets to interpn.\r\n\r\nI would recommend you print the shape of the vol and loc in `interpn`, `transform`, and `_single_trasnform` and see where it breaks?  That would be my first step -- I haven't worked with this code in a long time (we switched all the code to tf 2 quite some time ago).","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/846476131/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/847971524","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-847971524","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":847971524,"node_id":"MDEyOklzc3VlQ29tbWVudDg0Nzk3MTUyNA==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-25T15:29:22Z","updated_at":"2021-05-25T15:29:22Z","author_association":"NONE","body":"Thank you for the clue given to me.\r\n\r\n I sequentially printed the `nb_dims`, `vol`, and `loc` in the aforementioned functions:\r\n\r\nFirst of all, we have `_single_trasnform()` that is a 1-line function:\r\n\r\n ```\r\ndef _single_transform(self, inputs):\r\n        return transform(inputs[0], inputs[1], interp_method=self.interp_method)  \r\n```\r\n\r\nThe shapes of `inputs[0]` and `inputs[1]` are `_single_transform: (256, 256, 1) (256, 2) `, respectively. Therefore, I think the shape of transformation that is (?, 256, 256, 2) is manipulated in the first lines of codes in `SpatialTransformer` class. \r\n\r\nFor your information, the modified shape is conveyed to the `interpn()` and `transform()` so that the error is eventuated.\r\n\r\ninterpn():\r\n\r\n```\r\nnb_dims: 1\r\nvol.shape: (256, 256, 1)\r\nloc.shape: [<tf.Tensor 'spatial_transformer_1/map/while/add_1:0' shape=(256,) dtype=float32>]\r\n```\r\ntransform():\r\n\r\n```\r\nnb_dims: 1\r\nvol.shape: (256, 256, 1)\r\nloc.shape: (256, 1)\r\n```\r\n\r\nYour help is highly appreciated.\r\n","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/847971524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/847982187","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-847982187","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":847982187,"node_id":"MDEyOklzc3VlQ29tbWVudDg0Nzk4MjE4Nw==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-25T15:42:57Z","updated_at":"2021-05-25T15:42:57Z","author_association":"COLLABORATOR","body":"`inputs[1]` should definitely not be (256, 2),it should be (256, 256, 2) so this is the problem. In my opinion you should track this up the stack and see where the problem is.\r\n\r\nFor example, before `if self.single_transform:` it would be useful to print the shape of `vol`, `trf`, and value of `self.single_transform`","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/847982187/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/848094835","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-848094835","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":848094835,"node_id":"MDEyOklzc3VlQ29tbWVudDg0ODA5NDgzNQ==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-25T18:03:00Z","updated_at":"2021-05-25T18:03:00Z","author_association":"NONE","body":"Yes, I am confused about that! why this is (256, 2) while the transformation inputted to the `SpatialTransformer` is in the shape of (?, 256, 256, 2) ?\r\n\r\nI printed the aforementioned items before the line `if self.single_transform: `and here is the results:\r\n\r\n```\r\nBefore if: vol: (?, 256, 256, 1)\r\nBefore if: trf: Tensor(\"spatial_transformer_1/Reshape_1:0\", shape=(?, 256, 2), dtype=float32)\r\nBefore if: self.single_transform: False\r\n```\r\n\r\nThis version of the Neuron package works OK for my affine network. In the deformable version of the Voxelmorph you add a `Conv2D `layer in the shape of (?, 256, 256, 1) before passing the registration field to the `SpatialTransformer` layer while I don't use such, and feed the output of my customized layer with the function `neuron.utils.affine_to_shift()` directly to the `SpatialTransformer`. May it be the source of the problem?","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/848094835/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/848189827","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-848189827","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":848189827,"node_id":"MDEyOklzc3VlQ29tbWVudDg0ODE4OTgyNw==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-25T19:10:09Z","updated_at":"2021-05-25T19:10:09Z","author_association":"COLLABORATOR","body":"I would look at the shape of the inputs right inside the `def call(self, inputs)` function. You might be passing in the wrong inputs or something like that?","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/848189827/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/849415905","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-849415905","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":849415905,"node_id":"MDEyOklzc3VlQ29tbWVudDg0OTQxNTkwNQ==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-27T07:47:02Z","updated_at":"2021-05-27T07:47:02Z","author_association":"NONE","body":"Fortunately, I found the source of the error. The problematic lines of code were the followings:\r\n\r\n```\r\n# necessary for multi_gpu models...\r\nvol = K.reshape(vol, [-1, *self.inshape[0][1:]])\r\ntrf = K.reshape(trf, [-1, *self.inshape[1][1:]])\r\n```\r\nBefore these lines, the `vol` and `trf` are in their correct shapes i.e. (?, 256, 256, 1) and (?, 256, 256, 2), respectively. But, after the code, the `trf` is reshaped to the incorrect shape of (?, 256, 2)\r\n\r\nI deactivated these two lines and the Model went for fitting without any error. Please let me know if the lines should be replaced by the correct ones.\r\n","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/849415905/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/849525263","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-849525263","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":849525263,"node_id":"MDEyOklzc3VlQ29tbWVudDg0OTUyNTI2Mw==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-27T10:35:08Z","updated_at":"2021-05-27T10:35:08Z","author_association":"COLLABORATOR","body":"hmm, those lines are only necessary for multi-gpu calls in early tf, so you can safely take them out. They shouldn't cause a reshaping issue, and we've never run into this so it's a tad weird. The only thing I could imaging is if tf can't figure out the tensor shape of `fieldAff`, but it's unclear why that would be. Anyway glad you solved it.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/849525263/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/850410640","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-850410640","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":850410640,"node_id":"MDEyOklzc3VlQ29tbWVudDg1MDQxMDY0MA==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-05-28T13:14:24Z","updated_at":"2021-05-28T13:14:24Z","author_association":"NONE","body":"Thank you for your follow-up. Your help is so appreciated. \r\n\r\nHerewith, I could convert the affine parameters produced by the network to a field so that different regularization terms can be applied. Our first system has no regularization module since we could not apply any to the affine transformation parameters in the shape of (6,). Accordingly, the system produced abnormal transformations while we extended the no. of layers, or modified some hyperparameters.\r\n\r\n![image](https://user-images.githubusercontent.com/52887476/119987941-d0b17a80-bfda-11eb-8ee0-3d4647d6ff41.png)\r\n\r\nAfter converting the affine parameters from (6,) to a field (256, 256, 2), with a simple l2.norm regularization term on the field, the problem was resolved. \r\n\r\nActually, I am not expert in the regularization of the displacement field (only accustomed to l1 and l2 norms). I will be pleased to have your idea about the fitness and properness of l2.norm for affine registration. Also, if there is any good reference to review and evaluate the regularization terms applied in the deep learning-based registration, please let me know. Thank you again.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/850410640/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/850820716","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-850820716","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":850820716,"node_id":"MDEyOklzc3VlQ29tbWVudDg1MDgyMDcxNg==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-05-29T11:56:35Z","updated_at":"2021-05-29T11:57:21Z","author_association":"COLLABORATOR","body":"spatial gradient regularization on Affine is probably not that meaningful -- it would encourage neighboring voxels to have similar deformations, but of course you get very regular deformations in affine by definition. Regularization would encourage smaller deformations (smaller rotations, etc) but I'm not sure that's meaningful. \r\n\r\nAffine registration is a tougher machine learning task than deformable, because there's a lot less output data. So I'd worry more about the training vs validation performance for you, have you looked at that? In our experience with affine, you need to carefully design the network to avoid overfitting.\r\n\r\nI'm closing this issue as the `affine_to_shift` question has been answered, though if you ask any other questions on this thread ill try to get to it.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/850820716/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"id":4815962125,"node_id":"MDExOkNsb3NlZEV2ZW50NDgxNTk2MjEyNQ==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/4815962125","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2021-05-29T11:56:43Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/855396687","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-855396687","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":855396687,"node_id":"MDEyOklzc3VlQ29tbWVudDg1NTM5NjY4Nw==","user":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false},"created_at":"2021-06-06T13:08:27Z","updated_at":"2021-06-06T13:08:27Z","author_association":"NONE","body":"Thank you for your help. The system is working OK, and the results are sensibly better even with simple regularization terms like l2 norm.\r\n\r\nTo write the novelty up, please let me know if you have made any theoretical study on the differentiability of such a layer, and how we can prove this affine-to-field layer is differentiable.  ","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/855396687/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"boveiri","id":52887476,"node_id":"MDQ6VXNlcjUyODg3NDc2","avatar_url":"https://avatars.githubusercontent.com/u/52887476?v=4","gravatar_id":"","url":"https://api.github.com/users/boveiri","html_url":"https://github.com/boveiri","followers_url":"https://api.github.com/users/boveiri/followers","following_url":"https://api.github.com/users/boveiri/following{/other_user}","gists_url":"https://api.github.com/users/boveiri/gists{/gist_id}","starred_url":"https://api.github.com/users/boveiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boveiri/subscriptions","organizations_url":"https://api.github.com/users/boveiri/orgs","repos_url":"https://api.github.com/users/boveiri/repos","events_url":"https://api.github.com/users/boveiri/events{/privacy}","received_events_url":"https://api.github.com/users/boveiri/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/855404618","html_url":"https://github.com/voxelmorph/voxelmorph/issues/312#issuecomment-855404618","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/312","id":855404618,"node_id":"MDEyOklzc3VlQ29tbWVudDg1NTQwNDYxOA==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-06-06T14:02:55Z","updated_at":"2021-06-06T14:02:55Z","author_association":"COLLABORATOR","body":"The layer is just a multiplication of a [meshgrid](https://numpy.org/doc/stable/reference/generated/numpy.meshgrid.html) of coordinates with the affine matrix. So it's differentiable by construction. It's doing `T(x) = Ax` for all possible `x` values.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/855404618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}}]