[{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/611556171","html_url":"https://github.com/voxelmorph/voxelmorph/issues/169#issuecomment-611556171","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/169","id":611556171,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTU1NjE3MQ==","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T14:24:04Z","updated_at":"2020-04-09T14:24:04Z","author_association":"COLLABORATOR","body":"For your first part, so that I understand where to begin, did you read our description in the TMI paper (https://arxiv.org/abs/1809.05231)? The semi-supervised method is a big part of that paper. In this initial version, we did not use any of the non-labelled images, our point was more about how to use the labelled ones in training. The Figure in that paper should shed light on how the model works.\r\n\r\nTo combine labelled and unlabelled we have information here: https://arxiv.org/abs/1908.04466 . In terms of implementation, the simplest thing to do is to use the same implementation as the TMI paper, and just feed in a 'background' segmentation (e.g. segmentation map where everything is background for both images) for those, and I think this will work as you'll get no useful gradient from the segmentation loss for those images, which is what you want. Alternatively you can have a fancier implementation that turns off the segmentation weight for the unlabelled images, but I think that's unnecessary.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/611556171/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"id":3218531173,"node_id":"MDEyOkxhYmVsZWRFdmVudDMyMTg1MzExNzM=","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3218531173","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-04-09T14:24:09Z","label":{"name":"voxelmorph","color":"1d76db"},"performed_via_github_app":null},{"id":3218532581,"node_id":"MDExOkNsb3NlZEV2ZW50MzIxODUzMjU4MQ==","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/3218532581","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2020-04-09T14:24:29Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/923947820","html_url":"https://github.com/voxelmorph/voxelmorph/issues/169#issuecomment-923947820","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/169","id":923947820,"node_id":"IC_kwDOB_Nd2843ElMs","user":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false},"created_at":"2021-09-21T12:40:40Z","updated_at":"2021-09-21T12:40:40Z","author_association":"NONE","body":"Dear authors,\r\n\r\nI also have some problem with semi-supervised training. I did not find the test program about semi-supervised and I create a new program based on the unsupervised test file. I change the model from `VxmDense` to `VxmDenseSemiSupervisedSeg` and load the checkpoint file from `train_semisupervised_seg.py`. The result I got is very strange and I wonder whether my steps are correct.\r\n\r\nThanks!","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/923947820/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false}},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/924013905","html_url":"https://github.com/voxelmorph/voxelmorph/issues/169#issuecomment-924013905","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/169","id":924013905,"node_id":"IC_kwDOB_Nd2843E1VR","user":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"created_at":"2021-09-21T13:55:09Z","updated_at":"2021-09-21T13:55:09Z","author_association":"COLLABORATOR","body":"@ElegantLin can you provide more information? What is the result, etc. Overall the idea seems right, but there are a lot of details to get right, of course.","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/924013905/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false}},{"id":5335818537,"node_id":"MEE_lADOB_Nd284jmdC5zwAAAAE-CiEp","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/5335818537","actor":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-09-21T13:55:09Z","performed_via_github_app":null},{"id":5335818544,"node_id":"SE_lADOB_Nd284jmdC5zwAAAAE-CiEw","url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/events/5335818544","actor":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-09-21T13:55:09Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/924029620","html_url":"https://github.com/voxelmorph/voxelmorph/issues/169#issuecomment-924029620","issue_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/169","id":924029620,"node_id":"IC_kwDOB_Nd2843E5K0","user":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false},"created_at":"2021-09-21T14:12:13Z","updated_at":"2021-09-21T14:18:27Z","author_association":"NONE","body":"Thanks for your quick reply.\r\n\r\nThe code I used is \r\n\r\n```\r\nwith tf.device(device):\r\n\r\n    # load model and build nearest-neighbor transfer model\r\n    registration_model = vxm.networks.VxmDenseSemiSupervisedSeg.load(args.model).get_registration_model()\r\n    inshape = registration_model.inputs[0].shape[1:-1]\r\n    transform_model = vxm.networks.Transform(inshape, interp_method='nearest')\r\n\r\n    for i in range(len(img_pairs)):\r\n\r\n        # load moving image and seg\r\n        moving_vol = vxm.py.utils.load_volfile(\r\n            img_pairs[i][0], np_var='vol', add_batch_axis=True, add_feat_axis=add_feat_axis)\r\n        moving_seg = vxm.py.utils.load_volfile(\r\n            seg_pairs[i][0], np_var='seg', add_batch_axis=True, add_feat_axis=add_feat_axis)\r\n\r\n        # load fixed image and seg\r\n        fixed_vol = vxm.py.utils.load_volfile(\r\n            img_pairs[i][1], np_var='vol', add_batch_axis=True, add_feat_axis=add_feat_axis)\r\n        fixed_seg = vxm.py.utils.load_volfile(\r\n            seg_pairs[i][1], np_var='seg')\r\n\r\n        # predict warp and time\r\n        start = time.time()\r\n        warp = registration_model.predict([moving_vol, fixed_vol])\r\n        reg_time = time.time() - start\r\n        if i != 0:\r\n            # first keras prediction is generally rather slow\r\n            reg_times.append(reg_time)\r\n\r\n        # apply transform\r\n        warped_seg = transform_model.predict([moving_seg, warp]).squeeze()\r\n\r\n        # compute volume overlap (dice)\r\n        overlap = vxm.py.utils.dice(warped_seg, fixed_seg, labels=labels)   \r\n        dice_means.append(np.mean(overlap))\r\n        print('Pair %d    Reg Time: %.4f    Dice: %.4f +/- %.4f' % (i + 1, reg_time,\r\n                                                                    np.mean(overlap),\r\n                                                                    np.std(overlap)))\r\n```\r\n\r\nThe same testing data I used from `test.py` using unsupervised and the result is\r\n\r\n```\r\nPair 1    Reg Time: 8.5144    Dice: 0.4222 +/- 0.2646\r\nPair 2    Reg Time: 3.0140    Dice: 0.4654 +/- 0.0843\r\nPair 3    Reg Time: 2.8464    Dice: 0.5470 +/- 0.0642\r\nPair 4    Reg Time: 2.8613    Dice: 0.3773 +/- 0.0864\r\nPair 5    Reg Time: 2.6998    Dice: 0.2471 +/- 0.0963\r\nPair 6    Reg Time: 2.7484    Dice: 0.1950 +/- 0.1238\r\nPair 7    Reg Time: 2.7477    Dice: 0.4867 +/- 0.1545\r\nPair 8    Reg Time: 2.7271    Dice: 0.0780 +/- 0.1351\r\n\r\nAvg Reg Time: 2.8064 +/- 0.1015  (skipping first prediction)\r\nAvg Dice: 0.3523 +/- 0.1522\r\n```\r\n\r\nHowever, when I used a weight from semi-supervised and tested it with the code above and the same data, the result is \r\n\r\n```\r\nPair 1    Reg Time: 8.3701    Dice: 0.0000 +/- 0.0000\r\nPair 2    Reg Time: 2.9412    Dice: 0.0000 +/- 0.0000\r\nPair 3    Reg Time: 2.7902    Dice: 0.0000 +/- 0.0000\r\nPair 4    Reg Time: 2.8090    Dice: 0.0000 +/- 0.0000\r\nPair 5    Reg Time: 2.8164    Dice: 0.0000 +/- 0.0000\r\nPair 6    Reg Time: 2.6783    Dice: 0.0000 +/- 0.0000\r\nPair 7    Reg Time: 2.7020    Dice: 0.0000 +/- 0.0000\r\nPair 8    Reg Time: 2.7635    Dice: 0.0076 +/- 0.0100\r\n\r\nAvg Reg Time: 2.7858 +/- 0.0799  (skipping first prediction)\r\nAvg Dice: 0.0009 +/- 0.0025\r\n```\r\n\r\nThe semi-supervised training loss goes normally so I suspect there is something wrong with the testing code.\r\n\r\nCould you please help me with it? I don't know where the mistake is.\r\n\r\nThanks!","reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/comments/924029620/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ElegantLin","id":16239478,"node_id":"MDQ6VXNlcjE2MjM5NDc4","avatar_url":"https://avatars.githubusercontent.com/u/16239478?v=4","gravatar_id":"","url":"https://api.github.com/users/ElegantLin","html_url":"https://github.com/ElegantLin","followers_url":"https://api.github.com/users/ElegantLin/followers","following_url":"https://api.github.com/users/ElegantLin/following{/other_user}","gists_url":"https://api.github.com/users/ElegantLin/gists{/gist_id}","starred_url":"https://api.github.com/users/ElegantLin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElegantLin/subscriptions","organizations_url":"https://api.github.com/users/ElegantLin/orgs","repos_url":"https://api.github.com/users/ElegantLin/repos","events_url":"https://api.github.com/users/ElegantLin/events{/privacy}","received_events_url":"https://api.github.com/users/ElegantLin/received_events","type":"User","site_admin":false}}]