{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211","repository_url":"https://api.github.com/repos/voxelmorph/voxelmorph","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211/labels{/name}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211/comments","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211/events","html_url":"https://github.com/voxelmorph/voxelmorph/issues/211","id":678533837,"node_id":"MDU6SXNzdWU2Nzg1MzM4Mzc=","number":211,"title":"Bug in pytorch NCC loss class implementation - master branch","user":{"login":"p-wein","id":18594536,"node_id":"MDQ6VXNlcjE4NTk0NTM2","avatar_url":"https://avatars.githubusercontent.com/u/18594536?v=4","gravatar_id":"","url":"https://api.github.com/users/p-wein","html_url":"https://github.com/p-wein","followers_url":"https://api.github.com/users/p-wein/followers","following_url":"https://api.github.com/users/p-wein/following{/other_user}","gists_url":"https://api.github.com/users/p-wein/gists{/gist_id}","starred_url":"https://api.github.com/users/p-wein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/p-wein/subscriptions","organizations_url":"https://api.github.com/users/p-wein/orgs","repos_url":"https://api.github.com/users/p-wein/repos","events_url":"https://api.github.com/users/p-wein/events{/privacy}","received_events_url":"https://api.github.com/users/p-wein/received_events","type":"User","site_admin":false},"labels":[{"id":1347467145,"node_id":"MDU6TGFiZWwxMzQ3NDY3MTQ1","url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels/voxelmorph","name":"voxelmorph","color":"1d76db","default":false,"description":""},{"id":1512756635,"node_id":"MDU6TGFiZWwxNTEyNzU2NjM1","url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels/pytorch","name":"pytorch","color":"e51206","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-08-13T15:35:42Z","updated_at":"2020-08-21T18:25:26Z","closed_at":"2020-08-21T18:25:26Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nin the master/voxelmorph/torch/losses.py file the NCC classes method NCC.loss() tries to use the function compute_local_sums() in line 51, but that function is not present in the master branch. It looks like someone tried to merge the ncc_loss and compute_local_sums functions in the legacy branches losses.py into a NCC class and did not finish.\r\nI also got an error in line 26 since self.win is not defined (but self.window is).\r\n\r\nSolution:\r\nI tried to finish the merging of compute_local_sums() into NCC.losses, which works for me so far. (I am also creating a pull request):\r\n\r\n```\r\nclass NCC:\r\n    \"\"\"\r\n    Local (over window) normalized cross correlation loss.\r\n    \"\"\"\r\n\r\n    def __init__(self, win=None):\r\n        self.win = win\r\n\r\n    def loss(self, y_true, y_pred):\r\n\r\n        I = y_true\r\n        J = y_pred\r\n\r\n        # get dimension of volume\r\n        # assumes I, J are sized [batch_size, *vol_shape, nb_feats]\r\n        ndims = len(list(I.size())) - 2\r\n        assert ndims in [1, 2, 3], \"volumes should be 1 to 3 dimensions. found: %d\" % ndims\r\n\r\n        # set window size\r\n        win = [9] * ndims if self.win is None else self.win\r\n\r\n        # compute filters\r\n        sum_filt = torch.ones([1, 1, *win]).to(\"cuda\")\r\n\r\n        pad_no = math.floor(win[0]/2)\r\n\r\n        if ndims == 1:\r\n            stride = (1)\r\n            padding = (pad_no)\r\n        elif ndims == 2:\r\n            stride = (1,1)\r\n            padding = (pad_no, pad_no)\r\n        else:\r\n            stride = (1,1,1)\r\n            padding = (pad_no, pad_no, pad_no)\r\n\r\n        # get convolution function\r\n        conv_fn = getattr(F, 'conv%dd' % ndims)\r\n\r\n        # compute CC squares\r\n        I2 = I * I\r\n        J2 = J * J\r\n        IJ = I * J\r\n\r\n        I_sum = conv_fn(I, sum_filt, stride=stride, padding=padding)\r\n        J_sum = conv_fn(J, sum_filt, stride=stride, padding=padding)\r\n        I2_sum = conv_fn(I2, sum_filt, stride=stride, padding=padding)\r\n        J2_sum = conv_fn(J2, sum_filt, stride=stride, padding=padding)\r\n        IJ_sum = conv_fn(IJ, sum_filt, stride=stride, padding=padding)\r\n\r\n        win_size = np.prod(win)\r\n        u_I = I_sum / win_size\r\n        u_J = J_sum / win_size\r\n\r\n        cross = IJ_sum - u_J * I_sum - u_I * J_sum + u_I * u_J * win_size\r\n        I_var = I2_sum - 2 * u_I * I_sum + u_I * u_I * win_size\r\n        J_var = J2_sum - 2 * u_J * J_sum + u_J * u_J * win_size\r\n\r\n        cc = cross * cross / (I_var * J_var + 1e-5)\r\n\r\n        return -torch.mean(cc)\r\n```","closed_by":{"login":"adalca","id":3219675,"node_id":"MDQ6VXNlcjMyMTk2NzU=","avatar_url":"https://avatars.githubusercontent.com/u/3219675?v=4","gravatar_id":"","url":"https://api.github.com/users/adalca","html_url":"https://github.com/adalca","followers_url":"https://api.github.com/users/adalca/followers","following_url":"https://api.github.com/users/adalca/following{/other_user}","gists_url":"https://api.github.com/users/adalca/gists{/gist_id}","starred_url":"https://api.github.com/users/adalca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adalca/subscriptions","organizations_url":"https://api.github.com/users/adalca/orgs","repos_url":"https://api.github.com/users/adalca/repos","events_url":"https://api.github.com/users/adalca/events{/privacy}","received_events_url":"https://api.github.com/users/adalca/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/211/timeline","performed_via_github_app":null,"state_reason":"completed"}