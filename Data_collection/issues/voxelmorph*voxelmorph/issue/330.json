{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330","repository_url":"https://api.github.com/repos/voxelmorph/voxelmorph","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330/labels{/name}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330/comments","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330/events","html_url":"https://github.com/voxelmorph/voxelmorph/issues/330","id":934157840,"node_id":"MDU6SXNzdWU5MzQxNTc4NDA=","number":330,"title":"Error while loading vxm_dense_brain_T1_3D_mse.h5","user":{"login":"srivathsapv","id":1017519,"node_id":"MDQ6VXNlcjEwMTc1MTk=","avatar_url":"https://avatars.githubusercontent.com/u/1017519?v=4","gravatar_id":"","url":"https://api.github.com/users/srivathsapv","html_url":"https://github.com/srivathsapv","followers_url":"https://api.github.com/users/srivathsapv/followers","following_url":"https://api.github.com/users/srivathsapv/following{/other_user}","gists_url":"https://api.github.com/users/srivathsapv/gists{/gist_id}","starred_url":"https://api.github.com/users/srivathsapv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srivathsapv/subscriptions","organizations_url":"https://api.github.com/users/srivathsapv/orgs","repos_url":"https://api.github.com/users/srivathsapv/repos","events_url":"https://api.github.com/users/srivathsapv/events{/privacy}","received_events_url":"https://api.github.com/users/srivathsapv/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-06-30T21:58:10Z","updated_at":"2022-03-08T12:50:52Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I am using Keras 2.3.0 and tensorflow 1.14\r\n\r\nI initialize the dense model like this\r\n```\r\nenc_nf = [16, 32, 32, 32]\r\ndec_nf = [32, 32, 32, 32, 32, 16, 16]\r\n\r\nmodel = vxm.networks.VxmDense(\r\n    inshape=(160, 192, 224),\r\n    nb_unet_features=[enc_nf, dec_nf],\r\n    bidir=False,\r\n    use_probs=False,\r\n    int_steps=7,\r\n    int_downsize=2,\r\n    src_feats=1,\r\n    trg_feats=1\r\n)\r\n```\r\n\r\nand then I do\r\n\r\n```\r\nmodel.load_weights('vxm_dense_brain_T1_3D_mse.h5')\r\n```\r\n\r\nI get an error as follows\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-49-90e78dfcb397> in <module>\r\n----> 1 model.load_weights('/home/srivathsa/projects/studies/gad/vmorph/tutorial_data/vxm_dense_brain_T1_3D_mse.h5')\r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py in load_weights(self, filepath, by_name)\r\n    160         raise ValueError('Load weights is not yet supported with TPUStrategy '\r\n    161                          'with steps_per_run greater than 1.')\r\n--> 162     return super(Model, self).load_weights(filepath, by_name)\r\n    163 \r\n    164   @trackable.no_automatic_dependency_tracking\r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/tensorflow/python/keras/engine/network.py in load_weights(self, filepath, by_name)\r\n   1422         saving.load_weights_from_hdf5_group_by_name(f, self.layers)\r\n   1423       else:\r\n-> 1424         saving.load_weights_from_hdf5_group(f, self.layers)\r\n   1425 \r\n   1426   def _updated_config(self):\r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/tensorflow/python/keras/saving/hdf5_format.py in load_weights_from_hdf5_group(f, layers)\r\n    750     symbolic_weights = _legacy_weights(layer)\r\n    751     weight_values = preprocess_weights_for_loading(\r\n--> 752         layer, weight_values, original_keras_version, original_backend)\r\n    753     if len(weight_values) != len(symbolic_weights):\r\n    754       raise ValueError('Layer #' + str(k) + ' (named \"' + layer.name +\r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/tensorflow/python/keras/saving/hdf5_format.py in preprocess_weights_for_loading(layer, weights, original_keras_version, original_backend)\r\n    457       print(weights[0].shape)\r\n    458       print(layer.weights[0].shape)\r\n--> 459       weights[0] = np.transpose(weights[0], (3, 2, 0, 1))\r\n    460       if layer.__class__.__name__ == 'ConvLSTM2D':\r\n    461         weights[1] = np.transpose(weights[1], (3, 2, 0, 1))\r\n\r\n<__array_function__ internals> in transpose(*args, **kwargs)\r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/numpy/core/fromnumeric.py in transpose(a, axes)\r\n    658 \r\n    659     \"\"\"\r\n--> 660     return _wrapfunc(a, 'transpose', axes)\r\n    661 \r\n    662 \r\n\r\n~/miniconda3/envs/voxelmorph/lib/python3.7/site-packages/numpy/core/fromnumeric.py in _wrapfunc(obj, method, *args, **kwds)\r\n     55 \r\n     56     try:\r\n---> 57         return bound(*args, **kwds)\r\n     58     except TypeError:\r\n     59         # A TypeError occurs if the object does have such a method in its\r\n\r\nValueError: axes don't match array\r\n```\r\n\r\nI further debug and find that the shape of weights of the layer `vxm_dense_unet_dec_final_conv_0` is `(3, 3, 3, 32, 32)` in the h5 file but in the model definition above it is `(3, 3, 3, 48, 32)`. \r\n\r\nHow can I fix this inconsistency? Thanks","closed_by":null,"reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/330/timeline","performed_via_github_app":null,"state_reason":null}