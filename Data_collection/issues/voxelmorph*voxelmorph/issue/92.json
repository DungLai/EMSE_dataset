{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92","repository_url":"https://api.github.com/repos/voxelmorph/voxelmorph","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92/labels{/name}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92/comments","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92/events","html_url":"https://github.com/voxelmorph/voxelmorph/issues/92","id":485988744,"node_id":"MDU6SXNzdWU0ODU5ODg3NDQ=","number":92,"title":"Reproduce NCC loss","user":{"login":"John1231983","id":24875971,"node_id":"MDQ6VXNlcjI0ODc1OTcx","avatar_url":"https://avatars.githubusercontent.com/u/24875971?v=4","gravatar_id":"","url":"https://api.github.com/users/John1231983","html_url":"https://github.com/John1231983","followers_url":"https://api.github.com/users/John1231983/followers","following_url":"https://api.github.com/users/John1231983/following{/other_user}","gists_url":"https://api.github.com/users/John1231983/gists{/gist_id}","starred_url":"https://api.github.com/users/John1231983/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/John1231983/subscriptions","organizations_url":"https://api.github.com/users/John1231983/orgs","repos_url":"https://api.github.com/users/John1231983/repos","events_url":"https://api.github.com/users/John1231983/events{/privacy}","received_events_url":"https://api.github.com/users/John1231983/received_events","type":"User","site_admin":false},"labels":[{"id":1347467145,"node_id":"MDU6TGFiZWwxMzQ3NDY3MTQ1","url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels/voxelmorph","name":"voxelmorph","color":"1d76db","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-08-27T19:21:36Z","updated_at":"2019-08-28T14:29:57Z","closed_at":"2019-08-28T14:26:13Z","author_association":"NONE","active_lock_reason":null,"body":"Hello, this is not an issue. I just want to ask you about the NCC loss in CVPR 2018, that I want to reproduce \r\n\r\n1. For two following lines, if we use in 3D image, then win=[9,9,9], strides =[1,1,1] and  sum_filt = ones([9,9,9,1,1]). So, if my input has 2 channels, then the sum_fit must be size of `9x9x9x2x1`, is it right?\r\n\r\nhttps://github.com/voxelmorph/voxelmorph/blob/c975b94d0ef6d235afe39a1b49f28e5f10861631/src/losses.py#L43\r\nhttps://github.com/voxelmorph/voxelmorph/blob/c975b94d0ef6d235afe39a1b49f28e5f10861631/src/losses.py#L54\r\nhttps://github.com/voxelmorph/voxelmorph/blob/c975b94d0ef6d235afe39a1b49f28e5f10861631/src/losses.py#L57\r\n\r\nThis is my reproduce code\r\n```\r\n    def ncc_loss(self, I, J):        \r\n        eps = 1e-5\r\n        n = 9\r\n        win = [n] *3 # [9,9,9]\r\n        # compute CC squares\r\n        I2 = torch.mul(I,I)\r\n        J2 = torch.mul(J,J)\r\n        IJ = torch.mul(I,J)\r\n        # compute filters\r\n        batch_size, channels, _, _, _ = I.shape\r\n        sum_filt = torch.ones((1, channels, n, n, n)).float().to('cuda')\r\n        strides = [1]*3 # [1,1,1]\r\n        # compute local sums via convolution\r\n        I_sum = F.conv3d(I, sum_filt, stride= strides, padding=1)\r\n        J_sum = F.conv3d(J, sum_filt, stride=strides, padding=1)\r\n        I2_sum = F.conv3d(I2, sum_filt, stride=strides, padding=1)\r\n        J2_sum = F.conv3d(J2, sum_filt, stride=strides, padding=1)\r\n        IJ_sum = F.conv3d(IJ, sum_filt, stride=strides, padding=1)\r\n        # compute cross correlation\r\n        win_size = np.prod(win)\r\n        u_I = I_sum / win_size\r\n        u_J = J_sum / win_size\r\n        cross = IJ_sum - u_J*I_sum - u_I*J_sum + u_I*u_J*win_size\r\n        I_var = I2_sum - 2 * u_I * I_sum + u_I*u_I*win_size\r\n        J_var = J2_sum - 2 * u_J * J_sum + u_J*u_J*win_size\r\n        cc = cross*cross / (I_var*J_var + eps)        \r\n        return 1 - torch.mean(cc)\r\n\r\n```\r\n\r\nHowever, I got some big value in the loss during training (i.e. ncc loss: -162.68817  in epoch 3). Could you guess any issue in the code?\r\n```\r\nEpoch: (  1)  | Total loss: 0.83465 |ncc loss: 0.59442 |  Smooth loss 0.24022\r\nEpoch: (  1)  | Total loss: 0.81657 |ncc loss: 0.57388 |  Smooth loss 0.24269\r\nEpoch: (  1) | Total loss: 0.87251 |ncc loss: 0.62968 |  Smooth loss 0.24282\r\nEpoch: (  1) | Total loss: 0.89325 |ncc loss: 0.65125 |  Smooth loss 0.24199\r\n...\r\nEpoch: (  3)  | Total loss: -0.01893 |ncc loss: -0.25998 |  Smooth loss 0.24104\r\nEpoch: (  3)  | Total loss: 0.73279 |ncc loss: 0.49024 |  Smooth loss 0.24255\r\nEpoch: (  3)  | Total loss: -162.44589 |ncc loss: -162.68817 |  Smooth loss 0.24228\r\nEpoch: (  3)  | Total loss: 1.79963 |ncc loss: 1.55769 |  Smooth loss 0.24194\r\nEpoch: (  3) | Total loss: 0.51922 |ncc loss: 0.27774 |  Smooth loss 0.24147\r\nEpoch: (  3) | Total loss: 0.00790 |ncc loss: -0.23127 |  Smooth loss 0.23916\r\n```","closed_by":{"login":"John1231983","id":24875971,"node_id":"MDQ6VXNlcjI0ODc1OTcx","avatar_url":"https://avatars.githubusercontent.com/u/24875971?v=4","gravatar_id":"","url":"https://api.github.com/users/John1231983","html_url":"https://github.com/John1231983","followers_url":"https://api.github.com/users/John1231983/followers","following_url":"https://api.github.com/users/John1231983/following{/other_user}","gists_url":"https://api.github.com/users/John1231983/gists{/gist_id}","starred_url":"https://api.github.com/users/John1231983/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/John1231983/subscriptions","organizations_url":"https://api.github.com/users/John1231983/orgs","repos_url":"https://api.github.com/users/John1231983/repos","events_url":"https://api.github.com/users/John1231983/events{/privacy}","received_events_url":"https://api.github.com/users/John1231983/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/92/timeline","performed_via_github_app":null,"state_reason":"completed"}