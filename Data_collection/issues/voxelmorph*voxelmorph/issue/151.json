{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151","repository_url":"https://api.github.com/repos/voxelmorph/voxelmorph","labels_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151/labels{/name}","comments_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151/comments","events_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151/events","html_url":"https://github.com/voxelmorph/voxelmorph/issues/151","id":567561093,"node_id":"MDU6SXNzdWU1Njc1NjEwOTM=","number":151,"title":"Registration with own data","user":{"login":"armaneshaghi","id":4290297,"node_id":"MDQ6VXNlcjQyOTAyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/4290297?v=4","gravatar_id":"","url":"https://api.github.com/users/armaneshaghi","html_url":"https://github.com/armaneshaghi","followers_url":"https://api.github.com/users/armaneshaghi/followers","following_url":"https://api.github.com/users/armaneshaghi/following{/other_user}","gists_url":"https://api.github.com/users/armaneshaghi/gists{/gist_id}","starred_url":"https://api.github.com/users/armaneshaghi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/armaneshaghi/subscriptions","organizations_url":"https://api.github.com/users/armaneshaghi/orgs","repos_url":"https://api.github.com/users/armaneshaghi/repos","events_url":"https://api.github.com/users/armaneshaghi/events{/privacy}","received_events_url":"https://api.github.com/users/armaneshaghi/received_events","type":"User","site_admin":false},"labels":[{"id":1347467145,"node_id":"MDU6TGFiZWwxMzQ3NDY3MTQ1","url":"https://api.github.com/repos/voxelmorph/voxelmorph/labels/voxelmorph","name":"voxelmorph","color":"1d76db","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-02-19T13:13:59Z","updated_at":"2020-03-05T18:30:11Z","closed_at":"2020-03-05T18:30:11Z","author_association":"NONE","active_lock_reason":null,"body":"I am trying to retrain the MICCAI 2018 model with my own data. \r\n\r\n\r\nI have removed the skull, rescaled (range 0 to 1), recast to float, and resampled my images to 160 x 192 x 224 . I have converted my NIFTI files to .npz as explained in the documentation. \r\n\r\nI am using my own template as well, which I created by affine registration of my template to the one you have provided. \r\n\r\nI ran the following command:\r\n\r\n`python train_miccai2018.py --atlas_file ./template_DL_noSkull.npz --load_model_file voxelmorph/models/miccai2018_10_02_init1.h5 --gpu 0,1 --steps_per_epoch 100 --epochs 1500 --lr 0.0001 --model_dir ./new_models_miccai/ --image_sigma 0.01 --batch_size 4 --prior_lambda 25  ./train/`\r\n\r\nThe loss seems to be quite high (about 200) and the model does not converge, I have waited up to 100 epochs. \r\n\r\n```\r\n\r\n100/100 [==============================] - 250s 3s/step - loss: 220.5585 - spatial_transformer_1_loss: 209.7777 - concatenate_5_loss: 10.7808\r\nEpoch 2/1500\r\n100/100 [==============================] - 229s 2s/step - loss: 217.9164 - spatial_transformer_1_loss: 207.0999 - concatenate_5_loss: 10.8165\r\nEpoch 3/1500\r\n100/100 [==============================] - 227s 2s/step - loss: 216.2113 - spatial_transformer_1_loss: 205.4252 - concatenate_5_loss: 10.7861\r\nEpoch 4/1500\r\n100/100 [==============================] - 225s 2s/step - loss: 215.7948 - spatial_transformer_1_loss: 204.8948 - concatenate_5_loss: 10.9001\r\nEpoch 5/1500\r\n100/100 [==============================] - 225s 2s/step - loss: 217.0399 - spatial_transformer_1_loss: 206.2001 - concatenate_5_loss: 10.8399\r\nEpoch 6/1500\r\n100/100 [==============================] - 227s 2s/step - loss: 217.9617 - spatial_transformer_1_loss: 206.9990 - concatenate_5_loss: 10.9627\r\nEpoch 7/1500\r\n100/100 [==============================] - 226s 2s/step - loss: 222.8638 - spatial_transformer_1_loss: 211.8576 - concatenate_5_loss: 11.0062\r\nEpoch 8/1500\r\n100/100 [==============================] - 228s 2s/step - loss: 213.9191 - spatial_transformer_1_loss: 202.9843 - concatenate_5_loss: 10.9348\r\nEpoch 9/1500\r\n100/100 [==============================] - 225s 2s/step - loss: 220.6996 - spatial_transformer_1_loss: 209.7147 - concatenate_5_loss: 10.9850\r\nEpoch 10/1500\r\n100/100 [==============================] - 225s 2s/step - loss: 219.5768 - spatial_transformer_1_loss: 208.5653 - concatenate_5_loss: 11.0115\r\nEpoch 11/1500\r\n100/100 [==============================] - 224s 2s/step - loss: 214.5705 - spatial_transformer_1_loss: 203.5438 - concatenate_5_loss: 11.0267\r\nEpoch 12/1500\r\n100/100 [==============================] - 230s 2s/step - loss: 221.3336 - spatial_transformer_1_loss: 210.2824 - concatenate_5_loss: 11.0512\r\nEpoch 13/1500\r\n100/100 [==============================] - 229s 2s/step - loss: 221.3173 - spatial_transformer_1_loss: 210.3257 - concatenate_5_loss: 10.9917\r\nEpoch 14/1500\r\n100/100 [==============================] - 227s 2s/step - loss: 216.8826 - spatial_transformer_1_loss: 205.8614 - concatenate_5_loss: 11.0212\r\nEpoch 15/1500\r\n100/100 [==============================] - 227s 2s/step - loss: 216.0033 - spatial_transformer_1_loss: 204.9779 - concatenate_5_loss: 11.0254\r\nEpoch 16/1500\r\n100/100 [==============================] - 226s 2s/step - loss: 220.5126 - spatial_transformer_1_loss: 209.4179 - concatenate_5_loss: 11.0948\r\nEpoch 17/1500\r\n100/100 [==============================] - 226s 2s/step - loss: 213.2728 - spatial_transformer_1_loss: 202.2822 - concatenate_5_loss: 10.9906\r\nEpoch 18/1500\r\n100/100 [==============================] - 226s 2s/step - loss: 221.4961 - spatial_transformer_1_loss: 210.4481 - concatenate_5_loss: 11.0480\r\nEpoch 19/1500\r\n100/100 [==============================] - 225s 2s/step - loss: 213.0599 - spatial_transformer_1_loss: 202.0254 - concatenate_5_loss: 11.0345\r\nEpoch 20/1500\r\n100/100 [==============================] - 232s 2s/step - loss: 216.0980 - spatial_transformer_1_loss: 204.9946 - concatenate_5_loss: 11.1034\r\n\r\n```\r\nThe registered image (using `register.py` and the newly trained model) looks like the below (range 0 to 1): \r\n\r\n![image](https://user-images.githubusercontent.com/4290297/74839931-01a5f880-531e-11ea-955b-3794149f6376.png)\r\n\r\nI have also tried the CVPR version (with the `train.py` command instead of `train_miccai2018.py`) and looked at many different levels of lambda (0.01 to more than 10), although the loss is much different (gets to less than 1) but the alignment still does not look good, which means that there are gross misalignments. \r\n\r\nI would be grateful if you could  provide hints on how to improve. \r\n\r\n","closed_by":{"login":"armaneshaghi","id":4290297,"node_id":"MDQ6VXNlcjQyOTAyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/4290297?v=4","gravatar_id":"","url":"https://api.github.com/users/armaneshaghi","html_url":"https://github.com/armaneshaghi","followers_url":"https://api.github.com/users/armaneshaghi/followers","following_url":"https://api.github.com/users/armaneshaghi/following{/other_user}","gists_url":"https://api.github.com/users/armaneshaghi/gists{/gist_id}","starred_url":"https://api.github.com/users/armaneshaghi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/armaneshaghi/subscriptions","organizations_url":"https://api.github.com/users/armaneshaghi/orgs","repos_url":"https://api.github.com/users/armaneshaghi/repos","events_url":"https://api.github.com/users/armaneshaghi/events{/privacy}","received_events_url":"https://api.github.com/users/armaneshaghi/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/voxelmorph/voxelmorph/issues/151/timeline","performed_via_github_app":null,"state_reason":"completed"}