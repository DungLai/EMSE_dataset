{"url":"https://api.github.com/repos/dbiir/UER-py/issues/86","repository_url":"https://api.github.com/repos/dbiir/UER-py","labels_url":"https://api.github.com/repos/dbiir/UER-py/issues/86/labels{/name}","comments_url":"https://api.github.com/repos/dbiir/UER-py/issues/86/comments","events_url":"https://api.github.com/repos/dbiir/UER-py/issues/86/events","html_url":"https://github.com/dbiir/UER-py/issues/86","id":774200640,"node_id":"MDU6SXNzdWU3NzQyMDA2NDA=","number":86,"title":"转换hugging face 模型 进行预训练出错，以及 不转换直接预训练正确率太低","user":{"login":"watermelon-lee","id":34205153,"node_id":"MDQ6VXNlcjM0MjA1MTUz","avatar_url":"https://avatars.githubusercontent.com/u/34205153?v=4","gravatar_id":"","url":"https://api.github.com/users/watermelon-lee","html_url":"https://github.com/watermelon-lee","followers_url":"https://api.github.com/users/watermelon-lee/followers","following_url":"https://api.github.com/users/watermelon-lee/following{/other_user}","gists_url":"https://api.github.com/users/watermelon-lee/gists{/gist_id}","starred_url":"https://api.github.com/users/watermelon-lee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/watermelon-lee/subscriptions","organizations_url":"https://api.github.com/users/watermelon-lee/orgs","repos_url":"https://api.github.com/users/watermelon-lee/repos","events_url":"https://api.github.com/users/watermelon-lee/events{/privacy}","received_events_url":"https://api.github.com/users/watermelon-lee/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-12-24T05:53:41Z","updated_at":"2020-12-24T06:02:20Z","closed_at":"2020-12-24T06:02:20Z","author_association":"NONE","active_lock_reason":null,"body":"Q1: 转换模型预训练出错\r\n执行转换脚本\r\npython3 scripts/convert_bert_from_huggingface_to_uer.py --input_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model.bin \\\r\n                                                        --output_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model_uer.bin \\\r\n                                                        --layers_num 24\r\n\r\n在将数据（约 15MB语料）转换完毕之后，进行预训练\r\n\r\nCUDA_VISIBLE_DEVICES=1,2 python3 pretrain.py --dataset_path dataset.pt --vocab_path models/google_zh_vocab.txt --pretrained_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model_uer.bin \\\r\n                    --output_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model_uer_mlm.bin  --world_size 2 --gpu_ranks 0 1  \\\r\n                    --total_steps 5000 --save_checkpoint_steps 1000 --embedding bert --encoder bert --target mlm\r\n\r\n然后出现报错：\r\nRuntimeError: Error(s) in loading state_dict for Model:\r\n        size mismatch for embedding.word_embedding.weight: copying a param with shape torch.Size([21128, 1024]) from checkpoint, the shape in current model is torch.Size([21128, 768]).\r\n        size mismatch for embedding.position_embedding.weight: copying a param with shape torch.Size([512, 1024]) from checkpoint, the shape in current model is torch.Size([512, 768]).\r\n疑似在模型转换的时候将bert large 转换出错了？\r\n\r\nQ2:\r\n不使用转换的预训练模型，直接使用hugging face 的模型进行预训练\r\nCUDA_VISIBLE_DEVICES=1,2 python3 pretrain.py --dataset_path dataset.pt --vocab_path models/google_zh_vocab.txt --pretrained_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model.bin \\\r\n                    --output_model_path models/chinese_roberta_wwm_large_ext_pytorch/pytorch_model_uer_mlm.bin  --world_size 2 --gpu_ranks 0 1  \\\r\n                    --total_steps 5000 --save_checkpoint_steps 1000 --embedding bert --encoder bert --target mlm\r\n\r\n能够正确运行，但是模型正确率非常低，感觉和issue #32Can we use bert wwm pretrain model directly ? 情况很类似？\r\n具体输出如下：\r\n|      100/    5000 steps| 28313.10 tokens/s| loss    9.36| acc: 0.025\r\n|      200/    5000 steps| 28757.11 tokens/s| loss    8.19| acc: 0.034\r\n|      300/    5000 steps| 28903.85 tokens/s| loss    7.36| acc: 0.032\r\n|      400/    5000 steps| 29195.85 tokens/s| loss    6.85| acc: 0.045\r\n|      500/    5000 steps| 28838.23 tokens/s| loss    6.66| acc: 0.057\r\n|      600/    5000 steps| 28747.72 tokens/s| loss    6.58| acc: 0.062\r\n|      700/    5000 steps| 29120.63 tokens/s| loss    6.44| acc: 0.070\r\n|      800/    5000 steps| 28985.53 tokens/s| loss    6.40| acc: 0.080\r\n|      900/    5000 steps| 28426.76 tokens/s| loss    6.34| acc: 0.089\r\n|     1000/    5000 steps| 29011.21 tokens/s| loss    6.27| acc: 0.096\r\n|     1100/    5000 steps| 28754.28 tokens/s| loss    6.24| acc: 0.097\r\n|     1200/    5000 steps| 28884.74 tokens/s| loss    6.21| acc: 0.103\r\n|     1300/    5000 steps| 28976.05 tokens/s| loss    6.23| acc: 0.108\r\n|     1400/    5000 steps| 29083.27 tokens/s| loss    6.16| acc: 0.111\r\n|     1500/    5000 steps| 29082.03 tokens/s| loss    6.14| acc: 0.109\r\n|     1600/    5000 steps| 29118.99 tokens/s| loss    6.12| acc: 0.117\r\n|     1700/    5000 steps| 28007.29 tokens/s| loss    6.11| acc: 0.117\r\n|     1800/    5000 steps| 29114.06 tokens/s| loss    6.11| acc: 0.121\r\n|     1900/    5000 steps| 28985.75 tokens/s| loss    6.08| acc: 0.118\r\n|     2000/    5000 steps| 29076.29 tokens/s| loss    6.10| acc: 0.123\r\n|     2100/    5000 steps| 28764.05 tokens/s| loss    6.05| acc: 0.124\r\n|     2200/    5000 steps| 29038.47 tokens/s| loss    5.98| acc: 0.127\r\n|     2300/    5000 steps| 29029.31 tokens/s| loss    5.99| acc: 0.126\r\n|     2400/    5000 steps| 29082.48 tokens/s| loss    6.01| acc: 0.127\r\n\r\n提前圣诞快乐～  望回答！\r\n\r\n\r\n","closed_by":{"login":"watermelon-lee","id":34205153,"node_id":"MDQ6VXNlcjM0MjA1MTUz","avatar_url":"https://avatars.githubusercontent.com/u/34205153?v=4","gravatar_id":"","url":"https://api.github.com/users/watermelon-lee","html_url":"https://github.com/watermelon-lee","followers_url":"https://api.github.com/users/watermelon-lee/followers","following_url":"https://api.github.com/users/watermelon-lee/following{/other_user}","gists_url":"https://api.github.com/users/watermelon-lee/gists{/gist_id}","starred_url":"https://api.github.com/users/watermelon-lee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/watermelon-lee/subscriptions","organizations_url":"https://api.github.com/users/watermelon-lee/orgs","repos_url":"https://api.github.com/users/watermelon-lee/repos","events_url":"https://api.github.com/users/watermelon-lee/events{/privacy}","received_events_url":"https://api.github.com/users/watermelon-lee/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dbiir/UER-py/issues/86/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dbiir/UER-py/issues/86/timeline","performed_via_github_app":null,"state_reason":"completed"}