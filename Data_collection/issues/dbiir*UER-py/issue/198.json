{"url":"https://api.github.com/repos/dbiir/UER-py/issues/198","repository_url":"https://api.github.com/repos/dbiir/UER-py","labels_url":"https://api.github.com/repos/dbiir/UER-py/issues/198/labels{/name}","comments_url":"https://api.github.com/repos/dbiir/UER-py/issues/198/comments","events_url":"https://api.github.com/repos/dbiir/UER-py/issues/198/events","html_url":"https://github.com/dbiir/UER-py/issues/198","id":975535208,"node_id":"MDU6SXNzdWU5NzU1MzUyMDg=","number":198,"title":"deepspeed多机多卡训练bert错误","user":{"login":"RyanHuangNLP","id":49582480,"node_id":"MDQ6VXNlcjQ5NTgyNDgw","avatar_url":"https://avatars.githubusercontent.com/u/49582480?v=4","gravatar_id":"","url":"https://api.github.com/users/RyanHuangNLP","html_url":"https://github.com/RyanHuangNLP","followers_url":"https://api.github.com/users/RyanHuangNLP/followers","following_url":"https://api.github.com/users/RyanHuangNLP/following{/other_user}","gists_url":"https://api.github.com/users/RyanHuangNLP/gists{/gist_id}","starred_url":"https://api.github.com/users/RyanHuangNLP/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RyanHuangNLP/subscriptions","organizations_url":"https://api.github.com/users/RyanHuangNLP/orgs","repos_url":"https://api.github.com/users/RyanHuangNLP/repos","events_url":"https://api.github.com/users/RyanHuangNLP/events{/privacy}","received_events_url":"https://api.github.com/users/RyanHuangNLP/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-08-20T11:46:25Z","updated_at":"2021-09-26T08:08:00Z","closed_at":"2021-09-26T08:08:00Z","author_association":"NONE","active_lock_reason":null,"body":"这是我的shell 脚本\r\n```\r\nexport NCCL_IB_CUDA_SUPPORT=1 && export NCCL_DEBUG=INFO && export NCCL_IB_DISABLE=0 && export NCCL_IB_GID_INDEX=3 && deepspeed \\\r\n          --hostfile=./hostfile \\\r\n         pretrain.py \\\r\n          --deepspeed --deepspeed_config models/deepspeed_config.json \\\r\n          --dataset_path dataset_wwm.pt \\\r\n          --vocab_path models/google_zh_vocab.txt \\\r\n          --config_path models/bert/large_config.json \\\r\n          --output_model_path models/roberta_large_seq128_model.bin \\\r\n          --world_size 16 --total_steps 4000000 --save_checkpoint_steps 128 --report_steps 128 \\\r\n          --learning_rate 1e-4 --batch_size 16 \\\r\n          --embedding word_pos_seg --encoder transformer --mask fully_visible --target mlm --tie_weights \r\n```\r\ndeepspeed的config文件\r\n```\r\n{\r\n  \"train_batch_size\": 256,\r\n  \"train_micro_batch_size_per_gpu\": 16,\r\n  \"steps_per_print\": 128,\r\n  \"prescale_gradients\": false,\r\n  \"optimizer\": {\r\n    \"type\": \"Adam\",\r\n    \"params\": {\r\n      \"lr\": 0.00001,\r\n      \"weight_decay\": 0.01\r\n    }\r\n  },\r\n  \"flops_profiler\": {\r\n    \"enabled\": true,\r\n    \"profile_step\": 1,\r\n    \"module_depth\": -1,\r\n    \"top_modules\": 3,\r\n    \"detailed\": true\r\n  },\r\n  \"wall_clock_breakdown\": false\r\n}\r\n```\r\n出现以下的错误\r\n```\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:   File \"/data/ceph_11015/ssd/ramseyhuang/UER/uer/utils/config.py\", line 21, in <dictcomp>\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=4'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=1'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=7'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=6'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=2'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=3'\\n\"\r\nb\"11.213.17.148: KeyError: 'local_rank=0'\\n\"\r\nb'11.213.17.148:     input_args = {k: args_dict[k] for k in [a[2:] for a in sys.argv if a[:2] == \"--\"]}\\n'\r\nb\"11.213.17.148: KeyError: 'local_rank=5'\\n\"\r\nb'11.213.17.148: Killing subprocess 2355\\n'\r\nb'11.213.17.148: Killing subprocess 2356\\n'\r\nb'11.213.17.148: Killing subprocess 2357\\n'\r\nb'11.213.17.148: Killing subprocess 2358\\n'\r\nb'11.213.17.148: Killing subprocess 2359\\n'\r\nb'11.213.17.148: Killing subprocess 2360\\n'\r\nb'11.213.17.148: Killing subprocess 2361\\n'\r\nb'11.213.17.148: Killing subprocess 2362\\n'\r\nb'11.213.17.148: Traceback (most recent call last):\\n'\r\nb'11.213.17.148:   File \"/data/miniconda3/envs/env-3.6.8/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\\n'\r\nb'11.213.17.148:     \"__main__\", mod_spec)\\n'\r\nb'11.213.17.148:   File \"/data/miniconda3/envs/env-3.6.8/lib/python3.6/runpy.py\", line 85, in _run_code\\n'\r\nb'11.213.17.148:     exec(code, run_globals)\\n'\r\nb'11.213.17.148:   File \"/data/miniconda3/envs/env-3.6.8/lib/python3.6/site-packages/deepspeed/launcher/launch.py\", line 171, in <module>\\n'\r\nb'11.213.17.148:     main()\\n'\r\nb'11.213.17.148:   File \"/data/miniconda3/envs/env-3.6.8/lib/python3.6/site-packages/deepspeed/launcher/launch.py\", line 161, in main\\n'\r\nb'11.213.17.148:     sigkill_handler(signal.SIGTERM, None)  # not coming back\\n'\r\nb'11.213.17.148:   File \"/data/miniconda3/envs/env-3.6.8/lib/python3.6/site-packages/deepspeed/launcher/launch.py\", line 139, in sigkill_handler\\n'\r\nb'11.213.17.148:     raise subprocess.CalledProcessError(returncode=last_return_code, cmd=cmd)\\n'\r\n```\r\n主要问题是`KeyError: 'local_rank=4'\\n\"`?","closed_by":{"login":"ydli-ai","id":20391895,"node_id":"MDQ6VXNlcjIwMzkxODk1","avatar_url":"https://avatars.githubusercontent.com/u/20391895?v=4","gravatar_id":"","url":"https://api.github.com/users/ydli-ai","html_url":"https://github.com/ydli-ai","followers_url":"https://api.github.com/users/ydli-ai/followers","following_url":"https://api.github.com/users/ydli-ai/following{/other_user}","gists_url":"https://api.github.com/users/ydli-ai/gists{/gist_id}","starred_url":"https://api.github.com/users/ydli-ai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ydli-ai/subscriptions","organizations_url":"https://api.github.com/users/ydli-ai/orgs","repos_url":"https://api.github.com/users/ydli-ai/repos","events_url":"https://api.github.com/users/ydli-ai/events{/privacy}","received_events_url":"https://api.github.com/users/ydli-ai/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dbiir/UER-py/issues/198/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dbiir/UER-py/issues/198/timeline","performed_via_github_app":null,"state_reason":"completed"}