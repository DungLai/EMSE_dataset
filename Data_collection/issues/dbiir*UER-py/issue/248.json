{"url":"https://api.github.com/repos/dbiir/UER-py/issues/248","repository_url":"https://api.github.com/repos/dbiir/UER-py","labels_url":"https://api.github.com/repos/dbiir/UER-py/issues/248/labels{/name}","comments_url":"https://api.github.com/repos/dbiir/UER-py/issues/248/comments","events_url":"https://api.github.com/repos/dbiir/UER-py/issues/248/events","html_url":"https://github.com/dbiir/UER-py/issues/248","id":1094926750,"node_id":"I_kwDOCsNQKM5BQ0Ge","number":248,"title":"多卡运行报错 TypeError: can't pickle _thread.RLock objects","user":{"login":"LeoWood","id":17940401,"node_id":"MDQ6VXNlcjE3OTQwNDAx","avatar_url":"https://avatars.githubusercontent.com/u/17940401?v=4","gravatar_id":"","url":"https://api.github.com/users/LeoWood","html_url":"https://github.com/LeoWood","followers_url":"https://api.github.com/users/LeoWood/followers","following_url":"https://api.github.com/users/LeoWood/following{/other_user}","gists_url":"https://api.github.com/users/LeoWood/gists{/gist_id}","starred_url":"https://api.github.com/users/LeoWood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeoWood/subscriptions","organizations_url":"https://api.github.com/users/LeoWood/orgs","repos_url":"https://api.github.com/users/LeoWood/repos","events_url":"https://api.github.com/users/LeoWood/events{/privacy}","received_events_url":"https://api.github.com/users/LeoWood/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-01-06T03:15:42Z","updated_at":"2022-02-08T12:20:55Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"您好，这边用了最新的代码之后，使用多卡进行预训练就会报错，主要是出现在mp.spawn那一步，错误信息如下：\r\nTraceback (most recent call last):\r\n  File \"pretrain.py\", line 133, in <module>\r\n    main()\r\n  File \"pretrain.py\", line 129, in main\r\n    trainer.train_and_validate(args)\r\n  File \"/data/leo/Projects/uer-py-1/uer/trainer.py\", line 56, in train_and_validate\r\n    mp.spawn(worker, nprocs=args.ranks_num, args=(args.gpu_ranks, args, model), daemon=False)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/site-packages/torch/multiprocessing/spawn.py\", line 200, in spawn\r\n    return start_processes(fn, args, nprocs, join, daemon, start_method='spawn')\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/site-packages/torch/multiprocessing/spawn.py\", line 149, in start_processes\r\n    process.start()\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/process.py\", line 105, in start\r\n    self._popen = self._Popen(self)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/context.py\", line 284, in _Popen\r\n    return Popen(process_obj)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 32, in __init__\r\n    super().__init__(process_obj)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/popen_fork.py\", line 19, in __init__\r\n    self._launch(process_obj)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 47, in _launch\r\n    reduction.dump(process_obj, fp)\r\n  File \"/home/leo/anaconda3/envs/py36/lib/python3.6/multiprocessing/reduction.py\", line 60, in dump\r\n    ForkingPickler(file, protocol).dump(obj)\r\nTypeError: can't pickle _thread.RLock objects\r\n\r\n\r\n如果用单卡训练 wordsize=1时，就没有问题。\r\n\r\n以下是我的训练脚本：\r\n\r\npython pretrain.py \\\r\n--dataset_path /data/leo/Projects/uer-py-1/corpora/medical_zh_albert_512.pt \\\r\n--vocab_path /data/leo/Projects/UER-py/models/google_zh_vocab.txt \\\r\n--pretrained_model_path /data/leo/Projects/UER-py/output_pre/r_512_419/r_512_mlm_from_base_100gpus_110w.bin \\\r\n--output_model_path outputs/pretrin/pretrain_r_512_medical_zh_albert_512.bin \\\r\n--config_path /data/leo/Projects/uer-py-1/models/bert_base_config.json \\\r\n--total_steps 5000000 \\\r\n--save_checkpoint_steps 1000 \\\r\n--report_steps 100 \\\r\n--accumulation_steps 1 \\\r\n--batch_size 25 \\\r\n--tokenizer bert \\\r\n--embedding word_pos_seg \\\r\n--encoder transformer \\\r\n--whole_word_masking \\\r\n--target albert \\\r\n--learning_rate 2e-5 \\\r\n--warmup 0.1 \\\r\n--world_size 3 \\\r\n--gpu_ranks 0 1 2 \\\r\n--fp16\r\n\r\n请帮助解答一下，谢谢！","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dbiir/UER-py/issues/248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dbiir/UER-py/issues/248/timeline","performed_via_github_app":null,"state_reason":null}