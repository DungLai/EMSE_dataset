{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124/events","html_url":"https://github.com/catalyst-team/catalyst/issues/124","id":423541859,"node_id":"MDU6SXNzdWU0MjM1NDE4NTk=","number":124,"title":"[BUG] CheckpointCallback is wrong","user":{"login":"ngxbac","id":11550123,"node_id":"MDQ6VXNlcjExNTUwMTIz","avatar_url":"https://avatars.githubusercontent.com/u/11550123?v=4","gravatar_id":"","url":"https://api.github.com/users/ngxbac","html_url":"https://github.com/ngxbac","followers_url":"https://api.github.com/users/ngxbac/followers","following_url":"https://api.github.com/users/ngxbac/following{/other_user}","gists_url":"https://api.github.com/users/ngxbac/gists{/gist_id}","starred_url":"https://api.github.com/users/ngxbac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ngxbac/subscriptions","organizations_url":"https://api.github.com/users/ngxbac/orgs","repos_url":"https://api.github.com/users/ngxbac/repos","events_url":"https://api.github.com/users/ngxbac/events{/privacy}","received_events_url":"https://api.github.com/users/ngxbac/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-03-21T01:41:19Z","updated_at":"2019-03-28T19:53:07Z","closed_at":"2019-03-28T19:53:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi, \r\nI did my experiment, I dont know why best checkpoints are not saved. I tried to `pdb` and found a bug.  \r\n\r\n# Settings \r\n* metrics: map05 \r\n* minimize_metric: False \r\n\r\n# Scenario \r\n* From opoch 0->10, `valid map05 = 0` for all \r\n* From epoch 11, `valid map05` starts increasing. \r\n* From epoch 11, the best checkpoints are not saved  \r\n\r\nFollowing are console logs and checkpoints folder screenshot\r\nFrom `epoch 0->10`: \r\n```\r\n....\r\n8/100 * Epoch (train): _fps=758.1664 | base/batch_time=0.0454 | base/data_time=0.0043 | base/lr=0.0001 | base/model_time=0.0411 | base/momentum=0.9000 | loss=28.4960 | map05=0.0000\r\n8/100 * Epoch (valid): _fps=753.5475 | base/batch_time=0.0635 | base/data_time=0.0245 | base/lr=0.0001 | base/model_time=0.0390 | base/momentum=0.9000 | loss=30.4348 | map05=0.0000\r\n9/100 * Epoch (train): 100% 133/133 [00:06<00:00, 22.16it/s, _fps=733.518, loss=26.232, map05=0.000]\r\n9/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.60it/s, _fps=787.242, loss=28.358, map05=0.000]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) checkpoint_metric\r\n9\r\n(Pdb) c\r\n[2019-03-21 10:20:30,871] \r\n9/100 * Epoch (train): _fps=765.4649 | base/batch_time=0.0453 | base/data_time=0.0045 | base/lr=0.0001 | base/model_time=0.0408 | base/momentum=0.9000 | loss=27.7296 | map05=0.0000\r\n9/100 * Epoch (valid): _fps=752.4676 | base/batch_time=0.0630 | base/data_time=0.0239 | base/lr=0.0001 | base/model_time=0.0391 | base/momentum=0.9000 | loss=29.9424 | map05=0.0000\r\n10/100 * Epoch (train): 100% 133/133 [00:06<00:00, 20.10it/s, _fps=779.565, loss=24.555, map05=0.000]\r\n10/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.95it/s, _fps=822.962, loss=27.833, map05=0.000]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) c\r\n[2019-03-21 10:20:46,505] \r\n10/100 * Epoch (train): _fps=758.8756 | base/batch_time=0.0458 | base/data_time=0.0047 | base/lr=0.0001 | base/model_time=0.0411 | base/momentum=0.9000 | loss=26.9246 | map05=0.0004\r\n10/100 * Epoch (valid): _fps=754.0560 | base/batch_time=0.0616 | base/data_time=0.0225 | base/lr=0.0001 | base/model_time=0.0391 | base/momentum=0.9000 | loss=29.3501 | map05=0.0000\r\n11/100 * Epoch (train): 100% 133/133 [00:06<00:00, 22.27it/s, _fps=785.593, loss=26.380, map05=0.000]\r\n11/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 14.73it/s, _fps=774.013, loss=27.053, map05=0.000]\r\n...\r\n```\r\n\r\nFrom epoch 11: \r\n```\r\n11/100 * Epoch (train): _fps=761.4851 | base/batch_time=0.0455 | base/data_time=0.0045 | base/lr=0.0001 | base/model_time=0.0410 | base/momentum=0.9000 | loss=26.1523 | map05=0.0014\r\n11/100 * Epoch (valid): _fps=751.8519 | base/batch_time=0.0668 | base/data_time=0.0277 | base/lr=0.0001 | base/model_time=0.0391 | base/momentum=0.9000 | loss=28.8740 | map05=0.0000\r\n12/100 * Epoch (train): 100% 133/133 [00:06<00:00, 20.17it/s, _fps=765.323, loss=26.579, map05=0.000]\r\n12/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.92it/s, _fps=824.337, loss=26.422, map05=0.016]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) checkpoint_metric\r\n0.0011160714285714285\r\n(Pdb) c\r\n[2019-03-21 10:21:46,089] \r\n12/100 * Epoch (train): _fps=758.7695 | base/batch_time=0.0456 | base/data_time=0.0046 | base/lr=0.0001 | base/model_time=0.0410 | base/momentum=0.9000 | loss=25.5722 | map05=0.0015\r\n12/100 * Epoch (valid): _fps=762.2009 | base/batch_time=0.0616 | base/data_time=0.0229 | base/lr=0.0001 | base/model_time=0.0387 | base/momentum=0.9000 | loss=28.3761 | map05=0.0011\r\n13/100 * Epoch (train): 100% 133/133 [00:06<00:00, 19.99it/s, _fps=783.159, loss=23.634, map05=0.000]\r\n13/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 16.25it/s, _fps=807.500, loss=26.013, map05=0.016]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) c\r\n[2019-03-21 10:21:55,990] \r\n13/100 * Epoch (train): _fps=760.6421 | base/batch_time=0.0461 | base/data_time=0.0051 | base/lr=0.0001 | base/model_time=0.0410 | base/momentum=0.9000 | loss=24.9090 | map05=0.0021\r\n13/100 * Epoch (valid): _fps=758.2683 | base/batch_time=0.0604 | base/data_time=0.0215 | base/lr=0.0001 | base/model_time=0.0389 | base/momentum=0.9000 | loss=27.9700 | map05=0.0011\r\n14/100 * Epoch (train): 100% 133/133 [00:06<00:00, 22.07it/s, _fps=770.857, loss=26.029, map05=0.000]\r\n14/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.66it/s, _fps=811.955, loss=25.584, map05=0.031]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) c\r\n[2019-03-21 10:22:08,043] \r\n14/100 * Epoch (train): _fps=762.4881 | base/batch_time=0.0452 | base/data_time=0.0042 | base/lr=0.0001 | base/model_time=0.0410 | base/momentum=0.9000 | loss=24.1805 | map05=0.0037\r\n14/100 * Epoch (valid): _fps=752.5557 | base/batch_time=0.0627 | base/data_time=0.0236 | base/lr=0.0001 | base/model_time=0.0391 | base/momentum=0.9000 | loss=27.5076 | map05=0.0022\r\n15/100 * Epoch (train): 100% 133/133 [00:06<00:00, 20.10it/s, _fps=760.488, loss=22.381, map05=0.000]\r\n15/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 16.09it/s, _fps=787.039, loss=25.456, map05=0.031]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) c\r\n[2019-03-21 10:22:20,274] \r\n15/100 * Epoch (train): _fps=754.6090 | base/batch_time=0.0455 | base/data_time=0.0044 | base/lr=0.0001 | base/model_time=0.0411 | base/momentum=0.9000 | loss=23.6162 | map05=0.0060\r\n15/100 * Epoch (valid): _fps=739.9028 | base/batch_time=0.0610 | base/data_time=0.0212 | base/lr=0.0001 | base/model_time=0.0398 | base/momentum=0.9000 | loss=27.1939 | map05=0.0033\r\n16/100 * Epoch (train): 100% 133/133 [00:06<00:00, 19.69it/s, _fps=778.896, loss=24.231, map05=0.000]\r\n16/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.89it/s, _fps=807.296, loss=24.941, map05=0.031]\r\n> /home/ngxbac/anaconda3/envs/general/lib/python3.6/site-packages/catalyst/dl/callbacks/base.py(83)save_checkpoint()\r\n-> last_item = self.top_best_metrics.pop(-1)\r\n(Pdb) c\r\n[2019-03-21 10:22:45,175] \r\n16/100 * Epoch (train): _fps=756.6095 | base/batch_time=0.0466 | base/data_time=0.0054 | base/lr=0.0001 | base/model_time=0.0412 | base/momentum=0.9000 | loss=23.0421 | map05=0.0070\r\n16/100 * Epoch (valid): _fps=749.7147 | base/batch_time=0.0618 | base/data_time=0.0225 | base/lr=0.0001 | base/model_time=0.0393 | base/momentum=0.9000 | loss=26.7421 | map05=0.0045\r\n17/100 * Epoch (train): 100% 133/133 [00:06<00:00, 19.92it/s, _fps=771.987, loss=23.759, map05=0.000]\r\n17/100 * Epoch (valid): 100% 14/14 [00:00<00:00, 15.72it/s, _fps=805.377, loss=24.638, map05=0.062]\r\n```\r\n\r\nCheckpoints folder: \r\n[Imgur](https://i.imgur.com/r8AQ3JC.png)  \r\n\r\n# Problem \r\nI found the problem is [here](https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/callbacks/base.py#L73) \r\n\r\n* From `epoch 0->11`: \r\n```\r\ncheckpoint_metric = 0\r\ncheckpoint_metric = checkpoint_metric or epoch\r\n=> checkpoint_metric = epoch \r\n```\r\ncheckpoint_metric now is a number greater than 1. \r\n\r\n* From `epoch > 11`: \r\n```\r\ncheckpoint_metric = 0.xxxx \r\ncheckpoint_metric = checkpoint_metric or epoch \r\n=> checkpoint_metric = 0.xxxx\r\n```\r\n\r\ncheckpoint_metric now is a float number less than 1 \r\n=> The next best checkpoints will be removed after sorting. \r\n\r\nFollowing is the log of `self.top_best_metrics` \r\n\r\n```\r\n[('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.11.pth', 11), ('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.10.pth', 10), ('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.9.pth', 9), ('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.8.pth', 8), ('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.7.pth', 7), ('/media/ngxbac/DATA/logs_aivivn/face-recognition/arcface/checkpoints//stage1.18.pth', 0.006324404761904762)]\r\n``` \r\n=> The last checkpoint is removed after \r\n```\r\n            last_item = self.top_best_metrics.pop(-1)\r\n            last_filepath = last_item[0]\r\n            os.remove(last_filepath)\r\n```","closed_by":{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/124/timeline","performed_via_github_app":null,"state_reason":"completed"}