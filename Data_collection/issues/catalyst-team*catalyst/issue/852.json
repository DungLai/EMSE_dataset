{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852/events","html_url":"https://github.com/catalyst-team/catalyst/issues/852","id":644156620,"node_id":"MDU6SXNzdWU2NDQxNTY2MjA=","number":852,"title":"Wrong global_epoch in Runner","user":{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-06-23T21:25:01Z","updated_at":"2020-06-25T08:46:19Z","closed_at":"2020-06-25T08:46:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## ðŸ› Bug Report\r\n\r\nWith `20.6` release (State -> Runner) `global_epoch` has the same value as epoch on a new stage.\r\nExpected that `global_epoch` will continue to increase.\r\nFor example if experiment has two stages - first with 10 epochs and second with 5 epochs, then value of `global_epoch` at the end of experiment should be a 15 (not 5).\r\n\r\n\r\n### How To Reproduce\r\n\r\nTo reproduce the issue please compare outputs in `20.5` and `20.6` versions:\r\n\r\n```python\r\nimport torch\r\nfrom torch.utils.data import DataLoader, TensorDataset\r\nfrom catalyst.dl import (\r\n    SupervisedRunner, Callback, CallbackOrder,\r\n    CriterionCallback,\r\n)\r\n\r\nclass PrinterCallback(Callback):\r\n    def __init__(self):\r\n        super().__init__(CallbackOrder.Internal)\r\n\r\n    def on_epoch_start(self, runner):\r\n        print(f\">> epoch - {runner.epoch}, global epoch - {runner.global_epoch}\")\r\n\r\n# experiment_setup\r\nlogdir = './remove_me_logs'\r\nnum_epochs = 5\r\n\r\n# data\r\nnum_samples, num_features = int(1e4), int(1e1)\r\nX = torch.rand(num_samples, num_features)\r\ny = torch.randint(0, 5, size=[num_samples])\r\ndataset = TensorDataset(X, y)\r\nloader = DataLoader(dataset, batch_size=32, num_workers=1)\r\nloaders = {\r\n    'train': loader,\r\n    'valid': loader,\r\n}\r\n\r\n# model, criterion, optimizer, scheduler\r\nmodel = torch.nn.Linear(num_features, 5)\r\ncriterion = torch.nn.CrossEntropyLoss()\r\noptimizer = torch.optim.Adam(model.parameters())\r\nrunner = SupervisedRunner()\r\n\r\n\r\n# first stage\r\nrunner.train(\r\n    model=model,\r\n    criterion=criterion,\r\n    optimizer=optimizer,\r\n    loaders=loaders,\r\n    logdir=logdir,\r\n    num_epochs=num_epochs,\r\n    verbose=False,\r\n    callbacks=[PrinterCallback()]\r\n)\r\n\r\n# second stage\r\nrunner.train(\r\n    model=model,\r\n    criterion=criterion,\r\n    optimizer=optimizer,\r\n    loaders=loaders,\r\n    logdir=logdir,\r\n    num_epochs=num_epochs,\r\n    verbose=False,\r\n    callbacks=[PrinterCallback()]\r\n)\r\n```\r\n\r\nOutput for `20.5`:\r\n\r\n```\r\n>> epoch - 1, global epoch - 1\r\n[2020-06-24 00:13:10,981] \r\n1/5 * Epoch 1 (_base): lr=0.0010 | momentum=0.9000\r\n1/5 * Epoch 1 (train): loss=1.6276\r\n1/5 * Epoch 1 (valid): loss=1.6183\r\n>> epoch - 2, global epoch - 2\r\n[2020-06-24 00:13:13,073] \r\n2/5 * Epoch 2 (_base): lr=0.0010 | momentum=0.9000\r\n2/5 * Epoch 2 (train): loss=1.6179\r\n2/5 * Epoch 2 (valid): loss=1.6159\r\n>> epoch - 3, global epoch - 3\r\n[2020-06-24 00:13:15,219] \r\n3/5 * Epoch 3 (_base): lr=0.0010 | momentum=0.9000\r\n3/5 * Epoch 3 (train): loss=1.6158\r\n3/5 * Epoch 3 (valid): loss=1.6140\r\n>> epoch - 4, global epoch - 4\r\n[2020-06-24 00:13:17,328] \r\n4/5 * Epoch 4 (_base): lr=0.0010 | momentum=0.9000\r\n4/5 * Epoch 4 (train): loss=1.6141\r\n4/5 * Epoch 4 (valid): loss=1.6126\r\n>> epoch - 5, global epoch - 5\r\n[2020-06-24 00:13:19,462] \r\n5/5 * Epoch 5 (_base): lr=0.0010 | momentum=0.9000\r\n5/5 * Epoch 5 (train): loss=1.6129\r\n5/5 * Epoch 5 (valid): loss=1.6115\r\nTop best models:\r\nremove_me_logs/checkpoints/train.5.pth  1.6115\r\n>> epoch - 1, global epoch - 6\r\n[2020-06-24 00:13:21,456] \r\n1/5 * Epoch 6 (_base): lr=0.0010 | momentum=0.9000\r\n1/5 * Epoch 6 (train): loss=1.6119\r\n1/5 * Epoch 6 (valid): loss=1.6106\r\n>> epoch - 2, global epoch - 7\r\n[2020-06-24 00:13:23,499] \r\n2/5 * Epoch 7 (_base): lr=0.0010 | momentum=0.9000\r\n2/5 * Epoch 7 (train): loss=1.6111\r\n2/5 * Epoch 7 (valid): loss=1.6099\r\n>> epoch - 3, global epoch - 8\r\n[2020-06-24 00:13:25,619] \r\n3/5 * Epoch 8 (_base): lr=0.0010 | momentum=0.9000\r\n3/5 * Epoch 8 (train): loss=1.6105\r\n3/5 * Epoch 8 (valid): loss=1.6094\r\n>> epoch - 4, global epoch - 9\r\n[2020-06-24 00:13:27,727] \r\n4/5 * Epoch 9 (_base): lr=0.0010 | momentum=0.9000\r\n4/5 * Epoch 9 (train): loss=1.6101\r\n4/5 * Epoch 9 (valid): loss=1.6090\r\n>> epoch - 5, global epoch - 10\r\n[2020-06-24 00:13:29,856] \r\n5/5 * Epoch 10 (_base): lr=0.0010 | momentum=0.9000\r\n5/5 * Epoch 10 (train): loss=1.6097\r\n5/5 * Epoch 10 (valid): loss=1.6087\r\nTop best models:\r\nremove_me_logs/checkpoints/train.5.pth  1.6087\r\n```\r\n\r\nOutput for `20.6`:\r\n\r\n```\r\n>> epoch - 1, global epoch - 1\r\n[2020-06-24 00:09:35,632] \r\n1/5 * Epoch 1 (_base): lr=0.0010 | momentum=0.9000\r\n1/5 * Epoch 1 (train): loss=1.6223\r\n1/5 * Epoch 1 (valid): loss=1.6174\r\n>> epoch - 2, global epoch - 2\r\n[2020-06-24 00:09:36,722] \r\n2/5 * Epoch 2 (_base): lr=0.0010 | momentum=0.9000\r\n2/5 * Epoch 2 (train): loss=1.6170\r\n2/5 * Epoch 2 (valid): loss=1.6151\r\n>> epoch - 3, global epoch - 3\r\n[2020-06-24 00:09:37,793] \r\n3/5 * Epoch 3 (_base): lr=0.0010 | momentum=0.9000\r\n3/5 * Epoch 3 (train): loss=1.6150\r\n3/5 * Epoch 3 (valid): loss=1.6133\r\n>> epoch - 4, global epoch - 4\r\n[2020-06-24 00:09:38,842] \r\n4/5 * Epoch 4 (_base): lr=0.0010 | momentum=0.9000\r\n4/5 * Epoch 4 (train): loss=1.6134\r\n4/5 * Epoch 4 (valid): loss=1.6120\r\n>> epoch - 5, global epoch - 5\r\n[2020-06-24 00:09:39,907] \r\n5/5 * Epoch 5 (_base): lr=0.0010 | momentum=0.9000\r\n5/5 * Epoch 5 (train): loss=1.6122\r\n5/5 * Epoch 5 (valid): loss=1.6109\r\nTop best models:\r\nremove_me_logs/checkpoints/train.5.pth  1.6109\r\n>> epoch - 1, global epoch - 1\r\n[2020-06-24 00:09:40,967] \r\n1/5 * Epoch 1 (_base): lr=0.0010 | momentum=0.9000\r\n1/5 * Epoch 1 (train): loss=1.6112\r\n1/5 * Epoch 1 (valid): loss=1.6100\r\n>> epoch - 2, global epoch - 2\r\n[2020-06-24 00:09:42,000] \r\n2/5 * Epoch 2 (_base): lr=0.0010 | momentum=0.9000\r\n2/5 * Epoch 2 (train): loss=1.6104\r\n2/5 * Epoch 2 (valid): loss=1.6094\r\n>> epoch - 3, global epoch - 3\r\n[2020-06-24 00:09:43,091] \r\n3/5 * Epoch 3 (_base): lr=0.0010 | momentum=0.9000\r\n3/5 * Epoch 3 (train): loss=1.6099\r\n3/5 * Epoch 3 (valid): loss=1.6089\r\n>> epoch - 4, global epoch - 4\r\n[2020-06-24 00:09:44,131] \r\n4/5 * Epoch 4 (_base): lr=0.0010 | momentum=0.9000\r\n4/5 * Epoch 4 (train): loss=1.6094\r\n4/5 * Epoch 4 (valid): loss=1.6085\r\n>> epoch - 5, global epoch - 5\r\n[2020-06-24 00:09:45,171] \r\n5/5 * Epoch 5 (_base): lr=0.0010 | momentum=0.9000\r\n5/5 * Epoch 5 (train): loss=1.6090\r\n5/5 * Epoch 5 (valid): loss=1.6081\r\nTop best models:\r\nremove_me_logs/checkpoints/train.5.pth  1.6081\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nExpected that after first stage global epoch counter will increase.\r\n","closed_by":{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/852/timeline","performed_via_github_app":null,"state_reason":"completed"}