{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833/events","html_url":"https://github.com/catalyst-team/catalyst/issues/833","id":629868507,"node_id":"MDU6SXNzdWU2Mjk4Njg1MDc=","number":833,"title":"Custom collate_fn doesn't work in distributed environment","user":{"login":"vinnamkim","id":26541465,"node_id":"MDQ6VXNlcjI2NTQxNDY1","avatar_url":"https://avatars.githubusercontent.com/u/26541465?v=4","gravatar_id":"","url":"https://api.github.com/users/vinnamkim","html_url":"https://github.com/vinnamkim","followers_url":"https://api.github.com/users/vinnamkim/followers","following_url":"https://api.github.com/users/vinnamkim/following{/other_user}","gists_url":"https://api.github.com/users/vinnamkim/gists{/gist_id}","starred_url":"https://api.github.com/users/vinnamkim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vinnamkim/subscriptions","organizations_url":"https://api.github.com/users/vinnamkim/orgs","repos_url":"https://api.github.com/users/vinnamkim/repos","events_url":"https://api.github.com/users/vinnamkim/events{/privacy}","received_events_url":"https://api.github.com/users/vinnamkim/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"},{"id":1029400277,"node_id":"MDU6TGFiZWwxMDI5NDAwMjc3","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2020-06-03T10:09:46Z","updated_at":"2021-03-30T08:05:30Z","closed_at":"2021-03-30T08:05:30Z","author_association":"NONE","active_lock_reason":null,"body":"## üêõ Bug Report\r\nIf `distributed=True`, custom `collate_fn` for `DataLoader` turns into `default_collate`.\r\n\r\n### How To Reproduce\r\nSteps to reproduce the behavior:\r\n1. Train `SupervisedRunner` with custom `collate_fn` and `distributed=True`.\r\n```\r\nrunner.train(\r\n    model=model,\r\n    criterion=criterion,\r\n    optimizer=optimizer,\r\n    scheduler=scheduler,\r\n    datasets={\r\n        'batch_size': 24,\r\n        'num_workers': 8,\r\n        'get_datasets_fn': get_datasets,\r\n        'loaders_params': {\r\n            'train': {\r\n                'collate_fn': data_collector.collate_batch\r\n            },\r\n            'valid': {\r\n                'collate_fn': data_collector.collate_batch\r\n            }\r\n        }\r\n    },\r\n    fp16=True,\r\n    distributed=True,\r\n)\r\n```\r\n2. Get error msg\r\n```\r\nTraceback (most recent call last):\r\n  File \"train_mlm.py\", line 92, in <module>\r\n    runner.train(\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/dl/runner/core.py\", line 156, in train\r\n    utils.distributed_cmd_run(self.run_experiment, distributed)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/utils/scripts.py\", line 137, in distributed_cmd_run\r\n    worker_fn(*args, **kwargs)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 525, in run_experiment\r\n    self._run_event(\"on_exception\")\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 330, in _run_event\r\n    getattr(callback, event)(self.state)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/callbacks/exception.py\", line 20, in on_exception\r\n    raise exception\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 512, in run_experiment\r\n    self._run_stage(stage)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 488, in _run_stage\r\n    self._run_epoch(stage=stage, epoch=state.epoch)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 465, in _run_epoch\r\n    self._run_loader(loader)\r\n  File \"/home/kl_reasoning/vinnamkim/catalyst/catalyst/core/runner.py\", line 399, in _run_loader\r\n    for i, batch in enumerate(loader):\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/dataloader.py\", line 345, in __next__\r\n    data = self._next_data()\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/dataloader.py\", line 856, in _next_data\r\n    return self._process_data(data)\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/dataloader.py\", line 881, in _process_data\r\n    data.reraise()\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/_utils.py\", line 395, in reraise\r\n    raise self.exc_type(msg)\r\nRuntimeError: Caught RuntimeError in DataLoader worker process 0.\r\nOriginal Traceback (most recent call last):\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/_utils/worker.py\", line 178, in _worker_loop\r\n    data = fetcher.fetch(index)\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/_utils/fetch.py\", line 47, in fetch\r\n    return self.collate_fn(data)\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/torch/utils/data/_utils/collate.py\", line 55, in default_collate\r\n    return torch.stack(batch, 0, out=out)\r\n  File \"/home/kl_reasoning/swjang90/anaconda3/envs/vinnamkim/lib/python3.8/site-packages/apex/amp/wrap.py\", line 81, in wrapper\r\n    return orig_fn(seq, *args, **kwargs)\r\nRuntimeError: stack expects each tensor to be equal size, but got [495] at entry 0 and [178] at entry 1\r\n```\r\n\r\n### Environment\r\nCatalyst version: 20.05.1\r\nPyTorch version: 1.5.0+cu101\r\nIs debug build: No\r\nCUDA used to build PyTorch: 10.1\r\nTensorFlow version: 2.2.0-rc2\r\nTensorBoard version: 2.2.0\r\nOS: Ubuntu 18.04.3 LTS\r\nGCC version: (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0\r\nCMake version: version 3.13.3\r\nPython version: 3.8\r\nIs CUDA available: Yes\r\nCUDA runtime version: 10.1.168\r\nNvidia driver version: 418.116.00\r\ncuDNN version: Could not collect\r\n\r\n\r\n### Additional context\r\nThis is happened by the comment when forcing to make distributed loader. Is there any reason not to pass `loader.collate_fn` for distributed loader?\r\n\r\nhttps://github.com/catalyst-team/catalyst/blob/d1d8f4d30cefeaeaac3f4dcb50242fd1f72e82c8/catalyst/core/utils/data.py#L36","closed_by":{"login":"vinnamkim","id":26541465,"node_id":"MDQ6VXNlcjI2NTQxNDY1","avatar_url":"https://avatars.githubusercontent.com/u/26541465?v=4","gravatar_id":"","url":"https://api.github.com/users/vinnamkim","html_url":"https://github.com/vinnamkim","followers_url":"https://api.github.com/users/vinnamkim/followers","following_url":"https://api.github.com/users/vinnamkim/following{/other_user}","gists_url":"https://api.github.com/users/vinnamkim/gists{/gist_id}","starred_url":"https://api.github.com/users/vinnamkim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vinnamkim/subscriptions","organizations_url":"https://api.github.com/users/vinnamkim/orgs","repos_url":"https://api.github.com/users/vinnamkim/repos","events_url":"https://api.github.com/users/vinnamkim/events{/privacy}","received_events_url":"https://api.github.com/users/vinnamkim/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/833/timeline","performed_via_github_app":null,"state_reason":"completed"}