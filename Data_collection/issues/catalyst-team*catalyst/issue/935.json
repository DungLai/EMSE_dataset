{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935/events","html_url":"https://github.com/catalyst-team/catalyst/issues/935","id":696105629,"node_id":"MDU6SXNzdWU2OTYxMDU2Mjk=","number":935,"title":"How to make QueryGallery Dataset from Pytorch ImageFolder","user":{"login":"ohernpaul","id":13112890,"node_id":"MDQ6VXNlcjEzMTEyODkw","avatar_url":"https://avatars.githubusercontent.com/u/13112890?v=4","gravatar_id":"","url":"https://api.github.com/users/ohernpaul","html_url":"https://github.com/ohernpaul","followers_url":"https://api.github.com/users/ohernpaul/followers","following_url":"https://api.github.com/users/ohernpaul/following{/other_user}","gists_url":"https://api.github.com/users/ohernpaul/gists{/gist_id}","starred_url":"https://api.github.com/users/ohernpaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ohernpaul/subscriptions","organizations_url":"https://api.github.com/users/ohernpaul/orgs","repos_url":"https://api.github.com/users/ohernpaul/repos","events_url":"https://api.github.com/users/ohernpaul/events{/privacy}","received_events_url":"https://api.github.com/users/ohernpaul/received_events","type":"User","site_admin":false},"labels":[{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"},{"id":1029400276,"node_id":"MDU6TGFiZWwxMDI5NDAwMjc2","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/question","name":"question","color":"d876e3","default":true,"description":"Further information is requested"}],"state":"closed","locked":false,"assignee":{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false},"assignees":[{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-09-08T19:00:33Z","updated_at":"2020-10-04T08:23:23Z","closed_at":"2020-10-04T08:22:47Z","author_association":"NONE","active_lock_reason":null,"body":"## â“ Questions and Help\r\n\r\n#### What is your question?\r\nWhat is the correct way of making a QueryGallery Dataset from Pytorch ImageFolder Dataset? \r\n\r\nThe reason I ask is because the MNIST example isn't necessarily the same. \r\n\r\nI am confused by the mnist test dataset being preshuffled and having the gallery images randomly assigned to the last 20%. It seems there's no guarantee that each class will be assigned a gallery image. Please correct me if my understanding is incorrect. \r\n\r\n#### Code\r\nMy attempted class:\r\n`\r\nclass HandsQGDataset(QueryGalleryDataset):\r\n    \r\n    def __init__(self, path, transform=None, gallery_fraq=0.2):\r\n        self.path = path\r\n        self.transform = transform\r\n        \r\n        #self.shuf_ds = ShuffledImageFolder(self.path, self.transform)\r\n        self.shuf_ds = ImageFolder(self.path, transform = self.transform)\r\n        \r\n        self.gallery_fraq = gallery_fraq\r\n        \r\n        self._gallery_size = int(self.gallery_fraq * len(self.shuf_ds))\r\n        self._query_size = len(self.shuf_ds) - self._gallery_size\r\n        \r\n        self._is_query = torch.zeros(len(self.shuf_ds)).type(torch.bool)\r\n        self._is_query[: self._query_size] = True\r\n        \r\n        \r\n    def __getitem__(self, idx: int):\r\n        \"\"\"\r\n        Get item method for dataset\r\n\r\n\r\n        Args:\r\n            idx: index of the object\r\n\r\n        Returns:\r\n            Dict with features, targets and is_query flag\r\n        \"\"\"\r\n        image, label = self.shuf_ds[idx]\r\n        return {\r\n            \"features\": image,\r\n            \"targets\": label,\r\n            \"is_query\": self._is_query[idx],\r\n        }\r\n    \r\n    def __len__(self) -> int:\r\n        \"\"\"Length\"\"\"\r\n        return len(self.shuf_ds)\r\n\r\n    @property\r\n    def gallery_size(self) -> int:\r\n        \"\"\"Query Gallery dataset should have gallery_size property\"\"\"\r\n        return self._gallery_size\r\n\r\n    @property\r\n    def query_size(self) -> int:\r\n        \"\"\"Query Gallery dataset should have query_size property\"\"\"\r\n        return self._query_size\r\n        \r\n`\r\n\r\nI have also tried to create a custom preshuffled image dataset that is called by HandsQGDataset\r\n\r\n`\r\nclass ShuffledImageFolder(Dataset):\r\n    \r\n    def getImgsLabs(self):\r\n        t = list(iter(os.walk(self.path, topdown=False)))\r\n        \r\n        out = [[''.join([t[i][0] + '/', t[i][2][0]]),int(t[i][0].split('/')[-1])] \\\r\n               for i in range(len(t)) for j in range(len(t[i][2])) \\\r\n               if 'ipy' not in t[i][0]]\r\n        \r\n        np.random.shuffle(out)\r\n        \r\n        return out\r\n    \r\n    def loadImg(self, file_path):\r\n        return io.imread(file_path)\r\n    \r\n    def __init__(self, path, transform=None):\r\n        self.path = path\r\n        self.transform = transform\r\n        \r\n        self._ds = self.getImgsLabs()\r\n        \r\n    def __getitem__(self, idx):\r\n        path, lab = self._ds[idx]\r\n        img = self.loadImg(path)\r\n        \r\n        if self.transform is not None:\r\n            img = self.transform(img)\r\n        \r\n        return img, lab\r\n    \r\n    def __len__(self):\r\n        return len(self._ds)\r\n        \r\n`\r\n\r\n#### What's your environment?\r\nCatalyst version: 20.8.2\r\nPyTorch version: 1.1.0\r\nTensorFlow version: N/A\r\nTensorBoard version: 2.1.0\r\nOS: Mac OSX 10.15.5\r\nPython version: 3.7\r\n```\r\n\r\n\r\n### Additional context\r\nThe training behavior seems correct and the loss decreases, but in Validation with cmc01 while the dataset has not been shuffled, I continually get a value of 0.0152\r\n\r\niI Validation with cmc01 while the dataset has been shuffled, I continually get a value of 1.00\r\n\r\n![image](https://user-images.githubusercontent.com/13112890/92516971-30f55780-f1d3-11ea-887b-7da7ecbdfddc.png)\r\n\r\n","closed_by":{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/935/timeline","performed_via_github_app":null,"state_reason":"completed"}