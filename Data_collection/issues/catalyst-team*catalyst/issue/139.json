{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139/events","html_url":"https://github.com/catalyst-team/catalyst/issues/139","id":431330479,"node_id":"MDU6SXNzdWU0MzEzMzA0Nzk=","number":139,"title":"Segmentation quickstartnotebook: TypeError: tensor is not a torch image.","user":{"login":"Diyago","id":8073766,"node_id":"MDQ6VXNlcjgwNzM3NjY=","avatar_url":"https://avatars.githubusercontent.com/u/8073766?v=4","gravatar_id":"","url":"https://api.github.com/users/Diyago","html_url":"https://github.com/Diyago","followers_url":"https://api.github.com/users/Diyago/followers","following_url":"https://api.github.com/users/Diyago/following{/other_user}","gists_url":"https://api.github.com/users/Diyago/gists{/gist_id}","starred_url":"https://api.github.com/users/Diyago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diyago/subscriptions","organizations_url":"https://api.github.com/users/Diyago/orgs","repos_url":"https://api.github.com/users/Diyago/repos","events_url":"https://api.github.com/users/Diyago/events{/privacy}","received_events_url":"https://api.github.com/users/Diyago/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-04-10T06:45:05Z","updated_at":"2019-04-19T06:54:22Z","closed_at":"2019-04-19T06:54:22Z","author_association":"NONE","active_lock_reason":null,"body":"I have several png images with corresponding masks:\r\nGetting data:\r\n``` python\r\ndata_dir = './data_objects'\r\n\r\ndef load_data(root_dir):\r\n    data = []\r\n\r\n    for stage in ['train']:\r\n        for content in ['images', 'segmentation']:\r\n            \r\n            # construct path to each image\r\n            directory = os.path.join(root_dir,  content)\r\n            fps = [os.path.join(directory, filename) for filename in os.listdir(directory)]\r\n\r\n            # read images\r\n\r\n            images = [imread(filepath) for filepath in fps]\r\n \r\n            # if images have different sizes you have to resize them before:\r\n            resized_images = [resize(image, (64, 64)) for image in images]\r\n            \r\n            # stack to one np.array \r\n            np_images = np.stack(resized_images, axis=0)\r\n            \r\n            data.append(np_images)\r\n            \r\n    return data\r\nx_train, y_train  = load_data(data_dir)\r\ny_train = y_train.reshape(19, 64, 64, 1)\r\n```\r\nMaking data looks like in the example notebook:\r\n``` python\r\nx_train, X_test, y_train, y_test = train_test_split(\r\n         x_train, y_train, test_size=0.33, random_state=42)\r\n\r\ntrain_data = list(zip(x_train, y_train))\r\nvalid_data = list(zip(X_test, y_test))\r\n```\r\n> train_data[0][0].shape, train_data[0][1].shape, len(train_data)\r\n(64, 64, 3), (64, 64, 1), 12\r\n\r\nCalling `train` returns error:\r\n\r\n```\r\n0/10 * Epoch (train):   0% 0/3 [00:00<?, ?it/s]\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-43-69a57e657d9d> in <module>()\r\n     26     logdir=logdir,\r\n     27     num_epochs=num_epochs,\r\n---> 28     verbose=True\r\n     29 )\r\n\r\n~/anaconda3/lib/python3.6/site-packages/catalyst/dl/experiments/runner.py in train(self, model, criterion, optimizer, loaders, logdir, callbacks, scheduler, num_epochs, valid_loader, main_metric, minimize_metric, verbose, state_kwargs, check)\r\n    269             state_kwargs=state_kwargs\r\n    270         )\r\n--> 271         self.run_experiment(experiment, check=check)\r\n    272 \r\n    273     def infer(\r\n\r\n~/anaconda3/lib/python3.6/site-packages/catalyst/dl/experiments/runner.py in run_experiment(self, experiment, check)\r\n    192         self.experiment = experiment\r\n    193         for stage in self.experiment.stages:\r\n--> 194             self._run_stage(stage)\r\n    195         return self\r\n    196 \r\n\r\n~/anaconda3/lib/python3.6/site-packages/catalyst/dl/experiments/runner.py in _run_stage(self, stage)\r\n    173 \r\n    174             self._run_event(\"epoch_start\")\r\n--> 175             self._run_epoch(loaders)\r\n    176             self._run_event(\"epoch_end\")\r\n    177 \r\n\r\n~/anaconda3/lib/python3.6/site-packages/catalyst/dl/experiments/runner.py in _run_epoch(self, loaders)\r\n    158             self._run_event(\"loader_start\")\r\n    159             with torch.set_grad_enabled(self.state.need_backward):\r\n--> 160                 self._run_loader(loaders[loader_name])\r\n    161             self._run_event(\"loader_end\")\r\n    162 \r\n\r\n~/anaconda3/lib/python3.6/site-packages/catalyst/dl/experiments/runner.py in _run_loader(self, loader)\r\n    119         self.state.timer.start(\"base/data_time\")\r\n    120 \r\n--> 121         for i, batch in enumerate(loader):\r\n    122             batch = self._batch2device(batch, self.device)\r\n    123             self.state.timer.stop(\"base/data_time\")\r\n\r\n~/anaconda3/lib/python3.6/site-packages/torch/utils/data/dataloader.py in __next__(self)\r\n    635                 self.reorder_dict[idx] = batch\r\n    636                 continue\r\n--> 637             return self._process_next_batch(batch)\r\n    638 \r\n    639     next = __next__  # Python 2 compatibility\r\n\r\n~/anaconda3/lib/python3.6/site-packages/torch/utils/data/dataloader.py in _process_next_batch(self, batch)\r\n    656         self._put_indices()\r\n    657         if isinstance(batch, ExceptionWrapper):\r\n--> 658             raise batch.exc_type(batch.exc_msg)\r\n    659         return batch\r\n    660 \r\n\r\nTypeError: Traceback (most recent call last):\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 138, in _worker_loop\r\n    samples = collate_fn([dataset[i] for i in batch_indices])\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 138, in <listcomp>\r\n    samples = collate_fn([dataset[i] for i in batch_indices])\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/catalyst/data/dataset.py\", line 74, in __getitem__\r\n    dict_ = self.dict_transform(dict_)\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/torchvision-0.2.0-py3.6.egg/torchvision/transforms/transforms.py\", line 42, in __call__\r\n    img = t(img)\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/catalyst/data/augmentor.py\", line 25, in __call__\r\n    ] = self.augment_fn(dict_[self.dict_key], **self.default_kwargs)\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/torchvision-0.2.0-py3.6.egg/torchvision/transforms/transforms.py\", line 118, in __call__\r\n    return F.normalize(tensor, self.mean, self.std)\r\n  File \"/home/dex/anaconda3/lib/python3.6/site-packages/torchvision-0.2.0-py3.6.egg/torchvision/transforms/functional.py\", line 158, in normalize\r\n    raise TypeError('tensor is not a torch image.')\r\nTypeError: tensor is not a torch image.\r\n```\r\n\r\nThen I tried adding more transforms, but failed to fix that problem, for example something like this:\r\n\r\n``` python\r\ndata_transform = transforms.Compose([\r\n    Augmentor(\r\n        dict_key=\"features\",\r\n        augment_fn=lambda x: \\\r\n            torch.from_numpy(x.copy().astype(np.float32) / 255.).unsqueeze_(0)),\r\n    Augmentor(\r\n        dict_key=\"features\",\r\n        augment_fn=transforms.ToPILImage()),  #transforms.ToTensor()),\r\n    Augmentor(\r\n        dict_key=\"features\",\r\n        augment_fn=transforms.Normalize(\r\n            (0.5, 0.5, 0.5),\r\n            (0.5, 0.5, 0.5))),\r\n    Augmentor(\r\n        dict_key=\"targets\",\r\n        augment_fn=lambda x: \\\r\n            torch.from_numpy(x.copy().astype(np.float32) / 255.).unsqueeze_(0)),\r\n    Augmentor(\r\n        dict_key=\"targets\",\r\n        augment_fn= transforms.ToPILImage())#transforms.ToTensor())\r\n])\r\n```\r\n\r\nWhat is wrong here?","closed_by":{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/139/timeline","performed_via_github_app":null,"state_reason":"completed"}