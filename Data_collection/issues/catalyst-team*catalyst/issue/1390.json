{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390/events","html_url":"https://github.com/catalyst-team/catalyst/issues/1390","id":1092490485,"node_id":"I_kwDOCKpmxM5BHhT1","number":1390,"title":"FunctionalBatchMetric doesn't pass batch size to BatchMetricCallback","user":{"login":"MartSlaaf","id":1595440,"node_id":"MDQ6VXNlcjE1OTU0NDA=","avatar_url":"https://avatars.githubusercontent.com/u/1595440?v=4","gravatar_id":"","url":"https://api.github.com/users/MartSlaaf","html_url":"https://github.com/MartSlaaf","followers_url":"https://api.github.com/users/MartSlaaf/followers","following_url":"https://api.github.com/users/MartSlaaf/following{/other_user}","gists_url":"https://api.github.com/users/MartSlaaf/gists{/gist_id}","starred_url":"https://api.github.com/users/MartSlaaf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MartSlaaf/subscriptions","organizations_url":"https://api.github.com/users/MartSlaaf/orgs","repos_url":"https://api.github.com/users/MartSlaaf/repos","events_url":"https://api.github.com/users/MartSlaaf/events{/privacy}","received_events_url":"https://api.github.com/users/MartSlaaf/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"},{"id":1029400277,"node_id":"MDU6TGFiZWwxMDI5NDAwMjc3","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false},"assignees":[{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-01-03T13:00:18Z","updated_at":"2022-03-19T21:53:39Z","closed_at":"2022-03-19T21:53:39Z","author_association":"NONE","active_lock_reason":null,"body":"## üêõ Bug Report\r\n`FunctionalBatchMetric` wrapped with `BatchMetricCallback` fails to pass actual inputs to functions. Because `FunctionalBatchMetric.update_key_value` at [_functional_metric.py#L84](https://github.com/catalyst-team/catalyst/blob/678dc06eda1848242df010b7f34adb572def2598/catalyst/metrics/_functional_metric.py#L84) expects `batc_size` as the first argument, but `BatchMetricCallback. _update_value_metric` at [metric.py#L166](https://github.com/catalyst-team/catalyst/blob/678dc06eda1848242df010b7f34adb572def2598/catalyst/callbacks/metric.py#L166) fails to provide it.\r\n\r\n\r\n### How To Reproduce\r\nSteps to reproduce the behavior:\r\n1. Define custom metric function computed from predictions and targets\r\n2. Wrap it with `FunctionalBatchMetric`\r\n3. Wrap the result with `BatchMetricCallback`\r\n4. Pass it to the runner as callback.\r\n\r\n<!-- If you have a code sample, error messages, stack traces, please provide it here as well --> \r\n\r\n\r\n#### Code sample\r\n```python\r\nfrom torch.utils.data import TensorDataset, DataLoader\r\nfrom torch import nn, optim, FloatTensor\r\nimport numpy as np\r\nfrom sklearn.model_selection import train_test_split\r\nfrom catalyst.runners.runner import SupervisedRunner\r\nfrom catalyst.metrics._functional_metric import FunctionalBatchMetric\r\nfrom catalyst.callbacks.metric import BatchMetricCallback\r\n\r\n# Defining metric\r\n\r\ndef custom_metric_function(prediction, label):\r\n    return ((prediction - label)**2).mean()\r\nmetric = FunctionalBatchMetric(metric_fn=custom_metric_function, metric_key='custom')\r\ncallback = BatchMetricCallback(metric=metric, input_key='logits', target_key='targets')\r\n\r\n# Generating dataset\r\n\r\nX = np.random.randn(1_000, 10)\r\ny = X.sum(1)\r\n\r\ntrain_X, test_X, train_y, test_y = train_test_split(X, y)\r\n\r\ntrain_set = TensorDataset(FloatTensor(train_X), FloatTensor(train_y))\r\ntest_set = TensorDataset(FloatTensor(test_X), FloatTensor(test_y))\r\n\r\ntrain_loader = DataLoader(train_set, batch_size=32)\r\ntest_loader = DataLoader(test_set, batch_size=32)\r\n\r\n# Initializing model, criterion and optimizer\r\n\r\nmodel = nn.Linear(10, 1)\r\ncriterion = nn.MSELoss()\r\noptimizer = optim.Adam(model.parameters())\r\n\r\n# Getting error\r\n\r\nrunner = SupervisedRunner()\r\nrunner.train(model=model,\r\n             loaders={'train': train_loader, 'valid': test_loader},\r\n             criterion=criterion, \r\n             optimizer=optimizer, \r\n             callbacks=[callback],\r\n             verbose=True)\r\n```\r\n\r\n### Expected behavior\r\nI expect it to work.\r\nI guess, either in callback or in metric batch size should be derived from the input lengths?\r\n\r\n\r\n### Environment\r\nPlease copy and paste the output from our environment collection script\r\n```\r\nCatalyst version: 21.12\r\nPyTorch version: 1.10.0+cu113\r\nIs debug build: No\r\nCUDA used to build PyTorch: 11.3\r\nTensorFlow version: N/A\r\nTensorBoard version: 2.7.0\r\n\r\nOS: Ubuntu 20.04.3 LTS\r\nGCC version: (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0\r\nCMake version: version 3.16.3\r\n\r\nPython version: 3.9\r\nIs CUDA available: Yes\r\nCUDA runtime version: Could not collect\r\nGPU models and configuration:\r\nGPU 0: NVIDIA RTX A5000\r\nGPU 1: NVIDIA RTX A5000\r\nGPU 2: NVIDIA RTX A5000\r\nGPU 3: NVIDIA RTX A5000\r\n\r\nNvidia driver version: 495.29.05\r\ncuDNN version: Could not collect\r\n\r\nVersions of relevant libraries:\r\n[pip3] catalyst==21.12\r\n[pip3] efficientnet-pytorch==0.6.3\r\n[pip3] numpy==1.20.3\r\n[pip3] numpydoc==1.1.0\r\n[pip3] segmentation-losses-pytorch==0.0.1\r\n[pip3] segmentation-models-pytorch==0.2.1\r\n[pip3] tensorboard==2.7.0\r\n[pip3] tensorboard-data-server==0.6.1\r\n[pip3] tensorboard-plugin-wit==1.8.0\r\n[pip3] tensorboardX==2.2\r\n[pip3] torch==1.10.0+cu113\r\n[pip3] torchaudio==0.10.0+cu113\r\n[pip3] torchvision==0.11.1+cu113\r\n[conda] blas                      1.0                         mkl\r\n[conda] catalyst                  21.12                    pypi_0    pypi\r\n[conda] efficientnet-pytorch      0.6.3                    pypi_0    pypi\r\n[conda] mkl                       2021.4.0           h06a4308_640\r\n[conda] mkl-service               2.4.0            py39h7f8727e_0\r\n[conda] mkl_fft                   1.3.1            py39hd3c417c_0\r\n[conda] mkl_random                1.2.2            py39h51133e4_0\r\n[conda] numpy                     1.20.3           py39hf144106_0\r\n[conda] numpy-base                1.20.3           py39h74d4b33_0\r\n[conda] numpydoc                  1.1.0              pyhd3eb1b0_1\r\n[conda] segmentation-losses-pytorch 0.0.1                    pypi_0    pypi\r\n[conda] segmentation-models-pytorch 0.2.1                    pypi_0    pypi\r\n[conda] tensorboard               2.7.0                    pypi_0    pypi\r\n[conda] tensorboard-data-server   0.6.1                    pypi_0    pypi\r\n[conda] tensorboard-plugin-wit    1.8.0                    pypi_0    pypi\r\n[conda] tensorboardx              2.2                      pypi_0    pypi\r\n[conda] torch                     1.10.0+cu113             pypi_0    pypi\r\n[conda] torchaudio                0.10.0+cu113             pypi_0    pypi\r\n[conda] torchvision               0.11.1+cu113             pypi_0    pypi\r\n```\r\n\r\n### Checklist\r\n- [x] bug description\r\n- [x] steps to reproduce\r\n- [x] expected behavior\r\n- [x] environment\r\n- [x] code sample / screenshots\r\n  \r\n### FAQ\r\nPlease review the FAQ before submitting an issue:\r\n- [x] I have read the [documentation and FAQ](https://catalyst-team.github.io/catalyst/)\r\n- [x] I have reviewed the [minimal examples section](https://github.com/catalyst-team/catalyst#minimal-examples)\r\n- [x] I have checked the [changelog](https://github.com/catalyst-team/catalyst/blob/master/CHANGELOG.md) for main framework updates\r\n- [x] I have read the [contribution guide](https://github.com/catalyst-team/catalyst/blob/master/CONTRIBUTING.md)\r\n- [ ] I have joined [Catalyst slack (#__questions channel)](https://join.slack.com/t/catalyst-team-core/shared_invite/zt-d9miirnn-z86oKDzFMKlMG4fgFdZafw) for issue discussion\r\n","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1390/timeline","performed_via_github_app":null,"state_reason":"completed"}