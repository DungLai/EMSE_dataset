{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155/events","html_url":"https://github.com/catalyst-team/catalyst/issues/1155","id":848030273,"node_id":"MDU6SXNzdWU4NDgwMzAyNzM=","number":1155,"title":"HitrateMetric returns wrong results","user":{"login":"vinnamkim","id":26541465,"node_id":"MDQ6VXNlcjI2NTQxNDY1","avatar_url":"https://avatars.githubusercontent.com/u/26541465?v=4","gravatar_id":"","url":"https://api.github.com/users/vinnamkim","html_url":"https://github.com/vinnamkim","followers_url":"https://api.github.com/users/vinnamkim/followers","following_url":"https://api.github.com/users/vinnamkim/following{/other_user}","gists_url":"https://api.github.com/users/vinnamkim/gists{/gist_id}","starred_url":"https://api.github.com/users/vinnamkim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vinnamkim/subscriptions","organizations_url":"https://api.github.com/users/vinnamkim/orgs","repos_url":"https://api.github.com/users/vinnamkim/repos","events_url":"https://api.github.com/users/vinnamkim/events{/privacy}","received_events_url":"https://api.github.com/users/vinnamkim/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"}],"state":"closed","locked":false,"assignee":{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false},"assignees":[{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2021-04-01T06:20:28Z","updated_at":"2021-04-17T06:12:33Z","closed_at":"2021-04-17T06:12:33Z","author_association":"NONE","active_lock_reason":null,"body":"## ðŸ› Bug Report\r\n\r\n### How To Reproduce\r\n#### Code sample\r\n```\r\nimport torch\r\nfrom catalyst.metrics import HitrateMetric\r\n\r\nmetric = HitrateMetric(topk_args=(1, 10, 20))\r\n\r\nlogits = torch.randn([10, 100])\r\ntargets = torch.zeros_like(logits)\r\ntargets[:, 0] = 1.0\r\n\r\nprint(metric.update_key_value(logits, targets))\r\n```\r\n\r\n#### Results\r\nOccasionally, it returns ```hitrate@{x1} > hitrate@{x2}``` for ```x1 < x2```.\r\n```\r\n{'hitrate01': 0.0, 'hitrate10': 0.030000001192092896, 'hitrate20': 0.019999999552965164, 'hitrate': 0.0}\r\n```\r\n\r\n\r\n### Expected behavior\r\nHitrate should returns ```hitrate{x1} < hitrate{x2}``` for every ```x1 < x2```.\r\n\r\n### Environment\r\n```\r\nCollecting environment information...\r\nCatalyst version: 21.03.2\r\nPyTorch version: 1.7.1+cu110\r\nIs debug build: No\r\nCUDA used to build PyTorch: 11.0\r\nTensorFlow version: 2.2.0-rc2\r\nTensorBoard version: 2.2.0\r\n\r\nOS: Ubuntu 18.04.5 LTS\r\nGCC version: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0\r\nCMake version: version 3.19.4\r\n\r\nPython version: 3.8\r\nIs CUDA available: Yes\r\nCUDA runtime version: Could not collect\r\nGPU models and configuration: GPU 0: GeForce RTX 2080 Ti\r\nNvidia driver version: 450.102.04\r\ncuDNN version: Could not collect\r\n\r\nVersions of relevant libraries:\r\n[pip] catalyst==21.3.2\r\n[pip] gpytorch==1.0.1\r\n[pip] numpy==1.18.1\r\n[pip] pytorch-nlp==0.5.0\r\n[pip] tensorboard==2.2.0\r\n[pip] tensorboard-plugin-wit==1.6.0.post2\r\n[pip] tensorboardX==2.1\r\n[pip] tensorflow==2.2.0rc2\r\n[pip] tensorflow-datasets==2.1.0\r\n[pip] tensorflow-estimator==2.2.0rc0\r\n[pip] tensorflow-metadata==0.21.1\r\n[pip] torch==1.7.1+cu110\r\n[pip] torchaudio==0.7.2\r\n[pip] torchvision==0.8.2+cu110\r\n[conda] blas                      1.0                         mkl  \r\n[conda] catalyst                  21.3.2                   pypi_0    pypi\r\n[conda] cudatoolkit               10.1.243             h6bb024c_0  \r\n[conda] gpytorch                  1.0.1                    pypi_0    pypi\r\n[conda] mkl                       2020.2                      256  \r\n[conda] mkl-include               2020.2                      256  \r\n[conda] mkl-service               2.3.0            py38he904b0f_0  \r\n[conda] mkl_fft                   1.0.15           py38ha843d7b_0  \r\n[conda] mkl_random                1.1.0            py38h962f231_0  \r\n[conda] numpy                     1.18.1           py38h4f9e942_0  \r\n[conda] numpy-base                1.18.1           py38hde5b4d6_1  \r\n[conda] pytorch-nlp               0.5.0                    pypi_0    pypi\r\n[conda] tensorboard               2.2.0                    pypi_0    pypi\r\n[conda] tensorboard-plugin-wit    1.6.0.post2              pypi_0    pypi\r\n[conda] tensorboardx              2.1                      pypi_0    pypi\r\n[conda] tensorflow                2.2.0rc2                 pypi_0    pypi\r\n[conda] tensorflow-datasets       2.1.0                    pypi_0    pypi\r\n[conda] tensorflow-estimator      2.2.0rc0                 pypi_0    pypi\r\n[conda] tensorflow-metadata       0.21.1                   pypi_0    pypi\r\n[conda] torch                     1.7.1+cu110              pypi_0    pypi\r\n[conda] torchaudio                0.7.2                    pypi_0    pypi\r\n[conda] torchvision               0.8.2+cu110              pypi_0    pypi\r\n```\r\n\r\n### Additional context\r\nhttps://github.com/catalyst-team/catalyst/blob/5cc209ef5f850548a4daa5da229bec4831767ebb/catalyst/metrics/functional/_hitrate.py#L42\r\n\r\nThe number of hits should be divided by the number of targets as follows.\r\n```\r\nhits_score = torch.sum(targets_sort_by_outputs[:, :k], dim=1) / targets.sum(dim=1)\r\n```\r\n\r\n### Checklist\r\n- [x] bug description.\r\n- [x] steps to reproduce.\r\n- [x] expected behavior.\r\n- [x] environment.\r\n- [x] code sample / screenshots.\r\n- [x] I know, that I could [join Catalyst slack (#__questions channel)](https://join.slack.com/t/catalyst-team-core/shared_invite/zt-d9miirnn-z86oKDzFMKlMG4fgFdZafw) for issue discussion.\r\n","closed_by":{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1155/timeline","performed_via_github_app":null,"state_reason":"completed"}