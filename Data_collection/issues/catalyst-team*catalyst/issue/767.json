{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767/events","html_url":"https://github.com/catalyst-team/catalyst/issues/767","id":604991011,"node_id":"MDU6SXNzdWU2MDQ5OTEwMTE=","number":767,"title":"Distributed mode fail","user":{"login":"balakhonoff","id":44712112,"node_id":"MDQ6VXNlcjQ0NzEyMTEy","avatar_url":"https://avatars.githubusercontent.com/u/44712112?v=4","gravatar_id":"","url":"https://api.github.com/users/balakhonoff","html_url":"https://github.com/balakhonoff","followers_url":"https://api.github.com/users/balakhonoff/followers","following_url":"https://api.github.com/users/balakhonoff/following{/other_user}","gists_url":"https://api.github.com/users/balakhonoff/gists{/gist_id}","starred_url":"https://api.github.com/users/balakhonoff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/balakhonoff/subscriptions","organizations_url":"https://api.github.com/users/balakhonoff/orgs","repos_url":"https://api.github.com/users/balakhonoff/repos","events_url":"https://api.github.com/users/balakhonoff/events{/privacy}","received_events_url":"https://api.github.com/users/balakhonoff/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400277,"node_id":"MDU6TGFiZWwxMDI5NDAwMjc3","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-04-22T19:02:46Z","updated_at":"2020-06-22T18:57:53Z","closed_at":"2020-06-22T18:57:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the bug**\r\nHere is the thing. I used the new feature DistributedDataParallel in notebook API with Distilbert from huggingface and it was cool. But when I tried to change the model to BERT, I found out that the catalyst works in a notebook (with distributed=False) and fails in script (with distributed=True)\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. run a notebook (https://yadi.sk/d/Agr5JkPH-SppuA ) -> it works ok \r\n2. convert it to script: `jupyter nbconvert --to script example_to_reproduce_an_error.ipynb`\r\n3. run the script: `python example_to_reproduce_an_error.py` -> it fails with the trace:\r\n`Traceback (most recent call last):\r\n  File \"v71_pytorch_distilbert_is_is_v4_with_main_auc_first_stage_notmulti.py\", line 530, in <module>\r\n    minimize_metric=False\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/dl/runner/core.py\", line 133, in train\r\n    utils.distributed_cmd_run(self.run_experiment, distributed)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/utils/scripts.py\", line 133, in distributed_cmd_run\r\n    worker_fn(*args, **kwargs)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 510, in run_experiment\r\n    self._run_event(\"on_exception\")\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 329, in _run_event\r\n    getattr(callback, event)(self.state)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/callbacks/exception.py\", line 20, in on_exception\r\n    raise exception\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 497, in run_experiment\r\n    self._run_stage(stage)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 474, in _run_stage\r\n    self._run_epoch(stage=stage, epoch=state.epoch)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 451, in _run_epoch\r\n    self._run_loader(loader)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 398, in _run_loader\r\n    self._run_batch(batch)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/core/runner.py\", line 375, in _run_batch\r\n    self._handle_batch(batch=batch)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/dl/runner/supervised.py\", line 135, in _handle_batch\r\n    self.state.batch_out = self.forward(batch)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/dl/runner/supervised.py\", line 122, in forward\r\n    output = self._process_input(batch, **kwargs)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/catalyst/dl/runner/supervised.py\", line 88, in _process_input_str\r\n    output = self.model(batch[self.input_key], **kwargs)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/torch/nn/modules/module.py\", line 532, in __call__\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/kb/.local/lib/python3.7/site-packages/torch/nn/parallel/distributed.py\", line 464, in forward\r\n    self.reducer.prepare_for_backward([])\r\nRuntimeError: Expected to have finished reduction in the prior iteration before starting a new one. This error indicates that your module has parameters that were not used in producing loss. You can enable unused parameter detection by (1) passing the keyword argument `find_unused_parameters=True` to `torch.nn.parallel.DistributedDataParallel`; (2) making sure all `forward` function outputs participate in calculating loss. If you already have done the above two steps, then the distributed data parallel module wasn't able to locate the output tensors in the return value of your module's `forward` function. Please include the loss function and the structure of the return value of `forward` of your module when reporting this issue (e.g. list, dict, iterable). (prepare_for_backward at /pytorch/torch/csrc/distributed/c10d/reducer.cpp:514)\r\nframe #0: c10::Error::Error(c10::SourceLocation, std::string const&) + 0x33 (0x7efc40902193 in /home/kb/.local/lib/python3.7/site-packages/torch/lib/libc10.so)\r\nframe #1: c10d::Reducer::prepare_for_backward(std::vector<at::Tensor, std::allocator<at::Tensor> > const&) + 0x731 (0x7efc8c0c26f1 in /home/kb/.local/lib/python3.7/site-packages/torch/lib/libtorch_python.so)\r\nframe #2: <unknown function> + 0xa168ea (0x7efc8c0ae8ea in /home/kb/.local/lib/python3.7/site-packages/torch/lib/libtorch_python.so)\r\nframe #3: <unknown function> + 0x295a74 (0x7efc8b92da74 in /home/kb/.local/lib/python3.7/site-packages/torch/lib/libtorch_python.so)\r\nframe #4: _PyMethodDef_RawFastCallKeywords + 0x264 (0x555be3a68114 in /home/kb/anaconda3/bin/python3)\r\nframe #5: _PyCFunction_FastCallKeywords + 0x21 (0x555be3a68231 in /home/kb/anaconda3/bin/python3)\r\nframe #6: _PyEval_EvalFrameDefault + 0x52cf (0x555be3acce8f in /home/kb/anaconda3/bin/python3)\r\nframe #7: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #8: _PyFunction_FastCallDict + 0x1d5 (0x555be3a22805 in /home/kb/anaconda3/bin/python3)\r\nframe #9: _PyObject_Call_Prepend + 0x63 (0x555be3a3d943 in /home/kb/anaconda3/bin/python3)\r\nframe #10: PyObject_Call + 0x6e (0x555be3a30b9e in /home/kb/anaconda3/bin/python3)\r\nframe #11: _PyEval_EvalFrameDefault + 0x1e35 (0x555be3ac99f5 in /home/kb/anaconda3/bin/python3)\r\nframe #12: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #13: _PyFunction_FastCallDict + 0x1d5 (0x555be3a22805 in /home/kb/anaconda3/bin/python3)\r\nframe #14: _PyObject_Call_Prepend + 0x63 (0x555be3a3d943 in /home/kb/anaconda3/bin/python3)\r\nframe #15: <unknown function> + 0x17512a (0x555be3a7c12a in /home/kb/anaconda3/bin/python3)\r\nframe #16: PyObject_Call + 0x6e (0x555be3a30b9e in /home/kb/anaconda3/bin/python3)\r\nframe #17: _PyEval_EvalFrameDefault + 0x1e35 (0x555be3ac99f5 in /home/kb/anaconda3/bin/python3)\r\nframe #18: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #19: _PyFunction_FastCallDict + 0x1d5 (0x555be3a22805 in /home/kb/anaconda3/bin/python3)\r\nframe #20: _PyObject_Call_Prepend + 0x63 (0x555be3a3d943 in /home/kb/anaconda3/bin/python3)\r\nframe #21: PyObject_Call + 0x6e (0x555be3a30b9e in /home/kb/anaconda3/bin/python3)\r\nframe #22: _PyEval_EvalFrameDefault + 0x1e35 (0x555be3ac99f5 in /home/kb/anaconda3/bin/python3)\r\nframe #23: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #24: _PyFunction_FastCallKeywords + 0x387 (0x555be3a67917 in /home/kb/anaconda3/bin/python3)\r\nframe #25: _PyEval_EvalFrameDefault + 0x6a0 (0x555be3ac8260 in /home/kb/anaconda3/bin/python3)\r\nframe #26: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #27: _PyFunction_FastCallKeywords + 0x387 (0x555be3a67917 in /home/kb/anaconda3/bin/python3)\r\nframe #28: _PyEval_EvalFrameDefault + 0x14e6 (0x555be3ac90a6 in /home/kb/anaconda3/bin/python3)\r\nframe #29: _PyFunction_FastCallKeywords + 0xfb (0x555be3a6768b in /home/kb/anaconda3/bin/python3)\r\nframe #30: _PyEval_EvalFrameDefault + 0x6a0 (0x555be3ac8260 in /home/kb/anaconda3/bin/python3)\r\nframe #31: _PyFunction_FastCallKeywords + 0xfb (0x555be3a6768b in /home/kb/anaconda3/bin/python3)\r\nframe #32: _PyEval_EvalFrameDefault + 0x6a0 (0x555be3ac8260 in /home/kb/anaconda3/bin/python3)\r\nframe #33: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #34: _PyFunction_FastCallKeywords + 0x387 (0x555be3a67917 in /home/kb/anaconda3/bin/python3)\r\nframe #35: _PyEval_EvalFrameDefault + 0x14e6 (0x555be3ac90a6 in /home/kb/anaconda3/bin/python3)\r\nframe #36: _PyFunction_FastCallKeywords + 0xfb (0x555be3a6768b in /home/kb/anaconda3/bin/python3)\r\nframe #37: _PyEval_EvalFrameDefault + 0x6a0 (0x555be3ac8260 in /home/kb/anaconda3/bin/python3)\r\nframe #38: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #39: _PyFunction_FastCallDict + 0x1d5 (0x555be3a22805 in /home/kb/anaconda3/bin/python3)\r\nframe #40: _PyObject_Call_Prepend + 0x63 (0x555be3a3d943 in /home/kb/anaconda3/bin/python3)\r\nframe #41: PyObject_Call + 0x6e (0x555be3a30b9e in /home/kb/anaconda3/bin/python3)\r\nframe #42: _PyEval_EvalFrameDefault + 0x1e35 (0x555be3ac99f5 in /home/kb/anaconda3/bin/python3)\r\nframe #43: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #44: _PyFunction_FastCallKeywords + 0x387 (0x555be3a67917 in /home/kb/anaconda3/bin/python3)\r\nframe #45: _PyEval_EvalFrameDefault + 0x4b09 (0x555be3acc6c9 in /home/kb/anaconda3/bin/python3)\r\nframe #46: _PyEval_EvalCodeWithName + 0xc30 (0x555be3a22030 in /home/kb/anaconda3/bin/python3)\r\nframe #47: _PyFunction_FastCallKeywords + 0x387 (0x555be3a67917 in /home/kb/anaconda3/bin/python3)\r\nframe #48: _PyEval_EvalFrameDefault + 0x14e6 (0x555be3ac90a6 in /home/kb/anaconda3/bin/python3)\r\nframe #49: _PyEval_EvalCodeWithName + 0x2f9 (0x555be3a216f9 in /home/kb/anaconda3/bin/python3)\r\nframe #50: PyEval_EvalCodeEx + 0x44 (0x555be3a225f4 in /home/kb/anaconda3/bin/python3)\r\nframe #51: PyEval_EvalCode + 0x1c (0x555be3a2261c in /home/kb/anaconda3/bin/python3)\r\nframe #52: <unknown function> + 0x21c974 (0x555be3b23974 in /home/kb/anaconda3/bin/python3)\r\nframe #53: PyRun_FileExFlags + 0xa1 (0x555be3b2dcf1 in /home/kb/anaconda3/bin/python3)\r\nframe #54: PyRun_SimpleFileExFlags + 0x1c3 (0x555be3b2dee3 in /home/kb/anaconda3/bin/python3)\r\nframe #55: <unknown function> + 0x227f95 (0x555be3b2ef95 in /home/kb/anaconda3/bin/python3)\r\nframe #56: _Py_UnixMain + 0x3c (0x555be3b2f0bc in /home/kb/anaconda3/bin/python3)\r\nframe #57: __libc_start_main + 0xe7 (0x7efc9a3ceb97 in /lib/x86_64-linux-gnu/libc.so.6)\r\nframe #58: <unknown function> + 0x1d0990 (0x555be3ad7990 in /home/kb/anaconda3/bin/python3)\r\n`\r\n\r\n**Expected behavior**\r\nNormal distributed training like with DistilBERT\r\n\r\n**Screenshots**\r\nNot sure what to add\r\n\r\n**Additional context**\r\nYou guys are cool\r\n","closed_by":{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/767/timeline","performed_via_github_app":null,"state_reason":"completed"}