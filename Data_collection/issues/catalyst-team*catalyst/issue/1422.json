{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422","repository_url":"https://api.github.com/repos/catalyst-team/catalyst","labels_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422/labels{/name}","comments_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422/comments","events_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422/events","html_url":"https://github.com/catalyst-team/catalyst/issues/1422","id":1287408233,"node_id":"I_kwDOCKpmxM5MvEpp","number":1422,"title":"`runner.evaluate_loader` does not work with DataParallelEngine","user":{"login":"ShuhuaGao","id":20141984,"node_id":"MDQ6VXNlcjIwMTQxOTg0","avatar_url":"https://avatars.githubusercontent.com/u/20141984?v=4","gravatar_id":"","url":"https://api.github.com/users/ShuhuaGao","html_url":"https://github.com/ShuhuaGao","followers_url":"https://api.github.com/users/ShuhuaGao/followers","following_url":"https://api.github.com/users/ShuhuaGao/following{/other_user}","gists_url":"https://api.github.com/users/ShuhuaGao/gists{/gist_id}","starred_url":"https://api.github.com/users/ShuhuaGao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShuhuaGao/subscriptions","organizations_url":"https://api.github.com/users/ShuhuaGao/orgs","repos_url":"https://api.github.com/users/ShuhuaGao/repos","events_url":"https://api.github.com/users/ShuhuaGao/events{/privacy}","received_events_url":"https://api.github.com/users/ShuhuaGao/received_events","type":"User","site_admin":false},"labels":[{"id":1029400270,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcw","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1029400273,"node_id":"MDU6TGFiZWwxMDI5NDAwMjcz","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/help%20wanted","name":"help wanted","color":"008672","default":true,"description":"Extra attention is needed"},{"id":1029400277,"node_id":"MDU6TGFiZWwxMDI5NDAwMjc3","url":"https://api.github.com/repos/catalyst-team/catalyst/labels/wontfix","name":"wontfix","color":"ffffff","default":true,"description":"This will not be worked on"}],"state":"closed","locked":false,"assignee":{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},"assignees":[{"login":"ditwoo","id":7264490,"node_id":"MDQ6VXNlcjcyNjQ0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7264490?v=4","gravatar_id":"","url":"https://api.github.com/users/ditwoo","html_url":"https://github.com/ditwoo","followers_url":"https://api.github.com/users/ditwoo/followers","following_url":"https://api.github.com/users/ditwoo/following{/other_user}","gists_url":"https://api.github.com/users/ditwoo/gists{/gist_id}","starred_url":"https://api.github.com/users/ditwoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ditwoo/subscriptions","organizations_url":"https://api.github.com/users/ditwoo/orgs","repos_url":"https://api.github.com/users/ditwoo/repos","events_url":"https://api.github.com/users/ditwoo/events{/privacy}","received_events_url":"https://api.github.com/users/ditwoo/received_events","type":"User","site_admin":false},{"login":"Scitator","id":7606451,"node_id":"MDQ6VXNlcjc2MDY0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/7606451?v=4","gravatar_id":"","url":"https://api.github.com/users/Scitator","html_url":"https://github.com/Scitator","followers_url":"https://api.github.com/users/Scitator/followers","following_url":"https://api.github.com/users/Scitator/following{/other_user}","gists_url":"https://api.github.com/users/Scitator/gists{/gist_id}","starred_url":"https://api.github.com/users/Scitator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scitator/subscriptions","organizations_url":"https://api.github.com/users/Scitator/orgs","repos_url":"https://api.github.com/users/Scitator/repos","events_url":"https://api.github.com/users/Scitator/events{/privacy}","received_events_url":"https://api.github.com/users/Scitator/received_events","type":"User","site_admin":false},{"login":"bagxi","id":19803638,"node_id":"MDQ6VXNlcjE5ODAzNjM4","avatar_url":"https://avatars.githubusercontent.com/u/19803638?v=4","gravatar_id":"","url":"https://api.github.com/users/bagxi","html_url":"https://github.com/bagxi","followers_url":"https://api.github.com/users/bagxi/followers","following_url":"https://api.github.com/users/bagxi/following{/other_user}","gists_url":"https://api.github.com/users/bagxi/gists{/gist_id}","starred_url":"https://api.github.com/users/bagxi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagxi/subscriptions","organizations_url":"https://api.github.com/users/bagxi/orgs","repos_url":"https://api.github.com/users/bagxi/repos","events_url":"https://api.github.com/users/bagxi/events{/privacy}","received_events_url":"https://api.github.com/users/bagxi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-06-28T14:07:37Z","updated_at":"2022-10-19T02:43:50Z","closed_at":"2022-10-19T02:43:50Z","author_association":"NONE","active_lock_reason":null,"body":"## üêõ Bug Report\r\n\r\n### How To Reproduce\r\nI have two GPUs and enable both of them. I copied the linear regression minimal example. After that, I checked\r\n```python\r\nrunner.engine\r\n# <catalyst.engines.torch.DataParallelEngine at 0x7f67e25d72b0>\r\n```\r\nThen, the following line produced a long error message:\r\n```python\r\nrunner.evaluate_loader(loaders['valid'])\r\n```\r\n```\r\n---------------------------------------------------------------------------\r\nRuntimeError                              Traceback (most recent call last)\r\n/home/shuhua/GitHub/Learn-DL/catalyst-tutorial/linear-regression.ipynb Cell 10' in <cell line: 1>()\r\n----> [1](vscode-notebook-cell://ssh-remote%2B7b22686f73744e616d65223a22575333303930227d/home/shuhua/GitHub/Learn-DL/catalyst-tutorial/linear-regression.ipynb#ch0000009vscode-remote?line=0) runner.evaluate_loader(loaders['valid'])\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/runners/runner.py:490, in Runner.evaluate_loader(self, loader, callbacks, model, engine, seed, verbose)\r\n    487     model = self.model\r\n    488 assert model is not None\r\n--> 490 self.train(\r\n    491     model=model,\r\n    492     engine=engine,\r\n    493     loaders=OrderedDict([(\"valid\", loader)]),\r\n    494     num_epochs=1,\r\n    495     verbose=verbose,\r\n    496     callbacks=callbacks,\r\n    497     valid_loader=\"valid\",\r\n    498     seed=seed,\r\n    499 )\r\n    501 return self.loader_metrics\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/runners/runner.py:377, in Runner.train(self, loaders, model, engine, criterion, optimizer, scheduler, callbacks, loggers, seed, hparams, num_epochs, logdir, resume, valid_loader, valid_metric, minimize_valid_metric, verbose, timeit, check, overfit, profile, load_best_on_end, cpu, fp16, ddp)\r\n    375 self._load_best_on_end = load_best_on_end\r\n    376 # run\r\n--> 377 self.run()\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:422, in IRunner.run(self)\r\n    420 except (Exception, KeyboardInterrupt) as ex:\r\n    421     self.exception = ex\r\n--> 422     self._run_event(\"on_exception\")\r\n    423 return self\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:365, in IRunner._run_event(self, event)\r\n    363     getattr(callback, event)(self)\r\n    364 if is_str_intersections(event, (\"_end\", \"_exception\")):\r\n--> 365     getattr(self, event)(self)\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:357, in IRunner.on_exception(self, runner)\r\n    355 def on_exception(self, runner: \"IRunner\"):\r\n    356     \"\"\"Event handler.\"\"\"\r\n--> 357     raise self.exception\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:419, in IRunner.run(self)\r\n    413 \"\"\"Runs the experiment.\r\n    414 \r\n    415 Returns:\r\n    416     self, `IRunner` instance after the experiment\r\n    417 \"\"\"\r\n    418 try:\r\n--> 419     self._run()\r\n    420 except (Exception, KeyboardInterrupt) as ex:\r\n    421     self.exception = ex\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:410, in IRunner._run(self)\r\n    408 def _run(self) -> None:\r\n    409     self.engine = self.get_engine()\r\n--> 410     self.engine.spawn(self._run_local)\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/engine.py:59, in Engine.spawn(self, fn, *args, **kwargs)\r\n     42 def spawn(self, fn: Callable, *args, **kwargs):\r\n     43     \"\"\"Spawns processes with specified ``fn`` and ``args``/``kwargs``.\r\n     44 \r\n     45     Args:\r\n   (...)\r\n     57         wrapped function (if needed).\r\n     58     \"\"\"\r\n---> 59     return fn(*args, **kwargs)\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:405, in IRunner._run_local(self, local_rank, world_size)\r\n    403 self._local_rank, self._world_size = local_rank, world_size\r\n    404 self._run_event(\"on_experiment_start\")\r\n--> 405 self._run_experiment()\r\n    406 self._run_event(\"on_experiment_end\")\r\n\r\nFile ~/miniconda3/lib/python3.9/site-packages/catalyst/core/runner.py:399, in IRunner._run_experiment(self)\r\n    397     break\r\n...\r\n  File \"/home/shuhua/miniconda3/lib/python3.9/site-packages/torch/nn/modules/linear.py\", line 103, in forward\r\n    return F.linear(input, self.weight, self.bias)\r\nRuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:1 and cuda:0! (when checking argument for argument mat1 in method wrapper_addmm)\r\n```\r\n\r\nBy contrast, if I use one GPU or CPU via setting `os.environ[\"CUDA_VISIBLE_DEVICES\"]`, then it works.\r\n\r\nPytorch `DataParallel` supports inference on multiple GPUs, right? I don't understand why `evaluate_loader` fails with `DataParallelEngine`.\r\n\r\n<!-- If you have a code sample, error messages, stack traces, please provide it here as well --> \r\n\r\n\r\n### Environment\r\n\r\n# example checklist, fill with your info\r\nCatalyst version: 20.04.\r\nPyTorch version: 1.11.0\r\nPython version: 3.9\r\nCUDA runtime version: 11.4\r\nNvidia driver version: 472.39\r\n```","closed_by":{"login":"stale[bot]","id":26384082,"node_id":"MDM6Qm90MjYzODQwODI=","avatar_url":"https://avatars.githubusercontent.com/in/1724?v=4","gravatar_id":"","url":"https://api.github.com/users/stale%5Bbot%5D","html_url":"https://github.com/apps/stale","followers_url":"https://api.github.com/users/stale%5Bbot%5D/followers","following_url":"https://api.github.com/users/stale%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stale%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/stale%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/stale%5Bbot%5D/repos","events_url":"https://api.github.com/users/stale%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/stale%5Bbot%5D/received_events","type":"Bot","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catalyst-team/catalyst/issues/1422/timeline","performed_via_github_app":null,"state_reason":"completed"}